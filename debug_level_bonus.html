<!DOCTYPE html>
<html>
<head>
    <title>命格层次加分调试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>命格层次加分调试</h1>
    
    <div class="test-case">
        <h3>测试八字: 戊午，己未，乙酉，丁丑</h3>
        <div id="result1" class="result"></div>
    </div>
    
    <script>
        // 模拟baziphone.html中的函数
        function getStemElement(stem) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火', 
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            return elementMap[stem] || '土';
        }
        
        function getHiddenStems(branch) {
            const hiddenStemsMap = {
                '子': ['癸'],
                '丑': ['己', '癸', '辛'],
                '寅': ['甲', '丙', '戊'],
                '卯': ['乙'],
                '辰': ['戊', '乙', '癸'],
                '巳': ['丙', '戊', '庚'],
                '午': ['丁', '己'],
                '未': ['己', '丁', '乙'],
                '申': ['庚', '壬', '戊'],
                '酉': ['辛'],
                '戌': ['戊', '辛', '丁'],
                '亥': ['壬', '甲']
            };
            return hiddenStemsMap[branch] || ['戊'];
        }
        
        function getTenGod(dayStem, targetStem) {
            const tenGodMap = {
                '甲': { '甲': '比肩', '乙': '劫财', '丙': '食神', '丁': '伤官', '戊': '偏财', '己': '正财', '庚': '七杀', '辛': '正官', '壬': '偏印', '癸': '正印' },
                '乙': { '甲': '劫财', '乙': '比肩', '丙': '伤官', '丁': '食神', '戊': '正财', '己': '偏财', '庚': '正官', '辛': '七杀', '壬': '正印', '癸': '偏印' },
                '丙': { '甲': '偏印', '乙': '正印', '丙': '比肩', '丁': '劫财', '戊': '食神', '己': '伤官', '庚': '偏财', '辛': '正财', '壬': '七杀', '癸': '正官' },
                '丁': { '甲': '正印', '乙': '偏印', '丙': '劫财', '丁': '比肩', '戊': '伤官', '己': '食神', '庚': '正财', '辛': '偏财', '壬': '正官', '癸': '七杀' },
                '戊': { '甲': '七杀', '乙': '正官', '丙': '偏印', '丁': '正印', '戊': '比肩', '己': '劫财', '庚': '食神', '辛': '伤官', '壬': '偏财', '癸': '正财' },
                '己': { '甲': '正官', '乙': '七杀', '丙': '正印', '丁': '偏印', '戊': '劫财', '己': '比肩', '庚': '伤官', '辛': '食神', '壬': '正财', '癸': '偏财' },
                '庚': { '甲': '偏财', '乙': '正财', '丙': '七杀', '丁': '正官', '戊': '偏印', '己': '正印', '庚': '比肩', '辛': '劫财', '壬': '食神', '癸': '伤官' },
                '辛': { '甲': '正财', '乙': '偏财', '丙': '正官', '丁': '七杀', '戊': '正印', '己': '偏印', '庚': '劫财', '辛': '比肩', '壬': '伤官', '癸': '食神' },
                '壬': { '甲': '食神', '乙': '伤官', '丙': '偏财', '丁': '正财', '戊': '七杀', '己': '正官', '庚': '偏印', '辛': '正印', '壬': '比肩', '癸': '劫财' },
                '癸': { '甲': '伤官', '乙': '食神', '丙': '正财', '丁': '偏财', '戊': '正官', '己': '七杀', '庚': '正印', '辛': '偏印', '壬': '劫财', '癸': '比肩' }
            };
            return tenGodMap[dayStem]?.[targetStem] || '未知';
        }
        
        function countTenGods(pillars) {
            const dayStem = pillars.day.charAt(0);
            const tenGodsCount = {};
            
            // 统计天干十神
            [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)].forEach(stem => {
                const tenGod = getTenGod(dayStem, stem);
                tenGodsCount[tenGod] = (tenGodsCount[tenGod] || 0) + 1;
            });
            
            // 统计地支藏干十神
            [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)].forEach(branch => {
                const hiddenStems = getHiddenStems(branch);
                hiddenStems.forEach(stem => {
                    if (stem !== dayStem) {
                        const tenGod = getTenGod(dayStem, stem);
                        tenGodsCount[tenGod] = (tenGodsCount[tenGod] || 0) + 0.5; // 地支藏干权重减半
                    }
                });
            });
            
            return tenGodsCount;
        }
        
        function hasSanQi(pillars) {
            const stems = [
                pillars.year.charAt(0),
                pillars.month.charAt(0), 
                pillars.day.charAt(0),
                pillars.hour.charAt(0)
            ];
            
            // 乙丙丁三奇
            const hasYi = stems.includes('乙');
            const hasBing = stems.includes('丙');
            const hasDing = stems.includes('丁');
            if (hasYi && hasBing && hasDing) return true;
            
            // 甲戊庚三奇  
            const hasJia = stems.includes('甲');
            const hasWu = stems.includes('戊');
            const hasGeng = stems.includes('庚');
            if (hasJia && hasWu && hasGeng) return true;
            
            return false;
        }
        
        function calculateLevelBonus(pillars) {
            let bonus = 0;
            const tenGodsCount = countTenGods(pillars);
            
            console.log('十神统计:', tenGodsCount);
            
            // 三奇贵人格局
            if (hasSanQi(pillars)) {
                bonus += 8;
                console.log('三奇贵人格局: +8分');
            }
            
            // 官印相生格局
            if ((tenGodsCount['正官'] || 0) > 0 && (tenGodsCount['正印'] || 0) > 0) {
                bonus += 6;
                console.log('官印相生格局: +6分');
            }
            
            // 食神制杀格局
            if ((tenGodsCount['食神'] || 0) > 0 && (tenGodsCount['七杀'] || 0) > 0) {
                bonus += 5;
                console.log('食神制杀格局: +5分');
            }
            
            // 财官双美格局
            if ((tenGodsCount['正财'] || 0) > 0 && (tenGodsCount['正官'] || 0) > 0) {
                bonus += 4;
                console.log('财官双美格局: +4分');
            }
            
            // 印绶格高层次
            if ((tenGodsCount['正印'] || 0) >= 2) {
                bonus += 3;
                console.log('印绶格高层次: +3分');
            }
            
            return Math.min(15, bonus);
        }
        
        // 测试
        const testPillars = {
            year: '戊午',
            month: '己未', 
            day: '乙酉',
            hour: '丁丑'
        };
        
        console.log('测试八字:', testPillars);
        const levelBonus = calculateLevelBonus(testPillars);
        const finalScore = Math.round(levelBonus * 0.2);
        
        document.getElementById('result1').innerHTML = `
            <p><strong>命格层次原始分数:</strong> ${levelBonus} 分</p>
            <p><strong>应用0.2系数后:</strong> ${finalScore} 分</p>
            <p><strong>详细分析请查看控制台</strong></p>
        `;
    </script>
</body>
</html>