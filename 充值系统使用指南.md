# 充值系统使用指南

## 系统概述

本充值系统支持多种支付方式，包括Stripe信用卡支付和余额支付，为用户提供安全便捷的充值体验。

## 系统架构

### 服务组件
1. **前端服务** (端口 8000): 提供用户界面和静态资源
2. **后端API服务** (端口 8787): 处理业务逻辑和数据库操作
3. **Stripe支付服务** (端口 3000): 处理信用卡支付

### 技术栈
- 前端: HTML5, JavaScript, CSS3
- 后端: Node.js, Cloudflare Workers
- 支付: Stripe API
- 认证: JWT (JSON Web Tokens)

## 启动系统

### 1. 启动后端API服务
```bash
cd bazi-backend
node server.js
```
服务将在 http://localhost:8787 启动

### 2. 启动前端服务
```bash
cd bazi_mobile_app
python3 -m http.server 8000
```
服务将在 http://localhost:8000 启动

### 3. 启动Stripe支付服务
```bash
cd bazi_mobile_app
npm install
node stripe-server.js
```
服务将在 http://localhost:3000 启动

## 用户操作流程

### 充值流程

1. **访问充值页面**
   - 打开 http://localhost:8000/assets/stripe_recharge.html

2. **用户认证**
   - 点击"测试Token"按钮生成测试用户令牌
   - 系统会自动设置测试用户信息 (testuser, ID: 1)

3. **查看当前余额**
   - 页面会自动显示当前用户余额
   - 余额信息实时从后端API获取

4. **选择充值金额**
   - 在充值金额输入框中输入要充值的金额
   - 支持的金额范围: $1 - $1000

5. **选择支付方式**
   - **Stripe信用卡支付**: 使用测试信用卡进行支付
   - **余额支付**: 使用账户现有余额进行内部转账

6. **完成支付**
   - 按照页面提示完成支付流程
   - 支付成功后余额会自动更新

### Stripe测试卡信息

在测试环境中，可以使用以下测试卡号:

- **成功支付**: 4242 4242 4242 4242
- **失败支付**: 4000 0000 0000 0002
- **需要验证**: 4000 0025 0000 3155

**其他信息**:
- 过期日期: 任何未来日期 (如 12/25)
- CVC: 任何3位数字 (如 123)
- 邮编: 任何5位数字 (如 12345)

## API接口说明

### 认证相关
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/register` - 用户注册

### 用户相关
- `GET /api/user/balance` - 获取用户余额
- `GET /api/user/profile` - 获取用户信息

### 充值相关
- `POST /api/user/recharge` - 用户充值
- `POST /api/payments/balance` - 余额支付

### Stripe相关
- `POST /create-payment-intent` - 创建支付意图
- `GET /health` - 健康检查

## 故障排除

### 常见问题

1. **JWT认证失败 (401错误)**
   - 确保点击了"测试Token"按钮
   - 检查localStorage中是否有有效的token
   - 确认后端服务正常运行

2. **Stripe支付失败**
   - 确认Stripe服务器已启动 (端口3000)
   - 检查网络连接
   - 使用正确的测试卡号

3. **余额查询失败**
   - 确认后端API服务正常运行
   - 检查数据库连接
   - 验证用户认证状态

### 日志查看

- **后端日志**: 查看后端服务终端输出
- **前端日志**: 打开浏览器开发者工具查看Console
- **Stripe日志**: 查看Stripe服务器终端输出

## 安全注意事项

1. **测试环境**
   - 当前使用的是Stripe测试密钥
   - 所有支付都是模拟的，不会产生真实费用

2. **生产环境部署**
   - 替换为生产环境的Stripe密钥
   - 配置HTTPS证书
   - 设置适当的CORS策略
   - 使用强密码和安全的JWT密钥

3. **数据保护**
   - 不在前端存储敏感信息
   - 使用HTTPS传输数据
   - 定期更新依赖包

## 技术支持

如遇到技术问题，请检查:
1. 所有服务是否正常启动
2. 端口是否被占用
3. 网络连接是否正常
4. 浏览器控制台是否有错误信息

---

**版本**: 1.0  
**更新日期**: 2024年12月  
**维护者**: 开发团队