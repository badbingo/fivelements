<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字身强身弱分析测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .bazi-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .analysis-result {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .debug-info {
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>八字身强身弱分析测试</h1>
        
        <div class="bazi-info">
            <h3>测试命主信息</h3>
            <p><strong>性别：</strong>男</p>
            <p><strong>出生时间：</strong>1987年12月24日 9:00</p>
            <p><strong>八字：</strong>丁卯（年） 壬子（月） 丁未（日） 乙巳（时）</p>
            <p><strong>日主：</strong>丁火</p>
        </div>
        
        <button onclick="testBaziAnalysis()">开始分析</button>
        <button onclick="clearResults()">清除结果</button>
        
        <div id="results"></div>
    </div>

    <script>
        // 模拟八字数据
        const testBaziData = {
            year: '丁卯',
            month: '壬子', 
            day: '丁未',
            hour: '乙巳',
            dayStem: '丁',
            dayElement: 'fire'
        };
        
        // 五行元素映射
        const stemElementMap = {
            '甲': 'wood', '乙': 'wood',
            '丙': 'fire', '丁': 'fire', 
            '戊': 'earth', '己': 'earth',
            '庚': 'metal', '辛': 'metal',
            '壬': 'water', '癸': 'water'
        };
        
        const branchElementMap = {
            '子': 'water', '丑': 'earth', '寅': 'wood', '卯': 'wood',
            '辰': 'earth', '巳': 'fire', '午': 'fire', '未': 'earth', 
            '申': 'metal', '酉': 'metal', '戌': 'earth', '亥': 'water'
        };
        
        // 地支藏干
        const BRANCH_ELEMENTS = {
            '子': {main: 'water', hidden: ['癸']},
            '丑': {main: 'earth', hidden: ['己', '癸', '辛']},
            '寅': {main: 'wood', hidden: ['甲', '丙', '戊']},
            '卯': {main: 'wood', hidden: ['乙']},
            '辰': {main: 'earth', hidden: ['戊', '乙', '癸']},
            '巳': {main: 'fire', hidden: ['丙', '庚', '戊']},
            '午': {main: 'fire', hidden: ['丁', '己']},
            '未': {main: 'earth', hidden: ['己', '丁', '乙']},
            '申': {main: 'metal', hidden: ['庚', '壬', '戊']},
            '酉': {main: 'metal', hidden: ['辛']},
            '戌': {main: 'earth', hidden: ['戊', '辛', '丁']},
            '亥': {main: 'water', hidden: ['壬', '甲']}
        };
        
        function testBaziAnalysis() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>分析结果</h3>';
            
            try {
                // 分析天干
                const stems = ['丁', '壬', '丁', '乙'];
                const branches = ['卯', '子', '未', '巳'];
                
                addResult('八字天干：' + stems.join(' '), 'debug-info');
                addResult('八字地支：' + branches.join(' '), 'debug-info');
                
                // 检查天干五合
                const hehuaAnalysis = analyzeHehua(stems);
                addResult('天干五合分析：', 'analysis-result');
                addResult(hehuaAnalysis, 'debug-info');
                
                // 计算五行分布
                const elements = calculateElements(stems, branches);
                addResult('五行分布：', 'analysis-result');
                addResult(JSON.stringify(elements, null, 2), 'debug-info');
                
                // 计算身强身弱
                const strengthAnalysis = calculateStrengthAnalysis(testBaziData.dayStem, elements, testBaziData.month.charAt(1));
                addResult('身强身弱分析：', 'analysis-result');
                addResult(JSON.stringify(strengthAnalysis, null, 2), 'debug-info');
                
                // 问题分析
                addResult('问题分析：', 'error');
                if (hehuaAnalysis.includes('争合')) {
                    addResult('✓ 确实存在丁壬争合问题，两个丁争合一个壬', 'error');
                }
                
                if (strengthAnalysis.type === '身强' && strengthAnalysis.ratio > 0.6) {
                    addResult('✗ 当前计算结果显示身强，但可能存在计算错误', 'error');
                }
                
            } catch (error) {
                addResult('分析过程中出现错误：' + error.message, 'error');
                console.error('分析错误：', error);
            }
        }
        
        function analyzeHehua(stems) {
            const tianGanHeHua = {
                '甲己': 'earth', '乙庚': 'metal', '丙辛': 'water',
                '丁壬': 'wood', '戊癸': 'fire'
            };
            
            let analysis = '';
            const hehuaConflicts = new Map();
            const stemCounts = {};
            
            // 统计天干出现次数
            stems.forEach(stem => {
                stemCounts[stem] = (stemCounts[stem] || 0) + 1;
            });
            
            analysis += '天干统计：' + JSON.stringify(stemCounts) + '\n';
            
            // 检查相邻天干五合
            for (let i = 0; i < stems.length - 1; i++) {
                const stem1 = stems[i];
                const stem2 = stems[i + 1];
                const pair1 = stem1 + stem2;
                const pair2 = stem2 + stem1;
                
                if (tianGanHeHua[pair1] || tianGanHeHua[pair2]) {
                    const hehuaElement = tianGanHeHua[pair1] || tianGanHeHua[pair2];
                    analysis += `发现天干五合：${stem1}${stem2} 合化${hehuaElement}\n`;
                    
                    // 检查争合
                    if (hehuaConflicts.has(stem1)) {
                        analysis += `争合：${stem1}同时与${hehuaConflicts.get(stem1)}和${stem2}相合\n`;
                    }
                    if (hehuaConflicts.has(stem2)) {
                        analysis += `争合：${stem2}同时与${hehuaConflicts.get(stem2)}和${stem1}相合\n`;
                    }
                    
                    // 检查妒合
                    if (stemCounts[stem1] > 1 || stemCounts[stem2] > 1) {
                        const repeatStem = stemCounts[stem1] > 1 ? stem1 : stem2;
                        analysis += `妒合：${repeatStem}重复出现${stemCounts[repeatStem]}次\n`;
                    }
                    
                    hehuaConflicts.set(stem1, stem2);
                    hehuaConflicts.set(stem2, stem1);
                }
            }
            
            return analysis;
        }
        
        function calculateElements(stems, branches) {
            const elements = {
                wood: 0, fire: 0, earth: 0, metal: 0, water: 0
            };
            
            // 计算天干五行
            stems.forEach(stem => {
                const element = stemElementMap[stem];
                if (element) {
                    elements[element] += 1;
                }
            });
            
            // 计算地支五行（主气）
            branches.forEach(branch => {
                const element = branchElementMap[branch];
                if (element) {
                    elements[element] += 1;
                }
            });
            
            // 计算地支藏干（权重0.5）
            branches.forEach(branch => {
                const branchInfo = BRANCH_ELEMENTS[branch];
                if (branchInfo && branchInfo.hidden) {
                    branchInfo.hidden.forEach(hiddenStem => {
                        const element = stemElementMap[hiddenStem];
                        if (element) {
                            elements[element] += 0.5;
                        }
                    });
                }
            });
            
            return elements;
        }
        
        function calculateStrengthAnalysis(dayStem, elements, monthBranch) {
            const dayElement = stemElementMap[dayStem];
            
            // 获取生扶和克泄元素
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            // 计算生扶力量
            let supportStrength = 0;
            supportElements.forEach(element => {
                supportStrength += elements[element];
            });
            
            // 计算克泄力量
            let weakenStrength = 0;
            weakenElements.forEach(element => {
                weakenStrength += elements[element];
            });
            
            // 计算月令得分
            const monthElement = branchElementMap[monthBranch];
            let monthScore = 0;
            if (monthElement === dayElement) {
                monthScore = 40; // 得令
            } else if (supportElements.includes(monthElement)) {
                monthScore = 20; // 得生
            } else if (weakenElements.includes(monthElement)) {
                monthScore = -20; // 被克
            }
            
            const strengthRatio = supportStrength / (supportStrength + weakenStrength);
            
            let type, description;
            if (strengthRatio >= 0.60) {
                type = '身强';
                description = '日主力量强旺，能够承担财官，适合主动出击，喜用财官。';
            } else if (strengthRatio >= 0.40) {
                type = '均衡';
                description = '日主力量适中，五行较为平衡，运势平稳，喜用印比。';
            } else {
                type = '身弱';
                description = '日主力量偏弱，需要生扶，宜守不宜攻，喜用印比。';
            }
            
            return {
                type: type,
                ratio: strengthRatio,
                supportStrength: supportStrength,
                weakenStrength: weakenStrength,
                description: description,
                monthScore: monthScore,
                dayElement: dayElement,
                monthElement: monthElement
            };
        }
        
        function getSupportElements(element) {
            const supportMap = {
                'wood': ['water', 'wood'],
                'fire': ['wood', 'fire'],
                'earth': ['fire', 'earth'],
                'metal': ['earth', 'metal'],
                'water': ['metal', 'water']
            };
            return supportMap[element] || [];
        }
        
        function getWeakenElements(element) {
            const weakenMap = {
                'wood': ['metal', 'fire', 'earth'],
                'fire': ['water', 'earth', 'metal'],
                'earth': ['wood', 'metal', 'water'],
                'metal': ['fire', 'water', 'wood'],
                'water': ['earth', 'wood', 'fire']
            };
            return weakenMap[element] || [];
        }
        
        function addResult(content, className = '') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = className;
            div.innerHTML = content.replace(/\n/g, '<br>');
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>