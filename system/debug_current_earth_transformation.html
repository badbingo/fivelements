<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•å½“å‰åœŸæ€§å˜åŒ–é€»è¾‘</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .success { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .warning { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .error { background-color: #ffebee; border-left: 4px solid #f44336; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è°ƒè¯•å½“å‰åœŸæ€§å˜åŒ–é€»è¾‘</h1>
        <p><strong>æµ‹è¯•å…«å­—ï¼š</strong>å£¬å­ ç™¸ä¸‘ å·±å·³ ç™¸é…‰</p>
        <p><strong>é—®é¢˜ï¼š</strong>æœˆä»¤å¾—åˆ†åº”è¯¥ä»40åˆ†å˜ä¸º-10åˆ†ï¼Œä½†å®é™…ä»æ˜¾ç¤º40åˆ†</p>
        
        <button onclick="testEarthTransformation()">æµ‹è¯•åœŸæ€§å˜åŒ–åˆ†æ</button>
        <button onclick="testMonthScoreCalculation()">æµ‹è¯•æœˆä»¤å¾—åˆ†è®¡ç®—</button>
        <button onclick="testFullLogic()">æµ‹è¯•å®Œæ•´é€»è¾‘</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        
        <div id="results"></div>
    </div>

    <script src="enhanced_strength_calculation.js"></script>
    <script>
        // æµ‹è¯•å…«å­—æ•°æ®
        const testBazi = {
            stems: ['å£¬', 'ç™¸', 'å·±', 'ç™¸'],
            branches: ['å­', 'ä¸‘', 'å·³', 'é…‰'],
            monthBranch: 'ä¸‘',
            dayStem: 'å·±'
        };
        
        function addResult(content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = content;
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // æµ‹è¯•åœŸæ€§å˜åŒ–åˆ†æ
        function testEarthTransformation() {
            addResult('<h3>ğŸŒ åœŸæ€§å˜åŒ–åˆ†ææµ‹è¯•</h3>', 'info');
            
            try {
                const earthCalculator = new EarthTransformationCalculator();
                const result = earthCalculator.analyzeEarthTransformation(testBazi.stems, testBazi.branches);
                
                addResult(`<h4>åˆ†æç»“æœï¼š</h4>
                    <p><strong>æ˜¯å¦æœ‰åœŸæ€§å˜åŒ–ï¼š</strong>${result.hasTransformation ? 'æ˜¯' : 'å¦'}</p>
                    <p><strong>å˜åŒ–æ•°é‡ï¼š</strong>${result.transformations.length}</p>`, 'info');
                
                if (result.transformations.length > 0) {
                    result.transformations.forEach((trans, index) => {
                        addResult(`<h4>å˜åŒ– ${index + 1}ï¼š</h4>
                            <p><strong>åœ°æ”¯ï¼š</strong>${trans.branch}</p>
                            <p><strong>ä½ç½®ï¼š</strong>${trans.position}</p>
                            <p><strong>æ˜¯å¦å˜åŒ–ï¼š</strong>${trans.hasTransformation ? 'æ˜¯' : 'å¦'}</p>
                            <p><strong>æ°´æºï¼š</strong>${trans.waterSources.join(', ')}</p>
                            <p><strong>åŸå› ï¼š</strong>${trans.reason}</p>
                            <pre>${JSON.stringify(trans, null, 2)}</pre>`, 'success');
                    });
                } else {
                    addResult('<p>âŒ æ²¡æœ‰æ£€æµ‹åˆ°åœŸæ€§å˜åŒ–</p>', 'error');
                }
                
                // æ£€æŸ¥æœˆæ”¯ä¸‘åœŸæ˜¯å¦è¢«è¯†åˆ«
                const monthTransformation = result.transformations.find(t => t.branch === 'ä¸‘');
                if (monthTransformation) {
                    addResult(`<h4>âœ… æœˆæ”¯ä¸‘åœŸå˜åŒ–æ£€æµ‹ï¼š</h4>
                        <p><strong>å˜åŒ–çŠ¶æ€ï¼š</strong>${monthTransformation.hasTransformation ? 'å·²å˜åŒ–' : 'æœªå˜åŒ–'}</p>
                        <p><strong>æ°´å½±å“æºï¼š</strong>${monthTransformation.waterSources.join(', ')}</p>`, 'success');
                } else {
                    addResult('<h4>âŒ æœˆæ”¯ä¸‘åœŸå˜åŒ–æ£€æµ‹ï¼š</h4><p>æœªæ‰¾åˆ°ä¸‘åœŸçš„å˜åŒ–è®°å½•</p>', 'error');
                }
                
            } catch (error) {
                addResult(`<h4>âŒ é”™è¯¯ï¼š</h4><p>${error.message}</p><pre>${error.stack}</pre>`, 'error');
            }
        }
        
        // æµ‹è¯•æœˆä»¤å¾—åˆ†è®¡ç®—
        function testMonthScoreCalculation() {
            addResult('<h3>ğŸ“Š æœˆä»¤å¾—åˆ†è®¡ç®—æµ‹è¯•</h3>', 'info');
            
            try {
                // æ¨¡æ‹Ÿ getMonthStrength å‡½æ•°
                function getMonthStrength(dayElement, monthBranch) {
                    // å·±åœŸç”Ÿäºä¸‘æœˆï¼ŒåŒç±»ç›¸åŠ©
                    if (dayElement === 'earth' && monthBranch === 'ä¸‘') {
                        return 40; // ä¼ ç»Ÿå¾—åˆ†
                    }
                    return 0;
                }
                
                const earthCalculator = new EarthTransformationCalculator();
                const earthResult = earthCalculator.analyzeEarthTransformation(testBazi.stems, testBazi.branches);
                
                // è®¡ç®—ä¼ ç»Ÿæœˆä»¤å¾—åˆ†
                let monthScore = getMonthStrength('earth', 'ä¸‘');
                addResult(`<p><strong>ä¼ ç»Ÿæœˆä»¤å¾—åˆ†ï¼š</strong>${monthScore}åˆ†</p>`, 'info');
                
                // åº”ç”¨åœŸæ€§å˜åŒ–é€»è¾‘
                if (earthResult.hasTransformation) {
                    const monthBranchTransformation = earthResult.transformations.find(t => t.branch === 'ä¸‘');
                    if (monthBranchTransformation && monthBranchTransformation.hasTransformation) {
                        addResult(`<h4>ğŸ”„ åº”ç”¨åœŸæ€§å˜åŒ–ï¼š</h4>
                            <p><strong>æœˆæ”¯ï¼š</strong>${monthBranchTransformation.branch}</p>
                            <p><strong>å˜åŒ–çŠ¶æ€ï¼š</strong>${monthBranchTransformation.hasTransformation}</p>
                            <p><strong>åŸå› ï¼š</strong>${monthBranchTransformation.reason}</p>`, 'info');
                        
                        const originalScore = monthScore;
                        
                        // æ ¹æ®å˜åŒ–å¼ºåº¦è°ƒæ•´å¾—åˆ†
                        if (monthBranchTransformation.reductionRate >= 0.5) {
                            // æ¹¿åœŸè½¬åŒ–ä¸ºæ°´æ€§ï¼Œå¯¹åœŸæ—¥ä¸»å®Œå…¨å¤±å»ç”Ÿæ‰¶ï¼Œå˜ä¸ºå…‹åˆ¶
                            monthScore = -10;
                            addResult(`<p><strong>è°ƒæ•´åæœˆä»¤å¾—åˆ†ï¼š</strong>${originalScore} â†’ ${monthScore}åˆ†ï¼ˆæ¹¿åœŸè½¬æ°´æ€§ï¼Œå¯¹åœŸæ—¥ä¸»å˜ä¸ºå…‹åˆ¶ï¼‰</p>`, 'success');
                        } else {
                            // åœŸæ€§å‡å¼±
                            monthScore = Math.round(monthScore * 0.5);
                            addResult(`<p><strong>è°ƒæ•´åæœˆä»¤å¾—åˆ†ï¼š</strong>${originalScore} â†’ ${monthScore}åˆ†ï¼ˆåœŸæ€§å‡å¼±ï¼‰</p>`, 'warning');
                        }
                    } else {
                        addResult('<p>âŒ æœˆæ”¯ä¸‘åœŸæœªå‘ç”Ÿå˜åŒ–ï¼Œæœˆä»¤å¾—åˆ†ä¿æŒä¸å˜</p>', 'error');
                    }
                } else {
                    addResult('<p>âŒ æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•åœŸæ€§å˜åŒ–</p>', 'error');
                }
                
            } catch (error) {
                addResult(`<h4>âŒ é”™è¯¯ï¼š</h4><p>${error.message}</p><pre>${error.stack}</pre>`, 'error');
            }
        }
        
        // æµ‹è¯•å®Œæ•´é€»è¾‘
        function testFullLogic() {
            addResult('<h3>ğŸ”§ å®Œæ•´é€»è¾‘æµ‹è¯•</h3>', 'info');
            
            try {
                const earthCalculator = new EarthTransformationCalculator();
                
                // 1. åˆ†ææ°´å½±å“
                addResult('<h4>1. åˆ†ææ°´å½±å“ï¼š</h4>', 'info');
                const waterInfluences = [];
                
                // æ£€æŸ¥å¤©å¹²æ°´
                testBazi.stems.forEach((stem, index) => {
                    if (['å£¬', 'ç™¸'].includes(stem)) {
                        const positionName = ['å¹´', 'æœˆ', 'æ—¥', 'æ—¶'][index];
                        waterInfluences.push(`${positionName}å¹²${stem}`);
                    }
                });
                
                // æ£€æŸ¥åœ°æ”¯æ°´
                testBazi.branches.forEach((branch, index) => {
                    if (['å­', 'äº¥'].includes(branch)) {
                        const positionName = ['å¹´', 'æœˆ', 'æ—¥', 'æ—¶'][index];
                        waterInfluences.push(`${positionName}æ”¯${branch}`);
                    }
                });
                
                addResult(`<p><strong>æ°´å½±å“æºï¼š</strong>${waterInfluences.join(', ')}</p>`, 'info');
                
                // 2. æ£€æŸ¥ä¸‘åœŸä½ç½®çš„æ°´å½±å“
                addResult('<h4>2. æ£€æŸ¥ä¸‘åœŸï¼ˆæœˆæ”¯ï¼‰çš„æ°´å½±å“ï¼š</h4>', 'info');
                const uglyPosition = 1; // æœˆæ”¯ä½ç½®
                let waterInfluence = 0;
                
                // æœ¬æŸ±å¤©å¹²ï¼ˆç™¸ï¼‰
                if (testBazi.stems[uglyPosition] === 'ç™¸') {
                    waterInfluence += 0.8;
                    addResult('<p>âœ… æœ¬æŸ±å¤©å¹²ç™¸æ°´ï¼š+0.8</p>', 'success');
                }
                
                // ç›¸é‚»åœ°æ”¯ï¼ˆå­ï¼‰
                if (testBazi.branches[uglyPosition - 1] === 'å­') {
                    waterInfluence += 0.6;
                    addResult('<p>âœ… å·¦é‚»åœ°æ”¯å­æ°´ï¼š+0.6</p>', 'success');
                }
                
                // å…¶ä»–å¤©å¹²æ°´
                testBazi.stems.forEach((stem, index) => {
                    if (index !== uglyPosition && ['å£¬', 'ç™¸'].includes(stem)) {
                        waterInfluence += 0.4;
                        const positionName = ['å¹´', 'æœˆ', 'æ—¥', 'æ—¶'][index];
                        addResult(`<p>âœ… ${positionName}å¹²${stem}ï¼š+0.4</p>`, 'success');
                    }
                });
                
                addResult(`<p><strong>æ€»æ°´å½±å“ï¼š</strong>${waterInfluence}</p>`, waterInfluence >= 0.5 ? 'success' : 'warning');
                addResult(`<p><strong>æ˜¯å¦è¾¾åˆ°å˜åŒ–é˜ˆå€¼ï¼ˆâ‰¥0.5ï¼‰ï¼š</strong>${waterInfluence >= 0.5 ? 'æ˜¯' : 'å¦'}</p>`, waterInfluence >= 0.5 ? 'success' : 'error');
                
                // 3. è°ƒç”¨å®é™…çš„åœŸæ€§å˜åŒ–åˆ†æ
                addResult('<h4>3. å®é™…åœŸæ€§å˜åŒ–åˆ†æç»“æœï¼š</h4>', 'info');
                const result = earthCalculator.analyzeEarthTransformation(testBazi.stems, testBazi.branches);
                addResult(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'info');
                
            } catch (error) {
                addResult(`<h4>âŒ é”™è¯¯ï¼š</h4><p>${error.message}</p><pre>${error.stack}</pre>`, 'error');
            }
        }
    </script>
</body>
</html>