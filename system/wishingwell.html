<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="命缘池 - 八字能量许愿系统，汇聚众生愿力，助你梦想成真">
    <meta name="keywords" content="命缘池,许愿,八字,加持,还愿,能量池">
    <title>命缘池 - 八字能量许愿系统</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/wwstyle.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="../js/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
      // 配置后端地址（必须修改！）
    const API_BASE = 'https://bazi-backend.owenjass.workers.dev';
    const API_URL = `${API_BASE}/api`;
    </script>
    
</head>
<body>
    
    <main class="content-container">
        <section class="content-title">
            <h1>命缘池</h1>
            <p>以八字为引，聚众生愿力，助你梦想成真</p>
        </section>

        <!-- 命缘池介绍 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-hand-holding-water"></i>
                <h2>缘起</h2>
            </div>
            
            <div class="card">
                <div class="mingyuan-intro">
                    <div class="intro-text">
                        <p>命缘池源自古老道家"愿力汇聚"之法，结合八字命理能量学，创造出一个集体意识能量场。</p>
                        <p>在此投入愿望之时，您的八字化作独一无二的能量标识，携同六字真言之力启动加持。而众生心念汇聚而来的加持之力，将如涟漪般扩散，不断放大愿望的共振频率。</p>
                        <p>每5次加持，愿望能量将提升一个等级，越多人帮你加持能量越强。30天内若达成所愿，请务必还愿以完成能量循环。</p>
                    </div>
                    <div class="intro-image">
                        <div class="energy-chart">
                            <canvas id="energyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="wish-levels">
                    <h3><i class="fas fa-signal"></i> 愿望能量等级</h3>
                    <div class="level-bars">
                        <div class="level-bar" data-level="1">
                            <div class="bar-fill"></div>
                            <span>初愿 (0-4加持)</span>
                        </div>
                        <div class="level-bar" data-level="2">
                            <div class="bar-fill"></div>
                            <span>小成 (5-9加持)</span>
                        </div>
                        <div class="level-bar" data-level="3">
                            <div class="bar-fill"></div>
                            <span>中成 (10-14加持)</span>
                        </div>
                        <div class="level-bar" data-level="4">
                            <div class="bar-fill"></div>
                            <span>大成 (15-19加持)</span>
                        </div>
                        <div class="level-bar" data-level="5">
                            <div class="bar-fill"></div>
                            <span>圆满 (20+加持)</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 许愿表单 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-magic"></i>
                <h2>投入愿望</h2>
            </div>
            
            <div class="card">
                <form id="wishForm" class="mingyuan-form">
                    <div class="form-group">
                        <label for="name"><i class="fas fa-user"></i> 您的姓名</label>
                        <input type="text" id="name" placeholder="请输入您的真实姓名" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="birthday"><i class="fas fa-calendar-alt"></i> 出生日期</label>
                        <input type="date" id="birthday" required>
                        <p class="form-hint">请选择您的出生年月日</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="birthtime"><i class="fas fa-clock"></i> 出生时间</label>
                        <select id="birthtime" required>
                            <option value="">请选择出生时辰</option>
                            <option value="23-1">子时 (23:00-1:00)</option>
                            <option value="1-3">丑时 (1:00-3:00)</option>
                            <option value="3-5">寅时 (3:00-5:00)</option>
                            <option value="5-7">卯时 (5:00-7:00)</option>
                            <option value="7-9">辰时 (7:00-9:00)</option>
                            <option value="9-11">巳时 (9:00-11:00)</option>
                            <option value="11-13">午时 (11:00-13:00)</option>
                            <option value="13-15">未时 (13:00-15:00)</option>
                            <option value="15-17">申时 (15:00-17:00)</option>
                            <option value="17-19">酉时 (17:00-19:00)</option>
                            <option value="19-21">戌时 (19:00-21:00)</option>
                            <option value="21-23">亥时 (21:00-23:00)</option>
                        </select>
                        <p class="form-hint">请选择您的出生时辰</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="wishContent"><i class="fas fa-star"></i> 愿望内容</label>
                        <textarea id="wishContent" rows="4" maxlength="200" placeholder="写下您真诚的愿望(限200字以内)..." required></textarea>
                        <p class="form-hint">已输入 <span id="charCount">0</span>/200 字</p>
                        <p class="bazi-info" id="baziInfo"></p>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-eye"></i> 愿望可见性</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="visibility" value="public" checked>
                                <span class="radio-custom"></span>
                                <span class="radio-label">公开愿望</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="visibility" value="private">
                                <span class="radio-custom"></span>
                                <span class="radio-label">隐藏愿望</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="wishType"><i class="fas fa-tags"></i> 愿望类型</label>
                        <select id="wishType">
                            <option value="love">姻缘感情</option>
                            <option value="wealth">财富事业</option>
                            <option value="health">健康平安</option>
                            <option value="study">学业成长</option>
                            <option value="family">家庭和睦</option>
                            <option value="other">其他愿望</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-mingyuan">
                            <i class="fas fa-paper-plane"></i> 投入命缘池
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- 愿望池展示 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-water"></i>
                <h2>愿望池</h2>
                <div class="filter-controls">
                    <select id="wishFilter">
                        <option value="all">全部愿望</option>
                        <option value="love">姻缘感情</option>
                        <option value="wealth">财富事业</option>
                        <option value="health">健康平安</option>
                        <option value="study">学业成长</option>
                        <option value="family">家庭和睦</option>
                    </select>
                    <select id="sortFilter">
                        <option value="newest">最新愿望</option>
                        <option value="oldest">最早愿望</option>
                        <option value="most">最多加持</option>
                        <option value="least">最少加持</option>
                    </select>
                </div>
            </div>
            
            <div class="wish-pool">
                <div class="wish-loading">
                    <div class="loader"></div>
                    <p>正在连接命缘池能量场...</p>
                </div>
            </div>
            
            <div class="pagination">
                <button id="prevPage" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="pageInfo">第 1 页</span>
                <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <!-- 能量统计 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-chart-line"></i>
                <h2>能量统计</h2>
            </div>
            
           <div class="card-grid">
              <div class="card hover-card" id="energyStatsCard">
                <div class="card-title">
                  <i class="fas fa-bolt" style="color: #f39c12;"></i> 今日能量
                  <button id="refreshStatsBtn" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
                <div class="card-content">
                  <!-- 新增愿望 -->
                  <div class="stat-card" onclick="fetchWishes('new')">
                    <div class="stat-value" id="newWishesCount">0</div>
                    <div class="stat-label">
                      新增愿望
                      <span class="stat-trend" id="wishesTrend"></span>
                    </div>
                  </div>
                  
                  <!-- 加持次数（重点修改部分） -->
                  <div class="stat-card highlight" onclick="fetchBlessings()">
                    <div class="stat-value" id="blessingsCount">0</div>
                    <div class="stat-label">
                      加持次数
                    </div>
                  </div>
                  
                  <!-- 还愿次数 -->
                  <div class="stat-card" onclick="fetchFulfillments()">
                    <div class="stat-value" id="fulfilledCount">0</div>
                    <div class="stat-label">
                      还愿次数
                    
                    </div>
                  </div>
                </div>
                
                <div class="card-footer">
                  最后更新: <span id="lastUpdated">刚刚</span>
                </div>
              </div>
        
                
                <div class="card hover-card">
                    <div class="card-title">
                        <i class="fas fa-chart-pie" style="color: #e84393;"></i> 愿望分布
                    </div>
                    <div class="card-content">
                        <canvas id="wishchart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 使用说明 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-book"></i>
                <h2>诚心须知</h2>
            </div>
            
            <div class="card">
                <div class="note-box important">
                    <h4><i class="fas fa-lightbulb"></i> 心诚则灵</h4>
                    <ul>
                        <li>请确保八字信息准确无误，这是愿望的能量标识</li>
                        <li>愿望内容需真诚具体，避免模糊或负面表述</li>
                        <li>在加持他人愿望时，请保持善念，能量会回馈于你</li>
                        <li>愿望达成后请及时还愿，完成能量循环</li>
                        <li>每个愿望有效期为30天，到期后自动从池中移除</li>
                    </ul>
                    
                    <div class="disclaimer-box">
                        <h4><i class="fas fa-info-circle"></i> 重要说明</h4>
                        <p>每个愿望都有六字真言（唵嘛呢叭咪吽）加持，这是佛教密宗核心咒语，具有净化业障、开启智慧、积累功德的核心作用，其功能涵盖身心修行与世俗利益双重维度‌。该真言通过持诵可净化身、语、意三业，消除贪嗔痴等根本烦恼，同时获得观世音菩萨加持，实现健康、财富、智慧等现实愿求。‌‌</p>
                        <blockquote>
                            《道德经》云："天道无亲，常与善人"。命缘池的能量运作遵循自然法则，多行善事能增强愿望实现的几率。
                        </blockquote>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 命缘池. 保留所有权利.</p>
            <p>汇聚善念，共振美好</p>
        </div>
    </footer>

    <!-- 六字真言特效 -->
    <div class="mantra-overlay" id="mantraOverlay">
        <div class="mantra-container">
            <div class="mantra-beam"></div>
            <div class="mantra-text" data-text="唵">唵</div>
            <div class="mantra-text" data-text="嘛">嘛</div>
            <div class="mantra-text" data-text="呢">呢</div>
            <div class="mantra-text" data-text="叭">叭</div>
            <div class="mantra-text" data-text="咪">咪</div>
            <div class="mantra-text" data-text="吽">吽</div>
        </div>
    </div>
    
    <!-- 登录提示模态框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3><i class="fas fa-user-lock"></i> 需要登录</h3>
            <p>您需要先登录才能加持愿望</p>
            <div class="modal-actions">
                <button id="cancelLogin" class="btn-cancel">取消</button>
                <button id="confirmLogin" class="btn-confirm">前往登录</button>
            </div>
        </div>
    </div>
    
   <!-- 还愿模态框 -->
    <div id="fulfillModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3><i class="fas fa-hand-holding-heart"></i> 感恩还愿</h3>
        <p>您的愿望已经实现，请选择还愿金额：</p>
        
        <!-- 金额选择 -->
        <div class="fulfill-options">
          <button class="fulfill-option" data-amount="0.01">1元</button>
          <button class="fulfill-option" data-amount="5">5元</button>
          <button class="fulfill-option" data-amount="10">10元</button>
          <button class="fulfill-option" data-amount="20">20元</button>
        </div>    
    <script>
        
document.addEventListener('DOMContentLoaded', function() {
    // 配置后端地址
    const API_BASE = 'https://bazi-backend.owenjass.workers.dev';
    const API_URL = `${API_BASE}/api`;
    // 全局变量
    let allWishes = [];
    let currentPage = 1;
    const wishesPerPage = 9;
    
    // 获取DOM元素
    const wishFilter = document.getElementById('wishFilter');
    const sortFilter = document.getElementById('sortFilter');
    const wishPool = document.querySelector('.wish-pool');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    const wishForm = document.getElementById('wishForm');
    const baziInfo = document.getElementById('baziInfo');
    const fulfillModal = document.getElementById('fulfillModal');

    // ==================== 新增：模态框关闭逻辑 ====================
    function setupModalClose() {
        // 1. 点击X按钮关闭
        const closeModalBtn = fulfillModal.querySelector('.close-modal');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                fulfillModal.style.display = 'none';
            });
        }

        // 2. 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === fulfillModal) {
                fulfillModal.style.display = 'none';
            }
        });
    }

    // 初始化模态框关闭功能
    if (fulfillModal) {
        setupModalClose();
    } else {
        console.warn('未找到还愿模态框元素');
    }

    // 绑定表单提交事件
    wishForm.addEventListener('submit', handleSubmitWish);

    // 初始化加载愿望数据
    async function loadAllWishes() {
        try {
            wishPool.innerHTML = `
                <div class="wish-loading">
                    <div class="loader"></div>
                    <p>正在连接命缘池能量场...</p>
                </div>
            `;

            const response = await fetch(API_URL + '?visibility=public');
            const data = await response.json();
            
            allWishes = Array.isArray(data) ? data : data.data || [];
            
            if (!Array.isArray(allWishes)) {
                throw new Error('返回的不是愿望数组');
            }
            
            renderFilteredWishes();
            updatePagination();
            
        } catch (err) {
            console.error('加载愿望时出错:', err);
            wishPool.innerHTML = `
                <div class="wish-loading">
                    <i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i>
                    <p>加载失败：${err.message}</p>
                    <button onclick="loadAllWishes()" class="btn-mingyuan" style="padding: 8px 20px; font-size: 0.9rem;">
                        <i class="fas fa-sync-alt"></i> 重新加载
                    </button>
                </div>
            `;
        }
    }


             // 初始化表单提交
            wishForm.addEventListener('submit', handleSubmitWish);
            
            // 生成八字信息
            function generateBazi(birthday, birthtime) {
                // 使用lunar.js计算
                const bazi = calculateBazi(birthday, birthtime);
                if (bazi) return bazi;
                
                // 如果计算失败，返回提示信息
                console.error('使用lunar.js计算八字失败');
                return "八字计算失败，请检查输入";
            }
            
            // 更新八字信息显示
            function updateBaziInfo() {
                const birthday = document.getElementById('birthday').value;
                const birthtime = document.getElementById('birthtime').value;
                
                if (birthday && birthtime) {
                    // 显示加载状态
                    baziInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 计算中...';
                    baziInfo.style.display = 'block';
                    
                    // 延迟计算以避免频繁调用
                    setTimeout(() => {
                        const bazi = calculateBazi(birthday, birthtime);
                        if (bazi) {
                            baziInfo.innerHTML = `您的八字：<strong>${bazi}</strong>`;
                        } else {
                            baziInfo.innerHTML = '<span style="color:#ff6b6b">八字计算失败，请检查输入</span>';
                        }
                    }, 300);
                } else {
                    baziInfo.style.display = 'none';
                }
            }

            // 添加出生日期和时间变化的事件监听
            document.getElementById('birthday').addEventListener('change', updateBaziInfo);
            document.getElementById('birthtime').addEventListener('change', updateBaziInfo);
            
            // 加载lunar.js库
            function loadLunarJS() {
                return new Promise((resolve, reject) => {
                    if (typeof Lunar !== 'undefined') {
                        resolve();
                        return;
                    }
            
                    const script = document.createElement('script');
                    // 指定 1.7.3 版本
                    script.src = 'https://cdn.jsdelivr.net/npm/lunar-javascript@1.7.3/dist/lunar.min.js';
                    script.onload = () => {
                        console.log('lunar.js 1.7.3 加载成功');
                        resolve();
                    };
                    script.onerror = (error) => {
                        console.error('lunar.js 1.7.3 加载失败:', error);
                        reject(error);
                    };
                    document.head.appendChild(script);
                });
            }
            
            // 使用lunar.js计算八字
            function calculateBazi(birthday, birthtime) {
    if (!birthday || !birthtime) return null;
    
    try {
        // 解析日期
        const [year, month, day] = birthday.split('-').map(Number);
        const [hourStr] = birthtime.split('-');
        const hour = parseInt(hourStr, 10);
        
        // 1.7.3版本时辰处理
        const timeIndex = Math.floor(((hour + 1) % 24) / 2);
        const timeNames = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        const timeZhi = timeNames[timeIndex];
        
        // 创建公历日期对象
        const solarDate = new Date(year, month - 1, day);
        
        // 使用lunar.js 1.7.3计算
        const lunarDate = Lunar.fromDate(solarDate);
        
        // 年柱
        const ganzhiYear = lunarDate.getYearInGanZhi();
        // 月柱
        const ganzhiMonth = lunarDate.getMonthInGanZhi();
        // 日柱
        const ganzhiDay = lunarDate.getDayInGanZhi();
        
        // 时柱计算（五鼠遁）
        const dayGan = ganzhiDay.substring(0, 1); // 日干
        const timeGan = getTimeGan(dayGan, timeZhi);
        
        return `${ganzhiYear} ${ganzhiMonth} ${ganzhiDay} ${timeGan}${timeZhi}`;
    } catch (error) {
        console.error('八字计算错误:', error);
        return null;
    }
}

            // 五鼠遁计算时干
            function getTimeGan(dayGan, timeZhi) {
    const ganOrder = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    const zhiOrder = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
    
    const startGanMap = {
        '甲': '甲', '乙': '丙', '丙': '戊', '丁': '庚', 
        '戊': '壬', '己': '甲', '庚': '丙', '辛': '戊', 
        '壬': '庚', '癸': '壬'
    };
    
    const startGan = startGanMap[dayGan];
    const startIndex = ganOrder.indexOf(startGan);
    const timeIndex = zhiOrder.indexOf(timeZhi);
    
    return ganOrder[(startIndex + timeIndex) % 10];
}
             
    // 表单提交处理
    async function handleSubmitWish(e) {
  e.preventDefault();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;

  // 1. 结构化数据采集
  const formData = {
    user_name: document.getElementById('name')?.value.trim() || '',
    birth_date: document.getElementById('birthday')?.value || '',
    birth_time: document.getElementById('birthtime')?.value || '',
    content: document.getElementById('wishContent')?.value.trim() || '',
    type: document.getElementById('wishType')?.value || 'other',
    visibility: document.querySelector('input[name="visibility"]:checked')?.value || 'public',
    bazi: calculateBazi(
      document.getElementById('birthday')?.value,
      document.getElementById('birthtime')?.value
    ) || '',
    solar_date: new Date().toISOString().split('T')[0]
  };

  console.debug('提交数据详情:', JSON.stringify(formData, null, 2)); // 关键调试点

  try {
    // 2. 增强验证
    if (!formData.user_name) throw new Error('姓名不能为空');
    if (!formData.birth_date) throw new Error('请选择出生日期');
    if (!formData.birth_time) throw new Error('请选择出生时辰');
    if (formData.content.length > 200) throw new Error('愿望内容超过200字限制');

    // 3. Token验证
    const token = localStorage.getItem('token');
    if (!token) {
      showLoginModal('会话已过期，请重新登录');
      return;
    }

    // 4. 发送请求
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';

    const response = await fetch(`${API_URL}/wishes`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(formData)
    });

    console.debug('响应状态:', response.status); // 关键调试点

    if (!response.ok) {
      const errorText = await response.text();
      console.error('错误响应内容:', errorText); // 关键调试点
      throw new Error(errorText || `请求失败 (${response.status})`);
    }

    // 5. 成功处理
    const result = await response.json();
    console.debug('提交成功:', result); // 关键调试点
    showSuccessMessage('愿望已成功提交！');
    resetWishForm();
    loadAllWishes();

  } catch (error) {
    console.error('完整错误上下文:', {
      error: error.message,
      stack: error.stack,
      formData, // 确保可访问
      timestamp: new Date().toISOString()
    });
    
    showErrorMessage(
      error.message.includes('Failed to fetch') ? 
      '网络连接失败，请检查网络' : 
      error.message
    );
    
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    }
  }
}

// 新增的Token刷新函数
async function refreshToken(oldToken) {
  try {
    const response = await fetch(`${API_URL}/refresh-token`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${oldToken}`
      }
    });
    
    if (response.ok) {
      const { token } = await response.json();
      localStorage.setItem('token', token);
      return true;
    }
    return false;
  } catch (error) {
    console.error('刷新Token失败:', error);
    return false;
  }
}

// 在每次API调用前检查Token
async function safeApiCall(url, options = {}) {
  await checkAndRefreshToken();
  
  const token = localStorage.getItem('token');
  if (token) {
    options.headers = {
      ...options.headers,
      'Authorization': `Bearer ${token}`
    };
  }
  
  const response = await fetch(url, options);
  
  if (response.status === 401) {
    localStorage.removeItem('token');
    showLoginModal('登录已过期，请重新登录');
    throw new Error('Unauthorized');
  }
  
  return response;
}
    

// 辅助函数：显示登录模态框
function showLoginModal(message) {
  const modal = document.getElementById('loginModal');
  modal.querySelector('p').textContent = message;
  modal.style.display = 'block';
  
  // 设置确认按钮跳转
  const confirmBtn = modal.querySelector('#confirmLogin');
  confirmBtn.onclick = () => {
    window.location.href = 'user.html?redirect=' + 
      encodeURIComponent(window.location.pathname + window.location.search);
  };
}

// 辅助函数：显示成功消息
function showSuccessMessage(message) {
  const toast = document.createElement('div');
  toast.className = 'toast success';
  toast.innerHTML = `
    <i class="fas fa-check-circle"></i>
    ${message}
  `;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }, 100);
}

// 辅助函数：显示错误消息
function showErrorMessage(message) {
  const toast = document.createElement('div');
  toast.className = 'toast error';
  toast.innerHTML = `
    <i class="fas fa-exclamation-circle"></i>
    ${message}
  `;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }, 100);
}

    function safeParseJwt(token) {
  try {
    if (!token) return null;
    
    // Base64 URL 安全解码
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
      atob(base64)
        .split('')
        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
        .join('')
    );
    
    return JSON.parse(jsonPayload);
  } catch (e) {
    console.error('Token 解析失败:', e);
    // 清除无效 token
    localStorage.removeItem('token');
    return null;
  }
}
    
// 添加在全局脚本区域
function isValidJWT(token) {
    if (!token) return false;
    const parts = token.split('.');
    return parts.length === 3 && 
           parts[0].length > 0 && 
           parts[1].length > 0 && 
           parts[2].length > 0;
}
    
// 替换原有的登录跳转代码
function showLoginModal(message) {
    const modal = document.getElementById('loginModal');
    modal.querySelector('p').textContent = message;
    modal.style.display = 'block';
    
    // 修改确认按钮跳转路径
    const confirmBtn = modal.querySelector('#confirmLogin');
    confirmBtn.onclick = () => {
        // 使用相对路径，保留当前URL参数
        const params = new URLSearchParams(window.location.search);
        window.location.href = `user.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
    };
    
    // 取消按钮关闭模态框
    modal.querySelector('#cancelLogin').onclick = () => {
        modal.style.display = 'none';
    };
}

     // 渲染愿望列表
            async function renderWishes() {
  try {
    const response = await fetch(`${API_URL}/wishes?visibility=public`);
    
    if (!response.ok) {
      throw new Error(`请求失败: ${response.status}`);
    }
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error('响应不是JSON格式');
    }
    
    const data = await response.json();
    const wishes = Array.isArray(data) ? data : (data.wishes || []);
    
    if (!Array.isArray(wishes)) {
      throw new Error('无效的愿望数据格式');
    }
    
    renderWishCards(wishes);
    
  } catch (err) {
    console.error('渲染愿望时出错:', err);
    wishPool.innerHTML = `
      <div class="wish-error">
        <i class="fas fa-exclamation-triangle"></i>
        <p>加载失败: ${err.message}</p>
        <button onclick="renderWishes()" class="btn-retry">重试</button>
      </div>
    `;
  }
}
                            
            // 更新统计信息
            async function updateStats() {
              try {
                const response = await fetch('https://bazi-backend.owenjass.workers.dev/api/stats?_=' + Date.now());
                
                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.details || '请求失败');
                }
            
                const data = await response.json();
                
                // 调试日志
                console.log('统计数据:', {
                  blessings: data.today.blessings,
                  rawData: data
                });
            
                // 更新UI
                document.getElementById('blessingsCount').textContent = data.today.blessings || 0;
                
              } catch (error) {
                console.error('更新统计失败:', {
                  error: error.message,
                  stack: error.stack
                });
              }
            }

    // 应用筛选和排序并渲染当前页的愿望
    async function renderFilteredWishes() {
    // 1. 获取筛选条件和排序方式
    const selectedType = wishFilter.value;
    const selectedSort = sortFilter.value;
    
    // 2. 获取当前登录用户ID
    let currentUserId = null;
    try {
        const token = localStorage.getItem('token');
        if (token) {
            // Instead of directly verifying, you could:
            // Option 1: Make an API call to verify the token
            // const response = await fetch(`${API_BASE}/api/verify-token`, {
            //     headers: { 'Authorization': `Bearer ${token}` }
            // });
            // const data = await response.json();
            // currentUserId = data.userId;
            
            // Option 2: Just decode the token without verifying (less secure)
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentUserId = payload.id;
        }
    } catch (error) {
        console.error('Token解析失败:', error);
        // Handle invalid token (e.g., remove it)
        localStorage.removeItem('token');
    }

    // 3. 应用筛选条件
    let filteredWishes = allWishes.filter(wish => {
        // "我的愿望"专属筛选
        if (selectedType === 'my') {
            return currentUserId && wish.user_id === currentUserId;
        }
        // 其他类型筛选
        else if (selectedType !== 'all') {
            return wish.type === selectedType;
        }
        // "全部愿望"不筛选
        return true;
    });

    // 4. 处理空状态
    if (filteredWishes.length === 0) {
        wishPool.innerHTML = createEmptyState(selectedType, !!currentUserId);
        return;
    }

    // 5. 应用排序
    filteredWishes = sortWishes(filteredWishes, selectedSort);

    // 6. 分页处理
    const startIndex = (currentPage - 1) * wishesPerPage;
    const paginatedWishes = filteredWishes.slice(startIndex, startIndex + wishesPerPage);

    // 7. 渲染愿望卡片
    renderWishCards(paginatedWishes);
}

// 辅助函数：创建空状态提示
function createEmptyState(selectedType, isLoggedIn) {
    const emptyState = document.createElement('div');
    emptyState.className = 'wish-empty';
    
    if (selectedType === 'my') {
        if (!isLoggedIn) {
            emptyState.innerHTML = `
                <i class="fas fa-lock"></i>
                <h3>请登录查看您的愿望</h3>
                <button onclick="window.location.href='/login.html'" class="btn-mingyuan">
                    <i class="fas fa-sign-in-alt"></i> 立即登录
                </button>
            `;
        } else {
            emptyState.innerHTML = `
                <i class="fas fa-star"></i>
                <h3>您还没有许过愿望</h3>
                <button onclick="document.querySelector('#wishContent').focus()" class="btn-mingyuan">
                    <i class="fas fa-plus"></i> 创建第一个愿望
                </button>
            `;
        }
    } else {
        emptyState.innerHTML = `
            <i class="fas fa-water"></i>
            <h3>没有找到符合条件的愿望</h3>
            <p>尝试调整筛选条件或创建新愿望</p>
            ${!isLoggedIn ? `
            <button onclick="window.location.href='/login.html'" class="btn-mingyuan">
                <i class="fas fa-sign-in-alt"></i> 登录后查看更多
            </button>
            ` : ''}
        `;
    }
    
    return emptyState;
}

// 辅助函数：愿望排序
function sortWishes(wishes, sortType) {
    const sorted = [...wishes];
    switch(sortType) {
        case 'newest':
            return sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        case 'oldest':
            return sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        case 'most':
            return sorted.sort((a, b) => (b.blessings || 0) - (a.blessings || 0));
        case 'least':
            return sorted.sort((a, b) => (a.blessings || 0) - (b.blessings || 0));
        default:
            return sorted;
    }
}

// 辅助函数：渲染愿望卡片
function renderWishCards(wishes) {
    wishPool.innerHTML = '';
    
    wishes.forEach(wish => {
        const card = document.createElement('div');
        card.className = 'wish-card';
        card.dataset.id = wish.id;
        card.dataset.level = wish.level || 1;
        
        // 计算剩余天数
        const expiresAt = new Date(wish.created_at);
        expiresAt.setDate(expiresAt.getDate() + 30);
        const daysLeft = Math.max(0, Math.ceil((expiresAt - new Date()) / 86400000));
        
        card.innerHTML = `
            <div class="wish-header">
                <div class="wish-user">
                    <i class="fas fa-user"></i> ${wish.user_name || '匿名用户'}
                </div>
                <span class="wish-type">${getWishTypeName(wish.type)}</span>
                <span class="wish-time">剩余${daysLeft}天</span>
            </div>
            <div class="wish-content">
                <p class="wish-text">${wish.content}</p>
            </div>
            <div class="wish-meta">
                <div class="wish-bazi">
                    <i class="fas fa-user-secret"></i> ${wish.bazi}
                </div>
                <div class="wish-stats">
                    <span class="bless-count">${wish.blessings || 0}</span> 次加持
                </div>
            </div>
            <div class="wish-actions">
                <button class="btn-bless">
                    <i class="fas fa-hands-helping"></i> 加持
                </button>
                ${wish.user_id === currentUserId ? `
                <button class="btn-fulfill">
                    <i class="fas fa-hand-holding-heart"></i> 还愿
                </button>
                ` : ''}
            </div>
            <div class="wish-energy">
                <div class="energy-level" style="width: ${(wish.level || 1) * 20}%"></div>
            </div>
        `;
        
        // 添加事件监听
        card.querySelector('.btn-bless').addEventListener('click', () => handleBlessWish(wish.id));
        if (wish.user_id === currentUserId) {
            card.querySelector('.btn-fulfill').addEventListener('click', () => handleFulfillWish(wish.id));
        }
        
        wishPool.appendChild(card);
    });
}

// 辅助函数：获取愿望类型名称
function getWishTypeName(type) {
    const typeNames = {
        love: '姻缘感情',
        wealth: '财富事业', 
        health: '健康平安',
        study: '学业成长',
        family: '家庭和睦',
        other: '其他愿望'
    };
    return typeNames[type] || '其他愿望';
}

    // 处理加持愿望
    async function handleBlessWish(cardElement, wish) {
        try {
            // 检查登录状态
            const token = localStorage.getItem('token');
            if (!token) {
                const shouldLogin = confirm('您需要先登录才能加持\n\n点击"确定"跳转到登录页面');
                if (shouldLogin) window.location.href = '/system/user.html';
                return;
            }
        
            // 检查本地加持记录
            const lastBlessKey = `lastBless_${wish.id}`;
            const lastBlessTime = localStorage.getItem(lastBlessKey);
            const now = Date.now();
            
            if (lastBlessTime && (now - parseInt(lastBlessTime)) < 3600000) {
                const nextBlessTime = new Date(parseInt(lastBlessTime) + 3600000);
                showToast(`每小时只能加持一次，请于 ${nextBlessTime.toLocaleTimeString()} 后再试`);
                return;
            }
        
            // 获取加持按钮并禁用
            const blessBtn = cardElement.querySelector('.btn-bless');
            blessBtn.disabled = true;
            blessBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加持中...';
        
            // 显示特效
            await showMantraEffect();
        
            // 发送请求
            const blessUrl = `${API_BASE}/api/bless/${wish.id}`;
            
            const response = await fetch(blessUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({})
            });
        
            // 处理响应
            if (!response.ok) {
                const errorData = await response.json();
                if (errorData.code === 429) {
                    localStorage.setItem(lastBlessKey, new Date(errorData.nextBlessTime).getTime() - 3600000);
                    showToast(errorData.error);
                    return;
                }
                throw new Error(`加持失败 (${response.status}): ${JSON.stringify(errorData)}`);
            }
        
            const result = await response.json();
            console.log('加持结果:', result);
        
            // 记录本次加持时间
            localStorage.setItem(lastBlessKey, now.toString());
        
            // 更新UI
            cardElement.querySelector('.bless-count').textContent = result.blessings;
            cardElement.dataset.level = result.level;
            cardElement.querySelector('.energy-level').style.width = `${result.level * 20}%`;
            
            // 显示成功动画
            cardElement.classList.add('level-up');
            setTimeout(() => cardElement.classList.remove('level-up'), 1000);
            
            // 提示用户
            const levelNames = ['初愿', '小成', '中成', '大成', '圆满'];
            showSuccessMessage(`加持成功！当前能量：${levelNames[result.level - 1]}`);
        
        } catch (error) {
            console.error('加持出错:', error);
            showErrorMessage(error.message);
        } finally {
            // 重置按钮状态
            const blessBtn = cardElement.querySelector('.btn-bless');
            if (blessBtn) {
                blessBtn.disabled = false;
                blessBtn.innerHTML = '<i class="fas fa-hands-helping"></i> 加持';
            }
        }
    }

     // 图表初始化
            const energyChart = new Chart(document.getElementById('energyChart'), {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                    datasets: [{
                        label: '能量强度',
                        data: [65, 79, 90, 81, 56, 75],
                        borderColor: '#6a11cb',
                        backgroundColor: 'rgba(106, 17, 203, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#6a11cb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#b8c2cc' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#b8c2cc' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { backgroundColor: 'rgba(10, 10, 20, 0.9)' }
                    }
                }
            });
            
            // 愿望类型图表
            const wishTypeChart = new Chart(document.getElementById('wishTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['姻缘感情', '财富事业', '健康平安', '学业成长', '家庭和睦', '其他愿望'],
                    datasets: [{
                        data: [35, 25, 15, 10, 10, 5],
                        backgroundColor: [
                            '#6a11cb', '#2575fc', '#00b894', '#fdcb6e', '#e17055', '#b2bec3'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#b8c2cc' } },
                        tooltip: { backgroundColor: 'rgba(10, 10, 20, 0.9)' }
                    }
                }
            });
            renderWishes();  // 加上这行：初始化时就加载愿望池内容
            fetchStats();// 添加统计获取调用
            setInterval(fetchStats, 5 * 60 * 1000);// 每5分钟自动更新一次统计数据

            // 更新获取统计数据的函数
               async function fetchStats() {
  try {
    // 添加时间戳防止缓存
    const apiUrl = `${API_BASE}/api/stats?t=${Date.now()}`;
    console.log('正在请求统计接口:', apiUrl); // 调试日志
    
    const response = await fetch(apiUrl);
    
    if (!response.ok) {
      throw new Error(`请求失败: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('接口返回数据:', data); // 调试日志
    
    // 确保数据结构正确（双重保护）
    const stats = data.today || {};
    const fulfilledCount = stats.fulfilled !== undefined ? stats.fulfilled : 0;
    
    console.log('计算出的还愿次数:', fulfilledCount); // 调试日志
    
    // 更新页面显示
    const fulfilledElement = document.getElementById('fulfilledCount');
    if (fulfilledElement) {
      fulfilledElement.textContent = fulfilledCount;
    } else {
      console.error('错误: 找不到ID为fulfilledCount的元素');
    }
    
    // 更新其他统计信息（保持原有逻辑）
    document.getElementById('newWishesCount').textContent = stats.newWishes || 0;
    document.getElementById('blessingsCount').textContent = stats.blessings || 0;
    
    // 更新最后更新时间
    const now = new Date();
    document.getElementById('lastUpdated').textContent = 
      `最后更新: ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    // 如果有分布数据则渲染图表
    if (data.distribution) {
      renderDistributionChart(data.distribution);
    }
    
  } catch (err) {
    console.error('加载统计数据失败:', err);
    
    // 显示错误状态
    document.getElementById('fulfilledCount').textContent = '?';
    document.getElementById('lastUpdated').textContent = '更新失败';
    
    // 可选：显示错误提示
    showToast(`统计加载失败: ${err.message}`, 'error');
  }
}
                
                // 渲染愿望分布图表
                function renderDistributionChart(distribution) {
                    // 获取canvas元素
                    const ctx = document.getElementById('wishchart').getContext('2d');
                    
                    // 确保之前的图表实例被销毁
                    if (window.wishDistributionChart) {
                        window.wishDistributionChart.destroy();
                    }
                    
                    // 准备图表数据
                    const labels = Object.keys(distribution);
                    const data = Object.values(distribution);
                    
                    // 创建新图表
                    window.wishDistributionChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#6a11cb', 
                                    '#2575fc', 
                                    '#00b894', 
                                    '#fdcb6e', 
                                    '#e17055', 
                                    '#b2bec3'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#b8c2cc',
                                        font: {
                                            family: "'Noto Serif SC', serif"
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(10, 10, 20, 0.9)',
                                    titleFont: {
                                        family: "'Noto Serif SC', serif"
                                    },
                                    bodyFont: {
                                        family: "'Noto Serif SC', serif"
                                    }
                                }
                            }
                        }
                    });
                }
    
       // 修改后的还愿处理函数
        async function handleFulfillWish(wish) {
  try {
    // 1. 检查是否已登录
    const token = localStorage.getItem('token');
    if (!token) {
      const shouldLogin = confirm('请先登录后再还愿');
      if (shouldLogin) window.location.href = '/user.html';
      return;
    }

    // 2. 立即更新is_fulfilled字段为true
    const updateResponse = await fetch(`${API_BASE}/api/wishes/${wish.id}/fulfill`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!updateResponse.ok) {
      throw new Error('更新还愿状态失败');
    }

    // 3. 显示还愿模态框
    const modal = document.getElementById('fulfillModal');
    if (!modal) {
      throw new Error('找不到还愿模态框');
    }
    
    // 设置愿望ID到模态框
    modal.dataset.wishId = wish.id;
    modal.style.display = 'block';
  
    // 4. 初始化支付选项
    if (window.wwPay) {
      window.wwPay.resetPaymentState();
    }
  } catch (error) {
    console.error('还愿初始化失败:', error);
    alert('还愿失败: ' + error.message);
  }
}

    // 更新分页信息
    function updatePagination() {
        const selectedType = wishFilter.value;
        let filteredWishes = [...allWishes];
        
        if (selectedType !== 'all') {
            filteredWishes = allWishes.filter(wish => wish.type === selectedType);
        }
        
        const totalPages = Math.ceil(filteredWishes.length / wishesPerPage);
        
        pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
    }

    // 显示六字真言特效
    async function showMantraEffect() {
        return new Promise((resolve) => {
            const overlay = document.getElementById('mantraOverlay');
            const container = overlay.querySelector('.mantra-container');
            
            // 重置状态
            overlay.classList.remove('active');
            document.querySelectorAll('.mantra-particle, .mantra-symbol, .mantra-circle').forEach(el => el.remove());
            
            // 创建背景元素
            createMantraBackground(container);
            
            // 显示叠加层
            setTimeout(() => {
                overlay.classList.add('active');
                
                // 文字逐个显示动画
                const texts = document.querySelectorAll('.mantra-text');
                texts.forEach((text, index) => {
                    setTimeout(() => {
                        text.classList.add('active');
                        
                        // 每个文字显示时创建粒子爆发
                        if(index % 2 === 0) createParticleBurst(text);
                        
                    }, index * 300);
                });
                
                // 7秒后结束
                setTimeout(() => {
                    overlay.classList.remove('active');
                    setTimeout(resolve, 800);
                }, 7000);
            }, 50);
        });
    }

    // 创建背景元素
    function createMantraBackground(container) {
        // 创建扫描光束
        for(let i = 0; i < 3; i++) {
            const beam = document.createElement('div');
            beam.className = 'mantra-beam';
            beam.style.left = `${Math.random() * 100}%`;
            beam.style.animationDelay = `${Math.random() * 5}s`;
            container.appendChild(beam);
        }
        
        // 创建脉动圆圈
        for(let i = 0; i < 5; i++) {
            const circle = document.createElement('div');
            circle.className = 'mantra-circle';
            circle.style.width = `${Math.random() * 200 + 100}px`;
            circle.style.height = circle.style.width;
            circle.style.left = `${Math.random() * 100}%`;
            circle.style.top = `${Math.random() * 100}%`;
            circle.style.animationDelay = `${Math.random() * 3}s`;
            container.appendChild(circle);
        }
        
        // 创建漂浮符号
        const symbols = ['☯', '☵', '☲', '☶', '☷', '☰', '☱', '☳', '☴', '卍', '⛩', '🪬', '📿', '⛥', '⛧', '⛤'];
        for(let i = 0; i < 25; i++) {
            const symbol = document.createElement('div');
            symbol.className = 'mantra-symbol';
            symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            symbol.style.left = `${Math.random() * 100}%`;
            symbol.style.fontSize = `${Math.random() * 3 + 2}rem`;
            symbol.style.animation = `symbolFloat ${Math.random() * 15 + 10}s linear ${Math.random() * 5}s infinite`;
            container.appendChild(symbol);
        }
    }

    // 显示Toast消息
    function showToast(message, type = 'success') {
        // 移除现有的toast
        document.querySelectorAll('.toast').forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(toast);
        
        // 显示动画
        setTimeout(() => toast.classList.add('show'), 100);
        
        // 3秒后自动消失
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 显示成功消息
    function showSuccessMessage(message) {
        showToast(message, 'success');
    }
    
    // 显示错误消息
    function showErrorMessage(message) {
        showToast(message, 'error');
    }

    // 初始化事件监听
    function initEventListeners() {
        // 筛选变化
        wishFilter.addEventListener('change', () => {
            currentPage = 1;
            renderFilteredWishes();
            updatePagination();
        });
        
        sortFilter.addEventListener('change', () => {
            currentPage = 1;
            renderFilteredWishes();
        });
        
        // 分页按钮
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderFilteredWishes();
                updatePagination();
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            const selectedType = wishFilter.value;
            let filteredWishes = [...allWishes];
            
            if (selectedType !== 'all') {
                filteredWishes = allWishes.filter(wish => wish.type === selectedType);
            }
            
            const totalPages = Math.ceil(filteredWishes.length / wishesPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                renderFilteredWishes();
                updatePagination();
            }
        });
        
        // 全局点击关闭模态框
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('fulfillModal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // 初始化
    initEventListeners();
    loadAllWishes();
});

    </script>
</body>
</html>
