<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤åçš„èº«å¼ºèº«å¼±è®¡ç®—</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        .calculation {
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¿®å¤åçš„èº«å¼ºèº«å¼±è®¡ç®—</h1>
        <p>é’ˆå¯¹ç”¨æˆ·å…«å­—ï¼ˆä¸å¯ï¼Œå£¬å­ï¼Œä¸æœªï¼Œä¹™å·³ï¼‰çš„æ­£ç¡®è®¡ç®—</p>
        
        <button onclick="calculateFixed()">å¼€å§‹ä¿®å¤è®¡ç®—</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        
        <div id="results"></div>
    </div>

    <script>
        // åŸºç¡€æ˜ å°„
        const stemElementMap = {
            'ç”²': 'wood', 'ä¹™': 'wood',
            'ä¸™': 'fire', 'ä¸': 'fire',
            'æˆŠ': 'earth', 'å·±': 'earth',
            'åºš': 'metal', 'è¾›': 'metal',
            'å£¬': 'water', 'ç™¸': 'water'
        };
        
        const branchElementMap = {
            'å­': 'water', 'ä¸‘': 'earth',
            'å¯…': 'wood', 'å¯': 'wood',
            'è¾°': 'earth', 'å·³': 'fire',
            'åˆ': 'fire', 'æœª': 'earth',
            'ç”³': 'metal', 'é…‰': 'metal',
            'æˆŒ': 'earth', 'äº¥': 'water'
        };
        
        const BRANCH_ELEMENTS = {
            'å­': {main: 'water', hidden: ['ç™¸']},
            'ä¸‘': {main: 'earth', hidden: ['å·±', 'ç™¸', 'è¾›']},
            'å¯…': {main: 'wood', hidden: ['ç”²', 'ä¸™', 'æˆŠ']},
            'å¯': {main: 'wood', hidden: ['ä¹™']},
            'è¾°': {main: 'earth', hidden: ['æˆŠ', 'ä¹™', 'ç™¸']},
            'å·³': {main: 'fire', hidden: ['ä¸™', 'åºš', 'æˆŠ']},
            'åˆ': {main: 'fire', hidden: ['ä¸', 'å·±']},
            'æœª': {main: 'earth', hidden: ['å·±', 'ä¸', 'ä¹™']},
            'ç”³': {main: 'metal', hidden: ['åºš', 'å£¬', 'æˆŠ']},
            'é…‰': {main: 'metal', hidden: ['è¾›']},
            'æˆŒ': {main: 'earth', hidden: ['æˆŠ', 'è¾›', 'ä¸']},
            'äº¥': {main: 'water', hidden: ['å£¬', 'ç”²']}
        };
        
        function calculateFixed() {
            clearResults();
            
            try {
                // ç”¨æˆ·å…«å­—ï¼šä¸å¯ï¼Œå£¬å­ï¼Œä¸æœªï¼Œä¹™å·³
                const stems = ['ä¸', 'å£¬', 'ä¸', 'ä¹™'];
                const branches = ['å¯', 'å­', 'æœª', 'å·³'];
                const dayStem = 'ä¸';
                const monthBranch = 'å­';
                
                addResult('=== ä¿®å¤åçš„èº«å¼ºèº«å¼±è®¡ç®— ===', 'debug-section');
                addResult(`å…«å­—ï¼š${stems[0]}${branches[0]} ${stems[1]}${branches[1]} ${stems[2]}${branches[2]} ${stems[3]}${branches[3]}`, 'calculation');
                addResult(`æ—¥ä¸»ï¼š${dayStem}ç«ï¼Œæœˆä»¤ï¼š${monthBranch}æ°´`, 'calculation');
                
                // 1. åˆ†æå¤©å¹²äº”åˆï¼ˆé‡ç‚¹ï¼šä¸å£¬äº‰åˆï¼‰
                addResult('=== å¤©å¹²äº”åˆåˆ†æ ===', 'debug-section');
                const hehuaAnalysis = analyzeHehua(stems);
                addResult(hehuaAnalysis, 'calculation');
                
                // 2. è®¡ç®—äº”è¡Œåˆ†å¸ƒ
                addResult('=== äº”è¡Œåˆ†å¸ƒè®¡ç®— ===', 'debug-section');
                const elements = calculateElements(stems, branches);
                addResult(createElementTable(elements), 'calculation');
                
                // 3. æœˆä»¤å¾—åˆ†è®¡ç®—ï¼ˆä¿®å¤ï¼‰
                addResult('=== æœˆä»¤å¾—åˆ†è®¡ç®—ï¼ˆä¿®å¤ç‰ˆï¼‰===', 'debug-section');
                const monthScore = calculateFixedMonthScore(dayStem, monthBranch);
                addResult(`æœˆä»¤å¾—åˆ†ï¼š${monthScore}åˆ†`, monthScore < 0 ? 'error' : 'success');
                
                // 4. ç”Ÿæ‰¶å…‹æ³„åŠ›é‡è®¡ç®—ï¼ˆä¿®å¤ï¼‰
                addResult('=== ç”Ÿæ‰¶å…‹æ³„åŠ›é‡è®¡ç®—ï¼ˆä¿®å¤ç‰ˆï¼‰===', 'debug-section');
                const strengthAnalysis = calculateFixedStrength(dayStem, elements, hehuaAnalysis.hasJealousy);
                addResult(strengthAnalysis.analysis, 'calculation');
                
                // 5. æœ€ç»ˆèº«å¼ºèº«å¼±åˆ¤æ–­ï¼ˆä¿®å¤ï¼‰
                addResult('=== æœ€ç»ˆèº«å¼ºèº«å¼±åˆ¤æ–­ï¼ˆä¿®å¤ç‰ˆï¼‰===', 'debug-section');
                const finalAnalysis = makeFixedJudgment(strengthAnalysis, monthScore);
                addResult(finalAnalysis, finalAnalysis.includes('èº«å¼±') ? 'success' : 'error');
                
            } catch (error) {
                addResult('è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š' + error.message, 'error');
                console.error('ä¿®å¤è®¡ç®—é”™è¯¯ï¼š', error);
            }
        }
        
        function analyzeHehua(stems) {
            const tianGanHeHua = {
                'ç”²å·±': 'earth', 'ä¹™åºš': 'metal', 'ä¸™è¾›': 'water',
                'ä¸å£¬': 'wood', 'æˆŠç™¸': 'fire'
            };
            
            let analysis = '';
            const stemCounts = {};
            let hasJealousy = false;
            
            // ç»Ÿè®¡å¤©å¹²å‡ºç°æ¬¡æ•°
            stems.forEach(stem => {
                stemCounts[stem] = (stemCounts[stem] || 0) + 1;
            });
            
            analysis += `å¤©å¹²ç»Ÿè®¡ï¼š${JSON.stringify(stemCounts)}\n`;
            
            // æ£€æŸ¥ä¸å£¬åˆæœ¨çš„æƒ…å†µ
            const dingCount = stemCounts['ä¸'] || 0;
            const renCount = stemCounts['å£¬'] || 0;
            
            if (dingCount > 1 && renCount >= 1) {
                analysis += `âŒ å¦’åˆæ£€æµ‹ï¼šä¸¤ä¸ªä¸äº‰åˆä¸€ä¸ªå£¬\n`;
                analysis += `ç»“è®ºï¼šå¤©å¹²ä¸å£¬å¦’åˆï¼ŒåˆåŒ–å¤±è´¥ï¼Œåªåˆä¸åŒ–ï¼ˆç»Šåˆï¼‰\n`;
                analysis += `å½±å“ï¼šåŒæ–¹åŠ›é‡å‡å¼±ï¼Œä¸äº§ç”Ÿæ–°çš„æœ¨äº”è¡ŒåŠ›é‡\n`;
                hasJealousy = true;
            } else if (dingCount >= 1 && renCount > 1) {
                analysis += `âŒ äº‰åˆæ£€æµ‹ï¼šä¸€ä¸ªä¸ä¸ä¸¤ä¸ªå£¬ç›¸åˆ\n`;
                analysis += `ç»“è®ºï¼šå¤©å¹²ä¸å£¬äº‰åˆï¼ŒåˆåŒ–å¤±è´¥\n`;
                hasJealousy = true;
            } else if (dingCount === 1 && renCount === 1) {
                analysis += `âœ… æ­£å¸¸åˆåŒ–ï¼šä¸€ä¸ªä¸ä¸ä¸€ä¸ªå£¬ç›¸åˆ\n`;
                analysis += `ç»“è®ºï¼šå¤©å¹²ä¸å£¬åˆæœ¨æˆåŠŸ\n`;
                hasJealousy = false;
            }
            
            return { analysis, hasJealousy };
        }
        
        function calculateElements(stems, branches) {
            const elements = {
                wood: 0, fire: 0, earth: 0, metal: 0, water: 0
            };
            
            let details = 'å¤©å¹²äº”è¡Œè®¡ç®—ï¼š\n';
            
            // è®¡ç®—å¤©å¹²äº”è¡Œ
            stems.forEach((stem, index) => {
                const element = stemElementMap[stem];
                if (element) {
                    elements[element] += 1;
                    details += `${stem}(${getElementChinese(element)}) +1\n`;
                }
            });
            
            details += '\nåœ°æ”¯ä¸»æ°”è®¡ç®—ï¼š\n';
            // è®¡ç®—åœ°æ”¯äº”è¡Œï¼ˆä¸»æ°”ï¼‰
            branches.forEach((branch, index) => {
                const element = branchElementMap[branch];
                if (element) {
                    elements[element] += 1;
                    details += `${branch}(${getElementChinese(element)}) +1\n`;
                }
            });
            
            details += '\nåœ°æ”¯è—å¹²è®¡ç®—ï¼š\n';
            // è®¡ç®—åœ°æ”¯è—å¹²ï¼ˆæƒé‡0.5ï¼‰
            branches.forEach((branch, index) => {
                const branchInfo = BRANCH_ELEMENTS[branch];
                if (branchInfo && branchInfo.hidden) {
                    branchInfo.hidden.forEach(hiddenStem => {
                        const element = stemElementMap[hiddenStem];
                        if (element) {
                            elements[element] += 0.5;
                            details += `${branch}è—${hiddenStem}(${getElementChinese(element)}) +0.5\n`;
                        }
                    });
                }
            });
            
            elements.details = details;
            return elements;
        }
        
        function calculateFixedMonthScore(dayStem, monthBranch) {
            const dayElement = stemElementMap[dayStem];
            const monthElement = branchElementMap[monthBranch];
            
            // ä¸ç«åœ¨å­æ°´æœˆçš„æ­£ç¡®è®¡ç®—
            if (dayElement === 'fire' && monthElement === 'water') {
                return -20; // æ°´å…‹ç«ï¼Œè¢«å…‹
            }
            
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            if (monthElement === dayElement) {
                return 40; // å¾—ä»¤
            } else if (supportElements.includes(monthElement)) {
                return 20; // å¾—ç”Ÿ
            } else if (weakenElements.includes(monthElement)) {
                return -20; // è¢«å…‹
            } else {
                return 0; // ä¸å¾—ä»¤
            }
        }
        
        function calculateFixedStrength(dayStem, elements, hasJealousy) {
            const dayElement = stemElementMap[dayStem];
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            let supportStrength = 0;
            let weakenStrength = 0;
            let analysis = '';
            
            analysis += 'ç”Ÿæ‰¶åŠ›é‡è®¡ç®—ï¼ˆä¿®å¤ç‰ˆï¼‰ï¼š\n';
            supportElements.forEach(element => {
                let strength = elements[element];
                
                // å¦‚æœæœ‰å¦’åˆï¼Œå‡å°‘ç›¸åº”çš„åŠ›é‡
                if (hasJealousy && element === 'fire') {
                    strength -= 1; // ä¸ç«ç»Šåˆå‡å°‘1åˆ†åŠ›é‡
                    analysis += `${getElementChinese(element)}ï¼š${elements[element]} - 1ï¼ˆç»Šåˆå‡å¼±ï¼‰= ${strength}\n`;
                } else {
                    analysis += `${getElementChinese(element)}ï¼š${strength}\n`;
                }
                
                supportStrength += strength;
            });
            analysis += `ç”Ÿæ‰¶åŠ›é‡æ€»è®¡ï¼š${supportStrength}\n\n`;
            
            analysis += 'å…‹æ³„åŠ›é‡è®¡ç®—ï¼ˆä¿®å¤ç‰ˆï¼‰ï¼š\n';
            weakenElements.forEach(element => {
                let strength = elements[element];
                
                // å¦‚æœæœ‰å¦’åˆï¼Œå‡å°‘ç›¸åº”çš„åŠ›é‡
                if (hasJealousy && element === 'water') {
                    strength -= 0.5; // å£¬æ°´ç»Šåˆå‡å°‘0.5åˆ†åŠ›é‡
                    analysis += `${getElementChinese(element)}ï¼š${elements[element]} - 0.5ï¼ˆç»Šåˆå‡å¼±ï¼‰= ${strength}\n`;
                } else {
                    analysis += `${getElementChinese(element)}ï¼š${strength}\n`;
                }
                
                weakenStrength += strength;
            });
            analysis += `å…‹æ³„åŠ›é‡æ€»è®¡ï¼š${weakenStrength}\n\n`;
            
            const ratio = supportStrength / (supportStrength + weakenStrength);
            analysis += `åŠ›é‡æ¯”ä¾‹ï¼š${supportStrength} / (${supportStrength} + ${weakenStrength}) = ${(ratio * 100).toFixed(2)}%\n`;
            
            return {
                supportStrength,
                weakenStrength,
                ratio,
                analysis
            };
        }
        
        function makeFixedJudgment(strengthAnalysis, monthScore) {
            const { supportStrength, weakenStrength, ratio } = strengthAnalysis;
            const totalScore = monthScore + supportStrength - weakenStrength;
            
            let analysis = `æœ€ç»ˆè®¡ç®—ï¼ˆä¿®å¤ç‰ˆï¼‰ï¼š\n`;
            analysis += `æœˆä»¤å¾—åˆ†ï¼š${monthScore}\n`;
            analysis += `ç”Ÿæ‰¶åŠ›é‡ï¼š${supportStrength}\n`;
            analysis += `å…‹æ³„åŠ›é‡ï¼š${weakenStrength}\n`;
            analysis += `æ€»åˆ†ï¼š${monthScore} + ${supportStrength} - ${weakenStrength} = ${totalScore}\n`;
            analysis += `åŠ›é‡æ¯”ä¾‹ï¼š${(ratio * 100).toFixed(2)}%\n\n`;
            
            let judgment, description;
            if (ratio >= 0.60) {
                judgment = 'èº«å¼º';
                description = 'æ—¥ä¸»åŠ›é‡å¼ºæ—ºï¼Œèƒ½å¤Ÿæ‰¿æ‹…è´¢å®˜ï¼Œé€‚åˆä¸»åŠ¨å‡ºå‡»ï¼Œå–œç”¨è´¢å®˜ã€‚';
            } else if (ratio >= 0.40) {
                judgment = 'å‡è¡¡';
                description = 'æ—¥ä¸»åŠ›é‡é€‚ä¸­ï¼Œäº”è¡Œè¾ƒä¸ºå¹³è¡¡ï¼Œè¿åŠ¿å¹³ç¨³ï¼Œå–œç”¨å°æ¯”ã€‚';
            } else {
                judgment = 'èº«å¼±';
                description = 'æ—¥ä¸»åŠ›é‡åå¼±ï¼Œéœ€è¦ç”Ÿæ‰¶ï¼Œå®œå®ˆä¸å®œæ”»ï¼Œå–œç”¨å°æ¯”ã€‚';
            }
            
            analysis += `âœ… ä¿®å¤ååˆ¤æ–­ç»“æœï¼š${judgment}\n`;
            analysis += `è¯´æ˜ï¼š${description}\n\n`;
            
            // ä¿®å¤è¯´æ˜
            analysis += 'ğŸ”§ ä¿®å¤è¦ç‚¹ï¼š\n';
            analysis += '1. æ­£ç¡®å¤„ç†ä¸å£¬å¦’åˆï¼Œç»Šåˆå‡å¼±åŒæ–¹åŠ›é‡\n';
            analysis += '2. ä¸ç«åœ¨å­æ°´æœˆå¾—åˆ†-20ï¼ˆæ°´å…‹ç«ï¼‰\n';
            analysis += '3. åŠ›é‡æ¯”ä¾‹è®¡ç®—è€ƒè™‘ç»Šåˆå½±å“\n';
            analysis += `4. æœ€ç»ˆæ¯”ä¾‹${(ratio * 100).toFixed(2)}%ï¼Œåˆ¤æ–­ä¸º${judgment}\n`;
            
            return analysis;
        }
        
        function getSupportElements(element) {
            const supportMap = {
                'wood': ['water', 'wood'],
                'fire': ['wood', 'fire'],
                'earth': ['fire', 'earth'],
                'metal': ['earth', 'metal'],
                'water': ['metal', 'water']
            };
            return supportMap[element] || [];
        }
        
        function getWeakenElements(element) {
            const weakenMap = {
                'wood': ['metal', 'fire', 'earth'],
                'fire': ['water', 'earth', 'metal'],
                'earth': ['wood', 'metal', 'water'],
                'metal': ['fire', 'water', 'wood'],
                'water': ['earth', 'wood', 'fire']
            };
            return weakenMap[element] || [];
        }
        
        function getElementChinese(element) {
            const elementNames = {
                'wood': 'æœ¨', 'fire': 'ç«', 'earth': 'åœŸ', 'metal': 'é‡‘', 'water': 'æ°´'
            };
            return elementNames[element] || element;
        }
        
        function createElementTable(elements) {
            let table = '<table>';
            table += '<tr><th>äº”è¡Œ</th><th>åŠ›é‡</th><th>è¯´æ˜</th></tr>';
            
            const elementNames = {
                wood: 'æœ¨', fire: 'ç«', earth: 'åœŸ', metal: 'é‡‘', water: 'æ°´'
            };
            
            Object.keys(elementNames).forEach(element => {
                table += `<tr><td>${elementNames[element]}</td><td>${elements[element]}</td><td>${element === 'fire' ? 'æ—¥ä¸»åŒç±»' : ''}</td></tr>`;
            });
            
            table += '</table>';
            table += '<br>' + elements.details.replace(/\n/g, '<br>');
            return table;
        }
        
        function addResult(content, className = '') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = className;
            div.innerHTML = content.replace(/\n/g, '<br>');
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>