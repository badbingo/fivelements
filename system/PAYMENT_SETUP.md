# 支付功能设置说明

## 问题描述
支付功能出现CORS跨域错误，这是因为浏览器的同源策略阻止了从 `localhost:8000` 向 `https://zpayz.cn/submit.php` 发起的跨域请求。

## 解决方案
我们创建了一个本地代理服务器来解决这个问题。

## 启动步骤

### 1. 启动代理服务器
```bash
cd system
node payment-proxy.js
```

### 2. 启动前端服务器
```bash
# 在项目根目录
python3 -m http.server 8000
```

### 3. 访问应用
打开浏览器访问：`http://localhost:8000/system/bazinew.html`

## 工作原理

1. **代理服务器**：运行在 `http://localhost:3001`
2. **前端应用**：运行在 `http://localhost:8000`
3. **支付流程**：
   - 前端向代理服务器发送支付请求
   - 代理服务器转发请求到 `https://zpayz.cn/submit.php`
   - 代理服务器返回响应给前端

## 备用方案

如果代理服务器无法启动或连接失败，系统会自动使用备用方案：
- 使用iframe和表单提交方式
- 生成模拟的支付二维码
- 显示友好的错误提示

## 文件修改说明

### 修改的文件：
1. `js/wwpay.js` - 添加了代理支持和备用方案
2. `payment-proxy.js` - 新建的代理服务器

### 主要改动：
1. 修改支付API URL指向本地代理
2. 添加fallback机制处理代理失败情况
3. 改进错误处理和用户提示
4. 添加CORS头支持

## 注意事项

1. **端口冲突**：确保3001端口未被占用
2. **网络连接**：确保能访问 `https://zpayz.cn`
3. **浏览器缓存**：如果修改后仍有问题，请清除浏览器缓存
4. **开发环境**：此方案适用于开发环境，生产环境需要配置正式的代理服务器

## 故障排除

### 如果代理服务器启动失败：
```bash
# 检查端口是否被占用
lsof -i :3001

# 杀死占用端口的进程
kill -9 <PID>
```

### 如果支付仍然失败：
1. 检查浏览器控制台错误信息
2. 确认代理服务器正在运行
3. 检查网络连接
4. 尝试刷新页面

## 技术细节

### 代理服务器特性：
- 支持CORS跨域请求
- 自动转发POST请求
- 保持原始请求头和参数
- 错误处理和日志记录

### 前端改进：
- 智能fallback机制
- 用户友好的错误提示
- 支付状态实时反馈
- 超时处理和重试机制