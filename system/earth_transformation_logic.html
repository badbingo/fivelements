<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>土性变化计算逻辑</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-case {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .calculation {
            background: #e8f5e8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .traditional, .enhanced {
            padding: 15px;
            border-radius: 5px;
        }
        .traditional {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .enhanced {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }
        .result {
            font-weight: bold;
            color: #dc3545;
            margin: 10px 0;
        }
        .explanation {
            background: #f0f8ff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>土性变化计算逻辑实现</h1>
        <p>针对用户八字（壬子 癸丑 己巳 癸酉）中土性变化的计算逻辑</p>
        
        <button onclick="calculateWithEarthTransformation()">计算土性变化</button>
        <button onclick="clearResults()">清空结果</button>
        
        <div id="results"></div>
    </div>

    <script>
        // 基础映射
        const stemElementMap = {
            '甲': 'wood', '乙': 'wood',
            '丙': 'fire', '丁': 'fire',
            '戊': 'earth', '己': 'earth',
            '庚': 'metal', '辛': 'metal',
            '壬': 'water', '癸': 'water'
        };
        
        const branchElementMap = {
            '子': 'water', '丑': 'earth',
            '寅': 'wood', '卯': 'wood',
            '辰': 'earth', '巳': 'fire',
            '午': 'fire', '未': 'earth',
            '申': 'metal', '酉': 'metal',
            '戌': 'earth', '亥': 'water'
        };
        
        // 地支藏干
        const BRANCH_ELEMENTS = {
            '子': {main: 'water', hidden: ['癸']},
            '丑': {main: 'earth', hidden: ['己', '癸', '辛']},
            '寅': {main: 'wood', hidden: ['甲', '丙', '戊']},
            '卯': {main: 'wood', hidden: ['乙']},
            '辰': {main: 'earth', hidden: ['戊', '乙', '癸']},
            '巳': {main: 'fire', hidden: ['丙', '庚', '戊']},
            '午': {main: 'fire', hidden: ['丁', '己']},
            '未': {main: 'earth', hidden: ['己', '丁', '乙']},
            '申': {main: 'metal', hidden: ['庚', '壬', '戊']},
            '酉': {main: 'metal', hidden: ['辛']},
            '戌': {main: 'earth', hidden: ['戊', '辛', '丁']},
            '亥': {main: 'water', hidden: ['壬', '甲']}
        };
        
        // 三合局定义
        const tripleCombinations = {
            '申子辰': { element: 'water', branches: ['申', '子', '辰'] },
            '亥卯未': { element: 'wood', branches: ['亥', '卯', '未'] },
            '寅午戌': { element: 'fire', branches: ['寅', '午', '戌'] },
            '巳酉丑': { element: 'metal', branches: ['巳', '酉', '丑'] }
        };
        
        function calculateWithEarthTransformation() {
            clearResults();
            
            // 用户八字：壬子 癸丑 己巳 癸酉
            const stems = ['壬', '癸', '己', '癸'];
            const branches = ['子', '丑', '巳', '酉'];
            const dayStem = '己';
            const monthBranch = '丑';
            
            addResult('=== 土性变化计算逻辑分析 ===', 'test-case');
            addResult(`八字：${stems[0]}${branches[0]} ${stems[1]}${branches[1]} ${stems[2]}${branches[2]} ${stems[3]}${branches[3]}`, 'calculation');
            addResult(`日主：${dayStem}土，月令：${monthBranch}土`, 'calculation');
            
            // 1. 检查三合局
            const tripleAnalysis = analyzeTripleCombinations(branches);
            addResult('=== 三合局分析 ===', 'test-case');
            addResult(tripleAnalysis.analysis, 'calculation');
            
            // 2. 检查湿土遇水变性
            const earthTransformation = analyzeEarthTransformation(branches, stems);
            addResult('=== 湿土遇水变性分析 ===', 'test-case');
            addResult(earthTransformation.analysis, 'calculation');
            
            // 3. 对比传统计算与考虑土性变化的计算
            addResult('=== 身强身弱计算对比 ===', 'test-case');
            
            const traditionalResult = calculateTraditionalStrength(stems, branches, dayStem);
            const enhancedResult = calculateEnhancedStrength(stems, branches, dayStem, tripleAnalysis, earthTransformation);
            
            addComparisonResult(traditionalResult, enhancedResult);
            
            // 4. 从格判断
            const congGeAnalysis = analyzeCongGe(enhancedResult);
            addResult('=== 从格判断 ===', 'test-case');
            addResult(congGeAnalysis, 'calculation');
        }
        
        function analyzeTripleCombinations(branches) {
            let analysis = '';
            let hasTriple = false;
            let tripleInfo = null;
            
            // 检查巳酉丑三合金局
            const siYouChou = ['巳', '酉', '丑'];
            const foundBranches = siYouChou.filter(branch => branches.includes(branch));
            
            if (foundBranches.length >= 2) {
                hasTriple = true;
                tripleInfo = {
                    type: '巳酉丑',
                    element: 'metal',
                    count: foundBranches.length,
                    branches: foundBranches
                };
                
                analysis += `✅ 发现三合局：${foundBranches.join('')}${foundBranches.length === 3 ? '全三合' : '半三合'}金局\n`;
                analysis += `合化结果：增强金的力量，生水助水\n`;
                analysis += `对土的影响：金泄土气，减弱土的力量\n`;
                
                if (foundBranches.includes('丑')) {
                    analysis += `特别影响：丑土参与合金，土性减弱\n`;
                }
            } else {
                analysis += `❌ 未发现有效三合局\n`;
            }
            
            return { hasTriple, tripleInfo, analysis };
        }
        
        function analyzeEarthTransformation(branches, stems) {
            let analysis = '';
            let transformations = [];
            
            // 检查湿土（丑、辰）遇水的情况
            const wetEarth = ['丑', '辰'];
            const waterElements = ['子', '亥']; // 地支水
            const waterStems = ['壬', '癸']; // 天干水
            
            branches.forEach((branch, index) => {
                if (wetEarth.includes(branch)) {
                    let hasWater = false;
                    let waterSources = [];
                    
                    // 检查相邻地支是否有水
                    if (index > 0 && waterElements.includes(branches[index - 1])) {
                        hasWater = true;
                        waterSources.push(`左邻${branches[index - 1]}`);
                    }
                    if (index < branches.length - 1 && waterElements.includes(branches[index + 1])) {
                        hasWater = true;
                        waterSources.push(`右邻${branches[index + 1]}`);
                    }
                    
                    // 检查对应天干是否有水
                    if (waterStems.includes(stems[index])) {
                        hasWater = true;
                        waterSources.push(`本柱天干${stems[index]}`);
                    }
                    
                    // 检查其他天干水的影响
                    stems.forEach((stem, stemIndex) => {
                        if (waterStems.includes(stem) && stemIndex !== index) {
                            hasWater = true;
                            waterSources.push(`${stemIndex === 0 ? '年' : stemIndex === 1 ? '月' : stemIndex === 2 ? '日' : '时'}干${stem}`);
                        }
                    });
                    
                    if (hasWater) {
                        transformations.push({
                            branch: branch,
                            position: index,
                            waterSources: waterSources,
                            transformation: 'earth_to_water_tendency'
                        });
                        
                        analysis += `✅ ${branch}土遇水变性：${waterSources.join('、')}\n`;
                        analysis += `变性效果：${branch}土偏向水性，土力减弱，水力增强\n`;
                    } else {
                        analysis += `❌ ${branch}土未遇水，保持土性\n`;
                    }
                }
            });
            
            if (transformations.length === 0) {
                analysis += '❌ 未发现湿土遇水变性情况\n';
            }
            
            return { transformations, analysis };
        }
        
        function calculateTraditionalStrength(stems, branches, dayStem) {
            const elements = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            
            // 天干计算
            stems.forEach(stem => {
                const element = stemElementMap[stem];
                if (element) elements[element] += 1;
            });
            
            // 地支主气计算
            branches.forEach(branch => {
                const element = branchElementMap[branch];
                if (element) elements[element] += 1;
            });
            
            // 地支藏干计算（权重0.5）
            branches.forEach(branch => {
                const branchInfo = BRANCH_ELEMENTS[branch];
                if (branchInfo && branchInfo.hidden) {
                    branchInfo.hidden.forEach(hiddenStem => {
                        const element = stemElementMap[hiddenStem];
                        if (element) elements[element] += 0.5;
                    });
                }
            });
            
            const dayElement = stemElementMap[dayStem];
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            let supportStrength = 0;
            let weakenStrength = 0;
            
            Object.keys(elements).forEach(element => {
                if (supportElements.includes(element)) {
                    supportStrength += elements[element];
                } else if (weakenElements.includes(element)) {
                    weakenStrength += elements[element];
                }
            });
            
            const totalStrength = supportStrength + weakenStrength;
            const ratio = totalStrength > 0 ? supportStrength / totalStrength : 0;
            
            let judgment = '';
            if (ratio >= 0.6) judgment = '身强';
            else if (ratio <= 0.4) judgment = '身弱';
            else judgment = '均衡';
            
            return {
                elements,
                supportStrength,
                weakenStrength,
                ratio,
                judgment,
                method: '传统计算'
            };
        }
        
        function calculateEnhancedStrength(stems, branches, dayStem, tripleAnalysis, earthTransformation) {
            const elements = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            
            // 天干计算
            stems.forEach(stem => {
                const element = stemElementMap[stem];
                if (element) elements[element] += 1;
            });
            
            // 地支主气计算（考虑土性变化）
            branches.forEach((branch, index) => {
                let element = branchElementMap[branch];
                
                // 检查是否有土性变化
                const transformation = earthTransformation.transformations.find(t => t.position === index);
                if (transformation) {
                    // 湿土遇水，土力减弱，水力增强
                    if (element === 'earth') {
                        elements[element] += 0.5; // 土力减半
                        elements['water'] += 0.5; // 增加水力
                    }
                } else {
                    if (element) elements[element] += 1;
                }
            });
            
            // 地支藏干计算（考虑土性变化）
            branches.forEach((branch, index) => {
                const branchInfo = BRANCH_ELEMENTS[branch];
                if (branchInfo && branchInfo.hidden) {
                    branchInfo.hidden.forEach(hiddenStem => {
                        const element = stemElementMap[hiddenStem];
                        if (element) {
                            const transformation = earthTransformation.transformations.find(t => t.position === index);
                            if (transformation && element === 'earth') {
                                elements[element] += 0.25; // 藏干土力减弱
                                elements['water'] += 0.25; // 增加水力
                            } else {
                                elements[element] += 0.5;
                            }
                        }
                    });
                }
            });
            
            // 三合局影响
            if (tripleAnalysis.hasTriple) {
                const tripleInfo = tripleAnalysis.tripleInfo;
                if (tripleInfo.type === '巳酉丑' && tripleInfo.element === 'metal') {
                    // 巳酉丑合金，增强金力，减弱火土力
                    elements['metal'] += tripleInfo.count * 0.5;
                    elements['fire'] -= 0.3; // 火被金克
                    elements['earth'] -= 0.5; // 土被金泄
                    elements['water'] += 0.3; // 金生水
                }
            }
            
            const dayElement = stemElementMap[dayStem];
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            let supportStrength = 0;
            let weakenStrength = 0;
            
            Object.keys(elements).forEach(element => {
                if (supportElements.includes(element)) {
                    supportStrength += Math.max(0, elements[element]);
                } else if (weakenElements.includes(element)) {
                    weakenStrength += Math.max(0, elements[element]);
                }
            });
            
            const totalStrength = supportStrength + weakenStrength;
            const ratio = totalStrength > 0 ? supportStrength / totalStrength : 0;
            
            let judgment = '';
            if (ratio >= 0.6) judgment = '身强';
            else if (ratio <= 0.4) judgment = '身弱';
            else judgment = '均衡';
            
            return {
                elements,
                supportStrength,
                weakenStrength,
                ratio,
                judgment,
                method: '考虑土性变化'
            };
        }
        
        function analyzeCongGe(result) {
            let analysis = '';
            
            // 从格判断标准
            if (result.ratio <= 0.2) {
                analysis += '✅ 符合从弱格条件：\n';
                analysis += `生扶力量比例：${(result.ratio * 100).toFixed(1)}% (< 20%)\n`;
                analysis += '判断：从弱格\n';
                analysis += '特点：日主极弱，顺从克泄耗的力量\n';
                analysis += '喜用：官杀、食伤、财星\n';
                analysis += '忌神：印星、比劫\n';
            } else if (result.ratio >= 0.8) {
                analysis += '✅ 符合从强格条件：\n';
                analysis += `生扶力量比例：${(result.ratio * 100).toFixed(1)}% (> 80%)\n`;
                analysis += '判断：从强格\n';
                analysis += '特点：日主极强，顺从生扶的力量\n';
                analysis += '喜用：印星、比劫\n';
                analysis += '忌神：官杀、食伤、财星\n';
            } else {
                analysis += '❌ 不符合从格条件：\n';
                analysis += `生扶力量比例：${(result.ratio * 100).toFixed(1)}% (20%-80%之间)\n`;
                analysis += `判断：${result.judgment}\n`;
                analysis += '按普通格局论命\n';
            }
            
            return analysis;
        }
        
        function getSupportElements(element) {
            const supportMap = {
                'wood': ['water', 'wood'],
                'fire': ['wood', 'fire'],
                'earth': ['fire', 'earth'],
                'metal': ['earth', 'metal'],
                'water': ['metal', 'water']
            };
            return supportMap[element] || [];
        }
        
        function getWeakenElements(element) {
            const weakenMap = {
                'wood': ['metal', 'fire', 'earth'],
                'fire': ['water', 'earth', 'metal'],
                'earth': ['wood', 'metal', 'water'],
                'metal': ['fire', 'water', 'wood'],
                'water': ['earth', 'wood', 'fire']
            };
            return weakenMap[element] || [];
        }
        
        function addResult(text, className = '') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = className;
            div.innerHTML = text.replace(/\n/g, '<br>');
            resultsDiv.appendChild(div);
        }
        
        function addComparisonResult(traditional, enhanced) {
            const resultsDiv = document.getElementById('results');
            const comparisonDiv = document.createElement('div');
            comparisonDiv.className = 'comparison';
            
            comparisonDiv.innerHTML = `
                <div class="traditional">
                    <h4>传统计算方法</h4>
                    <p><strong>五行分布：</strong></p>
                    <p>木：${traditional.elements.wood.toFixed(1)} 火：${traditional.elements.fire.toFixed(1)} 土：${traditional.elements.earth.toFixed(1)} 金：${traditional.elements.metal.toFixed(1)} 水：${traditional.elements.water.toFixed(1)}</p>
                    <p><strong>生扶力量：</strong>${traditional.supportStrength.toFixed(1)}</p>
                    <p><strong>克泄力量：</strong>${traditional.weakenStrength.toFixed(1)}</p>
                    <p><strong>生扶比例：</strong>${(traditional.ratio * 100).toFixed(1)}%</p>
                    <p class="result">判断结果：${traditional.judgment}</p>
                </div>
                <div class="enhanced">
                    <h4>考虑土性变化的计算</h4>
                    <p><strong>五行分布：</strong></p>
                    <p>木：${enhanced.elements.wood.toFixed(1)} 火：${enhanced.elements.fire.toFixed(1)} 土：${enhanced.elements.earth.toFixed(1)} 金：${enhanced.elements.metal.toFixed(1)} 水：${enhanced.elements.water.toFixed(1)}</p>
                    <p><strong>生扶力量：</strong>${enhanced.supportStrength.toFixed(1)}</p>
                    <p><strong>克泄力量：</strong>${enhanced.weakenStrength.toFixed(1)}</p>
                    <p><strong>生扶比例：</strong>${(enhanced.ratio * 100).toFixed(1)}%</p>
                    <p class="result">判断结果：${enhanced.judgment}</p>
                </div>
            `;
            
            resultsDiv.appendChild(comparisonDiv);
            
            // 添加说明
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'explanation';
            explanationDiv.innerHTML = `
                <h4>计算差异说明：</h4>
                <p><strong>1. 巳酉丑三合金局：</strong>增强金的力量，金泄土气，减弱土的生扶作用</p>
                <p><strong>2. 丑土遇水变性：</strong>丑土在水的影响下偏向水性，土力减弱，水力增强</p>
                <p><strong>3. 综合影响：</strong>日主己土的生扶力量显著减弱，克泄力量增强</p>
                <p><strong>4. 结论：</strong>考虑土性变化后，更容易判断为从弱格</p>
            `;
            
            resultsDiv.appendChild(explanationDiv);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>