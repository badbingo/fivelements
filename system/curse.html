<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="诅咒池 - 八字能量诅咒系统，汇聚众生怨念，助你达成诅咒">
    <meta name="keywords" content="诅咒池,诅咒,八字,怨念,还愿,能量池">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>诅咒池 - 八字能量诅咒系统</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/cstyle.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/cpay.js"></script>
    <script src="../js/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
        /* 新增的登录注册弹窗样式 */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .auth-modal.active {
            display: flex;
        }
        
        .auth-card {
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 25px;
            width: 100%;
            max-width: 380px; /* 从500px缩小到380px */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            position: relative;
        }
        
        .auth-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: #b0b0b0;
            cursor: pointer;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 15px; /* 从20px缩小到15px */
            border-bottom: 1px solid #333;
        }
        
        .auth-tab {
            flex: 1;
            padding: 10px; /* 从12px缩小到10px */
            cursor: pointer;
            font-weight: 500;
            color: #b0b0b0;
            text-align: center;
        }
        
        .auth-tab.active {
            color: #8a5cf5;
            border-bottom: 2px solid #8a5cf5;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-form .form-group {
            margin-bottom: 15px; /* 从20px缩小到15px */
        }
        
        .auth-form label {
            display: block;
            margin-bottom: 6px; /* 从8px缩小到6px */
            color: #f0f0f0;
            font-size: 0.9rem; /* 缩小标签字体 */
        }
        
        .auth-form input {
            width: 90%; /* 从100%缩小到90% */
            padding: 10px; /* 从12px缩小到10px */
            background-color: #2a2a2a;
            border: 1px solid #333;
            border-radius: 6px; /* 从8px缩小到6px */
            color: #f0f0f0;
            font-family: 'Noto Serif SC', serif;
            font-size: 0.9rem; /* 缩小输入字体 */
            margin: 0 auto; /* 居中输入框 */
            display: block; /* 使margin auto生效 */
        }
        
        .auth-form button {
            width: 90%; /* 从100%缩小到90% */
            padding: 10px; /* 从12px缩小到10px */
            background-color: #8a5cf5;
            color: white;
            border: none;
            border-radius: 6px; /* 从8px缩小到6px */
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            margin-top: 8px; /* 从10px缩小到8px */
            margin-left: auto;
            margin-right: auto;
            display: block;
            font-size: 0.9rem; /* 缩小按钮字体 */
        }
        
        .auth-form button:hover {
            background-color: #7a4ce5;
        }
        
        .auth-error {
            color: #ff6b6b;
            font-size: 0.8rem; /* 从0.9rem缩小到0.8rem */
            margin-top: 3px; /* 从5px缩小到3px */
            display: none;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* 用户状态显示样式 */
        .user-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            display: flex;
            align-items: center;
            background-color: rgba(30, 30, 30, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .user-status .welcome {
            margin-right: 10px;
            color: #f0f0f0;
        }
        
        .user-status .username {
            color: #8a5cf5;
            font-weight: 500;
            margin-right: 15px;
        }
        
        .user-status .logout-btn {
            background: none;
            border: none;
            color: #b0b0b0;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .user-status .logout-btn:hover {
            color: #f0f0f0;
        }
        
        .login-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            background-color: #8a5cf5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .login-btn:hover {
            background-color: #7a4ce5;
        }

        /* 管理弹窗样式 */
        .manage-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .manage-modal.active {
            display: flex;
        }
        
        .manage-card {
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            position: relative;
            overflow-y: auto;
        }
        
        .manage-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: #b0b0b0;
            cursor: pointer;
        }
        
        .manage-title {
            color: #8a5cf5;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .curse-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .curse-card {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .curse-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .curse-card h4 {
            color: #8a5cf5;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .curse-card p {
            color: #f0f0f0;
            margin-bottom: 10px;
        }
        
        .curse-card small {
            color: #b0b0b0;
            display: block;
            margin-bottom: 10px;
        }
        
        .wish-stats {
            color: #f39c12;
            font-weight: 500;
        }
        
        .delete-card {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
        }
        
        .delete-card:hover {
            color: #ff4757;
        }
        
        .no-curses {
            color: #b0b0b0;
            text-align: center;
            grid-column: 1 / -1;
            padding: 20px;
        }
        
        .manage-btn {
            background-color: #8a5cf5;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            font-family: 'Noto Serif SC', serif;
        }
        
        .manage-btn:hover {
            background-color: #7a4ce5;
        }
    </style>
</head>
<body>
    <!-- 用户状态显示区域 -->
    <div id="userStatus" class="user-status" style="display: none;">
        <span class="welcome">欢迎，</span>
        <span class="username" id="usernameDisplay"></span>
        <button class="manage-btn" id="manageBtn">管理</button>
        <button class="logout-btn" id="logoutBtn">退出</button>
    </div>
        
    <button id="loginButton" class="login-btn" style="display: none;">
        <i class="fas fa-user"></i> 登录/注册
    </button>
    
    <!-- 登录注册弹窗 -->
    <div id="authModal" class="auth-modal">
        <div class="auth-card">
            <span class="auth-close" id="authClose">&times;</span>
            <h2 style="color: #8a5cf5; text-align: center; margin-bottom: 20px;">诅咒池用户</h2>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="modalLoginTab">登录</div>
                <div class="auth-tab" id="modalRegisterTab">注册</div>
            </div>
            
            <!-- 登录表单 -->
            <form id="modalLoginForm" class="auth-form active">
                <div class="form-group">
                    <label for="modalLoginUsername">用户名</label>
                    <input type="text" id="modalLoginUsername" placeholder="请输入用户名" required>
                    <div class="auth-error" id="modalLoginUsernameError"></div>
                </div>
                
                <div class="form-group">
                    <label for="modalLoginPassword">密码</label>
                    <input type="password" id="modalLoginPassword" placeholder="请输入密码" required>
                    <div class="auth-error" id="modalLoginPasswordError"></div>
                </div>
                
                <button type="submit" id="modalLoginBtn">登录</button>
            </form>
            
            <!-- 注册表单 -->
            <form id="modalRegisterForm" class="auth-form">
                <div class="form-group">
                    <label for="modalRegisterUsername">用户名</label>
                    <input type="text" id="modalRegisterUsername" placeholder="请输入用户名(4-16位)" required minlength="4" maxlength="16">
                    <div class="auth-error" id="modalRegisterUsernameError"></div>
                </div>
                
                <div class="form-group">
                    <label for="modalRegisterEmail">电子邮箱</label>
                    <input type="email" id="modalRegisterEmail" placeholder="请输入电子邮箱" required>
                    <div class="auth-error" id="modalRegisterEmailError"></div>
                </div>
                
                <div class="form-group">
                    <label for="modalRegisterPassword">密码</label>
                    <input type="password" id="modalRegisterPassword" placeholder="请输入密码(至少6位)" required minlength="6">
                    <div class="auth-error" id="modalRegisterPasswordError"></div>
                </div>
                
                <div class="form-group">
                    <label for="modalRegisterConfirmPassword">确认密码</label>
                    <input type="password" id="modalRegisterConfirmPassword" placeholder="请再次输入密码" required>
                    <div class="auth-error" id="modalRegisterConfirmPasswordError"></div>
                </div>
                
                <button type="submit" id="modalRegisterBtn">注册</button>
            </form>
        </div>
    </div>
    
    <!-- 诅咒卡管理弹窗 -->
    <div id="manageModal" class="manage-modal">
        <div class="manage-card">
            <span class="manage-close" id="manageClose">&times;</span>
            <h2 class="manage-title"><i class="fas fa-skull"></i> 我的诅咒卡</h2>
            <div class="curse-cards-container" id="userCurseCards">
                <!-- 用户诅咒卡将在这里动态加载 -->
                <div class="no-curses">
                    <i class="fas fa-spinner fa-spin"></i> 正在加载诅咒卡...
                </div>
            </div>
        </div>
    </div>
    
    <main class="content-container">
        <!-- 原有页面内容保持不变 -->
        <section class="content-title">
            <h1>诅咒池</h1>
            <p>以正义为引，聚众生怨念，助你达成诅咒</p>
        </section>

        <!-- 诅咒池介绍 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-skull"></i>
                <h2>怨起</h2>
            </div>
            
            <div class="card">
                <div class="mingyuan-intro">
                    <div class="intro-text">
                        <p>警告！诅咒池源自古老巫术"怨念汇聚"之法，结合易经能量学，创造出一个集体怨恨能量场。无非必要请勿使用！</p>
                        <p>在此投入诅咒之时，独一无二的怨念标识，携同正义之力启动诅咒。而众生心念汇聚而来的怨恨之力，将如涟漪般扩散，不断放大诅咒的共振频率。</p>
                        <p>每5次诅咒，诅咒能量将提升一个等级，越多人帮你诅咒怨念越强。请务必布施以免遭到反噬。</p>
                    </div>
                    <div class="intro-image">
                        <div class="energy-chart">
                            <canvas id="energyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="wish-levels">
                    <h3><i class="fas fa-signal"></i> 诅咒能量等级</h3>
                    <div class="level-bars">
                        <div class="level-bar" data-level="1">
                            <div class="bar-fill"></div>
                            <span>初咒 (0-4加持)</span>
                        </div>
                        <div class="level-bar" data-level="2">
                            <div class="bar-fill"></div>
                            <span>小怨 (5-9加持)</span>
                        </div>
                        <div class="level-bar" data-level="3">
                            <div class="bar-fill"></div>
                            <span>中怨 (10-14加持)</span>
                        </div>
                        <div class="level-bar" data-level="4">
                            <div class="bar-fill"></div>
                            <span>大怨 (15-19加持)</span>
                        </div>
                        <div class="level-bar" data-level="5">
                            <div class="bar-fill"></div>
                            <span>惩戒 (20+加持)</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 诅咒表单 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-hand-sparkles"></i>
                <h2>投入诅咒</h2>
            </div>
            
            <div class="card">
                <form id="wishForm" class="mingyuan-form">
                    <div class="form-row">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="name"><i class="fas fa-user"></i> 对方姓名</label>
                                <input type="text" id="name" placeholder="请输入对方姓名" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="targetDescription"><i class="fas fa-id-card"></i> 对方特征描述</label>
                                <textarea id="targetDescription" rows="3" maxlength="100" placeholder="描述对方的特征(外貌、习惯等)..." required></textarea>
                                <p class="form-hint">已输入 <span id="descCharCount">0</span>/100 字</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="wishType"><i class="fas fa-tags"></i> 诅咒类型</label>
                                <select id="wishType">
                                    <option value="love">感情破裂</option>
                                    <option value="wealth">事业失败</option>
                                    <option value="health">疾病缠身</option>
                                    <option value="study">学业受阻</option>
                                    <option value="family">家庭不和</option>
                                    <option value="other">其他诅咒</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-column">
                            <div class="form-group">
                                <label for="wishContent"><i class="fas fa-skull"></i> 诅咒事由</label>
                                <textarea id="wishContent" rows="4" maxlength="200" placeholder="写下您诅咒的真实事由(限200字以内)..." required></textarea>
                                <p class="form-hint">已输入 <span id="charCount">0</span>/200 字</p>
                                <p class="bazi-info" id="baziInfo"></p>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-eye"></i> 诅咒可见性</label>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="visibility" value="public" checked>
                                        <span class="radio-custom"></span>
                                        <span class="radio-label">公开诅咒</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="visibility" value="private">
                                        <span class="radio-custom"></span>
                                        <span class="radio-label">隐藏诅咒</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                   <div class="form-actions" style="text-align: center;">
                        <button type="submit" class="btn-mingyuan" style="display: inline-block;">
                            <i class="fas fa-paper-plane"></i> 投入诅咒池
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- 诅咒池展示 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-skull-crossbones"></i>
                <h2>诅咒池</h2>
                <div class="filter-controls wish-search-controls">
                    <div class="wish-search-row">
                        <!-- 搜索框 -->
                        <div class="wish-search-container">
                            <input type="text" id="wishSearch" placeholder="搜索姓名..." class="wish-search-input">
                            <button id="searchBtn" class="wish-search-btn"><i class="fas fa-search"></i></button>
                            <button id="clearSearchBtn" class="wish-clear-search-btn" style="display:none;"><i class="fas fa-times"></i></button>
                        </div>
                        
                        <!-- 诅咒类型筛选 - 保持原有样式 -->
                        <select id="wishFilter" class="form-control">
                            <option value="all">全部诅咒</option>
                            <option value="love">感情破裂</option>
                            <option value="wealth">事业失败</option>
                            <option value="health">疾病缠身</option>
                            <option value="study">学业受阻</option>
                            <option value="family">家庭不和</option>
                        </select>
                        
                        <!-- 排序筛选 - 保持原有样式 -->
                        <select id="sortFilter" class="form-control">
                            <option value="newest">最新诅咒</option>
                            <option value="oldest">最早诅咒</option>
                            <option value="most">最多诅咒</option>
                            <option value="least">最少诅咒</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="wish-pool">
                <div class="wish-loading">
                    <div class="loader"></div>
                    <p>正在连接诅咒池能量场...</p>
                </div>
            </div>
            
            <div class="pagination">
                <button id="prevPage" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="pageInfo">第 1 页</span>
                <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <!-- 能量统计 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-chart-line"></i>
                <h2>怨念统计</h2>
            </div>
            
           <div class="card-grid">
              <div class="card hover-card" id="energyStatsCard">
                <div class="card-title">
                  <i class="fas fa-bolt" style="color: #f39c12;"></i> 今日怨念
                  <button id="refreshStatsBtn" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
                <div class="card-content">
                  <!-- 新增诅咒 -->
                  <div class="stat-card" onclick="fetchWishes('new')" style="text-align: center;">
                      <div class="stat-value" id="newWishesCount" style="display: block; margin: 0 auto;">0</div>
                      <div class="stat-label" style="display: block; margin: 0 auto;">
                        新增诅咒
                        <span class="stat-trend" id="wishesTrend" style="display: inline-block;"></span>
                      </div>
                    </div>
                  
                  <!-- 加持次数（重点修改部分） -->
                  <div class="stat-card highlight" onclick="fetchBlessings()" style="text-align: center;">
                      <div class="stat-value" id="blessingsCount" style="display: block; margin: 0 auto;">0</div>
                      <div class="stat-label" style="display: block; margin: 0 auto;">
                        诅咒次数
                      </div>
                    </div>
                  
                  <!-- 还愿次数 -->
                  <div class="stat-card" onclick="fetchFulfillments()" style="text-align: center;">
                      <div class="stat-value" id="fulfilledCount" style="display: block; margin: 0 auto;">0</div>
                      <div class="stat-label" style="display: block; margin: 0 auto;">
                        还愿次数
                      </div>
                    </div>
                </div>
                
                <div class="card-footer">
                  最后更新: <span id="lastUpdated">刚刚</span>
                </div>
              </div>
               
                <div class="card hover-card">
                    <div class="card-title">
                        <i class="fas fa-chart-pie" style="color: #e84393;"></i> 诅咒分布
                    </div>
                    <div class="card-content">
                        <canvas id="wishchart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 使用说明 -->
        <section class="full-width-section">
            <div class="section-header">
                <i class="fas fa-book"></i>
                <h2>诚心须知</h2>
            </div>
            
            <div class="card">
                <div class="note-box important">
                    <h4><i class="fas fa-lightbulb"></i> 心诚则灵</h4>
                    <ul>
                        <li>请确保对方信息尽量详细，这是诅咒的能量标识</li>
                        <li>诅咒内容需真诚具体，避免模糊或正面表述</li>
                        <li>在帮助他人诅咒时，请保持正义之心，正义的能量会回馈于你</li>
                        <li>诅咒达成后请及时布施，以免遭到反噬</li>
                        <li>每个诅咒有效期为30天，到期后自动从池中移除</li>
                    </ul>
                    
                    <div class="disclaimer-box">
                        <h4><i class="fas fa-info-circle"></i> 重要说明</h4>
                        <p>每个诅咒都有正义法印加持，这是佛教密宗核心咒语，具有强化怨念、聚集负能量、加速诅咒实现的核心作用，其功能涵盖身心破坏与世俗损害双重维度‌。该真言通过持诵可强化怨念、聚集负能量，同时获得黑暗力量加持，实现疾病、失败、痛苦等现实诅咒。‌‌</p>
                        <blockquote>
                            《道德经》云："天道无亲，常与恶人"。诅咒池的能量运作遵循自然法则，多行恶事能增强诅咒实现的几率。
                        </blockquote>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 诅咒池. 保留所有权利.</p>
            <p>汇聚怨念，共振黑暗</p>
        </div>
    </footer>

    <!-- 新的诅咒特效HTML -->
    <div class="curse-overlay" id="curseOverlay">
        <div class="curse-container" id="curseContainer">
            <!-- 动态生成的内容将在这里 -->
        </div>
    </div>
    
    <!-- 登录提示模态框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3><i class="fas fa-user-lock"></i> 需要登录</h3>
            <p>您需要先登录才能实施诅咒</p>
            <div class="modal-actions">
                <button id="cancelLogin" class="btn-cancel">取消</button>
                <button id="confirmLogin" class="btn-confirm">前往登录</button>
            </div>
        </div>
    </div>

    <!-- 还愿模态框 -->
    <div id="fulfillModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3><i class="fas fa-hand-holding-heart"></i> 感恩布施</h3>
        <p>您的诅咒已经实现，请选择布施金额：</p>
        
        <!-- 金额选择 -->
        <div class="fulfill-options">
          <button class="fulfill-option" data-amount="0.01">1元</button>
          <button class="fulfill-option" data-amount="5">5元</button>
          <button class="fulfill-option" data-amount="10">10元</button>
          <button class="fulfill-option" data-amount="20">20元</button>
        </div>
      </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // 配置后端地址
    const API_BASE = 'https://curse-backend.owenjass.workers.dev';
    const API_URL = `${API_BASE}/api/curse`;
    const AUTH_API = `${API_BASE}/api/auth`;

    // 全局变量
    let allWishes = [];
    let currentPage = 1;
    const wishesPerPage = 9;
    let currentSearchTerm = '';
    let energyChart = null;
    let wishDistributionChart = null;
    
    // 获取DOM元素
    const wishFilter = document.getElementById('wishFilter');
    const sortFilter = document.getElementById('sortFilter');
    const wishPool = document.querySelector('.wish-pool');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    const wishForm = document.getElementById('wishForm');
    const baziInfo = document.getElementById('baziInfo');
    const fulfillModal = document.getElementById('fulfillModal');
    const wishSearch = document.getElementById('wishSearch');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const charCount = document.getElementById('charCount');
    const descCharCount = document.getElementById('descCharCount');
    const targetDescription = document.getElementById('targetDescription');
    const wishContent = document.getElementById('wishContent');
    const refreshStatsBtn = document.getElementById('refreshStatsBtn');
    
    // 登录注册相关DOM元素
    const authModal = document.getElementById('authModal');
    const authClose = document.getElementById('authClose');
    const modalLoginTab = document.getElementById('modalLoginTab');
    const modalRegisterTab = document.getElementById('modalRegisterTab');
    const modalLoginForm = document.getElementById('modalLoginForm');
    const modalRegisterForm = document.getElementById('modalRegisterForm');
    const modalLoginBtn = document.getElementById('modalLoginBtn');
    const modalRegisterBtn = document.getElementById('modalRegisterBtn');
    const loginButton = document.getElementById('loginButton');
    const userStatus = document.getElementById('userStatus');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const logoutBtn = document.getElementById('logoutBtn');
    const manageBtn = document.getElementById('manageBtn');
    const manageModal = document.getElementById('manageModal');
    const manageClose = document.getElementById('manageClose');
    const userCurseCards = document.getElementById('userCurseCards');

    // 初始化用户状态
    function initUserStatus() {
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        
        if (token && username) {
            // 用户已登录
            loginButton.style.display = 'none';
            userStatus.style.display = 'flex';
            usernameDisplay.textContent = username;
        } else {
            // 用户未登录
            loginButton.style.display = 'block';
            userStatus.style.display = 'none';
        }
    }
    
    // 初始化登录注册弹窗
    function initAuthModal() {
        // 登录/注册按钮点击事件
        loginButton.addEventListener('click', function() {
            authModal.classList.add('active');
            switchAuthTab('login');
        });
        
        // 关闭按钮点击事件
        authClose.addEventListener('click', function() {
            authModal.classList.remove('active');
        });
        
        // 点击弹窗外部关闭
        authModal.addEventListener('click', function(e) {
            if (e.target === authModal) {
                authModal.classList.remove('active');
            }
        });
        
        // 登录/注册标签切换
        modalLoginTab.addEventListener('click', function() {
            switchAuthTab('login');
        });
        
        modalRegisterTab.addEventListener('click', function() {
            switchAuthTab('register');
        });
        
        // 登录表单提交
        modalLoginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleModalLogin();
        });
        
        // 注册表单提交
        modalRegisterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleModalRegister();
        });
        
        // 退出按钮点击事件
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            initUserStatus();
            showSuccessMessage('已成功退出登录');
        });
    }
    
    // 切换登录/注册标签
    function switchAuthTab(tab) {
        if (tab === 'login') {
            modalLoginTab.classList.add('active');
            modalRegisterTab.classList.remove('active');
            modalLoginForm.classList.add('active');
            modalRegisterForm.classList.remove('active');
        } else {
            modalLoginTab.classList.remove('active');
            modalRegisterTab.classList.add('active');
            modalLoginForm.classList.remove('active');
            modalRegisterForm.classList.add('active');
        }
        
        // 清除错误信息
        document.querySelectorAll('.auth-error').forEach(el => {
            el.style.display = 'none';
        });
    }
    
    // 处理弹窗登录
    async function handleModalLogin() {
        const username = document.getElementById('modalLoginUsername').value.trim();
        const password = document.getElementById('modalLoginPassword').value.trim();
        
        // 验证输入
        if (!username) {
            document.getElementById('modalLoginUsernameError').textContent = '请输入用户名';
            document.getElementById('modalLoginUsernameError').style.display = 'block';
            return;
        }
        
        if (!password) {
            document.getElementById('modalLoginPasswordError').textContent = '请输入密码';
            document.getElementById('modalLoginPasswordError').style.display = 'block';
            return;
        }
        
        // 禁用登录按钮
        modalLoginBtn.disabled = true;
        modalLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登录中...';
        
        try {
            const response = await fetch('https://curse-backend.owenjass.workers.dev/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    name: username,
                    password: password
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || '登录失败，请检查用户名和密码');
            }
            
            const data = await response.json();
            
            // 登录成功，保存token和用户名
            localStorage.setItem('token', data.token);
            localStorage.setItem('username', username);
            
            // 更新用户状态
            initUserStatus();
            
            // 关闭弹窗
            authModal.classList.remove('active');
            
            // 显示成功消息
            showSuccessMessage('登录成功！');
            
        } catch (error) {
            console.error('登录失败:', error);
            document.getElementById('modalLoginPasswordError').textContent = error.message;
            document.getElementById('modalLoginPasswordError').style.display = 'block';
        } finally {
            // 恢复登录按钮
            modalLoginBtn.disabled = false;
            modalLoginBtn.innerHTML = '登录';
        }
    }
    
    // 处理弹窗注册
    async function handleModalRegister() {
        const username = document.getElementById('modalRegisterUsername').value.trim();
        const email = document.getElementById('modalRegisterEmail').value.trim();
        const password = document.getElementById('modalRegisterPassword').value.trim();
        const confirmPassword = document.getElementById('modalRegisterConfirmPassword').value.trim();
        
        // 清除之前的错误信息
        document.querySelectorAll('.auth-error').forEach(el => {
            el.style.display = 'none';
        });
        
        // 验证输入
        let isValid = true;
        
        if (!username) {
            document.getElementById('modalRegisterUsernameError').textContent = '请输入用户名';
            document.getElementById('modalRegisterUsernameError').style.display = 'block';
            isValid = false;
        } else if (username.length < 4 || username.length > 16) {
            document.getElementById('modalRegisterUsernameError').textContent = '用户名长度应为4-16位';
            document.getElementById('modalRegisterUsernameError').style.display = 'block';
            isValid = false;
        }
        
        if (!email) {
            document.getElementById('modalRegisterEmailError').textContent = '请输入电子邮箱';
            document.getElementById('modalRegisterEmailError').style.display = 'block';
            isValid = false;
        } else if (!validateEmail(email)) {
            document.getElementById('modalRegisterEmailError').textContent = '请输入有效的电子邮箱';
            document.getElementById('modalRegisterEmailError').style.display = 'block';
            isValid = false;
        }
        
        if (!password) {
            document.getElementById('modalRegisterPasswordError').textContent = '请输入密码';
            document.getElementById('modalRegisterPasswordError').style.display = 'block';
            isValid = false;
        } else if (password.length < 6) {
            document.getElementById('modalRegisterPasswordError').textContent = '密码长度至少为6位';
            document.getElementById('modalRegisterPasswordError').style.display = 'block';
            isValid = false;
        }
        
        if (!confirmPassword) {
            document.getElementById('modalRegisterConfirmPasswordError').textContent = '请确认密码';
            document.getElementById('modalRegisterConfirmPasswordError').style.display = 'block';
            isValid = false;
        } else if (password !== confirmPassword) {
            document.getElementById('modalRegisterConfirmPasswordError').textContent = '两次输入的密码不一致';
            document.getElementById('modalRegisterConfirmPasswordError').style.display = 'block';
            isValid = false;
        }
        
        if (!isValid) return;
        
        // 禁用注册按钮
        modalRegisterBtn.disabled = true;
        modalRegisterBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 注册中...';
        
        try {
            const response = await fetch(`${AUTH_API}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: username,
                    email: email,
                    password: password
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || '注册失败');
            }
            
            // 注册成功，自动登录
            localStorage.setItem('token', data.token);
            localStorage.setItem('username', username);
            
            // 更新用户状态
            initUserStatus();
            
            // 关闭弹窗
            authModal.classList.remove('active');
            
            // 显示成功消息
            showSuccessMessage('注册成功！已自动登录');
            
        } catch (error) {
            console.error('注册失败:', error);
            document.getElementById('modalRegisterPasswordError').textContent = error.message;
            document.getElementById('modalRegisterPasswordError').style.display = 'block';
        } finally {
            // 恢复注册按钮
            modalRegisterBtn.disabled = false;
            modalRegisterBtn.innerHTML = '注册';
        }
    }
    
    // 验证电子邮件格式
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // 初始化搜索功能
    function initSearchFunctionality() {
        // 搜索按钮点击事件
        searchBtn.addEventListener('click', () => {
            currentSearchTerm = wishSearch.value.trim();
            if (currentSearchTerm) {
                currentPage = 1;
                renderFilteredWishes();
                clearSearchBtn.style.display = 'inline-block';
            }
        });

        // 清空搜索按钮
        clearSearchBtn.addEventListener('click', () => {
            wishSearch.value = '';
            currentSearchTerm = '';
            currentPage = 1;
            renderFilteredWishes();
            clearSearchBtn.style.display = 'none';
        });

        // 回车键触发搜索
        wishSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentSearchTerm = wishSearch.value.trim();
                if (currentSearchTerm) {
                    currentPage = 1;
                    renderFilteredWishes();
                    clearSearchBtn.style.display = 'inline-block';
                }
            }
        });
    }

    // 应用筛选和排序并渲染当前页的诅咒
    function renderFilteredWishes() {
        // 1. 应用类型筛选
        const selectedType = wishFilter.value;
        let filteredWishes = [...allWishes];
        
        if (selectedType !== 'all') {
            filteredWishes = allWishes.filter(wish => wish.type === selectedType);
        }
        
        // 2. 应用搜索筛选
        if (currentSearchTerm) {
            filteredWishes = filteredWishes.filter(wish => 
                wish.user_name && wish.user_name.toLowerCase().includes(currentSearchTerm.toLowerCase())
            );
        }
        
        // 3. 应用排序
        const selectedSort = sortFilter.value;
        
        switch(selectedSort) {
            case 'newest':
                filteredWishes.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                break;
            case 'oldest':
                filteredWishes.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
                break;
            case 'most':
                filteredWishes.sort((a, b) => (b.blessings || 0) - (a.blessings || 0));
                break;
            case 'least':
                filteredWishes.sort((a, b) => (a.blessings || 0) - (b.blessings || 0));
                break;
            default:
                filteredWishes.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        }
        
        // 4. 分页处理
        const startIndex = (currentPage - 1) * wishesPerPage;
        const paginatedWishes = filteredWishes.slice(startIndex, startIndex + wishesPerPage);
        
        // 渲染筛选后的诅咒
        renderWishCards(paginatedWishes);
        updatePagination();
    }

    // 更新分页信息
    function updatePagination() {
        const selectedType = wishFilter.value;
        let filteredWishes = [...allWishes];
        
        if (selectedType !== 'all') {
            filteredWishes = allWishes.filter(wish => wish.type === selectedType);
        }
        
        // 应用搜索筛选
        if (currentSearchTerm) {
            filteredWishes = filteredWishes.filter(wish => 
                wish.user_name && wish.user_name.toLowerCase().includes(currentSearchTerm.toLowerCase())
            );
        }
        
        const totalPages = Math.ceil(filteredWishes.length / wishesPerPage);
        
        pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages || totalPages === 0;
    }

    // 渲染诅咒卡片
    function renderWishCards(wishes) {
        if (!Array.isArray(wishes)) {
            console.error('renderWishCards 接收到的不是数组:', wishes);
            return;
        }
        
        wishPool.innerHTML = '';
        
        if (wishes.length === 0) {
            wishPool.innerHTML = `
                <div class="wish-loading">
                    <i class="fas fa-skull-crossbones" style="font-size: 2rem; color: #c62828;"></i>
                    <p>没有找到符合条件的诅咒</p>
                    ${currentSearchTerm ? `<p>没有找到与"${currentSearchTerm}"相关的诅咒</p>` : '<p>请尝试其他筛选条件</p>'}
                </div>
            `;
            return;
        }
        
        // 诅咒类型名称映射
        const typeNames = {
            love: '感情破裂', 
            wealth: '事业失败', 
            health: '疾病缠身',
            study: '学业受阻', 
            family: '家庭不和', 
            other: '其他诅咒'
        };
        
        wishes.forEach(wish => {
            // 创建诅咒卡片
            const wishCard = document.createElement('div');
            wishCard.className = `wish-card level-${wish.level || 1}`;
            wishCard.dataset.id = wish.id;
            wishCard.dataset.level = wish.level || 1;
            wishCard.dataset.type = wish.type;
            wishCard.dataset.visibility = wish.visibility;
            
            // 计算剩余天数
            const createdDate = new Date(wish.created_at);
            const expiresAt = new Date(createdDate);
            expiresAt.setDate(expiresAt.getDate() + 30);
            const daysLeft = Math.max(0, Math.ceil((expiresAt - new Date()) / (86400000)));
            
            // 填充内容
            wishCard.innerHTML = `
                <div class="wish-header">
                    <div class="wish-user">
                        <i class="fas fa-user"></i> <span class="user-name">${wish.user_name || '匿名用户'}</span>
                    </div>
                    <span class="wish-type">${typeNames[wish.type] || '其他诅咒'}</span>
                    <span class="wish-time">剩余<span class="days-left">${daysLeft}</span>天</span>
                </div>
                <div class="wish-content">
                    <p class="wish-text">${wish.content}</p>
                    ${wish.target_description ? `<p class="target-description"><small>目标特征: ${wish.target_description}</small></p>` : ''}
                    <p class="wish-hidden">诅咒已隐藏</p>
                </div>
                <div class="wish-meta">
                    <div class="wish-stats">
                        <span class="bless-count">${wish.blessings || 0}</span> 次诅咒
                    </div>
                </div>
                <div class="wish-actions">
                    <button class="btn-bless">
                        <i class="fas fa-hands-helping"></i> 诅咒
                    </button>
                    <button class="btn-fulfill">
                    <i class="fas fa-hand-holding-heart"></i> 布施
                    </button>
                </div>
                <div class="wish-energy">
                    <div class="energy-level level-${wish.level || 1}" style="width: ${(wish.level || 1) * 20}%"></div>
                </div>
            `;
            
            // 添加事件监听
            const blessBtn = wishCard.querySelector('.btn-bless');
            blessBtn.addEventListener('click', () => handleBlessWish(wishCard, wish));
            
            const fulfillBtn = wishCard.querySelector('.btn-fulfill');
            fulfillBtn.addEventListener('click', () => handleFulfillWish(wish));
            
            // 添加到池中
            wishPool.appendChild(wishCard);
        });
    }

    // 处理加持诅咒
    async function handleBlessWish(cardElement, wish) {
        try {
            // 检查登录状态
            const token = localStorage.getItem('token');
            if (!token) {
                authModal.classList.add('active'); // 显示登录弹窗
                switchAuthTab('login'); // 切换到登录标签
                return;
            }

            // 检查本地加持记录
            const lastBlessKey = `lastBless_${wish.id}`;
            const lastBlessTime = localStorage.getItem(lastBlessKey);
            const now = Date.now();
            
            if (lastBlessTime && (now - parseInt(lastBlessTime)) < 3600000) {
                const nextBlessTime = new Date(parseInt(lastBlessTime) + 3600000);
                showToast(`每小时只能诅咒一次，请于 ${nextBlessTime.toLocaleTimeString()} 后再试`);
                return;
            }
        
            // 获取加持按钮并禁用
            const blessBtn = cardElement.querySelector('.btn-bless');
            blessBtn.disabled = true;
            blessBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 诅咒中...';
        
            // 显示新的诅咒特效
            await showCurseEffect();
        
            // 发送请求
            const blessUrl = `${API_BASE}/api/bless/${wish.id}`;
            
            const response = await fetch(blessUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({})
            });
        
            // 处理响应
            if (!response.ok) {
                const errorData = await response.json();
                if (errorData.code === 401) {  // 未授权/未登录
                    showLoginModal();
                    return;
                }
                if (errorData.code === 429) {  // 频率限制
                    localStorage.setItem(lastBlessKey, new Date(errorData.nextBlessTime).getTime() - 3600000);
                    showToast(errorData.error);
                    return;
                }
                throw new Error(`诅咒失败 (${response.status}): ${JSON.stringify(errorData)}`);
            }
        
            const result = await response.json();
            console.log('诅咒结果:', result);
        
            // 记录本次加持时间
            localStorage.setItem(lastBlessKey, now.toString());
        
            // 更新UI
            cardElement.querySelector('.bless-count').textContent = result.blessings;
            cardElement.dataset.level = result.level;
            cardElement.className = `wish-card level-${result.level}`;
            cardElement.querySelector('.energy-level').className = `energy-level level-${result.level}`;
            cardElement.querySelector('.energy-level').style.width = `${result.level * 20}%`;
            
            // 显示成功动画
            cardElement.classList.add('level-up');
            setTimeout(() => cardElement.classList.remove('level-up'), 1000);
            
            // 提示用户
            const levelNames = ['初咒', '小怨', '中怨', '大怨', '惩戒'];
            showSuccessMessage(`诅咒成功！当前能量：${levelNames[result.level - 1]}`);
        
            // 更新统计数据
            fetchStats();
        } catch (error) {
            console.error('诅咒出错:', error);
            showErrorMessage(error.message);
        } finally {
            // 重置按钮状态
            const blessBtn = cardElement.querySelector('.btn-bless');
            if (blessBtn) {
                blessBtn.disabled = false;
                blessBtn.innerHTML = '<i class="fas fa-hands-helping"></i> 诅咒';
            }
        }
    }

    // 新的诅咒特效函数
    async function showCurseEffect() {
        return new Promise((resolve) => {
            const overlay = document.getElementById('curseOverlay');
            const container = document.getElementById('curseContainer');
            
            // 清空容器
            container.innerHTML = '';
            
            // 添加震动效果到整个页面
            document.body.classList.add('shake');
            
            // 创建血脉冲效果
            const blood = document.createElement('div');
            blood.className = 'curse-blood';
            container.appendChild(blood);
            
            // 创建裂纹效果
            const crack = document.createElement('div');
            crack.className = 'curse-crack';
            container.appendChild(crack);
            
            // 创建诅咒符号
            const symbols = ['☠', '⚰', '☣', '🕱', '🕸', '💀'];
            for(let i = 0; i < 6; i++) {
                const symbol = document.createElement('div');
                symbol.className = 'curse-symbol';
                symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                symbol.style.left = `${10 + Math.random() * 80}%`;
                symbol.style.top = `${10 + Math.random() * 80}%`;
                symbol.style.animationDelay = `${i * 0.2}s`;
                container.appendChild(symbol);
            }
            
            // 创建诅咒文字
            const texts = ['诅咒!', '痛苦!', '毁灭!', '厄运!', '绝望!'];
            const curseText = document.createElement('div');
            curseText.className = 'curse-text';
            curseText.textContent = texts[Math.floor(Math.random() * texts.length)];
            curseText.style.left = `${30 + Math.random() * 40}%`;
            curseText.style.top = `${30 + Math.random() * 40}%`;
            container.appendChild(curseText);
            
            // 创建鬼脸
            const face = document.createElement('div');
            face.className = 'curse-face';
            face.style.left = `${20 + Math.random() * 60}%`;
            face.style.top = `${20 + Math.random() * 60}%`;
            container.appendChild(face);
            
            // 显示叠加层
            overlay.classList.add('active');
            
            // 创建粒子爆发
            createCurseParticles(container);
            
            // 播放音效（需要用户交互后才能播放）
            playCurseSound();
            
            // 3秒后结束
            setTimeout(() => {
                overlay.classList.remove('active');
                document.body.classList.remove('shake');
                setTimeout(resolve, 500);
            }, 3000);
        });
    }
    
    // 创建诅咒粒子效果
    function createCurseParticles(container) {
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'curse-particle';
            
            // 随机位置
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            
            // 随机大小
            const size = 3 + Math.random() * 7;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            
            container.appendChild(particle);
            
            // 动画
            const angle = Math.random() * Math.PI * 2;
            const velocity = 1 + Math.random() * 3;
            const lifetime = 1000 + Math.random() * 1000;
            
            let startTime = Date.now();
            
            function animateParticle() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / lifetime;
                
                if (progress >= 1) {
                    particle.remove();
                    return;
                }
                
                const distance = velocity * elapsed / 20;
                const newX = x + Math.cos(angle) * distance;
                const newY = y + Math.sin(angle) * distance;
                
                particle.style.left = `${newX}px`;
                particle.style.top = `${newY}px`;
                particle.style.opacity = 0.8 - progress * 0.8;
                
                requestAnimationFrame(animateParticle);
            }
            
            requestAnimationFrame(animateParticle);
        }
    }
    
    // 播放诅咒音效
    function playCurseSound() {
        // 需要用户交互后才能播放音频
        try {
            // 创建一个尖叫音效
            const scream = new Audio();
            scream.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'; // 简化的base64音频数据
            scream.volume = 0.3;
            scream.play().catch(e => console.log('音频播放被阻止:', e));
            
            // 创建一个低沉的声音
            const lowSound = new Audio();
            lowSound.src = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...'; // 简化的base64音频数据
            lowSound.volume = 0.5;
            setTimeout(() => lowSound.play().catch(e => console.log('音频播放被阻止:', e)), 500);
        } catch (e) {
            console.error('音频错误:', e);
        }
    }

    // 处理还愿诅咒
    async function handleFulfillWish(wish) {
        try {
            // 检查登录状态
            const token = localStorage.getItem('token');
            if (!token) {
                authModal.classList.add('active'); // 显示登录弹窗
                switchAuthTab('login'); // 切换到登录标签
                return;
            }

            // 立即更新is_fulfilled字段为true
            const updateResponse = await fetch(`${API_BASE}/api/curse/${wish.id}/fulfill`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!updateResponse.ok) {
                throw new Error('更新还愿状态失败');
            }

            // 显示还愿模态框
            const modal = document.getElementById('fulfillModal');
            if (!modal) {
                throw new Error('找不到还愿模态框');
            }
            
            // 设置愿望ID到模态框
            modal.dataset.wishId = wish.id;
            modal.style.display = 'block';
        
            // 初始化支付选项
            if (window.wwPay) {
                window.wwPay.resetPaymentState();
            }
        } catch (error) {
            console.error('还愿初始化失败:', error);
            alert('还愿失败: ' + error.message);
        }
    }

    // 显示Toast消息
    function showToast(message, type = 'success') {
        // 移除现有的toast
        document.querySelectorAll('.toast').forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(toast);
        
        // 显示动画
        setTimeout(() => toast.classList.add('show'), 100);
        
        // 3秒后自动消失
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 显示成功消息
    function showSuccessMessage(message) {
        showToast(message, 'success');
    }
    
    // 显示错误消息
    function showErrorMessage(message) {
        showToast(message, 'error');
    }

    // 获取并更新统计数据
    async function fetchStats() {
        try {
            console.log('正在获取统计数据...');
            
            const response = await fetch(`${API_BASE}/api/stats?_=${Date.now()}`);
            
            if (!response.ok) {
                throw new Error(`请求失败: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('API返回数据:', data);
            
            // 更新统计数字
            document.getElementById('newWishesCount').textContent = data.today.newWishes || 0;
            document.getElementById('blessingsCount').textContent = data.today.blessings || 0;
            document.getElementById('fulfilledCount').textContent = data.today.fulfilled || 0;
            
            // 更新最后更新时间
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                `最后更新: ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // 渲染分布图表
            if (data.distribution) {
                console.log('准备渲染分布图表，数据:', data.distribution);
                renderDistributionChart(data.distribution);
            } else {
                console.warn('API返回的数据中没有distribution字段，使用默认值');
                renderDistributionChart({
                    wealth: 2 // 默认值
                });
            }
            
        } catch (error) {
            console.error('加载统计数据失败:', error);
            
            // 出错时显示占位数据
            document.getElementById('newWishesCount').textContent = '?';
            document.getElementById('blessingsCount').textContent = '?';
            document.getElementById('fulfilledCount').textContent = '?';
            document.getElementById('lastUpdated').textContent = '更新失败';
            
            // 使用默认数据渲染图表
            renderDistributionChart({
                wealth: 2
            });
            
            showErrorMessage(`统计加载失败: ${error.message}`);
        }
    }

    // 初始化能量图表
    function initEnergyChart() {
        const ctx = document.getElementById('energyChart').getContext('2d');
        
        // 如果已存在图表实例，先销毁
        if (energyChart) {
            energyChart.destroy();
        }
        
        energyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                datasets: [{
                    label: '怨念强度',
                    data: [65, 79, 90, 81, 56, 75],
                    borderColor: '#c62828',
                    backgroundColor: 'rgba(198, 40, 40, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#c62828',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        backgroundColor: 'rgba(10, 10, 20, 0.9)',
                        titleFont: {
                            family: "'Noto Serif SC', serif"
                        },
                        bodyFont: {
                            family: "'Noto Serif SC', serif"
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { 
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#b8c2cc',
                            font: {
                                family: "'Noto Serif SC', serif"
                            }
                        }
                    },
                    x: {
                        grid: { 
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#b8c2cc',
                            font: {
                                family: "'Noto Serif SC', serif"
                            }
                        }
                    }
                }
            }
        });
    }

    // 初始化管理弹窗
    function initManageModal() {
        // 管理按钮点击事件
        manageBtn.addEventListener('click', openManageModal);
        
        // 关闭按钮点击事件
        manageClose.addEventListener('click', () => {
            manageModal.classList.remove('active');
        });
        
        // 点击弹窗外部关闭
        manageModal.addEventListener('click', function(e) {
            if (e.target === manageModal) {
                manageModal.classList.remove('active');
            }
        });
    }

    // 打开管理弹窗
    async function openManageModal() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                authModal.classList.add('active');
                switchAuthTab('login');
                return;
            }
            
            // 显示加载状态
            userCurseCards.innerHTML = `
                <div class="no-curses">
                    <i class="fas fa-spinner fa-spin"></i> 正在加载诅咒卡...
                </div>
            `;
            
            // 显示弹窗
            manageModal.classList.add('active');
            
            // 获取用户的所有诅咒卡
            const response = await fetch(`${API_BASE}/api/user/curse`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('获取诅咒卡失败');
            }
            
            const curses = await response.json();
            renderUserCurseCards(curses);
            
        } catch (error) {
            console.error('打开管理面板出错:', error);
            userCurseCards.innerHTML = `
                <div class="no-curses">
                    <i class="fas fa-exclamation-triangle"></i> 加载失败: ${error.message}
                </div>
            `;
            showErrorMessage('加载诅咒卡失败: ' + error.message);
        }
    }

    // 渲染用户的诅咒卡
    function renderUserCurseCards(curses) {
        const container = document.getElementById('userCurseCards');
        container.innerHTML = '';
        
        if (!curses || curses.length === 0) {
            container.innerHTML = `
                <div class="no-curses">
                    <i class="fas fa-skull-crossbones"></i> 您还没有创建任何诅咒卡
                </div>
            `;
            return;
        }
        
        // 诅咒类型名称映射
        const typeNames = {
            love: '感情破裂', 
            wealth: '事业失败', 
            health: '疾病缠身',
            study: '学业受阻', 
            family: '家庭不和', 
            other: '其他诅咒'
        };
        
        curses.forEach(curse => {
            // 计算剩余天数
            const createdDate = new Date(curse.created_at);
            const expiresAt = new Date(createdDate);
            expiresAt.setDate(expiresAt.getDate() + 30);
            const daysLeft = Math.max(0, Math.ceil((expiresAt - new Date()) / (86400000)));
            
            const card = document.createElement('div');
            card.className = 'curse-card';
            card.innerHTML = `
                <button class="delete-card" data-id="${curse.id}">&times;</button>
                <h4>${curse.user_name || '匿名目标'}</h4>
                <p>${curse.content}</p>
                <small>类型: ${typeNames[curse.type] || '其他诅咒'}</small>
                <small>剩余天数: ${daysLeft}天</small>
                <div class="wish-stats">
                    <span class="bless-count">${curse.blessings || 0}</span> 次诅咒
                </div>
            `;
            container.appendChild(card);
        });
        
        // 添加删除按钮事件
        document.querySelectorAll('.delete-card').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const cardId = btn.dataset.id;
                deleteCurseCard(cardId);
            });
        });
    }

    // 删除诅咒卡
    async function deleteCurseCard(cardId) {
        if (!confirm('确定要删除这个诅咒吗？此操作不可撤销！')) {
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/api/curse/${cardId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('删除失败');
            }
            
            showSuccessMessage('诅咒卡已删除');
            openManageModal(); // 刷新列表
        } catch (error) {
            console.error('删除诅咒卡出错:', error);
            showErrorMessage('删除失败: ' + error.message);
        }
    }
            
    // 渲染愿望分布图表
    function renderDistributionChart(distribution) {
        // 获取canvas元素
        const ctx = document.getElementById('wishchart').getContext('2d');
        
        // 确保之前的图表实例被销毁
        if (window.wishDistributionChart) {
            window.wishDistributionChart.destroy();
        }
        
        // 准备图表数据 - 使用中文标签
        const labels = {
            'love': '感情破裂',
            'wealth': '事业失败',
            'health': '疾病缠身',
            'study': '学业受阻',
            'family': '家庭不和',
            'other': '其他诅咒'
        };
            
        // 确保数据顺序一致
        const data = [
            distribution.love || 0,
            distribution.wealth || 0,
            distribution.health || 0,
            distribution.study || 0,
            distribution.family || 0,
            distribution.other || 0
        ];
        
        // 创建新图表
        window.wishDistributionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.values(labels),
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#6a11cb', 
                        '#2575fc', 
                        '#00b894', 
                        '#fdcb6e', 
                        '#e17055', 
                        '#b2bec3'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#b8c2cc',
                            font: {
                                family: "'Noto Serif SC', serif"
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        },
                        backgroundColor: 'rgba(10, 10, 20, 0.9)',
                        titleFont: {
                            family: "'Noto Serif SC', serif"
                        },
                        bodyFont: {
                            family: "'Noto Serif SC', serif"
                        }
                    }
                }
            }
        });
    }

    // 加载所有诅咒数据
    async function loadAllWishes() {
        try {
            const response = await fetch(API_URL);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            // 处理两种可能的响应格式
            allWishes = Array.isArray(result) 
                ? result 
                : (result.data || [result]).filter(Boolean);
            
            // 转换日期字符串为Date对象
            allWishes.forEach(wish => {
                if (wish.created_at && typeof wish.created_at === 'string') {
                    wish.created_at = new Date(wish.created_at);
                }
            });
            
            renderFilteredWishes();
            updatePagination();
            
        } catch (err) {
            console.error('加载诅咒时出错:', err);
            showErrorMessage(`加载失败: ${err.message}`);
        }
    }

    // 处理提交诅咒
    async function handleSubmitWish(e) {
      e.preventDefault();
      
      // 检查登录状态
      const token = localStorage.getItem('token');
      if (!token) {
        authModal.classList.add('active');
        switchAuthTab('login');
        return;
      }
      
      // 收集表单数据
      const targetName = document.getElementById('name').value.trim() || '匿名目标';
      const targetDescription = document.getElementById('targetDescription').value.trim();
      const content = document.getElementById('wishContent').value.trim();
      
      if (!content || !targetName || !targetDescription) {
        showErrorMessage('请填写完整的诅咒内容和目标信息');
        return;
      }
    
      // 设置提交按钮状态
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
    
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${token}`  // 添加Authorization头
          },
          body: JSON.stringify({
            content,
            user_name: targetName,
            target_description: targetDescription,
            type: document.getElementById('wishType').value,
            visibility: document.querySelector('input[name="visibility"]:checked').value,
            solar_date: new Date().toISOString().split('T')[0]
            // 不再手动设置user_id，后端会从JWT中获取
          })
        });
    
        if (!response.ok) {
          throw new Error(await response.text());
        }
    
        showSuccessMessage('诅咒已成功投入诅咒池！');
        wishForm.reset();
        charCount.textContent = '0';
        descCharCount.textContent = '0';
        
        // 重新加载诅咒列表和统计数据
        loadAllWishes();
        fetchStats();
      } catch (error) {
        console.error('提交错误:', error);
        showErrorMessage(`提交失败: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 投入诅咒池';
      }
    }

    // 初始化事件监听
    function initEventListeners() {
        // 初始化搜索功能
        initSearchFunctionality();
        
        // 筛选变化
        wishFilter.addEventListener('change', () => {
            currentPage = 1;
            renderFilteredWishes();
            updatePagination();
        });
        
        sortFilter.addEventListener('change', () => {
            currentPage = 1;
            renderFilteredWishes();
        });
        
        // 分页按钮
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderFilteredWishes();
                updatePagination();
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            const selectedType = wishFilter.value;
            let filteredWishes = [...allWishes];
            
            if (selectedType !== 'all') {
                filteredWishes = allWishes.filter(wish => wish.type === selectedType);
            }
            
            // 应用搜索筛选
            if (currentSearchTerm) {
                filteredWishes = filteredWishes.filter(wish => 
                    wish.user_name && wish.user_name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
            }
            
            const totalPages = Math.ceil(filteredWishes.length / wishesPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                renderFilteredWishes();
                updatePagination();
            }
        });

        // 绑定刷新统计按钮事件
        refreshStatsBtn.addEventListener('click', fetchStats);

        // 绑定表单提交事件
        wishForm.addEventListener('submit', handleSubmitWish);

        // 字符计数器
        wishContent.addEventListener('input', function() {
            charCount.textContent = this.value.length;
        });
        
        targetDescription.addEventListener('input', function() {
            descCharCount.textContent = this.value.length;
        });
    }
    
    // 初始化
    initUserStatus(); // 初始化用户状态
    initAuthModal(); // 初始化登录注册弹窗
    initManageModal(); // 初始化管理弹窗
    initEventListeners();
    loadAllWishes();
    fetchStats(); // 初始加载统计数据
    initEnergyChart(); // 初始化图表

    // 设置定时刷新统计数据（每5分钟）
    setInterval(fetchStats, 5 * 60 * 1000);
});
    </script>
</body>
</html>
