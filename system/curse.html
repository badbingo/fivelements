document.addEventListener('DOMContentLoaded', function() {
    // 配置后端地址
    const API_BASE = 'https://curse-backend.owenjass.workers.dev';
    const API_URL = `${API_BASE}/api/curse`;

    // 全局变量
    let allWishes = [];
    let currentPage = 1;
    const wishesPerPage = 9;
    let currentSearchTerm = '';
    
    // 获取DOM元素
    const wishFilter = document.getElementById('wishFilter');
    const sortFilter = document.getElementById('sortFilter');
    const wishPool = document.querySelector('.wish-pool');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    const wishForm = document.getElementById('wishForm');
    const baziInfo = document.getElementById('baziInfo');
    const fulfillModal = document.getElementById('fulfillModal');
    const wishSearch = document.getElementById('wishSearch');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const charCount = document.getElementById('charCount');
    const descCharCount = document.getElementById('descCharCount');
    const targetDescription = document.getElementById('targetDescription');
    const wishContent = document.getElementById('wishContent');
    const refreshStatsBtn = document.getElementById('refreshStatsBtn');

    // 初始化字符计数器
    wishContent.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });
    
    targetDescription.addEventListener('input', function() {
        descCharCount.textContent = this.value.length;
    });

    // 设置默认排序为"最新诅咒"
    sortFilter.value = 'newest';

    // 初始化搜索功能
    function initSearchFunctionality() {
        // 搜索按钮点击事件
        searchBtn.addEventListener('click', () => {
            currentSearchTerm = wishSearch.value.trim();
            if (currentSearchTerm) {
                currentPage = 1;
                renderFilteredWishes();
                clearSearchBtn.style.display = 'inline-block';
            }
        });

        // 清空搜索按钮
        clearSearchBtn.addEventListener('click', () => {
            wishSearch.value = '';
            currentSearchTerm = '';
            currentPage = 1;
            renderFilteredWishes();
            clearSearchBtn.style.display = 'none';
        });

        // 回车键触发搜索
        wishSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentSearchTerm = wishSearch.value.trim();
                if (currentSearchTerm) {
                    currentPage = 1;
                    renderFilteredWishes();
                    clearSearchBtn.style.display = 'inline-block';
                }
            }
        });
    }

    // 应用筛选和排序并渲染当前页的诅咒
    function renderFilteredWishes() {
        // 1. 应用类型筛选
        const selectedType = wishFilter.value;
        let filteredWishes = [...allWishes];
        
        if (selectedType !== 'all') {
            filteredWishes = allWishes.filter(wish => wish.type === selectedType);
        }
        
        // 2. 应用搜索筛选
        if (currentSearchTerm) {
            filteredWishes = filteredWishes.filter(wish => 
                wish.user_name && wish.user_name.toLowerCase().includes(currentSearchTerm.toLowerCase())
            );
        }
        
        // 3. 应用排序
        const selectedSort = sortFilter.value;
        
        switch(selectedSort) {
            case 'newest':
                filteredWishes.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                break;
            case 'oldest':
                filteredWishes.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
                break;
            case 'most':
                filteredWishes.sort((a, b) => (b.blessings || 0) - (a.blessings || 0));
                break;
            case 'least':
                filteredWishes.sort((a, b) => (a.blessings || 0) - (b.blessings || 0));
                break;
            default:
                filteredWishes.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        }
        
        // 4. 分页处理
        const startIndex = (currentPage - 1) * wishesPerPage;
        const paginatedWishes = filteredWishes.slice(startIndex, startIndex + wishesPerPage);
        
        // 渲染筛选后的诅咒
        renderWishCards(paginatedWishes);
        updatePagination();
    }

    // 更新分页信息
    function updatePagination() {
        const selectedType = wishFilter.value;
        let filteredWishes = [...allWishes];
        
        if (selectedType !== 'all') {
            filteredWishes = allWishes.filter(wish => wish.type === selectedType);
        }
        
        // 应用搜索筛选
        if (currentSearchTerm) {
            filteredWishes = filteredWishes.filter(wish => 
                wish.user_name && wish.user_name.toLowerCase().includes(currentSearchTerm.toLowerCase())
            );
        }
        
        const totalPages = Math.ceil(filteredWishes.length / wishesPerPage);
        
        pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages || totalPages === 0;
    }

    // 模态框关闭逻辑
    function setupModalClose() {
        // 1. 点击X按钮关闭
        const closeModalBtn = fulfillModal.querySelector('.close-modal');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                fulfillModal.style.display = 'none';
            });
        }

        // 2. 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === fulfillModal) {
                fulfillModal.style.display = 'none';
            }
        });
    }

    // 初始化模态框关闭功能
    setupModalClose();

    // 绑定表单提交事件
    wishForm.addEventListener('submit', handleSubmitWish);

    // 初始化加载诅咒数据
    async function loadAllWishes() {
      try {
        const response = await fetch(API_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // 处理两种可能的响应格式
        allWishes = Array.isArray(result) 
          ? result 
          : (result.data || [result]).filter(Boolean);
        
        // 转换日期字符串为Date对象
        allWishes.forEach(wish => {
          if (wish.created_at && typeof wish.created_at === 'string') {
            wish.created_at = new Date(wish.created_at);
          }
        });
        
        renderFilteredWishes();
        updatePagination();
        
      } catch (err) {
        console.error('加载诅咒时出错:', err);
        showErrorMessage(`加载失败: ${err.message}`);
      }
    }

    // 表单提交处理
    async function handleSubmitWish(e) {
        e.preventDefault();
        
        // 收集表单数据
        const targetName = document.getElementById('name').value.trim() || '匿名目标';
        const targetDescription = document.getElementById('targetDescription').value.trim();
        const content = document.getElementById('wishContent').value.trim();
        
        if (!content || !targetName || !targetDescription) {
            showErrorMessage('请填写完整的诅咒内容和目标信息');
            return;
        }

        // 设置提交按钮状态
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    content,
                    user_name: targetName,
                    target_description: targetDescription,
                    type: document.getElementById('wishType').value,
                    visibility: document.querySelector('input[name="visibility"]:checked').value,
                    solar_date: new Date().toISOString().split('T')[0],
                    user_id: 'guest_' + Date.now()
                })
            });

            if (!response.ok) {
                throw new Error(await response.text());
            }

            showSuccessMessage('诅咒已成功投入诅咒池！');
            wishForm.reset();
            charCount.textContent = '0';
            descCharCount.textContent = '0';
            
            // 重新加载诅咒列表和统计数据
            loadAllWishes();
            fetchStats();
        } catch (error) {
            console.error('提交错误:', error);
            showErrorMessage(`提交失败: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 投入诅咒池';
        }
    }

    // 获取并更新统计数据
    async function fetchStats() {
        try {
            // 添加时间戳防止缓存
            const response = await fetch(`${API_BASE}/api/stats?_=${Date.now()}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('统计数据:', data); // 调试用
            
            // 确保数据结构正确
            const stats = data.today || {};
            
            // 更新UI显示
            document.getElementById('newWishesCount').textContent = stats.newWishes || 0;
            document.getElementById('blessingsCount').textContent = stats.blessings || 0;
            document.getElementById('fulfilledCount').textContent = stats.fulfilled || 0;
            
            // 更新最后更新时间
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                `最后更新: ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // 如果有分布数据则渲染图表
            if (stats.distribution) {
                renderDistributionChart(stats.distribution);
            }
            
        } catch (error) {
            console.error('加载统计数据失败:', error);
            showErrorMessage(`统计加载失败: ${error.message}`);
        }
    }
    
    // 渲染愿望分布图表
    function renderDistributionChart(distribution) {
        const ctx = document.getElementById('wishchart').getContext('2d');
        
        // 销毁旧图表实例
        if (window.wishDistributionChart) {
            window.wishDistributionChart.destroy();
        }
        
        // 准备图表数据 - 使用中文标签
        const labels = {
            love: '感情破裂', 
            wealth: '事业失败', 
            health: '疾病缠身',
            study: '学业受阻', 
            family: '家庭不和', 
            other: '其他诅咒'
        };
                        
        // 确保数据顺序一致
        const data = [
            distribution.love || 0,
            distribution.wealth || 0,
            distribution.health || 0,
            distribution.study || 0,
            distribution.family || 0,
            distribution.other || 0
        ];
        
        // 创建新图表
        window.wishDistributionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.values(labels),
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#6a11cb', 
                        '#2575fc', 
                        '#00b894', 
                        '#fdcb6e', 
                        '#e17055', 
                        '#b2bec3'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#b8c2cc',
                            font: {
                                family: "'Noto Serif SC', serif"
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        },
                        backgroundColor: 'rgba(10, 10, 20, 0.9)',
                        titleFont: {
                            family: "'Noto Serif SC', serif"
                        },
                        bodyFont: {
                            family: "'Noto Serif SC', serif"
                        }
                    }
                }
            }
        });
    }

    // 渲染诅咒卡片
    function renderWishCards(wishes) {
        if (!Array.isArray(wishes)) {
            console.error('renderWishCards 接收到的不是数组:', wishes);
            return;
        }
        
        wishPool.innerHTML = '';
        
        if (wishes.length === 0) {
            wishPool.innerHTML = `
                <div class="wish-loading">
                    <i class="fas fa-skull-crossbones" style="font-size: 2rem; color: #c62828;"></i>
                    <p>没有找到符合条件的诅咒</p>
                    ${currentSearchTerm ? `<p>没有找到与"${currentSearchTerm}"相关的诅咒</p>` : '<p>请尝试其他筛选条件</p>'}
                </div>
            `;
            return;
        }
        
        // 诅咒类型名称映射
        const typeNames = {
            love: '感情破裂', 
            wealth: '事业失败', 
            health: '疾病缠身',
            study: '学业受阻', 
            family: '家庭不和', 
            other: '其他诅咒'
        };
        
        wishes.forEach(wish => {
            // 创建诅咒卡片
            const wishCard = document.createElement('div');
            wishCard.className = `wish-card level-${wish.level || 1}`;
            wishCard.dataset.id = wish.id;
            wishCard.dataset.level = wish.level || 1;
            wishCard.dataset.type = wish.type;
            wishCard.dataset.visibility = wish.visibility;
            
            // 计算剩余天数
            const createdDate = new Date(wish.created_at);
            const expiresAt = new Date(createdDate);
            expiresAt.setDate(expiresAt.getDate() + 30);
            const daysLeft = Math.max(0, Math.ceil((expiresAt - new Date()) / (86400000)));
            
            // 填充内容
            wishCard.innerHTML = `
                <div class="wish-header">
                    <div class="wish-user">
                        <i class="fas fa-user"></i> <span class="user-name">${wish.user_name || '匿名用户'}</span>
                    </div>
                    <span class="wish-type">${typeNames[wish.type] || '其他诅咒'}</span>
                    <span class="wish-time">剩余<span class="days-left">${daysLeft}</span>天</span>
                </div>
                <div class="wish-content">
                    <p class="wish-text">${wish.content}</p>
                    ${wish.target_description ? `<p class="target-description"><small>目标特征: ${wish.target_description}</small></p>` : ''}
                    <p class="wish-hidden">诅咒已隐藏</p>
                </div>
                <div class="wish-meta">
                    <div class="wish-stats">
                        <span class="bless-count">${wish.blessings || 0}</span> 次加持
                    </div>
                </div>
                <div class="wish-actions">
                    <button class="btn-bless">
                        <i class="fas fa-hands-helping"></i> 加持
                    </button>
                    <button class="btn-fulfill">
                    <i class="fas fa-hand-holding-heart"></i> 还愿
                    </button>
                </div>
                <div class="wish-energy">
                    <div class="energy-level level-${wish.level || 1}" style="width: ${(wish.level || 1) * 20}%"></div>
                </div>
            `;
            
            // 添加事件监听
            const blessBtn = wishCard.querySelector('.btn-bless');
            blessBtn.addEventListener('click', () => handleBlessWish(wishCard, wish));
            
            const fulfillBtn = wishCard.querySelector('.btn-fulfill');
            fulfillBtn.addEventListener('click', () => handleFulfillWish(wish));
            
            // 添加到池中
            wishPool.appendChild(wishCard);
        });
    }

    // 处理加持诅咒
    async function handleBlessWish(cardElement, wish) {
        try {
            // 检查登录状态
            const token = localStorage.getItem('token');
            if (!token) {
                showLoginModal();
                return;
            }

            // 检查本地加持记录
            const lastBlessKey = `lastBless_${wish.id}`;
            const lastBlessTime = localStorage.getItem(lastBlessKey);
            const now = Date.now();
            
            if (lastBlessTime && (now - parseInt(lastBlessTime)) < 3600000) {
                const nextBlessTime = new Date(parseInt(lastBlessTime) + 3600000);
                showToast(`每小时只能加持一次，请于 ${nextBlessTime.toLocaleTimeString()} 后再试`);
                return;
            }
        
            // 获取加持按钮并禁用
            const blessBtn = cardElement.querySelector('.btn-bless');
            blessBtn.disabled = true;
            blessBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加持中...';
        
            // 显示特效
            await showMantraEffect();
        
            // 发送请求
            const blessUrl = `${API_BASE}/api/bless/${wish.id}`;
            
            const response = await fetch(blessUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({})
            });
        
            // 处理响应
            if (!response.ok) {
                const errorData = await response.json();
                if (errorData.code === 401) {  // 未授权/未登录
                    showLoginModal();
                    return;
                }
                if (errorData.code === 429) {  // 频率限制
                    localStorage.setItem(lastBlessKey, new Date(errorData.nextBlessTime).getTime() - 3600000);
                    showToast(errorData.error);
                    return;
                }
                throw new Error(`加持失败 (${response.status}): ${JSON.stringify(errorData)}`);
            }
        
            const result = await response.json();
            console.log('加持结果:', result);
        
            // 记录本次加持时间
            localStorage.setItem(lastBlessKey, now.toString());
        
            // 更新UI
            cardElement.querySelector('.bless-count').textContent = result.blessings;
            cardElement.dataset.level = result.level;
            cardElement.className = `wish-card level-${result.level}`;
            cardElement.querySelector('.energy-level').className = `energy-level level-${result.level}`;
            cardElement.querySelector('.energy-level').style.width = `${result.level * 20}%`;
            
            // 显示成功动画
            cardElement.classList.add('level-up');
            setTimeout(() => cardElement.classList.remove('level-up'), 1000);
            
            // 提示用户
            const levelNames = ['初咒', '小成', '中成', '大成', '圆满'];
            showSuccessMessage(`加持成功！当前能量：${levelNames[result.level - 1]}`);
        
            // 更新统计数据
            fetchStats();
        } catch (error) {
            console.error('加持出错:', error);
            showErrorMessage(error.message);
        } finally {
            // 重置按钮状态
            const blessBtn = cardElement.querySelector('.btn-bless');
            if (blessBtn) {
                blessBtn.disabled = false;
                blessBtn.innerHTML = '<i class="fas fa-hands-helping"></i> 加持';
            }
        }
    }

    // 显示登录提示模态框
    function showLoginModal() {
        const modal = document.getElementById('loginModal');
        if (!modal) {
            // 如果没有模态框，使用默认confirm
            const shouldLogin = confirm('请先登录后才能加持\n\n点击"确定"跳转到登录页面');
            if (shouldLogin) {
                window.location.href = 'user.html';
            }
            return;
        }
        
        modal.style.display = 'block';
        
        // 设置确认按钮事件
        document.getElementById('confirmLogin').onclick = function() {
            window.location.href = 'user.html';
        };
        
        // 设置取消按钮事件
        document.getElementById('cancelLogin').onclick = function() {
            modal.style.display = 'none';
        };
    }

    // 处理还愿诅咒
    async function handleFulfillWish(wish) {
        try {
            // 检查登录状态
            const token = localStorage.getItem('token');
            if (!token) {
                const shouldLogin = confirm('请先登录后再还愿');
                if (shouldLogin) window.location.href = '/user.html';
                return;
            }

            // 显示还愿模态框
            const modal = document.getElementById('fulfillModal');
            if (!modal) {
                throw new Error('找不到还愿模态框');
            }
            
            // 设置诅咒ID到模态框
            modal.dataset.wishId = wish.id;
            modal.style.display = 'block';
        
        } catch (error) {
            console.error('还愿初始化失败:', error);
            alert('还愿失败: ' + error.message);
        }
    }

    // 显示六字真言特效
    async function showMantraEffect() {
        return new Promise((resolve) => {
            const overlay = document.getElementById('mantraOverlay');
            const container = overlay.querySelector('.mantra-container');
            
            // 重置状态
            overlay.classList.remove('active');
            document.querySelectorAll('.mantra-particle, .mantra-symbol, .mantra-circle').forEach(el => el.remove());
            
            // 创建背景元素
            createMantraBackground(container);
            
            // 显示叠加层
            setTimeout(() => {
                overlay.classList.add('active');
                
                // 文字逐个显示动画
                const texts = document.querySelectorAll('.mantra-text');
                texts.forEach((text, index) => {
                    setTimeout(() => {
                        text.classList.add('active');
                        
                        // 每个文字显示时创建粒子爆发
                        if(index % 2 === 0) createParticleBurst(text);
                        
                    }, index * 300);
                });
                
                // 7秒后结束
                setTimeout(() => {
                    overlay.classList.remove('active');
                    setTimeout(resolve, 800);
                }, 7000);
            }, 50);
        });
    }

    // 创建背景元素
    function createMantraBackground(container) {
        // 创建扫描光束
        for(let i = 0; i < 3; i++) {
            const beam = document.createElement('div');
            beam.className = 'mantra-beam';
            beam.style.left = `${Math.random() * 100}%`;
            beam.style.animationDelay = `${Math.random() * 5}s`;
            container.appendChild(beam);
        }
        
        // 创建脉动圆圈
        for(let i = 0; i < 5; i++) {
            const circle = document.createElement('div');
            circle.className = 'mantra-circle';
            circle.style.width = `${Math.random() * 200 + 100}px`;
            circle.style.height = circle.style.width;
            circle.style.left = `${Math.random() * 100}%`;
            circle.style.top = `${Math.random() * 100}%`;
            circle.style.animationDelay = `${Math.random() * 3}s`;
            container.appendChild(circle);
        }
        
        // 创建漂浮符号
        const symbols = ['☠', '☣', '☢', '⚰', '⚱', '☠', '☣', '☢', '⚰', '⚱', '☠', '☣', '☢', '⚰', '⚱'];
        for(let i = 0; i < 25; i++) {
            const symbol = document.createElement('div');
            symbol.className = 'mantra-symbol';
            symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
            symbol.style.left = `${Math.random() * 100}%`;
            symbol.style.fontSize = `${Math.random() * 3 + 2}rem`;
            symbol.style.animation = `symbolFloat ${Math.random() * 15 + 10}s linear ${Math.random() * 5}s infinite`;
            container.appendChild(symbol);
        }
    }

    // 创建粒子爆发效果
    function createParticleBurst(element) {
        const rect = element.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'mantra-particle';
            particle.style.left = `${centerX}px`;
            particle.style.top = `${centerY}px`;
            
            const angle = Math.random() * Math.PI * 2;
            const velocity = 2 + Math.random() * 3;
            const lifetime = 1000 + Math.random() * 1000;
            
            document.body.appendChild(particle);
            
            let startTime = Date.now();
            
            function animateParticle() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / lifetime;
                
                if (progress >= 1) {
                    particle.remove();
                    return;
                }
                
                const distance = velocity * elapsed / 20;
                const x = centerX + Math.cos(angle) * distance;
                const y = centerY + Math.sin(angle) * distance;
                
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.opacity = 1 - progress;
                
                requestAnimationFrame(animateParticle);
            }
            
            requestAnimationFrame(animateParticle);
        }
    }

    // 显示Toast消息
    function showToast(message, type = 'success') {
        // 移除现有的toast
        document.querySelectorAll('.toast').forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(toast);
        
        // 显示动画
        setTimeout(() => toast.classList.add('show'), 100);
        
        // 3秒后自动消失
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 显示成功消息
    function showSuccessMessage(message) {
        showToast(message, 'success');
    }
    
    // 显示错误消息
    function showErrorMessage(message) {
        showToast(message, 'error');
    }

    // 初始化事件监听
    function initEventListeners() {
        // 初始化搜索功能
        initSearchFunctionality();
        
        // 筛选变化
        wishFilter.addEventListener('change', () => {
            currentPage = 1;
            renderFilteredWishes();
            updatePagination();
        });
        
        sortFilter.addEventListener('change', () => {
            currentPage = 1;
            renderFilteredWishes();
        });
        
        // 分页按钮
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderFilteredWishes();
                updatePagination();
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            const selectedType = wishFilter.value;
            let filteredWishes = [...allWishes];
            
            if (selectedType !== 'all') {
                filteredWishes = allWishes.filter(wish => wish.type === selectedType);
            }
            
            // 应用搜索筛选
            if (currentSearchTerm) {
                filteredWishes = filteredWishes.filter(wish => 
                    wish.user_name && wish.user_name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
            }
            
            const totalPages = Math.ceil(filteredWishes.length / wishesPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                renderFilteredWishes();
                updatePagination();
            }
        });

        // 绑定刷新统计按钮事件
        refreshStatsBtn.addEventListener('click', fetchStats);
    }
    
    // 初始化
    initEventListeners();
    loadAllWishes();
    fetchStats(); // 初始加载统计数据

    // 设置定时刷新统计数据（每5分钟）
    setInterval(fetchStats, 5 * 60 * 1000);
});
