<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="专业八字预测系统，精准排盘，详细分析">
    <meta name="keywords" content="八字,命理,预测,排盘,五行">
    <title>专业八字预测系统</title>
    
    <!-- 字体和图标 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js 和插件 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- 导航菜单 -->
    <script src="../js/menu.js" defer></script>
    
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --gold-color: #f39c12;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e9ecef;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s ease;
            /* Added for unified UI blocks */
            --text-color: #2c3e50;
            --primary-rgb: 44, 62, 80;   /* rgb of #2c3e50 */
            --success-rgb: 39, 174, 96;  /* rgb of #27ae60 */
            --warning-rgb: 243, 156, 18; /* rgb of #f39c12 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Noto Serif SC', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .card-header i {
            font-size: 1.5rem;
            color: var(--secondary-color);
            margin-right: 15px;
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .form-group label i {
            margin-right: 8px;
            color: var(--secondary-color);
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            -webkit-appearance: none; /* 修复Safari下拉框样式 */
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg fill='%232c3e50' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Form Text Helper */
        .form-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
            display: block;
        }

        /* Button Styles */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-center {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        /* Bazi Table - 优化版 */
        .bazi-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 15px 0;
            font-size: 1.05rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(10px);
        }

        .bazi-table th,
        .bazi-table td {
            padding: 10px 8px;
            text-align: center;
            border: none;
            position: relative;
            height: auto;
            vertical-align: middle;
            transition: all 0.3s ease;
        }
        
        .bazi-table tr:not(:last-child) td,
        .bazi-table tr:not(:last-child) th {
            border-bottom: 1px solid rgba(233, 236, 239, 0.8);
        }
        
        .bazi-table th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            padding: 12px 10px;
        }

        .bazi-table td {
            background: transparent;
            font-weight: 500;
        }
        
        .bazi-table td:first-child {
            font-weight: 600;
            background: rgba(52, 152, 219, 0.05);
            border-right: 1px solid rgba(233, 236, 239, 0.8);
        }

        .bazi-table .pillar-header {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .bazi-table .stem {
            position: relative;
            padding: 8px 0;
        }

        .bazi-table .branch {
            position: relative;
            padding: 8px 0;
        }
        
        /* 添加柱子之间的分隔线 */
        .bazi-table th:not(:last-child),
        .bazi-table td:not(:last-child) {
            border-right: 1px solid rgba(233, 236, 239, 0.5);
        }
        
        /* 鼠标悬停效果 */
        .bazi-table tbody tr:hover td {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Chart Container - 优化版 */
        .chart-container,
        .current-chart-container {
            position: relative !important;
            height: 250px !important;
            margin: 35px 0 !important;
            border-radius: 12px !important;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)) !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08) !important;
            padding: 20px !important;
            backdrop-filter: blur(5px) !important;
            overflow: hidden !important;
        }
        
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }

/* Loading Spinner Styles */
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 20px;
}

.spinner-circle {
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

        .chart-description {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
            border-left: 4px solid var(--secondary-color);
        }
        
        .chart-description h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }
        
        .chart-description h4 i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .chart-description p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .chart-description strong {
            color: var(--primary-color);
        }

        /* Analysis Sections - 优化版 */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 35px 0;
        }

        .analysis-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }
        
        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at top right, rgba(52, 152, 219, 0.1), transparent 70%);
            border-radius: 0 0 0 100%;
        }

        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .analysis-card h3 {
            color: var(--primary-color);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            font-size: 1.4em;
            position: relative;
            padding-bottom: 12px;
        }
        
        .analysis-card h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), transparent);
            border-radius: 3px;
        }

        .analysis-card h3 i {
            margin-right: 12px;
            color: var(--secondary-color);
            font-size: 1.1em;
        }
        
        .analysis-card p {
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        .loading-overlay .loading {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
        }

        .loading-overlay p {
            color: white;
            font-size: 18px;
            margin: 0;
            text-align: center;
        }

        /* Beautiful Spinner */
        .beautiful-spinner {
            width: 20px;
            height: 20px;
            position: relative;
            display: inline-block;
        }

        .beautiful-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            border-top: 2px solid #3498db;
            border-right: 2px solid #e74c3c;
            border-radius: 50%;
            animation: beautiful-spin 1s linear infinite;
        }

        .beautiful-spinner::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: calc(100% - 6px);
            height: calc(100% - 6px);
            border: 2px solid transparent;
            border-top: 2px solid #f39c12;
            border-left: 2px solid #9b59b6;
            border-radius: 50%;
            animation: beautiful-spin 0.8s linear infinite reverse;
        }

        @keyframes beautiful-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab System - 优化版 */
        .tab-container {
            margin: 35px 0;
        }

        .tab-nav {
            display: flex;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            position: relative;
            z-index: 2;
            backdrop-filter: blur(5px);
        }

        .tab-btn {
            flex: 1;
            padding: 18px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            position: relative;
            overflow: hidden;
            color: var(--text-secondary);
            font-size: 1.05em;
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), rgba(52, 152, 219, 0.5));
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .tab-btn:hover::before {
            width: 30%;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(255,255,255,1), rgba(255,255,255,0.9));
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .tab-btn.active::before {
            width: 80%;
        }

        .tab-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            padding: 35px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: none;
            position: relative;
            z-index: 1;
            margin-top: -1px;
            backdrop-filter: blur(5px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Analysis Button - 优化版 */
        .analysis-btn {
            width: 100%;
            padding: 22px 25px;
            margin: 18px 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }
        
        .analysis-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), transparent);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .analysis-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, rgba(255,255,255,1), rgba(255,255,255,0.9));
        }
        
        .analysis-btn:hover::before {
            opacity: 1;
        }
        
        /* 五行主题颜色 - 命理全解（土） */
        .analysis-btn[data-analysis="full-analysis"] {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.08));
            border-left: 4px solid #ffc107;
        }
        
        .analysis-btn[data-analysis="full-analysis"]:hover {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.25), rgba(255, 193, 7, 0.15));
        }
        
        .analysis-btn[data-analysis="full-analysis"]::before {
            background: linear-gradient(to bottom, #ffc107, transparent);
        }
        
        /* 流年分析（火） */
        .analysis-btn[data-analysis="annual-fortune"] {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(231, 76, 60, 0.08));
            border-left: 4px solid #e74c3c;
        }
        
        .analysis-btn[data-analysis="annual-fortune"]:hover {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.25), rgba(231, 76, 60, 0.15));
        }
        
        .analysis-btn[data-analysis="annual-fortune"]::before {
            background: linear-gradient(to bottom, #e74c3c, transparent);
        }
        
        /* 流月分析（水） */
        .analysis-btn[data-analysis="monthly-fortune"] {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(52, 152, 219, 0.08));
            border-left: 4px solid #3498db;
        }
        
        .analysis-btn[data-analysis="monthly-fortune"]:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.25), rgba(52, 152, 219, 0.15));
        }
        
        .analysis-btn[data-analysis="monthly-fortune"]::before {
            background: linear-gradient(to bottom, #3498db, transparent);
        }
        
        /* 十年大运分析（金） */
        .analysis-btn[data-analysis="decade-fortune"] {
            background: linear-gradient(135deg, rgba(149, 165, 166, 0.15), rgba(149, 165, 166, 0.08));
            border-left: 4px solid #95a5a6;
        }
        
        .analysis-btn[data-analysis="decade-fortune"]:hover {
            background: linear-gradient(135deg, rgba(149, 165, 166, 0.25), rgba(149, 165, 166, 0.15));
        }
        
        .analysis-btn[data-analysis="decade-fortune"]::before {
            background: linear-gradient(to bottom, #95a5a6, transparent);
        }
        
        /* 性格分析（木） */
        .analysis-btn[data-analysis="personality"] {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.15), rgba(39, 174, 96, 0.08));
            border-left: 4px solid #27ae60;
        }
        
        .analysis-btn[data-analysis="personality"]:hover {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.25), rgba(39, 174, 96, 0.15));
        }
        
        .analysis-btn[data-analysis="personality"]::before {
            background: linear-gradient(to bottom, #27ae60, transparent);
        }
        
        /* 事业财富（土-深色） */
        .analysis-btn[data-analysis="career-wealth"] {
            background: linear-gradient(135deg, rgba(230, 126, 34, 0.15), rgba(230, 126, 34, 0.08));
            border-left: 4px solid #e67e22;
        }
        
        .analysis-btn[data-analysis="career-wealth"]:hover {
            background: linear-gradient(135deg, rgba(230, 126, 34, 0.25), rgba(230, 126, 34, 0.15));
        }
        
        .analysis-btn[data-analysis="career-wealth"]::before {
            background: linear-gradient(to bottom, #e67e22, transparent);
        }
        
        /* 婚姻分析（火-粉色） */
        .analysis-btn[data-analysis="marriage"] {
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.15), rgba(233, 30, 99, 0.08));
            border-left: 4px solid #e91e63;
        }
        
        .analysis-btn[data-analysis="marriage"]:hover {
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.25), rgba(233, 30, 99, 0.15));
        }
        
        .analysis-btn[data-analysis="marriage"]::before {
            background: linear-gradient(to bottom, #e91e63, transparent);
        }
        
        /* 子女分析（木-浅绿） */
        .analysis-btn[data-analysis="children"] {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.08));
            border-left: 4px solid #4caf50;
        }
        
        .analysis-btn[data-analysis="children"]:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.25), rgba(76, 175, 80, 0.15));
        }
        
        .analysis-btn[data-analysis="children"]::before {
            background: linear-gradient(to bottom, #4caf50, transparent);
        }
        
        /* 健康分析（水-青色） */
        .analysis-btn[data-analysis="health"] {
            background: linear-gradient(135deg, rgba(0, 188, 212, 0.15), rgba(0, 188, 212, 0.08));
            border-left: 4px solid #00bcd4;
        }
        
        .analysis-btn[data-analysis="health"]:hover {
            background: linear-gradient(135deg, rgba(0, 188, 212, 0.25), rgba(0, 188, 212, 0.15));
        }
        
        .analysis-btn[data-analysis="health"]::before {
            background: linear-gradient(to bottom, #00bcd4, transparent);
        }

        .analysis-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .analysis-btn-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .analysis-btn-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .analysis-btn:hover .analysis-btn-title {
            color: var(--secondary-color);
            transform: translateX(5px);
        }

        .analysis-btn-title i {
            margin-right: 12px;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .analysis-btn:hover .analysis-btn-title i {
            transform: scale(1.2);
        }

        .analysis-btn-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
            transition: all 0.3s ease;
        }
        
        .analysis-btn:hover .analysis-btn-desc {
            color: var(--text-primary);
        }

        .analysis-content {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        /* 展开内容的五行主题背景色 */
        .analysis-content[data-analysis="full-analysis"] {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.12), rgba(255, 193, 7, 0.05));
        }
        
        .analysis-content[data-analysis="annual-fortune"] {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.12), rgba(231, 76, 60, 0.05));
        }
        
        .analysis-content[data-analysis="monthly-fortune"] {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.12), rgba(52, 152, 219, 0.05));
        }
        
        .analysis-content[data-analysis="decade-fortune"] {
            background: linear-gradient(135deg, rgba(149, 165, 166, 0.12), rgba(149, 165, 166, 0.05));
        }
        
        .analysis-content[data-analysis="personality"] {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.12), rgba(39, 174, 96, 0.05));
        }
        
        .analysis-content[data-analysis="career-wealth"] {
            background: linear-gradient(135deg, rgba(230, 126, 34, 0.12), rgba(230, 126, 34, 0.05));
        }
        
        .analysis-content[data-analysis="marriage"] {
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
        }
        
        .analysis-content[data-analysis="children"] {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.12), rgba(76, 175, 80, 0.05));
        }
        
        .analysis-content[data-analysis="health"] {
            background: linear-gradient(135deg, rgba(0, 188, 212, 0.12), rgba(0, 188, 212, 0.05));
        }

        .analysis-content.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            body {
                overflow-x: auto;
            }
            
            .page-container {
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 15px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .tab-nav {
                flex-direction: column;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            /* 移动设备上的表单元素样式调整 */
            .form-group input,
            .form-group select {
                font-size: 16px; /* 防止iOS上自动缩放 */
                padding: 12px 40px 12px 15px; /* 增加右侧padding，为下拉箭头留出空间 */
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* 确保下拉箭头在移动设备上可见 */
            .form-group select {
                background-position: right 15px center;
                background-size: 16px;
            }
            
            /* 调整卡片内边距 */
            .card {
                padding: 20px 15px;
            }
        }
        
        /* 小屏幕设备的额外调整 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .card-header h2 {
                font-size: 1.3rem;
            }
            
            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            /* 确保表单元素在小屏幕上更易于点击 */
            .form-group input,
            .form-group select {
                height: 48px; /* 增加高度使触摸更容易 */
            }
        }

        /* 命格/财富等级移动端优化 */
        @media (max-width: 768px) {
            /* 分析卡片内容优化 */
            .analysis-card #fate-level-content > div:first-child > div:first-child,
            .analysis-card #wealth-level-content > div:first-child > div:first-child {
                font-size: 2rem !important;
            }
            
            .analysis-card #fate-level-content > div:first-child > div:nth-child(2),
            .analysis-card #wealth-level-content > div:first-child > div:nth-child(2) {
                font-size: 1.1rem !important;
            }
            
            /* 评分构成网格单列化 */
            .analysis-card div[style*="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .analysis-card div[style*="grid-template-columns: repeat(2, minmax(0, 1fr))"] {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }
            
            /* 评分卡片内边距和字体调整 */
            .analysis-card div[style*="border-radius: 8px; padding: 15px"] {
                padding: 10px !important;
            }
            
            .analysis-card div[style*="border-radius: 6px; padding: 12px"] {
                padding: 8px !important;
                font-size: 0.85rem !important;
            }
            
            /* 大分数字体调整 */
            .analysis-card div[style*="font-size: 1.5rem; font-weight: bold"] {
                font-size: 1.2rem !important;
            }
            
            /* 汇总区域弹性布局 */
            .analysis-card div[style*="display: flex; justify-content: space-between; align-items: center"] {
                flex-direction: column !important;
                gap: 8px !important;
                align-items: flex-start !important;
            }
        }
        
        @media (max-width: 480px) {
            /* 超小屏幕进一步缩小 */
            .analysis-card #fate-level-content > div:first-child > div:first-child,
            .analysis-card #wealth-level-content > div:first-child > div:first-child {
                font-size: 1.5rem !important;
            }
            
            .analysis-card #fate-level-content > div:first-child > div:nth-child(2),
            .analysis-card #wealth-level-content > div:first-child > div:nth-child(2) {
                font-size: 1rem !important;
            }
            
            .analysis-card div[style*="font-size: 1.2rem"] {
                font-size: 1rem !important;
            }
            
            .analysis-card div[style*="padding: 8px"] {
                padding: 6px !important;
                font-size: 0.8rem !important;
            }
        }

        /* Bazi Q&A Styles */
        .bazi-qa-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .bazi-qa-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .bazi-qa-header h3 {
            color: var(--primary-color);
            font-size: 1.5em;
            margin: 0 0 8px 0;
            font-weight: 600;
        }
        
        .bazi-qa-header h3 i {
            margin-right: 8px;
            color: var(--secondary-color);
        }
        
        .bazi-qa-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin: 0;
            line-height: 1.5;
        }
        
        .bazi-qa-input-section {
            margin-bottom: 20px;
        }
        
        .bazi-qa-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        #bazi-qa-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(52, 152, 219, 0.2);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            height: 48px;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
        }
        
        #bazi-qa-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: rgba(255,255,255,1);
        }
        
        .bazi-qa-submit {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
        }
        
        .bazi-qa-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .bazi-qa-submit:active {
            transform: translateY(0);
        }
        
        .bazi-qa-response {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            margin-top: 15px;
            line-height: 1.6;
        }
        
        .bazi-qa-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .qa-answer {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .qa-answer h4 {
            color: #007bff;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qa-answer h4 i {
            font-size: 1.2em;
        }
        
        .qa-content {
            line-height: 1.7;
            color: #333;
            font-size: 0.95em;
        }
        
        /* 新增样式：段落标题 */
        .qa-content .qa-section-title {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.05em;
            margin: 15px 0 8px 0;
            padding: 6px 10px;
            background: linear-gradient(135deg, #f1f3f4 0%, #e8eaf6 100%);
            border-left: 4px solid #3498db;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* 第一个标题的上边距调整 */
        .qa-content .qa-section-title:first-child {
            margin-top: 5px;
        }
        
        /* 新增样式：段落内容 */
        .qa-content .qa-paragraph {
            margin: 8px 0;
            padding: 0;
            text-align: justify;
            line-height: 1.6;
            text-indent: 0;
        }
        
        /* 段落内的换行样式 */
        .qa-content .qa-paragraph br {
            line-height: 1.4;
            margin: 2px 0;
        }
        
        /* 新增样式：列表容器 */
        .qa-content .qa-list {
            margin: 12px 0;
            padding-left: 0;
            list-style: none;
            background: rgba(248, 249, 250, 0.6);
            border-radius: 6px;
            padding: 10px;
        }
        
        /* 新增样式：列表项 */
        .qa-content .qa-list-item {
            margin: 6px 0;
            padding: 6px 12px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #17a2b8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .qa-content .qa-list-item:before {
            content: "▸";
            color: #17a2b8;
            font-weight: bold;
            position: absolute;
            left: -8px;
            top: 6px;
        }
        
        /* 新增样式：高亮文本 */
        .qa-content .qa-highlight {
            color: #e74c3c;
            font-weight: 600;
            background: rgba(231, 76, 60, 0.1);
            padding: 1px 3px;
            border-radius: 3px;
        }
        
        /* 新增样式：强调文本 */
        .qa-content .qa-emphasis {
            color: #8e44ad;
            font-style: italic;
            background: rgba(142, 68, 173, 0.1);
            padding: 1px 3px;
            border-radius: 3px;
        }
        
        /* 新增样式：关键词 */
        .qa-content .qa-keyword {
            color: #2980b9;
            font-weight: 600;
            background: rgba(41, 128, 185, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid rgba(41, 128, 185, 0.2);
        }
        
        /* 兼容旧样式 */
        .qa-content h1, .qa-content h2, .qa-content h3 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-weight: 600;
        }
        
        .qa-content h1 {
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .qa-content h2 {
            font-size: 1.2em;
            color: #34495e;
        }
        
        .qa-content h3 {
            font-size: 1.1em;
            color: #7f8c8d;
        }
        
        .qa-content strong {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .qa-content em {
            color: #8e44ad;
            font-style: italic;
        }
        
        .qa-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .qa-content li {
            margin: 5px 0;
            list-style-type: disc;
        }
        
        .qa-content p {
            margin: 10px 0;
            text-align: justify;
        }
        
        /* 移动设备适配 */
        @media (max-width: 768px) {
            .bazi-qa-input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            
            .bazi-qa-submit {
                justify-content: center;
            }
        }

        /* Hidden by default */
        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }
    /* 添加外层容器 */
    .page-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        overflow-x: hidden;
    }
    
    /* 内部容器使用100%宽度 */
    .container {
        width: 100%;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Safari特定样式 */
    @media not all and (min-resolution:.001dpcm) { 
        @supports (-webkit-appearance:none) {
            .form-group select {
                background-color: white; /* 确保背景色为白色 */
                text-indent: 1px; /* 修复文本对齐问题 */
                text-overflow: ''; /* 处理文本溢出 */
                padding-right: 30px; /* 为下拉箭头留出空间 */
            }
            
            /* 修复Safari上的触摸事件 */
            .form-group select:hover,
            .form-group select:focus {
                cursor: pointer;
                border-color: var(--secondary-color);
            }
        }
    }

            /* 用户管理区域样式 */
            .user-area {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
                background: rgba(255, 255, 255, 0.95);
                padding: 15px 20px;
                border-radius: 20px;
                border: 1px solid rgba(139, 69, 19, 0.2);
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                transition: all 0.3s ease;
                margin: 20px auto;
                max-width: 600px;
            }

            .user-area:hover {
                background: rgba(255, 255, 255, 1);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }

            .user-welcome {
                font-size: 14px;
                color: #8B4513;
                font-weight: 500;
                margin-right: 5px;
            }

            .user-balance {
                background: linear-gradient(135deg, #FFD700, #FFA500);
                color: #8B4513;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: bold;
                margin-right: 5px;
                box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
            }

            .login-btn, .logout-btn, .recharge-btn {
                background: linear-gradient(135deg, #8B4513, #A0522D);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 15px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 4px;
                font-weight: 500;
            }

            .login-btn:hover, .logout-btn:hover, .recharge-btn:hover {
                background: linear-gradient(135deg, #A0522D, #CD853F);
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
            }

            .recharge-btn {
                background: linear-gradient(135deg, #228B22, #32CD32);
            }

            .recharge-btn:hover {
                background: linear-gradient(135deg, #32CD32, #90EE90);
            }



            /* 认证弹窗样式 */
            .auth-modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                animation: fadeIn 0.3s ease;
            }

            .auth-container {
                position: relative;
                background: linear-gradient(135deg, rgba(255, 248, 220, 0.95), rgba(255, 255, 255, 0.95));
                margin: 5% auto;
                padding: 0;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(139, 69, 19, 0.2);
                overflow: hidden;
                animation: slideIn 0.3s ease;
            }

            .auth-header {
                background: linear-gradient(135deg, #8B4513, #A0522D);
                color: white;
                padding: 20px;
                text-align: center;
                border-radius: 15px 15px 0 0;
            }

            .auth-header h2 {
                margin: 0 0 5px 0;
                font-size: 24px;
                font-weight: 600;
            }

            .auth-header p {
                margin: 0;
                opacity: 0.9;
                font-size: 14px;
            }

            .auth-tabs {
                display: flex;
                background: rgba(139, 69, 19, 0.1);
            }

            .auth-tab {
                flex: 1;
                padding: 15px;
                text-align: center;
                cursor: pointer;
                background: rgba(139, 69, 19, 0.1);
                color: #8B4513;
                font-weight: 500;
                transition: all 0.3s ease;
                border-bottom: 3px solid transparent;
            }

            .auth-tab.active {
                background: white;
                color: #8B4513;
                border-bottom: 3px solid #8B4513;
            }

            .auth-tab:hover {
                background: rgba(139, 69, 19, 0.2);
            }

            .auth-form {
                display: none;
                padding: 30px;
            }

            .auth-form.active {
                display: block;
            }

            .auth-form .form-group {
                margin-bottom: 20px;
            }

            .auth-form label {
                display: block;
                margin-bottom: 8px;
                color: #8B4513;
                font-weight: 500;
                font-size: 14px;
            }

            .auth-form input {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid rgba(139, 69, 19, 0.2);
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
                background: rgba(255, 255, 255, 0.8);
                box-sizing: border-box;
            }

            .auth-form input:focus {
                outline: none;
                border-color: #8B4513;
                background: white;
                box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
            }

            .password-container {
                position: relative;
            }

            .password-toggle {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                color: #8B4513;
                opacity: 0.6;
                transition: opacity 0.3s ease;
            }

            .password-toggle:hover {
                opacity: 1;
            }

            .auth-btn {
                width: 100%;
                background: linear-gradient(135deg, #8B4513, #A0522D);
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-top: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .auth-btn:hover {
                background: linear-gradient(135deg, #A0522D, #CD853F);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
            }

            .forgot-password {
                text-align: center;
                margin-top: 15px;
            }

            .forgot-password a {
                color: #8B4513;
                text-decoration: none;
                font-size: 14px;
                transition: color 0.3s ease;
            }

            .forgot-password a:hover {
                color: #A0522D;
                text-decoration: underline;
            }

            .auth-message {
                margin-top: 15px;
                padding: 10px;
                border-radius: 5px;
                text-align: center;
                font-size: 14px;
                display: none;
            }

            .auth-message.success {
                background: rgba(34, 139, 34, 0.1);
                color: #228B22;
                border: 1px solid rgba(34, 139, 34, 0.3);
            }

            .auth-message.error {
                background: rgba(220, 20, 60, 0.1);
                color: #DC143C;
                border: 1px solid rgba(220, 20, 60, 0.3);
            }

            .close-auth {
                position: absolute;
                top: 15px;
                right: 20px;
                color: white;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                z-index: 1001;
                transition: color 0.3s ease;
            }

            .close-auth:hover {
                color: #FFD700;
            }

            /* 充值弹窗样式 */
            .recharge-modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                animation: fadeIn 0.3s ease;
            }

            .recharge-container {
                position: relative;
                background: linear-gradient(135deg, rgba(255, 248, 220, 0.95), rgba(255, 255, 255, 0.95));
                margin: 5% auto;
                padding: 0;
                border-radius: 15px;
                width: 90%;
                max-width: 450px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(34, 139, 34, 0.2);
                overflow: hidden;
                animation: slideIn 0.3s ease;
            }

            .recharge-header {
                background: linear-gradient(135deg, #228B22, #32CD32);
                color: white;
                padding: 20px;
                text-align: center;
                border-radius: 15px 15px 0 0;
            }

            .recharge-header h2 {
                margin: 0 0 5px 0;
                font-size: 24px;
                font-weight: 600;
            }

            .recharge-header p {
                margin: 0;
                opacity: 0.9;
                font-size: 14px;
            }

            .recharge-form {
                padding: 30px;
            }

            .recharge-form .form-group {
                margin-bottom: 20px;
            }

            .recharge-form label {
                display: block;
                margin-bottom: 8px;
                color: #228B22;
                font-weight: 500;
                font-size: 14px;
            }

            .recharge-form input[type="number"] {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid rgba(34, 139, 34, 0.2);
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
                background: rgba(255, 255, 255, 0.8);
                box-sizing: border-box;
            }

            .recharge-form input[type="number"]:focus {
                outline: none;
                border-color: #228B22;
                background: white;
                box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.1);
            }

            .payment-methods {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                gap: 15px;
            }

            .payment-option {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
                border: 2px solid transparent;
                border-radius: 12px;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }

            .payment-option:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                border-color: #52c41a;
            }

            .payment-option:has(input:checked) {
                background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
                color: white;
                border-color: #52c41a;
                box-shadow: 0 6px 20px rgba(82, 196, 26, 0.3);
            }

            .payment-option:has(input:checked) .payment-tag {
                color: rgba(255, 255, 255, 0.9);
            }

            .payment-option input[type="radio"] {
                display: none;
            }

            .payment-option i {
                font-size: 1.8em;
                margin-bottom: 8px;
            }

            .payment-main {
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  text-align: center;
                  font-size: 2.2em;
                  font-weight: 600;
                  margin-bottom: 6px;
              }

            .payment-tag {
                 font-size: 0.8em;
                 color: #666;
                 font-weight: 400;
                 padding: 2px 8px;
                 background: rgba(0, 0, 0, 0.05);
                 border-radius: 12px;
                 margin-top: 4px;
                 text-align: center;
                 display: block;
                 width: 100%;
             }

             /* 余额支付特殊样式 */
             .payment-option:has(input[value="balance"]) {
                 background: linear-gradient(135deg, #722ed1 0%, #9254de 100%);
                 color: white;
             }

             .payment-option:has(input[value="balance"]:checked) {
                 background: linear-gradient(135deg, #531dab 0%, #722ed1 100%);
                 border-color: #722ed1;
                 box-shadow: 0 6px 20px rgba(114, 46, 209, 0.3);
             }

             .payment-option:has(input[value="balance"]) .payment-tag {
                 color: rgba(255, 255, 255, 0.9);
                 background: rgba(255, 255, 255, 0.2);
             }

             /* 余额不足时的禁用样式 */
             .payment-option:has(input[value="balance"]:disabled) {
                 opacity: 0.5;
                 cursor: not-allowed;
                 background: linear-gradient(135deg, #d9d9d9 0%, #f0f0f0 100%);
                 color: #999;
             }

             .payment-option:has(input[value="balance"]:disabled):hover {
                 transform: none;
                 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
             }

            .recharge-form .recharge-btn {
                width: 100%;
                background: linear-gradient(135deg, #228B22, #32CD32);
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-top: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .recharge-form .recharge-btn:hover {
                background: linear-gradient(135deg, #32CD32, #90EE90);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(34, 139, 34, 0.3);
            }

            .recharge-message {
                margin-top: 15px;
                padding: 10px;
                border-radius: 5px;
                text-align: center;
                font-size: 14px;
                display: none;
            }

            .recharge-message.success {
                background: rgba(34, 139, 34, 0.1);
                color: #228B22;
                border: 1px solid rgba(34, 139, 34, 0.3);
            }

            .recharge-message.error {
                background: rgba(220, 20, 60, 0.1);
                color: #DC143C;
                border: 1px solid rgba(220, 20, 60, 0.3);
            }

            .close-recharge {
                position: absolute;
                top: 15px;
                right: 20px;
                color: white;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                z-index: 1001;
                transition: color 0.3s ease;
            }

            .close-recharge:hover {
                color: #FFD700;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-50px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* 响应式设计 */
            @media (max-width: 768px) {
                .user-area {
                    position: static;
                    margin-bottom: 15px;
                    justify-content: center;
                    flex-wrap: wrap;
                }

                .auth-container, .recharge-container {
                    width: 95%;
                    margin: 2% auto;
                }

                .payment-methods {
                    display: flex;
                    flex-direction: row;
                    justify-content: space-between;
                    gap: 15px;
                }
                .payment-option {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    border: 2px solid transparent;
                    border-radius: 12px;
                    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    position: relative;
                    overflow: hidden;
                }
                .payment-option:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                    border-color: #52c41a;
                }
                .payment-option:has(input:checked) {
                    background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
                    color: white;
                    border-color: #52c41a;
                    box-shadow: 0 6px 20px rgba(82, 196, 26, 0.3);
                }
                .payment-option:has(input:checked) .payment-tag {
                    color: rgba(255, 255, 255, 0.9);
                }
                .payment-option input {
                    display: none;
                }
                .payment-option i {
                    font-size: 1.8em;
                    margin-bottom: 8px;
                }
                .payment-main {
                     display: flex;
                     align-items: center;
                     justify-content: center;
                     text-align: center;
                     font-size: 1.1em;
                     font-weight: 600;
                     margin-bottom: 6px;
                 }
                .payment-tag {
                    font-size: 0.8em;
                    color: #666;
                    font-weight: 400;
                    padding: 2px 8px;
                    background: rgba(0, 0, 0, 0.05);
                    border-radius: 12px;
                    margin-top: 4px;
                }
            }

        /* 响应式设计 - 身强身弱分析对比 */
        @media (max-width: 1024px) {
            .strength-comparison-container {
                flex-direction: column !important;
                gap: 20px !important;
            }
            
            .original-strength-section,
            .current-strength-section {
                min-height: 350px;
            }
            
            .chart-container,
            .current-chart-container {
                height: 250px !important;
            }
        }
        
        @media (max-width: 768px) {
            .card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            /* 五行力量分布移动端优化 */
            .elements-comparison-container {
                flex-direction: column !important;
                gap: 20px !important;
                min-height: auto !important;
            }
            
            .original-elements-section,
            .current-elements-section {
                flex: none !important;
                padding: 15px !important;
                margin-bottom: 0;
            }
            
            .original-elements-section .chart-container,
            .current-elements-section .current-chart-container {
                height: 220px !important;
            }
            
            .original-elements-section .section-header h3,
            .current-elements-section .section-header h3 {
                font-size: 1rem !important;
            }
            
            /* 身强身弱分析移动端优化 */
            .strength-comparison-container {
                flex-direction: column !important;
                gap: 20px !important;
                min-height: auto !important;
            }
            
            .original-strength-section,
            .current-strength-section {
                flex: none !important;
                padding: 15px;
                min-height: 300px;
            }
            
            .section-header h3 {
                font-size: 1rem !important;
            }
            
            .chart-container,
            .current-chart-container {
                height: 200px !important;
            }
            
            .comparison-note {
                padding: 12px;
            }
            
            .comparison-note p {
                font-size: 0.85rem !important;
            }
            
            /* 五行分布概览768px以下优化 */
            #original-elements-summary div[style*="display: flex"],
            #current-elements-summary div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 6px !important;
            }
            
            #original-elements-summary div[style*="min-width: 100px"],
            #current-elements-summary div[style*="min-width: 100px"] {
                min-width: auto !important;
                margin-bottom: 6px !important;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem !important;
            }
            
            .header p {
                font-size: 1rem !important;
            }
            
            .card-header h2 {
                font-size: 1.3rem;
            }
            
            /* 五行力量分布小屏幕优化 */
            .original-elements-section,
            .current-elements-section {
                padding: 12px !important;
            }
            
            .original-elements-section .chart-container,
            .current-elements-section .current-chart-container {
                height: 200px !important;
                padding: 8px;
            }
            
            .original-elements-section .section-header h3,
            .current-elements-section .section-header h3 {
                font-size: 0.95rem !important;
            }
            
            #original-elements-summary,
            #current-elements-summary {
                padding: 10px !important;
                font-size: 0.85rem !important;
            }
            
            /* 身强身弱分析小屏幕优化 */
            .original-strength-section,
            .current-strength-section {
                padding: 12px;
                min-height: 280px;
            }
            
            .chart-container,
            .current-chart-container {
                height: 180px !important;
                padding: 8px;
            }
            
            .chart-description {
                padding: 12px !important;
            }
            
            /* 对比说明小屏幕优化 */
             .comparison-note {
                 padding: 10px !important;
                 margin-top: 12px !important;
             }
             
             .comparison-note p {
                 font-size: 0.8rem !important;
                 line-height: 1.4 !important;
             }
             
             /* 五行分布概览移动端优化 */
             #original-elements-summary div[style*="display: flex"],
             #current-elements-summary div[style*="display: flex"] {
                 flex-direction: column !important;
                 gap: 8px !important;
             }
             
             #original-elements-summary div[style*="min-width: 100px"],
             #current-elements-summary div[style*="min-width: 100px"] {
                 min-width: auto !important;
                 margin-bottom: 8px !important;
             }
         }

        /* Recent Records Styles */
        .recent-records-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .recent-record-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        .recent-record-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), var(--accent-color));
            opacity: 0;
            transition: all 0.3s ease;
        }

        .recent-record-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--secondary-color);
        }

        .recent-record-item:hover::before {
            opacity: 1;
        }

        .recent-record-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .recent-record-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .recent-record-name i {
            margin-right: 6px;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .recent-record-gender {
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .recent-record-gender.male {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(52, 152, 219, 0.1));
            color: #2980b9;
        }

        .recent-record-gender.female {
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.2), rgba(233, 30, 99, 0.1));
            color: #c2185b;
        }

        .recent-record-info {
            margin-bottom: 10px;
        }

        .recent-record-datetime {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .recent-record-datetime i {
            margin-right: 5px;
            color: var(--gold-color);
            font-size: 0.8rem;
        }

        .recent-record-bazi {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(52, 152, 219, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Noto Serif SC', serif;
            font-weight: 500;
        }

        .recent-record-pillar {
            text-align: center;
            flex: 1;
        }

        .recent-record-pillar-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .recent-record-pillar-value {
            font-size: 0.9rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .recent-record-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .recent-record-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .recent-record-btn i {
            font-size: 0.75rem;
        }

        .recent-record-btn.primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .recent-record-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .recent-record-btn.danger {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
            color: white;
        }

        .recent-record-btn.danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .no-recent-records {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .no-recent-records i {
            font-size: 3rem;
            color: var(--border-color);
            margin-bottom: 15px;
        }

        .no-recent-records p {
            font-size: 1.1rem;
            margin: 0;
        }

        /* 响应式设计 - 最近记录 */
        @media (max-width: 768px) {
            .recent-records-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .recent-record-item {
                padding: 10px;
            }
            
            .recent-record-header {
                margin-bottom: 6px;
            }
            
            .recent-record-info {
                margin-bottom: 8px;
            }
            
            .recent-record-actions {
                margin-top: 8px;
                gap: 5px;
            }
            
            .recent-record-btn {
                padding: 5px 8px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading beautiful-spinner"></div>
        <p id="loadingMessage">正在处理，请稍候...</p>
    </div>
    
    <!-- 充值弹窗 -->
    <div class="recharge-modal" id="rechargeModal">
        <div class="recharge-container">
            <span class="close-recharge" id="closeRecharge">&times;</span>
            <div class="recharge-header">
                <h2><i class="fas fa-coins"></i> 详批支付</h2>
                <p>选择一种支付方式</p>
            </div>
            
            <form id="rechargeForm" class="recharge-form">
                <div class="form-group">
                    <label for="rechargeAmount">付款金额</label>
                    <input type="number" id="rechargeAmount" placeholder="请输入充值金额" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>支付方式</label>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="alipay" checked>
                            <i class="fab fa-alipay"></i>
                            <div class="payment-main" style="font-size: 110%;">支付宝</div>
                            <span class="payment-tag">全球支付</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="wechat">
                            <i class="fab fa-weixin"></i>
                            <div class="payment-main" style="font-size: 110%;">微信支付</div>
                            <span class="payment-tag">国内支付</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="balance" id="balancePayment">
                            <i class="fas fa-wallet"></i>
                            <div class="payment-main" style="font-size: 110%;">余额支付</div>
                            <span class="payment-tag" id="balanceTag">余额: ¥<span id="userBalanceDisplay">0</span></span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="recharge-btn">
                    <span id="rechargeText">立即支付</span>
                    <span id="rechargeSpinner" style="display:none;">处理中...</span>
                </button>
                
                <div id="rechargeMessage" class="recharge-message"></div>
            </form>
        </div>
    </div>

    <!-- 半透明登录注册弹窗 -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <span class="close-auth" id="closeAuth">&times;</span>
            <div class="auth-header">
                <h2><i class="fas fa-user-circle"></i> 用户中心</h2>
                <p>登录或注册以管理您的账户</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">登录</div>
                <div class="auth-tab" id="registerTab">注册</div>
            </div>
            
           <!-- 登录表单 -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginUsername">用户名</label>
                    <input type="text" id="loginUsername" placeholder="请输入用户名" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" placeholder="请输入密码" required>
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('loginPassword', this)"></i>
                    </div>
                </div>
                
                <button type="submit" class="auth-btn" id="submitLogin">
                    <span id="loginText">登录</span>
                    <i class="fas fa-spinner fa-spin" id="loginSpinner" style="display:none;"></i>
                </button>
                
                <div class="forgot-password">
                    <a href="#" onclick="window.open('forgot.html','_blank','width=500,height=400,left='+(screen.width-500)/2+',top='+(screen.height-400)/2+',menubar=no,toolbar=no,location=no');return false;">
                        忘记密码?
                    </a>
                </div>
                
                <div id="loginMessage" class="auth-message"></div>
            </form>
            
            <!-- 注册表单 -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerUsername">用户名</label>
                    <input type="text" id="registerUsername" placeholder="请输入用户名(4-16位)" required minlength="4" maxlength="16">
                </div>
                
                <div class="form-group">
                    <label for="registerEmail">电子邮箱</label>
                    <input type="email" id="registerEmail" placeholder="请输入电子邮箱" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">密码</label>
                    <div class="password-container">
                        <input type="password" id="registerPassword" placeholder="请输入密码(至少6位)" required minlength="6">
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('registerPassword', this)"></i>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="registerConfirmPassword">确认密码</label>
                    <div class="password-container">
                        <input type="password" id="registerConfirmPassword" placeholder="请再次输入密码" required>
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('registerConfirmPassword', this)"></i>
                    </div>
                </div>
                
                <button type="submit" class="auth-btn" id="submitRegister">
                    <span id="registerText">注册</span>
                    <i class="fas fa-spinner fa-spin" id="registerSpinner" style="display:none;"></i>
                </button>
                
                <div id="registerMessage" class="auth-message"></div>
            </form>
        </div>
    </div>
    
    <div class="page-container">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-yin-yang"></i> 专业八字预测系统</h1>
            <p>精准排盘 · 详细分析 · 专业预测</p>
        </header>

        <!-- 用户信息区域 -->
        <div class="user-area">
            <div class="user-welcome" id="userWelcome" style="display:none;">欢迎, <span id="usernameDisplay"></span></div>
            <div class="user-balance" style="display:none; margin: 5px 0;" id="userBalance">
                <i class="fas fa-coins"></i> 余额: ¥<span id="balanceAmount">0</span>
            </div>
            <button class="login-btn" id="loginBtn">登录/注册</button>
            <button class="recharge-btn" id="rechargeBtn" style="display:none; margin: 2px;"><i class="fas fa-plus"></i> 充值</button>
            <button class="logout-btn" id="logoutBtn" style="display:none;"><i class="fas fa-sign-out-alt"></i> 退出</button>
        </div>

        <!-- Recent Records Section -->
        <section class="recent-records-section" id="recent-records-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-history"></i>
                    <h2>最近测算记录</h2>
                </div>
                <div class="recent-records-container" id="recent-records-container">
                    <!-- 最近测算记录将在这里显示 -->
                </div>
            </div>
        </section>

        <!-- Input Section -->
        <section class="input-section" id="input-section">
            <div class="card">
                
                <div class="card-header">
                    <i class="fas fa-user-edit"></i>
                    <h2>请输入您的出生信息</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name"><i class="fas fa-user"></i> 姓名</label>
                        <input type="text" id="name" placeholder="请输入您的姓名" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="gender"><i class="fas fa-venus-mars"></i> 性别</label>
                        <select id="gender" required>
                            <option value="">请选择性别</option>
                            <option value="male">男</option>
                            <option value="female">女</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="birth-date"><i class="fas fa-calendar-alt"></i> 出生日期</label>
                        <input type="date" id="birth-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="birth-time"><i class="fas fa-clock"></i> 出生时间</label>
                        <input type="time" id="birth-time" placeholder="请输入出生时间" required>
                        <small class="form-text">请输入24小时制时间，例如：08:30、15:45</small>
                    </div>
                    </div>
                </div>
                
                <div class="btn-center">
                    <button class="btn btn-primary" id="calculate-btn">
                        <i class="fas fa-calculator"></i> 开始八字测算
                    </button>
                </div>
            </div>
        </section>

        <!-- Result Section -->
        <section class="result-section" id="result-section">
            <!-- Basic Info -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-circle"></i>
                    <h2 id="user-info-title">基本信息</h2>
                </div>
                <div id="basic-info-content">
                    <!-- 基本信息将在这里显示 -->
                </div>
            </div>

            <!-- Bazi Chart -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-table"></i>
                    <h2>八字排盘</h2>
                </div>
                <div id="bazi-chart">
                    <!-- 八字排盘表格将在这里显示 -->
                </div>
            </div>

            <!-- Five Elements Chart -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i>
                    <h2>五行力量分布与分析</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-secondary); font-weight: normal;">原命局与当前运势的五行力量对比分析</p>
                </div>
                
                <!-- 双图表布局容器 -->
                <div class="elements-comparison-container" style="display: flex; gap: 25px; min-height: 450px; margin-bottom: 20px;">
                    
                    <!-- 左侧：原命局五行分布 -->
                    <div class="original-elements-section" style="flex: 1; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 20px; border: 2px solid #dee2e6; position: relative; overflow: hidden;">
                        <!-- 装饰性背景元素 -->
                        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: linear-gradient(45deg, #6c757d, #adb5bd); border-radius: 50%; opacity: 0.1;"></div>
                        
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #6c757d;">
                            <i class="fas fa-yin-yang" style="color: #6c757d; font-size: 1.3rem; margin-right: 10px;"></i>
                            <h3 style="margin: 0; color: #495057; font-weight: 600; font-size: 1.1rem;">原命局五行分布</h3>
                        </div>
                        
                        <div class="original-elements-frame" style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="chart-container" style="height: 280px !important; background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <canvas id="original-elements-chart"></canvas>
                            </div>
                            <div id="original-elements-summary" style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #6c757d; font-size: 0.9rem;">
                                <!-- 原命局五行分布概览 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：当前五行分布 -->
                    <div class="current-elements-section" style="flex: 1; background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 12px; padding: 20px; border: 2px solid #4caf50; position: relative; overflow: hidden;">
                        <!-- 装饰性背景元素 -->
                        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: linear-gradient(45deg, #4caf50, #81c784); border-radius: 50%; opacity: 0.15;"></div>
                        
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #4caf50;">
                            <i class="fas fa-clock" style="color: #4caf50; font-size: 1.3rem; margin-right: 10px;"></i>
                            <h3 style="margin: 0; color: #2e7d32; font-weight: 600; font-size: 1.1rem;">当前五行分布</h3>
                            <span style="margin-left: auto; font-size: 0.8rem; color: #388e3c; background: rgba(76, 175, 80, 0.1); padding: 4px 8px; border-radius: 4px;">含大运流年</span>
                        </div>
                        
                        <div class="current-elements-frame" style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="current-chart-container" style="height: 280px !important; background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <canvas id="current-elements-chart"></canvas>
                            </div>
                            <div id="current-elements-summary" style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #4caf50; font-size: 0.9rem;">
                                <!-- 当前五行分布概览 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 五行分析描述 -->
                <div class="chart-description" id="elements-description" style="width: 100%; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin: 0 auto;">
                    <!-- 五行分析描述 -->
                </div>
                
                <!-- 对比说明 -->
                <div class="comparison-note" style="margin-top: 15px; padding: 15px; background: linear-gradient(90deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <i class="fas fa-info-circle" style="color: #2e7d32; margin-right: 8px;"></i>
                        <strong style="color: #1b5e20;">分析说明</strong>
                    </div>
                    <p style="margin: 0; color: #2e7d32; font-size: 0.9rem; line-height: 1.5;">左侧显示您的原命局五行分布状态，右侧显示加入当前大运和流年后的五行力量变化。通过对比可以了解当前运势对您五行平衡的影响程度，以及哪些五行得到加强或削弱。</p>
                </div>
            </div>

            <!-- Combined Strength Analysis -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-balance-scale"></i>
                    <h2>身强身弱分析对比</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-secondary); font-weight: normal;">原命局与当前运势的力量对比分析</p>
                </div>
                
                <!-- 左右布局容器 -->
                <div class="strength-comparison-container" style="display: flex; gap: 25px; min-height: 400px;">
                    
                    <!-- 左侧：原命局分析 -->
                    <div class="original-strength-section" style="flex: 1; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 20px; border: 2px solid #dee2e6; position: relative; overflow: hidden;">
                        <!-- 装饰性背景元素 -->
                        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: linear-gradient(45deg, #6c757d, #adb5bd); border-radius: 50%; opacity: 0.1;"></div>
                        
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #6c757d;">
                            <i class="fas fa-yin-yang" style="color: #6c757d; font-size: 1.3rem; margin-right: 10px;"></i>
                            <h3 style="margin: 0; color: #495057; font-weight: 600; font-size: 1.1rem;">原命局分析</h3>
                        </div>
                        
                        <div class="strength-analysis-frame" style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="chart-container" style="height: 250px !important; background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <canvas id="strength-chart"></canvas>
                            </div>
                            <div class="chart-description" id="strength-description" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #6c757d;">
                                <!-- 身强身弱分析描述 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：当前分析 -->
                    <div class="current-strength-section" style="flex: 1; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; padding: 20px; border: 2px solid #2196f3; position: relative; overflow: hidden;">
                        <!-- 装饰性背景元素 -->
                        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: linear-gradient(45deg, #2196f3, #64b5f6); border-radius: 50%; opacity: 0.15;"></div>
                        
                        <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #2196f3;">
                            <i class="fas fa-clock" style="color: #2196f3; font-size: 1.3rem; margin-right: 10px;"></i>
                            <h3 style="margin: 0; color: #1976d2; font-weight: 600; font-size: 1.1rem;">当前运势分析</h3>
                        </div>
                        
                        <div class="current-strength-analysis-frame" style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="current-chart-container" style="height: 250px !important; background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <canvas id="current-strength-chart"></canvas>
                            </div>
                            <div class="chart-description" id="current-strength-description" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #2196f3;">
                                <!-- 当前身强身弱分析描述 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 对比说明 -->
                <div class="comparison-note" style="margin-top: 20px; padding: 15px; background: linear-gradient(90deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px; border-left: 4px solid #ff9800;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <i class="fas fa-info-circle" style="color: #f57c00; margin-right: 8px;"></i>
                        <strong style="color: #ef6c00;">分析说明</strong>
                    </div>
                    <p style="margin: 0; color: #bf360c; font-size: 0.9rem; line-height: 1.5;">左侧显示您的原命局身强身弱状态，右侧显示加入当前大运和流年后的身强身弱变化。通过对比可以了解当前运势对您命局力量的影响程度。</p>
                </div>
            </div>

            <!-- Luck Starting Time -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-hourglass-start"></i>
                    <h2>起运时间</h2>
                </div>
                <div id="luck-timing">
                    <!-- 起运时间分析 -->
                </div>
            </div>

            <!-- 详批八字按钮和介绍 -->
            <div class="card" style="background: linear-gradient(135deg, #fffbf0, #fff8e1); border: 2px solid #f0c674;">
                <div class="card-header">
                    <i class="fas fa-unlock"></i>
                    <h2>详批八字（20元每次）</h2>
                </div>
                <p style="font-weight: bold;">专业八字详批，深度解析您的一生运势！ 本系统基于传统命理精髓，结合现代算法，为您提供全面精准的八字分析，包括：命格等级评分（格局层次）、财富等级评分（财源特质）、命理全解（五行平衡、用神忌神）、十年大运走势、流年吉凶提示、流月运势波动，以及专项分析您的性格潜能、事业财富机遇、婚姻感情匹配度和子女缘份，助您把握人生关键节点。</p>
                <div class="btn-center">
                    <button class="btn btn-primary" id="detailed-analysis-btn">立即详批</button>
                </div>
            </div>

            <!-- 隐藏内容 -->
            <div id="paid-content" style="display: none; background: linear-gradient(135deg, #fffbf0, #fff8e1); border-radius: 12px; padding: 20px; border: 2px solid #f0c674; margin-bottom: 30px;">

            <!-- Fate Level Analysis -->
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3><i class="fas fa-star"></i> 命格等级</h3>
                    <div id="fate-level-content">
                        <!-- 命格等级分析 -->
                    </div>
                </div>
                
                <div class="analysis-card">
                    <h3><i class="fas fa-coins"></i> 财富等级</h3>
                    <div id="wealth-level-content">
                        <!-- 财富等级分析 -->
                    </div>
                </div>
            </div>


            <!-- Bazi Q&A Section -->
            <div class="bazi-qa-container">
                <div class="bazi-qa-header">
                    <h3><i class="fas fa-question-circle"></i> 八字问答</h3>
                    <p class="bazi-qa-subtitle">基于您的八字信息，询问任何八字相关问题</p>
                </div>
                <div class="bazi-qa-input-section">
                    <div class="bazi-qa-input-wrapper">
                        <input type="text" id="bazi-qa-input" placeholder="请输入您的八字相关问题，例如：我的命格等级的得分计算逻辑是什么？今年的事业运势如何？今年身体方面需要注意什么？" />
                        <button class="bazi-qa-submit" id="bazi-qa-submit">
                            <i class="fas fa-paper-plane"></i> 提问
                        </button>
                    </div>
                </div>
                <div id="bazi-qa-response" class="bazi-qa-response" style="display: none;">
                    <!-- 回答内容将在这里显示 -->
                </div>
                <div id="bazi-qa-loading" class="bazi-qa-loading" style="display: none;">
                    <div class="loading beautiful-spinner"></div>
                    <span>命理大师思考中，请耐心等待...</span>
                </div>
            </div>

            <!-- Analysis Tabs -->
            <div class="tab-container">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="fortune"><i class="fas fa-chart-line"></i> 运势分析</button>
                    <button class="tab-btn" data-tab="personality"><i class="fas fa-user-astronaut"></i> 个人分析</button>
                </div>
                
                <div class="tab-content active" id="fortune-tab">
                    <div class="analysis-btn" data-analysis="full-analysis">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-magic"></i> 命理全解</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">全面解析八字命理，包含性格、事业、财运、婚姻等多方面</div>
                    </div>
                    <div class="analysis-content" id="full-analysis-content" data-analysis="full-analysis"></div>
                    
                    <div class="analysis-btn" data-analysis="annual-fortune">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-calendar-alt"></i> 流年分析</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析当前流年对命局的影响和运势变化</div>
                    </div>
                    <div class="analysis-content" id="annual-fortune-content" data-analysis="annual-fortune"></div>
                    
                    <div class="analysis-btn" data-analysis="monthly-fortune">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-calendar-day"></i> 流月分析</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">预测当前年份每月的运势起伏</div>
                    </div>
                    <div class="analysis-content" id="monthly-fortune-content" data-analysis="monthly-fortune"></div>
                    
                    <div class="analysis-btn" data-analysis="decade-fortune">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-hourglass-half"></i> 十年大运分析</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析一生中各阶段大运走势</div>
                    </div>
                    <div class="analysis-content" id="decade-fortune-content" data-analysis="decade-fortune"></div>
                </div>
                
                <div class="tab-content" id="personality-tab">
                    <div class="analysis-btn" data-analysis="personality">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-brain"></i> 性格分析</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">根据八字分析性格特征和优缺点</div>
                    </div>
                    <div class="analysis-content" id="personality-content" data-analysis="personality"></div>
                    
                    <div class="analysis-btn" data-analysis="career-wealth">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-briefcase"></i> 事业财富</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析适合的职业方向和财富格局</div>
                    </div>
                    <div class="analysis-content" id="career-wealth-content" data-analysis="career-wealth"></div>
                    
                    <div class="analysis-btn" data-analysis="marriage">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-heart"></i> 婚姻分析</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析婚姻状况和配偶特征</div>
                    </div>
                    <div class="analysis-content" id="marriage-content" data-analysis="marriage"></div>
                    
                    <div class="analysis-btn" data-analysis="children">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-baby"></i> 子女分析</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析子女缘分和教育方向</div>
                    </div>
                    <div class="analysis-content" id="children-content" data-analysis="children"></div>
                    
                    <div class="analysis-btn" data-analysis="health">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="text-align: left;"><i class="fas fa-heartbeat"></i> 健康分析</div>
                                <i class="fas fa-caret-down" style="color: #3498db; font-size: 150%; margin-left: auto;"></i>
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">根据五行平衡分析健康状况</div>
                    </div>
                    <div class="analysis-content" id="health-content" data-analysis="health"></div>
                </div>
            </div>
            </div> <!-- 关闭 paid-content -->
            
            <div class="btn-center">
                <button class="btn btn-primary" id="recalculate-btn" onclick="location.reload()">
                    <i class="fas fa-redo"></i> 重新测算
                </button>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="../js/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 全局变量
        let currentBaziData = null;
        let elementsChart = null;
        let strengthChart = null;
        let currentStrengthChart = null;
        let recentRecords = []; // 最近测算记录
        const MAX_RECENT_RECORDS = 8; // 最大记录数

        // DOM元素
        const inputSection = document.getElementById('input-section');
        const resultSection = document.getElementById('result-section');
        const calculateBtn = document.getElementById('calculate-btn');
        const recalculateBtn = document.getElementById('recalculate-btn');
        const birthTimeInput = document.getElementById('birth-time');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupTabSystem();
            setupAnalysisButtons();
            loadRecentRecords();
            displayRecentRecords();
        });

        // 设置事件监听器
        function setupEventListeners() {
            calculateBtn.addEventListener('click', handleCalculate);
            recalculateBtn.addEventListener('click', handleRecalculate);
            setupBaziQA();
        }

        // 加载最近记录
        function loadRecentRecords() {
            try {
                const stored = localStorage.getItem('baziRecentRecords');
                if (stored) {
                    recentRecords = JSON.parse(stored);
                }
            } catch (error) {
                console.error('加载最近记录失败:', error);
                recentRecords = [];
            }
        }

        // 保存最近记录
        function saveRecentRecords() {
            try {
                localStorage.setItem('baziRecentRecords', JSON.stringify(recentRecords));
            } catch (error) {
                console.error('保存最近记录失败:', error);
            }
        }

        // 添加新记录
        function addRecentRecord(data) {
            const record = {
                id: Date.now().toString(),
                name: data.name,
                gender: data.gender,
                birthDate: data.birthDate,
                birthTime: data.birthTime,
                baziData: data.baziData,
                timestamp: new Date().toISOString()
            };

            // 检查是否已存在相同记录
            const existingIndex = recentRecords.findIndex(r => 
                r.name === record.name && 
                r.birthDate === record.birthDate && 
                r.birthTime === record.birthTime
            );

            if (existingIndex !== -1) {
                // 更新现有记录的时间戳
                recentRecords[existingIndex].timestamp = record.timestamp;
                // 移动到最前面
                const updatedRecord = recentRecords.splice(existingIndex, 1)[0];
                recentRecords.unshift(updatedRecord);
            } else {
                // 添加新记录到最前面
                recentRecords.unshift(record);
                // 保持最大记录数
                if (recentRecords.length > MAX_RECENT_RECORDS) {
                    recentRecords = recentRecords.slice(0, MAX_RECENT_RECORDS);
                }
            }

            saveRecentRecords();
            displayRecentRecords();
        }

        // 删除记录
        function deleteRecentRecord(id) {
            recentRecords = recentRecords.filter(record => record.id !== id);
            saveRecentRecords();
            displayRecentRecords();
        }

        // 显示最近记录
        function displayRecentRecords() {
            const container = document.getElementById('recent-records-container');
            const section = document.getElementById('recent-records-section');
            
            if (!container || !section) return;

            if (recentRecords.length === 0) {
                container.innerHTML = `
                    <div class="no-recent-records">
                        <i class="fas fa-history"></i>
                        <p>暂无最近测算记录</p>
                    </div>
                `;
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = recentRecords.map(record => {
                const date = new Date(record.timestamp);
                const formattedDate = date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const genderClass = record.gender === '男' ? 'male' : 'female';
                const genderIcon = record.gender === '男' ? 'fas fa-mars' : 'fas fa-venus';

                return `
                    <div class="recent-record-item" data-id="${record.id}">
                        <div class="recent-record-header">
                            <div class="recent-record-name">
                                <i class="fas fa-user"></i>
                                ${record.name}
                            </div>
                            <div class="recent-record-gender ${genderClass}">
                                <i class="${genderIcon}"></i> ${record.gender}
                            </div>
                        </div>
                        <div class="recent-record-info">
                            <div class="recent-record-datetime">
                                <i class="fas fa-clock"></i>
                                ${formattedDate}
                            </div>
                        </div>
                        <div class="recent-record-actions">
                            <button class="recent-record-btn primary" onclick="loadRecentRecord('${record.id}')">
                                <i class="fas fa-calculator"></i> 重新测算
                            </button>
                            <button class="recent-record-btn danger" onclick="deleteRecentRecord('${record.id}')">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 加载最近记录进行测算
        function loadRecentRecord(id) {
            const record = recentRecords.find(r => r.id === id);
            if (!record) return;

            // 填充表单
            document.getElementById('name').value = record.name;
            document.getElementById('gender').value = record.gender;
            document.getElementById('birth-date').value = record.birthDate;
            document.getElementById('birth-time').value = record.birthTime;

            // 滚动到输入区域
            document.getElementById('input-section').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });

            // 自动触发计算
            setTimeout(() => {
                handleCalculate();
            }, 500);
        }
        
        // 设置八字问答功能
        function setupBaziQA() {
            const qaInput = document.getElementById('bazi-qa-input');
            const qaSubmit = document.getElementById('bazi-qa-submit');
            const qaResponse = document.getElementById('bazi-qa-response');
            const qaLoading = document.getElementById('bazi-qa-loading');
            
            if (qaSubmit) {
                qaSubmit.addEventListener('click', handleBaziQA);
            }
            
            if (qaInput) {
                qaInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        handleBaziQA();
                    }
                });
            }
        }
        
        // 处理八字问答
        async function handleBaziQA() {
            const qaInput = document.getElementById('bazi-qa-input');
            const qaResponse = document.getElementById('bazi-qa-response');
            const qaLoading = document.getElementById('bazi-qa-loading');
            const qaSubmit = document.getElementById('bazi-qa-submit');
            
            const question = qaInput.value.trim();
            if (!question) {
                alert('请输入您的问题');
                return;
            }
            
            // 检查是否已计算八字
            if (!window.currentBaziData) {
                alert('请先计算八字信息');
                return;
            }
            
            // 显示加载状态
            qaLoading.style.display = 'flex';
            qaResponse.style.display = 'none';
            qaSubmit.disabled = true;
            
            try {
                const response = await callBaziQAAPI(question, window.currentBaziData);
                
                // 显示回答
                qaResponse.innerHTML = response;
                qaResponse.style.display = 'block';
                qaLoading.style.display = 'none';
                
                // 清空输入框
                qaInput.value = '';
                
            } catch (error) {
                console.error('八字问答API调用失败:', error);
                qaResponse.innerHTML = '<p style="color: #e74c3c;">抱歉，问答服务暂时不可用，请稍后再试。</p>';
                qaResponse.style.display = 'block';
                qaLoading.style.display = 'none';
            } finally {
                qaSubmit.disabled = false;
            }
        }



        // 设置标签页系统
        function setupTabSystem() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // 移除所有活动状态
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // 添加活动状态
                    this.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });
        }

        // 设置分析按钮
        function setupAnalysisButtons() {
            const analysisBtns = document.querySelectorAll('.analysis-btn');
            
            analysisBtns.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const analysisType = this.dataset.analysis;
                    const contentElement = document.getElementById(analysisType + '-content');
                    const loadingElement = this.querySelector('.loading');
                    
                    if (contentElement.classList.contains('show')) {
                        // 如果已经显示，则隐藏
                        contentElement.classList.remove('show');
                    } else {
                        // 检查是否有八字数据
                        if (!currentBaziData) {
                            alert('请先进行八字测算');
                            return;
                        }
                        
                        // 显示加载状态
                        loadingElement.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; width: 100%; margin: 0;"><i class="fas fa-spinner fa-spin" style="color: #3498db; font-size: 2.5em;"></i></span>';
                        loadingElement.style.display = 'flex';
                        loadingElement.style.position = 'absolute';
                        loadingElement.style.top = '0';
                        loadingElement.style.left = '0';
                        loadingElement.style.width = '100%';
                        loadingElement.style.height = '100%';
                        loadingElement.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                        loadingElement.style.borderRadius = '12px';
                        loadingElement.style.zIndex = '10';
                        // 移除 this.classList.add('loading'); 以避免潜在的旋转效果
                        
                        try {
                            // 使用本地已获取的八字信息、身强身弱信息和起运时间信息
                            // 通过DeepSeek API获取专业命理分析
                            const analysisContent = await getBaziAnalysisFromDeepSeek(analysisType, currentBaziData);
                            
                            // 隐藏加载状态
                            loadingElement.style.display = 'none';
                            this.classList.remove('loading');
                            
                            // 显示分析内容
                            contentElement.innerHTML = marked.parse(analysisContent);
contentElement.classList.add('show');
                            contentElement.classList.add('show');
                            console.log('成功获取API分析内容:', analysisType);
                        } catch (error) {
                            console.error('获取分析内容失败:', error);
                            
                            // 隐藏加载状态
                            loadingElement.style.display = 'none';
                            this.classList.remove('loading');
                            
                            // 显示错误提示和备用内容
                            const errorMessage = `<div class="api-error-message">API调用失败: ${error.message || '未知错误'}，使用备用内容</div>`;
                            contentElement.innerHTML = errorMessage + marked.parse(getAnalysisContent(analysisType));
                            contentElement.classList.add('show');
                        }
                    }
                });
            });
        }

        // 处理计算按钮点击
        async function handleCalculate() {
            if (!validateForm()) {
                return;
            }
            
            // 显示加载状态
            calculateBtn.innerHTML = '<div class="loading"></div> <span>计算中...</span>';
            calculateBtn.disabled = true;
            
            // 显示全局加载遮罩
            showLoading('正在进行八字测算，请稍候...');
            
            try {
                // 获取表单数据
                const formData = getFormData();
                
                // 计算八字
                const baziData = await calculateBazi(formData);
                currentBaziData = baziData;
                window.currentBaziData = baziData;
                
                // 显示结果
                displayResults(baziData);
                
                // 添加到最近记录
                addRecentRecord({
                    name: formData.name,
                    gender: formData.gender,
                    birthDate: formData.birthDate,
                    birthTime: formData.birthTime,
                    baziData: {
                        year: baziData.year,
                        month: baziData.month,
                        day: baziData.day,
                        hour: baziData.hour
                    }
                });
                
                // 切换到结果页面
                inputSection.style.display = 'none';
                resultSection.classList.add('show');
                
            } catch (error) {
                console.error('计算失败:', error);
                alert('计算失败，请检查输入信息后重试');
            } finally {
                calculateBtn.innerHTML = '<i class="fas fa-calculator"></i> 开始八字测算';
                calculateBtn.disabled = false;
                
                // 隐藏全局加载遮罩
                hideLoading();
            }
        }

        // 显示加载状态
        function showLoading(message = '正在处理，请稍候...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
            
            loadingOverlay.style.display = 'flex';
        }
        
        // 隐藏加载状态
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'none';
        }
        
        // 处理重新计算
        function handleRecalculate() {
            inputSection.style.display = 'block';
            resultSection.classList.remove('show');
            
            // 清空API反馈内容的缓存
            const cacheKeys = [
                'full-analysis', 'annual-fortune', 'monthly-fortune', 'decade-fortune',
                'personality', 'career', 'wealth', 'marriage', 
                'health', 'luck', 'children', 'disaster'
            ];
            cacheKeys.forEach(analysisType => {
                // 清空localStorage中的缓存
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes(analysisType)) {
                        localStorage.removeItem(key);
                    }
                });
                
                // 清空页面显示内容
                const contentElement = document.getElementById(analysisType + '-content');
                if (contentElement) {
                    contentElement.innerHTML = '';
                    contentElement.classList.remove('show');
                }
            });

            // 新增: 重置财富等级与命格等级缓存及页面显示
            wealthScoreValue = 0;
            fateScoreValue = 0;
            wealthScoreDetails = {};
            fateScoreDetails = {};
            const wealthScoreEl = document.getElementById('wealth-score');
            if (wealthScoreEl) wealthScoreEl.textContent = '';
            const fateScoreEl = document.getElementById('fate-score');
            if (fateScoreEl) fateScoreEl.textContent = '';
            
            // 重置当前八字数据
            currentBaziData = null;
            window.currentBaziData = null;
            
            // 重置表单
            document.getElementById('name').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('birth-date').value = '';
            document.getElementById('birth-time').value = '';
        }

        // 验证表单
        function validateForm() {
            const name = document.getElementById('name').value.trim();
            const gender = document.getElementById('gender').value;
            const birthDate = document.getElementById('birth-date').value;
            const birthTime = document.getElementById('birth-time').value;
            
            if (!name) {
                alert('请输入姓名');
                return false;
            }
            
            if (!gender) {
                alert('请选择性别');
                return false;
            }
            
            if (!birthDate) {
                alert('请选择出生日期');
                return false;
            }
            
            if (!birthTime) {
                alert('请输入出生时间');
                return false;
            }
            
            // 验证时间格式
            const timePattern = /^([01]?[0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timePattern.test(birthTime)) {
                alert('出生时间格式不正确，请使用24小时制（如：08:30、15:45）');
                return false;
            }
            
            return true;
        }

        // 获取表单数据
        function getFormData() {
            return {
                name: document.getElementById('name').value.trim(),
                gender: document.getElementById('gender').value,
                birthDate: document.getElementById('birth-date').value,
                birthTime: document.getElementById('birth-time').value
            };
        }

        // 计算八字
        async function calculateBazi(formData) {
            const { birthDate, birthTime } = formData;
            const [hour, minute] = birthTime.split(':').map(Number);
            
            // 验证时间格式
            if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                throw new Error('出生时间格式不正确，请使用24小时制（如：08:30、15:45）');
            }
            
            const date = new Date(birthDate + 'T00:00:00');
            date.setHours(hour, minute, 0, 0);
            
            // 使用lunar.js计算八字
            const solar = Solar.fromDate(date);
            const lunar = solar.getLunar();
            const eightChar = lunar.getEightChar();
            
            // 将eightChar保存到window对象，供其他函数使用
            window.eightChar = eightChar;
            
            // 获取四柱信息
            const yearPillar = eightChar.getYear();
            const monthPillar = eightChar.getMonth();
            const dayPillar = eightChar.getDay();
            const hourPillar = eightChar.getTime();
            
            // 确保四柱是字符串
            const yearStr = typeof yearPillar === 'string' ? yearPillar : String(yearPillar);
            const monthStr = typeof monthPillar === 'string' ? monthPillar : String(monthPillar);
            const dayStr = typeof dayPillar === 'string' ? dayPillar : String(dayPillar);
            const hourStr = typeof hourPillar === 'string' ? hourPillar : String(hourPillar);
            
            // 计算藏干
            const hiddenStems = {
                year: yearStr.length > 1 ? getHiddenStems(yearStr.charAt(1)) : [],
                month: monthStr.length > 1 ? getHiddenStems(monthStr.charAt(1)) : [],
                day: dayStr.length > 1 ? getHiddenStems(dayStr.charAt(1)) : [],
                hour: hourStr.length > 1 ? getHiddenStems(hourStr.charAt(1)) : []
            };
            
            // 计算五行分布
            const elements = calculateElements(yearStr, monthStr, dayStr, hourStr, hiddenStems);
            
            // 计算身强身弱
            // 计算起运时间，传入原始阳历日期
            const luckTiming = calculateLuckTiming(formData.gender, lunar, date);
            
            // 定义四柱对象
            const pillars = {
                year: yearStr,
                month: monthStr,
                day: dayStr,
                hour: hourStr
            };
            
            // 将四柱信息保存到window对象，供其他函数使用
            window.currentPillars = pillars;
            
            // 提取地支并保存到window对象，供三合局检测使用
            const allBranches = [];
            if (yearStr.length > 1) allBranches.push(yearStr.charAt(1));
            if (monthStr.length > 1) allBranches.push(monthStr.charAt(1));
            if (dayStr.length > 1) allBranches.push(dayStr.charAt(1));
            if (hourStr.length > 1) allBranches.push(hourStr.charAt(1));
            window.allBranches = allBranches;
            console.log('设置八字地支:', window.allBranches);
            
            // 计算身强身弱
            const strengthAnalysis = calculateStrength(dayStr, elements, monthStr, allBranches);
            
            // 计算命格等级
            const fateLevel = calculateFateLevel(pillars);
            
            // 计算财富等级
            const wealthLevel = calculateWealthLevel(pillars);
            
            // 计算当前流年信息供财富计算使用
            const currentDate = new Date();
            const currentSolar = Solar.fromDate(currentDate);
            const currentLunar = currentSolar.getLunar();
            const currentYearGanZhi = currentLunar.getYearInGanZhi();
            
            return {
                name: formData.name,
                gender: formData.gender,
                birthDate: formData.birthDate,
                birthTime: formData.birthTime,
                solar: solar,
                lunar: lunar,
                pillars: {
                    year: yearStr,
                    month: monthStr,
                    day: dayStr,
                    hour: hourStr
                },
                hiddenStems: hiddenStems,
                elements: elements,
                strengthAnalysis: strengthAnalysis,
                luckTiming: luckTiming,
                fateLevel: fateLevel,
                wealthLevel: wealthLevel,
                currentYearGanZhi: currentYearGanZhi,  // 新增：当前流年干支
                // API调用所需的格式化数据
                formattedBirthDate: `${lunar.getYear()}年${lunar.getMonth()}月${lunar.getDay()}日`,
                formattedBirthTime: `${formData.birthTime}时`,
                baziString: `${yearPillar} ${monthPillar} ${dayPillar} ${hourPillar}`
            };
        }

        // 获取地支藏干
        function getHiddenStems(branch) {
            const hiddenStemsMap = {
                '子': ['癸'],
                '丑': ['己', '癸', '辛'],
                '寅': ['甲', '丙', '戊'],
                '卯': ['乙'],
                '辰': ['戊', '乙', '癸'],
                '巳': ['丙', '庚', '戊'],
                '午': ['丁', '己'],
                '未': ['己', '丁', '乙'],
                '申': ['庚', '壬', '戊'],
                '酉': ['辛'],
                '戌': ['戊', '辛', '丁'],
                '亥': ['壬', '甲']
            };
            return hiddenStemsMap[branch] || [];
        }

        // 计算五行分布
        function calculateElements(year, month, day, hour, hiddenStems) {
            const elementMap = {
                '甲': 'wood', '乙': 'wood',
                '丙': 'fire', '丁': 'fire',
                '戊': 'earth', '己': 'earth',
                '庚': 'metal', '辛': 'metal',
                '壬': 'water', '癸': 'water',
                '寅': 'wood', '卯': 'wood',
                '巳': 'fire', '午': 'fire',
                '辰': 'earth', '戌': 'earth', '丑': 'earth', '未': 'earth',
                '申': 'metal', '酉': 'metal',
                '子': 'water', '亥': 'water'
            };
            
            const elements = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            
            // 确保四柱是字符串
            const pillars = [
                typeof year === 'string' ? year : String(year),
                typeof month === 'string' ? month : String(month),
                typeof day === 'string' ? day : String(day),
                typeof hour === 'string' ? hour : String(hour)
            ];
            
            // 计算天干地支
            const pillarWeights = [1.0, 1.2, 1.0, 0.8]; // 年月日时的权重
            pillars.forEach((pillar, index) => {
                if (pillar && pillar.length >= 2) {
                    const stem = pillar.charAt(0);
                    const branch = pillar.charAt(1);
                    const weight = pillarWeights[index];
                    
                    if (elementMap[stem]) elements[elementMap[stem]] += 2 * weight; // 天干权重2，乘以柱位权重
                    if (elementMap[branch]) elements[elementMap[branch]] += 1 * weight; // 地支权重1，乘以柱位权重
                }
            });
            
            // 计算藏干
            const hiddenStemWeights = [0.5, 0.6, 0.5, 0.4]; // 年月日时藏干的权重
            Object.entries(hiddenStems).forEach(([pillar, stems], index) => {
                stems.forEach(stem => {
                    if (elementMap[stem]) {
                        const weight = hiddenStemWeights[index];
                        elements[elementMap[stem]] += 0.5 * weight; // 藏干权重0.5，乘以柱位权重
                    }
                });
            });
            
            // 打印调试信息
            console.log('五行分布计算结果:', elements);
            
            return elements;
        }

        // 五行关系判断工具函数
        function is_generating(e1, e2) {
            // e1是否能生e2
            return (e1 === '木' && e2 === '火') || (e1 === '火' && e2 === '土') ||
                   (e1 === '土' && e2 === '金') || (e1 === '金' && e2 === '水') ||
                   (e1 === '水' && e2 === '木');
        }
        
        function is_restricting(e1, e2) {
            // e1是否能克e2
            return (e1 === '木' && e2 === '土') || (e1 === '土' && e2 === '水') ||
                   (e1 === '水' && e2 === '火') || (e1 === '火' && e2 === '金') ||
                   (e1 === '金' && e2 === '木');
        }
        
        function is_outputting(e1, e2) {
            // e1是否能泄e2（e2生e1）
            return is_generating(e2, e1);
        }

        // 计算身强身弱
        function calculateStrength(dayStem, elements, monthBranch, passedBranches = []) {
            // 确保输入是字符串
            dayStem = typeof dayStem === 'string' ? dayStem : String(dayStem);
            monthBranch = typeof monthBranch === 'string' ? monthBranch : String(monthBranch);
            
            // 获取第一个字符作为天干
            dayStem = dayStem.charAt(0);
            // 获取第二个字符作为地支
            monthBranch = monthBranch.length > 1 ? monthBranch.charAt(1) : monthBranch;
            
            const stemElementMap = {
                '甲': 'wood', '乙': 'wood',
                '丙': 'fire', '丁': 'fire',
                '戊': 'earth', '己': 'earth',
                '庚': 'metal', '辛': 'metal',
                '壬': 'water', '癸': 'water'
            };
            
            const dayElement = stemElementMap[dayStem];
            
            // 获取八字中的所有地支
            let allBranches = [];
            try {
                // 从四柱中获取地支
                const pillars = window.currentPillars || {};
                console.log('当前四柱信息:', pillars);
                
                if (pillars.year && pillars.year.length > 1) allBranches.push(pillars.year.charAt(1));
                if (pillars.month && pillars.month.length > 1) allBranches.push(pillars.month.charAt(1));
                if (pillars.day && pillars.day.length > 1) allBranches.push(pillars.day.charAt(1));
                if (pillars.hour && pillars.hour.length > 1) allBranches.push(pillars.hour.charAt(1));
                
                // 如果无法从currentPillars获取，尝试从eightChar获取
                if (allBranches.length === 0) {
                    console.log('尝试从eightChar获取地支');
                    const eightChar = window.eightChar || {};
                    if (eightChar.getYear && typeof eightChar.getYear === 'function') {
                        const year = eightChar.getYear();
                        if (year && year.length > 1) allBranches.push(year.charAt(1));
                    }
                    if (eightChar.getMonth && typeof eightChar.getMonth === 'function') {
                        const month = eightChar.getMonth();
                        if (month && month.length > 1) allBranches.push(month.charAt(1));
                    }
                    if (eightChar.getDay && typeof eightChar.getDay === 'function') {
                        const day = eightChar.getDay();
                        if (day && day.length > 1) allBranches.push(day.charAt(1));
                    }
                    if (eightChar.getTime && typeof eightChar.getTime === 'function') {
                        const time = eightChar.getTime();
                        if (time && time.length > 1) allBranches.push(time.charAt(1));
                    }
                }
            } catch (e) {
                console.error('获取八字地支失败:', e);
            }
            
            // 如果无法从页面获取，则使用传入的月支
            if (allBranches.length === 0 && monthBranch) {
                console.log('使用传入的月支:', monthBranch);
                allBranches.push(monthBranch);
            }
            
            // 打印调试信息
            console.log('八字地支:', allBranches);
            
            // 将地支数组保存到window对象，供其他函数使用
            window.allBranches = allBranches;
            
            // 检查合化情况
            const combined = checkCombinations(dayStem, monthBranch, passedBranches);

            // 保存日主天干到combined对象，供getMonthStrength使用
            combined.dayStem = dayStem;
            
            // 计算月令得分 (权重40%)
            let monthScore = getMonthStrength(dayElement, monthBranch, combined);
            
            console.log(`月令得分计算 - 日主:${dayStem}(${dayElement}), 月支:${monthBranch}, 得分:${monthScore}`);
            
            // 计算生扶力量（生我、助我）
            const supportElements = getSupportElements(dayElement);
            let supportStrength = 0;
            supportElements.forEach(element => {
                supportStrength += elements[element];
            });
            
            // 计算克泄力量（克我、泄我、耗我）
            const weakenElements = getWeakenElements(dayElement);
            let weakenStrength = 0;
            weakenElements.forEach(element => {
                weakenStrength += elements[element];
            });
            
            // 统一处理所有合化的加减分
            let combinationSupportStrength = 0; // 合化增强的力量
            let combinationWeakenStrength = 0;  // 合化削弱的力量
            const combinationTypes = ['tianGanWuHe', 'diZhiLiuHe', 'diZhiSanHe', 'diZhiSanHui'];
            combinationTypes.forEach(type => {
                if (!combined[type]) return; // 如果该类型不存在，跳过
                combined[type].forEach(comb => {
                    const heElement = comb.element;
                    // 专业命理评分规则 - 按照传统命理重要性排序
                    const SCORE_RULES = {
                        'diZhiSanHui': 8,  // 三会局8分（能量最强）
                        'diZhiSanHe': 6,   // 三合局6分
                        'diZhiLiuHe': 3,   // 六合局3分
                        'tianGanWuHe': 2   // 天干合2分（需通根验证）
                    };
                    let multiplier = SCORE_RULES[type];

                    // 天干合化专业规则检查
                    if(type === 'tianGanWuHe') {
                        // 检查是否为绊合（只合不化）
                        if (comb.onlyBind) {
                            // 绊合：双方力量减弱但性质不变，减少原有力量
                            const bindReduction = 1; // 绊合减少1分力量
                            
                            // 从原有五行力量中扣除
                            const stem1Element = stemElementMap[comb.gan1];
                            const stem2Element = stemElementMap[comb.gan2];
                            
                            if (getSupportElements(dayElement).includes(stem1Element)) {
                                supportStrength -= bindReduction * 0.5;
                                console.log(`天干绊合 ${comb.gan1}${comb.gan2} 减弱生扶力量 ${bindReduction * 0.5}`);
                            } else if (getWeakenElements(dayElement).includes(stem1Element)) {
                                weakenStrength -= bindReduction * 0.5;
                                console.log(`天干绊合 ${comb.gan1}${comb.gan2} 减弱克泄力量 ${bindReduction * 0.5}`);
                            }
                            
                            if (getSupportElements(dayElement).includes(stem2Element)) {
                                supportStrength -= bindReduction * 0.5;
                            } else if (getWeakenElements(dayElement).includes(stem2Element)) {
                                weakenStrength -= bindReduction * 0.5;
                            }
                            
                            console.log(`天干${comb.gan1}${comb.gan2}绊合：${comb.bindReason}，双方力量减弱`);
                            return; // 绊合不产生新的五行力量
                        }
                        
                        // 合化成功：按新的五行性质计算
                        console.log(`天干${comb.gan1}${comb.gan2}合化${heElement}成功：${comb.supportType}`);
                    }

                    // 地支合化天干透出检查 - 如果天干透出合化后的五行，能量加倍
                    if((type === 'diZhiLiuHe' || type === 'diZhiSanHe' || type === 'diZhiSanHui') && comb.hasTransparent) {
                        multiplier *= 1.5; // 透出时能量增加50%
                        console.log(`${type} 天干透出${heElement}，能量增强至 ${multiplier}`);
                    }

                    if (getSupportElements(dayElement).includes(heElement)) {
                        supportStrength += multiplier;
                        combinationSupportStrength += multiplier;
                        console.log(`${type} ${comb.gan1 || comb.zhi1 || comb.type || comb.branches} 合化${heElement} 生助日主，增加生扶 ${multiplier}`);
                    } else if (getWeakenElements(dayElement).includes(heElement)) {
                        weakenStrength += multiplier;
                        combinationWeakenStrength += multiplier;
                        console.log(`${type} ${comb.gan1 || comb.zhi1 || comb.type || comb.branches} 合化${heElement} 克泄日主，增加克泄 ${multiplier}`);
                    } else {
                        console.log(`${type} ${comb.gan1 || comb.zhi1 || comb.type || comb.branches} 合化${heElement} 中性影响`);
                    }
                });
            });
            
            // 计算合化的净影响
            const netCombinationEffect = combinationSupportStrength - combinationWeakenStrength;
            combined.deduction = netCombinationEffect;
            
            // 设置整体effect
            if (netCombinationEffect > 0) {
                combined.effect = 'strengthen';
            } else if (netCombinationEffect < 0) {
                combined.effect = 'weaken';
            } else {
                combined.effect = 'neutral';
            }
            
            // 确保合化信息显示在界面上
            window.combinedInfo = combined;
            
            // 移除通用effect调整，已在具体合化中处理
            
            // 三合加减已在统一处理中完成，保留特别处理
            if (combined.hasOwnProperty('sanhe')) {
                if (combined.sanhe.type === '巳酉丑' && dayStem === '己') {
                    weakenStrength += 3;
                    console.log('巳酉丑三合金对己土日主的特殊影响，额外增加克泄力量 3');
                }
            }
            
            // 计算总分
            const totalScore = monthScore + supportStrength - weakenStrength;
            
            // 判断身强身弱
            const strengthRatio = supportStrength / (supportStrength + weakenStrength);
            
            // 打印调试信息
            console.log(`身强身弱计算 - 日主:${dayStem}(${dayElement}), 生扶力量:${supportStrength}, 克泄力量:${weakenStrength}, 比例:${(strengthRatio * 100).toFixed(2)}%, 月令得分:${monthScore}`);
            
            let type, description;
            
            // 判断是否从格
            const isFollowing = checkFollowingPattern(dayElement, monthBranch, strengthRatio, supportStrength, weakenStrength, monthScore);
            
            if (isFollowing.isFollowing) {
                type = isFollowing.type;
                description = isFollowing.description;
            } else if (strengthRatio >= 0.60) { // 调整阈值，使身强判断更准确
                type = '身强';
                description = '日主力量强旺，能够承担财官，适合主动出击，喜用财官。';
            } else if (strengthRatio >= 0.40 && strengthRatio < 0.60) { // 调整均衡范围
                type = '均衡';
                description = '日主力量适中，五行较为平衡，运势平稳，喜用印比。';
            } else {
                type = '身弱';
                description = '日主力量偏弱，需要生扶，宜守不宜攻，喜用印比。';
            }
            
            return {
                type: type,
                ratio: strengthRatio,
                supportStrength: supportStrength,
                weakenStrength: weakenStrength,
                description: description,
                monthScore: monthScore,
                totalScore: totalScore,
                combined: combined
            };
        }
        
        // 检查合化情况
        function checkCombinations(dayStem, monthBranch, branches) {
            const combined = {
                tianGanWuHe: [],
                diZhiLiuHe: [],
                diZhiSanHe: [],
                deduction: 0 // 合化扣分
            };
            
            const stemElementMap = {
                '甲': 'wood', '乙': 'wood',
                '丙': 'fire', '丁': 'fire',
                '戊': 'earth', '己': 'earth',
                '庚': 'metal', '辛': 'metal',
                '壬': 'water', '癸': 'water'
            };
            
            // 天干五合规则
            const tianGanHeHua = {
                '甲己': 'earth',
                '乙庚': 'metal',
                '丙辛': 'water',
                '丁壬': 'wood',
                '戊癸': 'fire'
            };
            
            // 地支六合规则
            const diZhiLiuHe = {
                '子丑': 'earth',
                '寅亥': 'wood',
                '卯戌': 'fire',
                '辰酉': 'metal',
                '巳申': 'water',
                '午未': 'earth'
            };
            
            // 地支三合规则
            const diZhiSanHe = [
                {branches: ['申', '子', '辰'], element: 'water'}, // 三合水局
                {branches: ['亥', '卯', '未'], element: 'wood'},  // 三合木局
                {branches: ['寅', '午', '戌'], element: 'fire'},  // 三合火局
                {branches: ['巳', '酉', '丑'], element: 'metal'}  // 三合金局
            ];
            
            // 获取八字四柱
            let allStems = [];
            let allBranches = [];
            
            try {
                const pillars = window.currentPillars || {};
                if (pillars.year) {
                    allStems.push(pillars.year.charAt(0));
                    allBranches.push(pillars.year.charAt(1));
                }
                if (pillars.month) {
                    allStems.push(pillars.month.charAt(0));
                    allBranches.push(pillars.month.charAt(1));
                }
                if (pillars.day) {
                    allStems.push(pillars.day.charAt(0));
                    allBranches.push(pillars.day.charAt(1));
                }
                if (pillars.hour) {
                    allStems.push(pillars.hour.charAt(0));
                    allBranches.push(pillars.hour.charAt(1));
                }
            } catch (e) {
                console.error('获取八字信息失败:', e);
            }
            
            // 检查天干是否透出指定五行的辅助函数
            function checkTransparentElement(element, stems) {
                const elementToStems = {
                    'wood': ['甲', '乙'],
                    'fire': ['丙', '丁'],
                    'earth': ['戊', '己'],
                    'metal': ['庚', '辛'],
                    'water': ['壬', '癸']
                };
                
                const targetStems = elementToStems[element] || [];
                return stems.some(stem => targetStems.includes(stem));
            }
            
            // 检查地支是否支持天干合化的专业函数
            function checkHehuaSupport(hehuaElement, allBranches, monthBranch) {
                // 定义各五行对应的强根地支
                const elementStrongRoots = {
                    'earth': ['辰', '戌', '丑', '未'], // 土的强根
                    'metal': ['申', '酉', '戌', '丑'], // 金的强根
                    'water': ['亥', '子', '丑', '辰'], // 水的强根
                    'wood': ['寅', '卯', '辰', '未'], // 木的强根
                    'fire': ['巳', '午', '未', '戌']  // 火的强根
                };
                
                // 定义月令旺衰影响
                const monthElementMap = {
                    '子': 'water', '丑': 'earth', '寅': 'wood', '卯': 'wood',
                    '辰': 'earth', '巳': 'fire', '午': 'fire', '未': 'earth',
                    '申': 'metal', '酉': 'metal', '戌': 'earth', '亥': 'water'
                };
                
                const strongRoots = elementStrongRoots[hehuaElement] || [];
                const monthElement = monthElementMap[monthBranch];
                
                // 检查地支中是否有强根支撑
                const hasStrongRoot = allBranches.some(branch => strongRoots.includes(branch));
                
                // 检查月令是否有利于合化
                const monthSupport = monthElement === hehuaElement;
                const monthOppose = getOpposingElement(hehuaElement) === monthElement;
                
                // 合化成功的条件判断
                if (hasStrongRoot && monthSupport) {
                    return {
                        canHehua: true,
                        type: '地支强根+月令旺',
                        details: `地支有${strongRoots.filter(root => allBranches.includes(root)).join('、')}强根，月令${monthBranch}助旺${getElementChinese(hehuaElement)}`
                    };
                } else if (hasStrongRoot && !monthOppose) {
                    return {
                        canHehua: true,
                        type: '地支强根支撑',
                        details: `地支有${strongRoots.filter(root => allBranches.includes(root)).join('、')}强根支撑${getElementChinese(hehuaElement)}`
                    };
                } else if (monthSupport && allBranches.filter(branch => strongRoots.includes(branch)).length >= 2) {
                    return {
                        canHehua: true,
                        type: '月令旺+多重根',
                        details: `月令${monthBranch}旺${getElementChinese(hehuaElement)}，地支多重根气支撑`
                    };
                } else {
                    let reason = '';
                    if (!hasStrongRoot) {
                        reason += `地支无${getElementChinese(hehuaElement)}强根`;
                    }
                    if (monthOppose) {
                        reason += (reason ? '，' : '') + `月令${monthBranch}克制${getElementChinese(hehuaElement)}`;
                    }
                    if (!monthSupport && !hasStrongRoot) {
                        reason = `地支无强根且月令不助`;
                    }
                    
                    return {
                        canHehua: false,
                        reason: reason || '条件不足'
                    };
                }
            }
            
            // 获取五行中文名称
            function getElementChinese(element) {
                const elementNames = {
                    'wood': '木', 'fire': '火', 'earth': '土', 'metal': '金', 'water': '水'
                };
                return elementNames[element] || element;
            }
            
            // 获取相克的五行
            function getOpposingElement(element) {
                const opposingMap = {
                    'wood': 'metal',  // 金克木
                    'fire': 'water',  // 水克火
                    'earth': 'wood',  // 木克土
                    'metal': 'fire',  // 火克金
                    'water': 'earth'  // 土克水
                };
                return opposingMap[element];
            }
            
            // 检查争合和妒合情况
            const hehuaConflicts = new Map(); // 记录每个天干的合化对象
            const stemCounts = {}; // 统计每个天干出现次数
            
            // 统计天干出现次数（用于检查妒合）
            allStems.forEach(stem => {
                stemCounts[stem] = (stemCounts[stem] || 0) + 1;
            });
            
            // 检查相邻天干五合（按照专业规则：位置相邻且地支支持）
            for (let i = 0; i < allStems.length - 1; i++) {
                const stem1 = allStems[i];
                const stem2 = allStems[i + 1];
                const pair1 = stem1 + stem2;
                const pair2 = stem2 + stem1;
                
                if (tianGanHeHua[pair1] || tianGanHeHua[pair2]) {
                    const hehuaElement = tianGanHeHua[pair1] || tianGanHeHua[pair2];
                    
                    // 检查争合和妒合
                    let hasConflict = false;
                    let conflictType = '';
                    
                    // 检查争合：一天干与相邻两天干相合
                    if (hehuaConflicts.has(stem1)) {
                        hasConflict = true;
                        conflictType = `争合：${stem1}同时与${hehuaConflicts.get(stem1)}和${stem2}相合`;
                    }
                    if (hehuaConflicts.has(stem2)) {
                        hasConflict = true;
                        conflictType = `争合：${stem2}同时与${hehuaConflicts.get(stem2)}和${stem1}相合`;
                    }
                    
                    // 检查妒合：两相同天干争合一天干
                    if (stemCounts[stem1] > 1 || stemCounts[stem2] > 1) {
                        hasConflict = true;
                        const repeatStem = stemCounts[stem1] > 1 ? stem1 : stem2;
                        conflictType = `妒合：${repeatStem}重复出现${stemCounts[repeatStem]}次争合`;
                    }
                    
                    // 记录合化关系
                    hehuaConflicts.set(stem1, stem2);
                    hehuaConflicts.set(stem2, stem1);
                    
                    // 检查地支是否支持合化
                    const isSupported = checkHehuaSupport(hehuaElement, allBranches, monthBranch);
                    
                    // 如果有争合或妒合，合化力量分散，降低成功率
                    let finalCanHehua = isSupported.canHehua;
                    let finalReason = isSupported.reason;
                    
                    if (hasConflict && finalCanHehua) {
                        finalCanHehua = false;
                        finalReason = conflictType + '，合化力量分散';
                    }
                    
                    if (finalCanHehua) {
                        combined.tianGanWuHe.push({
                            gan1: stem1,
                            gan2: stem2,
                            element: hehuaElement,
                            positions: [i, i + 1],
                            isAdjacent: true,
                            supportType: isSupported.type,
                            supportDetails: isSupported.details,
                            hasConflict: hasConflict,
                            conflictType: hasConflict ? conflictType : null
                        });
                        console.log(`发现相邻天干五合: ${stem1}${stem2} 合化为${hehuaElement}（${isSupported.type}）${hasConflict ? ' - ' + conflictType : ''}`);
                    } else {
                        // 只合不化，作为绊合处理
                        combined.tianGanWuHe.push({
                            gan1: stem1,
                            gan2: stem2,
                            element: hehuaElement,
                            positions: [i, i + 1],
                            isAdjacent: true,
                            onlyBind: true,
                            bindReason: finalReason,
                            hasConflict: hasConflict,
                            conflictType: hasConflict ? conflictType : null
                        });
                        console.log(`发现相邻天干绊合: ${stem1}${stem2} 只合不化（${finalReason}）`);
                    }
                }
            }
            
            // 检查相邻地支六合
            for (let i = 0; i < allBranches.length - 1; i++) {
                const branch1 = allBranches[i];
                const branch2 = allBranches[i+1];
                const pair1 = branch1 + branch2;
                const pair2 = branch2 + branch1;
                
                if (diZhiLiuHe[pair1] || diZhiLiuHe[pair2]) {
                    const hehuaElement = diZhiLiuHe[pair1] || diZhiLiuHe[pair2];
                    // 检查天干是否透出合化后的五行
                    const hasTransparent = checkTransparentElement(hehuaElement, allStems);
                    combined.diZhiLiuHe.push({
                        zhi1: branch1,
                        zhi2: branch2,
                        element: hehuaElement,
                        positions: [i, i+1],
                        hasTransparent: hasTransparent
                    });
                    console.log(`发现相邻地支六合: ${branch1}${branch2} 合化为${hehuaElement}${hasTransparent ? '（天干透出）' : ''}`);
                }
            }
            
            // 保存地支数组供三合检测使用
            window.allBranches = allBranches;
            
            const elementMap = {
                'wood': '木',
                'fire': '火',
                'earth': '土',
                'metal': '金',
                'water': '水'
            };
            
            // 检查连续地支三合（只检查全三合，连续三个位置的地支set匹配）
            if (allBranches && allBranches.length >= 3) {
                console.log('检查连续三合局，地支:', allBranches);
                
                let bestMatch = null;
                
                let sanheStartIndex = -1;
                for (let i = 0; i <= allBranches.length - 3; i++) {
                    const trio = allBranches.slice(i, i+3).sort().join('');
                    for (const sanhe of diZhiSanHe) {
                        const sanheSorted = sanhe.branches.sort().join('');
                        if (trio === sanheSorted) {
                            // 检查天干是否透出合化后的五行
                            const hasTransparent = checkTransparentElement(sanhe.element, allStems);
                            bestMatch = {
                                type: sanhe.branches.join(''),
                                element: sanhe.element,
                                count: 3,
                                branches: allBranches.slice(i, i+3).join(''),
                                isFullSanhe: true,
                                hasTransparent: hasTransparent,
                                startIndex: i
                            };
                            sanheStartIndex = i;
                            combined.diZhiSanHe.push(bestMatch);
                            console.log(`发现连续全三合局: ${bestMatch.branches} 合化为${sanhe.element}${hasTransparent ? '（天干透出）' : ''}`);
                            break;
                        }
                    }
                    if (bestMatch) break; // 只记录一个最佳
                }
                
                if (bestMatch && sanheStartIndex >= 0) {
                    combined.sanhe = bestMatch;
                    
                    // 三合局优先级处理：移除与三合局地支重叠的六合
                    const sanhePositions = [sanheStartIndex, sanheStartIndex+1, sanheStartIndex+2]; // 三合局的位置
                    combined.diZhiLiuHe = combined.diZhiLiuHe.filter(liuhe => {
                        // 检查六合的位置是否与三合局重叠
                        const hasOverlap = liuhe.positions.some(pos => sanhePositions.includes(pos));
                        if (hasOverlap) {
                            console.log(`三合局优先：移除与三合局重叠的六合 ${liuhe.zhi1}${liuhe.zhi2}`);
                            return false;
                        }
                        return true;
                    });
                }
            }
            
            // 检查地支三会局
            const diZhiSanHui = [
                {branches: ['寅', '卯', '辰'], element: 'wood'},  // 东方三会木局
                {branches: ['巳', '午', '未'], element: 'fire'},  // 南方三会火局
                {branches: ['申', '酉', '戌'], element: 'metal'}, // 西方三会金局
                {branches: ['亥', '子', '丑'], element: 'water'}  // 北方三会水局
            ];
            
            combined.diZhiSanHui = [];
            if (allBranches && allBranches.length >= 3) {
                console.log('检查三会局，地支:', allBranches);
                
                for (let i = 0; i <= allBranches.length - 3; i++) {
                    const trio = allBranches.slice(i, i+3).sort().join('');
                    for (const sanhui of diZhiSanHui) {
                        const sanhuiSorted = sanhui.branches.sort().join('');
                        if (trio === sanhuiSorted) {
                            // 检查天干是否透出合化后的五行
                            const hasTransparent = checkTransparentElement(sanhui.element, allStems);
                            const sanhuiMatch = {
                                type: sanhui.branches.join(''),
                                element: sanhui.element,
                                count: 3,
                                branches: allBranches.slice(i, i+3).join(''),
                                isFullSanHui: true,
                                hasTransparent: hasTransparent
                            };
                            combined.diZhiSanHui.push(sanhuiMatch);
                            console.log(`发现连续全三会局: ${sanhuiMatch.branches} 会化为${sanhui.element}${hasTransparent ? '（天干透出）' : ''}`);
                            break;
                        }
                    }
                }
            }
            
            // 移除半三合和特别检查，只全连续三合
            
            // 简化的合化判断
            const dayElement = stemElementMap[dayStem];
            
            // 判断合化是否有利于日主
            if (dayElement && !combined.effect) {
                // 检查所有合化的影响
                let hasStrengthening = false;
                let hasWeakening = false;
                
                // 检查天干五合
                combined.tianGanWuHe.forEach(comb => {
                    if (comb.onlyBind) {
                        // 绊合对日主的影响较小，主要是减弱双方力量
                        console.log(`天干五合 ${comb.gan1}${comb.gan2} 绊合（${comb.bindReason}），双方力量减弱`);
                    } else {
                        // 合化成功按新的五行性质判断
                        if (getSupportElements(dayElement).includes(comb.element)) {
                            hasStrengthening = true;
                            console.log(`天干五合 ${comb.gan1}${comb.gan2} 合化${comb.element}成功（${comb.supportType}）生助日主`);
                        } else if (getWeakenElements(dayElement).includes(comb.element)) {
                            hasWeakening = true;
                            console.log(`天干五合 ${comb.gan1}${comb.gan2} 合化${comb.element}成功（${comb.supportType}）克泄日主`);
                        }
                    }
                });
                
                // 检查地支六合
                combined.diZhiLiuHe.forEach(comb => {
                    if (getSupportElements(dayElement).includes(comb.element)) {
                        hasStrengthening = true;
                        console.log(`地支六合 ${comb.zhi1}${comb.zhi2} 合化${comb.element} 生助日主`);
                    } else if (getWeakenElements(dayElement).includes(comb.element)) {
                        hasWeakening = true;
                        console.log(`地支六合 ${comb.zhi1}${comb.zhi2} 合化${comb.element} 克泄日主`);
                    }
                });
                
                // 检查地支三合
                combined.diZhiSanHe.forEach(comb => {
                    if (getSupportElements(dayElement).includes(comb.element)) {
                        hasStrengthening = true;
                        console.log(`地支三合 ${comb.type || comb.branches} 合化${comb.element} 生助日主`);
                    } else if (getWeakenElements(dayElement).includes(comb.element)) {
                        hasWeakening = true;
                        console.log(`地支三合 ${comb.type || comb.branches} 合化${comb.element} 克泄日主`);
                    }
                });
                
                // 设置最终影响
                if (hasStrengthening && !hasWeakening) {
                    combined.effect = 'strengthen';
                    console.log('合化总体对日主影响: 增强');
                } else if (hasWeakening && !hasStrengthening) {
                    combined.effect = 'weaken';
                    console.log('合化总体对日主影响: 削弱');
                } else if (hasStrengthening && hasWeakening) {
                    combined.effect = 'mixed';
                    console.log('合化总体对日主影响: 混合');
                } else {
                    combined.effect = 'neutral';
                    console.log('合化总体对日主影响: 中性');
                }
            }
            
            return combined;
        }
        
        // 获取月令强度
        function getMonthStrength(dayElement, monthBranch, combined) {
            console.log(`getMonthStrength调试 - dayElement: ${dayElement}, monthBranch: ${monthBranch}`);
            
            const branchElementMap = {
                '子': 'water', '丑': 'earth',
                '寅': 'wood', '卯': 'wood',
                '辰': 'earth', '巳': 'fire',
                '午': 'fire', '未': 'earth',
                '申': 'metal', '酉': 'metal',
                '戌': 'earth', '亥': 'water'
            };
            
            // 地支藏干映射
            const BRANCH_ELEMENTS = {
                '子': {main: 'water', hidden: ['癸']},
                '丑': {main: 'earth', hidden: ['己', '癸', '辛']},
                '寅': {main: 'wood', hidden: ['甲', '丙', '戊']},
                '卯': {main: 'wood', hidden: ['乙']},
                '辰': {main: 'earth', hidden: ['戊', '乙', '癸']},
                '巳': {main: 'fire', hidden: ['丙', '庚', '戊']},
                '午': {main: 'fire', hidden: ['丁', '己']},
                '未': {main: 'earth', hidden: ['己', '丁', '乙']},
                '申': {main: 'metal', hidden: ['庚', '壬', '戊']},
                '酉': {main: 'metal', hidden: ['辛']},
                '戌': {main: 'earth', hidden: ['戊', '辛', '丁']},
                '亥': {main: 'water', hidden: ['壬', '甲']}
            };
            
            // 如果月支被合化，使用合化后的元素
            let monthElement = combined.hasOwnProperty('monthElement') ? 
                combined.monthElement : branchElementMap[monthBranch];
            
            console.log(`月令元素初始值: ${monthElement}`);
            
            // 注意：三合局不应该改变月令的基本五行属性
            // 三合局的影响在合化计算中单独处理
            // 月令得分应该基于月支本身的五行
            
            console.log(`最终月令元素: ${monthElement}`);
            
            if (!monthElement) return 0; // 如果无法确定月令元素，返回0
            
            // 获取生扶和克泄元素列表
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            // 特别处理巳酉丑三合金对己土日主的影响
            if (combined.hasOwnProperty('sanhe') && 
                combined.sanhe.type === '巳酉丑' && 
                dayElement === 'earth') {
                console.log('特别处理：巳酉丑三合金对己土日主的影响，月令得分 -30');
                return -30; // 三合金对土的克制更强
            }
            
            let score = 0;
            
            if (monthElement === dayElement) {
                score = 40;  // 得令
                console.log(`月令得分：${score} (得令，月令五行与日主相同)`);
            } else if (supportElements.includes(monthElement)) {
                score = 20;  // 得生
                console.log(`月令得分：${score} (得生，月令五行生扶日主)`);
            } else if (weakenElements.includes(monthElement)) {
                score = -20; // 被克
                console.log(`月令得分：${score} (被克，月令五行克泄日主)`);
            } else {
                score = 0;   // 不得令
                console.log(`月令得分：${score} (不得令，月令五行与日主无关)`);
            }
            
            // 考虑特殊情况：戊己土日主在子月、辰月、戌月的特殊表现
            if ((dayElement === 'earth') && (['子', '辰', '戌'].includes(monthBranch))) {
                // 戊土在子月、辰月、戌月偏强
                if (combined.dayStem === '戊') {
                    score += 10;
                    console.log(`特殊情况：戊土在${monthBranch}月偏强，月令得分调整为 ${score}`);
                }
            }
            
            return score;
        }
        
        // 检查是否从格
        function checkFollowingPattern(dayElement, monthBranch, strengthRatio, supportStrength, weakenStrength, monthScore) {
            // 从弱格判断：生扶力量小于等于5且克泄力量大于等于15（不包含月令负分）
            if (supportStrength <= 5 && weakenStrength >= 15) {
                console.log(`从弱格判断: 生扶力量${supportStrength} <= 5, 克泄力量${weakenStrength} >= 15`);
                return {
                    isFollowing: true,
                    type: '从弱',
                    description: '日主极弱，生扶力量不足，命局以克泄日主的五行为用神，顺势而为，喜用财官。'
                };
            }
            const branchElementMap = {
                '子': 'water', '丑': 'earth',
                '寅': 'wood', '卯': 'wood',
                '辰': 'earth', '巳': 'fire',
                '午': 'fire', '未': 'earth',
                '申': 'metal', '酉': 'metal',
                '戌': 'earth', '亥': 'water'
            };
            
            const monthElement = branchElementMap[monthBranch];
            if (!monthElement) return { isFollowing: false };
            
            // 获取生扶和克泄元素列表
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            // 从弱格：生扶力量小于等于5且克泄力量大于等于15
            if (supportStrength <= 5 && weakenStrength >= 15) {
                console.log(`从弱格判断: 生扶力量${supportStrength} <= 5, 克泄力量${weakenStrength} >= 15`);
                return {
                    isFollowing: true,
                    type: '从弱',
                    description: '日主极弱，生扶力量不足，命局以克泄日主的五行为用神，顺势而为，喜用财官。'
                };
            }
            
            // 传统从弱格判断（作为备用）
            if (strengthRatio < 0.3 && weakenElements.includes(monthElement)) {
                console.log(`传统从弱格判断: 比例${(strengthRatio * 100).toFixed(2)}% < 30%, 月令克泄日主`);
                return {
                    isFollowing: true,
                    type: '从弱',
                    description: '日主偏弱，但命局以克泄日主的五行为用神，顺势而为，喜用财官。'
                };
            }
            
            // 从强格：身强而用生扶
            if (strengthRatio > 0.7 && supportElements.includes(monthElement)) {
                console.log(`从强格判断: 比例${(strengthRatio * 100).toFixed(2)}% > 70%, 月令生扶日主`);
                return {
                    isFollowing: true,
                    type: '从强',
                    description: '日主偏强，但命局以生扶日主的五行为用神，顺势而为，喜用印比。'
                };
            }
            
            return { isFollowing: false };
        }

        // 获取生扶五行
        function getSupportElements(element) {
            const supportMap = {
                'wood': ['water', 'wood'],
                'fire': ['wood', 'fire'],
                'earth': ['fire', 'earth'],
                'metal': ['earth', 'metal'],
                'water': ['metal', 'water']
            };
            return supportMap[element] || [];
        }

        // 获取克泄五行
        function getWeakenElements(element) {
            const weakenMap = {
                'wood': ['metal', 'fire', 'earth'],
                'fire': ['water', 'earth', 'metal'],
                'earth': ['wood', 'metal', 'water'],
                'metal': ['fire', 'water', 'wood'],
                'water': ['earth', 'wood', 'fire']
            };
            return weakenMap[element] || [];
        }

        // 根据传统命理规则计算大运序列
        function calculateDayunSequence(monthGanZhi, isForward, startAge) {
            // 六十甲子表
            const jiaZi = [
                '甲子', '乙丑', '丙寅', '丁卯', '戊辰', '己巳', '庚午', '辛未', '壬申', '癸酉',
                '甲戌', '乙亥', '丙子', '丁丑', '戊寅', '己卯', '庚辰', '辛巳', '壬午', '癸未',
                '甲申', '乙酉', '丙戌', '丁亥', '戊子', '己丑', '庚寅', '辛卯', '壬辰', '癸巳',
                '甲午', '乙未', '丙申', '丁酉', '戊戌', '己亥', '庚子', '辛丑', '壬寅', '癸卯',
                '甲辰', '乙巳', '丙午', '丁未', '戊申', '己酉', '庚戌', '辛亥', '壬子', '癸丑',
                '甲寅', '乙卯', '丙辰', '丁巳', '戊午', '己未', '庚申', '辛酉', '壬戌', '癸亥'
            ];
            
            // 找到月柱在六十甲子中的位置
            const monthIndex = jiaZi.indexOf(monthGanZhi);
            if (monthIndex === -1) {
                console.error('无法找到月柱:', monthGanZhi);
                return [];
            }
            
            const dayunList = [];
            
            for (let i = 0; i < 10; i++) {
                let dayunIndex;
                if (isForward) {
                    // 顺排：月柱后一位开始
                    dayunIndex = (monthIndex + i + 1) % 60;
                } else {
                    // 逆排：月柱前一位开始
                    dayunIndex = (monthIndex - i - 1 + 60) % 60;
                }
                
                const dayunGanZhi = jiaZi[dayunIndex];
                const dayunStartAge = startAge + i * 10;
                const dayunEndAge = dayunStartAge + 9;
                
                dayunList.push({
                    ganZhi: dayunGanZhi,
                    startAge: dayunStartAge,
                    endAge: dayunEndAge,
                    index: i + 1
                });
            }
            
            return dayunList;
        }

        // 获取当前大运信息
        function getCurrentDayun() {
            try {
                const today = new Date();
                const currentYear = today.getFullYear();
                
                console.log('getCurrentDayun调试信息:');
                console.log('window.eightChar存在:', !!window.eightChar);
                
                // 从八字信息获取基本信息
                const eightChar = window.eightChar;
                if (eightChar && window.currentBaziData && window.currentBaziData.luckTiming) {
                    // 获取起运信息
                    const luckTiming = window.currentBaziData.luckTiming;
                    const isForward = luckTiming.direction === '顺排';
                    const startAge = luckTiming.age;
                    
                    // 获取月柱干支
                    const monthGanZhi = eightChar.getMonth();
                    
                    console.log('月柱干支:', monthGanZhi);
                    console.log('起运方向:', luckTiming.direction);
                    console.log('起运年龄:', startAge);
                    
                    // 计算大运序列
                    const dayunList = calculateDayunSequence(monthGanZhi, isForward, startAge);
                    
                    // 计算当前年龄（虚岁）
                    const birthYear = eightChar.getLunar().getSolar().getYear();
                    const currentAge = currentYear - birthYear + 1; // 使用虚岁计算
                    
                    console.log('出生年份:', birthYear, '当前年份:', currentYear, '当前年龄:', currentAge);
                    console.log('大运列表长度:', dayunList.length);
                    
                    // 打印所有大运
                    dayunList.forEach((dayun, index) => {
                        console.log(`第${index + 1}步大运: ${dayun.ganZhi}, 起始年龄: ${dayun.startAge}, 结束年龄: ${dayun.endAge}`);
                    });
                    
                    // 查找当前大运
                    for (const dayun of dayunList) {
                        if (currentAge >= dayun.startAge && currentAge <= dayun.endAge) {
                            console.log(`找到当前大运: ${dayun.ganZhi}`);
                            return {
                                ganZhi: dayun.ganZhi,
                                startAge: dayun.startAge,
                                endAge: dayun.endAge,
                                currentAge: currentAge
                            };
                        }
                    }
                    
                    console.log('未找到匹配的大运');
                } else {
                    console.log('缺少必要的八字信息或起运信息');
                }
                
                return {
                    ganZhi: '未知',
                    startAge: 0,
                    endAge: 0,
                    currentAge: 0
                };
            } catch (error) {
                console.error('获取当前大运失败:', error);
                return {
                    ganZhi: '计算错误',
                    startAge: 0,
                    endAge: 0,
                    currentAge: 0
                };
            }
        }

        // 获取指定年份的天干地支
        function getYearGanZhi(year) {
            // 天干地支数组（正确顺序）
            const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            // 以1984年甲子年为基准计算
            const baseYear = 1984;
            const yearDiff = year - baseYear;
            
            // 计算天干地支索引
            const ganIndex = (yearDiff % 10 + 10) % 10;
            const zhiIndex = (yearDiff % 12 + 12) % 12;
            
            return tianGan[ganIndex] + diZhi[zhiIndex];
        }

        // 十二长生状态表
        function getTwelveStagesTable() {
            return {
                '甲': { 长生: '亥', 沐浴: '子', 冠带: '丑', 临官: '寅', 帝旺: '卯', 衰: '辰', 病: '巳', 死: '午', 墓: '未', 绝: '申', 胎: '酉', 养: '戌' },
                '乙': { 长生: '午', 沐浴: '巳', 冠带: '辰', 临官: '卯', 帝旺: '寅', 衰: '丑', 病: '子', 死: '亥', 墓: '戌', 绝: '酉', 胎: '申', 养: '未' },
                '丙': { 长生: '寅', 沐浴: '卯', 冠带: '辰', 临官: '巳', 帝旺: '午', 衰: '未', 病: '申', 死: '酉', 墓: '戌', 绝: '亥', 胎: '子', 养: '丑' },
                '丁': { 长生: '酉', 沐浴: '申', 冠带: '未', 临官: '午', 帝旺: '巳', 衰: '辰', 病: '卯', 死: '寅', 墓: '丑', 绝: '子', 胎: '亥', 养: '戌' },
                '戊': { 长生: '寅', 沐浴: '卯', 冠带: '辰', 临官: '巳', 帝旺: '午', 衰: '未', 病: '申', 死: '酉', 墓: '戌', 绝: '亥', 胎: '子', 养: '丑' },
                '己': { 长生: '酉', 沐浴: '申', 冠带: '未', 临官: '午', 帝旺: '巳', 衰: '辰', 病: '卯', 死: '寅', 墓: '丑', 绝: '子', 胎: '亥', 养: '戌' },
                '庚': { 长生: '巳', 沐浴: '午', 冠带: '未', 临官: '申', 帝旺: '酉', 衰: '戌', 病: '亥', 死: '子', 墓: '丑', 绝: '寅', 胎: '卯', 养: '辰' },
                '辛': { 长生: '子', 沐浴: '亥', 冠带: '戌', 临官: '酉', 帝旺: '申', 衰: '未', 病: '午', 死: '巳', 墓: '辰', 绝: '卯', 胎: '寅', 养: '丑' },
                '壬': { 长生: '申', 沐浴: '酉', 冠带: '戌', 临官: '亥', 帝旺: '子', 衰: '丑', 病: '寅', 死: '卯', 墓: '辰', 绝: '巳', 胎: '午', 养: '未' },
                '癸': { 长生: '卯', 沐浴: '寅', 冠带: '丑', 临官: '子', 帝旺: '亥', 衰: '戌', 病: '酉', 死: '申', 墓: '未', 绝: '午', 胎: '巳', 养: '辰' }
            };
        }
        
        // 计算十二长生状态
        function calculateTwelveStages(dayStem, luckTiming, currentAge) {
            const stagesTable = getTwelveStagesTable();
            const dayStages = stagesTable[dayStem];
            
            if (!dayStages) {
                console.error('无法找到日主天干对应的十二长生表:', dayStem);
                return [];
            }
            
            // 生成大运列表
            const dayunList = generateDayunList(luckTiming);
            
            // 计算每个大运对应的十二长生状态
            const twelveStages = [];
            
            dayunList.forEach((dayun, index) => {
                const dayunZhi = dayun.ganZhi.charAt(1); // 获取大运地支
                
                // 查找该地支在十二长生中的状态
                let stageName = '未知';
                for (const [stage, zhi] of Object.entries(dayStages)) {
                    if (zhi === dayunZhi) {
                        stageName = stage;
                        break;
                    }
                }
                
                // 计算年龄范围
                const startAge = luckTiming.age + index * 10;
                const endAge = startAge + 9;
                
                // 获取状态描述和颜色
                const stageInfo = getStageInfo(stageName);
                
                twelveStages.push({
                    name: stageName,
                    dayun: dayun.ganZhi,
                    energy: stageInfo.energy,
                    color: stageInfo.color,
                    description: stageInfo.description,
                    ageRange: `${startAge}-${endAge}岁`,
                    isCurrent: currentAge >= startAge && currentAge <= endAge
                });
            });
            
            return twelveStages;
        }
        
        // 获取十二长生状态信息
        function getStageInfo(stageName) {
            const stageInfoMap = {
                '长生': { energy: '初生', color: '#4CAF50', description: '新生力量，充满希望与活力' },
                '沐浴': { energy: '洗礼', color: '#2196F3', description: '清洗净化，重新开始人生' },
                '冠带': { energy: '成长', color: '#FF9800', description: '逐渐成熟，展现才华能力' },
                '临官': { energy: '建功', color: '#9C27B0', description: '建功立业，权威地位显现' },
                '帝旺': { energy: '巅峰', color: '#F44336', description: '达到人生顶峰，威势最强' },
                '衰': { energy: '衰退', color: '#795548', description: '力量开始减弱，需要调整' },
                '病': { energy: '困顿', color: '#607D8B', description: '遇到阻碍困难，需要休养' },
                '死': { energy: '终结', color: '#424242', description: '旧事物结束，准备新的开始' },
                '墓': { energy: '收藏', color: '#9E9E9E', description: '收敛蓄积，等待时机' },
                '绝': { energy: '断绝', color: '#37474F', description: '彻底断绝，重新孕育' },
                '胎': { energy: '孕育', color: '#8BC34A', description: '新生命孕育，潜力萌发' },
                '养': { energy: '蓄养', color: '#CDDC39', description: '积蓄力量，培养根基' },
                '未知': { energy: '未知', color: '#9E9E9E', description: '状态未明，需要进一步分析' }
            };
            
            return stageInfoMap[stageName] || stageInfoMap['未知'];
        }
        
        // 生成大运列表
        function generateDayunList(luckTiming) {
            try {
                // 使用现有的calculateDayunSequence函数
                const eightChar = window.eightChar;
                if (!eightChar) {
                    console.error('无法获取八字信息');
                    return [];
                }
                
                // 获取月柱干支
                const monthGanZhi = eightChar.getMonth();
                const isForward = luckTiming.direction === '顺排';
                const startAge = luckTiming.age;
                
                // 计算大运序列
                const dayunSequence = calculateDayunSequence(monthGanZhi, isForward, startAge);
                
                // 转换为所需格式
                return dayunSequence.map(dayun => ({
                    ganZhi: dayun.ganZhi,
                    startAge: dayun.startAge,
                    endAge: dayun.endAge
                }));
            } catch (error) {
                console.error('生成大运列表失败:', error);
                // 返回默认的大运列表
                return [
                    { ganZhi: '甲子', startAge: 0, endAge: 9 },
                    { ganZhi: '乙丑', startAge: 10, endAge: 19 },
                    { ganZhi: '丙寅', startAge: 20, endAge: 29 },
                    { ganZhi: '丁卯', startAge: 30, endAge: 39 },
                    { ganZhi: '戊辰', startAge: 40, endAge: 49 },
                    { ganZhi: '己巳', startAge: 50, endAge: 59 },
                    { ganZhi: '庚午', startAge: 60, endAge: 69 },
                    { ganZhi: '辛未', startAge: 70, endAge: 79 }
                ];
            }
        }

        // 计算起运时间 - 根据正确的八字起运算法
        function calculateLuckTiming(gender, lunar, originalBirthDate) {
            try {
                // 直接使用原始的阳历出生日期，避免转换误差
                const birthDate = originalBirthDate;
                
                // 获取年柱天干
                const eightChar = lunar.getEightChar();
                const yearPillar = eightChar.getYear();
                const yearStr = typeof yearPillar === 'string' ? yearPillar : String(yearPillar);
                const yearGan = yearStr.charAt(0);
                
                console.log('起运计算调试信息:');
                console.log('性别:', gender);
                console.log('年柱:', yearStr);
                console.log('年干:', yearGan);
                
                // 1. 判断年柱阴阳与顺逆排
                const yangTianGan = ['甲', '丙', '戊', '庚', '壬'];
                const yinTianGan = ['乙', '丁', '己', '辛', '癸'];
                const isMale = gender === 'male';
                
                console.log('是否男性:', isMale);
                console.log('年干是否阳干:', yangTianGan.includes(yearGan));
                console.log('年干是否阴干:', yinTianGan.includes(yearGan));
                
                let direction;
                if ((yangTianGan.includes(yearGan) && isMale) || (yinTianGan.includes(yearGan) && !isMale)) {
                    direction = '顺排'; // 阳年男 or 阴年女
                } else {
                    direction = '逆排'; // 阴年男 or 阳年女
                }
                
                console.log('起运方向:', direction);
                
                // 2. 计算出生日到最近节气的天数差
                const daysDiff = getDaysToJieQi(birthDate, direction, birthDate.getFullYear());
                
                // 3. 起运年龄计算
                const years = Math.floor(daysDiff / 3); // 3天 = 1岁
                const months = Math.round((daysDiff / 3 - years) * 12); // 小数部分转月份
                
                return {
                    age: years,
                    months: months,
                    direction: direction,
                    daysDiff: daysDiff.toFixed(2),
                    description: `${direction}，${years}岁${months}个月起运`
                };
            } catch (error) {
                console.error('起运计算错误:', error);
                // 返回默认值
                return {
                    age: 8,
                    months: 0,
                    direction: '顺排',
                    daysDiff: '24.00',
                    description: '8岁0个月起运（默认值）'
                };
            }
        }
        
        // 计算出生日到最近节气的天数差
        function getDaysToJieQi(birthDate, direction, birthYear) {
            try {
                // 获取当年的节气表
                const solar = Solar.fromYmd(birthYear, 6, 1);
                const lunar = solar.getLunar();
                const jieQiTable = lunar.getJieQiTable();
                
                // 八字换月节气列表（用于起运计算）
                const monthlyJieQi = [
                    '立春', '惊蛰', '清明', '立夏', '芒种', '小暑',
                    '立秋', '白露', '寒露', '立冬', '大雪', '小寒'
                ];
                
                let targetJieQi = null;
                let minDiff = Infinity;
                
                // 检查当年和前后一年的节气
                for (let yearOffset = -1; yearOffset <= 1; yearOffset++) {
                    const checkYear = birthYear + yearOffset;
                    
                    for (const jieQiName of monthlyJieQi) {
                        const jieQiSolar = getJieQiTime(checkYear, jieQiName);
                        if (!jieQiSolar) continue;
                        
                        const jieQiDate = new Date(
                            jieQiSolar.getYear(),
                            jieQiSolar.getMonth() - 1,
                            jieQiSolar.getDay(),
                            jieQiSolar.getHour(),
                            jieQiSolar.getMinute(),
                            jieQiSolar.getSecond()
                        );
                        
                        const timeDiff = jieQiDate.getTime() - birthDate.getTime();
                        
                        if (direction === '顺排') {
                            // 找下一个节气
                            if (timeDiff > 0 && timeDiff < minDiff) {
                                minDiff = timeDiff;
                                targetJieQi = jieQiDate;
                            }
                        } else {
                            // 找上一个节气
                            if (timeDiff < 0 && Math.abs(timeDiff) < minDiff) {
                                minDiff = Math.abs(timeDiff);
                                targetJieQi = jieQiDate;
                            }
                        }
                    }
                }
                
                if (targetJieQi) {
                    const diffMs = Math.abs(targetJieQi.getTime() - birthDate.getTime());
                    return diffMs / (1000 * 60 * 60 * 24); // 转换为天数
                }
                
                // 如果找不到合适的节气，返回默认值
                return 24;
                
            } catch (error) {
                console.error('获取节气时间错误:', error);
                return 24; // 默认值
            }
        }
        
        // 获取指定年份的节气时间
        function getJieQiTime(year, jieQiName) {
            try {
                const solar = Solar.fromYmd(year, 6, 1);
                const lunar = solar.getLunar();
                const jieQiTable = lunar.getJieQiTable();
                
                return jieQiTable[jieQiName] || null;
            } catch (error) {
                console.error(`获取${year}年${jieQiName}节气时间失败:`, error);
                return null;
            }
        }

        // 计算当前身强身弱（加入大运和流年）
        function calculateCurrentStrength(dayStem, elements, monthBranch, currentYear) {
            try {
                // 获取当前流年干支
                const today = new Date();
                const currentLunar = Lunar.fromDate(today);
                const currentYearGanZhi = currentLunar.getYearInGanZhi();
                const currentYearStem = currentYearGanZhi.charAt(0);
                const currentYearBranch = currentYearGanZhi.charAt(1);
                
                // 获取当前大运信息
                let currentDayunStem = '';
                let currentDayunBranch = '';
                
                try {
                    // 使用getCurrentDayun函数获取当前大运信息，保持一致性
                    const currentDayunInfo = getCurrentDayun();
                    if (currentDayunInfo && currentDayunInfo.ganZhi && currentDayunInfo.ganZhi !== '未知' && currentDayunInfo.ganZhi !== '计算错误') {
                        currentDayunStem = currentDayunInfo.ganZhi.charAt(0);
                        currentDayunBranch = currentDayunInfo.ganZhi.charAt(1);
                    } else {
                        // 如果getCurrentDayun也失败，则不添加大运影响
                        console.log('无法获取当前大运信息，跳过大运影响计算');
                        currentDayunStem = '';
                        currentDayunBranch = '';
                    }
                } catch (e) {
                    console.log('获取大运信息失败:', e);
                    currentDayunStem = '';
                    currentDayunBranch = '';
                }
                
                console.log(`当前流年: ${currentYear}年${currentYearGanZhi}, 当前大运: ${currentDayunStem}${currentDayunBranch}`);
                
                // 复制原始五行分布
                const currentElements = { ...elements };
                
                // 获取天干地支对应的五行
                const stemElementMap = {
                    '甲': 'wood', '乙': 'wood',
                    '丙': 'fire', '丁': 'fire',
                    '戊': 'earth', '己': 'earth',
                    '庚': 'metal', '辛': 'metal',
                    '壬': 'water', '癸': 'water'
                };
                
                const branchElementMap = {
                    '子': 'water', '丑': 'earth', '寅': 'wood', '卯': 'wood',
                    '辰': 'earth', '巳': 'fire', '午': 'fire', '未': 'earth',
                    '申': 'metal', '酉': 'metal', '戌': 'earth', '亥': 'water'
                };
                
                // 地支藏干映射
                const BRANCH_ELEMENTS = {
                    '子': {main: 'water', hidden: ['癸']},
                    '丑': {main: 'earth', hidden: ['己', '癸', '辛']},
                    '寅': {main: 'wood', hidden: ['甲', '丙', '戊']},
                    '卯': {main: 'wood', hidden: ['乙']},
                    '辰': {main: 'earth', hidden: ['戊', '乙', '癸']},
                    '巳': {main: 'fire', hidden: ['丙', '庚', '戊']},
                    '午': {main: 'fire', hidden: ['丁', '己']},
                    '未': {main: 'earth', hidden: ['己', '丁', '乙']},
                    '申': {main: 'metal', hidden: ['庚', '壬', '戊']},
                    '酉': {main: 'metal', hidden: ['辛']},
                    '戌': {main: 'earth', hidden: ['戊', '辛', '丁']},
                    '亥': {main: 'water', hidden: ['壬', '甲']}
                };
                
                // 加入流年天干地支的五行力量
                const yearStemElement = stemElementMap[currentYearStem];
                const yearBranchElement = branchElementMap[currentYearBranch];
                
                if (yearStemElement) {
                    currentElements[yearStemElement] += 1.5; // 流年天干权重
                }
                if (yearBranchElement) {
                    currentElements[yearBranchElement] += 2.0; // 流年地支权重
                }
                
                // 加入大运天干地支的五行力量
                const dayunStemElement = stemElementMap[currentDayunStem];
                const dayunBranchElement = branchElementMap[currentDayunBranch];
                
                if (dayunStemElement) {
                    currentElements[dayunStemElement] += 1.2; // 大运天干权重
                }
                if (dayunBranchElement) {
                    currentElements[dayunBranchElement] += 1.8; // 大运地支权重
                }
                
                // 获取所有干支用于合化检查
                const allStems = [];
                const allBranches = [];
                
                // 原八字干支
                try {
                    const pillars = window.currentPillars || {};
                    if (pillars.year) {
                        allStems.push(pillars.year.charAt(0));
                        allBranches.push(pillars.year.charAt(1));
                    }
                    if (pillars.month) {
                        allStems.push(pillars.month.charAt(0));
                        allBranches.push(pillars.month.charAt(1));
                    }
                    if (pillars.day) {
                        allStems.push(pillars.day.charAt(0));
                        allBranches.push(pillars.day.charAt(1));
                    }
                    if (pillars.hour) {
                        allStems.push(pillars.hour.charAt(0));
                        allBranches.push(pillars.hour.charAt(1));
                    }
                } catch (e) {
                    console.error('获取八字信息失败:', e);
                }
                
                // 加入流年和大运干支
                allStems.push(currentYearStem, currentDayunStem);
                allBranches.push(currentYearBranch, currentDayunBranch);
                
                // 检查合化（流年和大运可以与任意八字干支合化）
                const currentCombined = checkCurrentCombinations(dayStem, allStems, allBranches, currentYearStem, currentYearBranch, currentDayunStem, currentDayunBranch);
                
                // 计算月令得分（保持不变）
                let monthScore = getMonthStrength(stemElementMap[dayStem], monthBranch, currentCombined);
                
                // 计算生扶和克泄力量
                const dayElement = stemElementMap[dayStem];
                const supportElements = getSupportElements(dayElement);
                const weakenElements = getWeakenElements(dayElement);
                
                let supportStrength = 0;
                let weakenStrength = 0;
                
                supportElements.forEach(element => {
                    supportStrength += currentElements[element];
                });
                
                weakenElements.forEach(element => {
                    weakenStrength += currentElements[element];
                });
                
                // 处理合化影响
                let combinationDeduction = 0;
                const combinationTypes = ['tianGanWuHe', 'diZhiLiuHe', 'diZhiSanHe', 'diZhiSanHui'];
                combinationTypes.forEach(type => {
                    if (currentCombined[type]) {
                        currentCombined[type].forEach(comb => {
                            const heElement = comb.element;
                            // 专业命理评分规则
const SCORE_RULES = {
  'diZhiSanHui': 8,  // 三会局8分（能量最强）
  'diZhiSanHe': 6,   // 三合局6分
  'diZhiLiuHe': 3,   // 六合局3分
  'tianGanWuHe': 2   // 天干合需通根验证
};
let multiplier = SCORE_RULES[type];

// 天干合化通根检查
if(type === 'tianGanWuHe') {
  const currentBranch = allBranches[comb.positions[0]];
  const hiddenElements = BRANCH_ELEMENTS[currentBranch]?.hidden || [];
  if(!hiddenElements.includes(comb.gan1) && !hiddenElements.includes(comb.gan2)) {
    console.log(`天干${comb.gan1}${comb.gan2}合化无效：地支${currentBranch}无通根`);
    return;
  }
}

// 地支合化天干透出检查 - 如果天干透出合化后的五行，能量加倍
if((type === 'diZhiLiuHe' || type === 'diZhiSanHe' || type === 'diZhiSanHui') && comb.hasTransparent) {
  multiplier *= 1.5; // 透出时能量增加50%
  console.log(`${type} 天干透出${heElement}，能量增强至 ${multiplier}`);
}
                            if (getSupportElements(dayElement).includes(heElement)) {
                                supportStrength += multiplier;
                                combinationDeduction += multiplier;
                            } else if (getWeakenElements(dayElement).includes(heElement)) {
                                supportStrength -= multiplier;
                                combinationDeduction -= multiplier;
                            }
                        });
                    }
                });
                
                currentCombined.deduction = combinationDeduction;
                
                // 判断身强身弱
                const strengthRatio = supportStrength / (supportStrength + weakenStrength);
                const strengthPercentage = (strengthRatio - 0.5) * 100; // 转换为百分比，以50%为基准
                
                // 打印调试信息
                console.log(`当前身强身弱计算 - 日主:${dayStem}(${dayElement}), 生扶力量:${supportStrength}, 克泄力量:${weakenStrength}, 比例:${(strengthRatio * 100).toFixed(2)}%, 月令得分:${monthScore}`);
                
                let type, description;
                
                // 判断是否从格（使用与原始函数相同的逻辑）
                const isFollowing = checkFollowingPattern(dayElement, monthBranch, strengthRatio, supportStrength, weakenStrength, monthScore);
                
                if (isFollowing.isFollowing) {
                    type = isFollowing.type;
                    description = '加入当前大运和流年后，' + isFollowing.description;
                } else if (strengthRatio >= 0.60) {
                    type = '身强';
                    description = '加入当前大运和流年后，日主力量强旺，能够承担财官，适合主动出击，喜用财官。';
                } else if (strengthRatio >= 0.40 && strengthRatio < 0.60) {
                    type = '均衡';
                    description = '加入当前大运和流年后，日主力量适中，五行较为平衡，运势平稳，喜用印比。';
                } else {
                    type = '身弱';
                    description = '加入当前大运和流年后，日主力量偏弱，需要生扶，宜守不宜攻，喜用印比。';
                }
                
                // 获取当前大运信息用于显示
                const displayDayunInfo = getCurrentDayun();
                const displayDayun = (displayDayunInfo && displayDayunInfo.ganZhi && displayDayunInfo.ganZhi !== '未知' && displayDayunInfo.ganZhi !== '计算错误') 
                    ? displayDayunInfo.ganZhi 
                    : '未知';
                
                return {
                    type: type,
                    ratio: strengthRatio,
                    strengthPercentage: strengthPercentage,
                    supportStrength: supportStrength,
                    weakenStrength: weakenStrength,
                    description: description,
                    monthScore: monthScore,
                    combined: currentCombined,
                    currentYear: currentYear,
                    currentYearGanZhi: currentYearGanZhi,
                    currentDayun: displayDayun,
                    elements: currentElements
                };
                
            } catch (error) {
                console.error('计算当前身强身弱失败:', error);
                return {
                    type: '计算失败',
                    ratio: 0.5,
                    supportStrength: 0,
                    weakenStrength: 0,
                    description: '无法计算当前身强身弱，请检查数据。',
                    monthScore: 0,
                    combined: {},
                    currentYear: currentYear,
                    currentYearGanZhi: '',
                    currentDayun: '',
                    elements: elements
                };
            }
        }
        
        // 检查当前合化情况（包括流年大运）
        function checkCurrentCombinations(dayStem, allStems, allBranches, yearStem, yearBranch, dayunStem, dayunBranch) {
            const combined = {
                tianGanWuHe: [],
                diZhiLiuHe: [],
                diZhiSanHe: [],
                deduction: 0
            };
            
            // 天干五合规则
            const tianGanHeHua = {
                '甲己': 'earth', '乙庚': 'metal', '丙辛': 'water',
                '丁壬': 'wood', '戊癸': 'fire'
            };
            
            // 地支六合规则
            const diZhiLiuHe = {
                '子丑': 'earth', '寅亥': 'wood', '卯戌': 'fire',
                '辰酉': 'metal', '巳申': 'water', '午未': 'earth'
            };
            
            // 地支三合规则
            const diZhiSanHe = [
                {branches: ['申', '子', '辰'], element: 'water'},
                {branches: ['亥', '卯', '未'], element: 'wood'},
                {branches: ['寅', '午', '戌'], element: 'fire'},
                {branches: ['巳', '酉', '丑'], element: 'metal'}
            ];
            
            // 检查天干五合（流年大运可以与任意八字天干合化）
            for (let i = 0; i < allStems.length; i++) {
                for (let j = i + 1; j < allStems.length; j++) {
                    const stem1 = allStems[i];
                    const stem2 = allStems[j];
                    const pair1 = stem1 + stem2;
                    const pair2 = stem2 + stem1;
                    
                    if (tianGanHeHua[pair1] || tianGanHeHua[pair2]) {
                        const hehuaElement = tianGanHeHua[pair1] || tianGanHeHua[pair2];
                        
                        // 检查地支通根（简化版）
                        let hasRoot = true; // 暂时简化，认为都有通根
                        
                        if (hasRoot) {
                            combined.tianGanWuHe.push({
                                gan1: stem1,
                                gan2: stem2,
                                element: hehuaElement,
                                positions: [i, j],
                                isCurrentYear: (stem1 === yearStem || stem2 === yearStem),
                                isCurrentDayun: (stem1 === dayunStem || stem2 === dayunStem)
                            });
                        }
                    }
                }
            }
            
            // 检查地支六合
            for (let i = 0; i < allBranches.length; i++) {
                for (let j = i + 1; j < allBranches.length; j++) {
                    const branch1 = allBranches[i];
                    const branch2 = allBranches[j];
                    const pair1 = branch1 + branch2;
                    const pair2 = branch2 + branch1;
                    
                    if (diZhiLiuHe[pair1] || diZhiLiuHe[pair2]) {
                        const hehuaElement = diZhiLiuHe[pair1] || diZhiLiuHe[pair2];
                        combined.diZhiLiuHe.push({
                            zhi1: branch1,
                            zhi2: branch2,
                            element: hehuaElement,
                            positions: [i, j],
                            isCurrentYear: (branch1 === yearBranch || branch2 === yearBranch),
                            isCurrentDayun: (branch1 === dayunBranch || branch2 === dayunBranch)
                        });
                    }
                }
            }
            
            // 检查地支三合
            diZhiSanHe.forEach(sanhe => {
                const matches = [];
                sanhe.branches.forEach(branch => {
                    const indices = allBranches.map((b, i) => b === branch ? i : -1).filter(i => i !== -1);
                    if (indices.length > 0) {
                        matches.push({branch, indices});
                    }
                });
                
                if (matches.length >= 2) {
                    combined.diZhiSanHe.push({
                        type: sanhe.branches.join(''),
                        element: sanhe.element,
                        count: matches.length,
                        branches: matches.map(m => m.branch).join(''),
                        isCurrentYear: matches.some(m => m.indices.some(idx => allBranches[idx] === yearBranch)),
                        isCurrentDayun: matches.some(m => m.indices.some(idx => allBranches[idx] === dayunBranch))
                    });
                }
            });
            
            return combined;
        }

        // 显示当前身强身弱分析图表
        function displayCurrentStrengthChart(currentStrengthData) {
            console.log('显示当前身强身弱分析，数据:', currentStrengthData);
            
            const canvas = document.getElementById('current-strength-chart');
            const ctx = canvas.getContext('2d');
            
            // 调试信息：检查数据值
            console.log('当前运势图表数据:', {
                supportStrength: currentStrengthData.supportStrength,
                weakenStrength: currentStrengthData.weakenStrength,
                canvasWidth: canvas.clientWidth,
                canvasHeight: canvas.clientHeight
            });
            
            // 强制重置canvas尺寸
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            
            if (currentStrengthChart) {
                currentStrengthChart.destroy();
            }
            
            currentStrengthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['生扶力量', '克泄力量'],
                    datasets: [{
                        label: '力量对比',
                        data: [currentStrengthData.supportStrength, currentStrengthData.weakenStrength],
                        backgroundColor: [
                            '#27ae60', // 生扶 - 绿色
                            '#e74c3c'  // 克泄 - 红色
                        ],
                        borderWidth: 2,
                        borderColor: '#fff',
                        barThickness: 60,
                        maxBarThickness: 80
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const yVal = typeof context.parsed.y === 'number' ? context.parsed.y : parseFloat(context.parsed.y);
                                    return `${context.label}: ${yVal.toFixed(2)}点`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value) => Number(value).toFixed(2),
                            color: '#333',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            title: {
                                display: true,
                                text: '力量值',
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return Number(value).toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
            
            // 显示当前身强身弱分析描述
            const description = document.getElementById('current-strength-description');
            
            // 根据不同类型设置不同的图标和颜色
            let typeIcon, typeColor;
            switch(currentStrengthData.type) {
                case '身强':
                    typeIcon = 'fa-fire';
                    typeColor = '#e74c3c';
                    break;
                case '身弱':
                    typeIcon = 'fa-snowflake';
                    typeColor = '#3498db';
                    break;
                case '均衡':
                    typeIcon = 'fa-balance-scale';
                    typeColor = '#f39c12';
                    break;
                case '从强':
                    typeIcon = 'fa-arrow-up';
                    typeColor = '#9b59b6';
                    break;
                case '从弱':
                    typeIcon = 'fa-arrow-down';
                    typeColor = '#2ecc71';
                    break;
                default:
                    typeIcon = 'fa-balance-scale';
                    typeColor = '#7f8c8d';
            }
            
            description.innerHTML = `
                <h4><i class="fas fa-clock"></i> 当前身强身弱分析</h4>
                <div style="background-color: #e8f6f3; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1abc9c;">
                    <p style="margin: 0; font-size: 0.95rem;"><strong>当前流年:</strong> ${currentStrengthData.currentYear}年 ${currentStrengthData.currentYearGanZhi}</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.95rem;"><strong>当前大运:</strong> ${currentStrengthData.currentDayun}</p>
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <div style="background-color: ${typeColor}; color: white; padding: 5px 10px; border-radius: 5px; margin-right: 10px;">
                        <i class="fas ${typeIcon}"></i> ${currentStrengthData.type}
                    </div>
                    <div>力量比例: ${currentStrengthData.strengthPercentage.toFixed(2)}%</div>
                </div>
                <p><strong>生扶力量:</strong> ${currentStrengthData.supportStrength.toFixed(2)}点</p>
                <p><strong>克泄力量:</strong> ${currentStrengthData.weakenStrength.toFixed(2)}点</p>
                ${currentStrengthData.monthScore ? `<p><strong>月令得分:</strong> ${currentStrengthData.monthScore}点</p>` : ''}
                ${currentStrengthData.combined && currentStrengthData.combined.effect ? `<p><strong>合化影响:</strong> ${currentStrengthData.combined.effect === 'strengthen' ? '增强日主' : '削弱日主'}</p>` : ''}
                ${currentStrengthData.combined && currentStrengthData.combined.deduction ? `<p><strong>合化扣分:</strong> <span style="color: #e74c3c; font-weight: bold;">${currentStrengthData.combined.deduction}点</span></p>` : ''}
                <div class="current-hehua-info">
                ${currentStrengthData.combined && (currentStrengthData.combined.tianGanWuHe.length > 0 || currentStrengthData.combined.diZhiLiuHe.length > 0 || currentStrengthData.combined.diZhiSanHe.length > 0) ? 
                   `<div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ffc107; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                       <h5 style="color: #856404; margin-top: 0; font-size: 16px;"><i class="fas fa-link"></i> 当前合化信息</h5>
                       ${currentStrengthData.combined.tianGanWuHe.length > 0 ? 
                           `<div style="margin-bottom: 10px;">
                               <p><strong>天干五合:</strong> ${currentStrengthData.combined.tianGanWuHe.map(h => {
                                   const elementName = h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水';
                                   const yearFlag = h.isCurrentYear ? '(流年)' : '';
                                   const dayunFlag = h.isCurrentDayun ? '(大运)' : '';
                                   return `${h.gan1}${h.gan2}合${elementName}${yearFlag}${dayunFlag}`;
                               }).join('、')}</p>
                           </div>` : ''}
                       ${currentStrengthData.combined.diZhiLiuHe.length > 0 ? 
                           `<div style="margin-bottom: 10px;">
                               <p><strong>地支六合:</strong> ${currentStrengthData.combined.diZhiLiuHe.map(h => {
                                   const elementName = h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水';
                                   const yearFlag = h.isCurrentYear ? '(流年)' : '';
                                   const dayunFlag = h.isCurrentDayun ? '(大运)' : '';
                                   return `${h.zhi1}${h.zhi2}合${elementName}${yearFlag}${dayunFlag}`;
                               }).join('、')}</p>
                           </div>` : ''}
                       ${currentStrengthData.combined.diZhiSanHe.length > 0 ? 
                           `<div style="margin-bottom: 10px;">
                               <p><strong>地支三合:</strong> ${currentStrengthData.combined.diZhiSanHe.map(h => {
                                   const elementName = h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水';
                                   const yearFlag = h.isCurrentYear ? '(流年)' : '';
                                   const dayunFlag = h.isCurrentDayun ? '(大运)' : '';
                                   return `${h.type}三合${elementName}(${h.count === 3 ? '全三合' : '半三合'})${yearFlag}${dayunFlag}`;
                               }).join('、')}</p>
                           </div>` : ''}
                       <p><strong>对日主影响:</strong> <span style="color: ${currentStrengthData.combined.effect === 'strengthen' ? '#27ae60' : currentStrengthData.combined.effect === 'weaken' ? '#e74c3c' : '#7f8c8d'}; font-weight: bold;">${currentStrengthData.combined.effect === 'strengthen' ? '增强日主' : currentStrengthData.combined.effect === 'weaken' ? '削弱日主' : '影响中性'}</span></p>
                       ${currentStrengthData.combined.deduction ? `<p><strong>力量扣减:</strong> <span style="color: #e74c3c; font-weight: bold;">${currentStrengthData.combined.deduction}点</span> (合化影响)</p>` : ''}
                   </div>` : `<div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px dashed #ccc;">
                       <p style="color: #7f8c8d; margin: 0;"><i class="fas fa-info-circle"></i> 未检测到当前合化</p>
                   </div>`}
                </div>
                <p><strong>分析说明:</strong> ${currentStrengthData.description}</p>
            `;
            
            // 调整图表容器和描述容器的样式，确保左右并排显示
            const currentStrengthAnalysisFrame = document.querySelector('.current-strength-analysis-frame');
            const currentChartContainer = document.querySelector('.current-chart-container');
            const currentDescriptionContainer = document.getElementById('current-strength-description');
            
            if (currentStrengthAnalysisFrame && currentChartContainer && currentDescriptionContainer) {
                // 确保上下排列显示
                currentStrengthAnalysisFrame.style.display = 'flex';
                currentStrengthAnalysisFrame.style.flexDirection = 'column';
                currentStrengthAnalysisFrame.style.gap = '20px';
                currentStrengthAnalysisFrame.style.flexWrap = 'wrap';
                
                // 设置图表容器样式 - 注释掉以避免覆盖CSS样式
                // currentChartContainer.style.flex = '1';
                // currentChartContainer.style.minWidth = '300px';
                // currentChartContainer.style.minHeight = '350px';
                // currentChartContainer.style.backgroundColor = '#ffffff';
                // currentChartContainer.style.padding = '15px';
                // currentChartContainer.style.borderRadius = '8px';
                // currentChartContainer.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                
                // 设置描述容器样式
                currentDescriptionContainer.style.flex = '1';
                currentDescriptionContainer.style.minWidth = '300px';
                currentDescriptionContainer.style.padding = '15px';
                currentDescriptionContainer.style.backgroundColor = '#f9f9f9';
                currentDescriptionContainer.style.borderRadius = '8px';
                currentDescriptionContainer.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
            }
        }

        // 全局变量存储分数详情
        let fateScoreDetails = {};
        let wealthScoreDetails = {};
        let fateScoreValue = 0;
        let wealthScoreValue = 0;

        // 计算命格等级 - 高级专业版
        function calculateFateLevel(pillars) {
            const score = calculateFateScore(pillars);
            const levelInfo = getFateLevel(score);
            
            return {
                score: score,
                level: levelInfo.name,
                description: getFateDescription(score),
                details: fateScoreDetails
            };
        }

        // 计算命格分数 - 专业版算法
        function calculateFateScore(pillars) {
            if (fateScoreValue === 0) {
                // 确保输入是字符串
                const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
                const monthStr = typeof pillars.month === 'string' ? pillars.month : String(pillars.month);
                const yearStr = typeof pillars.year === 'string' ? pillars.year : String(pillars.year);
                const hourStr = typeof pillars.hour === 'string' ? pillars.hour : String(pillars.hour);
                
                // 创建安全的pillars对象
                const safePillars = {
                    year: yearStr,
                    month: monthStr,
                    day: dayStr,
                    hour: hourStr
                };
                
                // 基础评分：使用新的专业评分算法（总计120分）
                const seasonScore = calculateAdvancedSeasonScore(safePillars);
                const balanceScore = calculateAdvancedBalanceScore(safePillars);
                const patternScore = calculateAdvancedPatternScore(safePillars);
                const godsScore = calculateAdvancedGodsScore(safePillars);
                const combinationScore = calculateAdvancedCombinationScore(safePillars);
                
                // 进阶与修正评分（总计60分）
                const dayMasterStrength = calculateDayMasterStrengthScore(safePillars);
                const usefulGodScore = calculateUsefulGodScore(safePillars);
                const tabooGodControl = calculateTabooGodControlScore(safePillars);
                const kongWangPenalty = calculateKongWangPenalty(safePillars);
                const luckSupport = calculateLuckSupportScore(safePillars);
                const dayunCoordination = calculateDayunCoordinationScore(safePillars);
                
                // 格局与特效评分（总计30分）
                const noblesSupport = calculateNoblesSupportScore(safePillars);
                const specialPatternBonus = calculateSpecialPatternBonus(safePillars);
                const levelBonus = calculateLevelBonus(safePillars);
                
                // 调候用神评分（单独计算）
                const adjustmentScore = calculateSeasonalAdjustmentScore(safePillars);
                
                // 基础模块合计（用于“基础合计”展示：季节助力、五行平衡、格局结构、十神影响、组合刑冲、调候用神）
                const baseModulesTotal = seasonScore + balanceScore + patternScore + godsScore + combinationScore + adjustmentScore;
                // 取消固定基础分，保持为0
                const baseScore = 0;
                
                const total = baseModulesTotal +
                             dayMasterStrength + usefulGodScore + tabooGodControl - kongWangPenalty +
                             luckSupport + dayunCoordination + noblesSupport + specialPatternBonus +
                             levelBonus + baseScore;
                
                fateScoreDetails = {
                    seasonScore,
                    balanceScore,
                    patternScore,
                    godsScore,
                    combinationScore,
                    adjustmentScore,
                    dayMasterStrength,
                    usefulGodScore,
                    tabooGodControl,
                    kongWangPenalty,
                    luckSupport,
                    dayunCoordination,
                    noblesSupport,
                    specialPatternBonus,
                    levelBonus,
                    // 基础合计展示为基础模块合计
                    baseScore: baseModulesTotal,
                    total
                };
                fateScoreValue = Math.round(total);
            }
            return fateScoreValue;
        }

        // 高级季节助力评分 - 连续化评分，考虑月令强弱和通根透干
        function calculateAdvancedSeasonScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            const monthBranch = pillars.month.charAt(1);
            const dayBranch = pillars.day.charAt(1);
            
            // 月令得分基础
            let baseScore = calculateMonthlyStrength(dayStem, monthBranch);
            
            // 通根透干加分
            const rootScore = calculateRootStrength(dayStem, pillars);
            
            // 透干加分
            const transparentScore = calculateTransparentStrength(dayStem, pillars);
            
            // 调候因子
            const seasonalAdjustment = calculateSeasonalAdjustment(dayStem, monthBranch);
            
            const finalScore = (baseScore + rootScore + transparentScore) * seasonalAdjustment;
            return Math.max(0, Math.min(30, finalScore));
        }

        // 月令强弱评分
        function calculateMonthlyStrength(dayStem, monthBranch) {
            const strengthMap = {
                // 木日主
                '甲': { '寅': 25, '卯': 30, '辰': 20, '巳': 8, '午': 12, '未': 15, '申': 5, '酉': 3, '戌': 12, '亥': 18, '子': 15, '丑': 10 },
                '乙': { '寅': 20, '卯': 25, '辰': 18, '巳': 10, '午': 15, '未': 18, '申': 3, '酉': 5, '戌': 10, '亥': 20, '子': 18, '丑': 12 },
                // 火日主
                '丙': { '寅': 18, '卯': 15, '辰': 10, '巳': 25, '午': 30, '未': 20, '申': 8, '酉': 5, '戌': 15, '亥': 3, '子': 5, '丑': 8 },
                '丁': { '寅': 15, '卯': 12, '辰': 8, '巳': 20, '午': 25, '未': 18, '申': 5, '酉': 8, '戌': 12, '亥': 5, '子': 3, '丑': 10 },
                // 土日主
                '戊': { '寅': 8, '卯': 5, '辰': 25, '巳': 20, '午': 18, '未': 30, '申': 12, '酉': 15, '戌': 25, '亥': 3, '子': 5, '丑': 20 },
                '己': { '寅': 5, '卯': 8, '辰': 20, '巳': 18, '午': 15, '未': 25, '申': 10, '酉': 12, '戌': 20, '亥': 5, '子': 8, '丑': 25 },
                // 金日主
                '庚': { '寅': 3, '卯': 5, '辰': 12, '巳': 8, '午': 5, '未': 10, '申': 25, '酉': 30, '戌': 15, '亥': 8, '子': 10, '丑': 18 },
                '辛': { '寅': 5, '卯': 3, '辰': 10, '巳': 5, '午': 8, '未': 12, '申': 20, '酉': 25, '戌': 12, '亥': 10, '子': 12, '丑': 20 },
                // 水日主
                '壬': { '寅': 10, '卯': 8, '辰': 5, '巳': 3, '午': 5, '未': 8, '申': 15, '酉': 12, '戌': 8, '亥': 25, '子': 30, '丑': 18 },
                '癸': { '寅': 8, '卯': 10, '辰': 8, '巳': 5, '午': 3, '未': 10, '申': 12, '酉': 15, '戌': 5, '亥': 20, '子': 25, '丑': 15 }
            };
            
            return strengthMap[dayStem]?.[monthBranch] || 10;
        }

        // 通根强度计算
        function calculateRootStrength(dayStem, pillars) {
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            const elementMap = getElementMap();
            const dayElement = elementMap[dayStem];
            
            let rootScore = 0;
            
            branches.forEach((branch, index) => {
                const hiddenStems = getHiddenStems(branch);
                const mainStem = hiddenStems[0]; // 主气
                
                // 主气同类加分
                if (elementMap[mainStem] === dayElement) {
                    const weight = index === 2 ? 1.5 : 1.0; // 日支权重更高
                    rootScore += 8 * weight;
                }
                
                // 藏干同类加分
                hiddenStems.slice(1).forEach(stem => {
                    if (elementMap[stem] === dayElement) {
                        const weight = index === 2 ? 1.2 : 0.8;
                        rootScore += 3 * weight;
                    }
                });
            });
            
            return Math.min(15, rootScore);
        }

        // 透干强度计算
        function calculateTransparentStrength(dayStem, pillars) {
            const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)];
            const elementMap = getElementMap();
            const dayElement = elementMap[dayStem];
            
            let transparentScore = 0;
            
            stems.forEach((stem, index) => {
                if (elementMap[stem] === dayElement) {
                    const weight = index === 1 ? 1.2 : 1.0; // 月干权重稍高
                    transparentScore += 6 * weight;
                }
            });
            
            return Math.min(12, transparentScore);
        }

        // 调候因子计算
        function calculateSeasonalAdjustment(dayStem, monthBranch) {
            // 调候表：不同日主在不同月份的调候因子
            const adjustmentMap = {
                '甲': { '寅': 1.1, '卯': 1.2, '辰': 1.0, '巳': 0.8, '午': 0.7, '未': 0.8, '申': 0.9, '酉': 0.8, '戌': 0.9, '亥': 1.0, '子': 0.9, '丑': 0.9 },
                '乙': { '寅': 1.0, '卯': 1.1, '辰': 1.0, '巳': 0.9, '午': 1.0, '未': 1.0, '申': 0.7, '酉': 0.6, '戌': 0.8, '亥': 1.1, '子': 1.0, '丑': 0.9 },
                '丙': { '寅': 1.0, '卯': 0.9, '辰': 0.8, '巳': 1.2, '午': 1.3, '未': 1.1, '申': 0.8, '酉': 0.7, '戌': 0.9, '亥': 0.6, '子': 0.5, '丑': 0.7 },
                '丁': { '寅': 0.9, '卯': 0.8, '辰': 0.7, '巳': 1.1, '午': 1.2, '未': 1.0, '申': 0.7, '酉': 0.8, '戌': 0.8, '亥': 0.7, '子': 0.6, '丑': 0.8 },
                '戊': { '寅': 0.8, '卯': 0.7, '辰': 1.2, '巳': 1.1, '午': 1.0, '未': 1.3, '申': 0.9, '酉': 1.0, '戌': 1.2, '亥': 0.6, '子': 0.5, '丑': 1.0 },
                '己': { '寅': 0.7, '卯': 0.8, '辰': 1.1, '巳': 1.0, '午': 0.9, '未': 1.2, '申': 0.8, '酉': 0.9, '戌': 1.1, '亥': 0.7, '子': 0.6, '丑': 1.1 },
                '庚': { '寅': 0.6, '卯': 0.5, '辰': 0.8, '巳': 0.9, '午': 0.7, '未': 0.8, '申': 1.3, '酉': 1.4, '戌': 1.0, '亥': 0.8, '子': 0.9, '丑': 1.0 },
                '辛': { '寅': 0.7, '卯': 0.6, '辰': 0.9, '巳': 0.8, '午': 0.8, '未': 0.9, '申': 1.2, '酉': 1.3, '戌': 0.9, '亥': 0.9, '子': 1.0, '丑': 1.1 },
                '壬': { '寅': 0.9, '卯': 0.8, '辰': 0.7, '巳': 0.6, '午': 0.5, '未': 0.7, '申': 1.0, '酉': 0.9, '戌': 0.8, '亥': 1.3, '子': 1.4, '丑': 1.1 },
                '癸': { '寅': 0.8, '卯': 0.9, '辰': 0.8, '巳': 0.7, '午': 0.6, '未': 0.8, '申': 0.9, '酉': 1.0, '戌': 0.7, '亥': 1.2, '子': 1.3, '丑': 1.0 }
            };
            
            return adjustmentMap[dayStem]?.[monthBranch] || 1.0;
        }

        // 高级五行平衡评分 - 藏干加权 + 透干倍增 + 动态生克
        function calculateAdvancedBalanceScore(pillars) {
            const elementMap = getElementMap();
            const elements = { '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 };
            const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.day.charAt(0), pillars.hour.charAt(0)];
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            
            // 1. 天干能量计算（权重：3分）
            stems.forEach((stem, index) => {
                const element = elementMap[stem];
                const weight = index === 2 ? 1.5 : 1.0; // 日干权重更高
                elements[element] += 3 * weight;
            });
            
            // 2. 地支主气能量计算（权重：2分）
            branches.forEach((branch, index) => {
                const hiddenStems = getHiddenStems(branch);
                const mainStem = hiddenStems[0];
                const element = elementMap[mainStem];
                const weight = index === 2 ? 1.3 : 1.0; // 日支权重稍高
                elements[element] += 2 * weight;
            });
            
            // 3. 藏干能量计算（权重递减：1.5, 1, 0.5分）
            branches.forEach((branch, branchIndex) => {
                const hiddenStems = getHiddenStems(branch);
                hiddenStems.slice(1).forEach((stem, stemIndex) => {
                    const element = elementMap[stem];
                    const baseWeight = [1.5, 1, 0.5][stemIndex] || 0.3;
                    const positionWeight = branchIndex === 2 ? 1.2 : 1.0;
                    elements[element] += baseWeight * positionWeight;
                });
            });
            
            // 4. 应用合化效果
            const combinedElements = applyElementCombinationEffects(elements, stems, branches);
            
            // 5. 应用刑冲破害效果
            const finalElements = applyElementConflictEffects(combinedElements, branches);
            
            // 6. 计算平衡分数
            const values = Object.values(finalElements);
            const total = values.reduce((sum, val) => sum + val, 0);
            const average = total / 5;
            
            // 计算标准差
            const variance = values.reduce((sum, val) => sum + Math.pow(val - average, 2), 0) / 5;
            const standardDeviation = Math.sqrt(variance);
            
            // 平衡分数：标准差越小，平衡性越好
            const balanceScore = Math.max(0, 25 - standardDeviation * 1.5);
            
            return Math.round(balanceScore);
        }

        // 元素层面的合化效果（用于平衡分数计算，不影响原始柱对象）
        function applyElementCombinationEffects(elements, stems, branches) {
            const elementMap = getElementMap();
            const branchSanHe = hasSanHui(branches, 'sanhe');
            if (branchSanHe.count === 3) {
                // 三合化一气：对应五行得到额外加成
                elements[branchSanHe.element] = (elements[branchSanHe.element] || 0) + 3;
            } else if (branchSanHe.count === 2) {
                elements[branchSanHe.element] = (elements[branchSanHe.element] || 0) + 1.5;
            }
            const branchSanHui = hasSanHui(branches, 'sanhui');
            if (branchSanHui.count === 3) {
                elements[branchSanHui.element] = (elements[branchSanHui.element] || 0) + 2;
            }
            // 六合小幅加成
            if (hasLiuHe(branches)) {
                // 六合不定化气，给平均小加成
                Object.keys(elements).forEach(k => elements[k] += 0.3);
            }
            return elements;
        }

        // 元素层面的刑冲破害影响（用于平衡分数计算）
        function applyElementConflictEffects(elements, branches) {
            // 简化版：存在冲（对宫）时，双方元素略降
            const conflictPairs = [['子','午'],['丑','未'],['寅','申'],['卯','酉'],['辰','戌'],['巳','亥']];
            const elementMap = getElementMap();
            const present = new Set(branches);
            conflictPairs.forEach(([a,b]) => {
                if (present.has(a) && present.has(b)) {
                    const ea = elementMap[a];
                    const eb = elementMap[b];
                    if (ea) elements[ea] = Math.max(0, (elements[ea] || 0) - 1);
                    if (eb) elements[eb] = Math.max(0, (elements[eb] || 0) - 1);
                }
            });
            return elements;
        }

        // 高级格局识别评分 - 正格 + 从格 + 破格成败判断
        function calculateAdvancedPatternScore(pillars) {
            let patternScore = 0;
            let patternType = '普通格局';
            
            // 1. 特殊格局识别
            const specialPattern = identifySpecialPattern(pillars);
            if (specialPattern.type !== 'normal') {
                patternScore += specialPattern.score;
                patternType = specialPattern.name;
            }
            
            // 2. 正格评分
            const regularPattern = identifyRegularPattern(pillars);
            patternScore += regularPattern.score;
            
            // 3. 格局成败判断
            const patternIntegrity = evaluatePatternIntegrity(pillars, specialPattern.type);
            patternScore += patternIntegrity.score;
            
            // 4. 用神相神评分
            const yongShenScore = evaluateYongShen(pillars);
            patternScore += yongShenScore;
            
            return Math.min(25, Math.max(5, patternScore));
        }

        // 高级十神评分 - 考虑十神组合、位置和流通
        function calculateAdvancedGodsScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            const dayStrength = estimateDayStrength(pillars);
            let godsScore = 0;
            
            // 统计十神分布
            const tenGodsCount = countTenGods(pillars);
            
            // 1. 财官印食的黄金组合
            if (tenGodsCount.正财 > 0 && tenGodsCount.正官 > 0 && tenGodsCount.正印 > 0) {
                godsScore += 8; // 财官印俱全
            }
            
            // 2. 伤官佩印格
            if (tenGodsCount.伤官 > 0 && tenGodsCount.正印 > 0 && dayStrength >= 40) {
                godsScore += 6; // 伤官佩印，文贵之格
            }
            
            // 3. 食神制杀格
            if (tenGodsCount.食神 > 0 && tenGodsCount.七杀 > 0) {
                godsScore += 7; // 食神制杀，武贵之格
            }
            
            // 4. 十神位置加分
            const monthStem = pillars.month.charAt(0);
            const monthTenGod = getTenGod(dayStem, monthStem);
            if (monthTenGod === '正官' || monthTenGod === '正财') {
                godsScore += 5; // 月令正官正财，格局纯正
            }
            
            // 5. 十神流通检查
            const hasGoodFlow = checkTenGodsFlow(pillars);
            if (hasGoodFlow) {
                godsScore += 4; // 十神流通有情
            }
            
            return Math.min(20, Math.max(0, godsScore));
        }

        // 高级组合评分 - 三合六合三会局的精准评分
        function calculateAdvancedCombinationScore(pillars) {
            let combinationScore = 0;
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            
            // 1. 三合局评分
            const sanHeResult = hasSanHui(branches, 'sanhe');
            if (sanHeResult.count === 3) {
                combinationScore += 12; // 完整三合
                combinationScore += applyAdvancedCombinationEffects(pillars, sanHeResult);
            } else if (sanHeResult.count === 2) {
                combinationScore += 6; // 半合
            }
            
            // 2. 六合评分
            const liuHeCount = hasLiuHe(branches) ? 1 : 0;
            if (liuHeCount > 0) {
                combinationScore += 4;
                combinationScore += applyAdvancedCombinationEffects(pillars, {type: 'liuhe'});
            }
            
            // 3. 三会局评分
            const sanHuiResult = hasSanHui(branches, 'sanhui');
            if (sanHuiResult.count === 3) {
                combinationScore += 10; // 三会局
            }
            
            // 4. 冲克刑害扣分
            const conflictPenalty = applyAdvancedConflictEffects(pillars);
            combinationScore -= conflictPenalty;
            
            // 5. 空亡检查
            const voidPenalty = checkVoidPenalty(pillars);
            combinationScore -= voidPenalty;
            
            return Math.min(15, Math.max(0, combinationScore));
        }

        // 高级组合增益效果
        function applyAdvancedCombinationEffects(pillars, combination) {
            let bonus = 0;
            const dayStem = pillars.day.charAt(0);
            const dayElement = getElementMap()[dayStem];
            const dayStrength = estimateDayStrength(pillars);
            
            if (combination.type === 'sanhe' || combination.type === 'sanhui') {
                const combinedElement = combination.element;
                
                // 合化为用神
                if (isFavorableElement(dayElement, combinedElement, dayStrength)) {
                    bonus += 5;
                }
                
                // 合化为喜神
                if (isSupportiveElement(dayElement, combinedElement)) {
                    bonus += 3;
                }
                
                // 合化为忌神
                if (isUnfavorableElement(dayElement, combinedElement, dayStrength)) {
                    bonus -= 4;
                }
            }
            
            return bonus;
        }

        // 高级冲克扣分效果
        function applyAdvancedConflictEffects(pillars) {
            let penalty = 0;
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            
            // 相冲检查
            const chongPairs = [
                ['子', '午'], ['丑', '未'], ['寅', '申'], 
                ['卯', '酉'], ['辰', '戌'], ['巳', '亥']
            ];
            
            for (const pair of chongPairs) {
                if (branches.includes(pair[0]) && branches.includes(pair[1])) {
                    if (pair[0] === pillars.day.charAt(1) || pair[1] === pillars.day.charAt(1)) {
                        penalty += 5; // 日支被冲，严重
                    } else {
                        penalty += 2; // 其他柱被冲
                    }
                }
            }
            
            // 相刑检查
            const xingGroups = [
                ['寅', '巳', '申'], // 无恩之刑
                ['丑', '戌', '未'], // 恃势之刑
                ['子', '卯']       // 无礼之刑
            ];
            
            for (const group of xingGroups) {
                const presentCount = group.filter(branch => branches.includes(branch)).length;
                if (presentCount >= 2) {
                    penalty += presentCount;
                }
            }
            
            return penalty;
        }

        // 元素对应表
        function getElementMap() {
            return {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '寅': '木', '卯': '木',
                '午': '火', '巳': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
        }

        // 特殊格局识别
        function identifySpecialPattern(pillars) {
            const dayStem = pillars.day.charAt(0);
            
            // 检查从格
            if (isCongGe(pillars)) {
                if (isCongQiangGe(dayStem, 
                    [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)],
                    [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)])) {
                    return { type: 'congqiang', name: '从强格', score: 15 };
                }
                if (isCongRuoGe(dayStem,
                    [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)],
                    [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)])) {
                    return { type: 'congruo', name: '从弱格', score: 12 };
                }
            }
            
            // 检查专旺格
            if (isZhuanWangGe(pillars)) {
                return { type: 'zhuanwang', name: '专旺格', score: 18 };
            }
            
            return { type: 'normal', name: '普通格局', score: 8 };
        }

        // 正格识别
        function identifyRegularPattern(pillars) {
            const monthStem = pillars.month.charAt(0);
            const dayStem = pillars.day.charAt(0);
            const tenGod = getTenGod(dayStem, monthStem);
            
            let score = 0;
            switch(tenGod) {
                case '正官':
                    score = 12; // 正官格，富贵双全
                    break;
                case '七杀':
                    score = 10; // 七杀格，威权之命
                    break;
                case '正财':
                    score = 11; // 正财格，财富之命
                    break;
                case '偏财':
                    score = 9;  // 偏财格，投机之财
                    break;
                case '食神':
                    score = 10; // 食神格，福寿之命
                    break;
                case '伤官':
                    score = 8;  // 伤官格，聪明反被聪明误
                    break;
                case '正印':
                    score = 9;  // 正印格，文贵之命
                    break;
                case '偏印':
                    score = 7;  // 偏印格，孤独之命
                    break;
                default:
                    score = 6;  // 比劫建禄格
            }
            
            return { type: tenGod, score: score };
        }

        // 格局成败判断
        function evaluatePatternIntegrity(pillars, patternType) {
            let integrityScore = 0;
            
            // 检查格局是否被破坏
            if (patternType === 'normal') {
                // 正格成败检查
                integrityScore = checkRegularPatternIntegrity(pillars);
            } else {
                // 变格成败检查
                integrityScore = checkSpecialPatternIntegrity(pillars, patternType);
            }
            
            return { score: integrityScore };
        }

        // 用神相神评分
        function evaluateYongShen(pillars) {
            const dayStrength = estimateDayStrength(pillars);
            let yongShenScore = 0;
            
            // 根据身强身弱确定用神
            if (dayStrength > 70) {
                // 身强用食伤财官
                yongShenScore += evaluateWeakeningGods(pillars);
            } else if (dayStrength < 30) {
                // 身弱用印比
                yongShenScore += evaluateStrengtheningGods(pillars);
            } else {
                // 中和用调候
                yongShenScore += evaluateBalancingGods(pillars);
            }
            
            return Math.min(8, Math.max(0, yongShenScore));
        }

        // 估算日主强度
        function estimateDayStrength(pillars) {
            // 复用已有的 calculateSimpleDayStrength 函数
            return calculateSimpleDayStrength(pillars);
        }

        // 新增：全局十神计算函数（供格局识别、十神统计、元素标注等模块使用）
        function getTenGod(dayStem, target) {
            const ganList = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            // 如果传入的是地支，则取其主气天干
            if (!ganList.includes(target)) {
                const mainQiMap = {
                    '子': '癸', '丑': '己', '寅': '甲', '卯': '乙',
                    '辰': '戊', '巳': '丙', '午': '丁', '未': '己',
                    '申': '庚', '酉': '辛', '戌': '戊', '亥': '壬'
                };
                target = mainQiMap[target];
                if (!target) return '未知';
            }
            const dayIndex = ganList.indexOf(dayStem);
            const targetIndex = ganList.indexOf(target);
            if (dayIndex === -1 || targetIndex === -1) return '未知';
            const diff = (targetIndex - dayIndex + 10) % 10;
            const tenGods = [
                '比肩', '劫财', '食神', '伤官',
                '偏财', '正财', '七杀', '正官',
                '偏印', '正印'
            ];
            return tenGods[diff] || '未知';
        }

        // 统计十神数量
        function countTenGods(pillars) {
            const dayStem = pillars.day.charAt(0);
            const tenGodsCount = {
                '比肩': 0, '劫财': 0, '食神': 0, '伤官': 0,
                '偏财': 0, '正财': 0, '七杀': 0, '正官': 0,
                '偏印': 0, '正印': 0
            };
            
            // 统计天干十神
            [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)].forEach(stem => {
                const tenGod = getTenGod(dayStem, stem);
                if (tenGodsCount.hasOwnProperty(tenGod)) {
                    tenGodsCount[tenGod]++;
                }
            });
            
            // 统计地支藏干十神
            [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)].forEach(branch => {
                const hiddenStems = getHiddenStems(branch);
                hiddenStems.forEach(stem => {
                    if (stem !== dayStem) {
                        const tenGod = getTenGod(dayStem, stem);
                        if (tenGodsCount.hasOwnProperty(tenGod)) {
                            tenGodsCount[tenGod] += 0.3; // 藏干权重较低
                        }
                    }
                });
            });
            
            return tenGodsCount;
        }

        // 三合三会检查
        function hasSanHui(branches, type = 'sanhe') {
            if (type === 'sanhe') {
                // 三合局检查
                const sanHeGroups = [
                    { branches: ['申', '子', '辰'], element: '水' },
                    { branches: ['亥', '卯', '未'], element: '木' },
                    { branches: ['寅', '午', '戌'], element: '火' },
                    { branches: ['巳', '酉', '丑'], element: '金' }
                ];
                
                for (const group of sanHeGroups) {
                    const count = group.branches.filter(branch => branches.includes(branch)).length;
                    if (count >= 2) {
                        return { count: count, element: group.element, type: 'sanhe' };
                    }
                }
            } else if (type === 'sanhui') {
                // 三会局检查
                const sanHuiGroups = [
                    { branches: ['亥', '子', '丑'], element: '水' },
                    { branches: ['寅', '卯', '辰'], element: '木' },
                    { branches: ['巳', '午', '未'], element: '火' },
                    { branches: ['申', '酉', '戌'], element: '金' }
                ];
                
                for (const group of sanHuiGroups) {
                    const count = group.branches.filter(branch => branches.includes(branch)).length;
                    if (count === 3) {
                        return { count: count, element: group.element, type: 'sanhui' };
                    }
                }
            }
            
            return { count: 0, element: null, type: null };
        }

        // 空亡检查
        function checkVoidPenalty(pillars) {
            const dayBranch = pillars.day.charAt(1);
            const hourBranch = pillars.hour.charAt(1);
            
            // 简化的空亡检查（基于日支和时支）
            const voidPairs = [
                ['甲子', '乙丑'], ['丙寅', '丁卯'], ['戊辰', '己巳'],
                ['庚午', '辛未'], ['壬申', '癸酉'], ['甲戌', '乙亥']
            ];
            
            let penalty = 0;
            const dayPillar = pillars.day;
            
            // 检查日柱是否空亡
            for (const pair of voidPairs) {
                if (pair.includes(dayPillar)) {
                    penalty += 3; // 日柱空亡，扣分
                    break;
                }
            }
            
            return penalty;
        }

        // 十神流通检查
        function checkTenGodsFlow(pillars) {
            const dayStem = pillars.day.charAt(0);
            const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)];
            
            // 检查是否有连续的生克关系
            let flowCount = 0;
            for (let i = 0; i < stems.length - 1; i++) {
                const tenGod1 = getTenGod(dayStem, stems[i]);
                const tenGod2 = getTenGod(dayStem, stems[i + 1]);
                
                // 检查十神之间的流通关系
                if (isGoodTenGodFlow(tenGod1, tenGod2)) {
                    flowCount++;
                }
            }
            
            return flowCount >= 1; // 至少有一组流通
        }

        // 判断十神流通关系
        function isGoodTenGodFlow(god1, god2) {
            const flowMap = {
                '食神': ['偏财', '正财'],
                '伤官': ['偏财', '正财'],
                '偏财': ['七杀', '正官'],
                '正财': ['七杀', '正官'],
                '七杀': ['偏印', '正印'],
                '正官': ['偏印', '正印'],
                '偏印': ['比肩', '劫财'],
                '正印': ['比肩', '劫财']
            };
            
            return flowMap[god1]?.includes(god2) || false;
        }

        // 判断用神元素
        function isFavorableElement(dayElement, targetElement, dayStrength) {
            
            if (dayStrength > 70) {
                // 身强，克泄为用
                const drainMap = {
                    '木': ['火'], '火': ['土'], '土': ['金'], '金': ['水'], '水': ['木']
                };
                const restrainMap = {
                    '木': ['土'], '火': ['金'], '土': ['水'], '金': ['木'], '水': ['火']
                };
                return drainMap[dayElement]?.includes(targetElement) || 
                       restrainMap[dayElement]?.includes(targetElement);
            } else if (dayStrength < 30) {
                // 身弱，生助为用
                const supportMap = {
                    '木': ['水'], '火': ['木'], '土': ['火'], '金': ['土'], '水': ['金']
                };
                return supportMap[dayElement]?.includes(targetElement) || dayElement === targetElement;
            }
            
            return false;
        }

        // 判断喜神元素
        function isSupportiveElement(dayElement, targetElement) {
            // 简化判断：生用神的为喜神
            const supportMap = {
                '木': ['水'], '火': ['木'], '土': ['火'], '金': ['土'], '水': ['金']
            };
            
            return supportMap[targetElement]?.includes(dayElement);
        }

        // 判断忌神元素
        function isUnfavorableElement(dayElement, targetElement, dayStrength) {
            
            if (dayStrength > 70) {
                // 身强，生助为忌
                const supportMap = {
                    '木': ['水'], '火': ['木'], '土': ['火'], '金': ['土'], '水': ['金']
                };
                return supportMap[dayElement]?.includes(targetElement) || dayElement === targetElement;
            } else if (dayStrength < 30) {
                // 身弱，克泄为忌
                const drainMap = {
                    '木': ['火'], '火': ['土'], '土': ['金'], '金': ['水'], '水': ['木']
                };
                const restrainMap = {
                    '木': ['土'], '火': ['金'], '土': ['水'], '金': ['木'], '水': ['火']
                };
                return drainMap[dayElement]?.includes(targetElement) || 
                       restrainMap[dayElement]?.includes(targetElement);
            }
            
            return false;
        }

        // 正格成败检查
        function checkRegularPatternIntegrity(pillars) {
            const monthStem = pillars.month.charAt(0);
            const dayStem = pillars.day.charAt(0);
            const tenGod = getTenGod(dayStem, monthStem);
            
            let integrityScore = 5; // 基础分
            
            // 检查格局是否被破坏
            switch(tenGod) {
                case '正官':
                    // 正官格怕伤官破格
                    if (hasInjuringOfficer(pillars)) {
                        integrityScore -= 3;
                    }
                    break;
                case '七杀':
                    // 七杀格要有制化
                    if (hasKillControl(pillars)) {
                        integrityScore += 2;
                    } else {
                        integrityScore -= 2;
                    }
                    break;
                case '正财':
                case '偏财':
                    // 财格怕比劫夺财
                    if (hasWealthRobbery(pillars)) {
                        integrityScore -= 3;
                    }
                    break;
                case '食神':
                    // 食神格怕枭印夺食
                    if (hasOwlSnatching(pillars)) {
                        integrityScore -= 3;
                    }
                    break;
            }
            
            return Math.max(0, integrityScore);
        }

        // 变格成败检查
        function checkSpecialPatternIntegrity(pillars, patternType) {
            let integrityScore = 8; // 特殊格局基础分较高
            
            if (patternType === 'congqiang' || patternType === 'congruo') {
                // 从格怕逢反局
                if (hasReversalElements(pillars, patternType)) {
                    integrityScore -= 5;
                }
            } else if (patternType === 'zhuanwang') {
                // 专旺格要气势连贯
                if (hasContinuousForce(pillars)) {
                    integrityScore += 3;
                } else {
                    integrityScore -= 2;
                }
            }
            
            return Math.max(0, integrityScore);
        }

        // 身强用神评分
        function evaluateWeakeningGods(pillars) {
            const tenGodsCount = countTenGods(pillars);
            let score = 0;
            
            // 食伤泄秀
            score += (tenGodsCount.食神 + tenGodsCount.伤官) * 2;
            
            // 财星耗身
            score += (tenGodsCount.正财 + tenGodsCount.偏财) * 1.5;
            
            // 官杀制身
            score += (tenGodsCount.正官 + tenGodsCount.七杀) * 1;
            
            return Math.min(8, score);
        }

        // 身弱用神评分
        function evaluateStrengtheningGods(pillars) {
            const tenGodsCount = countTenGods(pillars);
            let score = 0;
            
            // 印星生身
            score += (tenGodsCount.正印 + tenGodsCount.偏印) * 2;
            
            // 比劫帮身
            score += (tenGodsCount.比肩 + tenGodsCount.劫财) * 1.5;
            
            return Math.min(8, score);
        }

        // 中和调候用神评分
        function evaluateBalancingGods(pillars) {
            const monthBranch = pillars.month.charAt(1);
            let score = 5; // 中和基础分
            
            // 根据季节调候
            if (['子', '丑', '亥'].includes(monthBranch)) {
                // 冬季用火调候
                const tenGodsCount = countTenGods(pillars);
                if (tenGodsCount.食神 > 0) score += 2; // 食神生火
            } else if (['午', '未', '巳'].includes(monthBranch)) {
                // 夏季用水调候
                const tenGodsCount = countTenGods(pillars);
                if (tenGodsCount.正官 > 0 || tenGodsCount.七杀 > 0) score += 2; // 官杀为水
            }
            
            return Math.min(8, score);
        }

        // 辅助检查函数
        function hasInjuringOfficer(pillars) {
            const dayStem = pillars.day.charAt(0);
            const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)];
            return stems.some(stem => getTenGod(dayStem, stem) === '伤官');
        }

        function hasKillControl(pillars) {
            const tenGodsCount = countTenGods(pillars);
            return tenGodsCount.食神 > 0 || tenGodsCount.正印 > 0;
        }

        function hasWealthRobbery(pillars) {
            const tenGodsCount = countTenGods(pillars);
            return tenGodsCount.比肩 > 0 || tenGodsCount.劫财 > 0;
        }

        function hasOwlSnatching(pillars) {
            const tenGodsCount = countTenGods(pillars);
            return tenGodsCount.偏印 > 0;
        }

        function hasReversalElements(pillars, patternType) {
            const dayStem = pillars.day.charAt(0);
            const dayElement = getElementMap()[dayStem];
            
            // 简化检查：从强格忌克泄，从弱格忌生助
            if (patternType === 'congqiang') {
                // 从强格怕食伤财官
                const tenGodsCount = countTenGods(pillars);
                return (tenGodsCount.食神 + tenGodsCount.伤官 + 
                       tenGodsCount.正财 + tenGodsCount.偏财 + 
                       tenGodsCount.正官 + tenGodsCount.七杀) > 1;
            } else if (patternType === 'congruo') {
                // 从弱格怕印比
                const tenGodsCount = countTenGods(pillars);
                return (tenGodsCount.正印 + tenGodsCount.偏印 + 
                       tenGodsCount.比肩 + tenGodsCount.劫财) > 1;
            }
            
            return false;
        }

        function hasContinuousForce(pillars) {
            const dayElement = getElementMap()[pillars.day.charAt(0)];
            let sameElementCount = 0;
            
            // 统计同类五行数量
            [pillars.year, pillars.month, pillars.day, pillars.hour].forEach(pillar => {
                const stemElement = getElementMap()[pillar.charAt(0)];
                const branchElement = getElementMap()[pillar.charAt(1)];
                if (stemElement === dayElement) sameElementCount++;
                if (branchElement === dayElement) sameElementCount++;
            });
            
            return sameElementCount >= 5; // 超过一半为同类五行
        }

        // 判断从格
        function isCongGe(pillars) {
            const dayStem = pillars.day.charAt(0);
            const stems = [
                pillars.year.charAt(0),
                pillars.month.charAt(0),
                pillars.hour.charAt(0)
            ];
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            if (isCongQiangGe(dayStem, stems, branches)) {
                return true;
            }
            if (isCongRuoGe(dayStem, stems, branches)) {
                return true;
            }
            return false;
        }

        // 判断从强格
        function isCongQiangGe(dayStem, stems, branches) {
            let count = 0;
            stems.forEach(function(stem) {
                if (isSameElement(stem, dayStem) || isGenerateElement(stem, dayStem)) {
                    count++;
                }
            });
            branches.forEach(function(branch) {
                if (isSameElement(branch, dayStem) || isGenerateElement(branch, dayStem)) {
                    count++;
                }
            });
            return count >= 6;
        }

        // 判断从弱格
        function isCongRuoGe(dayStem, stems, branches) {
            let count = 0;
            stems.forEach(function(stem) {
                if (isSameElement(stem, dayStem) || isGenerateElement(stem, dayStem)) {
                    count++;
                }
            });
            branches.forEach(function(branch) {
                if (isSameElement(branch, dayStem) || isGenerateElement(branch, dayStem)) {
                    count++;
                }
            });
            return count <= 1;
        }

        // 判断专旺格
        function isZhuanWangGe(pillars) {
            const dayStem = pillars.day.charAt(0);
            const stems = [
                pillars.year.charAt(0),
                pillars.month.charAt(0),
                pillars.hour.charAt(0)
            ];
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            let sameCount = 0;
            let otherCount = 0;
            stems.forEach(function(stem) {
                if (isSameElement(stem, dayStem)) {
                    sameCount++;
                } else {
                    otherCount++;
                }
            });
            branches.forEach(function(branch) {
                if (isSameElement(branch, dayStem)) {
                    sameCount++;
                } else {
                    otherCount++;
                }
            });
            return sameCount >= 5 && otherCount <= 2;
        }

        // 判断相同元素
        function isSameElement(a, b) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '寅': '木', '卯': '木',
                '午': '火', '巳': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
            return elementMap[a] === elementMap[b];
        }

        // 判断生成元素
        function isGenerateElement(a, b) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '寅': '木', '卯': '木',
                '午': '火', '巳': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
            const aElement = elementMap[a];
            const bElement = elementMap[b];
            const generateMap = {
                '木': '火',
                '火': '土',
                '土': '金',
                '金': '水',
                '水': '木'
            };
            return generateMap[aElement] === bElement;
        }

        // 计算十神分数
        function calculateGodsScore(pillars) {
            return 10;
        }

        // 计算组合分数
        function calculateCombinationScore(pillars) {
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            if (hasSanHe(branches)) {
                return 8;
            }
            if (hasLiuHe(branches)) {
                return 5;
            }
            return 2;
        }

        // 判断三合
        function hasSanHe(branches) {
            const sanHeGroups = [
                ['申', '子', '辰'],
                ['亥', '卯', '未'],
                ['寅', '午', '戌'],
                ['巳', '酉', '丑']
            ];
            for (const group of sanHeGroups) {
                let count = 0;
                for (const branch of branches) {
                    if (group.includes(branch)) {
                        count++;
                    }
                }
                if (count >= 2) {
                    return true;
                }
            }
            return false;
        }

        // 判断六合
        function hasLiuHe(branches) {
            const liuHePairs = [
                ['子', '丑'],
                ['寅', '亥'],
                ['卯', '戌'],
                ['辰', '酉'],
                ['巳', '申'],
                ['午', '未']
            ];
            for (const pair of liuHePairs) {
                if (branches.includes(pair[0]) && branches.includes(pair[1])) {
                    return true;
                }
            }
            return false;
        }

        // 获取命运等级 - 适配去掉固定50分后的评分系统（约130-140分制）
        function getFateLevel(score) {
            if (score >= 150) return { name: "天赐鸿运 ★★★★★", class: "excellent" };      // 150+：天赐鸿运（五星）
            if (score >= 120) return { name: "福星高照 ★★★★☆", class: "good" };          // 120-149：福星高照（四星）
            if (score >= 95) return { name: "安常守分 ★★★☆☆", class: "average" };        // 95-119：安常守分（三星）
            if (score >= 70) return { name: "勤能补拙 ★★☆☆☆", class: "struggling" };     // 70-94：勤能补拙（二星）
            if (score >= 45) return { name: "力争上游 ★☆☆☆☆", class: "basic" };          // 45-69：力争上游（一星）
            return { name: "逆水行舟 ☆☆☆☆☆", class: "needs-improvement" };             // <45：逆水行舟（零星）
        }

        // 获取命格描述
        function getFateDescription(score) {
            if (score >= 85) return '天赋异禀，福泽深厚，一生运势极佳';
            if (score >= 70) return '聪明才智，运势较佳，发展前景良好';
            if (score >= 50) return '资质良好，发展平稳，需要努力进取';
            if (score >= 30) return '普通命格，需要勤奋努力方能成功';
            return '命途坎坷，需要坚持不懈，逆境求生';
        }



        // 计算财富等级 - 专业版
        function calculateWealthLevel(pillars) {
            // 优先使用 window.currentBaziData.pillars 如果可用
            let effectivePillars = pillars;
            if (window.currentBaziData && window.currentBaziData.pillars) {
                effectivePillars = window.currentBaziData.pillars;
            }
            
            const score = calculateWealthScore(effectivePillars);
            const levelInfo = getWealthLevel(score);
            
            return {
                score: score,
                level: levelInfo.name,
                description: getWealthDescription(score),
                details: wealthScoreDetails
            };
        }

        // 计算财富分数 - 基于专业八字命理的无上限评分，融入自坐财库、财气通门户等因素
        function calculateWealthScore(pillars) {
            wealthScoreValue = 0; // 重置缓存，确保每次重新计算
            if (wealthScoreValue === 0) {
                // 优先使用 window.currentBaziData.pillars 如果可用
                let effectivePillars = pillars;
                if (window.currentBaziData && window.currentBaziData.pillars) {
                    effectivePillars = window.currentBaziData.pillars;
                }
                
                // 确保输入是字符串
                const dayStr = typeof effectivePillars.day === 'string' ? effectivePillars.day : String(effectivePillars.day);
                const monthStr = typeof effectivePillars.month === 'string' ? effectivePillars.month : String(effectivePillars.month);
                const yearStr = typeof effectivePillars.year === 'string' ? effectivePillars.year : String(effectivePillars.year);
                const hourStr = typeof effectivePillars.hour === 'string' ? effectivePillars.hour : String(effectivePillars.hour);
                
                // 创建安全的pillars对象
                const safePillars = {
                    year: yearStr,
                    month: monthStr,
                    day: dayStr,
                    hour: hourStr
                };
                
                // 进一步优化的专业八字财富算法
                const shishangScore = calculateShishangEnergy(safePillars);         // 食伤生财 (15分)
                const yinshouScore = calculateYinshouSupport(safePillars);          // 印绶护身 (8分)
                const wealthStarScore = calculateWealthStarEnergy(safePillars);      // 财星能量 (12分)
                const wealthPositionScore = calculateWealthPosition(safePillars);    // 财星位置 (8分)
                const wealthVaultScore = calculateWealthVault(safePillars);          // 财富库 (8分)
                const dayMasterCapacity = calculateDayMasterCapacity(safePillars);   // 日主承载力 (10分)
                const selfVaultScore = calculateSelfSittingVault(safePillars);       // 自坐财库 (8分)
                const portalScore = calculateWealthPortal(safePillars);             // 财气通门户 (8分)
                const fromWealthScore = calculateFromWealthGrid(safePillars);        // 从财格 (0分，已废弃)
                
                // 基础分数
                let baseScore = shishangScore + yinshouScore + wealthStarScore + wealthPositionScore + wealthVaultScore + dayMasterCapacity + selfVaultScore + portalScore + fromWealthScore;
                
                // 十神组合特效
                const tenGodsBonus = calculateTenGodsEffects(safePillars);
                baseScore += tenGodsBonus;
                
                // 特殊格局识别和加分
                const specialPatterns = identifySpecialPatterns(safePillars);
                const specialBonus = specialPatterns.reduce((sum, pattern) => sum + pattern.bonus, 0);
                baseScore += specialBonus;
                
                // 身财平衡调整
                const balanceAdjustment = calculateBodyWealthBalance(safePillars);
                baseScore += balanceAdjustment;
                
                // 大运流年修正 (简化版本，基于当前年份)
                const luckAdjustment = calculateLuckAdjustment(safePillars, new Date().getFullYear());
                
                const dayunStrength = calculateDayunStrength(safePillars);
                let total = baseScore + luckAdjustment + dayunStrength; // 不再封顶，显示真实得分
                
                // 专业八字要素：空亡检查 - 传统命理核心理论
                const kongWangPenalty = calculateKongWangPenalty(safePillars);
                
                // 专业八字要素：喜忌平衡分析
                const favorableBalance = calculateFavorableBalance(safePillars);
                
                // 专业八字要素：季节性财运潜力
                const seasonalWealthPotential = calculateSeasonalWealthPotential(safePillars.day.charAt(0), safePillars.month.charAt(1));
                
                // 专业八字要素：财星保护分数（官星护财、印星化劫等）
                const wealthProtectionScore = calculateWealthProtectionScore(safePillars);
                
                // 调整总分，增加专业分析维度
                total = total + favorableBalance + seasonalWealthPotential + wealthProtectionScore - kongWangPenalty;
                
                // 应用传统否决条款（升级版）
                total = applyTraditionalVetoRules(total, safePillars);
                
                // 移除100分上限，显示真实财富评分
                
                // 基础模块合计（食伤生财、印绶护身、财星能量、财星位置、财富库藏、自坐财库、财气通门户、日主承载）
                const baseModulesTotal = shishangScore + yinshouScore + wealthStarScore + wealthPositionScore + wealthVaultScore + dayMasterCapacity + selfVaultScore + portalScore;
                
                wealthScoreDetails = {
                    shishangScore,
                    yinshouScore,
                    wealthStarScore,
                    wealthPositionScore,
                    wealthVaultScore,
                    dayMasterCapacity,
                    selfVaultScore,
                    portalScore,
                    fromWealthScore,
                    tenGodsBonus,
                    specialPatterns,
                    specialBonus,
                    balanceAdjustment,
                    luckAdjustment,
                    dayunStrength,
                    // 新增专业八字分析要素
                    kongWangPenalty,
                    favorableBalance,
                    seasonalWealthPotential,
                    wealthProtectionScore,
                    // 基础合计为基础模块总和
                    baseScore: baseModulesTotal,
                    total
                };
                wealthScoreValue = Math.round(total);
            }
            return wealthScoreValue;
        }

        // 辅助函数定义
        function isShishang(dayElement, element) {
            // 食神: 同阴阳的偏印, 伤官: 异阴阳的偏印 (简化)
            const shishangMap = {
                '木': ['水'], '火': ['木'], '土': ['火'], '金': ['土'], '水': ['金']
            };
            return shishangMap[dayElement]?.includes(element);
        }

        function isYinshou(dayElement, element) {
            // 正印/偏印: 生日的元素
            const yinshouMap = {
                '木': ['水'], '火': ['木'], '土': ['火'], '金': ['土'], '水': ['金']
            };
            return yinshouMap[dayElement]?.includes(element);
        }

        function isWealth(dayElement, element) {
            // 正财/偏财: 日所克的元素
            const wealthMap = {
                '木': ['土'], '火': ['金'], '土': ['水'], '金': ['木'], '水': ['火']
            };
            return wealthMap[dayElement]?.includes(element);
        }

        function hasWealthNearby(pillars) {
            // 检查食伤旁是否有财星 (简化检查月日柱)
            return isWealth(getStemElement(pillars.day.charAt(0)), getStemElement(pillars.month.charAt(0))) ||
                   isWealth(getStemElement(pillars.day.charAt(0)), getBranchElement(pillars.month.slice(1)));
        }

        // 计算食伤能量 - 作为财富源头 (30分) - 优化版
          function calculateShishangEnergy(pillars) {
             const dayElement = getStemElement(pillars.day.charAt(0));
             const dayStrength = calculateSimpleDayStrength(pillars);
             let energy = 0;
             let shishangCount = 0;
             let wealthCount = 0;
             
             const positions = ['year', 'month', 'day', 'hour'];
             positions.forEach(pos => {
                 const stem = pillars[pos].charAt(0);
                 const branch = pillars[pos].slice(1);
                 if (isShishang(dayElement, getStemElement(stem))) {
                     energy += 3; // 食伤在天干，降低分数
                     shishangCount++;
                 }
                 if (isShishang(dayElement, getBranchElement(branch))) {
                     energy += 2; // 在地支，降低分数
                     shishangCount++;
                 }
                 if (isWealth(dayElement, getStemElement(stem)) || isWealth(dayElement, getBranchElement(branch))) {
                     wealthCount++;
                 }
             });
             
             // 食伤生财组合 - 富贵之源
             if (shishangCount > 0 && wealthCount > 0) {
                 energy += 8; // 食伤生财，降低分数
                 
                 // 身强食伤生财更佳
                 if (dayStrength >= 60) {
                     energy += 4; // 身强能驾驭食伤，降低分数
                 }
             }
             
             // 伤官佩印格局检查
             const yinCount = countYinStars(pillars);
             if (shishangCount >= 2 && yinCount >= 1 && dayStrength >= 40 && dayStrength <= 70) {
                 energy += 6; // 伤官佩印，降低分数
             }
             
             return Math.min(15, Math.round(energy)); // 降低上限到15分
         }

        // 计算印绶支持 - 护身担财 (20分) - 优化版
         function calculateYinshouSupport(pillars) {
             const dayElement = getStemElement(pillars.day.charAt(0));
             const dayStrength = calculateSimpleDayStrength(pillars);
             const wealthStrength = calculateWealthStrength(pillars);
             let score = 0;
             let yinCount = 0;
             
             const positions = ['year', 'month', 'day', 'hour'];
             positions.forEach(pos => {
                 const stem = pillars[pos].charAt(0);
                 const branch = pillars[pos].slice(1);
                 if (isYinshou(dayElement, getStemElement(stem))) {
                     score += (pos === 'month' ? 10 : 5); // 月令印星最重要
                     yinCount++;
                 }
                 if (isYinshou(dayElement, getBranchElement(branch))) {
                     score += 3;
                     yinCount++;
                 }
             });
             
             // 身弱财旺时印星的重要性
             if (dayStrength < 50 && wealthStrength > 60) {
                 score += yinCount * 5; // 身弱财旺，印星护身
             }
             
             // 印星化杀生身 - 贵格
             const officerCount = calculateOfficerPresence(pillars);
             if (yinCount >= 1 && officerCount >= 1) {
                 score += 8; // 印星化杀，转危为安
             }
             
             return Math.min(8, score); // 降低上限到8分
         }

        // 计算财星能量 - 优化版（增加财星质量系数）
         function calculateWealthStarEnergy(pillars) {
             const dayElement = getStemElement(pillars.day.charAt(0));
             const monthBranch = pillars.month.slice(1);
             let totalEnergy = 0;
             
             const positions = ['year', 'month', 'day', 'hour'];
             positions.forEach(pos => {
                 const stem = pillars[pos].charAt(0);
                 const branch = pillars[pos].slice(1);
                 const stemElement = getStemElement(stem);
                 const branchElement = getBranchElement(branch);
                 
                 // 天干财星
                 if (isWealth(dayElement, stemElement)) {
                     let baseScore = (pos === 'month' || pos === 'day' ? 3 : 1);
                     let qualityFactor = calculateWealthQuality(stem, monthBranch, pillars);
                     totalEnergy += baseScore * qualityFactor;
                 }
                 
                 // 地支财星
                 if (isWealth(dayElement, branchElement)) {
                     let baseScore = 2;
                     let qualityFactor = calculateWealthQuality(branch, monthBranch, pillars);
                     totalEnergy += baseScore * qualityFactor * 0.6;
                 }
             });
             
             // 流通系数调整
             const flowFactor = calculateWealthFlow(pillars);
             totalEnergy *= flowFactor;
             
             const score = Math.min(12, totalEnergy); // 降低上限到12分
             return Math.max(0, Math.round(score));
         }
         
         // 新增：计算财星质量系数
         function calculateWealthQuality(wealthStar, monthBranch, pillars) {
             let quality = 1.0;
             
             // 得令系数（2.0）
             if (isWealthInSeason(wealthStar, monthBranch)) {
                 quality *= 2.0;
             }
             // 得地系数（1.5）
             else if (isWealthSupported(wealthStar, pillars)) {
                 quality *= 1.5;
             }
             // 有源系数（1.3）- 有食伤生财
             else if (hasWealthSource(wealthStar, pillars)) {
                 quality *= 1.3;
             }
             // 无破系数（1.2）- 无比劫夺财
             else if (!hasWealthDestruction(wealthStar, pillars)) {
                 quality *= 1.2;
             }
             // 被克泄系数（0.7）
             else if (isWealthWeakened(wealthStar, pillars)) {
                 quality *= 0.7;
             }
             
             return quality;
         }
         
         // 新增：计算财星流通系数
         function calculateWealthFlow(pillars) {
             let flow = 1.0;
             
             // 检查刑冲破害
             const harmFactor = calculateHarmEffects(pillars);
             flow *= harmFactor;
             
             // 检查合化效果
             const combineFactor = calculateCombineEffects(pillars);
             flow *= combineFactor;
             
             return Math.max(0.3, Math.min(2.5, flow));
         }
        
        // 新增：财星质量评估辅助函数
        function isWealthInSeason(wealthStar, monthBranch) {
            const wealthElement = getStemElement(wealthStar) || getBranchElement(wealthStar);
            const monthElement = getBranchElement(monthBranch);
            
            // 财星得令判断
            const seasonMap = {
                '木': ['寅', '卯'], '火': ['巳', '午'], 
                '土': ['辰', '戌', '丑', '未'], '金': ['申', '酉'], 
                '水': ['亥', '子']
            };
            
            return seasonMap[wealthElement]?.includes(monthBranch);
        }
        
        function isWealthSupported(wealthStar, pillars) {
            const wealthElement = getStemElement(wealthStar) || getBranchElement(wealthStar);
            const allBranches = [pillars.year.slice(1), pillars.month.slice(1), pillars.day.slice(1), pillars.hour.slice(1)];
            
            // 检查是否有同类或生扶
            return allBranches.some(branch => {
                const branchElement = getBranchElement(branch);
                return branchElement === wealthElement || isElementSupporting(branchElement, wealthElement);
            });
        }
        
        function hasWealthSource(wealthStar, pillars) {
            const dayElement = getStemElement(pillars.day.charAt(0));
            const allStems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)];
            
            // 检查是否有食伤生财
            return allStems.some(stem => isShishang(dayElement, getStemElement(stem)));
        }
        
        function hasWealthDestruction(wealthStar, pillars) {
            const dayElement = getStemElement(pillars.day.charAt(0));
            const allStems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)];
            
            // 检查是否有比劫夺财
            return allStems.some(stem => {
                const stemElement = getStemElement(stem);
                return stemElement === dayElement; // 比劫同类
            });
        }
        
        function isWealthWeakened(wealthStar, pillars) {
            const wealthElement = getStemElement(wealthStar) || getBranchElement(wealthStar);
            const allElements = [];
            
            // 收集所有天干地支元素
            ['year', 'month', 'day', 'hour'].forEach(pos => {
                allElements.push(getStemElement(pillars[pos].charAt(0)));
                allElements.push(getBranchElement(pillars[pos].slice(1)));
            });
            
            // 检查是否被克或泄
            return allElements.some(element => {
                return isElementWeakening(element, wealthElement);
            });
        }
        
        function isElementSupporting(source, target) {
            const supportMap = {
                '木': ['火'], '火': ['土'], '土': ['金'], '金': ['水'], '水': ['木']
            };
            return supportMap[source]?.includes(target);
        }
        
        function isElementWeakening(source, target) {
             const weakenMap = {
                 '木': ['土'], '火': ['金'], '土': ['水'], '金': ['木'], '水': ['火']
             };
             const supportMap = {
                 '木': ['火'], '火': ['土'], '土': ['金'], '金': ['水'], '水': ['木']
             };
             return weakenMap[target]?.includes(source) || supportMap[target]?.includes(source);
         }
         
         // 新增：刑冲破害效果计算
         function calculateHarmEffects(pillars) {
             let harmFactor = 1.0;
             const branches = [pillars.year.slice(1), pillars.month.slice(1), pillars.day.slice(1), pillars.hour.slice(1)];
             
             // 相冲关系
             const chongPairs = [
                 ['子', '午'], ['丑', '未'], ['寅', '申'], ['卯', '酉'],
                 ['辰', '戌'], ['巳', '亥']
             ];
             
             // 相穿关系（六害）
             const chuanPairs = [
                 ['子', '未'], ['丑', '午'], ['寅', '巳'], ['卯', '辰'],
                 ['申', '亥'], ['酉', '戌']
             ];
             
             // 相刑关系
             const xingGroups = [
                 ['寅', '巳', '申'], // 无恩之刑
                 ['丑', '戌', '未'], // 恃势之刑
                 ['子', '卯']       // 无礼之刑
             ];
             
             // 检查相冲
             for (const pair of chongPairs) {
                 if (branches.includes(pair[0]) && branches.includes(pair[1])) {
                     // 财库逢冲是好事，其他冲一般不利
                     if (['辰', '戌', '丑', '未'].includes(pair[0]) || ['辰', '戌', '丑', '未'].includes(pair[1])) {
                         harmFactor *= 1.5; // 财库逢冲，冲开财库
                     } else {
                         harmFactor *= 0.8; // 其他冲减分
                     }
                 }
             }
             
             // 检查相穿（特别是申亥相穿）
             for (const pair of chuanPairs) {
                 if (branches.includes(pair[0]) && branches.includes(pair[1])) {
                     if ((pair[0] === '申' && pair[1] === '亥') || (pair[0] === '亥' && pair[1] === '申')) {
                         harmFactor *= 0.6; // 申亥相穿，严重减分
                     } else {
                         harmFactor *= 0.85; // 其他相穿
                     }
                 }
             }
             
             // 检查相刑
             for (const group of xingGroups) {
                 const presentCount = group.filter(branch => branches.includes(branch)).length;
                 if (presentCount >= 2) {
                     harmFactor *= Math.pow(0.9, presentCount - 1); // 相刑减分
                 }
             }
             
             return harmFactor;
         }
         
         // 新增：合化效果计算
         function calculateCombineEffects(pillars) {
             let combineFactor = 1.0;
             const branches = [pillars.year.slice(1), pillars.month.slice(1), pillars.day.slice(1), pillars.hour.slice(1)];
             
             // 六合关系
             const liuHePairs = [
                 ['子', '丑'], ['寅', '亥'], ['卯', '戌'],
                 ['辰', '酉'], ['巳', '申'], ['午', '未']
             ];
             
             // 三合局
             const sanHeGroups = [
                 ['申', '子', '辰'], // 水局
                 ['亥', '卯', '未'], // 木局
                 ['寅', '午', '戌'], // 火局
                 ['巳', '酉', '丑']  // 金局
             ];
             
             // 检查六合
             for (const pair of liuHePairs) {
                 if (branches.includes(pair[0]) && branches.includes(pair[1])) {
                     // 寅亥合化木，对财运有利
                     if ((pair[0] === '寅' && pair[1] === '亥') || (pair[0] === '亥' && pair[1] === '寅')) {
                         combineFactor *= 1.4; // 寅亥合化，化忌为喜
                     } else {
                         combineFactor *= 1.2; // 其他六合
                     }
                 }
             }
             
             // 检查三合局
             for (const group of sanHeGroups) {
                 const presentCount = group.filter(branch => branches.includes(branch)).length;
                 if (presentCount === 3) {
                     combineFactor *= 1.8; // 三合财局，大吉
                 } else if (presentCount === 2) {
                     combineFactor *= 1.3; // 半合局
                 }
             }
             
             return combineFactor;
          }
          
          // 新增：十神组合特效计算
          function calculateTenGodsEffects(pillars) {
              let bonus = 0;
              const dayElement = getStemElement(pillars.day.charAt(0));
              
              // 官星带财库检查
              const hasOfficer = ['year', 'month', 'hour'].some(pos => {
                  const stem = pillars[pos].charAt(0);
                  return isOfficer(dayElement, getStemElement(stem));
              });
              
              const hasWealthVault = ['year', 'month', 'day', 'hour'].some(pos => {
                  const branch = pillars[pos].slice(1);
                  return ['辰', '戌', '丑', '未'].includes(branch);
              });
              
              if (hasOfficer && hasWealthVault) {
                  bonus += 25; // 官星带财库
              }
              
              // 劫财夺财无制检查
              const robbingWealth = ['year', 'month', 'hour'].filter(pos => {
                  const stem = pillars[pos].charAt(0);
                  const stemElement = getStemElement(stem);
                  return stemElement === dayElement; // 比劫同类
              }).length;
              
              const hasControl = ['year', 'month', 'hour'].some(pos => {
                  const stem = pillars[pos].charAt(0);
                  return isOfficer(dayElement, getStemElement(stem)); // 有官杀制比劫
              });
              
              if (robbingWealth > 0 && !hasControl) {
                  bonus -= 20; // 劫财夺财无制
              }
              
              // 暗拱财局检查（简化版）
              const wealthStars = [];
              ['year', 'month', 'hour'].forEach(pos => {
                  const stem = pillars[pos].charAt(0);
                  if (isWealth(dayElement, getStemElement(stem))) {
                      wealthStars.push(pos);
                  }
              });
              
              if (wealthStars.length >= 2) {
                  // 检查是否有克制财星的因素
                  const hasWealthDestruction = ['year', 'month', 'hour'].some(pos => {
                      const stem = pillars[pos].charAt(0);
                      const stemElement = getStemElement(stem);
                      return wealthStars.some(wPos => {
                          const wealthStem = pillars[wPos].charAt(0);
                          const wealthElement = getStemElement(wealthStem);
                          return isElementWeakening(stemElement, wealthElement);
                      });
                  });
                  
                  if (hasWealthDestruction) {
                      bonus += 18; // 暗拱财局但受克
                  }
              }
              
              return bonus;
           }
           
           // 新增：否决条款检查
           function applyVetoRules(score, pillars) {
               let adjustedScore = score;
               const dayElement = getStemElement(pillars.day.charAt(0));
               
               // 1. 财星被合化忌神检查
               const wealthStars = [];
               ['year', 'month', 'hour'].forEach(pos => {
                   const stem = pillars[pos].charAt(0);
                   if (isWealth(dayElement, getStemElement(stem))) {
                       wealthStars.push({pos, stem});
                   }
               });
               
               // 检查财星是否被合化为忌神（简化版）
               const hasWealthCombinedToTaboo = wealthStars.some(wealth => {
                   // 检查申亥相穿等不利组合
                   const branches = [pillars.year.slice(1), pillars.month.slice(1), pillars.day.slice(1), pillars.hour.slice(1)];
                   return branches.includes('申') && branches.includes('亥');
               });
               
               if (hasWealthCombinedToTaboo) {
                   adjustedScore -= 50; // 财星被合化忌神，严重减分
               }
               
               // 2. 全局无明现财库检查
               const hasWealthVault = ['year', 'month', 'day', 'hour'].some(pos => {
                   const branch = pillars[pos].slice(1);
                   return ['辰', '戌', '丑', '未'].includes(branch);
               });
               
               if (!hasWealthVault) {
                   adjustedScore = Math.min(67, adjustedScore); // 无财库，分数封顶67
               }
               
               // 3. 比劫夺财无制检查
               const robbingWealth = ['year', 'month', 'hour'].filter(pos => {
                   const stem = pillars[pos].charAt(0);
                   const stemElement = getStemElement(stem);
                   return stemElement === dayElement; // 比劫同类
               }).length;
               
               const hasControl = ['year', 'month', 'hour'].some(pos => {
                   const stem = pillars[pos].charAt(0);
                   return isOfficer(dayElement, getStemElement(stem)); // 有官杀制比劫
               });
               
               if (robbingWealth > 1 && !hasControl) {
                   // 比劫夺财无制，财富等级自动降一级
                   adjustedScore *= 0.8;
               }
               
               // 4. 身不胜财否决条款
               const dayStrength = calculateSimpleDayStrength(pillars);
               const wealthCount = ['year', 'month', 'hour'].filter(pos => {
                   const stem = pillars[pos].charAt(0);
                   return isWealth(dayElement, getStemElement(stem));
               }).length;
               const biJieCount = countBiJieStars(pillars);
               
               // 财多身弱且无比劫帮身的情况，限制最高分数
               // 但排除真从财格（日主极弱且财星极多的情况）
               if (dayStrength < 40 && wealthCount >= 3 && biJieCount === 0 && !(dayStrength <= 35 && wealthCount >= 4)) {
                   adjustedScore = Math.min(adjustedScore, 60); // 身不胜财最高60分
               }
               
               return Math.max(0, Math.round(adjustedScore));
            }
            
            // 新增：特殊格局识别模块
            function identifySpecialPatterns(pillars) {
                const dayElement = getStemElement(pillars.day.charAt(0));
                const patterns = [];
                
                // 1. 从财格识别 - 修正版
                let wealthCount = 0;
                ['year', 'month', 'day', 'hour'].forEach(pos => {
                    const stem = pillars[pos].charAt(0);
                    const branch = pillars[pos].charAt(1);
                    if (isWealth(dayElement, getStemElement(stem))) wealthCount++;
                    if (isWealth(dayElement, getBranchElement(branch))) wealthCount++;
                });
                
                const biJieCount = countBiJieStars(pillars);
                const yinCount = countYinStars(pillars);
                
                if (wealthCount >= 2 && biJieCount === 0 && yinCount <= 1) {
                    const dayStrength = calculateSimpleDayStrength(pillars);
                    const wealthStrength = calculateWealthStrength(pillars);
                    
                    // 真从财格：日主极弱(≤35)且财星数量多(≥4)
                    if (dayStrength <= 35 && wealthCount >= 4) {
                        patterns.push({
                            name: '真从财格',
                            description: '日主极弱从财星之势，富贵可期',
                            bonus: 20 // 调整真从财格奖励，避免得分过高
                        });
                    }
                    // 假从财格：日主较弱但财星较多
                    else if (dayStrength <= 50 && wealthCount >= 3) {
                        patterns.push({
                            name: '假从财格',
                            description: '日主偏弱，财星较旺，中等富贵',
                            bonus: 12 // 调整假从财格奖励
                        });
                    }
                    // 身不胜财：财多身弱的不利格局
                    else {
                        patterns.push({
                            name: '身不胜财',
                            description: '财星过多，日主承载不足',
                            bonus: -15
                        });
                    }
                }
                
                // 2. 从杀格识别
                const officerCount = ['year', 'month', 'hour'].filter(pos => {
                    const stem = pillars[pos].charAt(0);
                    return isOfficer(dayElement, getStemElement(stem));
                }).length;
                
                if (officerCount >= 2 && biJieCount === 0 && yinCount === 0) {
                    patterns.push({
                        name: '从杀格',
                        description: '日主从官杀之势，权贵之命',
                        bonus: 25
                    });
                }
                
                // 3. 化气格识别（超严格版）- 需要多重条件同时满足
                const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.day.charAt(0), pillars.hour.charAt(0)];
                const chemicalCombinations = [
                    ['甲', '己', '土'], ['乙', '庚', '金'], ['丙', '辛', '水'], ['丁', '壬', '木'], ['戊', '癸', '火']
                ];
                
                // 严格化气格条件：
                // 1. 日干必须参与化合（月日化合或日时化合）
                // 2. 化神必须在天干中透出
                // 3. 化神得月令旺气
                // 4. 无明显破格因素
                
                const dayIndex = 2; // 日干在stems数组中的位置
                const dayStem = stems[dayIndex];
                
                for (const [stem1, stem2, element] of chemicalCombinations) {
                    let isValidChemical = false;
                    let chemicalDescription = '';
                    
                    // 只认可日干参与的化合：月日化合或日时化合
                    if (dayStem === stem1) {
                        if (stems[1] === stem2) { // 月日化合
                            isValidChemical = true;
                            chemicalDescription = '月日化合';
                        } else if (stems[3] === stem2) { // 日时化合
                            isValidChemical = true;
                            chemicalDescription = '日时化合';
                        }
                    } else if (dayStem === stem2) {
                        if (stems[1] === stem1) { // 月日化合
                            isValidChemical = true;
                            chemicalDescription = '月日化合';
                        } else if (stems[3] === stem1) { // 日时化合
                            isValidChemical = true;
                            chemicalDescription = '日时化合';
                        }
                    }
                    
                    if (isValidChemical) {
                        // 检查化神是否透出
                        const chemicalElementStems = {
                            '土': ['戊', '己'],
                            '金': ['庚', '辛'],
                            '水': ['壬', '癸'],
                            '木': ['甲', '乙'],
                            '火': ['丙', '丁']
                        };
                        
                        const hasChemicalStemTransparent = stems.some(stem => 
                            chemicalElementStems[element] && chemicalElementStems[element].includes(stem)
                        );
                        
                        // 检查化神是否得月令之气
                        const monthBranch = pillars.month.slice(1);
                        const monthElement = getBranchElement(monthBranch);
                        const isChemicalSupported = monthElement === element || isGenerateElement(monthElement, element);
                        
                        // 只有同时满足化神透出且得月令之气才认定为化气格
                        if (hasChemicalStemTransparent && isChemicalSupported) {
                            patterns.push({
                                name: '化气格',
                                description: `${stem1}${stem2}化${element}（${chemicalDescription}），化神透出得令`,
                                bonus: 18
                            });
                        }
                        break;
                    }
                }
                
                // 4. 专旺格识别
                const dayBranch = pillars.day.slice(1);
                const monthBranch = pillars.month.slice(1);
                
                // 曲直格（木专旺）
                if (dayElement === '木' && ['寅', '卯'].includes(monthBranch)) {
                    const woodCount = [pillars.year.slice(1), pillars.month.slice(1), pillars.day.slice(1), pillars.hour.slice(1)]
                        .filter(branch => ['寅', '卯', '辰'].includes(branch)).length;
                    if (woodCount >= 3) {
                        patterns.push({
                            name: '曲直格',
                            description: '木气专旺，文贵之命',
                            bonus: 15
                        });
                    }
                }
                
                // 炎上格（火专旺）
                if (dayElement === '火' && ['巳', '午'].includes(monthBranch)) {
                    const fireCount = [pillars.year.slice(1), pillars.month.slice(1), pillars.day.slice(1), pillars.hour.slice(1)]
                        .filter(branch => ['巳', '午', '未'].includes(branch)).length;
                    if (fireCount >= 3) {
                        patterns.push({
                            name: '炎上格',
                            description: '火气专旺，威权之命',
                            bonus: 15
                        });
                    }
                }
                
                return patterns;
            }
           
           // 获取旺衰系数
        function getSeasonCoefficient(stem, branch, monthBranch) {
            // 简化的旺衰判断
            if (isDayStemInSeason(stem, monthBranch)) {
                return 2.0; // 得令
            }
            
            // 根据五行生克关系判断
            const stemElement = getStemElement(stem);
            const monthElement = getBranchElement(monthBranch);
            
            if (isElementSupported(stemElement, monthElement)) {
                return 1.5; // 得地
            } else if (isElementNeutral(stemElement, monthElement)) {
                return 1.0; // 平和
            } else {
                return 0.6; // 失令
            }
        }
        
        // 获取天干五行
        function getStemElement(stem) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            return elementMap[stem] || '土';
        }
        
        // 获取地支五行
        function getBranchElement(branch) {
            const elementMap = {
                '寅': '木', '卯': '木',
                '巳': '火', '午': '火',
                '申': '金', '酉': '金',
                '亥': '水', '子': '水',
                '辰': '土', '戌': '土', '丑': '土', '未': '土'
            };
            return elementMap[branch] || '土';
        }
        
        // 判断五行是否得生
        function isElementSupported(element, monthElement) {
            const supportMap = {
                '木': ['水'],
                '火': ['木'],
                '土': ['火'],
                '金': ['土'],
                '水': ['金']
            };
            return supportMap[element]?.includes(monthElement) || false;
        }
        
        // 判断五行是否中性
        function isElementNeutral(element, monthElement) {
            return element !== monthElement && !isElementSupported(element, monthElement) && !isElementWeakened(element, monthElement);
        }
        
        // 判断五行是否被克
        function isElementWeakened(element, monthElement) {
            const weakenMap = {
                '木': ['金'],
                '火': ['水'],
                '土': ['木'],
                '金': ['火'],
                '水': ['土']
            };
            return weakenMap[element]?.includes(monthElement) || false;
        }

        // 判断财星是否有利
        function isFavorableWealth(dayStem, wealthStem) {
            const dayElement = getStemElement(dayStem);
            const wealthElement = getStemElement(wealthStem);
            return isElementSupported(dayElement, wealthElement) || dayElement === wealthElement;
        }

        // 计算财星位置分数 (20分) - 优化版
        function calculateWealthPosition(pillars) {
            let score = 0;
            const dayStem = pillars.day.charAt(0);
            const dayStrength = calculateSimpleDayStrength(pillars);
            const zhengCai = getZhengCai(dayStem);
            const pianCai = getPianCai(dayStem);
            const wealthBranches = getWealthBranches(dayStem);

            // 月令财星 - 财气通门户
            if (pillars.month.charAt(0) === zhengCai || pillars.month.charAt(0) === pianCai) {
                score += 12; // 月干见财
            }
            if (wealthBranches.includes(pillars.month.charAt(1))) {
                score += 15; // 月支见财，财气通门户
            }
            
            // 时上偏财格 - 晚年富贵
            if (pillars.hour.charAt(0) === pianCai) {
                score += 10; // 时上偏财，晚年发达
            }
            
            // 日坐财星 - 配偶助财
            if (wealthBranches.includes(pillars.day.charAt(1))) {
                score += 8; // 日支见财，配偶助财
                if (dayStrength >= 60) {
                    score += 5; // 身强坐财更佳
                }
            }
            
            // 年柱财星 - 祖业或早年财运
            if (pillars.year.charAt(0) === zhengCai || pillars.year.charAt(0) === pianCai) {
                score += 6; // 年干见财
            }

            return Math.min(20, score);
        }

        // 计算财星强度分数 (20分)
        function calculateWealthStrength(pillars) {
            // 优先使用 currentBaziData 提供的月令信息
            let monthBranch = pillars.month.charAt(1);
            if (window.currentBaziData && window.currentBaziData.pillars && typeof window.currentBaziData.pillars.month === 'string') {
                const mb = window.currentBaziData.pillars.month;
                if (mb.length > 1) monthBranch = mb.charAt(1);
            }
            
            let score = 0;
            const dayStem = pillars.day.charAt(0);
            const wealthStems = [getZhengCai(dayStem), getPianCai(dayStem)];

            wealthStems.forEach(stem => {
                const coeff = getSeasonCoefficient(stem, '', monthBranch);
                score += coeff * 5;
            });

            return Math.min(8, Math.round(score)); // 降低上限到8分
        }

        // 计算财富库分数 (10分) - 优化版
        function calculateWealthVault(pillars) {
            const dayStem = pillars.day.charAt(0);
            const dayElement = getStemElement(dayStem);
            const vaults = ['辰', '戌', '丑', '未'];
            let score = 0;
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            
            // 财库的定义：土为甲乙木的财库，金为丙丁火的财库等
            const wealthVaultMap = {
                '甲': ['辰', '戌', '丑', '未'], // 土库
                '乙': ['辰', '戌', '丑', '未'],
                '丙': ['申', '酉'], // 金库（简化）
                '丁': ['申', '酉'],
                '戊': ['子', '亥'], // 水库（简化）
                '己': ['子', '亥'],
                '庚': ['寅', '卯'], // 木库（简化）
                '辛': ['寅', '卯'],
                '壬': ['午', '巳'], // 火库（简化）
                '癸': ['午', '巳']
            };
            
            const myWealthVaults = wealthVaultMap[dayStem] || [];
            let vaultCount = 0;
            
            branches.forEach((branch, index) => {
                if (myWealthVaults.includes(branch)) {
                    vaultCount++;
                    if (index === 1) score += 5; // 月支财库最重要
                    else if (index === 2) score += 4; // 日支财库
                    else score += 2; // 年时财库
                }
            });
            
            // 财库逢冲 - 冲开财库发大财
            const chongMap = {
                '辰': '戌', '戌': '辰', '丑': '未', '未': '丑',
                '子': '午', '午': '子', '卯': '酉', '酉': '卯',
                '寅': '申', '申': '寅', '巳': '亥', '亥': '巳'
            };
            
            branches.forEach(branch1 => {
                if (myWealthVaults.includes(branch1)) {
                    branches.forEach(branch2 => {
                        if (chongMap[branch1] === branch2) {
                            score += 8; // 财库逢冲，财富爆发
                        }
                    });
                }
            });
            
            // 四库俱全特殊加分
            const uniqueVaults = new Set(branches.filter(b => vaults.includes(b)));
            if (uniqueVaults.size === 4) score += 6; // 四库俱全，财富丰厚
            
            return Math.min(8, score); // 降低上限到8分
        }
        
        // 计算自坐财库 (10分)
        function calculateSelfSittingVault(pillars) {
            const dayElement = getStemElement(pillars.day.charAt(0));
            const dayBranch = pillars.day.charAt(1);
            const vaults = ['辰', '戌', '丑', '未'];
            const vaultElements = { '辰': '土', '戌': '土', '丑': '土', '未': '土' };
            if (vaults.includes(dayBranch) && isWealth(dayElement, vaultElements[dayBranch])) {
                return 8; // 降低自坐财库分数
            }
            return 0;
        }
        
        // 计算财气通门户 (5分) - 优化版
        function calculateWealthPortal(pillars) {
            const dayStrength = calculateSimpleDayStrength(pillars);
            const monthBranch = pillars.month.charAt(1);
            const dayStem = pillars.day.charAt(0);
            const wealthBranches = getWealthBranches(dayStem);
            
            let score = 0;
            
            // 月令财星 - 财气通门户的核心
            if (wealthBranches.includes(monthBranch)) {
                score += 15; // 月令见财，财气通门户
                
                // 身强配财星更佳
                if (dayStrength >= 60) {
                    score += 8; // 身强能胜财
                }
                
                // 有食伤生财更佳
                const hasShishang = calculateShishangEnergy(pillars) > 0;
                if (hasShishang) {
                    score += 5; // 食伤生财，源源不断
                }
            }
            
            // 时柱见财星 - 晚年富贵
            const hourBranch = pillars.hour.charAt(1);
            if (wealthBranches.includes(hourBranch)) {
                score += 8; // 时上见财，晚年富足
            }
            
            return Math.min(8, score); // 降低上限到8分
        }
        
        // 计算从财格分数 - 已废弃，统一由identifySpecialPatterns处理
        function calculateFromWealthGrid(pillars) {
            // 从财格识别已统一由identifySpecialPatterns函数处理
            // 避免重复计分，此函数返回0
            return 0;
        }
        
        // 新函数：检查官杀存在
        function calculateOfficerPresence(pillars) {
            const dayElement = getStemElement(pillars.day.charAt(0));
            let presence = 0;
            const positions = ['year', 'month', 'day', 'hour'];
            positions.forEach(pos => {
                const stem = pillars[pos].charAt(0);
                if (isOfficer(dayElement, getStemElement(stem))) presence += 1;
            });
            return presence;
        }
        
        // 新辅助函数：判断是否官杀
        function isOfficer(dayElement, element) {
            const officerMap = {
                '木': ['金'], '火': ['水'], '土': ['木'], '金': ['火'], '水': ['土']
            };
            return officerMap[dayElement]?.includes(element);
        }
                
        
        // 计算比劫星数量
        function countBiJieStars(pillars) {
            const dayStem = pillars.day.charAt(0);
            const biJieStars = getBiJieStars(dayStem);
            const allChars = [
                pillars.year.charAt(0), pillars.year.charAt(1),
                pillars.month.charAt(0), pillars.month.charAt(1),
                pillars.hour.charAt(0), pillars.hour.charAt(1)
            ];
            return allChars.filter(char => biJieStars.includes(char)).length;
        }
        
        // 计算印星数量
        function countYinStars(pillars) {
            const dayStem = pillars.day.charAt(0);
            const yinStars = getYinStars(dayStem);
            const allChars = [
                pillars.year.charAt(0), pillars.year.charAt(1),
                pillars.month.charAt(0), pillars.month.charAt(1),
                pillars.hour.charAt(0), pillars.hour.charAt(1)
            ];
            return allChars.filter(char => yinStars.includes(char)).length;
        }
        
        // 计算身财平衡调整 (-10 to +10) - 优化版
        // 升级版身财平衡算法 - 非线性阈值计算
        function calculateBodyWealthBalance(pillars) {
            const dayStrength = calculateSimpleDayStrength(pillars);
            const wealthStrength = calculateWealthStrength(pillars);
            
            // 计算承载系数
            const carryingCapacity = wealthStrength > 0 ? dayStrength / wealthStrength : dayStrength / 50;
            
            let balanceScore = 0;
            
            // 非线性阈值算法
            if (carryingCapacity > 1.5) {
                // 身强财弱，承载力过剩
                balanceScore = Math.min(15, carryingCapacity * 5);
            } else if (carryingCapacity >= 0.8 && carryingCapacity <= 1.5) {
                // 身财平衡，最佳状态
                balanceScore = carryingCapacity * 10;
            } else {
                // 身弱财强，承载不足
                balanceScore = -10 + (carryingCapacity - 0.5) * 20;
            }
            
            // 特殊格局修正 - 移除重复的从财格判断
            if (carryingCapacity < 0.3) {
                // 身极弱财极强的情况，由identifySpecialPatterns统一处理
                // 这里只做基础的身财平衡计算
                balanceScore = -10; // 身弱财强，承载不足
            }
            
            // 身强财旺特殊加分
            if (dayStrength >= 70 && wealthStrength >= 70) {
                balanceScore += 5; // 身强财旺，额外加分
            }
            
            return Math.max(-20, Math.min(20, Math.round(balanceScore)));
        }
        
        // 简化的日主强度计算 - 优先使用已计算的身强身弱分析
        function calculateSimpleDayStrength(pillars) {
            // 优先使用已计算的身强身弱分析结果
            if (window.currentBaziData && window.currentBaziData.strengthAnalysis) {
                const analysis = window.currentBaziData.strengthAnalysis;
                
                // 将身强身弱类型转换为数值
                let strength = 50; // 默认中等
                
                switch(analysis.type) {
                    case '身强':
                        strength = 75;
                        break;
                    case '身弱':
                        strength = 25;
                        break;
                    case '从强':
                        strength = 85;
                        break;
                    case '从弱':
                        strength = 15;
                        break;
                    case '化气':
                        strength = 60;
                        break;
                    default:
                        // 使用力量比例计算
                        if (analysis.ratio !== undefined) {
                            strength = Math.round(analysis.ratio * 100);
                        }
                }
                
                return Math.max(10, Math.min(100, strength));
            }
            
            // 备用计算方法（原有逻辑）
            const dayStem = pillars.day.charAt(0);
            const monthBranch = pillars.month.charAt(1);
            
            let strength = 40; // 基础值
            
            // 月令对日主的影响 (最重要)
            if (isDayStemInSeason(dayStem, monthBranch)) {
                strength += 25; // 日主当令
            } else if (isDayStemSupported(dayStem, monthBranch)) {
                strength += 15; // 日主得生
            } else {
                strength -= 10; // 日主失令
            }
            
            // 其他柱的比劫帮身
            const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)];
            const biJieStars = getBiJieStars(dayStem);
            
            stems.forEach(stem => {
                if (biJieStars.includes(stem)) {
                    strength += 12; // 比劫帮身
                }
            });
            
            // 印星生身
            const yinStars = getYinStars(dayStem);
            stems.forEach(stem => {
                if (yinStars.includes(stem)) {
                    strength += 10; // 印星生身
                }
            });
            
            return Math.max(10, Math.min(100, strength));
        }
        
        // 判断日主是否当令
        function isDayStemInSeason(dayStem, monthBranch) {
            const seasonMap = {
                '甲': ['寅', '卯'], '乙': ['寅', '卯'], // 木旺于春
                '丙': ['午', '巳'], '丁': ['午', '巳'], // 火旺于夏
                '戊': ['辰', '戌', '丑', '未'], '己': ['辰', '戌', '丑', '未'], // 土旺于四季
                '庚': ['申', '酉'], '辛': ['申', '酉'], // 金旺于秋
                '壬': ['子', '亥'], '癸': ['子', '亥']  // 水旺于冬
            };
            return seasonMap[dayStem]?.includes(monthBranch) || false;
        }
        
        // 判断日主是否得生
        function isDayStemSupported(dayStem, monthBranch) {
            const supportMap = {
                '甲': ['子', '亥'], '乙': ['子', '亥'], // 水生木
                '丙': ['寅', '卯'], '丁': ['寅', '卯'], // 木生火
                '戊': ['午', '巳'], '己': ['午', '巳'], // 火生土
                '庚': ['辰', '戌', '丑', '未'], '辛': ['辰', '戌', '丑', '未'], // 土生金
                '壬': ['申', '酉'], '癸': ['申', '酉']  // 金生水
            };
            return supportMap[dayStem]?.includes(monthBranch) || false;
        }
        
        // 判断财星是否当令
        function isWealthInSeason(dayStem, monthBranch) {
            const wealthSeasonMap = {
                '甲': ['辰', '戌', '丑', '未'], '乙': ['辰', '戌', '丑', '未'], // 土财旺于四季
                '丙': ['申', '酉'], '丁': ['申', '酉'], // 金财旺于秋
                '戊': ['子', '亥'], '己': ['子', '亥'], // 水财旺于冬
                '庚': ['寅', '卯'], '辛': ['寅', '卯'], // 木财旺于春
                '壬': ['午', '巳'], '癸': ['午', '巳']  // 火财旺于夏
            };
            return wealthSeasonMap[dayStem]?.includes(monthBranch) || false;
        }
        
        // 获取月令对日主的支持度
        function getMonthSupport(dayStem, monthBranch) {
            const supportMap = {
                '甲': { '寅': 20, '卯': 15, '子': 10, '亥': 8, '辰': 5, '未': 5 },
                '乙': { '卯': 20, '寅': 15, '亥': 10, '子': 8, '辰': 5, '未': 5 },
                '丙': { '午': 20, '巳': 15, '寅': 10, '卯': 8, '戌': 5, '未': 5 },
                '丁': { '巳': 20, '午': 15, '卯': 10, '寅': 8, '戌': 5, '未': 5 },
                '戊': { '戌': 20, '未': 15, '午': 10, '巳': 8, '辰': 5, '丑': 5 },
                '己': { '未': 20, '戌': 15, '巳': 10, '午': 8, '丑': 5, '辰': 5 },
                '庚': { '申': 20, '酉': 15, '戌': 10, '未': 8, '辰': 5, '丑': 5 },
                '辛': { '酉': 20, '申': 15, '未': 10, '戌': 8, '丑': 5, '辰': 5 },
                '壬': { '子': 20, '亥': 15, '申': 10, '酉': 8, '辰': 5, '丑': 5 },
                '癸': { '亥': 20, '子': 15, '酉': 10, '申': 8, '丑': 5, '辰': 5 }
            };
            
            return supportMap[dayStem] && supportMap[dayStem][monthBranch] ? supportMap[dayStem][monthBranch] : -10;
        }
        
        // 获取支持日主的星
        function getSupportStars(dayStem) {
            const supportMap = {
                '甲': ['甲', '乙', '寅', '卯', '壬', '癸', '子', '亥'], // 比劫 + 印星
                '乙': ['甲', '乙', '寅', '卯', '壬', '癸', '子', '亥'],
                '丙': ['丙', '丁', '午', '巳', '甲', '乙', '寅', '卯'],
                '丁': ['丙', '丁', '午', '巳', '甲', '乙', '寅', '卯'],
                '戊': ['戊', '己', '辰', '戌', '丑', '未', '丙', '丁', '午', '巳'],
                '己': ['戊', '己', '辰', '戌', '丑', '未', '丙', '丁', '午', '巳'],
                '庚': ['庚', '辛', '申', '酉', '戊', '己', '辰', '戌', '丑', '未'],
                '辛': ['庚', '辛', '申', '酉', '戊', '己', '辰', '戌', '丑', '未'],
                '壬': ['壬', '癸', '子', '亥', '庚', '辛', '申', '酉'],
                '癸': ['壬', '癸', '子', '亥', '庚', '辛', '申', '酉']
            };
            return supportMap[dayStem] || [];
        }
        
        // 计算财星强度分数 - 100分制版 (20分) - 保留作为备用
        function calculateWealthStarScore(pillars) {
            const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
            const monthStr = typeof pillars.month === 'string' ? pillars.month : String(pillars.month);
            const yearStr = typeof pillars.year === 'string' ? pillars.year : String(pillars.year);
            const hourStr = typeof pillars.hour === 'string' ? pillars.hour : String(pillars.hour);
            
            const dayStem = dayStr.charAt(0);
            const dayBranch = dayStr.charAt(1);
            const monthBranch = monthStr.charAt(1);
            
            let score = 5; // 基础分数
            
            // 1. 正财偏财透干得分 (最高10分)
            const zhengCai = getZhengCai(dayStem);
            const pianCai = getPianCai(dayStem);
            const stems = [yearStr.charAt(0), monthStr.charAt(0), hourStr.charAt(0)];
            
            let zhengCaiCount = 0;
            let pianCaiCount = 0;
            stems.forEach(stem => {
                if (stem === zhengCai) zhengCaiCount++;
                if (stem === pianCai) pianCaiCount++;
            });
            
            // 正财透干评分
            if (zhengCaiCount >= 2) score += 10;
            else if (zhengCaiCount === 1) score += 8;
            
            // 偏财透干评分
            if (pianCaiCount >= 2) score += 8;
            else if (pianCaiCount === 1) score += 6;
            
            // 2. 财星在地支的强度 (最高7分)
            const wealthBranches = getWealthBranches(dayStem);
            const branches = [yearStr.charAt(1), monthStr.charAt(1), dayStr.charAt(1), hourStr.charAt(1)];
            
            let branchWealthCount = 0;
            branches.forEach(branch => {
                if (wealthBranches.includes(branch)) {
                    branchWealthCount++;
                }
            });
            
            // 地支财星评分
            if (branchWealthCount >= 3) score += 7;
            else if (branchWealthCount === 2) score += 5;
            else if (branchWealthCount === 1) score += 3;
            
            // 3. 财星得月令之气 (最高5分)
            if (wealthBranches.includes(monthBranch)) {
                score += 5;
            } else if (isWealthSeasonallyStrong(dayStem, monthBranch)) {
                score += 3;
            }
            
            return Math.min(20, score);
        }

        // 获取正财
        function getZhengCai(dayStem) {
            const zhengCaiMap = {
                '甲': '己', '乙': '戊', '丙': '辛', '丁': '庚',
                '戊': '癸', '己': '壬', '庚': '乙', '辛': '甲',
                '壬': '丁', '癸': '丙'
            };
            return zhengCaiMap[dayStem] || '';
        }
        
        // 获取偏财
        function getPianCai(dayStem) {
            const pianCaiMap = {
                '甲': '戊', '乙': '己', '丙': '庚', '丁': '辛',
                '戊': '壬', '己': '癸', '庚': '甲', '辛': '乙',
                '壬': '丙', '癸': '丁'
            };
            return pianCaiMap[dayStem] || '';
        }
        
        // 获取财星地支
        function getWealthBranches(dayStem) {
            const wealthBranchMap = {
                '甲': ['辰', '戌', '丑', '未'], // 土为财
                '乙': ['辰', '戌', '丑', '未'],
                '丙': ['申', '酉'],             // 金为财
                '丁': ['申', '酉'],
                '戊': ['子', '亥'],             // 水为财
                '己': ['子', '亥'],
                '庚': ['寅', '卯'],             // 木为财
                '辛': ['寅', '卯'],
                '壬': ['午', '巳'],             // 火为财
                '癸': ['午', '巳']
            };
            return wealthBranchMap[dayStem] || [];
        }
        
        // 判断财星是否得季节之气
        function isWealthSeasonallyStrong(dayStem, monthBranch) {
            const seasonMap = {
                '甲': ['辰', '戌', '丑', '未'], // 土旺于四季月
                '乙': ['辰', '戌', '丑', '未'],
                '丙': ['申', '酉'],             // 金旺于秋
                '丁': ['申', '酉'],
                '戊': ['子', '亥'],             // 水旺于冬
                '己': ['子', '亥'],
                '庚': ['寅', '卯'],             // 木旺于春
                '辛': ['寅', '卯'],
                '壬': ['午', '巳'],             // 火旺于夏
                '癸': ['午', '巳']
            };
            return seasonMap[dayStem]?.includes(monthBranch) || false;
        }

        // 计算财富格局 - 基于专业命理格局理论 (40分)
        function calculateWealthPattern(pillars) {
            const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
            const monthStr = typeof pillars.month === 'string' ? pillars.month : String(pillars.month);
            const yearStr = typeof pillars.year === 'string' ? pillars.year : String(pillars.year);
            const hourStr = typeof pillars.hour === 'string' ? pillars.hour : String(pillars.hour);
            
            const dayStem = dayStr.charAt(0);
            const monthBranch = monthStr.charAt(1);
            let score = 0;
            
            // 1. 财气通门户 (月令财星) - 基础50分转换为20分
            const wealthBranches = getWealthBranches(dayStem);
            if (wealthBranches.includes(monthBranch)) {
                score += 20; // 财气通门户，财运根基深厚
            }
            
            // 2. 财星组合评分
            const zhengCai = getZhengCai(dayStem);
            const pianCai = getPianCai(dayStem);
            const allStems = [yearStr.charAt(0), monthStr.charAt(0), hourStr.charAt(0)];
            
            // 财星得食伤生 (每组合+8分，原20分压缩)
            const shiShangStars = getShiShangStars(dayStem);
            let shiShangCount = 0;
            let wealthCount = 0;
            
            allStems.forEach(stem => {
                if (shiShangStars.includes(stem)) shiShangCount++;
                if (stem === zhengCai || stem === pianCai) wealthCount++;
            });
            
            if (shiShangCount > 0 && wealthCount > 0) {
                score += 8; // 食伤生财组合
            }
            
            // 财星合入日主 (甲己合等) - 12分
            const mergePartner = getWealthMergePartner(dayStem);
            if (allStems.includes(mergePartner)) {
                score += 12; // 财星合身，财缘深厚
            }
            
            // 财星被比劫争夺 (每处-6分，原15分压缩)
            const biJieStars = getBiJieStars(dayStem);
            let biJieCount = 0;
            allStems.forEach(stem => {
                if (biJieStars.includes(stem)) biJieCount++;
            });
            
            if (biJieCount > 0 && wealthCount > 0) {
                score -= Math.min(biJieCount * 6, 12); // 比劫夺财，最多扣12分
            }
            
            // 3. 特殊格局判断
            const totalStems = [dayStem, ...allStems];
            const wealthStarRatio = totalStems.filter(stem => stem === zhengCai || stem === pianCai).length / totalStems.length;
            
            // 从财格 (财星占比>50%) - 32分 (原80分压缩)
            if (wealthStarRatio > 0.5) {
                score += 32;
            }
            
            // 财滋杀格 (财生杀有制化) - 16分 (原40分压缩)
            const officialStars = getGuanShaStars(dayStem);
            let hasOfficial = false;
            allStems.forEach(stem => {
                if (officialStars.includes(stem)) hasOfficial = true;
            });
            
            if (hasOfficial && wealthCount > 0) {
                score += 16; // 财滋杀格
            }
            
            // 伤官生财 (无官星混杂) - 24分 (原60分压缩)
            if (shiShangCount > 0 && wealthCount > 0 && !hasOfficial) {
                score += 24; // 伤官生财，清纯有力
            }
            
            return Math.max(0, Math.min(40, score));
        }
        
        // 获取财星合化对象
        function getWealthMergePartner(dayStem) {
            const mergeMap = {
                '甲': '己', '己': '甲', // 甲己合土
                '乙': '庚', '庚': '乙', // 乙庚合金
                '丙': '辛', '辛': '丙', // 丙辛合水
                '丁': '壬', '壬': '丁', // 丁壬合木
                '戊': '癸', '癸': '戊'  // 戊癸合火
            };
            
            const partner = mergeMap[dayStem];
            const zhengCai = getZhengCai(dayStem);
            const pianCai = getPianCai(dayStem);
            
            // 只有当合化对象是财星时才算财星合身
            if (partner === zhengCai || partner === pianCai) {
                return partner;
            }
            return null;
        }
        
        // 计算五行流通性
        function calculateElementFlow(pillars) {
            const elements = {
                '甲': '木', '乙': '木', '寅': '木', '卯': '木',
                '丙': '火', '丁': '火', '午': '火', '巳': '火',
                '戊': '土', '己': '土', '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '庚': '金', '辛': '金', '申': '金', '酉': '金',
                '壬': '水', '癸': '水', '子': '水', '亥': '水'
            };
            
            const allChars = [
                pillars.year.charAt(0), pillars.year.charAt(1),
                pillars.month.charAt(0), pillars.month.charAt(1),
                pillars.day.charAt(0), pillars.day.charAt(1),
                pillars.hour.charAt(0), pillars.hour.charAt(1)
            ];
            
            const elementCount = {};
            allChars.forEach(char => {
                const element = elements[char];
                if (element) {
                    elementCount[element] = (elementCount[element] || 0) + 1;
                }
            });
            
            const presentElements = Object.keys(elementCount);
            let flowScore = 0;
            
            // 五行齐全加分
            if (presentElements.length >= 4) flowScore += 4;
            else if (presentElements.length >= 3) flowScore += 2;
            
            // 相生关系加分
            const shengRelations = [
                ['木', '火'], ['火', '土'], ['土', '金'], ['金', '水'], ['水', '木']
            ];
            
            shengRelations.forEach(([from, to]) => {
                if (elementCount[from] && elementCount[to]) {
                    flowScore += 1;
                }
            });
            
            return flowScore;
        }
        
        // 获取印星
        function getYinStars(dayStem) {
            const yinMap = {
                '甲': ['壬', '癸', '子', '亥'], // 水生木
                '乙': ['壬', '癸', '子', '亥'],
                '丙': ['甲', '乙', '寅', '卯'], // 木生火
                '丁': ['甲', '乙', '寅', '卯'],
                '戊': ['丙', '丁', '午', '巳'], // 火生土
                '己': ['丙', '丁', '午', '巳'],
                '庚': ['戊', '己', '辰', '戌', '丑', '未'], // 土生金
                '辛': ['戊', '己', '辰', '戌', '丑', '未'],
                '壬': ['庚', '辛', '申', '酉'], // 金生水
                '癸': ['庚', '辛', '申', '酉']
            };
            return yinMap[dayStem] || [];
        }
        
        // 获取官星
        function getOfficialStars(dayStem) {
            const officialMap = {
                '甲': ['庚', '辛', '申', '酉'], // 金克木
                '乙': ['庚', '辛', '申', '酉'],
                '丙': ['壬', '癸', '子', '亥'], // 水克火
                '丁': ['壬', '癸', '子', '亥'],
                '戊': ['甲', '乙', '寅', '卯'], // 木克土
                '己': ['甲', '乙', '寅', '卯'],
                '庚': ['丙', '丁', '午', '巳'], // 火克金
                '辛': ['丙', '丁', '午', '巳'],
                '壬': ['戊', '己', '辰', '戌', '丑', '未'], // 土克水
                '癸': ['戊', '己', '辰', '戌', '丑', '未']
            };
            return officialMap[dayStem] || [];
        }
        
        // 计算财星位置分数 - 重新设计版 (25分) - 保留作为备用
        function calculateWealthPositionScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            const dayBranch = pillars.day.charAt(1);
            const monthBranch = pillars.month.charAt(1);
            const hourBranch = pillars.hour.charAt(1);
            const yearBranch = pillars.year.charAt(1);
            
            let score = 5; // 基础分数
            
            // 1. 财星居月令 (最重要位置，8分)
            const wealthBranches = getWealthBranches(dayStem);
            if (wealthBranches.includes(monthBranch)) {
                score += 8;
            }
            
            // 2. 财星居时柱 (财库位置，6分)
            if (wealthBranches.includes(hourBranch)) {
                score += 6;
            }
            
            // 3. 财星居年柱 (祖业财，4分)
            if (wealthBranches.includes(yearBranch)) {
                score += 4;
            }
            
            // 4. 财星居日支 (配偶宫财，3分)
            if (wealthBranches.includes(dayBranch)) {
                score += 3;
            }
            
            return Math.min(20, score);
        }

        // 计算日主承载力 - 基于专业身强身弱理论 (30分)
        function calculateDayMasterCapacity(pillars) {
            const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
            const monthStr = typeof pillars.month === 'string' ? pillars.month : String(pillars.month);
            const yearStr = typeof pillars.year === 'string' ? pillars.year : String(pillars.year);
            const hourStr = typeof pillars.hour === 'string' ? pillars.hour : String(pillars.hour);
            
            const dayStem = dayStr.charAt(0);
            const monthBranch = monthStr.charAt(1);
            
            // 1. 身强判断标准
            let strengthPoints = 0;
            
            // 得令判断 (月令是否帮扶日主)
            if (isDayStemInSeason(dayStem, monthBranch)) {
                strengthPoints += 2; // 得令+2分
            }
            
            // 得地判断 (地支帮扶)
            const supportiveBranches = getSupportiveBranches(dayStem);
            const allBranches = [yearStr.charAt(1), monthBranch, dayStr.charAt(1), hourStr.charAt(1)];
            let supportiveCount = 0;
            
            allBranches.forEach(branch => {
                if (supportiveBranches.includes(branch)) {
                    supportiveCount++;
                }
            });
            
            if (supportiveCount >= 2) {
                strengthPoints += 1; // 得地+1分
            }
            
            // 印比帮扶总数
            const yinStars = getYinStars(dayStem);
            const biJieStars = getBiJieStars(dayStem);
            const allStems = [yearStr.charAt(0), monthStr.charAt(0), hourStr.charAt(0)];
            
            let helpCount = 0;
            allStems.forEach(stem => {
                if (yinStars.includes(stem) || biJieStars.includes(stem)) {
                    helpCount++;
                }
            });
            
            if (helpCount >= 2) {
                strengthPoints += 1; // 印比帮扶+1分
            }
            
            // 2. 承载系数计算
            let yinScore = 0;
            let biJieScore = 0;
            let wealthScore = 0;
            
            // 计算印星总分
            allStems.forEach(stem => {
                if (yinStars.includes(stem)) {
                    yinScore += 1;
                }
            });
            
            // 计算比劫总分
            allStems.forEach(stem => {
                if (biJieStars.includes(stem)) {
                    biJieScore += 1;
                }
            });
            
            // 计算财星总分
            const zhengCai = getZhengCai(dayStem);
            const pianCai = getPianCai(dayStem);
            allStems.forEach(stem => {
                if (stem === zhengCai || stem === pianCai) {
                    wealthScore += 1;
                }
            });
            
            // 承载系数 = (印星总分 + 比劫总分) / 财星总分
            let capacityRatio = 0;
            if (wealthScore > 0) {
                capacityRatio = (yinScore + biJieScore) / wealthScore;
            } else {
                capacityRatio = yinScore + biJieScore; // 无财星时直接用帮扶力量
            }
            
            // 3. 最终承载力评分
            let score = 10; // 基础分
            
            // 身强程度加分
            if (strengthPoints >= 3) {
                score += 10; // 身强
            } else if (strengthPoints >= 2) {
                score += 5; // 身中等
            }
            
            // 承载系数调整
            if (capacityRatio > 1.5) {
                score += 10; // 可担财
            } else if (capacityRatio > 0.8) {
                score += 5; // 正常承载
            } else if (wealthScore > 0) {
                score -= 5; // 不担财时扣分
            }
            
            return Math.max(0, Math.min(10, score)); // 降低上限到10分
        }
        
        // 获取支持日主的地支
        function getSupportiveBranches(dayStem) {
            const branchMap = {
                '甲': ['寅', '卯', '亥', '未'], // 木的根和生扶
                '乙': ['寅', '卯', '亥', '未'],
                '丙': ['巳', '午', '寅', '戌'], // 火的根和生扶
                '丁': ['巳', '午', '寅', '戌'],
                '戊': ['辰', '戌', '丑', '未', '巳', '午'], // 土的根和生扶
                '己': ['辰', '戌', '丑', '未', '巳', '午'],
                '庚': ['申', '酉', '辰', '丑'], // 金的根和生扶
                '辛': ['申', '酉', '辰', '丑'],
                '壬': ['亥', '子', '申', '辰'], // 水的根和生扶
                '癸': ['亥', '子', '申', '辰']
            };
            return branchMap[dayStem] || [];
        }
        
        // 计算大运流年修正 - 优先使用 currentBaziData
        function calculateLuckAdjustment(pillars, currentYear) {
            const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
            const dayStem = dayStr.charAt(0);
            
            let adjustment = 0;
            
            // 优先从 currentBaziData 读取当前流年信息（若有）
            let yearStem, yearBranch;
            if (window.currentBaziData && window.currentBaziData.currentYearGanZhi) {
                const ygz = window.currentBaziData.currentYearGanZhi;
                if (typeof ygz === 'string' && ygz.length >= 2) {
                    yearStem = ygz.charAt(0);
                    yearBranch = ygz.charAt(1);
                }
            }
            // 退化到本地简化计算
            if (!yearStem || !yearBranch) {
                yearStem = getYearStem(currentYear);
                yearBranch = getYearBranch(currentYear);
            }
            
            // 1. 财星流年加成
            const zhengCai = getZhengCai(dayStem);
            const pianCai = getPianCai(dayStem);
            
            if (yearStem === zhengCai || yearStem === pianCai) {
                adjustment += 15; // 财星流年，财运亨通
            }
            
            // 2. 食伤流年 (生财)
            const shiShangStars = getShiShangStars(dayStem);
            if (shiShangStars.includes(yearStem)) {
                adjustment += 10; // 食伤流年，利于生财
            }
            
            // 3. 比劫流年 (夺财)
            const biJieStars = getBiJieStars(dayStem);
            if (biJieStars.includes(yearStem)) {
                adjustment -= 8; // 比劫流年，财运受阻
            }
            
            // 4. 三合财局判断
            const wealthBranches = getWealthBranches(dayStem);
            if (wealthBranches.includes(yearBranch)) {
                adjustment += 12; // 地支财星，根基稳固
            }
            
            return adjustment;
        }
        
        // 计算大运强弱系数（-10~+10）- 优先使用 currentBaziData 的大运
        function calculateDayunStrength(pillars){
            const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
            const dayStem = dayStr.charAt(0);
            const stagesTable = getTwelveStagesTable();
            const stageMap = {"长生":6, "沐浴":4, "冠带":5, "临官":8, "帝旺":10, "衰":-4, "病":-6, "死":-8, "墓":-9, "绝":-10, "胎":-3, "养":-2};
            
            // 优先从 currentBaziData 推断当前大运地支
            let dayunZhi = null;
            if (window.currentBaziData && window.currentBaziData.luckTiming) {
                try {
                    const currentDayun = getCurrentDayun();
                    if (currentDayun && typeof currentDayun.ganZhi === 'string' && currentDayun.ganZhi.length >= 2) {
                        dayunZhi = currentDayun.ganZhi.charAt(1);
                    }
                } catch (e) {
                    console.warn('获取当前大运失败，使用备用逻辑:', e);
                }
            }
            
            // 回退：通过简化逻辑或空值检查
            if (!dayunZhi) {
                const currentDayunFallback = getCurrentDayun();
                if (currentDayunFallback && typeof currentDayunFallback.ganZhi === 'string' && currentDayunFallback.ganZhi.length >= 2) {
                    dayunZhi = currentDayunFallback.ganZhi.charAt(1);
                }
            }
            
            if (!dayunZhi) return 0;
            
            let strength = 0;
            if (stagesTable[dayStem]) {
                const stages = stagesTable[dayStem];
                for (const [stage, zhi] of Object.entries(stages)) {
                    if (zhi === dayunZhi) {
                        strength = stageMap[stage] || 0;
                        break;
                    }
                }
            }
            return strength;
        }
        
        // 获取流年天干 (简化计算)
        function getYearStem(year) {
            const stems = ['庚', '辛', '壬', '癸', '甲', '乙', '丙', '丁', '戊', '己'];
            return stems[year % 10];
        }
        
        // 获取流年地支 (简化计算)
        function getYearBranch(year) {
            const branches = ['申', '酉', '戌', '亥', '子', '丑', '寅', '卯', '辰', '巳', '午', '未'];
            return branches[year % 12];
        }
        
        // 计算季节性财运潜力
        function calculateSeasonalWealthPotential(dayStem, monthBranch) {
            let score = 0;
            
            // 根据日主和月令判断财运的季节性潜力
            const seasonalMap = {
                '甲': { '申': 6, '酉': 8, '戌': 5, '未': 4, '辰': 3 }, // 木日主在金旺季节
                '乙': { '申': 6, '酉': 8, '戌': 5, '未': 4, '辰': 3 },
                '丙': { '子': 6, '亥': 8, '戌': 4, '丑': 5, '辰': 3 }, // 火日主在水旺季节
                '丁': { '子': 6, '亥': 8, '戌': 4, '丑': 5, '辰': 3 },
                '戊': { '寅': 6, '卯': 8, '辰': 4, '未': 3, '戌': 3 }, // 土日主在木旺季节
                '己': { '寅': 6, '卯': 8, '辰': 4, '未': 3, '戌': 3 },
                '庚': { '午': 6, '巳': 8, '未': 5, '戌': 4, '辰': 3 }, // 金日主在火旺季节
                '辛': { '午': 6, '巳': 8, '未': 5, '戌': 4, '辰': 3 },
                '壬': { '辰': 6, '戌': 8, '丑': 5, '未': 5, '午': 4 }, // 水日主在土旺季节
                '癸': { '辰': 6, '戌': 8, '丑': 5, '未': 5, '午': 4 }
            };
            
            if (seasonalMap[dayStem] && seasonalMap[dayStem][monthBranch]) {
                score += seasonalMap[dayStem][monthBranch];
            } else {
                score += 2; // 基础分数
            }
            
            return score;
        }
        
        // 计算财星保护分数 - 100分制版 (20分) - 保留作为备用
        function calculateWealthProtectionScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            let score = 6; // 基础保护分数
            
            const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)];
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            
            // 1. 印星保护财星 (最高8分)
            const yinStars = getYinStars(dayStem);
            let yinCount = 0;
            stems.forEach(stem => {
                if (yinStars.includes(stem)) yinCount++;
            });
            branches.forEach(branch => {
                if (yinStars.includes(branch)) yinCount++;
            });
            
            if (yinCount >= 2) score += 8;
            else if (yinCount === 1) score += 5;
            
            // 2. 食伤适度 (最高6分) - 改为正面评分
            const shiShangStars = getShiShangStars(dayStem);
            let shiShangCount = 0;
            stems.forEach(stem => {
                if (shiShangStars.includes(stem)) shiShangCount++;
            });
            branches.forEach(branch => {
                if (shiShangStars.includes(branch)) shiShangCount++;
            });
            
            if (shiShangCount === 1) score += 6; // 适度食伤有利财运
            else if (shiShangCount === 2) score += 4;
            else if (shiShangCount === 0) score += 3; // 无食伤也可以
            
            // 3. 比劫适度 (最高5分) - 改为正面评分
            const biJieStars = getBiJieStars(dayStem);
            let biJieCount = 0;
            stems.forEach(stem => {
                if (biJieStars.includes(stem)) biJieCount++;
            });
            branches.forEach(branch => {
                if (biJieStars.includes(branch)) biJieCount++;
            });
            
            if (biJieCount === 1) score += 5; // 适度比劫有助合作
            else if (biJieCount === 0) score += 4; // 无比劫也不错
            else if (biJieCount === 2) score += 2;
            
            return Math.min(20, score);
        }
        
        // 专业八字：喜忌平衡分析 (0~10分)
        function calculateFavorableBalance(pillars) {
            const dayElement = getStemElement(pillars.day.charAt(0));
            const dayStrength = calculateSimpleDayStrength(pillars);
            let balance = 0;
            
            // 财星在天干的力度
            let wealthStrength = 0;
            ['year', 'month', 'hour'].forEach(pos => {
                const stem = pillars[pos].charAt(0);
                if (isWealth(dayElement, getStemElement(stem))) {
                    wealthStrength += (pos === 'month') ? 3 : 1;
                }
            });
            
            const ratio = wealthStrength > 0 ? dayStrength / (wealthStrength * 10) : dayStrength / 50;
            if (ratio >= 0.8 && ratio <= 1.5) {
                balance += 6;
            } else if (ratio > 1.5) {
                balance += 4;
            } else {
                balance += 2;
            }
            
            // 用神到位：身弱要印比，身强要食伤
            if (dayStrength < 50) {
                let supportCount = 0;
                ['year', 'month', 'hour'].forEach(pos => {
                    const stem = pillars[pos].charAt(0);
                    const elem = getStemElement(stem);
                    if (elem === dayElement || isYinshou(dayElement, elem)) supportCount++;
                });
                if (supportCount >= 1) balance += 2;
            } else if (dayStrength >= 70) {
                let xsCount = 0;
                ['year', 'month', 'hour'].forEach(pos => {
                    const stem = pillars[pos].charAt(0);
                    if (isShishang(dayElement, getStemElement(stem))) xsCount++;
                });
                if (xsCount >= 1) balance += 2;
            }
            
            return Math.max(0, Math.min(10, Math.round(balance)));
        }
        
        // 专业八字：空亡减分 (按旬空简化，0~15分)
        function calculateKongWangPenalty(pillars) {
            const dayStem = pillars.day.charAt(0);
            const dayBranch = pillars.day.charAt(1);
            const dayGanZhi = dayStem + dayBranch;
            const kongWangBranches = (getKongWangTable()[dayGanZhi]) || [];
            let penalty = 0;
            
            // 财星空亡检查
            const wealthBranches = getWealthBranches(dayStem);
            [pillars.year.charAt(1), pillars.month.charAt(1), pillars.hour.charAt(1)].forEach(branch => {
                if (wealthBranches.includes(branch) && kongWangBranches.includes(branch)) {
                    penalty += 5;
                }
            });
            
            // 财库空亡检查
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            const vaults = ['辰', '戌', '丑', '未'];
            branches.forEach(b => {
                if (vaults.includes(b) && kongWangBranches.includes(b)) penalty += 3;
            });
            
            return Math.max(0, Math.min(15, penalty));
        }
        
        // 旬空表（简化版本）
        function getKongWangTable() {
            return {
                '甲子': ['戌', '亥'], '乙丑': ['戌', '亥'], '丙寅': ['戌', '亥'], '丁卯': ['戌', '亥'], '戊辰': ['戌', '亥'], '己巳': ['戌', '亥'], '庚午': ['戌', '亥'], '辛未': ['戌', '亥'], '壬申': ['戌', '亥'], '癸酉': ['戌', '亥'],
                '甲戌': ['申', '酉'], '乙亥': ['申', '酉'], '丙子': ['申', '酉'], '丁丑': ['申', '酉'], '戊寅': ['申', '酉'], '己卯': ['申', '酉'], '庚辰': ['申', '酉'], '辛巳': ['申', '酉'], '壬午': ['申', '酉'], '癸未': ['申', '酉'],
                '甲申': ['午', '未'], '乙酉': ['午', '未'], '丙戌': ['午', '未'], '丁亥': ['午', '未'], '戊子': ['午', '未'], '己丑': ['午', '未'], '庚寅': ['午', '未'], '辛卯': ['午', '未'], '壬辰': ['午', '未'], '癸巳': ['午', '未'],
                '甲午': ['辰', '巳'], '乙未': ['辰', '巳'], '丙申': ['辰', '巳'], '丁酉': ['辰', '巳'], '戊戌': ['辰', '巳'], '己亥': ['辰', '巳'], '庚子': ['辰', '巳'], '辛丑': ['辰', '巳'], '壬寅': ['辰', '巳'], '癸卯': ['辰', '巳'],
                '甲辰': ['寅', '卯'], '乙巳': ['寅', '卯'], '丙午': ['寅', '卯'], '丁未': ['寅', '卯'], '戊申': ['寅', '卯'], '己酉': ['寅', '卯'], '庚戌': ['寅', '卯'], '辛亥': ['寅', '卯'], '壬子': ['寅', '卯'], '癸丑': ['寅', '卯'],
                '甲寅': ['子', '丑'], '乙卯': ['子', '丑'], '丙辰': ['子', '丑'], '丁巳': ['子', '丑'], '戊午': ['子', '丑'], '己未': ['子', '丑'], '庚申': ['子', '丑'], '辛酉': ['子', '丑'], '壬戌': ['子', '丑'], '癸亥': ['子', '丑']
            };
        }

        // 计算日主强弱分数 (0~10分)
        function calculateDayMasterStrengthScore(pillars) {
            const dayStrength = calculateSimpleDayStrength(pillars);
            
            if (dayStrength >= 40 && dayStrength <= 60) {
                return 10; // 中和最佳
            } else if (dayStrength >= 30 && dayStrength <= 70) {
                return 8; // 稍有偏颇
            } else if (dayStrength >= 20 && dayStrength <= 80) {
                return 6; // 偏弱或偏强
            } else {
                return 3; // 过弱或过强
            }
        }

        // 计算用神得力分数 (0~12分)
        function calculateUsefulGodScore(pillars) {
            return evaluateYongShen(pillars);
        }

        // 计算忌神制约分数 (0~8分)
        function calculateTabooGodControlScore(pillars) {
            const dayElement = getStemElement(pillars.day.charAt(0));
            const dayStrength = calculateSimpleDayStrength(pillars);
            let score = 0;
            
            if (dayStrength > 70) {
                // 身强时，制约比劫、印星
                if (hasKillControl(pillars)) score += 3;
                if (hasInjuringOfficer(pillars)) score += 2;
            } else if (dayStrength < 30) {
                // 身弱时，制约财星、食伤
                if (hasWealthRobbery(pillars)) score += 3;
                if (hasOwlSnatching(pillars)) score += 2;
            } else {
                // 中和时，制约突出的忌神
                const tenGodsCount = countTenGods(pillars);
                const maxCount = Math.max(...Object.values(tenGodsCount));
                if (maxCount <= 2) score += 3; // 无明显忌神
            }
            
            return Math.min(8, score);
        }

        // 计算流年助力分数 (0~10分)
        function calculateLuckSupportScore(pillars) {
            try {
                // 使用已有的流年调整函数
                const currentYear = new Date().getFullYear();
                const adjustment = calculateLuckAdjustment(pillars, currentYear);
                
                // 将调整值转换为0-10分
                if (adjustment >= 15) return 10;
                else if (adjustment >= 10) return 8;
                else if (adjustment >= 5) return 6;
                else if (adjustment >= 0) return 4;
                else if (adjustment >= -5) return 2;
                else return 0;
            } catch (e) {
                return 5; // 默认中等分数
            }
        }

        // 计算大运配合分数 (0~8分)
        function calculateDayunCoordinationScore(pillars) {
            try {
                const dayunStrength = calculateDayunStrength(pillars);
                const dayStrength = calculateSimpleDayStrength(pillars);
                
                // 身强喜泄耗，身弱喜生助
                if (dayStrength > 60 && dayunStrength < 0) return 8; // 身强遇弱运
                else if (dayStrength < 40 && dayunStrength > 0) return 8; // 身弱遇强运
                else if (dayStrength >= 40 && dayStrength <= 60) return 6; // 中和配任何运
                else return 3; // 配合一般
            } catch (e) {
                return 4; // 默认分数
            }
        }

        // 计算贵人助力分数 (0~6分)
        function calculateNoblesSupportScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            const dayBranch = pillars.day.charAt(1);
            const branches = [pillars.year.charAt(1), pillars.month.charAt(1), pillars.day.charAt(1), pillars.hour.charAt(1)];
            let score = 0;
            
            // 天乙贵人
            const tianYiNobles = getTianYiNoble(dayStem);
            if (branches.some(branch => tianYiNobles.includes(branch))) score += 2;
            
            // 文昌贵人
            const wenChangNoble = getWenChangNoble(dayStem);
            if (branches.includes(wenChangNoble)) score += 1.5;
            
            // 天德贵人
            const tianDeNoble = getTianDeNoble(pillars.month.charAt(1));
            if ([pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)].includes(tianDeNoble)) score += 1.5;
            
            // 月德贵人
            const yueDeNoble = getYueDeNoble(pillars.month.charAt(1));
            if ([pillars.year.charAt(0), pillars.month.charAt(0), pillars.hour.charAt(0)].includes(yueDeNoble)) score += 1;
            
            return Math.min(6, score);
        }

        // 计算特殊格局加分 (0~20分)
        function calculateSpecialPatternBonus(pillars) {
            const specialPattern = identifySpecialPattern(pillars);
            const specialPatterns = identifySpecialPatterns(pillars);
            
            let bonus = 0;
            
            // 来自identifySpecialPattern的分数
            if (specialPattern.type !== 'normal') {
                if (specialPattern.type === 'zhuanwang') bonus += 18;
                else if (specialPattern.type === 'congqiang') bonus += 15;
                else if (specialPattern.type === 'congruo') bonus += 12;
            }
            
            // 来自identifySpecialPatterns的额外分数
            specialPatterns.forEach(pattern => {
                if (pattern.bonus > 0) {
                    bonus += Math.min(pattern.bonus, 10); // 限制单个格局最高10分
                }
            });
            
            return Math.min(20, bonus);
        }

        // 计算命格层次加分 (0~15分)
        function calculateLevelBonus(pillars) {
            let bonus = 0;
            const dayElement = getStemElement(pillars.day.charAt(0));
            const tenGodsCount = countTenGods(pillars);
            
            // 三奇贵人格局
            if (hasSanQi(pillars)) bonus += 8;
            
            // 官印相生格局
            if (tenGodsCount.正官 > 0 && tenGodsCount.正印 > 0) bonus += 6;
            
            // 食神制杀格局
            if (tenGodsCount.食神 > 0 && tenGodsCount.七杀 > 0) bonus += 5;
            
            // 财官双美格局
            if (tenGodsCount.正财 > 0 && tenGodsCount.正官 > 0) bonus += 4;
            
            // 印绶格高层次
            if (tenGodsCount.正印 >= 2) bonus += 3;
            
            return Math.min(15, bonus);
        }

        // 计算调候用神分数 (0~8分)
        function calculateSeasonalAdjustmentScore(pillars) {
            const monthBranch = pillars.month.charAt(1);
            const dayElement = getStemElement(pillars.day.charAt(0));
            let score = 0;
            
            // 冬季调候 - 需要火暖局
            if (['子', '丑', '亥'].includes(monthBranch)) {
                const tenGodsCount = countTenGods(pillars);
                if (dayElement === '木' || dayElement === '水') {
                    if (tenGodsCount.食神 > 0 || tenGodsCount.伤官 > 0) score += 4; // 木火通明
                }
                if (dayElement === '金') {
                    if (tenGodsCount.食神 > 0) score += 3; // 金水伤官
                }
            }
            
            // 夏季调候 - 需要水润燥
            else if (['午', '未', '巳'].includes(monthBranch)) {
                if (dayElement === '火' || dayElement === '土') {
                    const tenGodsCount = countTenGods(pillars);
                    if (tenGodsCount.正官 > 0 || tenGodsCount.七杀 > 0) score += 4; // 火土需水调候
                }
            }
            
            // 春秋季节相对平和
            else {
                score += 2; // 基础调候分数
            }
            
            return Math.min(8, score);
        }

        // 天乙贵人查法
        function getTianYiNoble(dayStem) {
            const tianYiMap = {
                '甲': ['丑', '未'], '乙': ['子', '申'], '丙': ['亥', '酉'], '丁': ['亥', '酉'],
                '戊': ['丑', '未'], '己': ['子', '申'], '庚': ['丑', '未'], '辛': ['午', '寅'],
                '壬': ['卯', '巳'], '癸': ['卯', '巳']
            };
            return tianYiMap[dayStem] || [];
        }

        // 文昌贵人查法
        function getWenChangNoble(dayStem) {
            const wenChangMap = {
                '甲': '巳', '乙': '午', '丙': '申', '丁': '酉', '戊': '申',
                '己': '酉', '庚': '亥', '辛': '子', '壬': '寅', '癸': '卯'
            };
            return wenChangMap[dayStem] || '巳';
        }

        // 天德贵人查法（按月支）
        function getTianDeNoble(monthBranch) {
            const tianDeMap = {
                '子': '丁', '丑': '丁', '寅': '丙', '卯': '甲', '辰': '甲',
                '巳': '癸', '午': '壬', '未': '壬', '申': '辛', '酉': '庚',
                '戌': '庚', '亥': '乙'
            };
            return tianDeMap[monthBranch] || '丁';
        }

        // 月德贵人查法（按月支）
        function getYueDeNoble(monthBranch) {
            const yueDeMap = {
                '子': '丙', '丑': '甲', '寅': '壬', '卯': '庚', '辰': '丙',
                '巳': '甲', '午': '壬', '未': '庚', '申': '丁', '酉': '乙',
                '戌': '癸', '亥': '己'
            };
            return yueDeMap[monthBranch] || '丙';
        }

        // 检查三奇格局
        function hasSanQi(pillars) {
            const stems = [pillars.year.charAt(0), pillars.month.charAt(0), pillars.day.charAt(0), pillars.hour.charAt(0)];
            
            // 乙丙丁三奇
            const hasYi = stems.includes('乙');
            const hasBing = stems.includes('丙');
            const hasDing = stems.includes('丁');
            if (hasYi && hasBing && hasDing) return true;
            
            // 甲戊庚三奇
            const hasJia = stems.includes('甲');
            const hasWu = stems.includes('戊');
            const hasGeng = stems.includes('庚');
            if (hasJia && hasWu && hasGeng) return true;
            
            return false;
        }
        
        // 专业八字：否决条款（传统版）
        function applyTraditionalVetoRules(score, pillars) {
            let adjusted = score;
            const dayElement = getStemElement(pillars.day.charAt(0));
            const dayStrength = calculateSimpleDayStrength(pillars);
            
            // 财多身弱不担财
            let wealthCount = 0;
            ['year', 'month', 'hour'].forEach(pos => {
                const stem = pillars[pos].charAt(0);
                if (isWealth(dayElement, getStemElement(stem))) wealthCount++;
            });
            const biJieCount = countBiJieStars(pillars);
            const yinCount = countYinStars(pillars);
            if (dayStrength < 40 && wealthCount >= 3 && (biJieCount + yinCount) === 0) {
                adjusted = Math.min(adjusted, 70);
            }
            
            // 比劫夺财无制
            if (biJieCount >= 2 && wealthCount >= 1) {
                const hasOfficerControl = ['year', 'month', 'hour'].some(pos => {
                    const stem = pillars[pos].charAt(0);
                    return isOfficer(dayElement, getStemElement(stem));
                });
                if (!hasOfficerControl) adjusted *= 0.7;
            }
            
            // 伤官见官
            let shiShangCount = 0, guanCount = 0;
            ['year', 'month', 'hour'].forEach(pos => {
                const stem = pillars[pos].charAt(0);
                const elem = getStemElement(stem);
                if (isShishang(dayElement, elem)) shiShangCount++;
                if (isOfficer(dayElement, elem)) guanCount++;
            });
            if (shiShangCount >= 1 && guanCount >= 1) adjusted *= 0.8;
            
            // 全局无财库，封顶
            const hasWealthVault = ['year', 'month', 'day', 'hour'].some(pos => ['辰', '戌', '丑', '未'].includes(pillars[pos].charAt(1)));
            if (!hasWealthVault && adjusted > 80) adjusted = Math.min(adjusted, 80);
            
            return Math.max(0, Math.round(adjusted));
        }
        
        // 获取财星
        function getWealthStars(dayStem) {
            const wealthMap = {
                '甲': ['戊', '己', '辰', '戌', '丑', '未'], // 木克土
                '乙': ['戊', '己', '辰', '戌', '丑', '未'],
                '丙': ['庚', '辛', '申', '酉'], // 火克金
                '丁': ['庚', '辛', '申', '酉'],
                '戊': ['壬', '癸', '子', '亥'], // 土克水
                '己': ['壬', '癸', '子', '亥'],
                '庚': ['甲', '乙', '寅', '卯'], // 金克木
                '辛': ['甲', '乙', '寅', '卯'],
                '壬': ['丙', '丁', '午', '巳'], // 水克火
                '癸': ['丙', '丁', '午', '巳']
            };
            return wealthMap[dayStem] || [];
        }
        
        // 获取印星
        function getYinStars(dayStem) {
            const yinMap = {
                '甲': ['壬', '癸', '子', '亥'], // 水生木
                '乙': ['壬', '癸', '子', '亥'],
                '丙': ['甲', '乙', '寅', '卯'], // 木生火
                '丁': ['甲', '乙', '寅', '卯'],
                '戊': ['丙', '丁', '午', '巳'], // 火生土
                '己': ['丙', '丁', '午', '巳'],
                '庚': ['戊', '己', '辰', '戌', '丑', '未'], // 土生金
                '辛': ['戊', '己', '辰', '戌', '丑', '未'],
                '壬': ['庚', '辛', '申', '酉'], // 金生水
                '癸': ['庚', '辛', '申', '酉']
            };
            return yinMap[dayStem] || [];
        }
        
        // 获取食伤星
        function getShiShangStars(dayStem) {
            const shiShangMap = {
                '甲': ['丙', '丁', '午', '巳'], // 木生火
                '乙': ['丙', '丁', '午', '巳'],
                '丙': ['戊', '己', '辰', '戌', '丑', '未'], // 火生土
                '丁': ['戊', '己', '辰', '戌', '丑', '未'],
                '戊': ['庚', '辛', '申', '酉'], // 土生金
                '己': ['庚', '辛', '申', '酉'],
                '庚': ['壬', '癸', '子', '亥'], // 金生水
                '辛': ['壬', '癸', '子', '亥'],
                '壬': ['甲', '乙', '寅', '卯'], // 水生木
                '癸': ['甲', '乙', '寅', '卯']
            };
            return shiShangMap[dayStem] || [];
        }
        
        // 获取比劫星
        function getBiJieStars(dayStem) {
            const biJieMap = {
                '甲': ['甲', '乙', '寅', '卯'], // 同类五行
                '乙': ['甲', '乙', '寅', '卯'],
                '丙': ['丙', '丁', '午', '巳'],
                '丁': ['丙', '丁', '午', '巳'],
                '戊': ['戊', '己', '辰', '戌', '丑', '未'],
                '己': ['戊', '己', '辰', '戌', '丑', '未'],
                '庚': ['庚', '辛', '申', '酉'],
                '辛': ['庚', '辛', '申', '酉'],
                '壬': ['壬', '癸', '子', '亥'],
                '癸': ['壬', '癸', '子', '亥']
            };
            return biJieMap[dayStem] || [];
        }

        // calculateWealthFlowScore函数已被新的财富结构评分替代
        
        // 获取官杀星
        function getGuanShaStars(dayStem) {
            const guanShaMap = {
                '甲': ['庚', '辛', '申', '酉'], // 金克木
                '乙': ['庚', '辛', '申', '酉'],
                '丙': ['壬', '癸', '子', '亥'], // 水克火
                '丁': ['壬', '癸', '子', '亥'],
                '戊': ['甲', '乙', '寅', '卯'], // 木克土
                '己': ['甲', '乙', '寅', '卯'],
                '庚': ['丙', '丁', '午', '巳'], // 火克金
                '辛': ['丙', '丁', '午', '巳'],
                '壬': ['戊', '己', '辰', '戌', '丑', '未'], // 土克水
                '癸': ['戊', '己', '辰', '戌', '丑', '未']
            };
            return guanShaMap[dayStem] || [];
        }
        
        // 计算五行流通分数
        function calculateFiveElementFlow(pillars) {
            const elements = {
                '甲': '木', '乙': '木', '寅': '木', '卯': '木',
                '丙': '火', '丁': '火', '午': '火', '巳': '火',
                '戊': '土', '己': '土', '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '庚': '金', '辛': '金', '申': '金', '酉': '金',
                '壬': '水', '癸': '水', '子': '水', '亥': '水'
            };
            
            const allChars = [
                pillars.year.charAt(0), pillars.year.charAt(1),
                pillars.month.charAt(0), pillars.month.charAt(1),
                pillars.day.charAt(0), pillars.day.charAt(1),
                pillars.hour.charAt(0), pillars.hour.charAt(1)
            ];
            
            const elementSet = new Set();
            allChars.forEach(char => {
                if (elements[char]) {
                    elementSet.add(elements[char]);
                }
            });
            
            const elementCount = elementSet.size;
            
            // 五行齐全得6分，四行得4分，三行得2分
            if (elementCount >= 5) return 6;
            else if (elementCount === 4) return 4;
            else if (elementCount === 3) return 2;
            else return 0;
        }

        // calculateWealthTimingScore函数已被新的财富潜力评分替代

        // 获取财富等级 - 适配新评分系统（无上限但常见范围至150+）
        function getWealthLevel(score) {
            // 调整阈值，使新系统下约100分为四星、130分为五星起步
            if (score >= 130) return { name: "超格富贵 ★★★★★", class: "legendary-rich" };   // 130+：超格富贵（五星）
            if (score >= 100) return { name: "制度富贵 ★★★★☆", class: "ultra-rich" };      // 100-129：制度富贵（四星）
            if (score >= 75) return { name: "技术致富 ★★★★☆", class: "very-rich" };        // 75-99：技术致富（高四星/低四星）
            if (score >= 55) return { name: "勤勉小富 ★★★☆☆", class: "moderately-rich" };   // 55-74：勤勉小富（三星）
            if (score >= 35) return { name: "小康水平 ★★☆☆☆", class: "somewhat-rich" };     // 35-54：小康（二星）
            if (score >= 20) return { name: "基本温饱 ★☆☆☆☆", class: "basic-wealth" };      // 20-34：基本温饱（一星）
            return { name: "平常级别 ☆☆☆☆☆", class: "wealth-average" };                   // <20：普通水平（零星）
        }

        // 获取财富描述 - 基于优化后的专业命理理论
        function getWealthDescription(score) {
            if (score >= 130) return '超格富贵命局，财星格局完美，十神配合得当，具备顶级富豪潜质，财富可达十亿级以上，适合大型产业投资或金融运作';
            if (score >= 105) return '制度富贵之命，财星旺盛且有利，格局上乘，日主有力承载，具备亿级富豪潜质，适合大型企业经营或高端投资';
            if (score >= 80) return '技术致富格局，财星强劲配合得当，善于创新发展，可通过专业技能或科技创业达到数千万级资产';
            if (score >= 60) return '勤勉小富之命，财星中等但稳定，格局平衡，通过持续努力可积累数百万至千万级财富，适合稳健经营';
            if (score >= 40) return '小康水平命局，财星尚可，需要努力经营和理财规划，可达到百万级小康生活水平';
            if (score >= 20) return '基本温饱之命，财运一般，需通过勤奋工作维持稳定生活，建议加强技能提升和理财意识';
            return '财运平常，需注重开源节流，逐步改善财务状况，避免高风险投资，以稳为主';
        }

        // 显示结果
        function displayResults(baziData) {
            displayBasicInfo(baziData);
            displayBaziChart(baziData);
            displayElementsChartComplete(baziData);
            displayStrengthChart(baziData);
            
            // 计算并显示当前身强身弱分析
            try {
                const currentYear = new Date().getFullYear();
                const dayStem = baziData.pillars.day[0];
                const monthBranch = baziData.pillars.month[1];
                const currentStrengthData = calculateCurrentStrength(dayStem, baziData.elements, monthBranch, currentYear);
                displayCurrentStrengthChart(currentStrengthData);
            } catch (error) {
                console.error('计算当前身强身弱分析失败:', error);
                // 显示错误信息
                const description = document.getElementById('current-strength-description');
                if (description) {
                    description.innerHTML = `
                        <h4><i class="fas fa-clock"></i> 当前身强身弱分析</h4>
                        <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
                            <p><i class="fas fa-exclamation-triangle"></i> 计算当前身强身弱分析时出现错误，请稍后重试。</p>
                        </div>
                    `;
                }
            }
            
            displayLuckTiming(baziData);
            displayFateLevel(baziData);
            displayWealthLevel(baziData);
        }

        // 显示基本信息
        function displayBasicInfo(baziData) {
            const userInfoTitle = document.getElementById('user-info-title');
            const basicInfoContent = document.getElementById('basic-info-content');
            
            userInfoTitle.textContent = `${baziData.name} - ${baziData.gender === 'male' ? '男' : '女'}`;
            
            const solarDate = baziData.solar.toYmd();
            const lunarDate = baziData.lunar.toString();
            
            basicInfoContent.innerHTML = `
                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="info-item">
                        <strong>阳历：</strong>${solarDate}
                    </div>
                    <div class="info-item">
                        <strong>农历：</strong>${lunarDate}
                    </div>
                    <div class="info-item">
                        <strong>性别：</strong>${baziData.gender === 'male' ? '男' : '女'}
                    </div>
                    <div class="info-item">
                        <strong>时辰：</strong>${baziData.birthTime}
                    </div>
                </div>
            `;
        }

        // 显示八字排盘
        function displayBaziChart(baziData) {
            const baziChart = document.getElementById('bazi-chart');
            const { pillars, hiddenStems } = baziData;
            const dayStem = pillars.day[0]; // 日主天干
            
            // 五行颜色映射
            const elementColors = {
                '木': '#27ae60', // 绿色
                '火': '#e74c3c', // 红色
                '土': '#f39c12', // 黄色
                '金': '#95a5a6', // 银色
                '水': '#3498db'  // 蓝色
            };
            
            // 天干地支五行映射
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '寅': '木', '卯': '木',
                '巳': '火', '午': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
            
            // 生成带颜色和十神的天干
                function coloredStem(stem, isDay = false) {
                    const element = elementMap[stem] || '';
                    const color = elementColors[element] || '#000';
                    const tenGod = isDay ? '' : getTenGod(dayStem, stem);
                    const tenGodText = isDay ? '' : `<small style="display:block;font-size:0.5em;color:#666;margin-top:2px;text-align:center;">${tenGod}</small>`;
                    const bgColor = isDay ? `background:linear-gradient(135deg, rgba(${getElementRGB(element)}, 0.15), rgba(${getElementRGB(element)}, 0.05));` : '';
                    return `<div style="display:inline-block;${bgColor}border-radius:6px;padding:3px 8px;">
                        <span style="color:${color};font-weight:bold;font-size:1.6em;font-family:'SimHei','黑体',sans-serif;text-shadow:0 1px 2px rgba(0,0,0,0.1);">${stem}</span>
                        ${tenGodText}
                    </div>`;
                }
                
                // 生成带颜色和十神的地支
                function coloredBranch(branch) {
                    const element = elementMap[branch] || '';
                    const color = elementColors[element] || '#000';
                    const tenGod = getTenGod(dayStem, branch);
                    return `<div style="display:inline-block;border-radius:6px;padding:3px 8px;">
                        <span style="color:${color};font-weight:bold;font-size:1.6em;font-family:'SimHei','黑体',sans-serif;text-shadow:0 1px 2px rgba(0,0,0,0.1);">${branch}</span>
                        <small style="display:block;font-size:0.5em;color:#666;margin-top:2px;text-align:center;">${tenGod}</small>
                    </div>`;
                }
                
                // 生成带颜色和十神的藏干
                function coloredHiddenStems(stems) {
                    return stems.map((stem, index) => {
                        const element = elementMap[stem] || '';
                        const color = elementColors[element] || '#000';
                        const tenGod = getTenGod(dayStem, stem);
                        return `<div style="display:inline-block;margin:0 1px;border-radius:4px;padding:2px 4px;background:rgba(${getElementRGB(element)}, 0.05);">
                            <span style="color:${color};font-size:1.1em;font-family:'SimHei','黑体',sans-serif;text-shadow:0 1px 1px rgba(0,0,0,0.05);">${stem}</span>
                            <small style="display:block;font-size:0.45em;color:#666;margin-top:1px;text-align:center;">${tenGod}</small>
                        </div>`;
                    }).join('');
                }
                
                // 获取五行对应的RGB值
                function getElementRGB(element) {
                    switch(element) {
                        case '木': return '39, 174, 96'; // 绿色
                        case '火': return '231, 76, 60'; // 红色
                        case '土': return '243, 156, 18'; // 黄色
                        case '金': return '149, 165, 166'; // 银色
                        case '水': return '52, 152, 219'; // 蓝色
                        default: return '0, 0, 0';
                    }
                }
            
            baziChart.innerHTML = `
                <table class="bazi-table">
                    <thead>
                        <tr>
                            <th>四柱</th>
                            <th class="pillar-header">年柱</th>
                            <th class="pillar-header">月柱</th>
                            <th class="pillar-header">日柱</th>
                            <th class="pillar-header">时柱</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>天干</strong></td>
                            <td class="stem">${coloredStem(pillars.year[0])}</td>
                            <td class="stem">${coloredStem(pillars.month[0])}</td>
                            <td class="stem">${coloredStem(pillars.day[0], true)}</td>
                            <td class="stem">${coloredStem(pillars.hour[0])}</td>
                        </tr>
                        <tr>
                            <td><strong>地支</strong></td>
                            <td class="branch">${coloredBranch(pillars.year[1])}</td>
                            <td class="branch">${coloredBranch(pillars.month[1])}</td>
                            <td class="branch">${coloredBranch(pillars.day[1])}</td>
                            <td class="branch">${coloredBranch(pillars.hour[1])}</td>
                        </tr>
                        <tr>
                            <td><strong>藏干</strong></td>
                            <td>${coloredHiddenStems(hiddenStems.year)}</td>
                            <td>${coloredHiddenStems(hiddenStems.month)}</td>
                            <td>${coloredHiddenStems(hiddenStems.day)}</td>
                            <td>${coloredHiddenStems(hiddenStems.hour)}</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- 大运流年信息表格 -->
                <div style="margin-top: 12px;">
                    <table class="bazi-table">
                        <thead>
                            <tr>
                                <th>运程</th>
                                <th class="pillar-header">当前大运</th>
                                <th class="pillar-header">流年</th>
                                <th class="pillar-header">运程信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(() => {
                                const currentYear = new Date().getFullYear();
                                const currentDayun = getCurrentDayun();
                                const yearGanZhi = getYearGanZhi(currentYear);
                                
                                return `
                                <tr>
                                    <td><strong>干支</strong></td>
                                    <td class="stem">${coloredStem(currentDayun.ganZhi[0])}${coloredBranch(currentDayun.ganZhi[1])}</td>
                                    <td class="stem">${coloredStem(yearGanZhi[0])}${coloredBranch(yearGanZhi[1])}</td>
                                    <td style="text-align: left; padding: 10px;">
                                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">大运: ${currentDayun.startAge}-${currentDayun.endAge}岁</div>
                                        <div style="font-size: 0.9em; color: #666;">当前: ${currentDayun.currentAge}岁 (${currentYear}年)</div>
                                    </td>
                                </tr>
                                `;
                            })()} 
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7)); border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); backdrop-filter: blur(5px);">
                    <div style="display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center;">
                        <div style="flex: 1; min-width: 200px; padding: 8px; text-align: center; border-right: 1px solid rgba(233, 236, 239, 0.5);">
                            <div style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 4px;">年命纳音</div>
                            <div style="font-size: 1.2em; font-weight: 600; color: #2c3e50;">${baziData.lunar.getYearNaYin()}</div>
                        </div>
                        <div style="flex: 1; min-width: 200px; padding: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 4px;">日主</div>
                            <div style="font-size: 1.2em; font-weight: 600;">
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 20px; background: linear-gradient(135deg, rgba(${getElementRGB(elementMap[pillars.day[0]])}, 0.2), rgba(${getElementRGB(elementMap[pillars.day[0]])}, 0.05)); color: ${elementColors[elementMap[pillars.day[0]]] || '#000'}; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">
                                    ${pillars.day[0]}${getElementName(pillars.day[0])}命
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 获取五行名称
        function getElementName(stem) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            return elementMap[stem] || '';
        }

        // 显示五行图表（双图表版本）
        function displayElementsChart(baziData) {
            // 显示原命局五行分布
            displayOriginalElementsChart(baziData.elements);
            
            // 计算并显示当前五行分布（包含大运流年）
            const currentYear = new Date().getFullYear();
            const currentElements = calculateCurrentElements(baziData.elements, currentYear);
            displayCurrentElementsChart(currentElements, currentYear);
        }
        
        // 显示原命局五行分布图表
        function displayOriginalElementsChart(elements) {
            const ctx = document.getElementById('original-elements-chart').getContext('2d');
            
            if (window.originalElementsChart) {
                window.originalElementsChart.destroy();
            }
            
            // 增强的五行颜色 - 更专业的配色方案
            const elementColors = {
                wood: {
                    main: '#2ecc71',
                    light: 'rgba(46, 204, 113, 0.8)',
                    border: 'rgba(46, 204, 113, 1)',
                    gradient: ['rgba(46, 204, 113, 0.9)', 'rgba(39, 174, 96, 0.9)']
                },
                fire: {
                    main: '#e74c3c',
                    light: 'rgba(231, 76, 60, 0.8)',
                    border: 'rgba(231, 76, 60, 1)',
                    gradient: ['rgba(231, 76, 60, 0.9)', 'rgba(192, 57, 43, 0.9)']
                },
                earth: {
                    main: '#f39c12',
                    light: 'rgba(243, 156, 18, 0.8)',
                    border: 'rgba(243, 156, 18, 1)',
                    gradient: ['rgba(243, 156, 18, 0.9)', 'rgba(211, 84, 0, 0.9)']
                },
                metal: {
                    main: '#95a5a6',
                    light: 'rgba(149, 165, 166, 0.8)',
                    border: 'rgba(149, 165, 166, 1)',
                    gradient: ['rgba(149, 165, 166, 0.9)', 'rgba(127, 140, 141, 0.9)']
                },
                water: {
                    main: '#3498db',
                    light: 'rgba(52, 152, 219, 0.8)',
                    border: 'rgba(52, 152, 219, 1)',
                    gradient: ['rgba(52, 152, 219, 0.9)', 'rgba(41, 128, 185, 0.9)']
                }
            };
            
            // 注册Chart.js插件
            Chart.register(ChartDataLabels);
            
            // 计算总分
            const total = Object.values(elements).reduce((sum, val) => sum + val, 0);
            
            // 创建渐变背景
            const createGradient = (ctx, colors) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, colors[0]);
                gradient.addColorStop(1, colors[1]);
                return gradient;
            };
            
            // 创建原命局五行环形图
            window.originalElementsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['木', '火', '土', '金', '水'],
                    datasets: [{
                        data: [elements.wood, elements.fire, elements.earth, elements.metal, elements.water],
                        backgroundColor: [
                            createGradient(ctx, elementColors.wood.gradient),
                            createGradient(ctx, elementColors.fire.gradient),
                            createGradient(ctx, elementColors.earth.gradient),
                            createGradient(ctx, elementColors.metal.gradient),
                            createGradient(ctx, elementColors.water.gradient)
                        ],
                        borderColor: [
                            elementColors.wood.border,
                            elementColors.fire.border,
                            elementColors.earth.border,
                            elementColors.metal.border,
                            elementColors.water.border
                        ],
                        borderWidth: 2,
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%', // 稍微减小中心孔，使图表更加突出
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: "'Noto Serif SC', serif"
                                },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#333',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 15,
                            boxPadding: 8,
                            usePointStyle: true,
                            titleFont: {
                                size: 16,
                                weight: 'bold',
                                family: "'Noto Serif SC', serif"
                            },
                            bodyFont: {
                                size: 14,
                                family: "'Noto Serif SC', serif"
                            },
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(2);
                                    return `${context.label}: ${context.parsed}点 (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            textShadow: '0 1px 2px rgba(0,0,0,0.2)',
                            font: {
                                weight: 'bold',
                                size: 16,
                                family: "'Noto Serif SC', serif"
                            },
                            formatter: (value, ctx) => {
                                const percentage = ((value / total) * 100).toFixed(2);
                                return percentage > 5 ? `${percentage}%` : '';
                            },
                            anchor: 'center',
                            align: 'center',
                            offset: 0,
                            borderWidth: 2,
                            borderRadius: 4,
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor[context.dataIndex];
                            },
                            opacity: 0.9
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // 显示原命局五行概览
            const originalSummary = document.getElementById('original-elements-summary');
            const strongest = Object.keys(elements).reduce((a, b) => elements[a] > elements[b] ? a : b);
            const weakest = Object.keys(elements).reduce((a, b) => elements[a] < elements[b] ? a : b);
            
            const elementNames = {
                wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
            };
            
            // 增强的五行特性
            const elementProperties = {
                wood: {
                    nature: '生长、向上、扩展',
                    character: '仁爱、正直、进取、创新、灵活、善变',
                    career: '教育、文化、艺术、法律、环保、植物相关行业、创意设计、新兴产业',
                    health: '肝胆系统、眼睛、肌腱、神经、头部',
                    favorable: '东方、绿色环境、春季、清晨',
                    icon: 'fa-tree',
                    personality: '思维活跃，创新能力强，善于规划，有远见，但可能缺乏耐心，情绪波动较大',
                    career_detail: '适合需要创造力和变革的工作，不适合固定模式的工作',
                    health_advice: '注意情绪管理，避免过度紧张和压力，保持规律作息，多做舒缓运动'
                },
                fire: {
                    nature: '上升、扩张、热烈',
                    character: '热情、活力、直觉、表达力强、乐观、冲动',
                    career: '娱乐、餐饮、照明、能源、传媒、营销、表演、公关',
                    health: '心脏、血液循环、眼睛、面部、小肠',
                    favorable: '南方、阳光充足环境、夏季、中午',
                    icon: 'fa-fire',
                    personality: '热情洋溢，富有感染力，直觉敏锐，善于表达，但可能冲动，缺乏耐心',
                    career_detail: '适合需要热情和表现力的工作，不适合需要冷静分析的工作',
                    health_advice: '注意心脏健康，避免情绪过度激动，保持充足睡眠，适当控制饮食'
                },
                earth: {
                    nature: '稳定、中和、包容',
                    character: '踏实、稳重、包容、忠诚、保守、固执',
                    career: '房地产、农业、食品、保险、服务业、医疗、教育、行政管理',
                    health: '脾胃、消化系统、肌肉、口腔',
                    favorable: '中央位置、黄色环境、季节交替时期、下午',
                    icon: 'fa-mountain',
                    personality: '稳重踏实，责任感强，忠诚可靠，但可能固执，缺乏变通',
                    career_detail: '适合需要耐心和稳定的工作，不适合需要频繁变动的工作',
                    health_advice: '注意消化系统健康，保持规律饮食，避免过度思虑，适当运动'
                },
                metal: {
                    nature: '收敛、向内、坚硬',
                    character: '果断、公正、条理、自律、理性、刚毅',
                    career: '金融、IT、机械、汽车、珠宝、军警、法律、精密工业',
                    health: '肺部、大肠、皮肤、鼻子、呼吸系统',
                    favorable: '西方、白色环境、秋季、傍晚',
                    icon: 'fa-coins',
                    personality: '条理分明，做事果断，公正严明，但可能过于刚硬，缺乏柔性',
                    career_detail: '适合需要精确和规范的工作，不适合需要灵活变通的工作',
                    health_advice: '注意呼吸系统健康，保持环境清洁，避免过度压抑情绪，适当放松'
                },
                water: {
                    nature: '向下、流动、适应',
                    character: '智慧、灵活、交际、适应力强、深沉、多变',
                    career: '贸易、运输、旅游、水产、外交、销售、咨询、信息传播',
                    health: '肾脏、膀胱、耳朵、骨骼、生殖系统',
                    favorable: '北方、水域环境、冬季、夜晚',
                    icon: 'fa-water',
                    personality: '思维灵活，适应力强，善于沟通，但可能多虑，缺乏决断',
                    career_detail: '适合需要交流和变通的工作，不适合固定模式的工作',
                    health_advice: '注意肾脏健康，保持充足睡眠，避免过度疲劳，保持水分摄入'
                }
            };
            
            // 计算五行平衡度
            const avg = total / 5;
            const deviation = Object.values(elements).reduce((sum, val) => sum + Math.abs(val - avg), 0) / total;
            const balancePercentage = (1 - deviation) * 100;
            let balanceLevel;
            if (balancePercentage >= 85) balanceLevel = '极佳';
            else if (balancePercentage >= 70) balanceLevel = '良好';
            else if (balancePercentage >= 50) balanceLevel = '一般';
            else balanceLevel = '失衡';
            
            // 获取第二强和第二弱的五行
            const sortedElements = Object.entries(elements).sort((a, b) => b[1] - a[1]);
            const secondStrongest = sortedElements[1][0];
            const secondWeakest = sortedElements[3][0];
            
            // 显示原命局五行分布概览
            originalSummary.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(240,240,240,0.7)); padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
                    <div style="margin-bottom: 8px; font-size: 0.85rem;">
                        <span style="color: #2e7d32; font-weight: bold;">原命局：</span>
                        <span style="color: #1976d2;">先天五行分布</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: 8px;">
                        <div style="min-width: 100px; margin-bottom: 4px; font-size: 0.85rem;">
                            <span style="font-weight: bold; color: ${elementColors[strongest].main};">最强：</span>
                            <span style="background: ${elementColors[strongest].light}; padding: 2px 6px; border-radius: 12px; color: #fff; font-weight: bold; font-size: 0.8rem;">
                                ${elementNames[strongest]} ${((elements[strongest]/total)*100).toFixed(1)}%
                            </span>
                        </div>
                        <div style="min-width: 100px; margin-bottom: 4px; font-size: 0.85rem;">
                            <span style="font-weight: bold; color: ${elementColors[weakest].main};">最弱：</span>
                            <span style="background: ${elementColors[weakest].light}; padding: 2px 6px; border-radius: 12px; color: #fff; font-weight: bold; font-size: 0.8rem;">
                                ${elementNames[weakest]} ${((elements[weakest]/total)*100).toFixed(1)}%
                            </span>
                        </div>
                    </div>
                    <div style="font-size: 0.8rem; line-height: 1.4;">
                        <span style="color: #2c3e50;">五行分布：</span>
                        <span style="color: ${elementColors.wood.main};">木${elements.wood.toFixed(1)}</span> |
                        <span style="color: ${elementColors.fire.main};">火${elements.fire.toFixed(1)}</span> |
                        <span style="color: ${elementColors.earth.main};">土${elements.earth.toFixed(1)}</span> |
                        <span style="color: ${elementColors.metal.main};">金${elements.metal.toFixed(1)}</span> |
                        <span style="color: ${elementColors.water.main};">水${elements.water.toFixed(1)}</span>
                    </div>
                </div>
            `;
        }
        
        // 计算当前五行分布（包含大运流年）
        function calculateCurrentElements(originalElements, currentYear) {
            try {
                // 获取当前流年干支
                const today = new Date();
                const currentLunar = Lunar.fromDate(today);
                const currentYearGanZhi = currentLunar.getYearInGanZhi();
                const currentYearStem = currentYearGanZhi.charAt(0);
                const currentYearBranch = currentYearGanZhi.charAt(1);
                
                // 获取当前大运信息
                let currentDayunStem = '';
                let currentDayunBranch = '';
                
                try {
                    const currentDayunInfo = getCurrentDayun();
                    if (currentDayunInfo && currentDayunInfo.ganZhi && currentDayunInfo.ganZhi !== '未知' && currentDayunInfo.ganZhi !== '计算错误') {
                        currentDayunStem = currentDayunInfo.ganZhi.charAt(0);
                        currentDayunBranch = currentDayunInfo.ganZhi.charAt(1);
                    }
                } catch (e) {
                    console.log('获取大运信息失败:', e);
                }
                
                // 复制原始五行分布
                const currentElements = { ...originalElements };
                
                // 获取天干地支对应的五行
                const stemElementMap = {
                    '甲': 'wood', '乙': 'wood',
                    '丙': 'fire', '丁': 'fire',
                    '戊': 'earth', '己': 'earth',
                    '庚': 'metal', '辛': 'metal',
                    '壬': 'water', '癸': 'water'
                };
                
                const branchElementMap = {
                    '子': 'water', '丑': 'earth', '寅': 'wood', '卯': 'wood',
                    '辰': 'earth', '巳': 'fire', '午': 'fire', '未': 'earth',
                    '申': 'metal', '酉': 'metal', '戌': 'earth', '亥': 'water'
                };
                
                // 加入流年天干地支的五行力量
                const yearStemElement = stemElementMap[currentYearStem];
                const yearBranchElement = branchElementMap[currentYearBranch];
                
                if (yearStemElement) {
                    currentElements[yearStemElement] += 1.5; // 流年天干权重
                }
                if (yearBranchElement) {
                    currentElements[yearBranchElement] += 2.0; // 流年地支权重
                }
                
                // 加入大运天干地支的五行力量
                const dayunStemElement = stemElementMap[currentDayunStem];
                const dayunBranchElement = branchElementMap[currentDayunBranch];
                
                if (dayunStemElement) {
                    currentElements[dayunStemElement] += 1.2; // 大运天干权重
                }
                if (dayunBranchElement) {
                    currentElements[dayunBranchElement] += 1.8; // 大运地支权重
                }
                
                return {
                    elements: currentElements,
                    yearGanZhi: currentYearGanZhi,
                    dayunGanZhi: currentDayunStem + currentDayunBranch
                };
            } catch (error) {
                console.error('计算当前五行分布失败:', error);
                return {
                    elements: originalElements,
                    yearGanZhi: '',
                    dayunGanZhi: ''
                };
            }
        }
        
        // 显示当前五行分布图表
        function displayCurrentElementsChart(currentData, currentYear) {
            const ctx = document.getElementById('current-elements-chart').getContext('2d');
            const elements = currentData.elements;
            
            if (window.currentElementsChart) {
                window.currentElementsChart.destroy();
            }
            
            // 增强的五行颜色 - 更专业的配色方案
            const elementColors = {
                wood: {
                    main: '#2ecc71',
                    light: 'rgba(46, 204, 113, 0.8)',
                    border: 'rgba(46, 204, 113, 1)',
                    gradient: ['rgba(46, 204, 113, 0.9)', 'rgba(39, 174, 96, 0.9)']
                },
                fire: {
                    main: '#e74c3c',
                    light: 'rgba(231, 76, 60, 0.8)',
                    border: 'rgba(231, 76, 60, 1)',
                    gradient: ['rgba(231, 76, 60, 0.9)', 'rgba(192, 57, 43, 0.9)']
                },
                earth: {
                    main: '#f39c12',
                    light: 'rgba(243, 156, 18, 0.8)',
                    border: 'rgba(243, 156, 18, 1)',
                    gradient: ['rgba(243, 156, 18, 0.9)', 'rgba(211, 84, 0, 0.9)']
                },
                metal: {
                    main: '#95a5a6',
                    light: 'rgba(149, 165, 166, 0.8)',
                    border: 'rgba(149, 165, 166, 1)',
                    gradient: ['rgba(149, 165, 166, 0.9)', 'rgba(127, 140, 141, 0.9)']
                },
                water: {
                    main: '#3498db',
                    light: 'rgba(52, 152, 219, 0.8)',
                    border: 'rgba(52, 152, 219, 1)',
                    gradient: ['rgba(52, 152, 219, 0.9)', 'rgba(41, 128, 185, 0.9)']
                }
            };
            
            // 注册Chart.js插件
            Chart.register(ChartDataLabels);
            
            // 计算总分
            const total = Object.values(elements).reduce((sum, val) => sum + val, 0);
            
            // 创建渐变背景
            const createGradient = (ctx, colors) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, colors[0]);
                gradient.addColorStop(1, colors[1]);
                return gradient;
            };
            
            // 创建当前五行环形图
            window.currentElementsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['木', '火', '土', '金', '水'],
                    datasets: [{
                        data: [elements.wood, elements.fire, elements.earth, elements.metal, elements.water],
                        backgroundColor: [
                            createGradient(ctx, elementColors.wood.gradient),
                            createGradient(ctx, elementColors.fire.gradient),
                            createGradient(ctx, elementColors.earth.gradient),
                            createGradient(ctx, elementColors.metal.gradient),
                            createGradient(ctx, elementColors.water.gradient)
                        ],
                        borderColor: [
                            elementColors.wood.border,
                            elementColors.fire.border,
                            elementColors.earth.border,
                            elementColors.metal.border,
                            elementColors.water.border
                        ],
                        borderWidth: 2,
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: "'Noto Serif SC', serif"
                                },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#333',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 15,
                            boxPadding: 8,
                            usePointStyle: true,
                            titleFont: {
                                size: 16,
                                weight: 'bold',
                                family: "'Noto Serif SC', serif"
                            },
                            bodyFont: {
                                size: 14,
                                family: "'Noto Serif SC', serif"
                            },
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(2);
                                    return `${context.label}: ${context.parsed.toFixed(1)}点 (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            textShadow: '0 1px 2px rgba(0,0,0,0.2)',
                            font: {
                                weight: 'bold',
                                size: 14,
                                family: "'Noto Serif SC', serif"
                            },
                            formatter: (value, ctx) => {
                                const percentage = ((value / total) * 100).toFixed(2);
                                return percentage > 5 ? `${percentage}%` : '';
                            },
                            anchor: 'center',
                            align: 'center',
                            offset: 0,
                            borderWidth: 2,
                            borderRadius: 4,
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor[context.dataIndex];
                            },
                            opacity: 0.9
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // 显示当前五行概览
            const currentSummary = document.getElementById('current-elements-summary');
            const strongest = Object.keys(elements).reduce((a, b) => elements[a] > elements[b] ? a : b);
            const weakest = Object.keys(elements).reduce((a, b) => elements[a] < elements[b] ? a : b);
            
            const elementNames = {
                wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
            };
            
            // 计算五行平衡度
            const avg = total / 5;
            const deviation = Object.values(elements).reduce((sum, val) => sum + Math.abs(val - avg), 0) / total;
            const balancePercentage = (1 - deviation) * 100;
            let balanceLevel;
            if (balancePercentage >= 85) balanceLevel = '极佳';
            else if (balancePercentage >= 70) balanceLevel = '良好';
            else if (balancePercentage >= 50) balanceLevel = '一般';
            else balanceLevel = '失衡';
            
            currentSummary.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(240,240,240,0.7)); padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);">
                    <div style="margin-bottom: 8px; font-size: 0.85rem;">
                        <span style="color: #2e7d32; font-weight: bold;">当前运势：</span>
                        <span style="color: #1976d2;">${currentYear}年${currentData.yearGanZhi}</span>
                        ${currentData.dayunGanZhi ? `<span style="margin-left: 8px; color: #388e3c;">大运${currentData.dayunGanZhi}</span>` : ''}
                    </div>
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: 8px;">
                        <div style="min-width: 100px; margin-bottom: 4px; font-size: 0.85rem;">
                            <span style="font-weight: bold; color: ${elementColors[strongest].main};">最强：</span>
                            <span style="background: ${elementColors[strongest].light}; padding: 2px 6px; border-radius: 12px; color: #fff; font-weight: bold; font-size: 0.8rem;">
                                ${elementNames[strongest]} ${((elements[strongest]/total)*100).toFixed(1)}%
                            </span>
                        </div>
                        <div style="min-width: 100px; margin-bottom: 4px; font-size: 0.85rem;">
                            <span style="font-weight: bold; color: ${elementColors[weakest].main};">最弱：</span>
                            <span style="background: ${elementColors[weakest].light}; padding: 2px 6px; border-radius: 12px; color: #fff; font-weight: bold; font-size: 0.8rem;">
                                ${elementNames[weakest]} ${((elements[weakest]/total)*100).toFixed(1)}%
                            </span>
                        </div>
                    </div>
                    <div style="font-size: 0.8rem; line-height: 1.4;">
                        <span style="color: #2c3e50;">五行分布：</span>
                        <span style="color: ${elementColors.wood.main};">木${elements.wood.toFixed(1)}</span> |
                        <span style="color: ${elementColors.fire.main};">火${elements.fire.toFixed(1)}</span> |
                        <span style="color: ${elementColors.earth.main};">土${elements.earth.toFixed(1)}</span> |
                        <span style="color: ${elementColors.metal.main};">金${elements.metal.toFixed(1)}</span> |
                        <span style="color: ${elementColors.water.main};">水${elements.water.toFixed(1)}</span>
                    </div>
                </div>
            `;
        }
        
        // 更新五行分析描述函数
        function updateElementsDescription(originalElements, currentElements) {
            const description = document.getElementById('elements-description');
            
            const elementNames = {
                wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
            };
            
            // 计算变化
            const changes = {};
            Object.keys(originalElements).forEach(element => {
                changes[element] = currentElements.elements[element] - originalElements[element];
            });
            
            // 找出变化最大的五行
            const maxIncrease = Object.keys(changes).reduce((a, b) => changes[a] > changes[b] ? a : b);
            const maxDecrease = Object.keys(changes).reduce((a, b) => changes[a] < changes[b] ? a : b);
            
            description.innerHTML = `
                <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid #4caf50; padding-bottom: 8px;">
                    <i class="fas fa-chart-bar"></i> 五行力量对比分析
                </h4>
                
                <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05)); padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-left: 4px solid #4caf50;">
                    <p style="margin: 0 0 10px 0; font-size: 0.95rem; line-height: 1.5;">
                        <strong>运势影响分析：</strong>当前大运和流年的加入，使您的五行力量发生了显著变化。
                        ${changes[maxIncrease] > 0 ? `<span style="color: #2e7d32; font-weight: bold;">${elementNames[maxIncrease]}力量增强最多（+${changes[maxIncrease].toFixed(1)}点）</span>` : ''}${changes[maxIncrease] > 0 && changes[maxDecrease] < 0 ? '，' : ''}${changes[maxDecrease] < 0 ? `<span style="color: #d32f2f; font-weight: bold;">${elementNames[maxDecrease]}力量减弱（${changes[maxDecrease].toFixed(1)}点）</span>` : ''}
                    </p>
                    
                    <p style="margin: 0 0 10px 0; font-size: 0.95rem; line-height: 1.5;">
                        <strong>当前运势特点：</strong>
                        ${currentElements.yearGanZhi ? `${new Date().getFullYear()}年${currentElements.yearGanZhi}年为您带来了${getYearInfluence(currentElements.yearGanZhi)}的能量。` : ''}
                        ${currentElements.dayunGanZhi ? `当前大运${currentElements.dayunGanZhi}进一步${getDayunInfluence(currentElements.dayunGanZhi)}。` : ''}
                    </p>
                    
                    <p style="margin: 0; font-size: 0.95rem; line-height: 1.5;">
                        <strong>运势建议：</strong>
                        ${getTimingAdvice(maxIncrease, maxDecrease, changes)}
                    </p>
                </div>
            `;
        }
        
        // 获取流年影响描述
        function getYearInfluence(yearGanZhi) {
            const yearStem = yearGanZhi.charAt(0);
            const yearBranch = yearGanZhi.charAt(1);
            
            const stemInfluence = {
                '甲': '积极进取', '乙': '温和包容',
                '丙': '热情活力', '丁': '细致温暖',
                '戊': '稳重踏实', '己': '谨慎细心',
                '庚': '果断坚毅', '辛': '精致优雅',
                '壬': '灵活变通', '癸': '深沉内敛'
            };
            
            return stemInfluence[yearStem] || '平衡';
        }
        
        // 获取大运影响描述
        function getDayunInfluence(dayunGanZhi) {
            const dayunStem = dayunGanZhi.charAt(0);
            
            const stemInfluence = {
                '甲': '增强了您的创新能力', '乙': '提升了您的适应性',
                '丙': '激发了您的表现力', '丁': '增进了您的人际关系',
                '戊': '稳固了您的基础', '己': '提高了您的执行力',
                '庚': '强化了您的决断力', '辛': '精进了您的技能',
                '壬': '拓展了您的视野', '癸': '深化了您的思考'
            };
            
            return stemInfluence[dayunStem] || '平衡了您的能量';
        }
        
        // 获取时机建议
        function getTimingAdvice(maxIncrease, maxDecrease, changes) {
            const elementNames = {
                wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
            };
            
            const advice = {
                wood: '适合学习、创新、规划新项目',
                fire: '适合表现、社交、推广宣传',
                earth: '适合稳固基础、储蓄理财',
                metal: '适合整理、决策、执行计划',
                water: '适合思考、调研、灵活应变'
            };
            
            let result = '';
            if (changes[maxIncrease] > 1) {
                result += `当前${elementNames[maxIncrease]}力量强盛，${advice[maxIncrease]}。`;
            }
            if (changes[maxDecrease] < -0.5) {
                result += `需要注意${elementNames[maxDecrease]}力量不足，建议通过相应方式进行补充。`;
            }
            
            return result || '五行力量相对平衡，适合稳步发展。';
        }
        
        // 修改原有的displayElementsChart调用，添加描述更新
        function displayElementsChartComplete(baziData) {
            // 显示原命局五行分布
            displayOriginalElementsChart(baziData.elements);
            
            // 计算并显示当前五行分布（包含大运流年）
            const currentYear = new Date().getFullYear();
            const currentElements = calculateCurrentElements(baziData.elements, currentYear);
            displayCurrentElementsChart(currentElements, currentYear);
            
            // 更新五行分析描述
            updateElementsDescription(baziData.elements, currentElements);
        }
        
        // 显示五行分析描述（保留原有功能）
        function displayOriginalElementsDescription() {
            const description = document.getElementById('elements-description');
            description.innerHTML = `
                <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2rem; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
                    <i class="fas fa-chart-bar"></i> 五行分析
                </h4>
                
                <div style="margin-bottom: 18px;">
                    <h5 style="color: ${elementColors[strongest].main}; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center;">
                        <i class="fas ${elementProperties[strongest].icon}" style="margin-right: 8px;"></i> ${elementNames[strongest]}的特性与影响
                    </h5>
                    <div style="background: linear-gradient(135deg, rgba(${strongest === 'wood' ? '46, 204, 113, 0.15' : strongest === 'fire' ? '231, 76, 60, 0.15' : strongest === 'earth' ? '243, 156, 18, 0.15' : strongest === 'metal' ? '149, 165, 166, 0.15' : '52, 152, 219, 0.15'}, 1), rgba(${strongest === 'wood' ? '46, 204, 113, 0.05' : strongest === 'fire' ? '231, 76, 60, 0.05' : strongest === 'earth' ? '243, 156, 18, 0.05' : strongest === 'metal' ? '149, 165, 166, 0.05' : '52, 152, 219, 0.05'}, 1)); padding: 15px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-left: 4px solid ${elementColors[strongest].main};">
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>性质：</strong>${elementProperties[strongest].nature}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>性格特点：</strong>${elementProperties[strongest].character}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>性格分析：</strong>${elementProperties[strongest].personality}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>事业方向：</strong>${elementProperties[strongest].career}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>事业特点：</strong>${elementProperties[strongest].career_detail}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>健康关注：</strong>${elementProperties[strongest].health}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>健康建议：</strong>${elementProperties[strongest].health_advice}</p>
                        <p style="margin: 0; font-size: 0.95rem;"><strong>有利环境：</strong>${elementProperties[strongest].favorable}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 18px;">
                    <h5 style="color: #2c3e50; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center;">
                        <i class="fas fa-balance-scale" style="margin-right: 8px;"></i> 五行平衡建议
                    </h5>
                    <div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(52, 152, 219, 0.05)); padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-left: 4px solid #3498db;">
                        <p style="margin: 0 0 10px 0; font-size: 0.95rem;">${getFiveElementsAdvice(strongest, weakest)}</p>
                        <p style="margin: 0 0 10px 0; font-size: 0.95rem;"><strong>五行组合特点：</strong>
                            ${strongest}${secondStrongest !== strongest ? `和${secondStrongest}` : ''}较强，表现为${elementProperties[strongest].character.split('、')[0]}${secondStrongest !== strongest ? `和${elementProperties[secondStrongest].character.split('、')[0]}` : ''}的特质突出。
                            ${weakest === strongest ? '' : `${weakest}较弱，可能缺乏${elementProperties[weakest].character.split('、')[0]}的特质。`}
                        </p>
                        <p style="margin: 0; font-size: 0.95rem;"><strong>补充${elementNames[weakest]}的方法：</strong>
                            ${weakest === 'wood' ? '多接触绿色植物，在东方位置活动，春季出行，佩戴绿色饰品，多吃绿色蔬菜' : 
                              weakest === 'fire' ? '增加红色装饰，在南方位置活动，夏季出行，佩戴红色饰品，适当晒太阳' : 
                              weakest === 'earth' ? '使用黄色、棕色物品，在中央位置活动，季节交替时多出门，多吃黄色食物' : 
                              weakest === 'metal' ? '佩戴金属饰品，在西方位置活动，秋季出行，使用白色物品，保持环境整洁' : 
                              '多喝水，在北方位置活动，冬季出行，使用蓝色或黑色物品，接触水域环境'}
                        </p>
                    </div>
                </div>
                

            `;
        }

        // 获取五行建议
        function getFiveElementsAdvice(strongest, weakest) {
            const adviceMap = {
                wood: '宜从事与木相关的行业，如林业、园艺、文教等',
                fire: '宜从事与火相关的行业，如能源、餐饮、娱乐等',
                earth: '宜从事与土相关的行业，如房地产、农业、建筑等',
                metal: '宜从事与金相关的行业，如金融、机械、汽车等',
                water: '宜从事与水相关的行业，如航运、水利、贸易等'
            };
            
            return `五行${strongest === 'wood' ? '木' : strongest === 'fire' ? '火' : strongest === 'earth' ? '土' : strongest === 'metal' ? '金' : '水'}最强，${adviceMap[strongest]}。需要补充${weakest === 'wood' ? '木' : weakest === 'fire' ? '火' : weakest === 'earth' ? '土' : weakest === 'metal' ? '金' : '水'}元素。`;
        }

        // 显示身强身弱图表
        function displayStrengthChart(baziData) {
            console.log('显示身强身弱分析，数据:', baziData.strengthAnalysis);
            
            // 使用window.combinedInfo获取最新的合化信息
            if (window.combinedInfo) {
                console.log('从window.combinedInfo获取合化信息:', window.combinedInfo);
                baziData.strengthAnalysis.combined = window.combinedInfo;
            } else {
                console.log('合化信息:', baziData.strengthAnalysis.combined);
            }
            
            // 打印完整的strengthAnalysis对象，用于调试
            console.log('完整的strengthAnalysis对象:', JSON.stringify(baziData.strengthAnalysis, null, 2));
            
            // 检查八字中是否有巳酉丑三合金局
            const branches = window.allBranches || [];
            console.log('当前八字地支:', branches);
            
            // 特别检查巳酉丑三合金局
            const metalCombo = '巳酉丑';
            const metalMatches = [];
            let metalMatchCount = 0;
            
            for (const char of metalCombo) {
                if (branches.includes(char)) {
                    metalMatchCount++;
                    metalMatches.push(char);
                }
            }
            
            console.log(`特别检查巳酉丑三合金局:`, metalMatches, metalMatchCount);
            
            if (baziData.strengthAnalysis.combined && baziData.strengthAnalysis.combined.sanhe) {
                console.log('三合局详情:', baziData.strengthAnalysis.combined.sanhe);
            } else {
                console.log('没有检测到三合局');
                
                // 如果系统没有检测到三合局，但实际上有巳酉丑三合金局
                if (metalMatchCount >= 2) {
                    console.log('手动检测到巳酉丑三合金局:', metalMatches.join(''));
                    
                    // 手动添加三合局信息
                    if (!baziData.strengthAnalysis.combined) {
                        baziData.strengthAnalysis.combined = {};
                    }
                    
                    baziData.strengthAnalysis.combined.sanhe = {
                        type: '巳酉丑',
                        element: 'metal',
                        count: metalMatchCount,
                        branches: metalMatches.join(''),
                        isFullSanhe: metalMatchCount === 3
                    };
                    
                    // 移除特殊处理，使用统一effect
                }
            }
            
            const canvas = document.getElementById('strength-chart');
            const ctx = canvas.getContext('2d');
            const strengthAnalysis = baziData.strengthAnalysis;
            
            // 调试信息：检查数据值
            console.log('原命局图表数据:', {
                supportStrength: strengthAnalysis.supportStrength,
                weakenStrength: strengthAnalysis.weakenStrength,
                canvasWidth: canvas.clientWidth,
                canvasHeight: canvas.clientHeight
            });
            
            // 强制重置canvas尺寸
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            
            if (strengthChart) {
                strengthChart.destroy();
            }
            
            strengthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['生扶力量', '克泄力量'],
                    datasets: [{
                        label: '力量对比',
                        data: [strengthAnalysis.supportStrength, strengthAnalysis.weakenStrength],
                        backgroundColor: [
                            '#27ae60', // 生扶 - 绿色
                            '#e74c3c'  // 克泄 - 红色
                        ],
                        borderWidth: 2,
                        borderColor: '#fff',
                        barThickness: 60,
                        maxBarThickness: 80
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                     const yVal = typeof context.parsed.y === 'number' ? context.parsed.y : parseFloat(context.parsed.y);
                                     return `${context.label}: ${yVal.toFixed(2)}点`;
                                 }
                             }
                         },
                         datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value) => Number(value).toFixed(2),
                            color: '#333',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                     },
                     scales: {
                         x: {
                             grid: {
                                 display: false
                             },
                             ticks: {
                                 font: {
                                     size: 12
                                 }
                             }
                         },
                         y: {
                             beginAtZero: true,
                             grid: {
                                 color: 'rgba(0,0,0,0.1)'
                             },
                             title: {
                                 display: true,
                                 text: '力量值',
                                 font: {
                                     size: 12
                                 }
                             },
                             ticks: {
                                 font: {
                                     size: 11
                                 },
                                 callback: function(value) {
                                     return Number(value).toFixed(2);
                                 }
                             }
                         }
                     }
                 }
             });
             
             // 显示身强身弱分析描述
             const description = document.getElementById('strength-description');
             
             // 根据不同类型设置不同的图标和颜色
             let typeIcon, typeColor;
             switch(strengthAnalysis.type) {
                 case '身强':
                     typeIcon = 'fa-fire';
                     typeColor = '#e74c3c';
                     break;
                 case '身弱':
                     typeIcon = 'fa-snowflake';
                     typeColor = '#3498db';
                     break;
                 case '均衡':
                     typeIcon = 'fa-balance-scale';
                     typeColor = '#f39c12';
                     break;
                 case '从强':
                     typeIcon = 'fa-arrow-up';
                     typeColor = '#9b59b6';
                     break;
                 case '从弱':
                     typeIcon = 'fa-arrow-down';
                     typeColor = '#2ecc71';
                     break;
                 default:
                     typeIcon = 'fa-balance-scale';
                     typeColor = '#7f8c8d';
             }
             
             description.innerHTML = `
                 <h4><i class="fas fa-balance-scale"></i> 身强身弱分析</h4>
                 <div style="display: flex; align-items: center; margin-bottom: 10px;">
                     <div style="background-color: ${typeColor}; color: white; padding: 5px 10px; border-radius: 5px; margin-right: 10px;">
                         <i class="fas ${typeIcon}"></i> ${strengthAnalysis.type}
                     </div>
                     <div>力量比例: ${(strengthAnalysis.ratio * 100).toFixed(2)}%</div>
                 </div>
                 <p><strong>生扶力量:</strong> ${strengthAnalysis.supportStrength.toFixed(2)}点</p>
                 <p><strong>克泄力量:</strong> ${strengthAnalysis.weakenStrength.toFixed(2)}点</p>
                 ${strengthAnalysis.monthScore ? `<p><strong>月令得分:</strong> ${strengthAnalysis.monthScore}点</p>` : ''}
                 ${strengthAnalysis.combined && strengthAnalysis.combined.effect ? `<p><strong>合化影响:</strong> ${strengthAnalysis.combined.effect === 'strengthen' ? '增强日主' : '削弱日主'}</p>` : ''}
                 ${strengthAnalysis.combined && strengthAnalysis.combined.deduction ? `<p><strong>合化扣分:</strong> <span style="color: #e74c3c; font-weight: bold;">${strengthAnalysis.combined.deduction}点</span></p>` : ''}
                 <div class="hehua-info">
                 ${strengthAnalysis.combined && (strengthAnalysis.combined.tianGanWuHe.length > 0 || strengthAnalysis.combined.diZhiLiuHe.length > 0 || strengthAnalysis.combined.diZhiSanHe.length > 0) ? 
                    `<div style="background-color: #e8f4fc; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #3498db; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <h5 style="color: #3498db; margin-top: 0; font-size: 16px;"><i class="fas fa-link"></i> 合化信息</h5>
                        ${strengthAnalysis.combined.tianGanWuHe.length > 0 ? 
                            `<div style="margin-bottom: 10px;">
                                <p><strong>天干五合:</strong> ${strengthAnalysis.combined.tianGanWuHe.map(h => `${h.gan1}${h.gan2}合${h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水'}`).join('、')}</p>
                            </div>` : ''}
                        ${strengthAnalysis.combined.diZhiLiuHe.length > 0 ? 
                            `<div style="margin-bottom: 10px;">
                                <p><strong>地支六合:</strong> ${strengthAnalysis.combined.diZhiLiuHe.map(h => `${h.zhi1}${h.zhi2}合${h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水'}`).join('、')}</p>
                            </div>` : ''}
                        ${strengthAnalysis.combined.diZhiSanHe.length > 0 ? 
                            `<div style="margin-bottom: 10px;">
                                <p><strong>地支三合:</strong> ${strengthAnalysis.combined.diZhiSanHe.map(h => `${h.type}三合${h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水'}(${h.count === 3 ? '全三合' : '半三合'})`).join('、')}</p>
                            </div>` : ''}
                        <p><strong>对日主影响:</strong> <span style="color: ${strengthAnalysis.combined.effect === 'strengthen' ? '#27ae60' : strengthAnalysis.combined.effect === 'weaken' ? '#e74c3c' : '#7f8c8d'}; font-weight: bold;">${strengthAnalysis.combined.effect === 'strengthen' ? '增强日主' : strengthAnalysis.combined.effect === 'weaken' ? '削弱日主' : '影响中性'}</span></p>
                        ${strengthAnalysis.combined.deduction ? `<p><strong>力量扣减:</strong> <span style="color: #e74c3c; font-weight: bold;">${strengthAnalysis.combined.deduction}点</span> (合化影响)</p>` : ''}
                    </div>` : `<div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px dashed #ccc;">
                        <p style="color: #7f8c8d; margin: 0;"><i class="fas fa-info-circle"></i> 未检测到合化</p>
                    </div>`}
                 </div>
                 <p><strong>分析说明:</strong> ${strengthAnalysis.description}</p>
             `;
             
             // 调整图表容器和描述容器的样式，确保左右并排显示
             const strengthAnalysisFrame = document.querySelector('.strength-analysis-frame');
             const chartContainer = document.querySelector('.chart-container');
             const descriptionContainer = document.getElementById('strength-description');
             
             if (strengthAnalysisFrame && chartContainer && descriptionContainer) {
                 // 确保上下排列显示
                strengthAnalysisFrame.style.display = 'flex';
                strengthAnalysisFrame.style.flexDirection = 'column';
                strengthAnalysisFrame.style.gap = '15px';
                strengthAnalysisFrame.style.flexWrap = 'nowrap';
                 
                 // 设置图表容器样式 - 注释掉以避免覆盖CSS样式
                // chartContainer.style.flex = 'none';
                // chartContainer.style.width = '100%';
                // chartContainer.style.height = '250px';
                 // chartContainer.style.backgroundColor = '#ffffff';
                 // chartContainer.style.padding = '15px';
                 // chartContainer.style.borderRadius = '8px';
                 // chartContainer.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                 
                 // 设置描述容器样式
                descriptionContainer.style.flex = 'none';
                descriptionContainer.style.width = '100%';
                 descriptionContainer.style.padding = '15px';
                 descriptionContainer.style.backgroundColor = '#f9f9f9';
                 descriptionContainer.style.borderRadius = '8px';
                 descriptionContainer.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
             }
         }

         // 显示起运时间
         function displayLuckTiming(baziData) {
             const luckTiming = document.getElementById('luck-timing');
             const timing = baziData.luckTiming;
             
             // 获取当前大运信息
             const currentDayun = getCurrentDayun();
             
             // 获取日主天干和当前年龄
             const dayStem = baziData.pillars?.day?.charAt(0) || '甲'; // 获取日主天干，默认为甲
             const currentAge = currentDayun?.currentAge || 25; // 默认年龄25岁
             
             // 动态计算12长生状态数据
             const twelveStages = calculateTwelveStages(dayStem, timing, currentAge);
             
             luckTiming.innerHTML = `
                 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                     <div class="analysis-card">
                         <h4><i class="fas fa-clock"></i> 起运年龄</h4>
                         <p style="font-size: 1.6rem; font-weight: bold; color: var(--secondary-color); margin: 6px 0;">
                             ${timing.age}岁${timing.months}个月
                         </p>
                         <p style="color: var(--primary-color); font-weight: 600; margin: 4px 0;">${timing.description}</p>
                         <div style="margin-top: 6px; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.3;">
                             <p style="margin: 2px 0;"><strong>排列方式：</strong>${timing.direction}</p>
                             <p style="margin: 2px 0;"><strong>节气天数：</strong>${timing.daysDiff}天</p>
                             <p style="margin: 2px 0;"><strong>当前大运：</strong><span style="color: var(--primary-color); font-weight: bold;">${currentDayun.ganZhi}</span> (${currentDayun.startAge}-${currentDayun.endAge}岁，当前${currentDayun.currentAge}岁)</p>
                         </div>
                     </div>
                     <div class="analysis-card">
                         <h4><i class="fas fa-info-circle"></i> 起运说明</h4>
                         <p>起运时间是命理学中的重要概念，标志着人生运势的正式开始。</p>
                         <p>计算方法：根据年柱天干阴阳和性别确定顺排或逆排，然后计算出生日到最近节气的天数，3天折合1岁。</p>
                         <p>在起运之前，主要受父母和家庭环境影响；起运之后，个人运势开始发挥主导作用。</p>
                     </div>
                 </div>
                 
                 <!-- 12长生分析容器 -->
                 <div class="analysis-card" style="margin-top: 20px;">
                     <h4 style="margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; gap: 8px;">
                         <i class="fas fa-yin-yang"></i> 十二长生运势分析
                     </h4>
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                         ${twelveStages.map(stage => `
                             <div style="
                                 background: linear-gradient(135deg, ${stage.color}15, ${stage.color}08);
                                 border: ${stage.isCurrent ? `2px solid ${stage.color}` : `1px solid ${stage.color}30`};
                                 border-radius: 10px;
                                 padding: 12px;
                                 text-align: center;
                                 transition: all 0.3s ease;
                                 position: relative;
                                 overflow: hidden;
                                 ${stage.isCurrent ? `box-shadow: 0 4px 15px ${stage.color}40; transform: scale(1.02);` : ''}
                             " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px ${stage.color}25'" onmouseout="this.style.transform='${stage.isCurrent ? 'scale(1.02)' : 'translateY(0)'}'; this.style.boxShadow='${stage.isCurrent ? `0 4px 15px ${stage.color}40` : 'none'}'">
                                 <div style="
                                     position: absolute;
                                     top: 0;
                                     left: 0;
                                     right: 0;
                                     height: 3px;
                                     background: linear-gradient(90deg, ${stage.color}, ${stage.color}80);
                                 "></div>
                                 <div style="
                                     font-size: 1.1rem;
                                     font-weight: bold;
                                     color: ${stage.color};
                                     margin-bottom: 6px;
                                 ">${stage.name}${stage.isCurrent ? ' <span style="color: var(--gold-color); font-size: 0.8rem;">●当前</span>' : ''}</div>
                                 <div style="
                                     font-size: 0.85rem;
                                     color: var(--text-secondary);
                                     margin-bottom: 4px;
                                 ">大运: <span style="color: var(--primary-color); font-weight: 600;">${stage.dayun}</span></div>
                                 <div style="
                                     font-size: 0.8rem;
                                     color: ${stage.color};
                                     font-weight: 600;
                                     margin-bottom: 4px;
                                 ">能量: ${stage.energy}</div>
                                 <div style="
                                     font-size: 0.8rem;
                                     color: var(--primary-color);
                                     font-weight: 600;
                                     margin-bottom: 6px;
                                 ">年龄: ${stage.ageRange}</div>
                                 <div style="
                                     font-size: 0.75rem;
                                     color: var(--text-secondary);
                                     line-height: 1.3;
                                 ">${stage.description}</div>
                             </div>
                         `).join('')}
                     </div>
                     <div style="
                         margin-top: 15px;
                         padding: 12px;
                         background: rgba(var(--primary-color-rgb), 0.08);
                         border-radius: 8px;
                         border-left: 4px solid var(--primary-color);
                     ">
                         <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
                             <i class="fas fa-lightbulb" style="color: var(--gold-color); margin-right: 5px;"></i>
                             十二长生代表生命力的循环变化，从长生到死再到养，体现了事物发展的自然规律。了解当前所处的长生阶段，有助于把握人生节奏，顺势而为。
                         </p>
                     </div>
                 </div>
             `;
         }

         // 显示命格等级
         function displayFateLevel(baziData) {
             const fateLevelContent = document.getElementById('fate-level-content');
             const fateLevel = baziData.fateLevel;
             
             fateLevelContent.innerHTML = `
                 <div style="text-align: center; margin-bottom: 10px;">
                     <div style="font-size: 2.5rem; font-weight: bold; color: var(--gold-color); margin-bottom: 5px;">
                         ${Number(fateLevel.score || 0).toFixed(2)}分
                     </div>
                     <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">
                         ${fateLevel.level}
                     </div>
                     <div style="color: var(--text-secondary); font-size: 0.95rem;">
                         ${fateLevel.description}
                     </div>
                 </div>
                 <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); margin-top: 10px;">
                     <div style="margin-top: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 12px;">

                         <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 20px;">
                             <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                                 <i class="fas fa-calculator"></i> 命格等级评分构成
                             </h4>

                             <div style="margin-bottom: 20px;">
                                 <h5 style="color: var(--primary-color); margin-bottom: 12px;">
                                     <i class="fas fa-layer-group"></i> 基础模块评分
                                 </h5>
                                 <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                     <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #3498db;">季节助力：</strong> ${Number(fateLevel.details.seasonScore || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">月令得气、通根透干的力量</small>
                                     </div>
                                     <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #27ae60;">五行平衡：</strong> ${Number(fateLevel.details.balanceScore || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">八字五行分布的均衡性</small>
                                     </div>
                                     <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #9b59b6;">格局结构：</strong> ${Number(fateLevel.details.patternScore || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">特殊格局的识别与完整性</small>
                                     </div>
                                     <div style="background: rgba(230, 126, 34, 0.08); border: 1px solid rgba(230, 126, 34, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e67e22;">十神影响：</strong> ${Number(fateLevel.details.godsScore || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">十神配置的协调性</small>
                                     </div>
                                     <div style="background: rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e74c3c;">组合刑冲：</strong> ${Number(fateLevel.details.combinationScore || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">地支组合关系的影响</small>
                                     </div>
                                     <div style="background: rgba(52, 73, 94, 0.08); border: 1px solid rgba(52, 73, 94, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #34495e;">调候用神：</strong> ${Number(fateLevel.details.adjustmentScore || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">调候用神的配置效果</small>
                                     </div>
                                 </div>
                             </div>

                             <div style="margin-bottom: 20px;">
                                 <h5 style="color: var(--warning-color); margin-bottom: 12px;">
                                     <i class="fas fa-cogs"></i> 进阶与修正评分
                                 </h5>
                                 <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                     <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #3498db;">日主强弱：</strong> ${Number(fateLevel.details.dayMasterStrength || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">日主旺衰程度评估</small>
                                     </div>
                                     <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #27ae60;">用神得力：</strong> ${Number(fateLevel.details.usefulGodScore || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">用神在八字中的力量</small>
                                     </div>
                                     <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #9b59b6;">忌神制约：</strong> ${Number(fateLevel.details.tabooGodControl || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">忌神的制约程度</small>
                                     </div>
                                     <div style="background: rgba(230, 126, 34, 0.08); border: 1px solid rgba(230, 126, 34, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e67e22;">空亡减分：</strong> -${Number(fateLevel.details.kongWangPenalty || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">空亡对命格的负面影响</small>
                                     </div>
                                     <div style="background: rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e74c3c;">流年助力：</strong> ${Number(fateLevel.details.luckSupport || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">当前流年的促进作用</small>
                                     </div>
                                     <div style="background: rgba(52, 73, 94, 0.08); border: 1px solid rgba(52, 73, 94, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #34495e;">大运配合：</strong> ${Number(fateLevel.details.dayunCoordination || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">当前大运与命格的配合</small>
                                     </div>
                                 </div>
                             </div>

                             <div style="margin-bottom: 20px;">
                                 <h5 style="color: var(--danger-color); margin-bottom: 12px;">
                                     <i class="fas fa-star"></i> 格局与特效评分
                                 </h5>
                                 <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                     <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #3498db;">贵人助力：</strong> ${Number(fateLevel.details.noblesSupport || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">天乙贵人等神煞的作用</small>
                                     </div>
                                     <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #27ae60;">特殊格局：</strong> ${Number(fateLevel.details.specialPatternBonus || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">从格、化格等特殊格局加成</small>
                                     </div>
                                     <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #9b59b6;">命格层次：</strong> ${Number(fateLevel.details.levelBonus || 0).toFixed(2)} 分
                                         <br><small style="color: #666;">整体命格层次的评估</small>
                                     </div>
                                 </div>
                             </div>
                             
                             <div style="padding: 15px; background: rgba(52, 73, 94, 0.05); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                     <h5 style="margin: 0; color: var(--primary-color);">
                                         <i class="fas fa-chart-line"></i> 命格评分汇总
                                     </h5>
                                     <div style="display: flex; gap: 15px;">
                                         <div style="text-align: center;">
                                             <div style="font-size: 0.9rem; color: #666;">基础合计</div>
                                             <div style="font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">
                                                 ${Number(fateLevel.details.baseScore || 0).toFixed(2)} 分
                                             </div>
                                         </div>
                                         <div style="text-align: center;">
                                             <div style="font-size: 0.9rem; color: #666;">最终得分</div>
                                             <div style="font-size: 1.3rem; font-weight: bold; color: var(--gold-color);">
                                                 ${Number(fateLevel.details.total || 0).toFixed(2)} 分
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 <p style="font-size: 0.9rem; color: #666; margin: 0; line-height: 1.5;">
                                     命格等级评分采用传统八字理论结合现代评分体系，从多个维度综合评估命格的优劣。分数越高表示命格层次越高，人生发展潜力越大。
                                 </p>
                             </div>
                         </div>
                     </div>
                 </div>
             `;
         }

         // 显示财富等级
         function displayWealthLevel(baziData) {
             const wealthLevelContent = document.getElementById('wealth-level-content');
             const wealthLevel = baziData.wealthLevel;
             
             wealthLevelContent.innerHTML = `
                 <div style="text-align: center; margin-bottom: 10px;">
                     <div style="font-size: 2.5rem; font-weight: bold; color: var(--success-color); margin-bottom: 5px;">
                         ${wealthLevel.score}分
                     </div>
                     <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">
                         ${wealthLevel.level}
                     </div>
                     <div style="color: var(--text-secondary); font-size: 0.95rem;">
                         ${wealthLevel.description}
                     </div>
                 </div>
                 <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); margin-top: 10px;">

                     <div style="margin-top: 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 12px;">
<div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 20px;">
                             <h4 style="color: var(--success-color); margin-bottom: 15px;">
                                 <i class="fas fa-calculator"></i> 财富等级评分构成
                             </h4>

                             <div style="margin-bottom: 20px;">
                                 <h5 style="color: var(--primary-color); margin-bottom: 12px;">
                                     <i class="fas fa-layer-group"></i> 基础模块评分
                                 </h5>
                                 <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                     <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #3498db;">食伤生财：</strong> ${wealthLevel.details.shishangScore || 0} 分
                                         <br><small style="color: #666;">食神伤官生财星的能力</small>
                                     </div>
                                     <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #27ae60;">印绶护身：</strong> ${wealthLevel.details.yinshouScore || 0} 分
                                         <br><small style="color: #666;">印星保护日主的作用</small>
                                     </div>
                                     <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #9b59b6;">财星能量：</strong> ${wealthLevel.details.wealthStarScore || 0} 分
                                         <br><small style="color: #666;">财星在八字中的力量</small>
                                     </div>
                                     <div style="background: rgba(230, 126, 34, 0.08); border: 1px solid rgba(230, 126, 34, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e67e22;">财星位置：</strong> ${wealthLevel.details.wealthPositionScore || 0} 分
                                         <br><small style="color: #666;">财星在四柱中的位置</small>
                                     </div>
                                     <div style="background: rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e74c3c;">财富库藏：</strong> ${wealthLevel.details.wealthVaultScore || 0} 分
                                         <br><small style="color: #666;">财库的聚财能力</small>
                                     </div>
                                     <div style="background: rgba(52, 73, 94, 0.08); border: 1px solid rgba(52, 73, 94, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #34495e;">自坐财库：</strong> ${wealthLevel.details.selfVaultScore || 0} 分
                                         <br><small style="color: #666;">日支为财库的情况</small>
                                     </div>
                                     <div style="background: rgba(26, 188, 156, 0.08); border: 1px solid rgba(26, 188, 156, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #1abc9c;">财气通门户：</strong> ${wealthLevel.details.portalScore || 0} 分
                                         <br><small style="color: #666;">财气流通的顺畅度</small>
                                     </div>
                                     <div style="background: rgba(142, 68, 173, 0.08); border: 1px solid rgba(142, 68, 173, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #8e44ad;">日主承载：</strong> ${wealthLevel.details.dayMasterCapacity || 0} 分
                                         <br><small style="color: #666;">日主承载财富的能力</small>
                                     </div>
                                 </div>
                             </div>

                             <div style="margin-bottom: 20px;">
                                 <h5 style="color: var(--warning-color); margin-bottom: 12px;">
                                     <i class="fas fa-cogs"></i> 进阶与修正评分
                                 </h5>
                                 <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                     <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #3498db;">喜忌平衡：</strong> ${wealthLevel.details.favorableBalance || 0} 分
                                         <br><small style="color: #666;">喜用神与忌神的平衡</small>
                                     </div>
                                     <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #27ae60;">季节财运：</strong> ${wealthLevel.details.seasonalWealthPotential || 0} 分
                                         <br><small style="color: #666;">出生季节对财运的影响</small>
                                     </div>
                                     <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #9b59b6;">财星保护：</strong> ${wealthLevel.details.wealthProtectionScore || 0} 分
                                         <br><small style="color: #666;">财星的保护机制</small>
                                     </div>
                                     <div style="background: rgba(230, 126, 34, 0.08); border: 1px solid rgba(230, 126, 34, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e67e22;">空亡扣分：</strong> -${wealthLevel.details.kongWangPenalty || 0} 分
                                         <br><small style="color: #666;">空亡对财运的负面影响</small>
                                     </div>
                                     <div style="background: rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #e74c3c;">流年修正：</strong> ${wealthLevel.details.luckAdjustment || 0} 分
                                         <br><small style="color: #666;">当前流年的影响</small>
                                     </div>
                                     <div style="background: rgba(52, 73, 94, 0.08); border: 1px solid rgba(52, 73, 94, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #34495e;">大运强弱：</strong> ${wealthLevel.details.dayunStrength || 0} 分
                                         <br><small style="color: #666;">当前大运对财运的作用</small>
                                     </div>
                                 </div>
                             </div>

                             <div style="margin-bottom: 20px;">
                                 <h5 style="color: var(--danger-color); margin-bottom: 12px;">
                                     <i class="fas fa-star"></i> 格局与特效评分
                                 </h5>
                                 <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                     <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #3498db;">十神特效：</strong> ${wealthLevel.details.tenGodsBonus || 0} 分
                                         <br><small style="color: #666;">十神配置的特殊效果</small>
                                     </div>
                                     <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #27ae60;">特殊格局：</strong> ${wealthLevel.details.specialBonus || 0} 分（识别到${(wealthLevel.details.specialPatterns && wealthLevel.details.specialPatterns.length) ? wealthLevel.details.specialPatterns.length : 0}项）
                                         <br><small style="color: #666;">格局带来的额外加成</small>
                                     </div>
                                     <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                         <strong style="color: #9b59b6;">身财平衡：</strong> ${wealthLevel.details.balanceAdjustment || 0} 分
                                         <br><small style="color: #666;">身强身弱与财星之间的协调</small>
                                     </div>
                                 </div>
                             </div>

                             <div style="padding: 15px; background: rgba(52, 73, 94, 0.05); border-radius: 8px; border-left: 4px solid var(--success-color);">
                                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                     <h5 style="margin: 0; color: var(--success-color);">
                                         <i class="fas fa-chart-bar"></i> 财富评分汇总
                                     </h5>
                                     <div style="display: flex; gap: 15px;">
                                         <div style="text-align: center;">
                                             <div style="font-size: 0.9rem; color: #666;">基础合计</div>
                                             <div style="font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">
                                                 ${wealthLevel.details.baseScore || 0} 分
                                             </div>
                                         </div>
                                         <div style="text-align: center;">
                                             <div style="font-size: 0.9rem; color: #666;">最终得分</div>
                                             <div style="font-size: 1.3rem; font-weight: bold; color: var(--success-color);">
                                                 ${wealthLevel.score || 0} 分
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 <p style="font-size: 0.9rem; color: #666; margin: 0; line-height: 1.5;">
                                     财富等级评分综合考虑八字中的财星配置、生财机制、库藏能力、流通状况等多个维度，结合传统命理与现代分析方法，为您提供专业的财运评估。
                                 </p>
                             </div>
                         </div>
                     </div>
                 </div>
             `;
         }

         // 获取分析内容（备用内容，当API调用失败时使用）
         function getAnalysisContent(analysisType) {
             const analysisData = {
                 'full-analysis': {
                     title: '命理全解',
                     content: `
                         <h4>八字命理全面解析</h4>
                         <div style="padding: 15px; margin-bottom: 15px; background: #f0f8ff; border-left: 4px solid #3498db; border-radius: 8px;">
                             <h5><i class="fas fa-user"></i> 性格特质</h5>
                             <p>性格温和稳重，做事认真负责，具有较强的责任感和使命感。思维缜密，善于分析问题，但有时过于追求完美。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #fff5eb; border-left: 4px solid #e67e22; border-radius: 8px;">
                             <h5><i class="fas fa-briefcase"></i> 事业发展</h5>
                             <p>适合从事需要耐心和细致的工作，如教育、医疗、金融等领域。职业生涯中期将迎来重要转折点，有望获得晋升或创业机会。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #f9f9f9; border-left: 4px solid #f1c40f; border-radius: 8px;">
                             <h5><i class="fas fa-coins"></i> 财富运势</h5>
                             <p>财运稳健，收入来源主要为工作薪资，中年后有机会获得额外财富。投资方面宜稳健为主，避免高风险投机。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #ffebee; border-left: 4px solid #e74c3c; border-radius: 8px;">
                             <h5><i class="fas fa-heart"></i> 感情婚姻</h5>
                             <p>感情生活较为稳定，婚后家庭和睦。与伴侣相处需注重沟通，避免因工作忙碌而忽略家庭。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #e8f5e9; border-left: 4px solid #27ae60; border-radius: 8px;">
                             <h5><i class="fas fa-heartbeat"></i> 健康状况</h5>
                             <p>体质中等，需要注意消化系统和呼吸系统的保养。建议保持规律作息，适当运动，避免过度劳累。</p>
                         </div>
                         <div style="padding: 15px; background: #e3f2fd; border-left: 4px solid #3498db; border-radius: 8px;">
                             <h5><i class="fas fa-star"></i> 人生建议</h5>
                             <p>1. 事业上保持稳健发展，同时不要错过关键机遇</p>
                             <p>2. 财务管理注重长期规划，建立多元化收入</p>
                             <p>3. 感情上增加沟通，平衡工作与家庭</p>
                             <p>4. 健康方面定期体检，保持良好生活习惯</p>
                         </div>
                     `
                 },
                 'annual-fortune': {
                     title: '流年分析',
                     content: `
                         <h4>当前流年运势分析</h4>
                         <p><strong>整体运势：</strong>今年运势较为平稳，有小幅上升趋势。甲木遇辰土，需要注意脾胃健康。</p>
                         <p><strong>事业运：</strong>工作上会有新的机遇出现，但需要谨慎把握，不宜冒进。</p>
                         <p><strong>财运：</strong>财运中等，正财稳定，偏财需谨慎。</p>
                         <p><strong>感情运：</strong>感情运势平稳，已婚者夫妻和睦，单身者有机会遇到合适对象。</p>
                         <p><strong>健康运：</strong>注意消化系统健康，适当运动，保持良好作息。</p>
                     `
                 },
                 'monthly-fortune': {
                     title: '流月分析',
                     content: `
                         <h4>当前年份各月运势预测</h4>
                         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>春季（1-3月）</h5>
                                 <p>运势回升，适合开展新项目</p>
                             </div>
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>夏季（4-6月）</h5>
                                 <p>运势旺盛，事业财运双丰收</p>
                             </div>
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>秋季（7-9月）</h5>
                                 <p>运势平稳，需要稳扎稳打</p>
                             </div>
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>冬季（10-12月）</h5>
                                 <p>运势略有下滑，宜保守行事</p>
                             </div>
                         </div>
                     `
                 },
                 'decade-fortune': {
                     title: '十年大运分析',
                     content: `
                         <h4>人生各阶段大运走势</h4>
                         <div style="margin-top: 15px;">
                             <div style="padding: 15px; margin-bottom: 15px; background: #e8f5e8; border-left: 4px solid #27ae60; border-radius: 8px;">
                                 <h5>青年期（20-30岁）</h5>
                                 <p>学业运佳，适合深造和技能提升。事业起步阶段，需要积累经验。</p>
                             </div>
                             <div style="padding: 15px; margin-bottom: 15px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 8px;">
                                 <h5>壮年期（30-40岁）</h5>
                                 <p>事业发展的黄金期，财运逐渐好转，适合创业或投资。</p>
                             </div>
                             <div style="padding: 15px; margin-bottom: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 8px;">
                                 <h5>中年期（40-50岁）</h5>
                                 <p>运势达到顶峰，事业有成，财富积累丰厚，家庭和睦。</p>
                             </div>
                             <div style="padding: 15px; background: #cce5ff; border-left: 4px solid #007bff; border-radius: 8px;">
                                 <h5>晚年期（50岁以后）</h5>
                                 <p>运势平稳，享受人生，注重健康养生，子女孝顺。</p>
                             </div>
                         </div>
                     `
                 },
                 'personality': {
                     title: '性格分析',
                     content: `
                         <h4>性格特征分析</h4>
                         <p><strong>核心性格：</strong>性格温和，待人真诚，有责任心，做事认真负责。</p>
                         <p><strong>优点：</strong></p>
                         <ul>
                             <li>善良正直，品德高尚</li>
                             <li>勤奋努力，不怕吃苦</li>
                             <li>有耐心，能够坚持</li>
                             <li>重视家庭，孝顺父母</li>
                         </ul>
                         <p><strong>需要改进：</strong></p>
                         <ul>
                             <li>有时过于保守，缺乏冒险精神</li>
                             <li>容易犹豫不决，错失机会</li>
                             <li>对自己要求过高，压力较大</li>
                         </ul>
                         <p><strong>建议：</strong>适当增强自信心，勇于尝试新事物，学会适度放松。</p>
                     `
                 },
                 'career': {
                     title: '事业财富分析',
                     content: `
                         <h4>事业发展方向</h4>
                         <p><strong>适合行业：</strong>教育、文化、医疗、服务业、公务员等稳定性行业。</p>
                         <p><strong>职业特质：</strong>适合需要耐心和责任心的工作，不适合高风险高压力的行业。</p>
                         <p><strong>财富格局：</strong></p>
                         <ul>
                             <li>正财运较好，适合稳定收入的工作</li>
                             <li>偏财运一般，不宜投机取巧</li>
                             <li>理财能力强，善于积累财富</li>
                             <li>晚年财运更佳，越老越富</li>
                         </ul>
                         <p><strong>投资建议：</strong>选择稳健的投资方式，如定期存款、国债、蓝筹股等。</p>
                     `
                 },
                 'marriage': {
                     title: '婚姻分析',
                     content: `
                         <h4>婚姻感情分析</h4>
                         <p><strong>婚姻运势：</strong>婚姻运势较好，能够找到合适的伴侣，婚后生活和睦。</p>
                         <p><strong>配偶特征：</strong></p>
                         <ul>
                             <li>性格温和，善解人意</li>
                             <li>有一定的经济基础</li>
                             <li>重视家庭，顾家</li>
                             <li>可能从事稳定的职业</li>
                         </ul>
                         <p><strong>最佳结婚年龄：</strong>25-30岁之间，此时运势较好，容易遇到合适对象。</p>
                         <p><strong>婚姻建议：</strong>保持沟通，相互理解，共同经营家庭，避免因小事争吵。</p>
                     `
                 },
                 'children': {
                     title: '子女分析',
                     content: `
                         <h4>子女缘分分析</h4>
                         <p><strong>子女运：</strong>子女运较好，能够拥有健康聪明的孩子。</p>
                         <p><strong>子女特征：</strong></p>
                         <ul>
                             <li>聪明伶俐，学习能力强</li>
                             <li>性格活泼，富有创造力</li>
                             <li>孝顺懂事，与父母关系融洽</li>
                             <li>未来发展前景良好</li>
                         </ul>
                         <p><strong>教育建议：</strong></p>
                         <ul>
                             <li>注重品德教育，培养正确价值观</li>
                             <li>发掘孩子的兴趣爱好，因材施教</li>
                             <li>给予适当的自由空间，培养独立性</li>
                             <li>保持良好的亲子沟通</li>
                         </ul>
                     `
                 },
                 'health': {
                     title: '健康分析',
                     content: `
                         <h4>健康状况分析</h4>
                         <p><strong>整体健康：</strong>体质较好，但需要注意某些方面的保养。</p>
                         <p><strong>需要关注的健康问题：</strong></p>
                         <ul>
                             <li>消化系统：注意饮食规律，避免暴饮暴食</li>
                             <li>心血管：适当运动，控制情绪波动</li>
                             <li>呼吸系统：避免吸烟，注意空气质量</li>
                             <li>精神状态：学会放松，避免过度压力</li>
                         </ul>
                         <p><strong>养生建议：</strong></p>
                         <ul>
                             <li>保持规律作息，早睡早起</li>
                             <li>适当运动，如散步、太极等</li>
                             <li>饮食清淡，多吃蔬菜水果</li>
                             <li>定期体检，预防疾病</li>
                         </ul>
                     `
                 }
             };
             
             return analysisData[analysisType]?.content || '<p>分析内容正在生成中...</p>';
         }
         
         // Markdown内容格式化函数
         function formatMarkdownContent(content) {
             // 清理和预处理内容
             let formatted = content
                 .trim()
                 // 移除多余的空行，保留段落间距
                 .replace(/\n{3,}/g, '\n\n')
                 // 移除行首行尾空格
                 .replace(/^\s+|\s+$/gm, '')
                 // 移除所有#字符
                 .replace(/#/g, '');
             
             // 智能分段：按句号、问号、感叹号等结束符分段
             formatted = formatted
                 // 在句号、问号、感叹号后添加换行，但保留原有段落结构
                 .replace(/([。！？])([^\n])/g, '$1\n$2')
                 // 在冒号后如果跟着重要内容也分段
                 .replace(/([：:])([^\n]*[。！？])/g, '$1\n$2')
                 // 合并过短的行（少于10个字符）到前一行
                 .replace(/\n([^\n]{1,10})\n/g, ' $1\n');
             
             // 按段落分割处理
             const paragraphs = formatted.split(/\n\n+/);
             const processedParagraphs = [];
             
             for (let paragraph of paragraphs) {
                 if (!paragraph.trim()) continue;
                 
                 // 检测标题格式（扩展识别范围）
                 if (paragraph.match(/^[一二三四五六七八九十、]+[、.]/) || 
                     paragraph.match(/^\d+[、.]/) ||
                     paragraph.match(/^(总结|结论|建议|分析|概述|要点|重点|注意|提醒|性格|事业|财运|婚姻|健康|运势|命格|格局|用神|大运|流年|月令|日主|十神)[:：]?/) ||
                     paragraph.match(/^[【\[].*[】\]]/) ||
                     paragraph.length < 20 && paragraph.match(/[：:]$/)) {
                     processedParagraphs.push(`<div class="qa-section-title">${paragraph}</div>`);
                     continue;
                 }
                 
                 // 检测列表项
                 if (paragraph.match(/^[\s]*[-*]\s/) || paragraph.match(/^[\s]*\d+[.、]\s/)) {
                     const listItems = paragraph.split('\n')
                         .filter(line => line.trim())
                         .map(line => {
                             const cleanLine = line.replace(/^[\s]*[-*\d+.、]\s*/, '').trim();
                             return `<li class="qa-list-item">${cleanLine}</li>`;
                         })
                         .join('');
                     processedParagraphs.push(`<ul class="qa-list">${listItems}</ul>`);
                     continue;
                 }
                 
                 // 处理普通段落 - 按句子分行
                 let sentences = paragraph.split(/\n/).filter(s => s.trim());
                 let processedSentences = [];
                 
                 for (let sentence of sentences) {
                     let processedSentence = sentence.trim()
                         // 处理粗体
                         .replace(/\*\*(.*?)\*\*/g, '<strong class="qa-highlight">$1</strong>')
                         // 处理斜体
                         .replace(/\*(.*?)\*/g, '<em class="qa-emphasis">$1</em>')
                         // 处理关键词高亮
                         .replace(/(身强|身弱|喜用神|忌神|大运|流年|财运|事业|婚姻|健康|命格|格局|十神|月令|日主)/g, '<span class="qa-keyword">$1</span>');
                     
                     if (processedSentence) {
                         processedSentences.push(processedSentence);
                     }
                 }
                 
                 if (processedSentences.length > 0) {
                     // 将句子用<br>连接，形成紧凑但分明的段落
                     const paragraphContent = processedSentences.join('<br>');
                     processedParagraphs.push(`<p class="qa-paragraph">${paragraphContent}</p>`);
                 }
             }
             
             return processedParagraphs.join('');
         }
         
         // 显示命格评分详情弹窗
         function showFateScoreDetails() {
             const modal = document.getElementById('scoreDetailsModal');
             const title = document.getElementById('scoreDetailsTitle');
             const body = document.getElementById('scoreDetailsBody');
             
             title.innerHTML = '<i class="fas fa-star"></i> 命格等级评分详细依据';
             
             if (fateScoreDetails && Object.keys(fateScoreDetails).length > 0) {
                 body.innerHTML = `
                     <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                         <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                             <i class="fas fa-calculator"></i> 命格等级评分构成
                         </h4>
                         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                             <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.2); border-radius: 8px; padding: 15px;">
                                 <h6 style="color: #3498db; margin-bottom: 10px;">季节助力得分</h6>
                                 <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                     ${Number(fateScoreDetails.seasonScore || 0).toFixed(2)} 分
                                 </div>
                                 <p style="font-size: 0.9rem; color: #666; margin: 0;">
                                     月令得气、通根透干、调候等因素的综合评分，反映日主在出生月份的旺衰程度。
                                 </p>
                             </div>
                             
                             <div style="background: rgba(39, 174, 96, 0.1); border: 1px solid rgba(39, 174, 96, 0.2); border-radius: 8px; padding: 15px;">
                                 <h6 style="color: #27ae60; margin-bottom: 10px;">五行平衡得分</h6>
                                 <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                     ${Number(fateScoreDetails.balanceScore || 0).toFixed(2)} 分
                                 </div>
                                 <p style="font-size: 0.9rem; color: #666; margin: 0;">
                                     八字中五行分布的均衡性，考虑相生相克关系，评估命格的稳定性和协调度。
                                 </p>
                             </div>
                             
                             <div style="background: rgba(155, 89, 182, 0.1); border: 1px solid rgba(155, 89, 182, 0.2); border-radius: 8px; padding: 15px;">
                                 <h6 style="color: #9b59b6; margin-bottom: 10px;">格局结构得分</h6>
                                 <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                     ${Number(fateScoreDetails.patternScore || 0).toFixed(2)} 分
                                 </div>
                                 <p style="font-size: 0.9rem; color: #666; margin: 0;">
                                     识别特殊格局（如从格、化格等）及其完整性，评估命格层次的高低。
                                 </p>
                             </div>
                             
                             <div style="background: rgba(230, 126, 34, 0.1); border: 1px solid rgba(230, 126, 34, 0.2); border-radius: 8px; padding: 15px;">
                                 <h6 style="color: #e67e22; margin-bottom: 10px;">十神影响得分</h6>
                                 <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                     ${Number(fateScoreDetails.godsScore || 0).toFixed(2)} 分
                                 </div>
                                 <p style="font-size: 0.9rem; color: #666; margin: 0;">
                                     正官、七杀、正印、偏印、比肩、劫财、食神、伤官、正财、偏财的配置和作用。
                                 </p>
                             </div>
                             
                             <div style="background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.2); border-radius: 8px; padding: 15px;">
                                 <h6 style="color: #e74c3c; margin-bottom: 10px;">组合刑冲得分</h6>
                                 <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                     ${Number(fateScoreDetails.combinationScore || 0).toFixed(2)} 分
                                 </div>
                                 <p style="font-size: 0.9rem; color: #666; margin: 0;">
                                     地支三合、六合、相冲、相刑、相害等组合关系对命格的影响评估。
                                 </p>
                             </div>
                         </div>
                         
                         <div style="margin-top: 20px; padding: 15px; background: rgba(52, 73, 94, 0.05); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                 <h5 style="margin: 0; color: var(--primary-color);">
                                     <i class="fas fa-chart-line"></i> 评分汇总
                                 </h5>
                                 <div style="font-size: 1.2rem; font-weight: bold; color: var(--gold-color);">
                                     总分：${Number(fateScoreDetails.total || 0).toFixed(2)} 分
                                 </div>
                             </div>
                             <p style="font-size: 0.9rem; color: #666; margin: 0; line-height: 1.5;">
                                 命格等级评分采用传统八字理论结合现代评分体系，从多个维度综合评估命格的优劣。
                                 分数越高表示命格层次越高，人生发展潜力越大。
                             </p>
                         </div>
                     </div>
                 `;
             } else {
                 body.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无评分详情数据</p>';
             }
             
             modal.style.display = 'block';
         }
         
         // 显示财富评分详情弹窗
         function showWealthScoreDetails() {
             const modal = document.getElementById('scoreDetailsModal');
             const title = document.getElementById('scoreDetailsTitle');
             const body = document.getElementById('scoreDetailsBody');
             
             title.innerHTML = '<i class="fas fa-coins"></i> 财富等级评分详细依据';
             
             if (wealthScoreDetails && Object.keys(wealthScoreDetails).length > 0) {
                 body.innerHTML = `
                     <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                         <h4 style="color: var(--success-color); margin-bottom: 15px;">
                             <i class="fas fa-calculator"></i> 财富等级评分构成
                         </h4>
                         
                         <div style="margin-bottom: 20px;">
                             <h5 style="color: var(--primary-color); margin-bottom: 12px;">
                                 <i class="fas fa-layer-group"></i> 基础模块评分
                             </h5>
                             <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                 <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #3498db;">食伤生财：</strong> ${wealthScoreDetails.shishangScore || 0} 分
                                     <br><small style="color: #666;">食神伤官生财星的能力</small>
                                 </div>
                                 <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #27ae60;">印绶护身：</strong> ${wealthScoreDetails.yinshouScore || 0} 分
                                     <br><small style="color: #666;">印星保护日主的作用</small>
                                 </div>
                                 <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #9b59b6;">财星能量：</strong> ${wealthScoreDetails.wealthStarScore || 0} 分
                                     <br><small style="color: #666;">财星在八字中的力量</small>
                                 </div>
                                 <div style="background: rgba(230, 126, 34, 0.08); border: 1px solid rgba(230, 126, 34, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #e67e22;">财星位置：</strong> ${wealthScoreDetails.wealthPositionScore || 0} 分
                                     <br><small style="color: #666;">财星在四柱中的位置</small>
                                 </div>
                                 <div style="background: rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #e74c3c;">财富库藏：</strong> ${wealthScoreDetails.wealthVaultScore || 0} 分
                                     <br><small style="color: #666;">财库的聚财能力</small>
                                 </div>
                                 <div style="background: rgba(52, 73, 94, 0.08); border: 1px solid rgba(52, 73, 94, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #34495e;">自坐财库：</strong> ${wealthScoreDetails.selfVaultScore || 0} 分
                                     <br><small style="color: #666;">日支为财库的情况</small>
                                 </div>
                                 <div style="background: rgba(26, 188, 156, 0.08); border: 1px solid rgba(26, 188, 156, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #1abc9c;">财气通门户：</strong> ${wealthScoreDetails.portalScore || 0} 分
                                     <br><small style="color: #666;">财气流通的顺畅度</small>
                                 </div>
                                 <div style="background: rgba(142, 68, 173, 0.08); border: 1px solid rgba(142, 68, 173, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #8e44ad;">日主承载：</strong> ${wealthScoreDetails.dayMasterCapacity || 0} 分
                                     <br><small style="color: #666;">日主承载财富的能力</small>
                                 </div>
                             </div>
                         </div>
                         
                         <div style="margin-bottom: 20px;">
                             <h5 style="color: var(--warning-color); margin-bottom: 12px;">
                                 <i class="fas fa-cogs"></i> 进阶与修正评分
                             </h5>
                             <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                 <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #3498db;">喜忌平衡：</strong> ${wealthScoreDetails.favorableBalance || 0} 分
                                     <br><small style="color: #666;">喜用神与忌神的平衡</small>
                                 </div>
                                 <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #27ae60;">季节财运：</strong> ${wealthScoreDetails.seasonalWealthPotential || 0} 分
                                     <br><small style="color: #666;">出生季节对财运的影响</small>
                                 </div>
                                 <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #9b59b6;">财星保护：</strong> ${wealthScoreDetails.wealthProtectionScore || 0} 分
                                     <br><small style="color: #666;">财星的保护机制</small>
                                 </div>
                                 <div style="background: rgba(230, 126, 34, 0.08); border: 1px solid rgba(230, 126, 34, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #e67e22;">空亡扣分：</strong> -${wealthScoreDetails.kongWangPenalty || 0} 分
                                     <br><small style="color: #666;">空亡对财运的负面影响</small>
                                 </div>
                                 <div style="background: rgba(231, 76, 60, 0.08); border: 1px solid rgba(231, 76, 60, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #e74c3c;">流年修正：</strong> ${wealthScoreDetails.luckAdjustment || 0} 分
                                     <br><small style="color: #666;">当前流年的影响</small>
                                 </div>
                                 <div style="background: rgba(52, 73, 94, 0.08); border: 1px solid rgba(52, 73, 94, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #34495e;">大运强弱：</strong> ${wealthScoreDetails.dayunStrength || 0} 分
                                     <br><small style="color: #666;">当前大运对财运的作用</small>
                                 </div>
                             </div>
                         </div>
                         
                         <div style="margin-bottom: 20px;">
                             <h5 style="color: var(--danger-color); margin-bottom: 12px;">
                                 <i class="fas fa-star"></i> 格局与特效评分
                             </h5>
                             <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                                 <div style="background: rgba(52, 152, 219, 0.08); border: 1px solid rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #3498db;">十神特效：</strong> ${wealthScoreDetails.tenGodsBonus || 0} 分
                                     <br><small style="color: #666;">十神配置的特殊效果</small>
                                 </div>
                                 <div style="background: rgba(39, 174, 96, 0.08); border: 1px solid rgba(39, 174, 96, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #27ae60;">特殊格局：</strong> ${wealthScoreDetails.specialBonus || 0} 分
                                     <br><small style="color: #666;">识别到的特殊财富格局</small>
                                 </div>
                                 <div style="background: rgba(155, 89, 182, 0.08); border: 1px solid rgba(155, 89, 182, 0.15); border-radius: 6px; padding: 12px;">
                                     <strong style="color: #9b59b6;">身财平衡：</strong> ${wealthScoreDetails.balanceAdjustment || 0} 分
                                     <br><small style="color: #666;">身强身弱与财星的平衡</small>
                                 </div>
                             </div>
                         </div>
                         
                         <div style="padding: 15px; background: rgba(52, 73, 94, 0.05); border-radius: 8px; border-left: 4px solid var(--success-color);">
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                 <h5 style="margin: 0; color: var(--success-color);">
                                     <i class="fas fa-chart-bar"></i> 财富评分汇总
                                 </h5>
                                 <div style="display: flex; gap: 15px;">
                                     <div style="text-align: center;">
                                         <div style="font-size: 0.9rem; color: #666;">基础合计</div>
                                         <div style="font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">
                                             ${wealthScoreDetails.baseScore || 0} 分
                                         </div>
                                     </div>
                                     <div style="text-align: center;">
                                         <div style="font-size: 0.9rem; color: #666;">最终得分</div>
                                         <div style="font-size: 1.3rem; font-weight: bold; color: var(--success-color);">
                                             ${wealthScoreDetails.total || 0} 分
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             <p style="font-size: 0.9rem; color: #666; margin: 0; line-height: 1.5;">
                                 财富等级评分综合考虑八字中的财星配置、生财机制、库藏能力、流通状况等多个维度，
                                 结合传统命理与现代分析方法，为您提供专业的财运评估。
                             </p>
                         </div>
                     </div>
                 `;
             } else {
                 body.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无评分详情数据</p>';
             }
             
             modal.style.display = 'block';
         }
         
         // 关闭评分详情弹窗
         function closeScoreDetailsModal() {
             const modal = document.getElementById('scoreDetailsModal');
             modal.style.display = 'none';
         }
         
         // 点击弹窗外部关闭
         window.onclick = function(event) {
             const modal = document.getElementById('scoreDetailsModal');
             if (event.target === modal) {
                 modal.style.display = 'none';
             }
         }
         
         // 八字问答API调用
         async function callBaziQAAPI(question, data) {
             // 生成缓存键（处理中文字符）
             const questionHash = encodeURIComponent(question).slice(0, 50).replace(/%/g, '_');
             const cacheKey = `qa:${generateBaziHashKey(data)}:${questionHash}`;
             
             // 检查缓存
             const cachedResponse = localStorage.getItem(cacheKey);
             if (cachedResponse) {
                 return cachedResponse;
             }
             
             // 根据环境自动选择API URL
             const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
             const apiUrl = isLocalhost ? 'http://localhost:3001/api/deepseek' : 'https://deepseek-api-proxy.owenjass.workers.dev/api/deepseek';
             // 使用代理服务器，不直接暴露API Key
             const apiKey = 'placeholder_key_for_local_dev_only';
             
             // 获取当前日期和年份信息
             const today = new Date();
             const currentDateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
             const currentLunar = Lunar.fromDate(today);
             const currentYearGanZhi = currentLunar.getYearInGanZhi();
             const currentYear = today.getFullYear();
             
             // 从data对象中获取八字信息
             const userName = data.name || '用户';
             const genderStr = data.gender === 'male' ? '男' : (data.gender === 'female' ? '女' : '未知');
             const yearPillarStr = data.pillars?.year || '年柱未知';
             const monthPillarStr = data.pillars?.month || '月柱未知';
             const dayPillarStr = data.pillars?.day || '日柱未知';
             const hourPillarStr = data.pillars?.hour || '时柱未知';
             // 计算当前身强身弱（包含大运和流年影响）
             const currentStrengthData = calculateCurrentStrength(
                 data.pillars?.day?.charAt(0) || '',
                 data.elements || {},
                 data.pillars?.month?.charAt(1) || '',
                 new Date().getFullYear()
             );
             const strengthStr = currentStrengthData?.type || '身强身弱未知';
             const startingAgeStr = data.luckTiming?.description || '起运时间未知';
             
             // 构建prompt
             let prompt = `你是一位专业的八字命理大师，请基于以下准确的八字信息回答用户的问题。\n\n`;
             prompt += `【基本信息】\n`;
             prompt += `姓名：${userName}\n`;
             prompt += `性别：${genderStr}\n`;
             prompt += `当前日期：${currentDateStr}\n`;
             prompt += `当前流年：${currentYear}年${currentYearGanZhi}年\n\n`;
             
             prompt += `【八字信息】\n`;
             prompt += `年柱：${yearPillarStr}\n`;
             prompt += `月柱：${monthPillarStr}\n`;
             prompt += `日柱：${dayPillarStr}\n`;
             prompt += `时柱：${hourPillarStr}\n`;
             prompt += `当前身强身弱：${strengthStr}\n`;
             prompt += `起运时间：${startingAgeStr}\n\n`;
             
             prompt += `【用户问题】\n${question}\n\n`;
             
             prompt += `【回答要求】\n`;
             prompt += `1. 请基于以上准确的八字信息回答问题，不要重新计算八字\n`;
             prompt += `2. 回答要专业、准确、具体，避免模糊的表述\n`;
             prompt += `3. 如果问题涉及时间预测，请结合当前流年${currentYear}年${currentYearGanZhi}年进行分析\n`;
             prompt += `4. 用通俗易懂的语言解释，让普通人也能理解\n`;
             prompt += `5. 如果问题不是八字相关的，请礼貌地提醒用户只能回答八字命理相关问题\n`;
             prompt += `6. 回答要有建设性，提供实用的建议和指导\n`;
             
             try {
                 console.log('开始调用八字问答API...');
                 console.log('API URL:', apiUrl);
                 console.log('请求数据:', {
                     model: "deepseek-chat",
                     messages: [{ role: "user", content: prompt.substring(0, 200) + '...' }],
                     temperature: 0.7,
                     max_tokens: 1500
                 });
                 
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${apiKey}`
                     },
                     body: JSON.stringify({
                         model: "deepseek-chat",
                         messages: [
                             {
                                 role: "user",
                                 content: prompt
                             }
                         ],
                         temperature: 0.7,
                         max_tokens: 1500
                     })
                 });
                 
                 console.log('API响应状态:', response.status, response.statusText);
                 
                 if (!response.ok) {
                     const errorText = await response.text();
                     console.error('API错误响应:', errorText);
                     throw new Error(`API请求失败: ${response.status} - ${response.statusText}`);
                 }
                 
                 const responseData = await response.json();
                 console.log('API响应数据:', responseData);
                 
                 if (!responseData.choices || !responseData.choices[0] || !responseData.choices[0].message || !responseData.choices[0].message.content) {
                     console.error('API返回数据格式错误:', responseData);
                     throw new Error('API返回数据格式不正确');
                 }
                 
                 const answerContent = responseData.choices[0].message.content;
                 
                 if (!answerContent.trim()) {
                     throw new Error('API返回内容为空');
                 }
                 
                 console.log('API调用成功，返回内容长度:', answerContent.length);
                 
                 // 格式化回答内容（支持Markdown）
                 const formattedAnswer = `<div class="qa-answer">\n<h4><i class="fas fa-lightbulb"></i> 命理解答</h4>\n<div class="qa-content">${formatMarkdownContent(answerContent)}</div>\n</div>`;
                 
                 // 缓存结果（缓存时间较短，因为问答内容可能需要更新）
                 localStorage.setItem(cacheKey, formattedAnswer);
                 
                 return formattedAnswer;
             } catch (error) {
                 console.error('八字问答API调用失败 - 详细错误:', error);
                 console.error('错误堆栈:', error.stack);
                 throw error;
             }
         }
         
         // 通过DeepSeek API获取八字分析
         async function getBaziAnalysisFromDeepSeek(analysisType, data) {
             // 生成缓存键
             const cacheKey = `${generateBaziHashKey(data)}:${analysisType}`;
             
             // 检查缓存
             const cachedResponse = localStorage.getItem(cacheKey);
             if (cachedResponse) {
                 return cachedResponse;
             }
             
             // 使用本地代理服务器
             const apiUrl = 'https://deepseek-api-proxy.owenjass.workers.dev/api/deepseek'
             // 使用代理服务器，不直接暴露API Key
             const apiKey = 'placeholder_key_for_local_dev_only';
             
             // 获取当前日期
             const today = new Date();
             const currentDateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
             
             // 获取当前年份的天干地支
             const currentLunar = Lunar.fromDate(today);
             const currentYearGanZhi = currentLunar.getYearInGanZhi();
             const currentYear = today.getFullYear();
             
             // 从data对象中获取八字信息
             const userName = data.name || '用户';
             const genderStr = data.gender === 'male' ? '男' : (data.gender === 'female' ? '女' : '未知');
             const yearPillarStr = data.pillars?.year || '年柱未知';
             const monthPillarStr = data.pillars?.month || '月柱未知';
             const dayPillarStr = data.pillars?.day || '日柱未知';
             const hourPillarStr = data.pillars?.hour || '时柱未知';
             // 计算当前身强身弱（包含大运和流年影响）
             const currentStrengthData = calculateCurrentStrength(
                 data.pillars?.day?.charAt(0) || '',
                 data.elements || {},
                 data.pillars?.month?.charAt(1) || '',
                 new Date().getFullYear()
             );
             const strengthStr = currentStrengthData?.type || '身强身弱未知';
             const startingAgeStr = data.luckTiming?.description || '起运时间未知';
             
            const baziFullInfo = `${userName}，${genderStr}，八字信息是：${yearPillarStr}，${monthPillarStr}，${dayPillarStr}，${hourPillarStr}，当前身强身弱为${strengthStr}，${startingAgeStr}。`;
            const baziInfo = {
            baziFullInfo,
            yearPillar: yearPillarStr,
            monthPillar: monthPillarStr,
            dayPillar: dayPillarStr,
            hourPillar: hourPillarStr,
            strength: strengthStr,
            startingAge: startingAgeStr,
            elementsDistribution: data.elementsDistribution || {}
            };
             
             // 根据分析类型构建提示词
             let prompt = `请作为专业命理师，使用标准Markdown语法，基于以下本地计算的准确八字信息进行深度分析。当前日期：${currentDateStr}\n\n`;
             
             // 添加八字核心信息（使用完整的baziFullInfo）
             prompt += `### 八字信息\n`;
             prompt += `${baziFullInfo}\n\n`;
             
             // 添加五行分布信息
             if (baziInfo.elementsDistribution && Object.keys(baziInfo.elementsDistribution).length > 0) {
                 prompt += `- 五行分布：`;
                 Object.entries(baziInfo.elementsDistribution).forEach(([element, count]) => {
                     prompt += `${element}${count}个 `;
                 });
                 prompt += `\n\n`;
             }
             
             prompt += `**重要说明：以上八字、当前身强身弱判断（已包含大运和流年影响）和起运时间均为本地精确计算结果。您必须严格基于这些信息进行分析，绝对不要自行重新计算或使用其他值。**\n\n`;
             
             // 根据分析类型添加特定提示
             switch (analysisType) {
                 case 'full-analysis':
                     prompt += `请基于以上八字信息，进行全面的命理解析。分析内容应包括：\n`;
                     prompt += `1. 性格特质与天赋才能分析\n`;
                     prompt += `2. 事业发展方向与职业规划建议\n`;
                     prompt += `3. 财富运势与理财投资指导\n`;
                     prompt += `4. 感情婚姻状况与伴侣特征\n`;
                     prompt += `5. 健康状况评估与养生建议\n`;
                     prompt += `6. 人生各阶段重要转折点预测\n`;
                     prompt += `7. 提升运势的实用方法与建议\n`;
                     break;
                     
                 case 'annual-fortune':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的流年运势分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. ${currentYear}年${currentYearGanZhi}年整体运势概述\n`;
                     prompt += `2. 事业发展与工作机遇分析\n`;
                     prompt += `3. 财运分析（正财与偏财）\n`;
                     prompt += `4. 感情与人际关系运势\n`;
                     prompt += `5. 健康状况预警与建议\n`;
                     prompt += `6. 流年吉凶月份预测\n`;
                     prompt += `7. 化解不利因素的实用建议\n`;
                     break;
                     
                 case 'monthly-fortune':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的流月运势分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. ${currentYear}年各月运势总体趋势\n`;
                     prompt += `2. 按季节分析（春、夏、秋、冬）各月运势特点\n`;
                     prompt += `3. 重点月份的机遇与挑战\n`;
                     prompt += `4. 每月事业、财运、感情、健康关键点\n`;
                     prompt += `5. 月份吉凶日预测方法\n`;
                     prompt += `6. 不同月份的行动建议\n`;
                     break;
                     
                 case 'decade-fortune':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的十年大运分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 人生各阶段大运走势概述\n`;
                     prompt += `2. 青年期（20-30岁）运势与发展方向\n`;
                     prompt += `3. 壮年期（30-40岁）事业与财富高峰期分析\n`;
                     prompt += `4. 中年期（40-50岁）稳定发展期特点\n`;
                     prompt += `5. 晚年期（50岁以后）运势变化\n`;
                     prompt += `6. 大运交接期的注意事项\n`;
                     prompt += `7. 如何把握各阶段机遇的建议\n`;
                     break;
                     
                 case 'personality':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的性格分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 核心性格特质与天赋才能\n`;
                     prompt += `2. 性格优势与特长详解\n`;
                     prompt += `3. 性格中需要注意的弱点\n`;
                     prompt += `4. 人际交往模式与沟通风格\n`;
                     prompt += `5. 思维方式与决策特点\n`;
                     prompt += `6. 情绪管理能力分析\n`;
                     prompt += `7. 性格发展与自我提升建议\n`;
                     break;
                     
                 case 'career':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的事业财富分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 最适合的职业领域与行业\n`;
                     prompt += `2. 职业发展路径与关键转折点\n`;
                     prompt += `3. 事业成功的关键因素\n`;
                     prompt += `4. 财富来源与积累模式\n`;
                     prompt += `5. 正财与偏财运势分析\n`;
                     prompt += `6. 投资理财建议与风险提示\n`;
                     prompt += `7. 事业与财富平衡的人生规划\n`;
                     break;
                     
                 case 'marriage':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的婚姻分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 婚姻运势与缘分总体评估\n`;
                     prompt += `2. 理想伴侣的性格与特质描述\n`;
                     prompt += `3. 婚姻生活的特点与模式\n`;
                     prompt += `4. 婚姻中可能面临的挑战\n`;
                     prompt += `5. 最佳婚姻时机与年龄段\n`;
                     prompt += `6. 婚姻关系经营的建议\n`;
                     prompt += `7. 提升婚姻质量的实用方法\n`;
                     break;
                     
                 case 'children':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的子女分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 子女缘分与数量预测\n`;
                     prompt += `2. 子女可能的性格特点\n`;
                     prompt += `3. 亲子关系的特点与互动模式\n`;
                     prompt += `4. 子女教育的最佳方式\n`;
                     prompt += `5. 子女成长中的关键阶段\n`;
                     prompt += `6. 如何培养子女的天赋与能力\n`;
                     prompt += `7. 亲子关系和谐的实用建议\n`;
                     break;
                     
                 case 'health':
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行详细的健康分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 先天体质与健康状况评估\n`;
                     prompt += `2. 需要特别关注的身体系统\n`;
                     prompt += `3. 不同年龄段的健康风险\n`;
                     prompt += `4. 季节性健康变化与注意事项\n`;
                     prompt += `5. 适合的运动与锻炼方式\n`;
                     prompt += `6. 饮食调理与营养建议\n`;
                     prompt += `7. 预防疾病的养生保健方法\n`;
                     break;
                     
                 default:
                     prompt += `请基于以上本地计算的准确八字信息（包括当前身强身弱和起运时间），进行全面的命理分析。请不要重新计算八字、当前身强身弱或起运时间，直接使用提供的信息。\n`;
             }
             
             prompt += `\n请用人性化、清晰的语言表达，避免过于专业的术语，使普通人也能理解。分析要全面、深入、具体，不要笼统。`;
             
             try {
                 // 调用DeepSeek API
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${apiKey}`
                     },
                     body: JSON.stringify({
                         model: "deepseek-chat",
                         messages: [
                             {
                                 role: "user",
                                 content: prompt
                             }
                         ],
                         temperature: 0.7,
                         max_tokens: 2000
                     })
                 });
                 
                 if (!response.ok) {
                     throw new Error(`API请求失败: ${response.status}`);
                 }
                 
                 const data = await response.json();
                 
                 if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                     throw new Error('API返回数据格式不正确');
                 }
                 
                 const analysisContent = data.choices[0].message.content;
                 
                 // 检查内容是否为空
                 if (!analysisContent.trim()) {
                     throw new Error('API返回内容为空');
                 }
                 
                 // 缓存结果
                 localStorage.setItem(cacheKey, analysisContent);
                 
                 return analysisContent;
             } catch (error) {
                 console.error('DeepSeek API调用失败:', error);
                 throw error;
             }
         }
         
         // 生成八字哈希键（用于缓存）
         function generateBaziHashKey(data) {
             return `${data.name}-${data.gender}-${data.birthDate}-${data.birthTime}`;
         }

         /* ==================== 用户管理功能 ==================== */

         // API配置
          const API_BASE = 'https://api.mybazi.net';
          const API_URL = `${API_BASE}/api`;

         // DOM元素
         const userWelcome = document.getElementById('userWelcome');
         const usernameDisplay = document.getElementById('usernameDisplay');
         const loginBtn = document.getElementById('loginBtn');
         const logoutBtn = document.getElementById('logoutBtn');

         const rechargeBtn = document.getElementById('rechargeBtn');
         const authModal = document.getElementById('authModal');
         const rechargeModal = document.getElementById('rechargeModal');
         const closeAuth = document.getElementById('closeAuth');
         const closeRecharge = document.getElementById('closeRecharge');
         const loginTab = document.getElementById('loginTab');
         const registerTab = document.getElementById('registerTab');
         const loginForm = document.getElementById('loginForm');
         const registerForm = document.getElementById('registerForm');
         const rechargeForm = document.getElementById('rechargeForm');
         const loginMessage = document.getElementById('loginMessage');
         const registerMessage = document.getElementById('registerMessage');
         const submitLogin = document.getElementById('submitLogin');
         const submitRegister = document.getElementById('submitRegister');
         const loginSpinner = document.getElementById('loginSpinner');
         const registerSpinner = document.getElementById('registerSpinner');

         // 检查登录状态
         function checkLoginStatus() {
             const token = localStorage.getItem('token');
             const username = localStorage.getItem('username');
             
             if (token && username) {
                 userWelcome.style.display = 'block';
                 usernameDisplay.textContent = username;
                 loginBtn.style.display = 'none';
                 logoutBtn.style.display = 'block';

                 rechargeBtn.style.display = 'inline-block';
                 document.getElementById('userBalance').style.display = 'block';
                 
                 // 更新余额
                 updateBalance();
             } else {
                 userWelcome.style.display = 'none';
                 loginBtn.style.display = 'block';
                 logoutBtn.style.display = 'none';

                 rechargeBtn.style.display = 'none';
                 document.getElementById('userBalance').style.display = 'none';
             }
         }

         // 更新用户余额
         async function updateBalance() {
             try {
                 const response = await fetch(`${API_URL}/user/balance`, {
                     headers: {
                         'Authorization': `Bearer ${localStorage.getItem('token')}`
                     }
                 });
                 
                 if (!response.ok) {
                     if (response.status === 401) {
                         // 处理未授权错误
                         localStorage.removeItem('token');
                         localStorage.removeItem('username');
                         checkLoginStatus();
                         throw new Error('会话已过期，请重新登录');
                     }
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 
                 const data = await response.json();
                 const balanceAmountEl = document.getElementById('balanceAmount');
                 
                 if (data.balance !== undefined && balanceAmountEl) {
                     balanceAmountEl.textContent = data.balance;
                 }
                 
                 // 同时更新充值弹窗中的余额显示
                 await updateBalanceDisplay();
             } catch (error) {
                 const balanceAmountEl = document.getElementById('balanceAmount');
                 if (balanceAmountEl) balanceAmountEl.textContent = '获取失败';
                 // 显示用户消息
                 showAuthMessage(document.getElementById('rechargeMessage') || loginMessage, error.message, 'error');
             }
         }

         // 更新充值弹窗中的余额显示
         async function updateBalanceDisplay() {
             try {
                 const response = await fetch(`${API_URL}/user/balance`, {
                     headers: {
                         'Authorization': `Bearer ${localStorage.getItem('token')}`
                     }
                 });
                 
                 if (response.ok) {
                     const data = await response.json();
                     const userBalanceDisplay = document.getElementById('userBalanceDisplay');
                     const balancePayment = document.getElementById('balancePayment');
                     
                     if (data.balance !== undefined && userBalanceDisplay) {
                         userBalanceDisplay.textContent = data.balance;
                         
                         // 如果余额不足，禁用余额支付选项
                         const rechargeAmount = document.getElementById('rechargeAmount').value;
                         if (balancePayment && rechargeAmount) {
                             if (parseFloat(data.balance) < parseFloat(rechargeAmount)) {
                                 balancePayment.disabled = true;
                                 balancePayment.parentElement.style.opacity = '0.5';
                             } else {
                                 balancePayment.disabled = false;
                                 balancePayment.parentElement.style.opacity = '1';
                             }
                         }
                     }
                 }
             } catch (error) {
                 console.error('更新余额显示失败:', error);
             }
         }

         // 切换登录/注册标签页
         function switchAuthTab(tab) {
             if (tab === 'login') {
                 loginTab.classList.add('active');
                 registerTab.classList.remove('active');
                 loginForm.classList.add('active');
                 registerForm.classList.remove('active');
             } else {
                 loginTab.classList.remove('active');
                 registerTab.classList.add('active');
                 loginForm.classList.remove('active');
                 registerForm.classList.add('active');
             }
             
             // 清空消息
             loginMessage.style.display = 'none';
             registerMessage.style.display = 'none';
         }

         // 显示/隐藏登录弹窗
         function toggleAuthModal(show) {
             if (show) {
                 authModal.style.display = 'block';
                 document.body.style.overflow = 'hidden';
             } else {
                 authModal.style.display = 'none';
                 document.body.style.overflow = '';
             }
         }

         // 处理登录
         async function handleLogin(e) {
             e.preventDefault();
             
             const username = document.getElementById('loginUsername').value.trim();
             const password = document.getElementById('loginPassword').value.trim();
             
             if (!username || !password) {
                 showAuthMessage(loginMessage, '请输入用户名和密码', 'error');
                 return;
             }
             
             submitLogin.disabled = true;
             loginSpinner.style.display = 'inline-block';
             document.getElementById('loginText').style.display = 'none';
             
             try {
                 const response = await fetch(`${API_BASE}/api/login`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ name: username, password })
                 });
                 
                 const result = await response.json();
                 
                 if (!response.ok) {
                     throw new Error(result.error || '登录失败');
                 }
                 
                 localStorage.setItem('token', result.token);
                 localStorage.setItem('username', username);
                 
                 showAuthMessage(loginMessage, '登录成功！', 'success');
                 checkLoginStatus();
                 
                 document.getElementById('loginUsername').value = '';
                 document.getElementById('loginPassword').value = '';
                 
                 setTimeout(() => {
                     toggleAuthModal(false);
                 }, 1500);
                 
             } catch (error) {
                 console.error('登录错误:', error);
                 showAuthMessage(loginMessage, error.message, 'error');
             } finally {
                 submitLogin.disabled = false;
                 loginSpinner.style.display = 'none';
                 document.getElementById('loginText').style.display = 'inline';
             }
         }

         // 处理注册
         async function handleRegister(e) {
             e.preventDefault();
             
             const username = document.getElementById('registerUsername').value.trim();
             const email = document.getElementById('registerEmail').value.trim();
             const password = document.getElementById('registerPassword').value.trim();
             const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
             
             if (!username || username.length < 4 || username.length > 16) {
                 showAuthMessage(registerMessage, '用户名长度应为4-16位', 'error');
                 return;
             }
             
             if (!email || !validateEmail(email)) {
                 showAuthMessage(registerMessage, '请输入有效的电子邮箱', 'error');
                 return;
             }
             
             if (!password || password.length < 6) {
                 showAuthMessage(registerMessage, '密码长度至少为6位', 'error');
                 return;
             }
             
             if (password !== confirmPassword) {
                 showAuthMessage(registerMessage, '两次输入的密码不一致', 'error');
                 return;
             }
             
             submitRegister.disabled = true;
             registerSpinner.style.display = 'inline-block';
             document.getElementById('registerText').style.display = 'none';
             
             try {
                 const response = await fetch(`${API_BASE}/api/register`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ name: username, email, password })
                 });
                 
                 const result = await response.json();
                 
                 if (!response.ok) {
                     throw new Error(result.error || '注册失败');
                 }
                 
                 localStorage.setItem('token', result.token);
                 localStorage.setItem('username', username);
                 
                 showAuthMessage(registerMessage, '注册成功！已自动登录', 'success');
                 checkLoginStatus();
                 
                 document.getElementById('registerUsername').value = '';
                 document.getElementById('registerEmail').value = '';
                 document.getElementById('registerPassword').value = '';
                 document.getElementById('registerConfirmPassword').value = '';
                 
                 setTimeout(() => {
                     toggleAuthModal(false);
                     switchAuthTab('login');
                 }, 1500);
                 
             } catch (error) {
                 showAuthMessage(registerMessage, error.message, 'error');
             } finally {
                 submitRegister.disabled = false;
                 registerSpinner.style.display = 'none';
                 document.getElementById('registerText').style.display = 'inline';
             }
         }

         // 处理退出登录
         function handleLogout() {
             localStorage.removeItem('token');
             localStorage.removeItem('username');
             checkLoginStatus();
             switchAuthTab('login');
         }

         // 显示认证消息
         function showAuthMessage(element, message, type) {
             element.textContent = message;
             element.className = 'auth-message ' + type;
             element.style.display = 'block';
             
             setTimeout(() => {
                 element.style.display = 'none';
             }, 3000);
         }

         // 验证邮箱格式
         function validateEmail(email) {
             const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
             return re.test(email);
         }

         // 密码显示/隐藏切换
         function togglePassword(inputId, icon) {
             const input = document.getElementById(inputId);
             if (input.type === 'password') {
                 input.type = 'text';
                 icon.classList.remove('fa-eye');
                 icon.classList.add('fa-eye-slash');
             } else {
                 input.type = 'password';
                 icon.classList.remove('fa-eye-slash');
                 icon.classList.add('fa-eye');
             }
         }

         // 处理充值
         async function handleRecharge(e) {
             e.preventDefault();
             
             const amount = document.getElementById('rechargeAmount').value;
             const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
             const rechargeSpinner = document.getElementById('rechargeSpinner');
             const rechargeText = document.getElementById('rechargeText');
             const rechargeMessage = document.getElementById('rechargeMessage');
             
             rechargeSpinner.style.display = 'inline-block';
             rechargeText.style.display = 'none';
             
             if (!localStorage.getItem('token')) {
                 rechargeMessage.textContent = '请先登录后再进行充值';
                 rechargeMessage.style.color = 'red';
                 rechargeSpinner.style.display = 'none';
                 rechargeText.style.display = 'inline';
                 return;
             }
             
             try {
                 if (paymentMethod === 'balance') {
                    // 余额支付处理 - 直接调用扣费接口
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('请先登录');
                    }
                    
                    const response = await fetch(`${API_BASE}/api/user/deduct`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            amount: parseFloat(amount), 
                            reason: '八字分析服务' 
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || '余额支付失败');
                    }
                    
                    // 支付成功后的处理
                    rechargeMessage.textContent = '余额支付成功！';
                    rechargeMessage.style.color = '#28a745';
                    // 更新余额显示
                    await updateBalanceDisplay();
                    await updateBalance();
                    // 关闭弹窗
                    setTimeout(() => {
                        document.getElementById('rechargeModal').style.display = 'none';
                    }, 1500);
                 } else {
                     // 其他支付方式
                     const wwPayInstance = new WWPay();
                     await wwPayInstance.processRecharge(amount, paymentMethod);
                     rechargeMessage.textContent = '支付处理中...';
                     rechargeMessage.style.color = '#28a745';
                 }
                 
                 // 支付成功后显示隐藏内容
                 const paidContent = document.getElementById('paid-content');
                 if (paidContent) {
                     paidContent.style.display = 'block';
                 }
                 
                 // 支付成功后禁用详批按钮
                 const detailedBtn = document.getElementById('detailed-analysis-btn');
                 if (detailedBtn) {
                     detailedBtn.disabled = true;
                     detailedBtn.innerHTML = '<i class="fas fa-check"></i> 已支付';
                     detailedBtn.style.opacity = '0.6';
                     detailedBtn.style.cursor = 'not-allowed';
                 }
             } catch (error) {
                 rechargeMessage.textContent = error.message;
                 rechargeMessage.style.color = 'red';
             } finally {
                 rechargeSpinner.style.display = 'none';
                 rechargeText.style.display = 'inline';
             }
         }

         // 初始化用户管理事件
         function initUserManagement() {
             // 检查登录状态
             checkLoginStatus();
             
             // 登录按钮事件
             if (loginBtn) {
                 loginBtn.addEventListener('click', () => {
                     toggleAuthModal(true);
                     switchAuthTab('login');
                 });
             }
             
             // 关闭弹窗事件
             if (closeAuth) {
                 closeAuth.addEventListener('click', () => toggleAuthModal(false));
             }
             
             if (closeRecharge) {
                 closeRecharge.addEventListener('click', () => {
                     rechargeModal.style.display = 'none';
                 });
             }
             
             // 弹窗外部点击关闭
             if (authModal) {
                 authModal.addEventListener('click', (e) => {
                     if (e.target === authModal) {
                         toggleAuthModal(false);
                     }
                 });
             }
             
             if (rechargeModal) {
                 rechargeModal.addEventListener('click', (e) => {
                     if (e.target === rechargeModal) {
                         rechargeModal.style.display = 'none';
                     }
                 });
             }
             
             // 标签页切换事件
             if (loginTab) {
                 loginTab.addEventListener('click', () => switchAuthTab('login'));
             }
             if (registerTab) {
                 registerTab.addEventListener('click', () => switchAuthTab('register'));
             }
             
             // 表单提交事件
             if (loginForm) {
                 loginForm.addEventListener('submit', handleLogin);
             }
             if (registerForm) {
                 registerForm.addEventListener('submit', handleRegister);
             }
             if (rechargeForm) {
                 rechargeForm.addEventListener('submit', handleRecharge);
             }
             
             // 退出登录事件
             if (logoutBtn) {
                 logoutBtn.addEventListener('click', handleLogout);
             }
             
             // 充值按钮事件
             if (rechargeBtn) {
                 rechargeBtn.addEventListener('click', () => {
                     rechargeModal.style.display = 'block';
                     // 初始化余额显示
                     updateBalanceDisplay();
                 });
             }
             
             // 充值金额输入框事件
             const rechargeAmount = document.getElementById('rechargeAmount');
             if (rechargeAmount) {
                 rechargeAmount.addEventListener('input', () => {
                     updateBalanceDisplay();
                 });
             }

         }

         // 页面加载完成后初始化用户管理
         document.addEventListener('DOMContentLoaded', function() {
             initUserManagement();
             
             // 确保页面重新加载后隐藏付费内容
             const paidContent = document.getElementById('paid-content');
             if (paidContent) {
                 paidContent.style.display = 'none';
             }
             
             // 重置详批按钮状态
             const detailedBtn = document.getElementById('detailed-analysis-btn');
             if (detailedBtn) {
                 detailedBtn.disabled = false;
                 detailedBtn.innerHTML = '立即详批';
                 detailedBtn.style.opacity = '1';
                 detailedBtn.style.cursor = 'pointer';
                 
                 detailedBtn.addEventListener('click', function() {
                     if (this.disabled) return;
                     
                     // 检查用户是否已登录
                     const token = localStorage.getItem('token');
                     if (!token) {
                         alert('请先登录后再进行详批');
                         toggleAuthModal(true);
                         switchAuthTab('login');
                         return;
                     }
                     
                     const rechargeAmount = document.getElementById('rechargeAmount');
                     if (rechargeAmount) {
                         rechargeAmount.value = '20';
                         rechargeAmount.readOnly = true;
                     }
                     // 显示充值模态，但实际为支付详批
                     rechargeModal.style.display = 'block';
                     // 初始化余额显示
                     updateBalanceDisplay();
                 });
             }
         });

         // 检查用户登录状态
         function checkLoginStatus() {
             const token = localStorage.getItem('token');
             const username = localStorage.getItem('username');
             
             const loginBtn = document.getElementById('loginBtn');
             const userWelcome = document.getElementById('userWelcome');
             const usernameDisplay = document.getElementById('usernameDisplay');
             const rechargeBtn = document.getElementById('rechargeBtn');
             const logoutBtn = document.getElementById('logoutBtn');
             const userBalance = document.getElementById('userBalance');
             
             if (token && username) {
                 // 用户已登录
                 loginBtn.style.display = 'none';
                 userWelcome.style.display = 'block';
                 usernameDisplay.textContent = username;
                 rechargeBtn.style.display = 'inline-block';
                 logoutBtn.style.display = 'inline-block';
                 userBalance.style.display = 'block';
                 // 加载用户余额
                 loadUserBalance();
             } else {
                 // 用户未登录
                 loginBtn.style.display = 'inline-block';
                 userWelcome.style.display = 'none';
                 rechargeBtn.style.display = 'none';
                 logoutBtn.style.display = 'none';
                 userBalance.style.display = 'none';
             }
         }
         
         // 加载用户余额
         async function loadUserBalance() {
             const token = localStorage.getItem('token');
             if (!token) return;
             
             try {
                 const response = await fetch(`${API_BASE}/api/user/balance`, {
                     headers: {
                         'Authorization': `Bearer ${token}`
                     }
                 });
                 
                 if (response.ok) {
                     const data = await response.json();
                     const balance = data.balance || 0;
                     document.getElementById('balanceAmount').textContent = balance.toFixed(2);
                 }
             } catch (error) {
                 console.error('获取用户余额失败:', error);
             }
         }

     </script>
    </div> <!-- 闭合 container -->
    </div> <!-- 闭合 page-container -->
<script src="../js/wwpay.js"></script>
</body>
</html>
