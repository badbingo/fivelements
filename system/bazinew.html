<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="专业八字预测系统，精准排盘，详细分析">
    <meta name="keywords" content="八字,命理,预测,排盘,五行">
    <title>专业八字预测系统</title>
    
    <!-- 字体和图标 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js 和插件 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="../js/wwpay.js" defer></script>
<script src="../js/lunar.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
   
    <script>
      // 配置后端地址（必须修改！）
      const API_BASE = 'https://bazi-backend.owenjass.workers.dev';
      const API_URL = `${API_BASE}/api`;
      
      // 充值功能
document.addEventListener('DOMContentLoaded', function() {
    // 确保WWPay类可用
    if (typeof WWPay === 'undefined') {
        console.error('WWPay类未定义，请检查wwpay.js是否加载成功');
        return;
    }
    
    // 使用全局的wwPay实例
    const rechargeBtn = document.getElementById('rechargeBtn');
    const rechargeModal = document.getElementById('rechargeModal');
    const closeRecharge = document.getElementById('closeRecharge');
    const rechargeForm = document.getElementById('rechargeForm');
          
          // 显示充值弹窗
          rechargeBtn.addEventListener('click', function() {
              rechargeModal.style.display = 'block';
          });
          
          // 关闭充值弹窗
          closeRecharge.addEventListener('click', function() {
              rechargeModal.style.display = 'none';
          });
          
          // 处理充值表单提交
          rechargeForm.addEventListener('submit', async function(e) {
              e.preventDefault();
              
              const amount = document.getElementById('rechargeAmount').value;
              const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
              const rechargeSpinner = document.getElementById('rechargeSpinner');
              const rechargeText = document.getElementById('rechargeText');
              const rechargeMessage = document.getElementById('rechargeMessage');
              
              rechargeSpinner.style.display = 'inline-block';
              rechargeText.style.display = 'none';
              
              try {
                  // 使用全局的wwPay实例
                  
                  // 1. 创建充值订单
                  const orderResponse = await window.wwPay.createRechargeOrder(amount, paymentMethod);
                  
                  // 2. 跳转支付平台
                  await window.wwPay.redirectToPaymentGateway(orderResponse);
                  
                  // 3. 显示支付处理中提示
                  rechargeMessage.textContent = '正在跳转支付平台...';
                  rechargeMessage.style.color = 'white';
                  
              } catch (error) {
                  rechargeMessage.textContent = error.message;
                  rechargeMessage.style.color = 'red';
              } finally {
                  rechargeSpinner.style.display = 'none';
                  rechargeText.style.display = 'inline';
              }
          });
          
          // 登录成功后显示充值按钮和余额
          if (localStorage.getItem('token')) {
              // 确保DOM元素存在
              const userBalanceEl = document.getElementById('userBalance');
              const modalBalanceEl = document.getElementById('modalBalance');
              
              if (rechargeBtn) rechargeBtn.style.display = 'inline-block';
              if (userBalanceEl) userBalanceEl.style.display = 'block';
              if (modalBalanceEl) modalBalanceEl.style.display = 'block';
              
              // 获取用户余额并更新显示
              async function updateBalance() {
                  try {
                      const response = await fetch(`${API_URL}/user/balance`, {
                          headers: {
                              'Authorization': `Bearer ${localStorage.getItem('token')}`
                          }
                      });
                      
                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                      }
                      
                      const data = await response.json();
                      
                      // 调试日志
                      console.log('用户数据:', data);
                      
                      const balanceAmountEl = document.getElementById('balanceAmount');
                      const modalBalanceAmountEl = document.getElementById('modalBalanceAmount');
                      
                      if (data.balance !== undefined) {
                          if (balanceAmountEl) balanceAmountEl.textContent = data.balance;
                          if (modalBalanceAmountEl) modalBalanceAmountEl.textContent = data.balance;
                      } else {
                          console.error('API响应中缺少balance字段');
                      }
                  } catch (error) {
                      console.error('获取余额失败:', error);
                      // 显示错误提示
                      const balanceAmountEl = document.getElementById('balanceAmount');
                      const modalBalanceAmountEl = document.getElementById('modalBalanceAmount');
                      if (balanceAmountEl) balanceAmountEl.textContent = '获取失败';
                      if (modalBalanceAmountEl) modalBalanceAmountEl.textContent = '获取失败';
                  }
              }
              
              // 立即执行并设置定时刷新
              updateBalance();
              setInterval(updateBalance, 30000); // 每30秒刷新一次
          }

          // 登录/注册功能
          const loginRegisterBtn = document.getElementById('loginRegisterBtn');
          const logoutBtn = document.getElementById('logoutBtn');
          const authModal = document.getElementById('authModal');
          const closeAuth = document.getElementById('closeAuth');
          const loginTab = document.getElementById('loginTab');
          const registerTab = document.getElementById('registerTab');
          const loginForm = document.getElementById('loginForm');
          const registerForm = document.getElementById('registerForm');
          const loginSpinner = document.getElementById('loginSpinner');
          const loginText = document.getElementById('loginText');
          const loginMessage = document.getElementById('loginMessage');
          const registerSpinner = document.getElementById('registerSpinner');
          const registerText = document.getElementById('registerText');
          const registerMessage = document.getElementById('registerMessage');

          // 显示登录/注册弹窗
          loginRegisterBtn.addEventListener('click', function() {
              authModal.style.display = 'block';
              loginForm.classList.add('active');
              registerForm.classList.remove('active');
              loginTab.classList.add('active');
              registerTab.classList.remove('active');
              loginMessage.textContent = '';
              registerMessage.textContent = '';
          });

          // 关闭登录/注册弹窗
          closeAuth.addEventListener('click', function() {
              authModal.style.display = 'none';
          });

          // 切换登录/注册表单
          loginTab.addEventListener('click', function() {
              loginForm.classList.add('active');
              registerForm.classList.remove('active');
              loginTab.classList.add('active');
              registerTab.classList.remove('active');
              loginMessage.textContent = '';
          });

          registerTab.addEventListener('click', function() {
              registerForm.classList.add('active');
              loginForm.classList.remove('active');
              registerTab.classList.add('active');
              loginTab.classList.remove('active');
              registerMessage.textContent = '';
          });

          // 处理登录表单提交
          loginForm.addEventListener('submit', async function(e) {
              e.preventDefault();
              const username = document.getElementById('loginUsername').value;
              const password = document.getElementById('loginPassword').value;

              loginSpinner.style.display = 'inline-block';
              loginText.style.display = 'none';
              loginMessage.textContent = '';

              try {
                  const response = await fetch(`${API_URL}/user/login`, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ username, password })
                  });

                  const data = await response.json();

                  if (response.ok) {
                      localStorage.setItem('token', data.token);
                      loginMessage.textContent = '登录成功！';
                      loginMessage.style.color = 'green';
                      authModal.style.display = 'none';
                      updateAuthUI();
                      updateBalance(); // 登录成功后更新余额
                  } else {
                      throw new Error(data.message || '登录失败');
                  }
              } catch (error) {
                  loginMessage.textContent = error.message;
                  loginMessage.style.color = 'red';
              } finally {
                  loginSpinner.style.display = 'none';
                  loginText.style.display = 'inline';
              }
          });

          // 处理注册表单提交
          registerForm.addEventListener('submit', async function(e) {
              e.preventDefault();
              const username = document.getElementById('registerUsername').value;
              const password = document.getElementById('registerPassword').value;
              const confirmPassword = document.getElementById('registerConfirmPassword').value;

              if (password !== confirmPassword) {
                  registerMessage.textContent = '两次输入的密码不一致！';
                  registerMessage.style.color = 'red';
                  return;
              }

              registerSpinner.style.display = 'inline-block';
              registerText.style.display = 'none';
              registerMessage.textContent = '';

              try {
                  const response = await fetch(`${API_URL}/user/register`, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ username, password })
                  });

                  const data = await response.json();

                  if (response.ok) {
                      registerMessage.textContent = '注册成功！请登录。';
                      registerMessage.style.color = 'green';
                      // 注册成功后自动切换到登录界面
                      loginForm.classList.add('active');
                      registerForm.classList.remove('active');
                      loginTab.classList.add('active');
                      registerTab.classList.remove('active');
                      document.getElementById('loginUsername').value = username;
                      document.getElementById('loginPassword').value = '';
                  } else {
                      throw new Error(data.message || '注册失败');
                  }
              } catch (error) {
                  registerMessage.textContent = error.message;
                  registerMessage.style.color = 'red';
              } finally {
                  registerSpinner.style.display = 'none';
                  registerText.style.display = 'inline';
              }
          });

          // 退出登录
          logoutBtn.addEventListener('click', function() {
              localStorage.removeItem('token');
              updateAuthUI();
              // 清除余额显示
              document.getElementById('balanceAmount').textContent = '0';
              // 隐藏充值按钮和余额
              document.getElementById('rechargeBtn').style.display = 'none';
              document.getElementById('userBalance').style.display = 'none';
          });

          // 更新认证UI状态
          function updateAuthUI() {
              if (localStorage.getItem('token')) {
                  loginRegisterBtn.style.display = 'none';
                  logoutBtn.style.display = 'inline-block';
                  rechargeBtn.style.display = 'inline-block';
                  userBalance.style.display = 'block';
              } else {
                  loginRegisterBtn.style.display = 'inline-block';
                  logoutBtn.style.display = 'none';
                  rechargeBtn.style.display = 'none';
                  userBalance.style.display = 'none';
              }
          }

          // 页面加载时检查登录状态并更新UI
          updateAuthUI();

          // 获取用户余额并更新显示 (已在DOMContentLoaded中定义，这里仅为确保函数可用)
          async function updateBalance() {
              try {
                  const response = await fetch(`${API_URL}/user/balance`, {
                      headers: {
                          'Authorization': `Bearer ${localStorage.getItem('token')}`
                      }
                  });

                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }

                  const data = await response.json();

                  if (data.balance !== undefined) {
                      document.getElementById('balanceAmount').textContent = data.balance;
                  } else {
                      console.error('API响应中缺少balance字段');
                  }
              } catch (error) {
                  console.error('获取余额失败:', error);
                  document.getElementById('balanceAmount').textContent = '获取失败';
              }
          }

          // 如果已登录，立即执行并设置定时刷新
          if (localStorage.getItem('token')) {
              updateBalance();
              setInterval(updateBalance, 30000); // 每30秒刷新一次
          }
      });
    </script>
    
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --gold-color: #f39c12;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e9ecef;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Noto Serif SC', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .card-header i {
            font-size: 1.5rem;
            color: var(--secondary-color);
            margin-right: 15px;
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .form-group label i {
            margin-right: 8px;
            color: var(--secondary-color);
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            -webkit-appearance: none; /* 修复Safari下拉框样式 */
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg fill='%232c3e50' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Form Text Helper */
        .form-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
            display: block;
        }

        /* Button Styles */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        /* 从 wwstyle.css 复制的样式 */
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --text-color: #e0e0e0;
            --text-light: #b8c2cc;
            --text-dark: #8a94a6;
            --bg-dark: rgba(10, 10, 20, 0.7);
            --bg-light: rgba(20, 20, 30, 0.7);
            --border-color: rgba(106, 17, 203, 0.3);
            
            /* 愿望卡片等级颜色 */
            --level-1: rgba(20, 20, 30, 0.7);
            --level-2: rgba(26, 58, 95, 0.7);
            --level-3: rgba(93, 64, 55, 0.7);
            --level-4: rgba(127, 0, 0, 0.7);
            --level-5: rgba(150, 110, 20, 0.8);
            
            /* 能量条等级颜色 */
            --bar-1: #6a11cb;
            --bar-2: #2575fc;
            --bar-3: #d35400;
            --bar-4: #c0392b;
            --bar-5: #f1c40f;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            line-height: 1.6;
            color: var(--text-color);
            background: #000000;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== 背景动画 ==================== */
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at center, 
                rgba(106, 17, 203, 0.15) 0%, 
                rgba(10, 10, 20, 0.95) 100%
            );
            z-index: -1;
            opacity: 0.8;
        }

        /* ==================== 主内容容器 ==================== */
        .content-container {
            max-width: 1200px;
            margin: 30px auto 80px;
            padding: 50px 60px;
            background: #1a237e;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
            background-image: url('../images/dragon.gif');
            background-repeat: no-repeat;
            background-position: top center;
            background-size: auto;
        }

        .content-container:hover {
            box-shadow: 0 15px 40px rgba(106, 17, 203, 0.4);
            /* 确保背景颜色不变 */
            background-color: #1a237e;
            background-image: url('../images/dragon.gif');
        }

        .content-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(106, 17, 203, 0.1) 0%, rgba(37, 117, 252, 0.05) 100%);
            z-index: -1;
        }

        /* ==================== 标题区域 ==================== */
        .content-title {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .content-title h1 {
            font-size: 4.5rem;
            font-family: 'Ma Shan Zheng', cursive;
            font-weight: 800;
            color: white;
            padding: 20px 50px;
            display: inline-block;

            text-shadow: 0 2px 10px rgba(106, 17, 203, 0.5);
            margin-bottom: 10px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .content-title h1:hover {
            transform: translateY(-5px) rotate(1deg);

        }

        .content-title h1::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;

            transform: rotate(30deg);
            animation: shine 5s infinite;
        }

        @keyframes shine {
            0% { left: -50%; }
            100% { left: 150%; }
        }

        .content-title p {
            color: var(--text-light);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
            position: relative;
            padding: 15px 0;
        }

        .content-title p::before,
        .content-title p::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .content-title p::before {
            top: 0;
        }

        .content-title p::after {
            bottom: 0;
        }

        /* 从 wwstyle.css 复制的样式 (201-400行) */
        .content-title p::before,
        .content-title p::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .content-title p::before {
            top: 0;
        }

        .content-title p::after {
            bottom: 0;
        }

        /* ==================== 愿望池区域 ==================== */
        .wishing-pool-section {
            margin-top: 50px;
            text-align: center;
        }

        .wishing-pool-section h2 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 20px;
            font-family: 'Ma Shan Zheng', cursive;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .wishing-pool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .wish-card {
            background: var(--level-1);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 220px;
        }

        .wish-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
            z-index: 0;
            pointer-events: none;
        }

        .wish-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-color: var(--primary-color);
        }

        .wish-card.level-2 { background: var(--level-2); }
        .wish-card.level-3 { background: var(--level-3); }
        .wish-card.level-4 { background: var(--level-4); }
        .wish-card.level-5 { background: var(--level-5); }

        .wish-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .wish-card-header i {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .wish-card-header h3 {
            font-size: 1.4rem;
            color: white;
            font-weight: 600;
        }

        .wish-card p {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 15px;
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }

        .wish-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-dark);
            position: relative;
            z-index: 1;
        }

        .wish-card-footer span i {
            margin-right: 5px;
            color: var(--secondary-color);
        }

        .wish-card-footer .date {
            font-style: italic;
        }

        .wish-card-footer .status {
            font-weight: 600;
            color: var(--primary-color);
        }

        .wish-card-footer .status.fulfilled { color: var(--success-color); }
        .wish-card-footer .status.pending { color: var(--warning-color); }

        /* ==================== 许愿表单 ==================== */
        .make-wish-section {
            margin-top: 50px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .make-wish-section h2 {
            font-size: 2rem;
            color: white;
            margin-bottom: 25px;
            text-align: center;
            font-family: 'Ma Shan Zheng', cursive;
        }

        .wish-form .form-group {
            margin-bottom: 20px;
        }

        .wish-form label {
            display: block;
            color: var(--text-light);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .wish-form input[type="text"],
        .wish-form textarea,
        .wish-form select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .wish-form input[type="text"]:focus,
        .wish-form textarea:focus,
        .wish-form select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .wish-form textarea {
            resize: vertical;
            min-height: 100px;
        }

        .wish-form .btn-submit {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wish-form .btn-submit:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* ==================== 充值弹窗样式 ==================== */
        .recharge-modal,
        .auth-modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .recharge-container,
        .auth-container {
            background-color: #1a237e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .close-recharge,
        .close-auth {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-recharge:hover,
        .close-recharge:focus,
        .close-auth:hover,
        .close-auth:focus {
            color: white;
        }

        .recharge-header,
        .auth-header {
            text-align: center;
            margin-bottom: 25px;
            color: white;
        }

        .recharge-header h2,
        .auth-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-family: 'Ma Shan Zheng', cursive;
        }

        .recharge-header p,
        .auth-header p {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .recharge-form .form-group,
        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .recharge-form label,
        .auth-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 500;
        }

        .recharge-form input[type="number"],
        .recharge-form input[type="text"],
        .recharge-form input[type="password"],
        .auth-form input[type="text"],
        .auth-form input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .recharge-form input:focus,
        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.08);
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--secondary-color);
        }

        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: var(--primary-color);
            transform: scale(1.2);
        }

        .payment-option i {
            font-size: 1.5rem;
            margin-right: 10px;
            color: var(--primary-color);
        }

        .payment-option .payment-tag {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            margin-left: auto;
        }

        .recharge-btn,
        .auth-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .recharge-btn:hover,
        .auth-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .recharge-message,
        .auth-message {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: red;
        }

        /* 登录注册弹窗特有样式 */
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: white;
            border-color: var(--primary-color);
        }

        .auth-form {
            display: none; /* 默认隐藏 */
        }

        .auth-form.active {
            display: block;
        }

        /* 管理条样式 */
        .info-input-container {
            position: relative;
            /* 根据实际布局调整宽度和定位 */
            width: 100%; /* 示例宽度 */
            margin: 20px auto; /* 示例居中 */
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .management-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .management-bar span {
            font-weight: bold;
            color: #333;
        }

        .management-bar button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .management-bar button:hover {
            background-color: #0056b3;
        }

        /* 从 wwstyle.css 复制的样式 (401-600行) */
        .auth-switch-link {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .auth-switch-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch-link a:hover {
            text-decoration: underline;
        }

        /* ==================== 响应式设计 ==================== */
        @media (max-width: 768px) {
            .content-container {
                padding: 20px;
            }

            .content-title h1 {
                font-size: 2.5rem;
            }

            .content-title p {
                font-size: 1.1rem;
            }

            .wishing-pool-grid {
                grid-template-columns: 1fr;
            }

            .wish-card {
                padding: 20px;
            }

            .make-wish-section {
                padding: 20px;
            }

            .recharge-container,
            .auth-container {
                padding: 20px;
            }

            .recharge-header h2,
            .auth-header h2 {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 480px) {
            .content-title h1 {
                font-size: 2rem;
            }

            .content-title p {
                font-size: 1rem;
            }

            .recharge-header h2,
            .auth-header h2 {
                font-size: 1.5rem;
            }

            .recharge-form input,
            .auth-form input,
            .recharge-btn,
            .auth-btn {
                font-size: 0.9rem;
                padding: 10px;
            }

            .payment-option {
                flex-direction: column;
                align-items: flex-start;
            }

            .payment-option i {
                margin-bottom: 5px;
            }

            .payment-option .payment-tag {
                margin-left: 0;
                margin-top: 5px;
            }
        }

        .btn-center {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        /* Bazi Table - 优化版 */
        .bazi-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 25px 0;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(10px);
        }

        .bazi-table th,
        .bazi-table td {
            padding: 15px 12px;
            text-align: center;
            border: none;
            position: relative;
            height: auto;
            vertical-align: middle;
            transition: all 0.3s ease;
        }
        
        .bazi-table tr:not(:last-child) td,
        .bazi-table tr:not(:last-child) th {
            border-bottom: 1px solid rgba(233, 236, 239, 0.8);
        }
        
        .bazi-table th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            padding: 18px 15px;
        }

        .bazi-table td {
            background: transparent;
            font-weight: 500;
        }
        
        .bazi-table td:first-child {
            font-weight: 600;
            background: rgba(52, 152, 219, 0.05);
            border-right: 1px solid rgba(233, 236, 239, 0.8);
        }

        .bazi-table .pillar-header {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .bazi-table .stem {
            position: relative;
            padding: 15px 0;
        }

        .bazi-table .branch {
            position: relative;
            padding: 15px 0;
        }
        
        /* 添加柱子之间的分隔线 */
        .bazi-table th:not(:last-child),
        .bazi-table td:not(:last-child) {
            border-right: 1px solid rgba(233, 236, 239, 0.5);
        }
        
        /* 鼠标悬停效果 */
        .bazi-table tbody tr:hover td {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Chart Container - 优化版 */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 35px 0;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 20px;
            backdrop-filter: blur(5px);
            overflow: hidden;
        }
        
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }

/* Loading Spinner Styles */
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 20px;
}

.spinner-circle {
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

        .chart-description {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
            border-left: 4px solid var(--secondary-color);
        }
        
        .chart-description h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }
        
        .chart-description h4 i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .chart-description p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .chart-description strong {
            color: var(--primary-color);
        }

        /* Analysis Sections - 优化版 */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 35px 0;
        }

        .analysis-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }
        
        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at top right, rgba(52, 152, 219, 0.1), transparent 70%);
            border-radius: 0 0 0 100%;
        }

        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .analysis-card h3 {
            color: var(--primary-color);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            font-size: 1.4em;
            position: relative;
            padding-bottom: 12px;
        }
        
        .analysis-card h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), transparent);
            border-radius: 3px;
        }

        .analysis-card h3 i {
            margin-right: 12px;
            color: var(--secondary-color);
            font-size: 1.1em;
        }
        
        .analysis-card p {
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        .loading-overlay .loading {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
        }

        .loading-overlay p {
            color: white;
            font-size: 18px;
            margin: 0;
            text-align: center;
        }

        /* Beautiful Spinner */
        .beautiful-spinner {
            width: 20px;
            height: 20px;
            position: relative;
            display: inline-block;
        }

        .beautiful-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            border-top: 2px solid #3498db;
            border-right: 2px solid #e74c3c;
            border-radius: 50%;
            animation: beautiful-spin 1s linear infinite;
        }

        .beautiful-spinner::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: calc(100% - 6px);
            height: calc(100% - 6px);
            border: 2px solid transparent;
            border-top: 2px solid #f39c12;
            border-left: 2px solid #9b59b6;
            border-radius: 50%;
            animation: beautiful-spin 0.8s linear infinite reverse;
        }

        @keyframes beautiful-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab System - 优化版 */
        .tab-container {
            margin: 35px 0;
        }

        .tab-nav {
            display: flex;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            position: relative;
            z-index: 2;
            backdrop-filter: blur(5px);
        }

        .tab-btn {
            flex: 1;
            padding: 18px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            position: relative;
            overflow: hidden;
            color: var(--text-secondary);
            font-size: 1.05em;
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), rgba(52, 152, 219, 0.5));
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .tab-btn:hover::before {
            width: 30%;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(255,255,255,1), rgba(255,255,255,0.9));
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .tab-btn.active::before {
            width: 80%;
        }

        .tab-content {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            padding: 35px;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: none;
            position: relative;
            z-index: 1;
            margin-top: -1px;
            backdrop-filter: blur(5px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Analysis Button - 优化版 */
        .analysis-btn {
            width: 100%;
            padding: 22px 25px;
            margin: 18px 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }
        
        .analysis-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), transparent);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .analysis-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, rgba(255,255,255,1), rgba(255,255,255,0.9));
        }
        
        .analysis-btn:hover::before {
            opacity: 1;
        }

        .analysis-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .analysis-btn-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .analysis-btn-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .analysis-btn:hover .analysis-btn-title {
            color: var(--secondary-color);
            transform: translateX(5px);
        }

        .analysis-btn-title i {
            margin-right: 12px;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .analysis-btn:hover .analysis-btn-title i {
            transform: scale(1.2);
        }

        .analysis-btn-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
            transition: all 0.3s ease;
        }
        
        .analysis-btn:hover .analysis-btn-desc {
            color: var(--text-primary);
        }

        .analysis-content {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .analysis-content.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            body {
                overflow-x: auto;
            }
            
            .page-container {
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 15px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .tab-nav {
                flex-direction: column;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            /* 移动设备上的表单元素样式调整 */
            .form-group input,
            .form-group select {
                font-size: 16px; /* 防止iOS上自动缩放 */
                padding: 12px 40px 12px 15px; /* 增加右侧padding，为下拉箭头留出空间 */
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* 确保下拉箭头在移动设备上可见 */
            .form-group select {
                background-position: right 15px center;
                background-size: 16px;
            }
            
            /* 调整卡片内边距 */
            .card {
                padding: 20px 15px;
            }
        }
        
        /* 小屏幕设备的额外调整 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .card-header h2 {
                font-size: 1.3rem;
            }
            
            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            /* 确保表单元素在小屏幕上更易于点击 */
            .form-group input,
            .form-group select {
                height: 48px; /* 增加高度使触摸更容易 */
            }
        }

        /* Bazi Q&A Styles */
        .bazi-qa-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .bazi-qa-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .bazi-qa-header h3 {
            color: var(--primary-color);
            font-size: 1.5em;
            margin: 0 0 8px 0;
            font-weight: 600;
        }
        
        .bazi-qa-header h3 i {
            margin-right: 8px;
            color: var(--secondary-color);
        }
        
        .bazi-qa-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin: 0;
            line-height: 1.5;
        }
        
        .bazi-qa-input-section {
            margin-bottom: 20px;
        }
        
        .bazi-qa-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        #bazi-qa-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(52, 152, 219, 0.2);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            height: 48px;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
        }
        
        #bazi-qa-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: rgba(255,255,255,1);
        }
        
        .bazi-qa-submit {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
        }
        
        .bazi-qa-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .bazi-qa-submit:active {
            transform: translateY(0);
        }
        
        .bazi-qa-response {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            margin-top: 15px;
            line-height: 1.6;
        }
        
        .bazi-qa-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .qa-answer {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .qa-answer h4 {
            color: #007bff;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qa-answer h4 i {
            font-size: 1.2em;
        }
        
        .qa-content {
            line-height: 1.6;
            color: #333;
            font-size: 0.95em;
        }
        
        .qa-content br {
            margin-bottom: 8px;
        }
        
        .qa-content h1, .qa-content h2, .qa-content h3 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-weight: 600;
        }
        
        .qa-content h1 {
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .qa-content h2 {
            font-size: 1.2em;
            color: #34495e;
        }
        
        .qa-content h3 {
            font-size: 1.1em;
            color: #7f8c8d;
        }
        
        .qa-content strong {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .qa-content em {
            color: #8e44ad;
            font-style: italic;
        }
        
        .qa-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .qa-content li {
            margin: 5px 0;
            list-style-type: disc;
        }
        
        .qa-content p {
            margin: 10px 0;
            text-align: justify;
        }
        
        /* 移动设备适配 */
        @media (max-width: 768px) {
            .bazi-qa-input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            
            .bazi-qa-submit {
                justify-content: center;
            }
        }

        /* Hidden by default */
        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }
    /* 添加外层容器 */
    .page-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        overflow-x: hidden;
    }
    
    /* 内部容器使用100%宽度 */
    .container {
        width: 100%;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Safari特定样式 */
    @media not all and (min-resolution:.001dpcm) { 
        @supports (-webkit-appearance:none) {
            .form-group select {
                background-color: white; /* 确保背景色为白色 */
                text-indent: 1px; /* 修复文本对齐问题 */
                text-overflow: ''; /* 处理文本溢出 */
                padding-right: 30px; /* 为下拉箭头留出空间 */
            }
            
            /* 修复Safari上的触摸事件 */
            .form-group select:hover,
            .form-group select:focus {
                cursor: pointer;
                border-color: var(--secondary-color);
            }
        }
    }
    </style>
</head>
<body>
    <div class="info-input-container">
        <div class="management-bar">
            <span id="userBalance" style="display:none;">余额: <span id="balanceAmount">0</span></span>
            <button id="rechargeBtn" style="display:none;">充值</button>
            <button id="loginRegisterBtn">登录/注册</button>
            <button id="logoutBtn" style="display:none;">退出</button>
        </div>
        <!-- 其他信息输入内容将放在这里 -->
    <!-- 充值弹窗 -->
    <div class="recharge-modal" id="rechargeModal">
        <div class="recharge-container">
            <span class="close-recharge" id="closeRecharge">&times;</span>
            <div class="recharge-header">
                <h2><i class="fas fa-coins"></i> 账户充值</h2>
                <p>请填写充值金额并选择支付方式</p>
            </div>
            
            <form id="rechargeForm" class="recharge-form">
                <div class="form-group">
                    <label for="rechargeAmount">充值金额</label>
                    <input type="number" id="rechargeAmount" placeholder="请输入充值金额" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>支付方式</label>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="alipay" checked>
                            <i class="fab fa-alipay"></i> 支付宝 <span class="payment-tag">全球支付</span>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="wechat">
                            <i class="fab fa-weixin"></i> 微信支付 <span class="payment-tag">国内支付</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="recharge-btn">
                    <span id="rechargeText">立即充值</span>
                    <span id="rechargeSpinner" style="display:none;">处理中...</span>
                </button>
                
                <div id="rechargeMessage" class="recharge-message"></div>
            </form>
        </div>
    </div>

    <!-- 半透明登录注册弹窗 -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <span class="close-auth" id="closeAuth">&times;</span>
            <div class="auth-header">
                <h2><i class="fas fa-user-circle"></i> 命缘池</h2>
                <p>登录或注册以管理您的愿望</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">登录</div>
                <div class="auth-tab" id="registerTab">注册</div>
            </div>
            
           <!-- 登录表单 -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginUsername">用户名</label>
                    <input type="text" id="loginUsername" placeholder="请输入用户名" required>
                </div>

                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码" required>
                </div>

                <button type="submit" class="auth-btn">
                    <span id="loginText">登录</span>
                    <span id="loginSpinner" style="display:none;">处理中...</span>
                </button>

                <div id="loginMessage" class="auth-message"></div>
            </form>

            <!-- 注册表单 -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerUsername">用户名</label>
                    <input type="text" id="registerUsername" placeholder="请输入用户名" required>
                </div>

                <div class="form-group">
                    <label for="registerPassword">密码</label>
                    <input type="password" id="registerPassword" placeholder="请输入密码" required>
                </div>

                <div class="form-group">
                    <label for="registerConfirmPassword">确认密码</label>
                    <input type="password" id="registerConfirmPassword" placeholder="请再次输入密码" required>
                </div>

                <button type="submit" class="auth-btn">
                    <span id="registerText">注册</span>
                    <span id="registerSpinner" style="display:none;">处理中...</span>
                </button>

                <div id="registerMessage" class="auth-message"></div>
            </form>
        </div>
    </div>
    </div>
    <!-- 加载遮罩 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading beautiful-spinner"></div>
        <p id="loadingMessage">正在处理，请稍候...</p>
    </div>
    
    <div class="page-container">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-yin-yang"></i> 专业八字预测系统</h1>
            <p>精准排盘 · 详细分析 · 专业预测</p>
        </header>

        <!-- Input Section -->
        <section class="input-section" id="input-section">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-edit"></i>
                    <h2>请输入您的出生信息</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name"><i class="fas fa-user"></i> 姓名</label>
                        <input type="text" id="name" placeholder="请输入您的姓名" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="gender"><i class="fas fa-venus-mars"></i> 性别</label>
                        <select id="gender" required>
                            <option value="">请选择性别</option>
                            <option value="male">男</option>
                            <option value="female">女</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="birth-date"><i class="fas fa-calendar-alt"></i> 出生日期</label>
                        <input type="date" id="birth-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="birth-time"><i class="fas fa-clock"></i> 出生时间</label>
                        <input type="time" id="birth-time" placeholder="请输入出生时间" required>
                        <small class="form-text">请输入24小时制时间，例如：08:30、15:45</small>
                    </div>
                    </div>
                </div>
                
                <div class="btn-center">
                    <button class="btn btn-primary" id="calculate-btn">
                        <i class="fas fa-calculator"></i> 开始八字测算
                    </button>
                </div>
            </div>
        </section>

        <!-- Result Section -->
        <section class="result-section" id="result-section">
            <!-- Basic Info -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-circle"></i>
                    <h2 id="user-info-title">基本信息</h2>
                </div>
                <div id="basic-info-content">
                    <!-- 基本信息将在这里显示 -->
                </div>
            </div>

            <!-- Bazi Chart -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-table"></i>
                    <h2>八字排盘</h2>
                </div>
                <div id="bazi-chart">
                    <!-- 八字排盘表格将在这里显示 -->
                </div>
            </div>

            <!-- Five Elements Chart -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i>
                    <h2>五行力量分布与分析</h2>
                </div>
                <div class="elements-analysis-frame" style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px;">
                    <div class="chart-container" style="width: 100%; min-height: 350px; margin: 0 auto;">
                        <canvas id="elements-chart"></canvas>
                    </div>
                    <div id="elements-summary" style="width: 100%; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin: 0 auto;">
                        <!-- 五行分布概览将在这里显示 -->
                    </div>
                    <div class="chart-description" id="elements-description" style="width: 100%; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin: 0 auto;">
                        <!-- 五行分析描述 -->
                    </div>
                </div>
            </div>

            <!-- Strength Analysis -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-balance-scale"></i>
                    <h2>身强身弱分析</h2>
                </div>
                <div class="strength-analysis-frame" style="display: flex; flex-direction: row; gap: 20px; flex-wrap: wrap;">
                    <div class="chart-container" style="flex: 1; min-width: 300px; min-height: 350px;">
                        <canvas id="strength-chart"></canvas>
                    </div>
                    <div class="chart-description" id="strength-description" style="flex: 1; min-width: 300px; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <!-- 身强身弱分析描述 -->
                    </div>
                </div>
            </div>

            <!-- Luck Starting Time -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-hourglass-start"></i>
                    <h2>起运时间</h2>
                </div>
                <div id="luck-timing">
                    <!-- 起运时间分析 -->
                </div>
            </div>

            <!-- Fate Level Analysis -->
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3><i class="fas fa-star"></i> 命格等级</h3>
                    <div id="fate-level-content">
                        <!-- 命格等级分析 -->
                    </div>
                </div>
                
                <div class="analysis-card">
                    <h3><i class="fas fa-coins"></i> 财富等级</h3>
                    <div id="wealth-level-content">
                        <!-- 财富等级分析 -->
                    </div>
                </div>
            </div>

            <!-- Bazi Q&A Section -->
            <div class="bazi-qa-container">
                <div class="bazi-qa-header">
                    <h3><i class="fas fa-question-circle"></i> 八字问答</h3>
                    <p class="bazi-qa-subtitle">基于您的八字信息，询问任何八字相关问题</p>
                </div>
                <div class="bazi-qa-input-section">
                    <div class="bazi-qa-input-wrapper">
                        <input type="text" id="bazi-qa-input" placeholder="请输入您的八字相关问题，例如：我的事业运势如何？什么时候适合结婚？财运方面需要注意什么？" />
                        <button class="bazi-qa-submit" id="bazi-qa-submit">
                            <i class="fas fa-paper-plane"></i> 提问
                        </button>
                    </div>
                </div>
                <div id="bazi-qa-response" class="bazi-qa-response" style="display: none;">
                    <!-- 回答内容将在这里显示 -->
                </div>
                <div id="bazi-qa-loading" class="bazi-qa-loading" style="display: none;">
                    <div class="loading beautiful-spinner"></div>
                    <span>命理大师思考中，请耐心等待...</span>
                </div>
            </div>

            <!-- Analysis Tabs -->
            <div class="tab-container">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="fortune"><i class="fas fa-chart-line"></i> 运势分析</button>
                    <button class="tab-btn" data-tab="personality"><i class="fas fa-user-astronaut"></i> 个人分析</button>
                </div>
                
                <div class="tab-content active" id="fortune-tab">
                    <div class="analysis-btn" data-analysis="full-analysis">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-magic"></i> 命理全解
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">全面解析八字命理，包含性格、事业、财运、婚姻等多方面</div>
                    </div>
                    <div class="analysis-content" id="full-analysis-content"></div>
                    
                    <div class="analysis-btn" data-analysis="annual-fortune">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-calendar-alt"></i> 流年分析
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析当前流年对命局的影响和运势变化</div>
                    </div>
                    <div class="analysis-content" id="annual-fortune-content"></div>
                    
                    <div class="analysis-btn" data-analysis="monthly-fortune">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-calendar-day"></i> 流月分析
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">预测当前年份每月的运势起伏</div>
                    </div>
                    <div class="analysis-content" id="monthly-fortune-content"></div>
                    
                    <div class="analysis-btn" data-analysis="decade-fortune">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-hourglass-half"></i> 十年大运分析
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析一生中各阶段大运走势</div>
                    </div>
                    <div class="analysis-content" id="decade-fortune-content"></div>
                </div>
                
                <div class="tab-content" id="personality-tab">
                    <div class="analysis-btn" data-analysis="personality">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-brain"></i> 性格分析
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">根据八字分析性格特征和优缺点</div>
                    </div>
                    <div class="analysis-content" id="personality-content"></div>
                    
                    <div class="analysis-btn" data-analysis="career">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-briefcase"></i> 事业财富
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析适合的职业方向和财富格局</div>
                    </div>
                    <div class="analysis-content" id="career-content"></div>
                    
                    <div class="analysis-btn" data-analysis="marriage">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-heart"></i> 婚姻分析
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析婚姻状况和配偶特征</div>
                    </div>
                    <div class="analysis-content" id="marriage-content"></div>
                    
                    <div class="analysis-btn" data-analysis="children">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-baby"></i> 子女分析
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">分析子女缘分和教育方向</div>
                    </div>
                    <div class="analysis-content" id="children-content"></div>
                    
                    <div class="analysis-btn" data-analysis="health">
                        <div class="analysis-btn-header">
                            <div class="analysis-btn-title">
                                <i class="fas fa-heartbeat"></i> 健康分析
                            </div>
                            <div class="loading" style="display: none;"></div>
                        </div>
                        <div class="analysis-btn-desc">根据五行平衡分析健康状况</div>
                    </div>
                    <div class="analysis-content" id="health-content"></div>
                </div>
            </div>
            
            <div class="btn-center">
                <button class="btn btn-primary" id="recalculate-btn">
                    <i class="fas fa-redo"></i> 重新测算
                </button>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="../js/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 全局变量
        let currentBaziData = null;
        let elementsChart = null;
        let strengthChart = null;

        // DOM元素
        const inputSection = document.getElementById('input-section');
        const resultSection = document.getElementById('result-section');
        const calculateBtn = document.getElementById('calculate-btn');
        const recalculateBtn = document.getElementById('recalculate-btn');
        const birthTimeInput = document.getElementById('birth-time');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupTabSystem();
            setupAnalysisButtons();
        });

        // 设置事件监听器
        function setupEventListeners() {
            calculateBtn.addEventListener('click', handleCalculate);
            recalculateBtn.addEventListener('click', handleRecalculate);
            setupBaziQA();
        }
        
        // 设置八字问答功能
        function setupBaziQA() {
            const qaInput = document.getElementById('bazi-qa-input');
            const qaSubmit = document.getElementById('bazi-qa-submit');
            const qaResponse = document.getElementById('bazi-qa-response');
            const qaLoading = document.getElementById('bazi-qa-loading');
            
            if (qaSubmit) {
                qaSubmit.addEventListener('click', handleBaziQA);
            }
            
            if (qaInput) {
                qaInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        handleBaziQA();
                    }
                });
            }
        }
        
        // 处理八字问答
        async function handleBaziQA() {
            const qaInput = document.getElementById('bazi-qa-input');
            const qaResponse = document.getElementById('bazi-qa-response');
            const qaLoading = document.getElementById('bazi-qa-loading');
            const qaSubmit = document.getElementById('bazi-qa-submit');
            
            const question = qaInput.value.trim();
            if (!question) {
                alert('请输入您的问题');
                return;
            }
            
            // 检查是否已计算八字
            if (!window.currentBaziData) {
                alert('请先计算八字信息');
                return;
            }
            
            // 显示加载状态
            qaLoading.style.display = 'flex';
            qaResponse.style.display = 'none';
            qaSubmit.disabled = true;
            
            try {
                const response = await callBaziQAAPI(question, window.currentBaziData);
                
                // 显示回答
                qaResponse.innerHTML = response;
                qaResponse.style.display = 'block';
                qaLoading.style.display = 'none';
                
                // 清空输入框
                qaInput.value = '';
                
            } catch (error) {
                console.error('八字问答API调用失败:', error);
                qaResponse.innerHTML = '<p style="color: #e74c3c;">抱歉，问答服务暂时不可用，请稍后再试。</p>';
                qaResponse.style.display = 'block';
                qaLoading.style.display = 'none';
            } finally {
                qaSubmit.disabled = false;
            }
        }



        // 设置标签页系统
        function setupTabSystem() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // 移除所有活动状态
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // 添加活动状态
                    this.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });
        }

        // 设置分析按钮
        function setupAnalysisButtons() {
            const analysisBtns = document.querySelectorAll('.analysis-btn');
            
            analysisBtns.forEach(btn => {
                btn.addEventListener('click', async function() {
                    const analysisType = this.dataset.analysis;
                    const contentElement = document.getElementById(analysisType + '-content');
                    const loadingElement = this.querySelector('.loading');
                    
                    if (contentElement.classList.contains('show')) {
                        // 如果已经显示，则隐藏
                        contentElement.classList.remove('show');
                    } else {
                        // 检查是否有八字数据
                        if (!currentBaziData) {
                            alert('请先进行八字测算');
                            return;
                        }
                        
                        // 显示加载状态
                        loadingElement.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; width: 100%; margin: 0;"><i class="fas fa-spinner fa-spin" style="color: #3498db; font-size: 2.5em;"></i></span>';
                        loadingElement.style.display = 'flex';
                        loadingElement.style.position = 'absolute';
                        loadingElement.style.top = '0';
                        loadingElement.style.left = '0';
                        loadingElement.style.width = '100%';
                        loadingElement.style.height = '100%';
                        loadingElement.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                        loadingElement.style.borderRadius = '12px';
                        loadingElement.style.zIndex = '10';
                        // 移除 this.classList.add('loading'); 以避免潜在的旋转效果
                        
                        try {
                            // 使用本地已获取的八字信息、身强身弱信息和起运时间信息
                            // 通过DeepSeek API获取专业命理分析
                            const analysisContent = await getBaziAnalysisFromDeepSeek(analysisType, currentBaziData);
                            
                            // 隐藏加载状态
                            loadingElement.style.display = 'none';
                            this.classList.remove('loading');
                            
                            // 显示分析内容
                            contentElement.innerHTML = marked.parse(analysisContent);
contentElement.classList.add('show');
                            contentElement.classList.add('show');
                            console.log('成功获取API分析内容:', analysisType);
                        } catch (error) {
                            console.error('获取分析内容失败:', error);
                            
                            // 隐藏加载状态
                            loadingElement.style.display = 'none';
                            this.classList.remove('loading');
                            
                            // 显示错误提示和备用内容
                            const errorMessage = `<div class="api-error-message">API调用失败: ${error.message || '未知错误'}，使用备用内容</div>`;
                            contentElement.innerHTML = errorMessage + marked.parse(getAnalysisContent(analysisType));
                            contentElement.classList.add('show');
                        }
                    }
                });
            });
        }

        // 处理计算按钮点击
        async function handleCalculate() {
            if (!validateForm()) {
                return;
            }
            
            // 显示加载状态
            calculateBtn.innerHTML = '<div class="loading"></div> <span>计算中...</span>';
            calculateBtn.disabled = true;
            
            // 显示全局加载遮罩
            showLoading('正在进行八字测算，请稍候...');
            
            try {
                // 获取表单数据
                const formData = getFormData();
                
                // 计算八字
                const baziData = await calculateBazi(formData);
                currentBaziData = baziData;
                window.currentBaziData = baziData;
                
                // 显示结果
                displayResults(baziData);
                
                // 切换到结果页面
                inputSection.style.display = 'none';
                resultSection.classList.add('show');
                
            } catch (error) {
                console.error('计算失败:', error);
                alert('计算失败，请检查输入信息后重试');
            } finally {
                calculateBtn.innerHTML = '<i class="fas fa-calculator"></i> 开始八字测算';
                calculateBtn.disabled = false;
                
                // 隐藏全局加载遮罩
                hideLoading();
            }
        }

        // 显示加载状态
        function showLoading(message = '正在处理，请稍候...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
            
            loadingOverlay.style.display = 'flex';
        }
        
        // 隐藏加载状态
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'none';
        }
        
        // 处理重新计算
        function handleRecalculate() {
            inputSection.style.display = 'block';
            resultSection.classList.remove('show');
            
            // 清空API反馈内容的缓存
            const cacheKeys = [
                'full-analysis', 'annual-fortune', 'monthly-fortune', 'decade-fortune',
                'personality', 'career', 'wealth', 'marriage', 
                'health', 'luck', 'children', 'disaster'
            ];
            cacheKeys.forEach(analysisType => {
                // 清空localStorage中的缓存
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes(analysisType)) {
                        localStorage.removeItem(key);
                    }
                });
                
                // 清空页面显示内容
                const contentElement = document.getElementById(analysisType + '-content');
                if (contentElement) {
                    contentElement.innerHTML = '';
                    contentElement.classList.remove('show');
                }
            });
            
            // 重置当前八字数据
            currentBaziData = null;
            window.currentBaziData = null;
            
            // 重置表单
            document.getElementById('name').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('birth-date').value = '';
            document.getElementById('birth-time').value = '';
        }

        // 验证表单
        function validateForm() {
            const name = document.getElementById('name').value.trim();
            const gender = document.getElementById('gender').value;
            const birthDate = document.getElementById('birth-date').value;
            const birthTime = document.getElementById('birth-time').value;
            
            if (!name) {
                alert('请输入姓名');
                return false;
            }
            
            if (!gender) {
                alert('请选择性别');
                return false;
            }
            
            if (!birthDate) {
                alert('请选择出生日期');
                return false;
            }
            
            if (!birthTime) {
                alert('请输入出生时间');
                return false;
            }
            
            // 验证时间格式
            const timePattern = /^([01]?[0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timePattern.test(birthTime)) {
                alert('出生时间格式不正确，请使用24小时制（如：08:30、15:45）');
                return false;
            }
            
            return true;
        }

        // 获取表单数据
        function getFormData() {
            return {
                name: document.getElementById('name').value.trim(),
                gender: document.getElementById('gender').value,
                birthDate: document.getElementById('birth-date').value,
                birthTime: document.getElementById('birth-time').value
            };
        }

        // 计算八字
        async function calculateBazi(formData) {
            const { birthDate, birthTime } = formData;
            const [hour, minute] = birthTime.split(':').map(Number);
            
            // 验证时间格式
            if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                throw new Error('出生时间格式不正确，请使用24小时制（如：08:30、15:45）');
            }
            
            const date = new Date(birthDate + 'T00:00:00');
            date.setHours(hour, minute, 0, 0);
            
            // 使用lunar.js计算八字
            const solar = Solar.fromDate(date);
            const lunar = solar.getLunar();
            const eightChar = lunar.getEightChar();
            
            // 获取四柱信息
            const yearPillar = eightChar.getYear();
            const monthPillar = eightChar.getMonth();
            const dayPillar = eightChar.getDay();
            const hourPillar = eightChar.getTime();
            
            // 确保四柱是字符串
            const yearStr = typeof yearPillar === 'string' ? yearPillar : String(yearPillar);
            const monthStr = typeof monthPillar === 'string' ? monthPillar : String(monthPillar);
            const dayStr = typeof dayPillar === 'string' ? dayPillar : String(dayPillar);
            const hourStr = typeof hourPillar === 'string' ? hourPillar : String(hourPillar);
            
            // 计算藏干
            const hiddenStems = {
                year: yearStr.length > 1 ? getHiddenStems(yearStr.charAt(1)) : [],
                month: monthStr.length > 1 ? getHiddenStems(monthStr.charAt(1)) : [],
                day: dayStr.length > 1 ? getHiddenStems(dayStr.charAt(1)) : [],
                hour: hourStr.length > 1 ? getHiddenStems(hourStr.charAt(1)) : []
            };
            
            // 计算五行分布
            const elements = calculateElements(yearStr, monthStr, dayStr, hourStr, hiddenStems);
            
            // 计算身强身弱
            // 计算起运时间
            const luckTiming = calculateLuckTiming(formData.gender, lunar);
            
            // 定义四柱对象
            const pillars = {
                year: yearStr,
                month: monthStr,
                day: dayStr,
                hour: hourStr
            };
            
            // 将四柱信息保存到window对象，供其他函数使用
            window.currentPillars = pillars;
            
            // 提取地支并保存到window对象，供三合局检测使用
            const allBranches = [];
            if (yearStr.length > 1) allBranches.push(yearStr.charAt(1));
            if (monthStr.length > 1) allBranches.push(monthStr.charAt(1));
            if (dayStr.length > 1) allBranches.push(dayStr.charAt(1));
            if (hourStr.length > 1) allBranches.push(hourStr.charAt(1));
            window.allBranches = allBranches;
            console.log('设置八字地支:', window.allBranches);
            
            // 计算身强身弱
            const strengthAnalysis = calculateStrength(dayStr, elements, monthStr, allBranches);
            
            // 计算命格等级
            const fateLevel = calculateFateLevel(pillars);
            
            // 计算财富等级
            const wealthLevel = calculateWealthLevel(pillars);
            
            return {
                name: formData.name,
                gender: formData.gender,
                birthDate: formData.birthDate,
                birthTime: formData.birthTime,
                solar: solar,
                lunar: lunar,
                pillars: {
                    year: yearStr,
                    month: monthStr,
                    day: dayStr,
                    hour: hourStr
                },
                hiddenStems: hiddenStems,
                elements: elements,
                strengthAnalysis: strengthAnalysis,
                luckTiming: luckTiming,
                fateLevel: fateLevel,
                wealthLevel: wealthLevel,
                // API调用所需的格式化数据
                formattedBirthDate: `${lunar.getYear()}年${lunar.getMonth()}月${lunar.getDay()}日`,
                formattedBirthTime: `${formData.birthTime}时`,
                baziString: `${yearPillar} ${monthPillar} ${dayPillar} ${hourPillar}`
            };
        }

        // 获取地支藏干
        function getHiddenStems(branch) {
            const hiddenStemsMap = {
                '子': ['癸'],
                '丑': ['己', '癸', '辛'],
                '寅': ['甲', '丙', '戊'],
                '卯': ['乙'],
                '辰': ['戊', '乙', '癸'],
                '巳': ['丙', '庚', '戊'],
                '午': ['丁', '己'],
                '未': ['己', '丁', '乙'],
                '申': ['庚', '壬', '戊'],
                '酉': ['辛'],
                '戌': ['戊', '辛', '丁'],
                '亥': ['壬', '甲']
            };
            return hiddenStemsMap[branch] || [];
        }

        // 计算五行分布
        function calculateElements(year, month, day, hour, hiddenStems) {
            const elementMap = {
                '甲': 'wood', '乙': 'wood',
                '丙': 'fire', '丁': 'fire',
                '戊': 'earth', '己': 'earth',
                '庚': 'metal', '辛': 'metal',
                '壬': 'water', '癸': 'water',
                '寅': 'wood', '卯': 'wood',
                '巳': 'fire', '午': 'fire',
                '辰': 'earth', '戌': 'earth', '丑': 'earth', '未': 'earth',
                '申': 'metal', '酉': 'metal',
                '子': 'water', '亥': 'water'
            };
            
            const elements = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            
            // 确保四柱是字符串
            const pillars = [
                typeof year === 'string' ? year : String(year),
                typeof month === 'string' ? month : String(month),
                typeof day === 'string' ? day : String(day),
                typeof hour === 'string' ? hour : String(hour)
            ];
            
            // 计算天干地支
            const pillarWeights = [1.0, 1.2, 1.0, 0.8]; // 年月日时的权重
            pillars.forEach((pillar, index) => {
                if (pillar && pillar.length >= 2) {
                    const stem = pillar.charAt(0);
                    const branch = pillar.charAt(1);
                    const weight = pillarWeights[index];
                    
                    if (elementMap[stem]) elements[elementMap[stem]] += 2 * weight; // 天干权重2，乘以柱位权重
                    if (elementMap[branch]) elements[elementMap[branch]] += 1 * weight; // 地支权重1，乘以柱位权重
                }
            });
            
            // 计算藏干
            const hiddenStemWeights = [0.5, 0.6, 0.5, 0.4]; // 年月日时藏干的权重
            Object.entries(hiddenStems).forEach(([pillar, stems], index) => {
                stems.forEach(stem => {
                    if (elementMap[stem]) {
                        const weight = hiddenStemWeights[index];
                        elements[elementMap[stem]] += 0.5 * weight; // 藏干权重0.5，乘以柱位权重
                    }
                });
            });
            
            // 打印调试信息
            console.log('五行分布计算结果:', elements);
            
            return elements;
        }

        // 计算身强身弱
        function calculateStrength(dayStem, elements, monthBranch, passedBranches = []) {
            // 确保输入是字符串
            dayStem = typeof dayStem === 'string' ? dayStem : String(dayStem);
            monthBranch = typeof monthBranch === 'string' ? monthBranch : String(monthBranch);
            
            // 获取第一个字符作为天干
            dayStem = dayStem.charAt(0);
            // 获取第二个字符作为地支
            monthBranch = monthBranch.length > 1 ? monthBranch.charAt(1) : monthBranch;
            
            const stemElementMap = {
                '甲': 'wood', '乙': 'wood',
                '丙': 'fire', '丁': 'fire',
                '戊': 'earth', '己': 'earth',
                '庚': 'metal', '辛': 'metal',
                '壬': 'water', '癸': 'water'
            };
            
            const dayElement = stemElementMap[dayStem];
            
            // 获取八字中的所有地支
            let allBranches = [];
            try {
                // 从四柱中获取地支
                const pillars = window.currentPillars || {};
                console.log('当前四柱信息:', pillars);
                
                if (pillars.year && pillars.year.length > 1) allBranches.push(pillars.year.charAt(1));
                if (pillars.month && pillars.month.length > 1) allBranches.push(pillars.month.charAt(1));
                if (pillars.day && pillars.day.length > 1) allBranches.push(pillars.day.charAt(1));
                if (pillars.hour && pillars.hour.length > 1) allBranches.push(pillars.hour.charAt(1));
                
                // 如果无法从currentPillars获取，尝试从eightChar获取
                if (allBranches.length === 0) {
                    console.log('尝试从eightChar获取地支');
                    const eightChar = window.eightChar || {};
                    if (eightChar.getYear && typeof eightChar.getYear === 'function') {
                        const year = eightChar.getYear();
                        if (year && year.length > 1) allBranches.push(year.charAt(1));
                    }
                    if (eightChar.getMonth && typeof eightChar.getMonth === 'function') {
                        const month = eightChar.getMonth();
                        if (month && month.length > 1) allBranches.push(month.charAt(1));
                    }
                    if (eightChar.getDay && typeof eightChar.getDay === 'function') {
                        const day = eightChar.getDay();
                        if (day && day.length > 1) allBranches.push(day.charAt(1));
                    }
                    if (eightChar.getTime && typeof eightChar.getTime === 'function') {
                        const time = eightChar.getTime();
                        if (time && time.length > 1) allBranches.push(time.charAt(1));
                    }
                }
            } catch (e) {
                console.error('获取八字地支失败:', e);
            }
            
            // 如果无法从页面获取，则使用传入的月支
            if (allBranches.length === 0 && monthBranch) {
                console.log('使用传入的月支:', monthBranch);
                allBranches.push(monthBranch);
            }
            
            // 打印调试信息
            console.log('八字地支:', allBranches);
            
            // 将地支数组保存到window对象，供其他函数使用
            window.allBranches = allBranches;
            
            // 检查合化情况
            const combined = checkCombinations(dayStem, monthBranch, passedBranches);

            // 保存日主天干到combined对象，供getMonthStrength使用
            combined.dayStem = dayStem;
            
            // 计算月令得分 (权重40%)
            let monthScore = getMonthStrength(dayElement, monthBranch, combined);
            
            console.log(`月令得分计算 - 日主:${dayStem}(${dayElement}), 月支:${monthBranch}, 得分:${monthScore}`);
            
            // 计算生扶力量（生我、助我）
            const supportElements = getSupportElements(dayElement);
            let supportStrength = 0;
            supportElements.forEach(element => {
                supportStrength += elements[element];
            });
            
            // 计算克泄力量（克我、泄我、耗我）
            const weakenElements = getWeakenElements(dayElement);
            let weakenStrength = 0;
            weakenElements.forEach(element => {
                weakenStrength += elements[element];
            });
            
            // 统一处理所有合化的加减分
            let combinationDeduction = 0;
            const combinationTypes = ['tianGanWuHe', 'diZhiLiuHe', 'diZhiSanHe'];
            combinationTypes.forEach(type => {
                combined[type].forEach(comb => {
                    const heElement = comb.element;
                    let multiplier = (type === 'diZhiSanHe' ? (comb.count === 3 ? 5 : 3) : (type === 'tianGanWuHe' ? 3 : 2));
                    if (getSupportElements(dayElement).includes(heElement)) {
                        supportStrength += multiplier;
                        combinationDeduction += multiplier; // 增强，正值
                        console.log(`${type} ${comb.gan1 || comb.zhi1 || comb.type || comb.branches} 合化${heElement} 生助日主，增加生扶 ${multiplier}`);
                    } else if (getWeakenElements(dayElement).includes(heElement)) {
                        supportStrength -= multiplier;
                        combinationDeduction -= multiplier; // 削弱，负值
                        console.log(`${type} ${comb.gan1 || comb.zhi1 || comb.type || comb.branches} 合化${heElement} 克泄日主，减少生扶 ${multiplier}`);
                    } else {
                        console.log(`${type} ${comb.gan1 || comb.zhi1 || comb.type || comb.branches} 合化${heElement} 中性影响`);
                    }
                });
            });
            combined.deduction = combinationDeduction;
            // 设置整体effect
            if (combinationDeduction > 0) {
                combined.effect = 'strengthen';
            } else if (combinationDeduction < 0) {
                combined.effect = 'weaken';
            } else {
                combined.effect = 'neutral';
            }
            
            // 确保合化信息显示在界面上
            window.combinedInfo = combined;
            
            // 移除通用effect调整，已在具体合化中处理
            
            // 三合加减已在统一处理中完成，保留特别处理
            if (combined.hasOwnProperty('sanhe')) {
                if (combined.sanhe.type === '巳酉丑' && dayStem === '己') {
                    weakenStrength += 3;
                    console.log('巳酉丑三合金对己土日主的特殊影响，额外增加克泄力量 3');
                }
            }
            
            // 计算总分
            const totalScore = monthScore + supportStrength - weakenStrength;
            
            // 判断身强身弱
            const strengthRatio = supportStrength / (supportStrength + weakenStrength);
            
            // 打印调试信息
            console.log(`身强身弱计算 - 日主:${dayStem}(${dayElement}), 生扶力量:${supportStrength}, 克泄力量:${weakenStrength}, 比例:${(strengthRatio * 100).toFixed(1)}%, 月令得分:${monthScore}`);
            
            let type, description;
            
            // 判断是否从格
            const isFollowing = checkFollowingPattern(dayElement, monthBranch, strengthRatio, supportStrength, weakenStrength, monthScore);
            
            if (isFollowing.isFollowing) {
                type = isFollowing.type;
                description = isFollowing.description;
            } else if (strengthRatio >= 0.60) { // 调整阈值，使身强判断更准确
                type = '身强';
                description = '日主力量强旺，能够承担财官，适合主动出击，喜用财官。';
            } else if (strengthRatio >= 0.40 && strengthRatio < 0.60) { // 调整均衡范围
                type = '均衡';
                description = '日主力量适中，五行较为平衡，运势平稳，喜用印比。';
            } else {
                type = '身弱';
                description = '日主力量偏弱，需要生扶，宜守不宜攻，喜用印比。';
            }
            
            return {
                type: type,
                ratio: strengthRatio,
                supportStrength: supportStrength,
                weakenStrength: weakenStrength,
                description: description,
                monthScore: monthScore,
                totalScore: totalScore,
                combined: combined
            };
        }
        
        // 检查合化情况
        function checkCombinations(dayStem, monthBranch, branches) {
            const combined = {
                tianGanWuHe: [],
                diZhiLiuHe: [],
                diZhiSanHe: [],
                deduction: 0 // 合化扣分
            };
            
            const stemElementMap = {
                '甲': 'wood', '乙': 'wood',
                '丙': 'fire', '丁': 'fire',
                '戊': 'earth', '己': 'earth',
                '庚': 'metal', '辛': 'metal',
                '壬': 'water', '癸': 'water'
            };
            
            // 天干五合规则
            const tianGanHeHua = {
                '甲己': 'earth',
                '乙庚': 'metal',
                '丙辛': 'water',
                '丁壬': 'wood',
                '戊癸': 'fire'
            };
            
            // 地支六合规则
            const diZhiLiuHe = {
                '子丑': 'earth',
                '寅亥': 'wood',
                '卯戌': 'fire',
                '辰酉': 'metal',
                '巳申': 'water',
                '午未': 'earth'
            };
            
            // 地支三合规则
            const diZhiSanHe = [
                {branches: ['申', '子', '辰'], element: 'water'}, // 三合水局
                {branches: ['亥', '卯', '未'], element: 'wood'},  // 三合木局
                {branches: ['寅', '午', '戌'], element: 'fire'},  // 三合火局
                {branches: ['巳', '酉', '丑'], element: 'metal'}  // 三合金局
            ];
            
            // 获取八字四柱
            let allStems = [];
            let allBranches = [];
            
            try {
                const pillars = window.currentPillars || {};
                if (pillars.year) {
                    allStems.push(pillars.year.charAt(0));
                    allBranches.push(pillars.year.charAt(1));
                }
                if (pillars.month) {
                    allStems.push(pillars.month.charAt(0));
                    allBranches.push(pillars.month.charAt(1));
                }
                if (pillars.day) {
                    allStems.push(pillars.day.charAt(0));
                    allBranches.push(pillars.day.charAt(1));
                }
                if (pillars.hour) {
                    allStems.push(pillars.hour.charAt(0));
                    allBranches.push(pillars.hour.charAt(1));
                }
            } catch (e) {
                console.error('获取八字信息失败:', e);
            }
            
            // 检查相邻天干五合
            for (let i = 0; i < allStems.length - 1; i++) {
                const stem1 = allStems[i];
                const stem2 = allStems[i+1];
                const pair1 = stem1 + stem2;
                const pair2 = stem2 + stem1;
                
                if (tianGanHeHua[pair1] || tianGanHeHua[pair2]) {
                    const hehuaElement = tianGanHeHua[pair1] || tianGanHeHua[pair2];
                    combined.tianGanWuHe.push({
                        gan1: stem1,
                        gan2: stem2,
                        element: hehuaElement,
                        positions: [i, i+1]
                    });
                    console.log(`发现相邻天干五合: ${stem1}${stem2} 合化为${hehuaElement}`);
                }
            }
            
            // 检查相邻地支六合
            for (let i = 0; i < allBranches.length - 1; i++) {
                const branch1 = allBranches[i];
                const branch2 = allBranches[i+1];
                const pair1 = branch1 + branch2;
                const pair2 = branch2 + branch1;
                
                if (diZhiLiuHe[pair1] || diZhiLiuHe[pair2]) {
                    const hehuaElement = diZhiLiuHe[pair1] || diZhiLiuHe[pair2];
                    combined.diZhiLiuHe.push({
                        zhi1: branch1,
                        zhi2: branch2,
                        element: hehuaElement,
                        positions: [i, i+1]
                    });
                    console.log(`发现相邻地支六合: ${branch1}${branch2} 合化为${hehuaElement}`);
                }
            }
            
            // 保存地支数组供三合检测使用
            window.allBranches = allBranches;
            
            const elementMap = {
                'wood': '木',
                'fire': '火',
                'earth': '土',
                'metal': '金',
                'water': '水'
            };
            
            // 检查连续地支三合（只检查全三合，连续三个位置的地支set匹配）
            if (allBranches && allBranches.length >= 3) {
                console.log('检查连续三合局，地支:', branches);
                
                let bestMatch = null;
                
                for (let i = 0; i <= allBranches.length - 3; i++) {
                    const trio = allBranches.slice(i, i+3).sort().join('');
                    for (const sanhe of diZhiSanHe) {
                        const sanheSorted = sanhe.branches.sort().join('');
                        if (trio === sanheSorted) {
                            bestMatch = {
                                type: sanhe.branches.join(''),
                                element: sanhe.element,
                                count: 3,
                                branches: allBranches.slice(i, i+3).join(''),
                                isFullSanhe: true
                            };
                            combined.diZhiSanHe.push(bestMatch);
                            console.log(`发现连续全三合局: ${bestMatch.branches} 合化为${sanhe.element}`);
                            break;
                        }
                    }
                    if (bestMatch) break; // 只记录一个最佳
                }
                
                if (bestMatch) {
                    combined.sanhe = bestMatch;
                }
            }
            
            // 移除半三合和特别检查，只全连续三合
            
            // 简化的合化判断
            const dayElement = stemElementMap[dayStem];
            
            // 判断合化是否有利于日主
            if (dayElement && !combined.effect) {
                // 检查所有合化的影响
                let hasStrengthening = false;
                let hasWeakening = false;
                
                // 检查天干五合
                combined.tianGanWuHe.forEach(comb => {
                    if (getSupportElements(dayElement).includes(comb.element)) {
                        hasStrengthening = true;
                        console.log(`天干五合 ${comb.gan1}${comb.gan2} 合化${comb.element} 生助日主`);
                    } else if (getWeakenElements(dayElement).includes(comb.element)) {
                        hasWeakening = true;
                        console.log(`天干五合 ${comb.gan1}${comb.gan2} 合化${comb.element} 克泄日主`);
                    }
                });
                
                // 检查地支六合
                combined.diZhiLiuHe.forEach(comb => {
                    if (getSupportElements(dayElement).includes(comb.element)) {
                        hasStrengthening = true;
                        console.log(`地支六合 ${comb.zhi1}${comb.zhi2} 合化${comb.element} 生助日主`);
                    } else if (getWeakenElements(dayElement).includes(comb.element)) {
                        hasWeakening = true;
                        console.log(`地支六合 ${comb.zhi1}${comb.zhi2} 合化${comb.element} 克泄日主`);
                    }
                });
                
                // 检查地支三合
                combined.diZhiSanHe.forEach(comb => {
                    if (getSupportElements(dayElement).includes(comb.element)) {
                        hasStrengthening = true;
                        console.log(`地支三合 ${comb.type || comb.branches} 合化${comb.element} 生助日主`);
                    } else if (getWeakenElements(dayElement).includes(comb.element)) {
                        hasWeakening = true;
                        console.log(`地支三合 ${comb.type || comb.branches} 合化${comb.element} 克泄日主`);
                    }
                });
                
                // 设置最终影响
                if (hasStrengthening && !hasWeakening) {
                    combined.effect = 'strengthen';
                    console.log('合化总体对日主影响: 增强');
                } else if (hasWeakening && !hasStrengthening) {
                    combined.effect = 'weaken';
                    console.log('合化总体对日主影响: 削弱');
                } else if (hasStrengthening && hasWeakening) {
                    combined.effect = 'mixed';
                    console.log('合化总体对日主影响: 混合');
                } else {
                    combined.effect = 'neutral';
                    console.log('合化总体对日主影响: 中性');
                }
            }
            
            return combined;
        }
        
        // 获取月令强度
        function getMonthStrength(dayElement, monthBranch, combined) {
            const branchElementMap = {
                '子': 'water', '丑': 'earth',
                '寅': 'wood', '卯': 'wood',
                '辰': 'earth', '巳': 'fire',
                '午': 'fire', '未': 'earth',
                '申': 'metal', '酉': 'metal',
                '戌': 'earth', '亥': 'water'
            };
            
            // 如果月支被合化，使用合化后的元素
            let monthElement = combined.hasOwnProperty('monthElement') ? 
                combined.monthElement : branchElementMap[monthBranch];
            
            // 考虑三合的影响
            if (combined.hasOwnProperty('sanhe')) {
                // 如果有三合局，考虑三合的影响
                const sanhe = combined.sanhe;
                if (sanhe.count === 3) { // 全三合，影响更大
                    monthElement = sanhe.element; // 使用三合的五行
                }
            }
            
            if (!monthElement) return 0; // 如果无法确定月令元素，返回0
            
            // 获取生扶和克泄元素列表
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            // 特别处理巳酉丑三合金对己土日主的影响
            if (combined.hasOwnProperty('sanhe') && 
                combined.sanhe.type === '巳酉丑' && 
                dayElement === 'earth') {
                console.log('特别处理：巳酉丑三合金对己土日主的影响，月令得分 -30');
                return -30; // 三合金对土的克制更强
            }
            
            let score = 0;
            
            if (monthElement === dayElement) {
                score = 40;  // 得令
                console.log(`月令得分：${score} (得令，月令五行与日主相同)`);
            } else if (supportElements.includes(monthElement)) {
                score = 20;  // 得生
                console.log(`月令得分：${score} (得生，月令五行生扶日主)`);
            } else if (weakenElements.includes(monthElement)) {
                score = -20; // 被克
                console.log(`月令得分：${score} (被克，月令五行克泄日主)`);
            } else {
                score = 0;   // 不得令
                console.log(`月令得分：${score} (不得令，月令五行与日主无关)`);
            }
            
            // 考虑特殊情况：戊己土日主在子月、辰月、戌月的特殊表现
            if ((dayElement === 'earth') && (['子', '辰', '戌'].includes(monthBranch))) {
                // 戊土在子月、辰月、戌月偏强
                if (combined.dayStem === '戊') {
                    score += 10;
                    console.log(`特殊情况：戊土在${monthBranch}月偏强，月令得分调整为 ${score}`);
                }
            }
            
            return score;
        }
        
        // 检查是否从格
        function checkFollowingPattern(dayElement, monthBranch, strengthRatio, supportStrength, weakenStrength, monthScore) {
            const effective_weaken = weakenStrength + (monthScore < 0 ? -monthScore : 0);
            if (supportStrength <= 5 && effective_weaken >= 15) {
                console.log(`从弱格判断: 生扶力量${supportStrength} <= 5, 有效克泄力量${effective_weaken} >= 15`);
                return {
                    isFollowing: true,
                    type: '从弱',
                    description: '日主极弱，生扶力量不足，命局以克泄日主的五行为用神，顺势而为，喜用财官。'
                };
            }
            const branchElementMap = {
                '子': 'water', '丑': 'earth',
                '寅': 'wood', '卯': 'wood',
                '辰': 'earth', '巳': 'fire',
                '午': 'fire', '未': 'earth',
                '申': 'metal', '酉': 'metal',
                '戌': 'earth', '亥': 'water'
            };
            
            const monthElement = branchElementMap[monthBranch];
            if (!monthElement) return { isFollowing: false };
            
            // 获取生扶和克泄元素列表
            const supportElements = getSupportElements(dayElement);
            const weakenElements = getWeakenElements(dayElement);
            
            // 从弱格：生扶力量小于等于5且克泄力量大于等于15
            if (supportStrength <= 5 && weakenStrength >= 15) {
                console.log(`从弱格判断: 生扶力量${supportStrength} <= 5, 克泄力量${weakenStrength} >= 15`);
                return {
                    isFollowing: true,
                    type: '从弱',
                    description: '日主极弱，生扶力量不足，命局以克泄日主的五行为用神，顺势而为，喜用财官。'
                };
            }
            
            // 传统从弱格判断（作为备用）
            if (strengthRatio < 0.3 && weakenElements.includes(monthElement)) {
                console.log(`传统从弱格判断: 比例${(strengthRatio * 100).toFixed(1)}% < 30%, 月令克泄日主`);
                return {
                    isFollowing: true,
                    type: '从弱',
                    description: '日主偏弱，但命局以克泄日主的五行为用神，顺势而为，喜用财官。'
                };
            }
            
            // 从强格：身强而用生扶
            if (strengthRatio > 0.7 && supportElements.includes(monthElement)) {
                console.log(`从强格判断: 比例${(strengthRatio * 100).toFixed(1)}% > 70%, 月令生扶日主`);
                return {
                    isFollowing: true,
                    type: '从强',
                    description: '日主偏强，但命局以生扶日主的五行为用神，顺势而为，喜用印比。'
                };
            }
            
            return { isFollowing: false };
        }

        // 获取生扶五行
        function getSupportElements(element) {
            const supportMap = {
                'wood': ['water', 'wood'],
                'fire': ['wood', 'fire'],
                'earth': ['fire', 'earth'],
                'metal': ['earth', 'metal'],
                'water': ['metal', 'water']
            };
            return supportMap[element] || [];
        }

        // 获取克泄五行
        function getWeakenElements(element) {
            const weakenMap = {
                'wood': ['metal', 'fire', 'earth'],
                'fire': ['water', 'earth', 'metal'],
                'earth': ['wood', 'metal', 'water'],
                'metal': ['fire', 'water', 'wood'],
                'water': ['earth', 'wood', 'fire']
            };
            return weakenMap[element] || [];
        }

        // 计算起运时间 - 根据正确的八字起运算法
        function calculateLuckTiming(gender, lunar) {
            try {
                // 获取出生时间信息
                const solar = lunar.getSolar();
                const birthDate = new Date(
                    solar.getYear(),
                    solar.getMonth() - 1,
                    solar.getDay(),
                    solar.getHour(),
                    solar.getMinute(),
                    solar.getSecond()
                );
                
                // 获取年柱天干
                const eightChar = lunar.getEightChar();
                const yearPillar = eightChar.getYear();
                const yearStr = typeof yearPillar === 'string' ? yearPillar : String(yearPillar);
                const yearGan = yearStr.charAt(0);
                
                // 1. 判断年柱阴阳与顺逆排
                const yangTianGan = ['甲', '丙', '戊', '庚', '壬'];
                const yinTianGan = ['乙', '丁', '己', '辛', '癸'];
                const isMale = gender === 'male';
                
                let direction;
                if ((yangTianGan.includes(yearGan) && isMale) || (yinTianGan.includes(yearGan) && !isMale)) {
                    direction = '顺排'; // 阳年男 or 阴年女
                } else {
                    direction = '逆排'; // 阴年男 or 阳年女
                }
                
                // 2. 计算出生日到最近节气的天数差
                const daysDiff = getDaysToJieQi(birthDate, direction, solar.getYear());
                
                // 3. 起运年龄计算
                const years = Math.floor(daysDiff / 3); // 3天 = 1岁
                const months = Math.round((daysDiff / 3 - years) * 12); // 小数部分转月份
                
                return {
                    age: years,
                    months: months,
                    direction: direction,
                    daysDiff: daysDiff.toFixed(2),
                    description: `${direction}，${years}岁${months}个月起运`
                };
            } catch (error) {
                console.error('起运计算错误:', error);
                // 返回默认值
                return {
                    age: 8,
                    months: 0,
                    direction: '顺排',
                    daysDiff: '24.00',
                    description: '8岁0个月起运（默认值）'
                };
            }
        }
        
        // 计算出生日到最近节气的天数差
        function getDaysToJieQi(birthDate, direction, birthYear) {
            try {
                // 获取当年的节气表
                const solar = Solar.fromYmd(birthYear, 6, 1);
                const lunar = solar.getLunar();
                const jieQiTable = lunar.getJieQiTable();
                
                // 八字换月节气列表（用于起运计算）
                const monthlyJieQi = [
                    '立春', '惊蛰', '清明', '立夏', '芒种', '小暑',
                    '立秋', '白露', '寒露', '立冬', '大雪', '小寒'
                ];
                
                let targetJieQi = null;
                let minDiff = Infinity;
                
                // 检查当年和前后一年的节气
                for (let yearOffset = -1; yearOffset <= 1; yearOffset++) {
                    const checkYear = birthYear + yearOffset;
                    
                    for (const jieQiName of monthlyJieQi) {
                        const jieQiSolar = getJieQiTime(checkYear, jieQiName);
                        if (!jieQiSolar) continue;
                        
                        const jieQiDate = new Date(
                            jieQiSolar.getYear(),
                            jieQiSolar.getMonth() - 1,
                            jieQiSolar.getDay(),
                            jieQiSolar.getHour(),
                            jieQiSolar.getMinute(),
                            jieQiSolar.getSecond()
                        );
                        
                        const timeDiff = jieQiDate.getTime() - birthDate.getTime();
                        
                        if (direction === '顺排') {
                            // 找下一个节气
                            if (timeDiff > 0 && timeDiff < minDiff) {
                                minDiff = timeDiff;
                                targetJieQi = jieQiDate;
                            }
                        } else {
                            // 找上一个节气
                            if (timeDiff < 0 && Math.abs(timeDiff) < minDiff) {
                                minDiff = Math.abs(timeDiff);
                                targetJieQi = jieQiDate;
                            }
                        }
                    }
                }
                
                if (targetJieQi) {
                    const diffMs = Math.abs(targetJieQi.getTime() - birthDate.getTime());
                    return diffMs / (1000 * 60 * 60 * 24); // 转换为天数
                }
                
                // 如果找不到合适的节气，返回默认值
                return 24;
                
            } catch (error) {
                console.error('获取节气时间错误:', error);
                return 24; // 默认值
            }
        }
        
        // 获取指定年份的节气时间
        function getJieQiTime(year, jieQiName) {
            try {
                const solar = Solar.fromYmd(year, 6, 1);
                const lunar = solar.getLunar();
                const jieQiTable = lunar.getJieQiTable();
                
                return jieQiTable[jieQiName] || null;
            } catch (error) {
                console.error(`获取${year}年${jieQiName}节气时间失败:`, error);
                return null;
            }
        }

        // 全局变量存储分数详情
        let fateScoreDetails = {};
        let wealthScoreDetails = {};
        let fateScoreValue = 0;
        let wealthScoreValue = 0;

        // 计算命格等级 - 专业版
        function calculateFateLevel(pillars) {
            const score = calculateFateScore(pillars);
            const levelInfo = getFateLevel(score);
            
            return {
                score: score,
                level: levelInfo.name,
                description: getFateDescription(score),
                details: fateScoreDetails
            };
        }

        // 计算命格分数
        function calculateFateScore(pillars) {
            if (fateScoreValue === 0) {
                // 确保输入是字符串
                const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
                const monthStr = typeof pillars.month === 'string' ? pillars.month : String(pillars.month);
                const yearStr = typeof pillars.year === 'string' ? pillars.year : String(pillars.year);
                const hourStr = typeof pillars.hour === 'string' ? pillars.hour : String(pillars.hour);
                
                // 使用安全的字符串方法
                const seasonScore = calculateSeasonScore(
                    dayStr.length > 0 ? dayStr.charAt(0) : '', 
                    monthStr.length > 1 ? monthStr.charAt(1) : ''
                );
                // 创建安全的pillars对象
                const safePillars = {
                    year: yearStr,
                    month: monthStr,
                    day: dayStr,
                    hour: hourStr
                };
                
                const balanceScore = calculateBalanceScore(safePillars);
                const patternScore = calculatePatternScore(safePillars);
                const godsScore = calculateGodsScore(safePillars);
                const combinationScore = calculateCombinationScore(safePillars);
                const total = seasonScore + balanceScore + patternScore + godsScore + combinationScore;
                fateScoreDetails = {
                    seasonScore,
                    balanceScore,
                    patternScore,
                    godsScore,
                    combinationScore,
                    total
                };
                fateScoreValue = Math.round(total);
            }
            return fateScoreValue;
        }

        // 计算季节分数
        function calculateSeasonScore(dayStem, monthBranch) {
            const seasonMap = {
                '甲': ['寅', '卯', '辰'],
                '乙': ['寅', '卯', '辰'],
                '丙': ['巳', '午', '未'],
                '丁': ['巳', '午', '未'],
                '戊': ['辰', '戌', '丑', '未'],
                '己': ['辰', '戌', '丑', '未'],
                '庚': ['申', '酉', '戌'],
                '辛': ['申', '酉', '戌'],
                '壬': ['亥', '子', '丑'],
                '癸': ['亥', '子', '丑']
            };
            if (seasonMap[dayStem] && seasonMap[dayStem].includes(monthBranch)) {
                return 30;
            }
            return 15;
        }

        // 计算平衡分数
        function calculateBalanceScore(pillars) {
            const elements = {
                '木': 0,
                '火': 0,
                '土': 0,
                '金': 0,
                '水': 0
            };
            const stemElements = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            const branchElements = {
                '寅': '木', '卯': '木',
                '午': '火', '巳': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
            elements[stemElements[pillars.year.charAt(0)]]++;
            elements[stemElements[pillars.month.charAt(0)]]++;
            elements[stemElements[pillars.day.charAt(0)]]++;
            elements[stemElements[pillars.hour.charAt(0)]]++;
            elements[branchElements[pillars.year.charAt(1)]]++;
            elements[branchElements[pillars.month.charAt(1)]]++;
            elements[branchElements[pillars.day.charAt(1)]]++;
            elements[branchElements[pillars.hour.charAt(1)]]++;
            const values = Object.values(elements);
            const max = Math.max(...values);
            const min = Math.min(...values);
            const balance = 25 - (max - min) * 2;
            return Math.max(0, balance);
        }

        // 计算格局分数
        function calculatePatternScore(pillars) {
            if (isCongGe(pillars)) {
                return 20;
            }
            if (isZhuanWangGe(pillars)) {
                return 15;
            }
            return 5;
        }

        // 判断从格
        function isCongGe(pillars) {
            const dayStem = pillars.day.charAt(0);
            const stems = [
                pillars.year.charAt(0),
                pillars.month.charAt(0),
                pillars.hour.charAt(0)
            ];
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            if (isCongQiangGe(dayStem, stems, branches)) {
                return true;
            }
            if (isCongRuoGe(dayStem, stems, branches)) {
                return true;
            }
            return false;
        }

        // 判断从强格
        function isCongQiangGe(dayStem, stems, branches) {
            let count = 0;
            stems.forEach(function(stem) {
                if (isSameElement(stem, dayStem) || isGenerateElement(stem, dayStem)) {
                    count++;
                }
            });
            branches.forEach(function(branch) {
                if (isSameElement(branch, dayStem) || isGenerateElement(branch, dayStem)) {
                    count++;
                }
            });
            return count >= 6;
        }

        // 判断从弱格
        function isCongRuoGe(dayStem, stems, branches) {
            let count = 0;
            stems.forEach(function(stem) {
                if (isSameElement(stem, dayStem) || isGenerateElement(stem, dayStem)) {
                    count++;
                }
            });
            branches.forEach(function(branch) {
                if (isSameElement(branch, dayStem) || isGenerateElement(branch, dayStem)) {
                    count++;
                }
            });
            return count <= 1;
        }

        // 判断专旺格
        function isZhuanWangGe(pillars) {
            const dayStem = pillars.day.charAt(0);
            const stems = [
                pillars.year.charAt(0),
                pillars.month.charAt(0),
                pillars.hour.charAt(0)
            ];
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            let sameCount = 0;
            let otherCount = 0;
            stems.forEach(function(stem) {
                if (isSameElement(stem, dayStem)) {
                    sameCount++;
                } else {
                    otherCount++;
                }
            });
            branches.forEach(function(branch) {
                if (isSameElement(branch, dayStem)) {
                    sameCount++;
                } else {
                    otherCount++;
                }
            });
            return sameCount >= 5 && otherCount <= 2;
        }

        // 判断相同元素
        function isSameElement(a, b) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '寅': '木', '卯': '木',
                '午': '火', '巳': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
            return elementMap[a] === elementMap[b];
        }

        // 判断生成元素
        function isGenerateElement(a, b) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '寅': '木', '卯': '木',
                '午': '火', '巳': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
            const aElement = elementMap[a];
            const bElement = elementMap[b];
            const generateMap = {
                '木': '火',
                '火': '土',
                '土': '金',
                '金': '水',
                '水': '木'
            };
            return generateMap[aElement] === bElement;
        }

        // 计算十神分数
        function calculateGodsScore(pillars) {
            return 10;
        }

        // 计算组合分数
        function calculateCombinationScore(pillars) {
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            if (hasSanHe(branches)) {
                return 8;
            }
            if (hasLiuHe(branches)) {
                return 5;
            }
            return 2;
        }

        // 判断三合
        function hasSanHe(branches) {
            const sanHeGroups = [
                ['申', '子', '辰'],
                ['亥', '卯', '未'],
                ['寅', '午', '戌'],
                ['巳', '酉', '丑']
            ];
            for (const group of sanHeGroups) {
                let count = 0;
                for (const branch of branches) {
                    if (group.includes(branch)) {
                        count++;
                    }
                }
                if (count >= 2) {
                    return true;
                }
            }
            return false;
        }

        // 判断六合
        function hasLiuHe(branches) {
            const liuHePairs = [
                ['子', '丑'],
                ['寅', '亥'],
                ['卯', '戌'],
                ['辰', '酉'],
                ['巳', '申'],
                ['午', '未']
            ];
            for (const pair of liuHePairs) {
                if (branches.includes(pair[0]) && branches.includes(pair[1])) {
                    return true;
                }
            }
            return false;
        }

        // 获取命运等级
        function getFateLevel(score) {
            if (score >= 85) return { name: "天赐鸿运 ★★★★★", class: "excellent" };
            if (score >= 70) return { name: "福星高照 ★★★★☆", class: "good" };
            if (score >= 50) return { name: "安常守分 ★★★☆☆", class: "average" };
            if (score >= 30) return { name: "勤能补拙 ★★☆☆☆", class: "struggling" };
            return { name: "逆水行舟 ★☆☆☆☆", class: "needs-improvement" };
        }

        // 获取命格描述
        function getFateDescription(score) {
            if (score >= 85) return '天赋异禀，福泽深厚，一生运势极佳';
            if (score >= 70) return '聪明才智，运势较佳，发展前景良好';
            if (score >= 50) return '资质良好，发展平稳，需要努力进取';
            if (score >= 30) return '普通命格，需要勤奋努力方能成功';
            return '命途坎坷，需要坚持不懈，逆境求生';
        }

        // 计算财富等级 - 专业版
        function calculateWealthLevel(pillars) {
            const score = calculateWealthScore(pillars);
            const levelInfo = getWealthLevel(score);
            
            return {
                score: score,
                level: levelInfo.name,
                description: getWealthDescription(score),
                details: wealthScoreDetails
            };
        }

        // 计算财富分数
        function calculateWealthScore(pillars) {
            if (wealthScoreValue === 0) {
                // 确保输入是字符串
                const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
                const monthStr = typeof pillars.month === 'string' ? pillars.month : String(pillars.month);
                const yearStr = typeof pillars.year === 'string' ? pillars.year : String(pillars.year);
                const hourStr = typeof pillars.hour === 'string' ? pillars.hour : String(pillars.hour);
                
                // 创建安全的pillars对象
                const safePillars = {
                    year: yearStr,
                    month: monthStr,
                    day: dayStr,
                    hour: hourStr
                };
                
                const wealthStarScore = calculateWealthStarScore(safePillars);
                const wealthPositionScore = calculateWealthPositionScore(safePillars);
                const wealthDamageScore = calculateWealthDamageScore(safePillars);
                const wealthSupportScore = calculateWealthSupportScore(safePillars);
                const fortuneScore = calculateFortuneScore(safePillars);
                const total = wealthStarScore + wealthPositionScore + (20 - wealthDamageScore) + wealthSupportScore + fortuneScore;
                wealthScoreDetails = {
                    wealthStarScore,
                    wealthPositionScore,
                    wealthDamageScore: 20 - wealthDamageScore,
                    wealthSupportScore,
                    fortuneScore,
                    total
                };
                wealthScoreValue = Math.round(total);
            }
            return wealthScoreValue;
        }

        // 计算财星分数
        function calculateWealthStarScore(pillars) {
            // 确保输入是字符串
            const dayStr = typeof pillars.day === 'string' ? pillars.day : String(pillars.day);
            const monthStr = typeof pillars.month === 'string' ? pillars.month : String(pillars.month);
            const yearStr = typeof pillars.year === 'string' ? pillars.year : String(pillars.year);
            const hourStr = typeof pillars.hour === 'string' ? pillars.hour : String(pillars.hour);
            
            const dayStem = dayStr.length > 0 ? dayStr.charAt(0) : '';
            let wealthCount = 0;
            const stems = [
                yearStr.length > 0 ? yearStr.charAt(0) : '',
                monthStr.length > 0 ? monthStr.charAt(0) : '',
                hourStr.length > 0 ? hourStr.charAt(0) : ''
            ];
            const branches = [
                yearStr.length > 1 ? yearStr.charAt(1) : '',
                monthStr.length > 1 ? monthStr.charAt(1) : '',
                dayStr.length > 1 ? dayStr.charAt(1) : '',
                hourStr.length > 1 ? hourStr.charAt(1) : ''
            ];
            const wealthStars = getWealthStars(dayStem);
            stems.forEach(function(stem) {
                if (wealthStars.includes(stem)) {
                    wealthCount++;
                }
            });
            branches.forEach(function(branch) {
                if (wealthStars.includes(branch)) {
                    wealthCount++;
                }
            });
            if (wealthCount >= 3) return 30;
            if (wealthCount === 2) return 20;
            if (wealthCount === 1) return 10;
            return 5;
        }

        // 获取财星
        function getWealthStars(dayStem) {
            const wealthMap = {
                '甲': ['戊', '己', '辰', '戌', '丑', '未'],
                '乙': ['戊', '己', '辰', '戌', '丑', '未'],
                '丙': ['庚', '辛', '申', '酉'],
                '丁': ['庚', '辛', '申', '酉'],
                '戊': ['壬', '癸', '子', '亥'],
                '己': ['壬', '癸', '子', '亥'],
                '庚': ['甲', '乙', '寅', '卯'],
                '辛': ['甲', '乙', '寅', '卯'],
                '壬': ['丙', '丁', '午', '巳'],
                '癸': ['丙', '丁', '午', '巳']
            };
            return wealthMap[dayStem] || [];
        }

        // 计算财位分数
        function calculateWealthPositionScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            const wealthStars = getWealthStars(dayStem);
            let score = 0;
            if (wealthStars.includes(pillars.month.charAt(1))) {
                score += 15;
            }
            if (wealthStars.includes(pillars.day.charAt(1))) {
                score += 5;
            }
            if (wealthStars.includes(pillars.hour.charAt(1))) {
                score += 5;
            }
            return Math.min(25, score);
        }

        // 计算财损分数
        function calculateWealthDamageScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            const wealthStars = getWealthStars(dayStem);
            let damageCount = 0;
            const stems = [
                pillars.year.charAt(0),
                pillars.month.charAt(0),
                pillars.hour.charAt(0)
            ];
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            const damageStars = getDamageStars(dayStem);
            stems.forEach(function(stem) {
                if (damageStars.includes(stem)) {
                    damageCount++;
                }
            });
            branches.forEach(function(branch) {
                if (damageStars.includes(branch)) {
                    damageCount++;
                }
            });
            return Math.min(20, damageCount * 5);
        }

        // 获取损星
        function getDamageStars(dayStem) {
            const damageMap = {
                '甲': ['甲', '乙', '寅', '卯'],
                '乙': ['甲', '乙', '寅', '卯'],
                '丙': ['丙', '丁', '午', '巳'],
                '丁': ['丙', '丁', '午', '巳'],
                '戊': ['戊', '己', '辰', '戌', '丑', '未'],
                '己': ['戊', '己', '辰', '戌', '丑', '未'],
                '庚': ['庚', '辛', '申', '酉'],
                '辛': ['庚', '辛', '申', '酉'],
                '壬': ['壬', '癸', '子', '亥'],
                '癸': ['壬', '癸', '子', '亥']
            };
            return damageMap[dayStem] || [];
        }

        // 计算财助分数
        function calculateWealthSupportScore(pillars) {
            const dayStem = pillars.day.charAt(0);
            const wealthStars = getWealthStars(dayStem);
            const generateStars = getGenerateStars(dayStem);
            let supportCount = 0;
            const stems = [
                pillars.year.charAt(0),
                pillars.month.charAt(0),
                pillars.hour.charAt(0)
            ];
            const branches = [
                pillars.year.charAt(1),
                pillars.month.charAt(1),
                pillars.day.charAt(1),
                pillars.hour.charAt(1)
            ];
            stems.forEach(function(stem) {
                if (generateStars.includes(stem)) {
                    supportCount++;
                }
            });
            branches.forEach(function(branch) {
                if (generateStars.includes(branch)) {
                    supportCount++;
                }
            });
            if (supportCount >= 2) return 15;
            if (supportCount === 1) return 8;
            return 3;
        }

        // 获取生星
        function getGenerateStars(dayStem) {
            const generateMap = {
                '甲': ['丙', '丁', '午', '巳'],
                '乙': ['丙', '丁', '午', '巳'],
                '丙': ['戊', '己', '辰', '戌', '丑', '未'],
                '丁': ['戊', '己', '辰', '戌', '丑', '未'],
                '戊': ['庚', '辛', '申', '酉'],
                '己': ['庚', '辛', '申', '酉'],
                '庚': ['壬', '癸', '子', '亥'],
                '辛': ['壬', '癸', '子', '亥'],
                '壬': ['甲', '乙', '寅', '卯'],
                '癸': ['甲', '乙', '寅', '卯']
            };
            return generateMap[dayStem] || [];
        }

        // 计算运势分数
        function calculateFortuneScore(pillars) {
            return 5;
        }

        // 获取财富等级
        function getWealthLevel(score) {
            if (score >= 90) return { name: "天禄盈门 ★★★★★", class: "ultra-rich" };
            if (score >= 80) return { name: "朱紫满箱 ★★★★☆", class: "very-rich" };
            if (score >= 60) return { name: "粟陈贯朽 ★★★☆☆", class: "moderately-rich" };
            if (score >= 40) return { name: "岁稔年丰 ★★☆☆☆", class: "somewhat-rich" };
            return { name: "营营逐逐 ★☆☆☆☆", class: "wealth-average" };
        }

        // 获取财富描述
        function getWealthDescription(score) {
            if (score >= 90) return '财运亨通，富贵双全，一生财富丰厚';
            if (score >= 80) return '财运不错，生活富足，财富稳步增长';
            if (score >= 60) return '财运平平，温饱无忧，需要努力积累';
            if (score >= 40) return '财运较弱，需要勤俭持家，谨慎理财';
            return '财运偏弱，需要特别努力，量入为出';
        }

        // 显示结果
        function displayResults(baziData) {
            displayBasicInfo(baziData);
            displayBaziChart(baziData);
            displayElementsChart(baziData);
            displayStrengthChart(baziData);
            displayLuckTiming(baziData);
            displayFateLevel(baziData);
            displayWealthLevel(baziData);
        }

        // 显示基本信息
        function displayBasicInfo(baziData) {
            const userInfoTitle = document.getElementById('user-info-title');
            const basicInfoContent = document.getElementById('basic-info-content');
            
            userInfoTitle.textContent = `${baziData.name} - ${baziData.gender === 'male' ? '男' : '女'}`;
            
            const solarDate = baziData.solar.toYmd();
            const lunarDate = baziData.lunar.toString();
            
            basicInfoContent.innerHTML = `
                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="info-item">
                        <strong>阳历：</strong>${solarDate}
                    </div>
                    <div class="info-item">
                        <strong>农历：</strong>${lunarDate}
                    </div>
                    <div class="info-item">
                        <strong>性别：</strong>${baziData.gender === 'male' ? '男' : '女'}
                    </div>
                    <div class="info-item">
                        <strong>时辰：</strong>${baziData.birthTime}
                    </div>
                </div>
            `;
        }

        // 显示八字排盘
        function displayBaziChart(baziData) {
            const baziChart = document.getElementById('bazi-chart');
            const { pillars, hiddenStems } = baziData;
            const dayStem = pillars.day[0]; // 日主天干
            
            // 五行颜色映射
            const elementColors = {
                '木': '#27ae60', // 绿色
                '火': '#e74c3c', // 红色
                '土': '#f39c12', // 黄色
                '金': '#95a5a6', // 银色
                '水': '#3498db'  // 蓝色
            };
            
            // 天干地支五行映射
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '寅': '木', '卯': '木',
                '巳': '火', '午': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '子': '水', '亥': '水'
            };
            
            // 十神计算函数
            function getTenGod(dayStem, target) {
                const ganList = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
                
                // 如果是地支，获取其主气天干
                if (!ganList.includes(target)) {
                    const mainQiMap = {
                        '子': '癸', '丑': '己', '寅': '甲', '卯': '乙',
                        '辰': '戊', '巳': '丙', '午': '丁', '未': '己',
                        '申': '庚', '酉': '辛', '戌': '戊', '亥': '壬'
                    };
                    target = mainQiMap[target];
                    if (!target) return '未知';
                }
                
                const dayIndex = ganList.indexOf(dayStem);
                const targetIndex = ganList.indexOf(target);
                
                if (dayIndex === -1 || targetIndex === -1) return '未知';
                
                const diff = (targetIndex - dayIndex + 10) % 10;
                
                // 十神顺序
                const tenGods = [
                    '比肩', '劫财', '食神', '伤官', 
                    '偏财', '正财', '七杀', '正官', 
                    '偏印', '正印'
                ];
                
                return tenGods[diff] || '未知';
            }
            
            // 生成带颜色和十神的天干
                function coloredStem(stem, isDay = false) {
                    const element = elementMap[stem] || '';
                    const color = elementColors[element] || '#000';
                    const tenGod = isDay ? '' : getTenGod(dayStem, stem);
                    const tenGodText = isDay ? '' : `<small style="display:block;font-size:0.5em;color:#666;margin-top:3px;text-align:center;">${tenGod}</small>`;
                    const bgColor = isDay ? `background:linear-gradient(135deg, rgba(${getElementRGB(element)}, 0.15), rgba(${getElementRGB(element)}, 0.05));` : '';
                    return `<div style="display:inline-block;${bgColor}border-radius:8px;padding:5px 10px;">
                        <span style="color:${color};font-weight:bold;font-size:1.8em;font-family:'SimHei','黑体',sans-serif;text-shadow:0 1px 2px rgba(0,0,0,0.1);">${stem}</span>
                        ${tenGodText}
                    </div>`;
                }
                
                // 生成带颜色和十神的地支
                function coloredBranch(branch) {
                    const element = elementMap[branch] || '';
                    const color = elementColors[element] || '#000';
                    const tenGod = getTenGod(dayStem, branch);
                    return `<div style="display:inline-block;border-radius:8px;padding:5px 10px;">
                        <span style="color:${color};font-weight:bold;font-size:1.8em;font-family:'SimHei','黑体',sans-serif;text-shadow:0 1px 2px rgba(0,0,0,0.1);">${branch}</span>
                        <small style="display:block;font-size:0.5em;color:#666;margin-top:3px;text-align:center;">${tenGod}</small>
                    </div>`;
                }
                
                // 生成带颜色和十神的藏干
                function coloredHiddenStems(stems) {
                    return stems.map((stem, index) => {
                        const element = elementMap[stem] || '';
                        const color = elementColors[element] || '#000';
                        const tenGod = getTenGod(dayStem, stem);
                        return `<div style="display:inline-block;margin:0 2px;border-radius:6px;padding:3px 6px;background:rgba(${getElementRGB(element)}, 0.05);">
                            <span style="color:${color};font-size:1.3em;font-family:'SimHei','黑体',sans-serif;text-shadow:0 1px 1px rgba(0,0,0,0.05);">${stem}</span>
                            <small style="display:block;font-size:0.5em;color:#666;margin-top:2px;text-align:center;">${tenGod}</small>
                        </div>`;
                    }).join('');
                }
                
                // 获取五行对应的RGB值
                function getElementRGB(element) {
                    switch(element) {
                        case '木': return '39, 174, 96'; // 绿色
                        case '火': return '231, 76, 60'; // 红色
                        case '土': return '243, 156, 18'; // 黄色
                        case '金': return '149, 165, 166'; // 银色
                        case '水': return '52, 152, 219'; // 蓝色
                        default: return '0, 0, 0';
                    }
                }
            
            baziChart.innerHTML = `
                <table class="bazi-table">
                    <thead>
                        <tr>
                            <th>四柱</th>
                            <th class="pillar-header">年柱</th>
                            <th class="pillar-header">月柱</th>
                            <th class="pillar-header">日柱</th>
                            <th class="pillar-header">时柱</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>天干</strong></td>
                            <td class="stem">${coloredStem(pillars.year[0])}</td>
                            <td class="stem">${coloredStem(pillars.month[0])}</td>
                            <td class="stem">${coloredStem(pillars.day[0], true)}</td>
                            <td class="stem">${coloredStem(pillars.hour[0])}</td>
                        </tr>
                        <tr>
                            <td><strong>地支</strong></td>
                            <td class="branch">${coloredBranch(pillars.year[1])}</td>
                            <td class="branch">${coloredBranch(pillars.month[1])}</td>
                            <td class="branch">${coloredBranch(pillars.day[1])}</td>
                            <td class="branch">${coloredBranch(pillars.hour[1])}</td>
                        </tr>
                        <tr>
                            <td><strong>藏干</strong></td>
                            <td>${coloredHiddenStems(hiddenStems.year)}</td>
                            <td>${coloredHiddenStems(hiddenStems.month)}</td>
                            <td>${coloredHiddenStems(hiddenStems.day)}</td>
                            <td>${coloredHiddenStems(hiddenStems.hour)}</td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7)); border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); backdrop-filter: blur(5px);">
                    <div style="display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center;">
                        <div style="flex: 1; min-width: 200px; padding: 10px; text-align: center; border-right: 1px solid rgba(233, 236, 239, 0.5);">
                            <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 5px;">年命纳音</div>
                            <div style="font-size: 1.3em; font-weight: 600; color: #2c3e50;">${baziData.lunar.getYearNaYin()}</div>
                        </div>
                        <div style="flex: 1; min-width: 200px; padding: 10px; text-align: center;">
                            <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 5px;">日主</div>
                            <div style="font-size: 1.3em; font-weight: 600;">
                                <span style="display: inline-block; padding: 5px 15px; border-radius: 20px; background: linear-gradient(135deg, rgba(${getElementRGB(elementMap[pillars.day[0]])}, 0.2), rgba(${getElementRGB(elementMap[pillars.day[0]])}, 0.05)); color: ${elementColors[elementMap[pillars.day[0]]] || '#000'}; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">
                                    ${pillars.day[0]}${getElementName(pillars.day[0])}命
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 获取五行名称
        function getElementName(stem) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            return elementMap[stem] || '';
        }

        // 显示五行图表
        function displayElementsChart(baziData) {
            const ctx = document.getElementById('elements-chart').getContext('2d');
            const elements = baziData.elements;
            
            if (elementsChart) {
                elementsChart.destroy();
            }
            
            // 增强的五行颜色 - 更专业的配色方案
            const elementColors = {
                wood: {
                    main: '#2ecc71',
                    light: 'rgba(46, 204, 113, 0.8)',
                    border: 'rgba(46, 204, 113, 1)',
                    gradient: ['rgba(46, 204, 113, 0.9)', 'rgba(39, 174, 96, 0.9)']
                },
                fire: {
                    main: '#e74c3c',
                    light: 'rgba(231, 76, 60, 0.8)',
                    border: 'rgba(231, 76, 60, 1)',
                    gradient: ['rgba(231, 76, 60, 0.9)', 'rgba(192, 57, 43, 0.9)']
                },
                earth: {
                    main: '#f39c12',
                    light: 'rgba(243, 156, 18, 0.8)',
                    border: 'rgba(243, 156, 18, 1)',
                    gradient: ['rgba(243, 156, 18, 0.9)', 'rgba(211, 84, 0, 0.9)']
                },
                metal: {
                    main: '#95a5a6',
                    light: 'rgba(149, 165, 166, 0.8)',
                    border: 'rgba(149, 165, 166, 1)',
                    gradient: ['rgba(149, 165, 166, 0.9)', 'rgba(127, 140, 141, 0.9)']
                },
                water: {
                    main: '#3498db',
                    light: 'rgba(52, 152, 219, 0.8)',
                    border: 'rgba(52, 152, 219, 1)',
                    gradient: ['rgba(52, 152, 219, 0.9)', 'rgba(41, 128, 185, 0.9)']
                }
            };
            
            // 注册Chart.js插件
            Chart.register(ChartDataLabels);
            
            // 计算总分
            const total = Object.values(elements).reduce((sum, val) => sum + val, 0);
            
            // 创建渐变背景
            const createGradient = (ctx, colors) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, colors[0]);
                gradient.addColorStop(1, colors[1]);
                return gradient;
            };
            
            // 创建增强的环形图
            elementsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['木', '火', '土', '金', '水'],
                    datasets: [{
                        data: [elements.wood, elements.fire, elements.earth, elements.metal, elements.water],
                        backgroundColor: [
                            createGradient(ctx, elementColors.wood.gradient),
                            createGradient(ctx, elementColors.fire.gradient),
                            createGradient(ctx, elementColors.earth.gradient),
                            createGradient(ctx, elementColors.metal.gradient),
                            createGradient(ctx, elementColors.water.gradient)
                        ],
                        borderColor: [
                            elementColors.wood.border,
                            elementColors.fire.border,
                            elementColors.earth.border,
                            elementColors.metal.border,
                            elementColors.water.border
                        ],
                        borderWidth: 2,
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%', // 稍微减小中心孔，使图表更加突出
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: "'Noto Serif SC', serif"
                                },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#333',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            cornerRadius: 10,
                            padding: 15,
                            boxPadding: 8,
                            usePointStyle: true,
                            titleFont: {
                                size: 16,
                                weight: 'bold',
                                family: "'Noto Serif SC', serif"
                            },
                            bodyFont: {
                                size: 14,
                                family: "'Noto Serif SC', serif"
                            },
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed}点 (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            textShadow: '0 1px 2px rgba(0,0,0,0.2)',
                            font: {
                                weight: 'bold',
                                size: 16,
                                family: "'Noto Serif SC', serif"
                            },
                            formatter: (value, ctx) => {
                                const percentage = ((value / total) * 100).toFixed(0);
                                return percentage > 5 ? `${percentage}%` : '';
                            },
                            anchor: 'center',
                            align: 'center',
                            offset: 0,
                            borderWidth: 2,
                            borderRadius: 4,
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor[context.dataIndex];
                            },
                            opacity: 0.9
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // 显示增强的五行分析描述
            const description = document.getElementById('elements-description');
            const summary = document.getElementById('elements-summary');
            const strongest = Object.keys(elements).reduce((a, b) => elements[a] > elements[b] ? a : b);
            const weakest = Object.keys(elements).reduce((a, b) => elements[a] < elements[b] ? a : b);
            
            const elementNames = {
                wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
            };
            
            // 增强的五行特性
            const elementProperties = {
                wood: {
                    nature: '生长、向上、扩展',
                    character: '仁爱、正直、进取、创新、灵活、善变',
                    career: '教育、文化、艺术、法律、环保、植物相关行业、创意设计、新兴产业',
                    health: '肝胆系统、眼睛、肌腱、神经、头部',
                    favorable: '东方、绿色环境、春季、清晨',
                    icon: 'fa-tree',
                    personality: '思维活跃，创新能力强，善于规划，有远见，但可能缺乏耐心，情绪波动较大',
                    career_detail: '适合需要创造力和变革的工作，不适合固定模式的工作',
                    health_advice: '注意情绪管理，避免过度紧张和压力，保持规律作息，多做舒缓运动'
                },
                fire: {
                    nature: '上升、扩张、热烈',
                    character: '热情、活力、直觉、表达力强、乐观、冲动',
                    career: '娱乐、餐饮、照明、能源、传媒、营销、表演、公关',
                    health: '心脏、血液循环、眼睛、面部、小肠',
                    favorable: '南方、阳光充足环境、夏季、中午',
                    icon: 'fa-fire',
                    personality: '热情洋溢，富有感染力，直觉敏锐，善于表达，但可能冲动，缺乏耐心',
                    career_detail: '适合需要热情和表现力的工作，不适合需要冷静分析的工作',
                    health_advice: '注意心脏健康，避免情绪过度激动，保持充足睡眠，适当控制饮食'
                },
                earth: {
                    nature: '稳定、中和、包容',
                    character: '踏实、稳重、包容、忠诚、保守、固执',
                    career: '房地产、农业、食品、保险、服务业、医疗、教育、行政管理',
                    health: '脾胃、消化系统、肌肉、口腔',
                    favorable: '中央位置、黄色环境、季节交替时期、下午',
                    icon: 'fa-mountain',
                    personality: '稳重踏实，责任感强，忠诚可靠，但可能固执，缺乏变通',
                    career_detail: '适合需要耐心和稳定的工作，不适合需要频繁变动的工作',
                    health_advice: '注意消化系统健康，保持规律饮食，避免过度思虑，适当运动'
                },
                metal: {
                    nature: '收敛、向内、坚硬',
                    character: '果断、公正、条理、自律、理性、刚毅',
                    career: '金融、IT、机械、汽车、珠宝、军警、法律、精密工业',
                    health: '肺部、大肠、皮肤、鼻子、呼吸系统',
                    favorable: '西方、白色环境、秋季、傍晚',
                    icon: 'fa-coins',
                    personality: '条理分明，做事果断，公正严明，但可能过于刚硬，缺乏柔性',
                    career_detail: '适合需要精确和规范的工作，不适合需要灵活变通的工作',
                    health_advice: '注意呼吸系统健康，保持环境清洁，避免过度压抑情绪，适当放松'
                },
                water: {
                    nature: '向下、流动、适应',
                    character: '智慧、灵活、交际、适应力强、深沉、多变',
                    career: '贸易、运输、旅游、水产、外交、销售、咨询、信息传播',
                    health: '肾脏、膀胱、耳朵、骨骼、生殖系统',
                    favorable: '北方、水域环境、冬季、夜晚',
                    icon: 'fa-water',
                    personality: '思维灵活，适应力强，善于沟通，但可能多虑，缺乏决断',
                    career_detail: '适合需要交流和变通的工作，不适合固定模式的工作',
                    health_advice: '注意肾脏健康，保持充足睡眠，避免过度疲劳，保持水分摄入'
                }
            };
            
            // 计算五行平衡度
            const avg = total / 5;
            const deviation = Object.values(elements).reduce((sum, val) => sum + Math.abs(val - avg), 0) / total;
            const balancePercentage = (1 - deviation) * 100;
            let balanceLevel;
            if (balancePercentage >= 85) balanceLevel = '极佳';
            else if (balancePercentage >= 70) balanceLevel = '良好';
            else if (balancePercentage >= 50) balanceLevel = '一般';
            else balanceLevel = '失衡';
            
            // 获取第二强和第二弱的五行
            const sortedElements = Object.entries(elements).sort((a, b) => b[1] - a[1]);
            const secondStrongest = sortedElements[1][0];
            const secondWeakest = sortedElements[3][0];
            
            // 显示五行分布概览（放在图表下方）
            summary.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(240,240,240,0.7)); padding: 15px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: 12px;">
                        <div style="min-width: 120px; margin-bottom: 8px;">
                            <span style="font-weight: bold; color: ${elementColors[strongest].main};">最强五行：</span>
                            <span style="background: linear-gradient(135deg, ${elementColors[strongest].gradient[0]}, ${elementColors[strongest].gradient[1]}); padding: 3px 10px; border-radius: 20px; color: #fff; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ${elementNames[strongest]} (${((elements[strongest]/total)*100).toFixed(1)}%)
                            </span>
                        </div>
                        <div style="min-width: 120px; margin-bottom: 8px;">
                            <span style="font-weight: bold; color: ${elementColors[weakest].main};">最弱五行：</span>
                            <span style="background: linear-gradient(135deg, ${elementColors[weakest].gradient[0]}, ${elementColors[weakest].gradient[1]}); padding: 3px 10px; border-radius: 20px; color: #fff; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ${elementNames[weakest]} (${((elements[weakest]/total)*100).toFixed(1)}%)
                            </span>
                        </div>
                        <div style="min-width: 120px; margin-bottom: 8px;">
                            <span style="font-weight: bold; color: #2c3e50;">平衡度：</span>
                            <span style="background: linear-gradient(135deg, ${balanceLevel === '极佳' ? 'rgba(39, 174, 96, 0.9), rgba(46, 204, 113, 0.9)' : balanceLevel === '良好' ? 'rgba(46, 204, 113, 0.9), rgba(39, 174, 96, 0.9)' : balanceLevel === '一般' ? 'rgba(243, 156, 18, 0.9), rgba(230, 126, 34, 0.9)' : 'rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9)'}); padding: 3px 10px; border-radius: 20px; color: #fff; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ${balanceLevel} (${balancePercentage.toFixed(0)}%)
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <p style="margin: 0; line-height: 1.6; font-size: 0.95rem;">
                            <strong>五行分布：</strong><br>
                            <span style="display: inline-block; margin: 5px 5px 5px 0; padding: 4px 10px; background-color: ${elementColors.wood.light}; color: white; border-radius: 15px; font-weight: bold;">木 ${elements.wood}点 (${((elements.wood/total)*100).toFixed(1)}%)</span>
                            <span style="display: inline-block; margin: 5px 5px 5px 0; padding: 4px 10px; background-color: ${elementColors.fire.light}; color: white; border-radius: 15px; font-weight: bold;">火 ${elements.fire}点 (${((elements.fire/total)*100).toFixed(1)}%)</span>
                            <span style="display: inline-block; margin: 5px 5px 5px 0; padding: 4px 10px; background-color: ${elementColors.earth.light}; color: white; border-radius: 15px; font-weight: bold;">土 ${elements.earth}点 (${((elements.earth/total)*100).toFixed(1)}%)</span>
                            <span style="display: inline-block; margin: 5px 5px 5px 0; padding: 4px 10px; background-color: ${elementColors.metal.light}; color: white; border-radius: 15px; font-weight: bold;">金 ${elements.metal}点 (${((elements.metal/total)*100).toFixed(1)}%)</span>
                            <span style="display: inline-block; margin: 5px 5px 5px 0; padding: 4px 10px; background-color: ${elementColors.water.light}; color: white; border-radius: 15px; font-weight: bold;">水 ${elements.water}点 (${((elements.water/total)*100).toFixed(1)}%)</span>
                        </p>
                    </div>
                </div>
            `;
            
            // 显示五行分析描述
            description.innerHTML = `
                <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2rem; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
                    <i class="fas fa-chart-bar"></i> 五行分析
                </h4>
                
                <div style="margin-bottom: 18px;">
                    <h5 style="color: ${elementColors[strongest].main}; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center;">
                        <i class="fas ${elementProperties[strongest].icon}" style="margin-right: 8px;"></i> ${elementNames[strongest]}的特性与影响
                    </h5>
                    <div style="background: linear-gradient(135deg, rgba(${strongest === 'wood' ? '46, 204, 113, 0.15' : strongest === 'fire' ? '231, 76, 60, 0.15' : strongest === 'earth' ? '243, 156, 18, 0.15' : strongest === 'metal' ? '149, 165, 166, 0.15' : '52, 152, 219, 0.15'}, 1), rgba(${strongest === 'wood' ? '46, 204, 113, 0.05' : strongest === 'fire' ? '231, 76, 60, 0.05' : strongest === 'earth' ? '243, 156, 18, 0.05' : strongest === 'metal' ? '149, 165, 166, 0.05' : '52, 152, 219, 0.05'}, 1)); padding: 15px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-left: 4px solid ${elementColors[strongest].main};">
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>性质：</strong>${elementProperties[strongest].nature}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>性格特点：</strong>${elementProperties[strongest].character}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>性格分析：</strong>${elementProperties[strongest].personality}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>事业方向：</strong>${elementProperties[strongest].career}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>事业特点：</strong>${elementProperties[strongest].career_detail}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>健康关注：</strong>${elementProperties[strongest].health}</p>
                        <p style="margin: 0 0 8px 0; font-size: 0.95rem;"><strong>健康建议：</strong>${elementProperties[strongest].health_advice}</p>
                        <p style="margin: 0; font-size: 0.95rem;"><strong>有利环境：</strong>${elementProperties[strongest].favorable}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 18px;">
                    <h5 style="color: #2c3e50; font-size: 1.1rem; margin-bottom: 10px; display: flex; align-items: center;">
                        <i class="fas fa-balance-scale" style="margin-right: 8px;"></i> 五行平衡建议
                    </h5>
                    <div style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(52, 152, 219, 0.05)); padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-left: 4px solid #3498db;">
                        <p style="margin: 0 0 10px 0; font-size: 0.95rem;">${getFiveElementsAdvice(strongest, weakest)}</p>
                        <p style="margin: 0 0 10px 0; font-size: 0.95rem;"><strong>五行组合特点：</strong>
                            ${strongest}${secondStrongest !== strongest ? `和${secondStrongest}` : ''}较强，表现为${elementProperties[strongest].character.split('、')[0]}${secondStrongest !== strongest ? `和${elementProperties[secondStrongest].character.split('、')[0]}` : ''}的特质突出。
                            ${weakest === strongest ? '' : `${weakest}较弱，可能缺乏${elementProperties[weakest].character.split('、')[0]}的特质。`}
                        </p>
                        <p style="margin: 0; font-size: 0.95rem;"><strong>补充${elementNames[weakest]}的方法：</strong>
                            ${weakest === 'wood' ? '多接触绿色植物，在东方位置活动，春季出行，佩戴绿色饰品，多吃绿色蔬菜' : 
                              weakest === 'fire' ? '增加红色装饰，在南方位置活动，夏季出行，佩戴红色饰品，适当晒太阳' : 
                              weakest === 'earth' ? '使用黄色、棕色物品，在中央位置活动，季节交替时多出门，多吃黄色食物' : 
                              weakest === 'metal' ? '佩戴金属饰品，在西方位置活动，秋季出行，使用白色物品，保持环境整洁' : 
                              '多喝水，在北方位置活动，冬季出行，使用蓝色或黑色物品，接触水域环境'}
                        </p>
                    </div>
                </div>
                

            `;
        }

        // 获取五行建议
        function getFiveElementsAdvice(strongest, weakest) {
            const adviceMap = {
                wood: '宜从事与木相关的行业，如林业、园艺、文教等',
                fire: '宜从事与火相关的行业，如能源、餐饮、娱乐等',
                earth: '宜从事与土相关的行业，如房地产、农业、建筑等',
                metal: '宜从事与金相关的行业，如金融、机械、汽车等',
                water: '宜从事与水相关的行业，如航运、水利、贸易等'
            };
            
            return `五行${strongest === 'wood' ? '木' : strongest === 'fire' ? '火' : strongest === 'earth' ? '土' : strongest === 'metal' ? '金' : '水'}最强，${adviceMap[strongest]}。需要补充${weakest === 'wood' ? '木' : weakest === 'fire' ? '火' : weakest === 'earth' ? '土' : weakest === 'metal' ? '金' : '水'}元素。`;
        }

        // 显示身强身弱图表
        function displayStrengthChart(baziData) {
            console.log('显示身强身弱分析，数据:', baziData.strengthAnalysis);
            
            // 使用window.combinedInfo获取最新的合化信息
            if (window.combinedInfo) {
                console.log('从window.combinedInfo获取合化信息:', window.combinedInfo);
                baziData.strengthAnalysis.combined = window.combinedInfo;
            } else {
                console.log('合化信息:', baziData.strengthAnalysis.combined);
            }
            
            // 打印完整的strengthAnalysis对象，用于调试
            console.log('完整的strengthAnalysis对象:', JSON.stringify(baziData.strengthAnalysis, null, 2));
            
            // 检查八字中是否有巳酉丑三合金局
            const branches = window.allBranches || [];
            console.log('当前八字地支:', branches);
            
            // 特别检查巳酉丑三合金局
            const metalCombo = '巳酉丑';
            const metalMatches = [];
            let metalMatchCount = 0;
            
            for (const char of metalCombo) {
                if (branches.includes(char)) {
                    metalMatchCount++;
                    metalMatches.push(char);
                }
            }
            
            console.log(`特别检查巳酉丑三合金局:`, metalMatches, metalMatchCount);
            
            if (baziData.strengthAnalysis.combined && baziData.strengthAnalysis.combined.sanhe) {
                console.log('三合局详情:', baziData.strengthAnalysis.combined.sanhe);
            } else {
                console.log('没有检测到三合局');
                
                // 如果系统没有检测到三合局，但实际上有巳酉丑三合金局
                if (metalMatchCount >= 2) {
                    console.log('手动检测到巳酉丑三合金局:', metalMatches.join(''));
                    
                    // 手动添加三合局信息
                    if (!baziData.strengthAnalysis.combined) {
                        baziData.strengthAnalysis.combined = {};
                    }
                    
                    baziData.strengthAnalysis.combined.sanhe = {
                        type: '巳酉丑',
                        element: 'metal',
                        count: metalMatchCount,
                        branches: metalMatches.join(''),
                        isFullSanhe: metalMatchCount === 3
                    };
                    
                    // 移除特殊处理，使用统一effect
                }
            }
            
            const ctx = document.getElementById('strength-chart').getContext('2d');
            const strengthAnalysis = baziData.strengthAnalysis;
            
            if (strengthChart) {
                strengthChart.destroy();
            }
            
            strengthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['生扶力量', '克泄力量'],
                    datasets: [{
                        label: '力量对比',
                        data: [strengthAnalysis.supportStrength, strengthAnalysis.weakenStrength],
                        backgroundColor: [
                            '#27ae60', // 生扶 - 绿色
                            '#e74c3c'  // 克泄 - 红色
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                     return `${context.label}: ${context.parsed.y}点`;
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             title: {
                                 display: true,
                                 text: '力量值'
                             }
                         }
                     }
                 }
             });
             
             // 显示身强身弱分析描述
             const description = document.getElementById('strength-description');
             
             // 根据不同类型设置不同的图标和颜色
             let typeIcon, typeColor;
             switch(strengthAnalysis.type) {
                 case '身强':
                     typeIcon = 'fa-fire';
                     typeColor = '#e74c3c';
                     break;
                 case '身弱':
                     typeIcon = 'fa-snowflake';
                     typeColor = '#3498db';
                     break;
                 case '均衡':
                     typeIcon = 'fa-balance-scale';
                     typeColor = '#f39c12';
                     break;
                 case '从强':
                     typeIcon = 'fa-arrow-up';
                     typeColor = '#9b59b6';
                     break;
                 case '从弱':
                     typeIcon = 'fa-arrow-down';
                     typeColor = '#2ecc71';
                     break;
                 default:
                     typeIcon = 'fa-balance-scale';
                     typeColor = '#7f8c8d';
             }
             
             description.innerHTML = `
                 <h4><i class="fas fa-balance-scale"></i> 身强身弱分析</h4>
                 <div style="display: flex; align-items: center; margin-bottom: 10px;">
                     <div style="background-color: ${typeColor}; color: white; padding: 5px 10px; border-radius: 5px; margin-right: 10px;">
                         <i class="fas ${typeIcon}"></i> ${strengthAnalysis.type}
                     </div>
                     <div>力量比例: ${(strengthAnalysis.ratio * 100).toFixed(1)}%</div>
                 </div>
                 <p><strong>生扶力量:</strong> ${strengthAnalysis.supportStrength.toFixed(1)}点</p>
                 <p><strong>克泄力量:</strong> ${strengthAnalysis.weakenStrength.toFixed(1)}点</p>
                 ${strengthAnalysis.monthScore ? `<p><strong>月令得分:</strong> ${strengthAnalysis.monthScore}点</p>` : ''}
                 ${strengthAnalysis.combined && strengthAnalysis.combined.effect ? `<p><strong>合化影响:</strong> ${strengthAnalysis.combined.effect === 'strengthen' ? '增强日主' : '削弱日主'}</p>` : ''}
                 ${strengthAnalysis.combined && strengthAnalysis.combined.deduction ? `<p><strong>合化扣分:</strong> <span style="color: #e74c3c; font-weight: bold;">${strengthAnalysis.combined.deduction}点</span></p>` : ''}
                 <div class="hehua-info">
                 ${strengthAnalysis.combined && (strengthAnalysis.combined.tianGanWuHe.length > 0 || strengthAnalysis.combined.diZhiLiuHe.length > 0 || strengthAnalysis.combined.diZhiSanHe.length > 0) ? 
                    `<div style="background-color: #e8f4fc; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #3498db; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <h5 style="color: #3498db; margin-top: 0; font-size: 16px;"><i class="fas fa-link"></i> 合化信息</h5>
                        ${strengthAnalysis.combined.tianGanWuHe.length > 0 ? 
                            `<div style="margin-bottom: 10px;">
                                <p><strong>天干五合:</strong> ${strengthAnalysis.combined.tianGanWuHe.map(h => `${h.gan1}${h.gan2}合${h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水'}`).join('、')}</p>
                            </div>` : ''}
                        ${strengthAnalysis.combined.diZhiLiuHe.length > 0 ? 
                            `<div style="margin-bottom: 10px;">
                                <p><strong>地支六合:</strong> ${strengthAnalysis.combined.diZhiLiuHe.map(h => `${h.zhi1}${h.zhi2}合${h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水'}`).join('、')}</p>
                            </div>` : ''}
                        ${strengthAnalysis.combined.diZhiSanHe.length > 0 ? 
                            `<div style="margin-bottom: 10px;">
                                <p><strong>地支三合:</strong> ${strengthAnalysis.combined.diZhiSanHe.map(h => `${h.type}三合${h.element === 'wood' ? '木' : h.element === 'fire' ? '火' : h.element === 'earth' ? '土' : h.element === 'metal' ? '金' : '水'}(${h.count === 3 ? '全三合' : '半三合'})`).join('、')}</p>
                            </div>` : ''}
                        <p><strong>对日主影响:</strong> <span style="color: ${strengthAnalysis.combined.effect === 'strengthen' ? '#27ae60' : strengthAnalysis.combined.effect === 'weaken' ? '#e74c3c' : '#7f8c8d'}; font-weight: bold;">${strengthAnalysis.combined.effect === 'strengthen' ? '增强日主' : strengthAnalysis.combined.effect === 'weaken' ? '削弱日主' : '影响中性'}</span></p>
                        ${strengthAnalysis.combined.deduction ? `<p><strong>力量扣减:</strong> <span style="color: #e74c3c; font-weight: bold;">${strengthAnalysis.combined.deduction}点</span> (合化影响)</p>` : ''}
                    </div>` : `<div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px dashed #ccc;">
                        <p style="color: #7f8c8d; margin: 0;"><i class="fas fa-info-circle"></i> 未检测到合化</p>
                    </div>`}
                 </div>
                 <p><strong>分析说明:</strong> ${strengthAnalysis.description}</p>
             `;
             
             // 调整图表容器和描述容器的样式，确保左右并排显示
             const strengthAnalysisFrame = document.querySelector('.strength-analysis-frame');
             const chartContainer = document.querySelector('.chart-container');
             const descriptionContainer = document.getElementById('strength-description');
             
             if (strengthAnalysisFrame && chartContainer && descriptionContainer) {
                 // 确保左右并排显示
                 strengthAnalysisFrame.style.display = 'flex';
                 strengthAnalysisFrame.style.flexDirection = 'row';
                 strengthAnalysisFrame.style.gap = '20px';
                 strengthAnalysisFrame.style.flexWrap = 'wrap';
                 
                 // 设置图表容器样式
                 chartContainer.style.flex = '1';
                 chartContainer.style.minWidth = '300px';
                 chartContainer.style.minHeight = '350px';
                 chartContainer.style.backgroundColor = '#ffffff';
                 chartContainer.style.padding = '15px';
                 chartContainer.style.borderRadius = '8px';
                 chartContainer.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                 
                 // 设置描述容器样式
                 descriptionContainer.style.flex = '1';
                 descriptionContainer.style.minWidth = '300px';
                 descriptionContainer.style.padding = '15px';
                 descriptionContainer.style.backgroundColor = '#f9f9f9';
                 descriptionContainer.style.borderRadius = '8px';
                 descriptionContainer.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
             }
         }

         // 显示起运时间
         function displayLuckTiming(baziData) {
             const luckTiming = document.getElementById('luck-timing');
             const timing = baziData.luckTiming;
             
             luckTiming.innerHTML = `
                 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                     <div class="analysis-card">
                         <h4><i class="fas fa-clock"></i> 起运年龄</h4>
                         <p style="font-size: 2rem; font-weight: bold; color: var(--secondary-color); margin: 10px 0;">
                             ${timing.age}岁${timing.months}个月
                         </p>
                         <p style="color: var(--primary-color); font-weight: 600;">${timing.description}</p>
                         <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);">
                             <p><strong>排列方式：</strong>${timing.direction}</p>
                             <p><strong>节气天数：</strong>${timing.daysDiff}天</p>
                         </div>
                     </div>
                     <div class="analysis-card">
                         <h4><i class="fas fa-info-circle"></i> 起运说明</h4>
                         <p>起运时间是命理学中的重要概念，标志着人生运势的正式开始。</p>
                         <p>计算方法：根据年柱天干阴阳和性别确定顺排或逆排，然后计算出生日到最近节气的天数，3天折合1岁。</p>
                         <p>在起运之前，主要受父母和家庭环境影响；起运之后，个人运势开始发挥主导作用。</p>
                     </div>
                 </div>
             `;
         }

         // 显示命格等级
         function displayFateLevel(baziData) {
             const fateLevelContent = document.getElementById('fate-level-content');
             const fateLevel = baziData.fateLevel;
             
             fateLevelContent.innerHTML = `
                 <div style="text-align: center; margin-bottom: 10px;">
                     <div style="font-size: 2.5rem; font-weight: bold; color: var(--gold-color); margin-bottom: 5px;">
                         ${fateLevel.score}分
                     </div>
                     <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">
                         ${fateLevel.level}
                     </div>
                     <div style="color: var(--text-secondary); font-size: 0.95rem;">
                         ${fateLevel.description}
                     </div>
                 </div>
                 <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); margin-top: 10px;">
                     <div style="display: flex; align-items: center; margin-bottom: 10px;">
                         <div style="width: 4px; height: 20px; background: linear-gradient(to bottom, var(--primary-color), var(--gold-color)); border-radius: 2px; margin-right: 8px;"></div>
                         <h5 style="color: var(--primary-color); font-weight: 700; margin: 0; font-size: 1.1rem;">命格分析说明</h5>
                     </div>
                     
                     <div style="background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; margin-bottom: 10px; border-left: 3px solid var(--primary-color);">
                         <p style="margin: 0; color: var(--text-color); font-size: 0.9rem; line-height: 1.4;">您的命格评分综合了五个关键维度，全面反映了您的先天命局特质与潜能。</p>
                     </div>
                     
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                         <div style="background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--primary-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--primary-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--primary-color); font-weight: 600; font-size: 0.8rem;">01</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 0.9rem;">日主状态</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">评估您的日主是否处于有利季节，这决定了您先天能量的强弱和基础运势。</p>
                         </div>
                         
                         <div style="background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--primary-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--primary-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--primary-color); font-weight: 600; font-size: 0.8rem;">02</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 0.9rem;">五行协调</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">反映您命盘中五行能量的平衡程度，越协调表示性格越全面，适应能力越强。</p>
                         </div>
                         
                         <div style="background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--primary-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--primary-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--primary-color); font-weight: 600; font-size: 0.8rem;">03</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 0.9rem;">命局格局</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">分析您八字中是否存在特殊格局，这些格局往往预示着特殊的人生际遇和才能。</p>
                         </div>
                         
                         <div style="background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--primary-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--primary-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--primary-color); font-weight: 600; font-size: 0.8rem;">04</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 0.9rem;">十神影响</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">体现您命盘中各种人际关系和外部环境对您的影响力和相互作用。</p>
                         </div>
                         
                         <div style="background: rgba(var(--primary-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--primary-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--primary-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--primary-color); font-weight: 600; font-size: 0.8rem;">05</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--primary-color); font-weight: 600; font-size: 0.9rem;">地支关系</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">评估您命盘中地支之间的相互作用，这影响着您的人生机遇和贵人相助的可能性。</p>
                         </div>
                     </div>
                 </div>
             `;
         }

         // 显示财富等级
         function displayWealthLevel(baziData) {
             const wealthLevelContent = document.getElementById('wealth-level-content');
             const wealthLevel = baziData.wealthLevel;
             
             wealthLevelContent.innerHTML = `
                 <div style="text-align: center; margin-bottom: 10px;">
                     <div style="font-size: 2.5rem; font-weight: bold; color: var(--success-color); margin-bottom: 5px;">
                         ${wealthLevel.score}分
                     </div>
                     <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">
                         ${wealthLevel.level}
                     </div>
                     <div style="color: var(--text-secondary); font-size: 0.95rem;">
                         ${wealthLevel.description}
                     </div>
                 </div>
                 <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); margin-top: 10px;">
                     <div style="display: flex; align-items: center; margin-bottom: 10px;">
                         <div style="width: 4px; height: 20px; background: linear-gradient(to bottom, var(--primary-color), var(--success-color)); border-radius: 2px; margin-right: 8px;"></div>
                         <h5 style="color: var(--primary-color); font-weight: 700; margin: 0; font-size: 1.1rem;">财富分析说明</h5>
                     </div>
                     
                     <div style="background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; margin-bottom: 10px; border-left: 3px solid var(--success-color);">
                         <p style="margin: 0; color: var(--text-color); font-size: 0.9rem; line-height: 1.4;">您的财富评分综合了五个关键维度，全面反映了您的财富获取能力与潜在机会。</p>
                     </div>
                     
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                         <div style="background: rgba(var(--success-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--success-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--success-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--success-color); font-weight: 600; font-size: 0.8rem;">01</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--success-color); font-weight: 600; font-size: 0.9rem;">财富潜力</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">评估您命盘中财富星的数量和强度，这决定了您获取财富的基本潜力和能力。</p>
                         </div>
                         
                         <div style="background: rgba(var(--success-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--success-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--success-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--success-color); font-weight: 600; font-size: 0.8rem;">02</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--success-color); font-weight: 600; font-size: 0.9rem;">财富时机</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">分析财富星在命盘中的位置，这影响您在不同人生阶段的财运强弱和财富积累时机。</p>
                         </div>
                         
                         <div style="background: rgba(var(--success-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--success-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--success-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--success-color); font-weight: 600; font-size: 0.8rem;">03</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--success-color); font-weight: 600; font-size: 0.9rem;">财富阻碍</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">评估命盘中对财运产生不利影响的因素，这可能导致财富流失或积累困难的情况。</p>
                         </div>
                         
                         <div style="background: rgba(var(--success-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--success-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--success-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--success-color); font-weight: 600; font-size: 0.8rem;">04</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--success-color); font-weight: 600; font-size: 0.9rem;">财富助力</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">分析命盘中有助于财富积累的因素，这些因素能帮助您更好地把握财富机会和增强财运。</p>
                         </div>
                         
                         <div style="background: rgba(var(--success-rgb), 0.05); border-radius: 8px; padding: 10px; transition: all 0.3s ease; border: 1px solid rgba(var(--success-rgb), 0.1);">
                             <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                 <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(var(--success-rgb), 0.15); display: flex; justify-content: center; align-items: center; margin-right: 8px;">
                                     <span style="color: var(--success-color); font-weight: 600; font-size: 0.8rem;">05</span>
                                 </div>
                                 <h6 style="margin: 0; color: var(--success-color); font-weight: 600; font-size: 0.9rem;">运势影响</h6>
                             </div>
                             <p style="margin: 0; color: var(--text-color); line-height: 1.4; padding-left: 32px; font-size: 0.85rem;">考虑当前大运和流年对您财运的影响，这决定了近期财富机会的多少和财运的强弱。</p>
                         </div>
                     </div>
                 </div>
             `;
         }

         // 获取分析内容（备用内容，当API调用失败时使用）
         function getAnalysisContent(analysisType) {
             const analysisData = {
                 'full-analysis': {
                     title: '命理全解',
                     content: `
                         <h4>八字命理全面解析</h4>
                         <div style="padding: 15px; margin-bottom: 15px; background: #f0f8ff; border-left: 4px solid #3498db; border-radius: 8px;">
                             <h5><i class="fas fa-user"></i> 性格特质</h5>
                             <p>性格温和稳重，做事认真负责，具有较强的责任感和使命感。思维缜密，善于分析问题，但有时过于追求完美。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #fff5eb; border-left: 4px solid #e67e22; border-radius: 8px;">
                             <h5><i class="fas fa-briefcase"></i> 事业发展</h5>
                             <p>适合从事需要耐心和细致的工作，如教育、医疗、金融等领域。职业生涯中期将迎来重要转折点，有望获得晋升或创业机会。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #f9f9f9; border-left: 4px solid #f1c40f; border-radius: 8px;">
                             <h5><i class="fas fa-coins"></i> 财富运势</h5>
                             <p>财运稳健，收入来源主要为工作薪资，中年后有机会获得额外财富。投资方面宜稳健为主，避免高风险投机。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #ffebee; border-left: 4px solid #e74c3c; border-radius: 8px;">
                             <h5><i class="fas fa-heart"></i> 感情婚姻</h5>
                             <p>感情生活较为稳定，婚后家庭和睦。与伴侣相处需注重沟通，避免因工作忙碌而忽略家庭。</p>
                         </div>
                         <div style="padding: 15px; margin-bottom: 15px; background: #e8f5e9; border-left: 4px solid #27ae60; border-radius: 8px;">
                             <h5><i class="fas fa-heartbeat"></i> 健康状况</h5>
                             <p>体质中等，需要注意消化系统和呼吸系统的保养。建议保持规律作息，适当运动，避免过度劳累。</p>
                         </div>
                         <div style="padding: 15px; background: #e3f2fd; border-left: 4px solid #3498db; border-radius: 8px;">
                             <h5><i class="fas fa-star"></i> 人生建议</h5>
                             <p>1. 事业上保持稳健发展，同时不要错过关键机遇</p>
                             <p>2. 财务管理注重长期规划，建立多元化收入</p>
                             <p>3. 感情上增加沟通，平衡工作与家庭</p>
                             <p>4. 健康方面定期体检，保持良好生活习惯</p>
                         </div>
                     `
                 },
                 'annual-fortune': {
                     title: '流年分析',
                     content: `
                         <h4>当前流年运势分析</h4>
                         <p><strong>整体运势：</strong>今年运势较为平稳，有小幅上升趋势。甲木遇辰土，需要注意脾胃健康。</p>
                         <p><strong>事业运：</strong>工作上会有新的机遇出现，但需要谨慎把握，不宜冒进。</p>
                         <p><strong>财运：</strong>财运中等，正财稳定，偏财需谨慎。</p>
                         <p><strong>感情运：</strong>感情运势平稳，已婚者夫妻和睦，单身者有机会遇到合适对象。</p>
                         <p><strong>健康运：</strong>注意消化系统健康，适当运动，保持良好作息。</p>
                     `
                 },
                 'monthly-fortune': {
                     title: '流月分析',
                     content: `
                         <h4>当前年份各月运势预测</h4>
                         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>春季（1-3月）</h5>
                                 <p>运势回升，适合开展新项目</p>
                             </div>
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>夏季（4-6月）</h5>
                                 <p>运势旺盛，事业财运双丰收</p>
                             </div>
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>秋季（7-9月）</h5>
                                 <p>运势平稳，需要稳扎稳打</p>
                             </div>
                             <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <h5>冬季（10-12月）</h5>
                                 <p>运势略有下滑，宜保守行事</p>
                             </div>
                         </div>
                     `
                 },
                 'decade-fortune': {
                     title: '十年大运分析',
                     content: `
                         <h4>人生各阶段大运走势</h4>
                         <div style="margin-top: 15px;">
                             <div style="padding: 15px; margin-bottom: 15px; background: #e8f5e8; border-left: 4px solid #27ae60; border-radius: 8px;">
                                 <h5>青年期（20-30岁）</h5>
                                 <p>学业运佳，适合深造和技能提升。事业起步阶段，需要积累经验。</p>
                             </div>
                             <div style="padding: 15px; margin-bottom: 15px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 8px;">
                                 <h5>壮年期（30-40岁）</h5>
                                 <p>事业发展的黄金期，财运逐渐好转，适合创业或投资。</p>
                             </div>
                             <div style="padding: 15px; margin-bottom: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 8px;">
                                 <h5>中年期（40-50岁）</h5>
                                 <p>运势达到顶峰，事业有成，财富积累丰厚，家庭和睦。</p>
                             </div>
                             <div style="padding: 15px; background: #cce5ff; border-left: 4px solid #007bff; border-radius: 8px;">
                                 <h5>晚年期（50岁以后）</h5>
                                 <p>运势平稳，享受人生，注重健康养生，子女孝顺。</p>
                             </div>
                         </div>
                     `
                 },
                 'personality': {
                     title: '性格分析',
                     content: `
                         <h4>性格特征分析</h4>
                         <p><strong>核心性格：</strong>性格温和，待人真诚，有责任心，做事认真负责。</p>
                         <p><strong>优点：</strong></p>
                         <ul>
                             <li>善良正直，品德高尚</li>
                             <li>勤奋努力，不怕吃苦</li>
                             <li>有耐心，能够坚持</li>
                             <li>重视家庭，孝顺父母</li>
                         </ul>
                         <p><strong>需要改进：</strong></p>
                         <ul>
                             <li>有时过于保守，缺乏冒险精神</li>
                             <li>容易犹豫不决，错失机会</li>
                             <li>对自己要求过高，压力较大</li>
                         </ul>
                         <p><strong>建议：</strong>适当增强自信心，勇于尝试新事物，学会适度放松。</p>
                     `
                 },
                 'career': {
                     title: '事业财富分析',
                     content: `
                         <h4>事业发展方向</h4>
                         <p><strong>适合行业：</strong>教育、文化、医疗、服务业、公务员等稳定性行业。</p>
                         <p><strong>职业特质：</strong>适合需要耐心和责任心的工作，不适合高风险高压力的行业。</p>
                         <p><strong>财富格局：</strong></p>
                         <ul>
                             <li>正财运较好，适合稳定收入的工作</li>
                             <li>偏财运一般，不宜投机取巧</li>
                             <li>理财能力强，善于积累财富</li>
                             <li>晚年财运更佳，越老越富</li>
                         </ul>
                         <p><strong>投资建议：</strong>选择稳健的投资方式，如定期存款、国债、蓝筹股等。</p>
                     `
                 },
                 'marriage': {
                     title: '婚姻分析',
                     content: `
                         <h4>婚姻感情分析</h4>
                         <p><strong>婚姻运势：</strong>婚姻运势较好，能够找到合适的伴侣，婚后生活和睦。</p>
                         <p><strong>配偶特征：</strong></p>
                         <ul>
                             <li>性格温和，善解人意</li>
                             <li>有一定的经济基础</li>
                             <li>重视家庭，顾家</li>
                             <li>可能从事稳定的职业</li>
                         </ul>
                         <p><strong>最佳结婚年龄：</strong>25-30岁之间，此时运势较好，容易遇到合适对象。</p>
                         <p><strong>婚姻建议：</strong>保持沟通，相互理解，共同经营家庭，避免因小事争吵。</p>
                     `
                 },
                 'children': {
                     title: '子女分析',
                     content: `
                         <h4>子女缘分分析</h4>
                         <p><strong>子女运：</strong>子女运较好，能够拥有健康聪明的孩子。</p>
                         <p><strong>子女特征：</strong></p>
                         <ul>
                             <li>聪明伶俐，学习能力强</li>
                             <li>性格活泼，富有创造力</li>
                             <li>孝顺懂事，与父母关系融洽</li>
                             <li>未来发展前景良好</li>
                         </ul>
                         <p><strong>教育建议：</strong></p>
                         <ul>
                             <li>注重品德教育，培养正确价值观</li>
                             <li>发掘孩子的兴趣爱好，因材施教</li>
                             <li>给予适当的自由空间，培养独立性</li>
                             <li>保持良好的亲子沟通</li>
                         </ul>
                     `
                 },
                 'health': {
                     title: '健康分析',
                     content: `
                         <h4>健康状况分析</h4>
                         <p><strong>整体健康：</strong>体质较好，但需要注意某些方面的保养。</p>
                         <p><strong>需要关注的健康问题：</strong></p>
                         <ul>
                             <li>消化系统：注意饮食规律，避免暴饮暴食</li>
                             <li>心血管：适当运动，控制情绪波动</li>
                             <li>呼吸系统：避免吸烟，注意空气质量</li>
                             <li>精神状态：学会放松，避免过度压力</li>
                         </ul>
                         <p><strong>养生建议：</strong></p>
                         <ul>
                             <li>保持规律作息，早睡早起</li>
                             <li>适当运动，如散步、太极等</li>
                             <li>饮食清淡，多吃蔬菜水果</li>
                             <li>定期体检，预防疾病</li>
                         </ul>
                     `
                 }
             };
             
             return analysisData[analysisType]?.content || '<p>分析内容正在生成中...</p>';
         }
         
         // Markdown内容格式化函数
         function formatMarkdownContent(content) {
             // 基本的Markdown转HTML处理
             let formatted = content
                 // 移除所有#字符
                 .replace(/#/g, '')
                 // 处理标题（不显示#符号）
                 .replace(/^\s*(.*?)\s*$/gm, function(match, text) {
                     // 检测是否为标题格式（连续的大写字母或重要关键词）
                     if (text.match(/^[一二三四五六七八九十、]+[、.]/) || 
                         text.match(/^\d+[、.]/) ||
                         text.match(/^(总结|结论|建议|分析|概述|要点|重点|注意|提醒)[:：]?/)) {
                         return '<h3>' + text + '</h3>';
                     }
                     return text;
                 })
                 // 处理粗体
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 // 处理斜体
                 .replace(/\*(.*?)\*/g, '<em>$1</em>')
                 // 处理列表项
                 .replace(/^- (.*$)/gm, '<li>$1</li>')
                 .replace(/^\* (.*$)/gm, '<li>$1</li>')
                 .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
                 // 处理换行
                 .replace(/\n\n/g, '</p><p>')
                 .replace(/\n/g, '<br>');
             
             // 包装列表项
             formatted = formatted.replace(/(<li>.*?<\/li>)/gs, function(match) {
                 if (!match.includes('<ul>') && !match.includes('<ol>')) {
                     return '<ul>' + match + '</ul>';
                 }
                 return match;
             });
             
             // 包装段落
             if (!formatted.startsWith('<h') && !formatted.startsWith('<ul') && !formatted.startsWith('<ol')) {
                 formatted = '<p>' + formatted + '</p>';
             }
             
             return formatted;
         }
         
         // 八字问答API调用
         async function callBaziQAAPI(question, data) {
             // 生成缓存键（处理中文字符）
             const questionHash = encodeURIComponent(question).slice(0, 50).replace(/%/g, '_');
             const cacheKey = `qa:${generateBaziHashKey(data)}:${questionHash}`;
             
             // 检查缓存
             const cachedResponse = localStorage.getItem(cacheKey);
             if (cachedResponse) {
                 return cachedResponse;
             }
             
             // 根据环境自动选择API URL
             const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
             const apiUrl = isLocalhost ? 'http://localhost:3001/api/deepseek' : 'https://deepseek-api-proxy.owenjass.workers.dev/api/deepseek';
             // 使用代理服务器，不直接暴露API Key
             const apiKey = 'placeholder_key_for_local_dev_only';
             
             // 获取当前日期和年份信息
             const today = new Date();
             const currentDateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
             const currentLunar = Lunar.fromDate(today);
             const currentYearGanZhi = currentLunar.getYearInGanZhi();
             const currentYear = today.getFullYear();
             
             // 从data对象中获取八字信息
             const userName = data.name || '用户';
             const genderStr = data.gender === 'male' ? '男' : (data.gender === 'female' ? '女' : '未知');
             const yearPillarStr = data.pillars?.year || '年柱未知';
             const monthPillarStr = data.pillars?.month || '月柱未知';
             const dayPillarStr = data.pillars?.day || '日柱未知';
             const hourPillarStr = data.pillars?.hour || '时柱未知';
             const strengthStr = data.strengthAnalysis?.type || '身强身弱未知';
             const startingAgeStr = data.luckTiming?.description || '起运时间未知';
             
             // 构建prompt
             let prompt = `你是一位专业的八字命理大师，请基于以下准确的八字信息回答用户的问题。\n\n`;
             prompt += `【基本信息】\n`;
             prompt += `姓名：${userName}\n`;
             prompt += `性别：${genderStr}\n`;
             prompt += `当前日期：${currentDateStr}\n`;
             prompt += `当前流年：${currentYear}年${currentYearGanZhi}年\n\n`;
             
             prompt += `【八字信息】\n`;
             prompt += `年柱：${yearPillarStr}\n`;
             prompt += `月柱：${monthPillarStr}\n`;
             prompt += `日柱：${dayPillarStr}\n`;
             prompt += `时柱：${hourPillarStr}\n`;
             prompt += `身强身弱：${strengthStr}\n`;
             prompt += `起运时间：${startingAgeStr}\n\n`;
             
             prompt += `【用户问题】\n${question}\n\n`;
             
             prompt += `【回答要求】\n`;
             prompt += `1. 请基于以上准确的八字信息回答问题，不要重新计算八字\n`;
             prompt += `2. 回答要专业、准确、具体，避免模糊的表述\n`;
             prompt += `3. 如果问题涉及时间预测，请结合当前流年${currentYear}年${currentYearGanZhi}年进行分析\n`;
             prompt += `4. 用通俗易懂的语言解释，让普通人也能理解\n`;
             prompt += `5. 如果问题不是八字相关的，请礼貌地提醒用户只能回答八字命理相关问题\n`;
             prompt += `6. 回答要有建设性，提供实用的建议和指导\n`;
             
             try {
                 console.log('开始调用八字问答API...');
                 console.log('API URL:', apiUrl);
                 console.log('请求数据:', {
                     model: "deepseek-chat",
                     messages: [{ role: "user", content: prompt.substring(0, 200) + '...' }],
                     temperature: 0.7,
                     max_tokens: 1500
                 });
                 
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${apiKey}`
                     },
                     body: JSON.stringify({
                         model: "deepseek-chat",
                         messages: [
                             {
                                 role: "user",
                                 content: prompt
                             }
                         ],
                         temperature: 0.7,
                         max_tokens: 1500
                     })
                 });
                 
                 console.log('API响应状态:', response.status, response.statusText);
                 
                 if (!response.ok) {
                     const errorText = await response.text();
                     console.error('API错误响应:', errorText);
                     throw new Error(`API请求失败: ${response.status} - ${response.statusText}`);
                 }
                 
                 const responseData = await response.json();
                 console.log('API响应数据:', responseData);
                 
                 if (!responseData.choices || !responseData.choices[0] || !responseData.choices[0].message || !responseData.choices[0].message.content) {
                     console.error('API返回数据格式错误:', responseData);
                     throw new Error('API返回数据格式不正确');
                 }
                 
                 const answerContent = responseData.choices[0].message.content;
                 
                 if (!answerContent.trim()) {
                     throw new Error('API返回内容为空');
                 }
                 
                 console.log('API调用成功，返回内容长度:', answerContent.length);
                 
                 // 格式化回答内容（支持Markdown）
                 const formattedAnswer = `<div class="qa-answer">\n<h4><i class="fas fa-lightbulb"></i> 命理解答</h4>\n<div class="qa-content">${formatMarkdownContent(answerContent)}</div>\n</div>`;
                 
                 // 缓存结果（缓存时间较短，因为问答内容可能需要更新）
                 localStorage.setItem(cacheKey, formattedAnswer);
                 
                 return formattedAnswer;
             } catch (error) {
                 console.error('八字问答API调用失败 - 详细错误:', error);
                 console.error('错误堆栈:', error.stack);
                 throw error;
             }
         }
         
         // 通过DeepSeek API获取八字分析
         async function getBaziAnalysisFromDeepSeek(analysisType, data) {
             // 生成缓存键
             const cacheKey = `${generateBaziHashKey(data)}:${analysisType}`;
             
             // 检查缓存
             const cachedResponse = localStorage.getItem(cacheKey);
             if (cachedResponse) {
                 return cachedResponse;
             }
             
             // 使用本地代理服务器
             const apiUrl = 'https://deepseek-api-proxy.owenjass.workers.dev/api/deepseek'
             // 使用代理服务器，不直接暴露API Key
             const apiKey = 'placeholder_key_for_local_dev_only';
             
             // 获取当前日期
             const today = new Date();
             const currentDateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
             
             // 获取当前年份的天干地支
             const currentLunar = Lunar.fromDate(today);
             const currentYearGanZhi = currentLunar.getYearInGanZhi();
             const currentYear = today.getFullYear();
             
             // 从data对象中获取八字信息
             const userName = data.name || '用户';
             const genderStr = data.gender === 'male' ? '男' : (data.gender === 'female' ? '女' : '未知');
             const yearPillarStr = data.pillars?.year || '年柱未知';
             const monthPillarStr = data.pillars?.month || '月柱未知';
             const dayPillarStr = data.pillars?.day || '日柱未知';
             const hourPillarStr = data.pillars?.hour || '时柱未知';
             const strengthStr = data.strengthAnalysis?.type || '身强身弱未知';
             const startingAgeStr = data.luckTiming?.description || '起运时间未知';
             
            const baziFullInfo = `${userName}，${genderStr}，八字信息是：${yearPillarStr}，${monthPillarStr}，${dayPillarStr}，${hourPillarStr}，命主为${strengthStr}，${startingAgeStr}。`;
            const baziInfo = {
            baziFullInfo,
            yearPillar: yearPillarStr,
            monthPillar: monthPillarStr,
            dayPillar: dayPillarStr,
            hourPillar: hourPillarStr,
            strength: strengthStr,
            startingAge: startingAgeStr,
            elementsDistribution: data.elementsDistribution || {}
            };
             
             // 根据分析类型构建提示词
             let prompt = `请作为专业命理师，使用标准Markdown语法，基于以下本地计算的准确八字信息进行深度分析。当前日期：${currentDateStr}\n\n`;
             
             // 添加八字核心信息（使用完整的baziFullInfo）
             prompt += `### 八字信息\n`;
             prompt += `${baziFullInfo}\n\n`;
             
             // 添加五行分布信息
             if (baziInfo.elementsDistribution && Object.keys(baziInfo.elementsDistribution).length > 0) {
                 prompt += `- 五行分布：`;
                 Object.entries(baziInfo.elementsDistribution).forEach(([element, count]) => {
                     prompt += `${element}${count}个 `;
                 });
                 prompt += `\n\n`;
             }
             
             prompt += `**重要说明：以上八字、身强身弱判断和起运时间均为本地精确计算结果。您必须严格基于这些信息进行分析，绝对不要自行重新计算或使用其他值。**\n\n`;
             
             // 根据分析类型添加特定提示
             switch (analysisType) {
                 case 'full-analysis':
                     prompt += `请基于以上八字信息，进行全面的命理解析。分析内容应包括：\n`;
                     prompt += `1. 性格特质与天赋才能分析\n`;
                     prompt += `2. 事业发展方向与职业规划建议\n`;
                     prompt += `3. 财富运势与理财投资指导\n`;
                     prompt += `4. 感情婚姻状况与伴侣特征\n`;
                     prompt += `5. 健康状况评估与养生建议\n`;
                     prompt += `6. 人生各阶段重要转折点预测\n`;
                     prompt += `7. 提升运势的实用方法与建议\n`;
                     break;
                     
                 case 'annual-fortune':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的流年运势分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. ${currentYear}年${currentYearGanZhi}年整体运势概述\n`;
                     prompt += `2. 事业发展与工作机遇分析\n`;
                     prompt += `3. 财运分析（正财与偏财）\n`;
                     prompt += `4. 感情与人际关系运势\n`;
                     prompt += `5. 健康状况预警与建议\n`;
                     prompt += `6. 流年吉凶月份预测\n`;
                     prompt += `7. 化解不利因素的实用建议\n`;
                     break;
                     
                 case 'monthly-fortune':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的流月运势分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. ${currentYear}年各月运势总体趋势\n`;
                     prompt += `2. 按季节分析（春、夏、秋、冬）各月运势特点\n`;
                     prompt += `3. 重点月份的机遇与挑战\n`;
                     prompt += `4. 每月事业、财运、感情、健康关键点\n`;
                     prompt += `5. 月份吉凶日预测方法\n`;
                     prompt += `6. 不同月份的行动建议\n`;
                     break;
                     
                 case 'decade-fortune':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的十年大运分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 人生各阶段大运走势概述\n`;
                     prompt += `2. 青年期（20-30岁）运势与发展方向\n`;
                     prompt += `3. 壮年期（30-40岁）事业与财富高峰期分析\n`;
                     prompt += `4. 中年期（40-50岁）稳定发展期特点\n`;
                     prompt += `5. 晚年期（50岁以后）运势变化\n`;
                     prompt += `6. 大运交接期的注意事项\n`;
                     prompt += `7. 如何把握各阶段机遇的建议\n`;
                     break;
                     
                 case 'personality':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的性格分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 核心性格特质与天赋才能\n`;
                     prompt += `2. 性格优势与特长详解\n`;
                     prompt += `3. 性格中需要注意的弱点\n`;
                     prompt += `4. 人际交往模式与沟通风格\n`;
                     prompt += `5. 思维方式与决策特点\n`;
                     prompt += `6. 情绪管理能力分析\n`;
                     prompt += `7. 性格发展与自我提升建议\n`;
                     break;
                     
                 case 'career':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的事业财富分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 最适合的职业领域与行业\n`;
                     prompt += `2. 职业发展路径与关键转折点\n`;
                     prompt += `3. 事业成功的关键因素\n`;
                     prompt += `4. 财富来源与积累模式\n`;
                     prompt += `5. 正财与偏财运势分析\n`;
                     prompt += `6. 投资理财建议与风险提示\n`;
                     prompt += `7. 事业与财富平衡的人生规划\n`;
                     break;
                     
                 case 'marriage':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的婚姻分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 婚姻运势与缘分总体评估\n`;
                     prompt += `2. 理想伴侣的性格与特质描述\n`;
                     prompt += `3. 婚姻生活的特点与模式\n`;
                     prompt += `4. 婚姻中可能面临的挑战\n`;
                     prompt += `5. 最佳婚姻时机与年龄段\n`;
                     prompt += `6. 婚姻关系经营的建议\n`;
                     prompt += `7. 提升婚姻质量的实用方法\n`;
                     break;
                     
                 case 'children':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的子女分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 子女缘分与数量预测\n`;
                     prompt += `2. 子女可能的性格特点\n`;
                     prompt += `3. 亲子关系的特点与互动模式\n`;
                     prompt += `4. 子女教育的最佳方式\n`;
                     prompt += `5. 子女成长中的关键阶段\n`;
                     prompt += `6. 如何培养子女的天赋与能力\n`;
                     prompt += `7. 亲子关系和谐的实用建议\n`;
                     break;
                     
                 case 'health':
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行详细的健康分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。分析内容应包括：\n`;
                     prompt += `1. 先天体质与健康状况评估\n`;
                     prompt += `2. 需要特别关注的身体系统\n`;
                     prompt += `3. 不同年龄段的健康风险\n`;
                     prompt += `4. 季节性健康变化与注意事项\n`;
                     prompt += `5. 适合的运动与锻炼方式\n`;
                     prompt += `6. 饮食调理与营养建议\n`;
                     prompt += `7. 预防疾病的养生保健方法\n`;
                     break;
                     
                 default:
                     prompt += `请基于以上本地计算的准确八字信息（包括身强身弱和起运时间），进行全面的命理分析。请不要重新计算八字、身强身弱或起运时间，直接使用提供的信息。\n`;
             }
             
             prompt += `\n请用人性化、清晰的语言表达，避免过于专业的术语，使普通人也能理解。分析要全面、深入、具体，不要笼统。`;
             
             try {
                 // 调用DeepSeek API
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${apiKey}`
                     },
                     body: JSON.stringify({
                         model: "deepseek-chat",
                         messages: [
                             {
                                 role: "user",
                                 content: prompt
                             }
                         ],
                         temperature: 0.7,
                         max_tokens: 2000
                     })
                 });
                 
                 if (!response.ok) {
                     throw new Error(`API请求失败: ${response.status}`);
                 }
                 
                 const data = await response.json();
                 
                 if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                     throw new Error('API返回数据格式不正确');
                 }
                 
                 const analysisContent = data.choices[0].message.content;
                 
                 // 检查内容是否为空
                 if (!analysisContent.trim()) {
                     throw new Error('API返回内容为空');
                 }
                 
                 // 缓存结果
                 localStorage.setItem(cacheKey, analysisContent);
                 
                 return analysisContent;
             } catch (error) {
                 console.error('DeepSeek API调用失败:', error);
                 throw error;
             }
         }
         
         // 生成八字哈希键（用于缓存）
         function generateBaziHashKey(data) {
             return `${data.name}-${data.gender}-${data.birthDate}-${data.birthTime}`;
         }
     </script>
    </div> <!-- 闭合 container -->
    </div> <!-- 闭合 page-container -->
</body>
</html>
