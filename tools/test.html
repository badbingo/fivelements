<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字计算器 - 麦八字教学网</title>
    <link rel="stylesheet" href="../css/style1.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <script defer src="../js/navigation.js"></script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2NHJXGKS0Y"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-2NHJXGKS0Y');
    </script>
    
    <style>
        /* 新增分析卡片样式 */
        .analysis-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(237, 28, 36, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .analysis-card h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(237, 28, 36, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analysis-card h3 i {
            color: var(--accent-color);
        }
        
        .analysis-content {
            line-height: 1.8;
            color: #444;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analysis-item {
            background: rgba(255, 255, 255, 0.6);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        
        .analysis-item-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .analysis-item-content {
            color: #555;
            line-height: 1.6;
        }
        
        /* 五行平衡图表 */
        .wuxing-chart-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .wuxing-chart {
            width: 100%;
            max-width: 500px;
            height: 300px;
        }
        
        /* 用神忌神标签 */
        .god-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-right: 8px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .useful-god {
            background-color: rgba(46, 125, 50, 0.1);
            color: #2e7d32;
            border: 1px solid rgba(46, 125, 50, 0.3);
        }
        
        .harmful-god {
            background-color: rgba(198, 40, 40, 0.1);
            color: #c62828;
            border: 1px solid rgba(198, 40, 40, 0.3);
        }
        
        /* 交互式元素 */
        .interactive-element {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .interactive-element:hover {
            color: var(--primary-color);
        }
        
        .interactive-element::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 1px;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .interactive-element:hover::after {
            width: 100%;
        }
        
        /* 工具提示 */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* 选项卡样式 */
        .tab-container {
            margin: 30px 0;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid rgba(237, 28, 36, 0.2);
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 运势时间轴 */
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 30px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-color);
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 20px;
            bottom: -30px;
            width: 1px;
            background: rgba(237, 28, 36, 0.3);
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .timeline-year {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .timeline-content {
            background: rgba(255, 255, 255, 0.6);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-buttons {
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    
    <main class="content-container">
        <div class="content-title">
            <h1>八字计算器</h1>
            <p>输入您的出生信息，自动生成完整八字命盘及详细分析</p>
        </div>

        <div class="content-section">
            <div class="calculator-form">
                <div class="form-header">
                    <h2 style="color: white;"><i class="fas fa-user-circle"></i> 基本信息输入</h2>
                    <p style="color: white;">请填写您的出生信息以生成八字命盘</p>
                </div>
                <form id="bazi-form" class="elegant-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="birth-date"><i class="far fa-calendar-alt"></i> 出生日期</label>
                            <div class="input-with-icon">
                                <i class="fas fa-calendar-day"></i>
                                <input type="date" id="birth-date" name="birth-date" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="far fa-clock"></i> 出生时间</label>
                            <div class="time-select-group">
                                <div class="select-with-icon">
                                    <i class="fas fa-hourglass-start"></i>
                                    <select id="birth-hour" name="birth-hour" required>
                                        <option value="">-- 时 --</option>
                                        <script>
                                            for(let i=0; i<24; i++) {
                                                document.write(`<option value="${i}">${i < 10 ? '0' + i : i}时</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                                <div class="select-with-icon">
                                    <i class="fas fa-hourglass-end"></i>
                                    <select id="birth-minute" name="birth-minute" required>
                                        <option value="">-- 分 --</option>
                                        <script>
                                            for(let i=0; i<60; i++) {
                                                document.write(`<option value="${i}">${i < 10 ? '0' + i : i}分</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timezone"><i class="fas fa-globe-asia"></i> 出生地区</label>
                            <div class="select-with-icon">
                                <i class="fas fa-map-marker-alt"></i>
                                <select id="timezone" name="timezone" required>
                                    <option value="8">中国标准时间 (UTC+8)</option>
                                    <option value="-8">太平洋时间 (UTC-8)</option>
                                    <option value="-5">东部时间 (UTC-5)</option>
                                    <option value="0">格林尼治时间 (UTC+0)</option>
                                    <option value="9">日本标准时间 (UTC+9)</option>
                                    <option value="-7">山地时间 (UTC-7)</option>
                                    <option value="-6">中部时间 (UTC-6)</option>
                                    <option value="1">中欧时间 (UTC+1)</option>
                                    <option value="10">澳大利亚东部时间 (UTC+10)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-venus-mars"></i> 性别</label>
                            <div class="gender-group">
                                <label class="gender-option">
                                    <input type="radio" name="gender" value="male" checked>
                                    <span class="gender-icon"><i class="fas fa-mars"></i></span>
                                    <span class="gender-text">男</span>
                                </label>
                                <label class="gender-option">
                                    <input type="radio" name="gender" value="female">
                                    <span class="gender-icon"><i class="fas fa-venus"></i></span>
                                    <span class="gender-text">女</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-calculator"></i> 计算八字</button>
                        <button type="reset" class="btn btn-secondary"><i class="fas fa-redo"></i> 重置</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="content-section" id="result-section" style="display: none;">
            <div class="result-header">
                <h2><i class="fas fa-chart-pie"></i> 八字命盘结果</h2>
                <div class="result-actions">
                    <button id="print-btn" class="btn btn-action"><i class="fas fa-print"></i> 打印</button>
                    <button id="save-btn" class="btn btn-action"><i class="fas fa-save"></i> 保存</button>
                </div>
            </div>
            
            <div class="bazi-result">
                <div class="basic-info-card">
                    <h3><i class="fas fa-info-circle"></i> 基本信息</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">出生日期：</span>
                            <span class="info-value" id="result-date">1984年1月1日</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">出生时间：</span>
                            <span class="info-value" id="result-time">23:00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">农历日期：</span>
                            <span class="info-value" id="result-lunar">癸亥年腊月初八</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">生肖：</span>
                            <span class="info-value" id="result-zodiac">鼠</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">命宫：</span>
                            <span class="info-value" id="result-minggong">卯宫</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">身宫：</span>
                            <span class="info-value" id="result-shengong">酉宫</span>
                        </div>
                    </div>
                </div>
                
                <div class="bazi-table-container">
                    <table class="bazi-elegant-table">
                        <thead>
                            <tr>
                                <th>四柱</th>
                                <th>年柱</th>
                                <th>月柱</th>
                                <th>日柱</th>
                                <th>时柱</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="pillar-label">天干</td>
                                <td class="wuxing-wood" id="year-stem">甲<br><span class="ten-god">(比肩)</span></td>
                                <td class="wuxing-wood" id="month-stem">乙<br><span class="ten-god">(劫财)</span></td>
                                <td class="wuxing-fire" id="day-stem">丙<br><span class="ten-god">(日元)</span></td>
                                <td class="wuxing-fire" id="hour-stem">丁<br><span class="ten-god">(伤官)</span></td>
                            </tr>
                            <tr>
                                <td class="pillar-label">地支</td>
                                <td class="wuxing-water" id="year-branch">子<br><span class="ten-god">(正官)</span></td>
                                <td class="wuxing-earth" id="month-branch">丑<br><span class="ten-god">(正印)</span></td>
                                <td class="wuxing-wood" id="day-branch">寅<br><span class="ten-god">(偏印)</span></td>
                                <td class="wuxing-wood" id="hour-branch">卯<br><span class="ten-god">(正印)</span></td>
                            </tr>
                            <tr>
                                <td class="pillar-label">藏干</td>
                                <td class="wuxing-water" id="year-hidden-god">癸<br><span class="ten-god">(正印)</span></td>
                                <td class="wuxing-earth" id="month-hidden-god">己(正财)<br>癸(正印)<br>辛(正官)</td>
                                <td class="wuxing-wood" id="day-hidden-god">甲(比肩)<br>丙(劫财)<br>戊(食神)</td>
                                <td class="wuxing-wood" id="hour-hidden-god">乙<br><span class="ten-god">(劫财)</span></td>
                            </tr>
                            <tr>
                                <td class="pillar-label">空亡</td>
                                <td id="year-void">戌亥</td>
                                <td id="month-void">戌亥</td>
                                <td id="day-void">戌亥</td>
                                <td id="hour-void">戌亥</td>
                            </tr>
                            <tr>
                                <td class="pillar-label">纳音</td>
                                <td id="year-nayin">海中金</td>
                                <td id="month-nayin">海中金</td>
                                <td id="day-nayin">炉中火</td>
                                <td id="hour-nayin">炉中火</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 新增的分析部分 -->
            <div class="analysis-card">
                <h3><i class="fas fa-balance-scale"></i> 身强身弱分析</h3>
                <div class="analysis-content" id="strength-analysis">
                    <!-- 这里将通过JavaScript动态生成内容 -->
                </div>
            </div>
            
            <div class="analysis-card">
                <h3><i class="fas fa-project-diagram"></i> 十神关系分析</h3>
                <div class="analysis-content" id="ten-god-analysis">
                    <!-- 这里将通过JavaScript动态生成内容 -->
                </div>
            </div>
            
            <div class="analysis-card">
                <h3><i class="fas fa-yin-yang"></i> 五行平衡分析</h3>
                <div class="analysis-content">
                    <div id="wuxing-balance-analysis">
                        <!-- 这里将通过JavaScript动态生成内容 -->
                    </div>
                    <div class="wuxing-chart-container">
                        <div class="wuxing-chart" id="wuxing-chart">
                            <!-- 五行图表将通过JavaScript生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="analysis-card">
                <h3><i class="fas fa-star"></i> 特殊组合分析</h3>
                <div class="analysis-content" id="special-combo-analysis">
                    <!-- 这里将通过JavaScript动态生成内容 -->
                </div>
            </div>
            
            <div class="analysis-card">
                <h3><i class="fas fa-thumbs-up"></i> 用神与忌神分析</h3>
                <div class="analysis-content">
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="analysis-item-title"><i class="fas fa-heart"></i> 喜用神</div>
                            <div class="analysis-item-content" id="useful-gods">
                                <!-- 这里将通过JavaScript动态生成内容 -->
                            </div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-item-title"><i class="fas fa-times-circle"></i> 忌神</div>
                            <div class="analysis-item-content" id="harmful-gods">
                                <!-- 这里将通过JavaScript动态生成内容 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="analysis-card">
                <h3><i class="fas fa-hourglass-half"></i> 命盘运势分析</h3>
                <div class="analysis-content">
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="luck-current">当前运势</button>
                            <button class="tab-button" data-tab="luck-decade">大运走势</button>
                            <button class="tab-button" data-tab="luck-year">流年分析</button>
                        </div>
                        
                        <div class="tab-content active" id="luck-current">
                            <div id="current-luck-analysis">
                                <!-- 当前运势内容 -->
                            </div>
                        </div>
                        
                        <div class="tab-content" id="luck-decade">
                            <div id="decade-luck-analysis">
                                <!-- 大运走势内容 -->
                            </div>
                        </div>
                        
                        <div class="tab-content" id="luck-year">
                            <div id="year-luck-analysis">
                                <!-- 流年分析内容 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="analysis-card">
                <h3><i class="fas fa-graduation-cap"></i> 八字学习建议</h3>
                <div class="analysis-content" id="learning-suggestions">
                    <!-- 这里将通过JavaScript动态生成内容 -->
                </div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 麦八字教学网. 保留所有权利.</p>
            <p>传承经典命理文化，科学学习八字知识</p>
        </div>
    </footer>
    
    <script src="../js/lunar.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // 选项卡功能
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // 移除所有按钮和内容的active类
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 添加active类到当前按钮和对应内容
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // 打印功能
    document.getElementById('print-btn').addEventListener('click', function() {
        window.print();
    });
    
    // 保存功能（需要html2canvas库）
    document.getElementById('save-btn').addEventListener('click', function() {
        const resultSection = document.getElementById('result-section');
        if (typeof html2canvas !== 'undefined') {
            html2canvas(resultSection).then(canvas => {
                const link = document.createElement('a');
                link.download = '八字命盘分析.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        } else {
            alert('请先引入html2canvas库以使用保存图片功能');
        }
    });
    
    // 表单提交处理
    document.getElementById('bazi-form').addEventListener('submit', function(e) {
        e.preventDefault();
        calculateBazi();
    });

    // 八字计算主函数
    function calculateBazi() {
        try {
            // 1. 获取并验证输入数据
            const birthDate = document.getElementById('birth-date').value;
            const birthHour = document.getElementById('birth-hour').value;
            const birthMinute = document.getElementById('birth-minute').value;
            const timezone = document.getElementById('timezone').value;
            const gender = document.querySelector('input[name="gender"]:checked').value;

            // 验证必填字段
            if (!birthDate || birthHour === "" || birthMinute === "") {
                throw new Error("请填写完整的出生日期和时间");
            }

            // 2. 解析日期和时间
            const dateParts = birthDate.split('-');
            if (dateParts.length !== 3) {
                throw new Error("日期格式不正确，请使用YYYY-MM-DD格式");
            }

            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]);
            const day = parseInt(dateParts[2]);
            const hour = parseInt(birthHour);
            const minute = parseInt(birthMinute);

            // 验证日期有效性
            if (isNaN(year) || isNaN(month) || isNaN(day) || 
                isNaN(hour) || isNaN(minute)) {
                throw new Error("请输入有效的数字");
            }

            if (year < 1900 || year > 2100) {
                throw new Error("年份应在1900-2100之间");
            }

            if (month < 1 || month > 12) {
                throw new Error("月份应在1-12之间");
            }

            if (day < 1 || day > 31) {
                throw new Error("日期应在1-31之间");
            }

            if (hour < 0 || hour > 23) {
                throw new Error("小时应在0-23之间");
            }

            if (minute < 0 || minute > 59) {
                throw new Error("分钟应在0-59之间");
            }

            // 3. 创建日期对象（考虑时区）
            const solarDate = new Date(year, month - 1, day, hour, minute);
            
            // 验证创建的日期是否有效
            if (isNaN(solarDate.getTime())) {
                throw new Error("无效的日期，请检查输入");
            }

            // 4. 使用lunar.js计算
            if (typeof Lunar === 'undefined') {
                throw new Error("lunar.js库未正确加载");
            }

            const lunar = Lunar.fromDate(solarDate);
            if (!lunar) {
                throw new Error("农历日期转换失败");
            }

            const baZi = lunar.getBaZi();
            if (!baZi || baZi.length !== 4) {
                throw new Error("八字计算失败");
            }

            // 5. 显示结果
            displayBaziResult(lunar, baZi, {
                solarDate,
                gender,
                timezone
            });

        } catch (error) {
            console.error("八字计算错误:", error);
            alert(error.message || "计算八字时出错，请检查输入是否正确");
        }
    }

    // 显示八字结果
    function displayBaziResult(lunar, baZi, options) {
        const [yearGanZhi, monthGanZhi, dayGanZhi, hourGanZhi] = baZi;
        const dayGan = dayGanZhi.substring(0, 1);
        
        // 显示基本信息
        document.getElementById('result-date').textContent = 
            `${options.solarDate.getFullYear()}年${options.solarDate.getMonth() + 1}月${options.solarDate.getDate()}日`;
        document.getElementById('result-time').textContent = 
            `${options.solarDate.getHours().toString().padStart(2, '0')}:${options.solarDate.getMinutes().toString().padStart(2, '0')}`;
        document.getElementById('result-lunar').textContent = 
            `${lunar.getYearInGanZhi()}年${lunar.getMonthInChinese()}${lunar.getDayInChinese()}`;
        document.getElementById('result-zodiac').textContent = 
            lunar.getYearShengXiao();

        // 更新四柱信息
        updatePillarInfo('year', yearGanZhi, dayGan, lunar);
        updatePillarInfo('month', monthGanZhi, dayGan, lunar);
        updatePillarInfo('day', dayGanZhi, dayGan, lunar);
        updatePillarInfo('hour', hourGanZhi, dayGan, lunar);

        // 填充分析部分
        fillAnalysisSections(lunar, options.gender);

        // 显示结果区域
        document.getElementById('result-section').style.display = 'block';
    }

    // 填充所有分析部分
    function fillAnalysisSections(lunar, gender) {
    const baZi = lunar.getBaZi();
    const dayGan = baZi[2].substring(0, 1);
    const wuxingCount = countWuxingElements(lunar);
        // 身强身弱分析
        document.getElementById('strength-analysis').innerHTML = `
            <p><strong>身强身弱：</strong>${getStrengthAnalysis(lunar)}</p>
            ${generateStrengthDetails(lunar)}
        `;    
            <div class="analysis-grid">
                <div class="analysis-item">
                    <div class="analysis-item-title"><i class="fas fa-cloud-sun"></i> 得令情况</div>
                    <div class="analysis-item-content">${getSeasonStrength(lunar)}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-item-title"><i class="fas fa-mountain"></i> 得地情况</div>
                    <div class="analysis-item-content">${getLandStrength(lunar)}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-item-title"><i class="fas fa-users"></i> 得势情况</div>
                    <div class="analysis-item-content">${getSupportStrength(lunar)}</div>
                </div>
            </div>
        `;
        
        // 十神关系分析
        document.getElementById('ten-god-analysis').innerHTML = `
            ${generateTenGodAnalysis(lunar)}
            <p>${getTenGodSummary(lunar)}</p>
        `;
        
        // 五行平衡分析
        document.getElementById('wuxing-balance-analysis').innerHTML = `
            ${generateWuxingBalance(lunar)}
            <p>${getWuxingImbalanceAnalysis(lunar)}</p>
        `;
        generateWuxingChart(lunar);
        
        // 特殊组合分析
        document.getElementById('special-combo-analysis').innerHTML = getSpecialCombination(lunar);
        
        // 用神与忌神分析
        document.getElementById('useful-gods').innerHTML = `
            ${getUsefulGods(lunar).map(god => `<span class="god-tag useful-god">${god}</span>`).join('')}
            <p>${getUsefulGodsAnalysis(lunar)}</p>
        `;
        
        document.getElementById('harmful-gods').innerHTML = `
            ${getHarmfulGods(lunar).map(god => `<span class="god-tag harmful-god">${god}</span>`).join('')}
            <p>${getHarmfulGodsAnalysis(lunar)}</p>
        `;
        
        // 命盘运势分析
        document.getElementById('current-luck-analysis').innerHTML = getCurrentLuck(lunar, gender);
        document.getElementById('decade-luck-analysis').innerHTML = `
            <p>${getDecadeLuckSummary(lunar, gender)}</p>
            ${generateDecadeLuckTimeline(lunar, gender)}
        `;
        document.getElementById('year-luck-analysis').innerHTML = `
            <p>${getYearLuckAnalysis(lunar)}</p>
            <div class="analysis-grid">
                ${generateNextYearsLuck(lunar)}
            </div>
        `;
        
        // 八字学习建议
        document.getElementById('learning-suggestions').innerHTML = `
            <p>${getLearningSuggestions(lunar)}</p>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <div class="analysis-item-title"><i class="fas fa-book-open"></i> 推荐学习重点</div>
                    <div class="analysis-item-content">${getRecommendedTopics(lunar).replace(/\n/g, '<br>')}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-item-title"><i class="fas fa-lightbulb"></i> 学习技巧</div>
                    <div class="analysis-item-content">${getLearningTips(lunar).replace(/\n/g, '<br>')}</div>
                </div>
            </div>
        `;
    }

    // 更新单个柱的信息
    function updatePillarInfo(type, ganZhi, dayGan, lunar) {
        const gan = ganZhi.substring(0, 1);
        const zhi = ganZhi.substring(1);
        
        // 天干
        document.getElementById(`${type}-stem`).innerHTML = 
            `${gan}<br><span class="ten-god">(${getTenGod(dayGan, gan)})</span>`;
        
        // 地支
        document.getElementById(`${type}-branch`).innerHTML = 
            `${zhi}<br><span class="ten-god">(${getTenGod(dayGan, zhi)})</span>`;
        
        // 藏干
        const hiddenStems = getHiddenStems(zhi).map(stem => 
            `${stem}(${getTenGod(dayGan, stem)})`
        ).join('<br>');
        document.getElementById(`${type}-hidden-god`).innerHTML = hiddenStems;
        
        // 空亡
        document.getElementById(`${type}-void`).textContent = getVoid(zhi);
        
        // 纳音
        document.getElementById(`${type}-nayin`).textContent = getNaYin(ganZhi);
    }

    /* ==================== 分析功能实现 ==================== */

    // 身强身弱分析
    function getStrengthAnalysis(lunar) {
    const baZi = lunar.getBaZi();
    const dayGan = baZi[2].substring(0, 1);
    const monthZhi = baZi[1].substring(1);
    
    // 判断得令情况
    const seasonStrength = getSeasonStrength(dayGan, monthZhi);
    
    // 判断得地情况
    const landStrength = getLandStrength(baZi, dayGan);
    
    // 判断得势情况
    const supportStrength = getSupportStrength(baZi, dayGan);
    
    // 综合判断
    if (seasonStrength === '得令' && landStrength >= 2 && supportStrength >= 2) {
        return "身强";
    } else if (seasonStrength === '不得令' && landStrength <= 1 && supportStrength <= 1) {
        return "身弱";
    } else {
        return "中和偏" + (seasonStrength === '得令' ? '强' : '弱');
    }
}
    
    function getSeasonStrength(lunar) {
        // 判断得令情况
        return "日主生于休囚之月，不得令";
    }
    
    function getLandStrength(lunar) {
        // 判断得地情况
        return "地支有根气，得地一般";
    }
    
    function getSupportStrength(lunar) {
        // 判断得势情况
        return "天干比劫帮扶较少，得势不足";
    }

    // 十神分析
    function generateTenGodAnalysis(lunar) {
    const baZi = lunar.getBaZi();
    const dayGan = baZi[2].substring(0, 1);
    
    // 统计十神数量
    const tenGodCount = {
        '比肩': 0, '劫财': 0, '食神': 0, '伤官': 0,
        '偏财': 0, '正财': 0, '七杀': 0, '正官': 0,
        '偏印': 0, '正印': 0
    };
    
    // 统计天干十神
    baZi.forEach(ganZhi => {
        const gan = ganZhi.substring(0, 1);
        const tenGod = getTenGod(dayGan, gan);
        tenGodCount[tenGod]++;
    });
    
    // 统计地支十神
    baZi.forEach(ganZhi => {
        const zhi = ganZhi.substring(1);
        const tenGod = getTenGod(dayGan, zhi);
        tenGodCount[tenGod]++;
        
        // 统计藏干十神
        const hiddenStems = getHiddenStems(zhi);
        hiddenStems.forEach(stem => {
            const hiddenTenGod = getTenGod(dayGan, stem);
            tenGodCount[hiddenTenGod]++;
        });
    });
    
    // 生成分析HTML
    return `
        <div class="analysis-grid">
            <div class="analysis-item">
                <div class="analysis-item-title"><i class="fas fa-user-friends"></i> 比劫</div>
                <div class="analysis-item-content">
                    比肩${tenGodCount['比肩']}个，劫财${tenGodCount['劫财']}个
                </div>
            </div>
            <!-- 其他十神分析项 -->
        </div>
    `;
}
    
    function getTenGodSummary(lunar) {
        // 十神总结
        return "综合分析，您的八字中印星较多，学习能力较强，但比劫较少，独立性强但合作能力需提升。";
    }

    // 五行平衡分析
    function generateWuxingBalance(lunar) {
    const wuxingCount = countWuxingElements(lunar);
    const total = Object.values(wuxingCount).reduce((a, b) => a + b, 0);
    
    return `
        <div class="analysis-grid">
            ${Object.entries(wuxingCount).map(([element, count]) => {
                const percentage = ((count / total) * 100).toFixed(1);
                let strength = '';
                if (percentage > 30) strength = '偏旺';
                else if (percentage > 15) strength = '适中';
                else strength = '偏弱';
                
                return `
                    <div class="analysis-item">
                        <div class="analysis-item-title">
                            <i class="fas fa-${getElementIcon(element)} wuxing-${getElementClass(element)}"></i> ${element}
                        </div>
                        <div class="analysis-item-content">${count}个 (${percentage}%), ${strength}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

    // 添加五行统计函数
function countWuxingElements(lunar) {
    const baZi = lunar.getBaZi();
    const wuxingCount = { 木: 0, 火: 0, 土: 0, 金: 0, 水: 0 };
    
    // 天干五行映射
    const ganWuxing = {
        '甲': '木', '乙': '木', '丙': '火', '丁': '火',
        '戊': '土', '己': '土', '庚': '金', '辛': '金',
        '壬': '水', '癸': '水'
    };
    
    // 地支五行映射
    const zhiWuxing = {
        '寅': '木', '卯': '木', '午': '火', '巳': '火',
        '辰': '土', '戌': '土', '丑': '土', '未': '土',
        '申': '金', '酉': '金', '子': '水', '亥': '水'
    };
    
    // 统计天干五行
    baZi.forEach(ganZhi => {
        const gan = ganZhi.substring(0, 1);
        const zhi = ganZhi.substring(1);
        
        if (ganWuxing[gan]) wuxingCount[ganWuxing[gan]]++;
        if (zhiWuxing[zhi]) wuxingCount[zhiWuxing[zhi]]++;
        
        // 统计藏干五行
        const hiddenStems = getHiddenStems(zhi);
        hiddenStems.forEach(stem => {
            if (ganWuxing[stem]) wuxingCount[ganWuxing[stem]]++;
        });
    });
    
    return wuxingCount;
}
            
    function getWuxingImbalanceAnalysis(lunar) {
        // 五行不平衡分析
        return "您的八字中木元素偏旺，土、金、水元素偏弱，建议在生活中多关注这些元素的平衡。";
    }
    
    function generateWuxingChart(lunar) {
        // 生成五行图表（简化版，实际应使用图表库）
        const chartContainer = document.getElementById('wuxing-chart');
        chartContainer.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <p>五行力量分布图</p>
                <div style="display: flex; justify-content: center; height: 200px; align-items: flex-end; gap: 20px; margin-top: 20px;">
                    <div style="width: 40px; background: #2e7d32; height: 150px; position: relative;">
                        <div style="position: absolute; bottom: -25px; width: 100%; text-align: center;">木</div>
                    </div>
                    <div style="width: 40px; background: #c62828; height: 100px; position: relative;">
                        <div style="position: absolute; bottom: -25px; width: 100%; text-align: center;">火</div>
                    </div>
                    <div style="width: 40px; background: #8d6e63; height: 50px; position: relative;">
                        <div style="position: absolute; bottom: -25px; width: 100%; text-align: center;">土</div>
                    </div>
                    <div style="width: 40px; background: #1565c0; height: 50px; position: relative;">
                        <div style="position: absolute; bottom: -25px; width: 100%; text-align: center;">金</div>
                    </div>
                    <div style="width: 40px; background: #0277bd; height: 50px; position: relative;">
                        <div style="position: absolute; bottom: -25px; width: 100%; text-align: center;">水</div>
                    </div>
                </div>
            </div>
        `;
    }

    // 特殊组合分析
    function getSpecialCombination(lunar) {
        // 特殊组合分析
        return "您的八字中有寅卯辰三会木局，增强了木的力量；同时子丑合土，但力量不强。这些特殊组合影响了五行的平衡。";
    }

    // 用神与忌神分析
    function getUsefulGods(lunar) {
        // 用神分析
        return ["金", "土", "水"];
    }
    
    function getUsefulGodsAnalysis(lunar) {
        // 用神分析说明
        return "金可以克制过旺的木，土可以泄木生金，水可以生木但也能润局，这些都是对您有利的五行。";
    }
    
    function getHarmfulGods(lunar) {
        // 忌神分析
        return ["木", "火"];
    }
    
    function getHarmfulGodsAnalysis(lunar) {
        // 忌神分析说明
        return "木已经过旺，再增加木的力量会加剧不平衡；火会泄木生土，但也会消耗用神金的力量。";
    }

    // 命盘运势分析
    function getCurrentLuck(lunar, gender) {
        // 当前运势分析
        return `您当前正处于${gender === 'male' ? '戊寅' : '丁丑'}大运（2020-2030年），这个大运加强了土和木的力量。今年是癸卯年，水木旺盛，对您来说既有帮助也有挑战。`;
    }
    
    function getDecadeLuckSummary(lunar, gender) {
        // 大运总结
        return `您的大运走势如下（${gender === 'male' ? '男命顺排' : '女命逆排'}），每十年一个大运：`;
    }
    
    function generateDecadeLuckTimeline(lunar, gender) {
        // 生成大运时间线
        let timelineHTML = '';
        const decades = [
            { year: "2020-2030", luck: "戊寅", analysis: "土木大运，事业发展期但压力较大" },
            { year: "2030-2040", luck: "己卯", analysis: "土木大运，财运提升但需注意健康" },
            { year: "2040-2050", luck: "庚辰", analysis: "金土大运，事业稳定收获期" },
            { year: "2050-2060", luck: "辛巳", analysis: "金火大运，变动较多需灵活应对" }
        ];
        
        decades.forEach(decade => {
            timelineHTML += `
                <div class="timeline-item">
                    <div class="timeline-year">${decade.year} (${decade.luck}运)</div>
                    <div class="timeline-content">${decade.analysis}</div>
                </div>
            `;
        });
        
        return timelineHTML;
    }
    
    function getYearLuckAnalysis(lunar) {
        // 流年分析总结
        return "未来几年的流年运势如下，供您参考规划：";
    }
    
    function generateNextYearsLuck(lunar) {
        // 生成未来几年运势
        const currentYear = new Date().getFullYear();
        let yearsHTML = '';
        
        for (let i = 0; i < 5; i++) {
            const year = currentYear + i;
            const ganZhi = getYearGanZhi(year);
            yearsHTML += `
                <div class="analysis-item">
                    <div class="analysis-item-title">${year}年 (${ganZhi})</div>
                    <div class="analysis-item-content">${getSingleYearLuck(lunar, year)}</div>
                </div>
            `;
        }
        
        return yearsHTML;
    }
    
    function getSingleYearLuck(lunar, year) {
        // 单个年份运势
        const lucks = [
            "事业有新发展机会，但需注意人际关系",
            "财运较好，适合投资理财",
            "变动较大，宜守不宜攻",
            "学习运佳，适合提升自我",
            "健康需注意，工作压力较大"
        ];
        return lucks[year % 5];
    }

    // 八字学习建议
    function getLearningSuggestions(lunar) {
        // 学习建议
        return "根据您的八字特点，以下是针对性的学习建议：";
    }
    
    function getRecommendedTopics(lunar) {
        // 推荐学习重点
        return "1. 五行平衡理论\n2. 十神关系分析\n3. 大运流年推算\n4. 用神取用方法";
    }
    
    function getLearningTips(lunar) {
        // 学习技巧
        return "1. 从基础五行开始学习\n2. 多做实际案例分析\n3. 结合自身八字理解理论\n4. 参加交流讨论提升理解";
    }

    /* ==================== 工具函数 ==================== */

    // 十神计算
   function getTenGod(dayGan, target) {
    const ganList = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    
    // 如果是地支，获取其主气天干
    if (!ganList.includes(target)) {
        target = getMainQi(target);
        if (!target) return '未知';
    }
    
    const dayIndex = ganList.indexOf(dayGan);
    const targetIndex = ganList.indexOf(target);
    
    if (dayIndex === -1 || targetIndex === -1) return '未知';
    
    const diff = (targetIndex - dayIndex + 10) % 10;
    
    // 修正十神顺序
    const tenGods = [
        '比肩', '劫财', '食神', '伤官', 
        '偏财', '正财', '七杀', '正官', 
        '偏印', '正印'
    ];
    
    return tenGods[diff] || '未知';
}

    // 地支主气
    function getMainQi(zhi) {
        const qiMap = {
            '子': '癸', '丑': '己', '寅': '甲', '卯': '乙',
            '辰': '戊', '巳': '丙', '午': '丁', '未': '己',
            '申': '庚', '酉': '辛', '戌': '戊', '亥': '壬'
        };
        return qiMap[zhi] || null;
    }

    // 藏干
    function getHiddenStems(zhi) {
        const hiddenMap = {
            '子': ['癸'],
            '丑': ['己', '癸', '辛'],
            '寅': ['甲', '丙', '戊'],
            '卯': ['乙'],
            '辰': ['戊', '乙', '癸'],
            '巳': ['丙', '戊', '庚'],
            '午': ['丁', '己'],
            '未': ['己', '丁', '乙'],
            '申': ['庚', '壬', '戊'],
            '酉': ['辛'],
            '戌': ['戊', '辛', '丁'],
            '亥': ['壬', '甲']
        };
        return hiddenMap[zhi] || [];
    }

    // 空亡计算
    function getVoid(zhi) {
        const branchOrder = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        const index = branchOrder.indexOf(zhi);
        if (index === -1) return '';
        
        const void1 = (index + 10) % 12;
        const void2 = (index + 11) % 12;
        return branchOrder[void1] + branchOrder[void2];
    }

    // 纳音五行
    function getNaYin(ganZhi) {
        const gan = ganZhi.substring(0, 1);
        const zhi = ganZhi.substring(1);
        
        const ganIndex = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'].indexOf(gan);
        const zhiIndex = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'].indexOf(zhi);
        
        if (ganIndex === -1 || zhiIndex === -1) return '';
        
        const naYinTable = [
            ['海中金', '海中金', '炉中火', '炉中火', '大林木', '大林木', '路旁土', '路旁土', '剑锋金', '剑锋金', '山头火', '山头火'],
            ['涧下水', '涧下水', '城头土', '城头土', '白蜡金', '白蜡金', '杨柳木', '杨柳木', '泉中水', '泉中水', '屋上土', '屋上土'],
            ['霹雳火', '霹雳火', '松柏木', '松柏木', '长流水', '长流水', '砂中金', '砂中金', '山下火', '山下火', '平地木', '平地木'],
            ['壁上土', '壁上土', '金箔金', '金箔金', '覆灯火', '覆灯火', '天河水', '天河水', '大驿土', '大驿土', '钗钏金', '钗钏金'],
            ['桑柘木', '桑柘木', '大溪水', '大溪水', '沙中土', '沙中土', '天上火', '天上火', '石榴木', '石榴木', '大海水', '大海水']
        ];
        
        return naYinTable[Math.floor(ganIndex / 2)][zhiIndex] || '';
    }

    // 获取年干支（简化版）
    function getYearGanZhi(year) {
        const gan = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];
        const zhi = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
        return gan[year % 10] + zhi[year % 12];
    }
});
    </script>
</body>
</html>
