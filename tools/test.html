<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字排盘系统</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="date"],
        input[type="time"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .gender-options {
            display: flex;
            gap: 15px;
        }
        .gender-option {
            display: flex;
            align-items: center;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #result-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        .pillars-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .pillar {
            text-align: center;
            margin: 10px;
            min-width: 80px;
        }
        .stem {
            font-weight: bold;
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        .branch {
            font-size: 1.2em;
        }
        .day-master {
            font-size: 0.8em;
            color: #7f8c8d;
        }
        .tengod {
            font-size: 0.9em;
            color: #e74c3c;
            margin-top: 5px;
        }
        .wuxing-container {
            display: flex;
            height: 200px;
            align-items: flex-end;
            justify-content: center;
            margin: 30px 0;
            gap: 15px;
        }
        .wuxing-item {
            text-align: center;
            width: 60px;
        }
        .wuxing-bar {
            width: 100%;
            transition: height 0.5s;
            margin: 0 auto;
            border-radius: 5px 5px 0 0;
        }
        .wuxing-label {
            margin-top: 5px;
            font-weight: bold;
        }
        .analysis-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .analysis-card h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .analysis-card ul {
            padding-left: 20px;
        }
        .analysis-card li {
            margin-bottom: 8px;
        }
        @media (max-width: 600px) {
            .pillars-container {
                flex-direction: column;
                align-items: center;
            }
            .wuxing-container {
                flex-wrap: wrap;
                height: auto;
                align-items: flex-start;
            }
            .wuxing-item {
                width: 40px;
            }
        }
    </style>
</head>
<body>
    <h1>八字排盘系统</h1>
    
    <div class="form-container">
        <form id="bazi-form">
            <div class="form-group">
                <label for="birth-date">出生日期</label>
                <input type="date" id="birth-date" required>
            </div>
            
            <div class="form-group">
                <label for="birth-time">出生时间</label>
                <input type="time" id="birth-time" required>
            </div>
            
            <div class="form-group">
                <label>性别</label>
                <div class="gender-options">
                    <div class="gender-option">
                        <input type="radio" id="gender-male" name="gender" value="male" checked>
                        <label for="gender-male">男</label>
                    </div>
                    <div class="gender-option">
                        <input type="radio" id="gender-female" name="gender" value="female">
                        <label for="gender-female">女</label>
                    </div>
                </div>
            </div>
            
            <button type="submit">开始排盘</button>
        </form>
    </div>
    
    <div id="result-section">
        <h2>四柱排盘</h2>
        <div class="pillars-container">
            <div id="year-pillar" class="pillar">
                <!-- 年柱将通过JS动态生成 -->
            </div>
            <div id="month-pillar" class="pillar">
                <!-- 月柱将通过JS动态生成 -->
            </div>
            <div id="day-pillar" class="pillar">
                <!-- 日柱将通过JS动态生成 -->
            </div>
            <div id="hour-pillar" class="pillar">
                <!-- 时柱将通过JS动态生成 -->
            </div>
        </div>
        
        <h2>五行力量分析</h2>
        <div id="wuxing-result"></div>
        
        <h2>日主强弱分析</h2>
        <div id="strength-result"></div>
    </div>

    <script>
        // ====================== 常量定义 ======================
        const STEMS = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        const BRANCHES = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        const WUXING_MAP = {
            '甲': '木', '乙': '木', '丙': '火', '丁': '火',
            '戊': '土', '己': '土', '庚': '金', '辛': '金',
            '壬': '水', '癸': '水',
            '寅': '木', '卯': '木', '巳': '火', '午': '火',
            '辰': '土', '戌': '土', '丑': '土', '未': '土',
            '申': '金', '酉': '金', '亥': '水', '子': '水'
        };
        const COLOR_MAP = {
            '木': '#4CAF50', '火': '#F44336', '土': '#FFC107',
            '金': '#9E9E9E', '水': '#2196F3'
        };

        // ====================== 工具函数 ======================
        function isSecureEnvironment() {
            try {
                new Function('return intrinsics.%DatePrototype%.toTemporalInstant')();
                return false;
            } catch (e) {
                return true;
            }
        }

        function getCurrentTimeZone() {
            try {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            } catch (e) {
                return 'Asia/Shanghai';
            }
        }

        // ====================== 核心排盘计算 ======================
        class BaziCalculator {
            static calculate(birthDate, birthTime, gender) {
                if (!birthDate || !birthTime) {
                    throw new Error('请输入完整的出生日期和时间');
                }

                const date = this.parseDate(birthDate, birthTime);
                const lunarDate = this.toLunarDate(date);

                const pillars = {
                    year: this.calculateYearPillar(lunarDate.year),
                    month: this.calculateMonthPillar(date, lunarDate),
                    day: this.calculateDayPillar(date),
                    hour: this.calculateHourPillar(date, birthTime)
                };

                this.calculateTenGods(pillars);

                return {
                    date: birthDate,
                    time: birthTime,
                    gender: gender,
                    pillars: pillars,
                    elements: this.calculateElements(pillars),
                    strength: this.calculateStrength(pillars)
                };
            }

            static parseDate(dateStr, timeStr) {
                if (isSecureEnvironment()) {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return new Date(year, month - 1, day, hours, minutes);
                } else {
                    return new Date(`${dateStr}T${timeStr}:00`);
                }
            }

            static toLunarDate(solarDate) {
                const year = solarDate.getFullYear();
                const month = solarDate.getMonth() + 1;
                const day = solarDate.getDate();
                
                return {
                    year: year,
                    month: month > 2 ? month - 1 : 12,
                    day: day,
                    isLeap: false
                };
            }

            static calculateYearPillar(year) {
                const stemIdx = (year - 4) % 10;
                const branchIdx = (year - 4) % 12;
                return this.buildPillar(stemIdx, branchIdx);
            }

            static calculateMonthPillar(solarDate, lunarDate) {
                const month = solarDate.getMonth() + 1;
                const stemIdx = (lunarDate.year * 2 + month + 2) % 10;
                const branchIdx = (month + 1) % 12;
                return this.buildPillar(stemIdx, branchIdx);
            }

            static calculateDayPillar(solarDate) {
                const year = solarDate.getFullYear();
                const days = Math.floor((year - 1900) * 365 + (year - 1897)/4 + 
                             solarDate.getDate() - 30);
                const stemIdx = days % 10;
                const branchIdx = days % 12;
                return this.buildPillar(stemIdx, branchIdx);
            }

            static calculateHourPillar(solarDate, timeStr) {
                const [hours] = timeStr.split(':').map(Number);
                const dayStem = STEMS.indexOf(this.calculateDayPillar(solarDate).stem);
                const branchIdx = Math.floor((hours + 1) / 2) % 12;
                const stemIdx = (dayStem % 5 * 2 + branchIdx) % 10;
                return this.buildPillar(stemIdx, branchIdx);
            }

            static buildPillar(stemIdx, branchIdx) {
                const stem = STEMS[stemIdx];
                const branch = BRANCHES[branchIdx];
                return {
                    stem: stem,
                    branch: branch,
                    wuxing: WUXING_MAP[stem],
                    element: WUXING_MAP[branch],
                    tengod: ''
                };
            }

            static calculateTenGods(pillars) {
                const dayStem = pillars.day.stem;
                const relations = {
                    '甲': { '甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财',
                          '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印' },
                    '乙': { '甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财',
                          '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印' },
                    '丙': { '甲':'偏印', '乙':'正印', '丙':'比肩', '丁':'劫财', '戊':'食神',
                          '己':'伤官', '庚':'偏财', '辛':'正财', '壬':'七杀', '癸':'正官' },
                    '丁': { '甲':'正印', '乙':'偏印', '丙':'劫财', '丁':'比肩', '戊':'伤官',
                          '己':'食神', '庚':'正财', '辛':'偏财', '壬':'正官', '癸':'七杀' },
                    '戊': { '甲':'七杀', '乙':'正官', '丙':'偏印', '丁':'正印', '戊':'比肩',
                          '己':'劫财', '庚':'食神', '辛':'伤官', '壬':'偏财', '癸':'正财' },
                    '己': { '甲':'正官', '乙':'七杀', '丙':'正印', '丁':'偏印', '戊':'劫财',
                          '己':'比肩', '庚':'伤官', '辛':'食神', '壬':'正财', '癸':'偏财' },
                    '庚': { '甲':'偏财', '乙':'正财', '丙':'七杀', '丁':'正官', '戊':'偏印',
                          '己':'正印', '庚':'比肩', '辛':'劫财', '壬':'食神', '癸':'伤官' },
                    '辛': { '甲':'正财', '乙':'偏财', '丙':'正官', '丁':'七杀', '戊':'正印',
                          '己':'偏印', '庚':'劫财', '辛':'比肩', '壬':'伤官', '癸':'食神' },
                    '壬': { '甲':'食神', '乙':'伤官', '丙':'偏财', '丁':'正财', '戊':'七杀',
                          '己':'正官', '庚':'偏印', '辛':'正印', '壬':'比肩', '癸':'劫财' },
                    '癸': { '甲':'伤官', '乙':'食神', '丙':'正财', '丁':'偏财', '戊':'正官',
                          '己':'七杀', '庚':'正印', '辛':'偏印', '壬':'劫财', '癸':'比肩' }
                };
                
                ['year', 'month', 'hour'].forEach(type => {
                    pillars[type].tengod = relations[dayStem]?.[pillars[type].stem] || '未知';
                });
            }

            static calculateElements(pillars) {
                const elements = { '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 };
                
                Object.values(pillars).forEach(pillar => {
                    elements[pillar.wuxing] += 1;
                    elements[pillar.element] += 0.5;
                });
                
                return elements;
            }

            static calculateStrength(pillars) {
                const day = pillars.day;
                let score = 0;
                
                if (pillars.month.element === day.wuxing) score += 2;
                
                ['year', 'month', 'hour'].forEach(type => {
                    const pillar = pillars[type];
                    if (pillar.tengod.includes('印') || pillar.tengod.includes('比')) {
                        score += 1;
                    }
                });
                
                return score >= 3 ? '强' : '弱';
            }
        }

        // ====================== 界面渲染 ======================
        class BaziRenderer {
            static init() {
                this.setDefaultDate();
                document.getElementById('bazi-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });
            }

            static setDefaultDate() {
                const today = new Date();
                document.getElementById('birth-date').value = 
                    `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            }

            static handleSubmit() {
                try {
                    const formData = {
                        date: document.getElementById('birth-date').value,
                        time: document.getElementById('birth-time').value,
                        gender: document.querySelector('input[name="gender"]:checked').value
                    };
                    
                    const result = BaziCalculator.calculate(
                        formData.date, 
                        formData.time, 
                        formData.gender
                    );
                    
                    this.renderResult(result);
                } catch (error) {
                    alert(error.message);
                    console.error(error);
                }
            }

            static renderResult(data) {
                this.renderPillars(data.pillars);
                this.renderElements(data.elements);
                this.renderStrengthAnalysis(data);
                document.getElementById('result-section').style.display = 'block';
            }

            static renderPillars(pillars) {
                ['year', 'month', 'day', 'hour'].forEach(type => {
                    const pillar = pillars[type];
                    const element = document.getElementById(`${type}-pillar`);
                    if (element) {
                        element.innerHTML = `
                            <div class="stem" style="color:${COLOR_MAP[pillar.wuxing]}">${pillar.stem}</div>
                            <div class="branch">${pillar.branch}</div>
                            ${type === 'day' ? '<div class="day-master">(日元)</div>' : ''}
                            <div class="tengod">${pillar.tengod}</div>
                    `;
                }
            });
        }

        static renderElements(elements) {
            let html = '<div class="wuxing-container">';
            Object.entries(elements).forEach(([name, value]) => {
                const width = Math.min(100, value * 20);
                html += `
                    <div class="wuxing-item">
                        <div class="wuxing-bar" 
                             style="height:${width}%;background:${COLOR_MAP[name]};">
                        </div>
                        <div class="wuxing-label" style="color:${COLOR_MAP[name]}">
                            ${name} (${value.toFixed(1)})
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('wuxing-result').innerHTML = html;

            // 添加动画效果
            setTimeout(() => {
                const bars = document.querySelectorAll('.wuxing-bar');
                bars.forEach(bar => {
                    const height = bar.style.height;
                    bar.style.height = '0';
                    setTimeout(() => {
                        bar.style.height = height;
                    }, 100);
                });
            }, 50);
        }

        static renderStrengthAnalysis(data) {
            const day = data.pillars.day;
            document.getElementById('strength-result').innerHTML = `
                <div class="analysis-card">
                    <h3 style="color:${COLOR_MAP[day.wuxing]}">
                        ${day.stem}${day.wuxing}日主 · ${data.strength}格局
                    </h3>
                    <ul>
                        <li><strong>月令影响：</strong>${this.getMonthEffect(data)}</li>
                        <li><strong>天干支持：</strong>${this.getStemSupport(data)}</li>
                        <li><strong>地支根基：</strong>${this.getBranchSupport(data)}</li>
                        <li><strong>综合判断：</strong>${this.getStrengthConclusion(data)}</li>
                    </ul>
                </div>
            `;
        }

        static getMonthEffect(data) {
            const dayWuxing = data.pillars.day.wuxing;
            const monthWuxing = data.pillars.month.element;
            
            if (monthWuxing === dayWuxing) {
                return `月令${monthWuxing}气旺，得令强根`;
            } else if (this.isGenerating(monthWuxing, dayWuxing)) {
                return `月令${monthWuxing}生${dayWuxing}，得生助`;
            } else if (this.isOvercoming(monthWuxing, dayWuxing)) {
                return `月令${monthWuxing}克${dayWuxing}，受制约`;
            } else {
                return `月令${monthWuxing}与日主${dayWuxing}无直接关系`;
            }
        }

        static getStemSupport(data) {
            const supports = [];
            ['year', 'month', 'hour'].forEach(type => {
                const pillar = data.pillars[type];
                if (pillar.tengod.includes('印') || pillar.tengod.includes('比')) {
                    supports.push(`${pillar.stem}(${pillar.tengod})`);
                }
            });
            
            return supports.length > 0 
                ? `得天干${supports.join('、')}支持` 
                : '天干无生助';
        }

        static getBranchSupport(data) {
            const dayWuxing = data.pillars.day.wuxing;
            const branches = [];
            
            ['year', 'month', 'hour'].forEach(type => {
                const element = data.pillars[type].element;
                if (element === dayWuxing) {
                    branches.push(data.pillars[type].branch);
                }
            });
            
            return branches.length > 0
                ? `地支${branches.join('、')}含${dayWuxing}气`
                : '地支无同五行根基';
        }

        static getStrengthConclusion(data) {
            const day = data.pillars.day;
            const strength = data.strength;
            const gender = data.gender;
            
            if (strength === '强') {
                return `${day.wuxing}日主身强，${gender === 'male' ? '宜' : '宜'}克泄耗`;
            } else {
                return `${day.wuxing}日主身弱，${gender === 'male' ? '宜' : '宜'}生扶`;
            }
        }

        static isGenerating(source, target) {
            const generatingCycle = {
                '木': '火',
                '火': '土',
                '土': '金',
                '金': '水',
                '水': '木'
            };
            return generatingCycle[source] === target;
        }

        static isOvercoming(source, target) {
            const overcomingCycle = {
                '木': '土',
                '土': '水',
                '水': '火',
                '火': '金',
                '金': '木'
            };
            return overcomingCycle[source] === target;
        }
    }

    // ====================== 初始化 ======================
    document.addEventListener('DOMContentLoaded', () => {
        BaziRenderer.init();
    });
</script>
