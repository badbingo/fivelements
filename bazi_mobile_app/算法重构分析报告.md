# 八字强度计算算法重构分析报告

## 目标
将Flutter应用的算法系统完全改为与baziphone.html一致的从格优先判断体系，确保所有得分数据完全一致。

## 核心算法差异分析

### 1. baziphone.html的从格优先算法

#### 核心判断逻辑（determineStrengthType函数）
```javascript
// 1. 特殊格局优先判断
const specialPattern = checkSpecialPatterns();
if (specialPattern) return specialPattern;

// 2. 从格判断
if (isTrueCongWeak()) return "从弱";
if (isTrueCongStrong()) return "从强";

// 3. 普通身强身弱
return scores.support > scores.weaken ? "身强" : "身弱";
```

#### 从弱格判断条件
```javascript
function isTrueCongWeak() {
    // 三重判断条件
    const condition1 = scores.weaken > scores.support * 2.5;  // 常规从弱
    const condition2 = scores.weaken > scores.support * 2 && !seasonMatch; // 不得令
    const condition3 = scores.weaken > scores.support * 1.8 && extremeWeaken; // 特殊弱势
    
    return rootStatus === '无根' && (condition1 || condition2 || condition3);
}
```

#### 从强格判断条件
```javascript
function isTrueCongStrong() {
    return rootStatus === '有根' && 
           scores.support > scores.weaken * 2 && 
           seasonMatch;
}
```

#### 力量计算特点
1. **天干力量**：基础1.5分，合化成功按新五行计算
2. **地支藏干**：主气0.6分，中气0.3分，余气0.1分
3. **月令加倍**：月支力量×2
4. **透干加成**：透干的藏干×1.3
5. **合化权重**：三会1.5倍，三合1.2倍，六合1.0倍

### 2. Flutter应用的百分比算法

#### 核心判断逻辑
```dart
// 1. 计算强度百分比
double strengthPercentage = _calculateStrengthPercentage(
  supportStrength,
  weakenStrength,
  monthScore,
);

// 2. 从格判断（简单阈值）
bool isFollowingPattern = strengthPercentage <= 15.0;

// 3. 12级分类系统
Map<String, dynamic> levelResult = _calculateStrengthLevel(...);
```

#### 力量计算特点
1. **天干力量**：统一1.0分
2. **地支藏干**：使用固定权重映射
3. **生克权重**：生我0.8，我生0.6，我克0.7，克我0.9
4. **月令得分**：独立计算后转换为力量点数

## 关键差异总结

| 方面 | baziphone.html | Flutter应用 | 影响 |
|------|----------------|-------------|------|
| **判断优先级** | 从格优先 | 百分比优先 | 核心差异 |
| **从格条件** | 多重复杂条件 | 简单阈值15% | 判断准确性 |
| **力量计算** | 精细化权重 | 简化权重 | 数值差异 |
| **根气判断** | 动态检测合化影响 | 静态判断 | 从格准确性 |
| **季节匹配** | 影响从格判断 | 仅影响月令得分 | 判断逻辑 |
| **合化处理** | 完整合化逻辑 | 基础合化检测 | 力量计算 |

## 重构实施方案

### 阶段1：核心算法重构
1. **替换判断逻辑**：从百分比优先改为从格优先
2. **实现根气检测**：动态判断日主是否有根
3. **添加季节匹配**：判断日主是否得令
4. **完善从格条件**：实现多重判断条件

### 阶段2：力量计算同步
1. **统一天干权重**：天干基础1.5分
2. **精细化藏干**：主气0.6，中气0.3，余气0.1
3. **透干加成机制**：透干藏干×1.3
4. **合化权重调整**：三会1.5倍，三合1.2倍

### 阶段3：特殊格局实现
1. **专旺格判断**：同类五行≥6个
2. **从财格细分**：财星主导的从弱格
3. **从官格细分**：官杀主导的从弱格
4. **从儿格细分**：食伤主导的从弱格

### 阶段4：验证测试
1. **对比测试**：多个八字案例验证
2. **数据一致性**：确保所有得分完全一致
3. **边界情况**：测试极端八字组合
4. **性能优化**：确保计算效率

## 预期效果

重构完成后，Flutter应用将：
1. **判断逻辑**：与baziphone.html完全一致
2. **数值结果**：所有得分数据完全相同
3. **格局识别**：准确识别各种特殊格局
4. **用户体验**：提供更准确的八字分析

---
*报告生成时间: 2024年12月*
*分析对象: baziphone.html vs Flutter应用*