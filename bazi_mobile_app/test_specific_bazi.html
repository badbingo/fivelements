<!DOCTYPE html>
<html>
<head>
    <title>测试特定八字：壬子癸丑己巳癸酉</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>测试特定八字：壬子癸丑己巳癸酉</h1>
    <div id="results"></div>
    
    <script>
        // 基础映射
        const stemElementMap = {
            '甲': 'wood', '乙': 'wood', '丙': 'fire', '丁': 'fire', '戊': 'earth',
            '己': 'earth', '庚': 'metal', '辛': 'metal', '壬': 'water', '癸': 'water'
        };
        
        const branchElementMap = {
            '子': 'water', '丑': 'earth', '寅': 'wood', '卯': 'wood', '辰': 'earth',
            '巳': 'fire', '午': 'fire', '未': 'earth', '申': 'metal', '酉': 'metal',
            '戌': 'earth', '亥': 'water'
        };
        
        // 地支藏干映射（与baziphone.html一致）
        const BRANCH_ELEMENTS = {
            '子': { main: 'water', hidden: ['癸'] },
            '丑': { main: 'earth', hidden: ['己', '癸', '辛'] },
            '寅': { main: 'wood', hidden: ['甲', '丙', '戊'] },
            '卯': { main: 'wood', hidden: ['乙'] },
            '辰': { main: 'earth', hidden: ['戊', '乙', '癸'] },
            '巳': { main: 'fire', hidden: ['丙', '庚', '戊'] },
            '午': { main: 'fire', hidden: ['丁', '己'] },
            '未': { main: 'earth', hidden: ['己', '丁', '乙'] },
            '申': { main: 'metal', hidden: ['庚', '壬', '戊'] },
            '酉': { main: 'metal', hidden: ['辛'] },
            '戌': { main: 'earth', hidden: ['戊', '辛', '丁'] },
            '亥': { main: 'water', hidden: ['壬', '甲'] }
        };
        
        // 测试八字
        const stems = ['壬', '癸', '己', '癸'];
        const branches = ['子', '丑', '巳', '酉'];
        const dayMaster = '己'; // 日干
        const dayMasterElement = 'earth';
        
        console.log('=== 开始计算特定八字：壬子癸丑己巳癸酉 ===');
        console.log('日干：', dayMaster, '(', dayMasterElement, ')');
        
        // 模拟baziphone.html的calculateEnhancedElements方法
        function calculateEnhancedElements() {
            const elements = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            
            console.log('\n--- 计算天干五行 ---');
            // 1. 计算天干五行
            stems.forEach((stem, index) => {
                const element = stemElementMap[stem];
                if (element) {
                    elements[element] += 1;
                    const position = ['年', '月', '日', '时'][index];
                    console.log(`${position}干${stem}(${element}) +1`);
                }
            });
            
            console.log('\n--- 计算地支主气 ---');
            // 2. 计算地支主气
            branches.forEach((branch, index) => {
                const element = branchElementMap[branch];
                if (element) {
                    elements[element] += 1;
                    const position = ['年', '月', '日', '时'][index];
                    console.log(`${position}支${branch}(${element}) +1`);
                }
            });
            
            console.log('\n--- 计算地支藏干（0.5权重系统）---');
            // 3. 计算地支藏干（使用baziphone.html的0.5权重系统）
            branches.forEach((branch, branchIndex) => {
                const branchInfo = BRANCH_ELEMENTS[branch];
                if (branchInfo && branchInfo.hidden) {
                    branchInfo.hidden.forEach((hiddenStem, stemIndex) => {
                        const element = stemElementMap[hiddenStem];
                        if (element) {
                            // baziphone.html中calculateEnhancedElements使用固定0.5权重
                            const weight = 0.5;
                            elements[element] += weight;
                            const position = ['年', '月', '日', '时'][branchIndex];
                            console.log(`${position}支${branch}藏${hiddenStem}(${element}) +${weight}`);
                        }
                    });
                }
            });
            
            console.log('\n--- 应用巳酉丑三合金局影响 ---');
            // 4. 应用巳酉丑三合金局影响
            const siYouChou = ['巳', '酉', '丑'];
            const foundBranches = siYouChou.filter(branch => branches.includes(branch));
            
            if (foundBranches.length >= 2) {
                const isComplete = foundBranches.length === 3;
                const strengthBonus = isComplete ? 1.0 : 0.6;
                
                elements['metal'] += strengthBonus; // 增强金力
                elements['water'] += strengthBonus * 0.5; // 金生水
                elements['fire'] = Math.max(0, elements['fire'] - 0.3); // 火被金克
                
                console.log(`${isComplete ? '全' : '半'}三合金局：金力+${strengthBonus}，水力+${strengthBonus * 0.5}，火力-0.3`);
                
                // 如果丑土参与，额外减弱土力
                if (foundBranches.includes('丑')) {
                    const reduction = isComplete ? 0.7 : 0.5;
                    elements['earth'] = Math.max(0, elements['earth'] - reduction);
                    console.log(`丑土参与合金局，土力额外减弱${reduction}`);
                }
            }
            
            return elements;
        }
        
        // 计算五行分布
        const elements = calculateEnhancedElements();
        
        console.log('\n=== 五行分布结果 ===');
        Object.entries(elements).forEach(([element, value]) => {
            console.log(`${element}: ${value}`);
        });
        
        // 计算月令得分
        function calculateMonthScore() {
            const monthBranch = '丑'; // 月支
            const dayElement = 'earth'; // 日主五行
            
            console.log('\n--- 计算月令得分 ---');
            
            // 检查巳酉丑三合金局
            const siYouChou = ['巳', '酉', '丑'];
            const foundBranches = siYouChou.filter(branch => branches.includes(branch));
            
            if (foundBranches.length >= 2 && foundBranches.includes('丑') && dayElement === 'earth') {
                console.log('特别处理：巳酉丑三合金对己土日主的影响，月令得分 -30');
                return -30;
            }
            
            // 检查子丑合土
            const hasZiChou = branches.includes('子') && branches.includes('丑');
            if (hasZiChou && dayElement === 'earth') {
                console.log('子丑合土调整：丑月土日主得到子丑合土增强，月令得分 -10');
                return -10;
            }
            
            // 基础月令得分（丑土对己土日主）
            return 40; // 得令
        }
        
        const monthScore = calculateMonthScore();
        console.log('月令得分:', monthScore);
        
        // 计算生扶克泄力量
        function calculateStrengths(elements, dayMasterElement, monthScore) {
            const supportElements = [];
            const weakenElements = [];
            
            // 根据五行相生相克关系分类
            switch (dayMasterElement) {
                case 'earth':
                    supportElements.push('fire', 'earth'); // 火生土，土比肩
                    weakenElements.push('wood', 'metal', 'water'); // 木克土，土生金，水克火
                    break;
            }
            
            let supportStrength = 0;
            let weakenStrength = 0;
            
            supportElements.forEach(element => {
                supportStrength += elements[element] || 0;
            });
            
            weakenElements.forEach(element => {
                weakenStrength += elements[element] || 0;
            });
            
            console.log(`初始计算 - 生扶力量:${supportStrength}, 克泄力量:${weakenStrength}`);
            
            // 将月令得分转换为力量点数并加入计算
            if (monthScore > 0) {
                // 正分加入生扶力量
                supportStrength += monthScore / 10;
                console.log(`月令得分${monthScore}分转换为生扶力量: +${monthScore / 10}`);
            } else if (monthScore < 0) {
                // 负分加入克泄力量
                weakenStrength += Math.abs(monthScore) / 10;
                console.log(`月令得分${monthScore}分转换为克泄力量: +${Math.abs(monthScore) / 10}`);
            }
            
            console.log(`加入月令得分后 - 生扶力量:${supportStrength}, 克泄力量:${weakenStrength}`);
            
            // 计算合化影响
            console.log('\n--- 计算合化影响 ---');
            
            // 巳酉丑三合金局
            const siYouChou = ['巳', '酉', '丑'];
            const foundBranches = siYouChou.filter(branch => branches.includes(branch));
            
            if (foundBranches.length >= 2) {
                const isComplete = foundBranches.length === 3;
                const multiplier = isComplete ? 6 : 3; // 全三合6分，半三合3分
                
                // 金克土，增加克泄力量
                weakenStrength += multiplier;
                console.log(`${isComplete ? '全' : '半'}三合金局：增加克泄力量 ${multiplier}`);
                
                // 特殊处理：巳酉丑三合金对己土日主的额外影响
                if (dayMasterElement === 'earth') {
                    const extraWeaken = 3;
                    weakenStrength += extraWeaken;
                    console.log(`巳酉丑三合金对己土日主的特殊影响，额外增加克泄力量 ${extraWeaken}`);
                }
            }
            
            console.log(`加入合化影响后 - 生扶力量:${supportStrength}, 克泄力量:${weakenStrength}`);
            
            return { supportStrength, weakenStrength };
        }
        
        const { supportStrength, weakenStrength } = calculateStrengths(elements, dayMasterElement, monthScore);
        const totalStrength = supportStrength + weakenStrength;
        const strengthPercentage = totalStrength > 0 ? (supportStrength / totalStrength * 100) : 0;
        
        console.log('\n=== 力量计算结果 ===');
        console.log('生扶力量:', supportStrength.toFixed(2));
        console.log('克泄力量:', weakenStrength.toFixed(2));
        console.log('强度百分比:', strengthPercentage.toFixed(2) + '%');
        
        console.log('\n=== 期望值对比 ===');
        console.log('期望生扶力量: 2.63');
        console.log('期望克泄力量: 19.63');
        console.log('期望强度百分比: 11.80%');
        
        console.log('\n=== 差异分析 ===');
        console.log('生扶力量差异:', (supportStrength - 2.63).toFixed(2));
        console.log('克泄力量差异:', (weakenStrength - 19.63).toFixed(2));
        console.log('强度百分比差异:', (strengthPercentage - 11.80).toFixed(2) + '%');
        
        // 显示结果到页面
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
            <h2>计算结果</h2>
            <p><strong>生扶力量:</strong> ${supportStrength.toFixed(2)} (期望: 2.63)</p>
            <p><strong>克泄力量:</strong> ${weakenStrength.toFixed(2)} (期望: 19.63)</p>
            <p><strong>强度百分比:</strong> ${strengthPercentage.toFixed(2)}% (期望: 11.80%)</p>
            
            <h2>差异分析</h2>
            <p><strong>生扶力量差异:</strong> ${(supportStrength - 2.63).toFixed(2)}</p>
            <p><strong>克泄力量差异:</strong> ${(weakenStrength - 19.63).toFixed(2)}</p>
            <p><strong>强度百分比差异:</strong> ${(strengthPercentage - 11.80).toFixed(2)}%</p>
            
            <p><em>详细计算过程请查看浏览器控制台</em></p>
        `;
    </script>
</body>
</html>