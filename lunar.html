<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字排盘系统</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #8B4513;
            margin-bottom: 30px;
        }
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #8B4513;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #A0522D;
        }
        .result {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 5px solid #8B4513;
            display: none;
        }
        .bazi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        .bazi-cell {
            text-align: center;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .year-cell {
            background-color: #F0E68C;
        }
        .month-cell {
            background-color: #98FB98;
        }
        .day-cell {
            background-color: #ADD8E6;
        }
        .hour-cell {
            background-color: #FFB6C1;
        }
        .title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .ganzhi {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        .wuxing {
            color: #8B4513;
            font-size: 16px;
            font-weight: bold;
        }
        .canggan {
            font-size: 14px;
            color: #666;
            margin: 8px 0;
            min-height: 20px;
        }
        .shishen {
            font-size: 16px;
            color: #8B4513;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #777;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .info-section {
            margin-bottom: 20px;
        }
        .info-section h3 {
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            color: #8B4513;
        }
        .error {
            color: red;
            margin-top: 10px;
            display: none;
        }
        .timezone-note {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .retry-section {
            display: none;
            margin-top: 20px;
        }
        .manual-load {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .success-message {
            color: green;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>八字排盘系统</h1>
        
        <div id="loading" class="loading">
            <p>正在加载八字计算库，请稍候...</p>
            <div id="retry-section" class="retry-section">
                <button onclick="retryLoadLibrary()">重试加载</button>
                <p>或<a href="javascript:void(0)" onclick="showManualLoad()">手动加载库文件</a></p>
                <div id="manual-load" class="manual-load">
                    <p><strong>手动加载步骤：</strong></p>
                    <p>1. 下载库文件：<a href="https://cdn.jsdelivr.net/npm/lunar-javascript@1.5.5/dist/lunar.min.js" download="lunar.min.js">lunar.min.js</a></p>
                    <p>2. 将文件放在与此HTML文件相同的目录下</p>
                    <p>3. 刷新页面</p>
                </div>
            </div>
        </div>
        
        <div id="app-content" style="display:none;">
            <div class="success-message">资源加载成功！请输入您的出生信息</div>
            
            <div class="form-group">
                <label for="birthday">出生日期</label>
                <input type="date" id="birthday" required>
                <div class="timezone-note">系统时区：<span id="timezone"></span></div>
            </div>
            
            <div class="form-group">
                <label for="time">出生时间</label>
                <input type="time" id="time" value="12:00" required>
                <div class="timezone-note">请使用24小时制</div>
            </div>
            
            <div class="form-group">
                <label for="gender">性别</label>
                <select id="gender">
                    <option value="1">男</option>
                    <option value="0">女</option>
                </select>
            </div>
            
            <button onclick="calculateBazi()">开始排盘</button>
            <div id="error-msg" class="error"></div>
            
            <div id="result" class="result">
                <h2 style="text-align: center; margin-bottom: 20px;">八字排盘结果</h2>
                <div id="bazi-grid" class="bazi-grid"></div>
                
                <div id="details">
                    <div class="info-section" id="basic-info"></div>
                    <div class="info-section" id="dayan-info"></div>
                    <div class="info-section" id="liunian-info"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>本系统使用 lunar-javascript 库计算 | © 2023 八字排盘系统</p>
    </div>

    <script>
        // 天干地支五行等常量定义
        const TIAN_GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];
        const DI_ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
        const WU_XING = ["木", "木", "火", "火", "土", "土", "金", "金", "水", "水"];
        const CANG_GAN = {
            "子": ["癸"], "丑": ["己", "癸", "辛"], "寅": ["甲", "丙", "戊"],
            "卯": ["乙"], "辰": ["戊", "乙", "癸"], "巳": ["丙", "戊", "庚"],
            "午": ["丁", "己"], "未": ["己", "丁", "乙"], "申": ["庚", "壬", "戊"],
            "酉": ["辛"], "戌": ["戊", "辛", "丁"], "亥": ["壬", "甲"]
        };
        const SHI_SHEN = ["比肩", "劫财", "食神", "伤官", "偏财", "正财", "七杀", "正官", "偏印", "正印"];
        const SHI_SHEN_COLORS = ["#8B4513", "#A0522D", "#CD853F", "#D2691E", "#B8860B", "#DAA520", "#F4A460", "#DEB887", "#BC8F8F", "#CD5C5C"];

        // 尝试多个CDN源
        const CDN_SOURCES = [
            'lunar.min.js', // 先尝试本地文件
            'https://cdn.jsdelivr.net/npm/lunar-javascript@1.5.5/dist/lunar.min.js',
            'https://unpkg.com/lunar-javascript@1.5.5/dist/lunar.min.js',
            'https://fastly.jsdelivr.net/npm/lunar-javascript@1.5.5/dist/lunar.min.js'
        ];

        let currentCdnIndex = 0;
        let libraryLoaded = false;
        
        // 显示手动加载选项
        function showManualLoad() {
            document.getElementById('manual-load').style.display = 'block';
        }
        
        // 重试加载
        function retryLoadLibrary() {
            document.getElementById('retry-section').style.display = 'none';
            document.getElementById('manual-load').style.display = 'none';
            document.getElementById('loading').innerHTML = '<p>正在重新加载资源，请稍候...</p>';
            currentCdnIndex = 0;
            loadLunarLibrary();
        }
        
        // 加载库文件
        function loadLunarLibrary() {
            if (currentCdnIndex >= CDN_SOURCES.length) {
                document.getElementById('loading').innerHTML = `
                    <p style="color:red">所有资源加载失败</p>
                    <div class="retry-section">
                        <button onclick="retryLoadLibrary()">重试加载</button>
                        <p>或<a href="javascript:void(0)" onclick="showManualLoad()">手动加载库文件</a></p>
                        <div id="manual-load" class="manual-load">
                            <p><strong>手动加载步骤：</strong></p>
                            <p>1. 下载库文件：<a href="https://cdn.jsdelivr.net/npm/lunar-javascript@1.5.5/dist/lunar.min.js" download="lunar.min.js">lunar.min.js</a></p>
                            <p>2. 将文件放在与此HTML文件相同的目录下</p>
                            <p>3. 刷新页面</p>
                        </div>
                    </div>
                `;
                document.getElementById('manual-load').style.display = 'block';
                return;
            }
            
            const script = document.createElement('script');
            script.src = CDN_SOURCES[currentCdnIndex];
            
            script.onload = function() {
                // 检查库是否真正加载成功
                if (typeof Lunar !== 'undefined' && Lunar.Solar && Lunar.Lunar) {
                    libraryLoaded = true;
                    initApp();
                } else {
                    tryNextCdn();
                }
            };
            
            script.onerror = function() {
                tryNextCdn();
            };
            
            // 设置超时（5秒）
            const timeout = setTimeout(function() {
                script.onerror();
                clearTimeout(timeout);
            }, 5000);
            
            document.head.appendChild(script);
        }
        
        // 尝试下一个CDN
        function tryNextCdn() {
            currentCdnIndex++;
            loadLunarLibrary();
        }
        
        // 初始化应用
        function initApp() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            
            // 设置默认日期范围
            const birthdayInput = document.getElementById('birthday');
            const now = new Date();
            const year = now.getFullYear();
            birthdayInput.min = "1900-01-01";
            birthdayInput.max = `${year+10}-12-31`;
            birthdayInput.value = `${year-30}-01-01`; // 默认设置为30年前
            
            // 显示时区
            document.getElementById('timezone').textContent = 
                Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            console.log('Lunar库已加载:', Lunar);
        }
        
        // 计算十神关系
        function getShiShen(dayGan, targetGan) {
            const dayIndex = TIAN_GAN.indexOf(dayGan);
            const targetIndex = TIAN_GAN.indexOf(targetGan);
            const diff = (targetIndex - dayIndex + 10) % 10;
            return {
                name: SHI_SHEN[diff],
                color: SHI_SHEN_COLORS[diff]
            };
        }

        // 日期验证函数
        function isValidDate(y, m, d, hh, mm) {
            // 检查年份范围
            if (y < 1900 || y > 2100) return false;
            
            // 检查月份
            if (m < 1 || m > 12) return false;
            
            // 检查日
            const daysInMonth = new Date(y, m, 0).getDate();
            if (d < 1 || d > daysInMonth) return false;
            
            // 检查时间
            if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return false;
            
            return true;
        }

        // 显示错误信息
        function showError(msg) {
            const errorMsg = document.getElementById('error-msg');
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
            document.getElementById('result').style.display = 'none';
        }

        // 主计算函数
        function calculateBazi() {
            if (!libraryLoaded) {
                showError('计算库未加载，请刷新页面重试');
                return;
            }
            
            const birthday = document.getElementById('birthday').value;
            const time = document.getElementById('time').value;
            const gender = document.getElementById('gender').value;
            const errorMsg = document.getElementById('error-msg');
            
            // 重置错误提示
            errorMsg.style.display = 'none';
            errorMsg.textContent = '';
            
            if (!birthday) {
                showError('请输入出生日期');
                return;
            }

            try {
                // 解析输入日期
                const [y, m, d] = birthday.split('-').map(Number);
                const [hh, mm] = time.split(':').map(Number);
                
                // 验证日期有效性
                if (!isValidDate(y, m, d, hh, mm)) {
                    showError('无效的日期或超出计算范围（请使用1900-2100年之间的有效日期）');
                    return;
                }
                
                // 创建日期对象
                const birthDate = new Date(y, m-1, d, hh, mm);
                
                // 计算农历和八字 - 使用正确的API调用链
                const solar = Lunar.Solar.fromDate(birthDate);
                if (!solar) {
                    showError('阳历日期转换失败');
                    return;
                }
                
                const lunar = solar.getLunar();
                if (!lunar) {
                    showError('农历转换失败，请尝试调整时间');
                    return;
                }
                
                const bazi = lunar.getEightChar();
                if (!bazi) {
                    showError('八字计算失败');
                    return;
                }
                
                // 获取四柱
                const yearGZ = bazi.getYear();
                const monthGZ = bazi.getMonth();
                const dayGZ = bazi.getDay();
                const hourGZ = bazi.getTime();
                
                // 拆分干支
                const yearGan = yearGZ.substring(0, 1);
                const yearZhi = yearGZ.substring(1);
                const monthGan = monthGZ.substring(0, 1);
                const monthZhi = monthGZ.substring(1);
                const dayGan = dayGZ.substring(0, 1);
                const dayZhi = dayGZ.substring(1);
                const hourGan = hourGZ.substring(0, 1);
                const hourZhi = hourGZ.substring(1);
                
                // 显示八字网格
                renderBaziGrid(yearGZ, monthGZ, dayGZ, hourGZ, dayGan);
                
                // 显示基本信息
                renderBasicInfo(solar, lunar, birthDate, gender, yearGZ);
                
                // 显示大运信息
                renderDayanInfo(lunar, dayGan);
                
                // 显示流年信息
                renderLiunianInfo(yearGZ);
                
                // 显示结果区域
                document.getElementById('result').style.display = 'block';
                
            } catch (e) {
                console.error("排盘错误:", e);
                showError('系统错误：' + e.message);
            }
        }

        // 显示八字网格
        function renderBaziGrid(yearGZ, monthGZ, dayGZ, hourGZ, dayGan) {
            const baziGrid = document.getElementById('bazi-grid');
            
            const pillars = [
                { name: "年柱", gz: yearGZ, gan: yearGZ.substring(0,1), zhi: yearGZ.substring(1), cls: "year-cell" },
                { name: "月柱", gz: monthGZ, gan: monthGZ.substring(0,1), zhi: monthGZ.substring(1), cls: "month-cell" },
                { name: "日柱", gz: dayGZ, gan: dayGZ.substring(0,1), zhi: dayGZ.substring(1), cls: "day-cell" },
                { name: "时柱", gz: hourGZ, gan: hourGZ.substring(0,1), zhi: hourGZ.substring(1), cls: "hour-cell" }
            ];
            
            let html = '';
            pillars.forEach(pillar => {
                const shishen = pillar.name === "日柱" ? 
                    {name: "日主", color: "#8B4513"} : 
                    getShiShen(dayGan, pillar.gan);
                
                html += `
                    <div class="bazi-cell ${pillar.cls}">
                        <div class="title">${pillar.name}</div>
                        <div class="ganzhi">${pillar.gz}</div>
                        <div class="wuxing">${WU_XING[TIAN_GAN.indexOf(pillar.gan)]}</div>
                        <div class="canggan">${CANG_GAN[pillar.zhi].join(' ')}</div>
                        <div class="shishen" style="color: ${shishen.color}">${shishen.name}</div>
                    </div>
                `;
            });
            
            baziGrid.innerHTML = html;
        }

        // 显示基本信息
        function renderBasicInfo(solar, lunar, birthDate, gender, yearGZ) {
            const basicInfo = document.getElementById('basic-info');
            
            const solarDate = `${birthDate.getFullYear()}年${(birthDate.getMonth()+1).toString().padStart(2,'0')}月${birthDate.getDate().toString().padStart(2,'0')}日`;
            const solarTime = `${birthDate.getHours().toString().padStart(2,'0')}:${birthDate.getMinutes().toString().padStart(2,'0')}`;
            
            basicInfo.innerHTML = `
                <h3>基本信息</h3>
                <p>阳历生日: ${solarDate} ${solarTime}</p>
                <p>农历日期: ${lunar.toString()}</p>
                <p>生肖: ${lunar.getYearShengXiao()}</p>
                <p>命卦: ${yearGZ} ${gender === '1' ? '男命' : '女命'}</p>
            `;
        }

        // 显示大运信息
        function renderDayanInfo(lunar, dayGan) {
            const dayanInfo = document.getElementById('dayan-info');
            const daYun = lunar.getDaYun();
            
            let tableHtml = '<h3>大运走势</h3><table><tr><th>大运</th><th>干支</th><th>十神</th><th>起运年龄</th><th>起运时间</th></tr>';
            
            for (let i = 0; i < Math.min(daYun.length, 10); i++) {
                const yun = daYun[i];
                const ganZhi = yun.getGanZhi();
                const shishen = getShiShen(dayGan, ganZhi.substring(0,1));
                const startAge = yun.getStartAge();
                
                // 验证起运年龄合理性
                if (startAge < 0 || startAge > 120) continue;
                
                tableHtml += `
                    <tr>
                        <td>第${i+1}大运</td>
                        <td>${ganZhi}</td>
                        <td style="color: ${shishen.color}">${shishen.name}</td>
                        <td>${startAge}岁</td>
                        <td>${yun.getStartSolar().getYear()}年</td>
                    </tr>
                `;
            }
            
            tableHtml += '</table>';
            dayanInfo.innerHTML = tableHtml;
        }

        // 显示流年信息
        function renderLiunianInfo(yearGZ) {
            const liunianInfo = document.getElementById('liunian-info');
            const currentYear = new Date().getFullYear();
            
            let html = '<h3>流年运势</h3><table><tr><th>年份</th><th>流年干支</th><th>与年柱关系</th></tr>';
            
            for (let y = currentYear - 2; y <= currentYear + 2; y++) {
                const solar = Lunar.Solar.fromYmd(y, 1, 1);
                const lunar = solar.getLunar();
                const yearGanZhi = lunar.getYearInGanZhi();
                const relation = getYearRelation(yearGZ, yearGanZhi);
                
                html += `
                    <tr>
                        <td>${y}年</td>
                        <td>${yearGanZhi}</td>
                        <td>${relation}</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            liunianInfo.innerHTML = html;
        }

        // 计算年柱关系
        function getYearRelation(baseGZ, targetGZ) {
            const baseGan = baseGZ.substring(0,1);
            const targetGan = targetGZ.substring(0,1);
            const baseIndex = TIAN_GAN.indexOf(baseGan);
            const targetIndex = TIAN_GAN.indexOf(targetGan);
            
            const diff = (targetIndex - baseIndex + 10) % 10;
            return SHI_SHEN[diff];
        }

        // 页面加载时开始加载库
        window.onload = function() {
            loadLunarLibrary();
            
            // 设置默认日期为30岁左右
            const now = new Date();
            const defaultDate = new Date(now.getFullYear() - 30, 0, 1);
            document.getElementById('birthday').valueAsDate = defaultDate;
        };
    </script>
</body>
</html>
