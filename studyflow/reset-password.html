<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reset your password · Studyflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2a;
      --text: #e6edf7;
      --muted: #9fb0cc;
      --accent: #4c7cf3;
      --danger: #e36b6b;
      --success: #4bbf73;
      --input: #18223a;
      --border: #24314d;
    }
    html, body {
      height: 100%; margin: 0; background: radial-gradient(1000px 400px at 50% 0%, #0f1830 0%, var(--bg) 45%);
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .container { min-height: 100%; display: grid; place-items: center; padding: 24px; }
    .card {
      width: 100%; max-width: 560px; background: linear-gradient(180deg, #0f1729 0%, var(--card) 100%);
      border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      padding: 24px; backdrop-filter: blur(4px);
    }
    .title { display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
    .logo {
      width: 42px; height: 42px; border-radius: 10px; display:grid; place-items:center;
      background: linear-gradient(135deg,#4866c9,#67a1f8); color:white; font-weight:700;
    }
    .title h1 { font-size: 22px; margin: 0; }
    .subtitle { color: var(--muted); font-size: 14px; margin: 4px 0 16px; }
    .alert {
      border: 1px solid var(--border); background: #1a243c; border-radius: 12px; padding: 12px 14px; font-size: 14px;
      display:flex; gap:10px; align-items:flex-start; margin: 10px 0 16px;
    }
    .alert.error { border-color: #5b1f2a; background: #2a1620; color: #ffd7d7; }
    .alert.success { border-color: #1f4d3a; background: #152a23; color: #c9ffe3; }
    .alert.info { border-color: #22365e; background: #12203a; color: #cfe1ff; }
    .alert .badge { font-weight:700; font-size: 12px; opacity: 0.8; }
    .form { display:grid; gap: 12px; }
    .field { display:grid; gap:6px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="password"] {
      width: 100%; padding: 12px 14px; background: var(--input); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-size: 14px; outline: none;
    }
    .hint { font-size: 12px; color: var(--muted); }
    .btn {
      appearance: none; border: none; border-radius: 10px; padding: 12px 16px; font-weight: 600; font-size: 14px;
      background: linear-gradient(135deg,#3756c7,#5992ff); color: white; cursor: pointer;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .footer { margin-top: 14px; font-size: 12px; color: var(--muted); text-align:center; }
    .strength { display:flex; gap:6px; align-items:center; font-size:12px; color: var(--muted); }
    .dot { width:8px; height:8px; border-radius:50%; background:#314160; }
    .dot.ok { background:#4bbf73; }
    .row { display:flex; gap:10px; }
    .tools { display:flex; gap:10px; margin-top: 8px; }
    .tool-btn { font-size: 12px; background: #1a243c; border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius:8px; cursor:pointer; }
    .tool-btn:disabled { opacity: 0.6; cursor:not-allowed; }
    a { color: #8fb7ff; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="title">
        <div class="logo">SF</div>
        <h1>Reset your password</h1>
      </div>
      <div class="subtitle">Securely update your Studyflow account password.</div>

      <div id="status" class="alert info" style="display:none"></div>

      <form id="form" class="form" style="display:none">
        <div class="field">
          <label for="password">New password</label>
          <input id="password" type="password" autocomplete="new-password" placeholder="Enter a strong password" />
          <div class="strength">
            <span>Strength</span>
            <span class="dot" id="s1"></span>
            <span class="dot" id="s2"></span>
            <span class="dot" id="s3"></span>
            <span class="dot" id="s4"></span>
          </div>
          <div class="hint">Min 8 chars, include upper/lowercase, number and symbol.</div>
        </div>

        <div class="field">
          <label for="confirm">Confirm password</label>
          <input id="confirm" type="password" autocomplete="new-password" placeholder="Re-enter your password" />
        </div>

        <div class="row">
          <button id="submit" class="btn" type="submit">Update password</button>
          <button id="cancel" class="tool-btn" type="button">Cancel</button>
        </div>
      </form>

      <div class="tools">
        <button id="probe" class="tool-btn" type="button">Connectivity check</button>
        <button id="details" class="tool-btn" type="button">Show debug</button>
      </div>

      <div class="footer">
        Forgot how you got here? Open the Studyflow app and try “Forgot password” again.
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.5/+esm';

    // Supabase configuration (from your .env)
    const SUPABASE_URL = 'https://zrnjebdkerrktgwvwjvz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpybmplYmRrZXJya3Rnd3Z3anZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MTIxMjQsImV4cCI6MjA3NzA4ODEyNH0.vV_oYy7hE_Vr8IFzH2Y40VbHPAhcjDRKr25mHfirGPg';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: false,
        detectSessionInUrl: false, // we'll handle hash ourselves
      },
    });

    const ui = {
      status: document.getElementById('status'),
      form: document.getElementById('form'),
      password: document.getElementById('password'),
      confirm: document.getElementById('confirm'),
      submit: document.getElementById('submit'),
      cancel: document.getElementById('cancel'),
      probe: document.getElementById('probe'),
      details: document.getElementById('details'),
      dots: [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3'), document.getElementById('s4')],
    };

    function setAlert(kind, message) {
      ui.status.className = `alert ${kind}`;
      ui.status.textContent = message;
      ui.status.style.display = 'block';
    }
    function clearAlert() {
      ui.status.style.display = 'none';
      ui.status.textContent = '';
    }

    function parseHash() {
      const hash = new URLSearchParams(window.location.hash.replace(/^#/, ''));
      return {
        access_token: hash.get('access_token'),
        refresh_token: hash.get('refresh_token'),
      };
    }
    function parseQuery() {
      const q = new URLSearchParams(window.location.search);
      return {
        token_hash: q.get('token_hash'),
        type: q.get('type'),
      };
    }

    async function connectivityCheck() {
      try {
        const res = await fetch(`${SUPABASE_URL}/auth/v1/settings`, {
          headers: { apikey: SUPABASE_ANON_KEY },
        });
        const json = await res.json();
        setAlert('info', `Connectivity OK. Auth settings received: email auth=${json?.email?.enabled ?? 'unknown'}`);
      } catch (err) {
        setAlert('error', `Network error when contacting Supabase. Possible CSP/AdBlock/Proxy issue. Details: ${err?.message || err}`);
      }
    }

    function score(pw) {
      let s = 0;
      if (pw.length >= 8) s++;
      if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) s++;
      if (/\d/.test(pw)) s++;
      if (/[^A-Za-z0-9]/.test(pw)) s++;
      ui.dots.forEach((d, i) => d.classList.toggle('ok', i < s));
      return s;
    }

    async function init() {
      clearAlert();
      // Step 1: connectivity probe
      try {
        await connectivityCheck();
      } catch { /* handled in connectivityCheck */ }

      // Step 2: try to establish session
      const { access_token, refresh_token } = parseHash();
      const { token_hash, type } = parseQuery();

      try {
        if (access_token && refresh_token) {
          const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
          if (error) throw error;
          setAlert('info', 'Session restored from access_token. You can now set a new password.');
          ui.form.style.display = 'grid';
          return;
        }

        if (token_hash && (type === 'recovery' || type === 'magiclink')) {
          const { data, error } = await supabase.auth.verifyOtp({ token_hash, type: 'recovery' });
          if (error) throw error;
          setAlert('info', 'Token verified. You can now set a new password.');
          ui.form.style.display = 'grid';
          return;
        }

        setAlert('error', 'Missing recovery tokens. Please re-open the link from the latest reset email.');
      } catch (err) {
        const msg = err?.message || String(err);
        if (/fetch|network/i.test(msg)) {
          setAlert('error', `Failed to initialize recovery: NetworkError when attempting to fetch resource.`);
        } else {
          setAlert('error', `Failed to initialize recovery: ${msg}`);
        }
      }
    }

    ui.password.addEventListener('input', () => score(ui.password.value));
    ui.cancel.addEventListener('click', () => {
      ui.password.value = '';
      ui.confirm.value = '';
      score('');
      clearAlert();
    });
    ui.details.addEventListener('click', () => {
      const { access_token, refresh_token } = parseHash();
      const { token_hash, type } = parseQuery();
      setAlert('info', `Debug: hash access_token=${!!access_token}, refresh_token=${!!refresh_token}; query token_hash=${!!token_hash}, type=${type || 'n/a'}`);
    });
    ui.probe.addEventListener('click', connectivityCheck);

    ui.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert();

      const pw = ui.password.value.trim();
      const cf = ui.confirm.value.trim();

      if (pw.length < 8 || score(pw) < 3) {
        setAlert('error', 'Password too weak. Use 8+ chars with upper/lowercase, number and symbol.');
        return;
      }
      if (pw !== cf) {
        setAlert('error', 'Passwords do not match.');
        return;
      }

      ui.submit.disabled = true;
      try {
        const { data, error } = await supabase.auth.updateUser({ password: pw });
        if (error) throw error;
        setAlert('success', 'Your password has been updated. You can close this page.');
        ui.form.style.display = 'none';
      } catch (err) {
        const msg = err?.message || String(err);
        setAlert('error', `Failed to update password: ${msg}`);
      } finally {
        ui.submit.disabled = false;
      }
    });

    // Optional: react to auth events (rarely needed on pure static pages)
    supabase.auth.onAuthStateChange((event) => {
      if (event === 'PASSWORD_RECOVERY') {
        ui.form.style.display = 'grid';
        setAlert('info', 'Recovery session active. Please set a new password.');
      }
    });

    init();
  </script>
</body>
</html>
