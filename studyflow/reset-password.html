<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Reset Password · Studyflow</title>
  <meta name="description" content="Reset your Studyflow account password securely." />
  <link rel="icon" href="https://mybazi.com/assets/favicon.png" />

  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --card: #111827;      /* gray-900 */
      --border: #1f2937;    /* gray-800 */
      --text: #e5e7eb;      /* gray-200 */
      --muted: #9ca3af;     /* gray-400 */
      --primary: #6366f1;   /* indigo-500 */
      --primary-600: #4f46e5;
      --danger: #ef4444;
      --success: #22c55e;
      --shadow: 0 20px 50px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background:
        radial-gradient(1200px 600px at 0% 0%, rgba(99,102,241,0.10), transparent 60%),
        radial-gradient(800px 600px at 100% 0%, rgba(34,197,94,0.08), transparent 60%),
        linear-gradient(180deg, #0b1220, #0f172a 30%, #0b1220 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .container {
      width: 100%;
      max-width: 520px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      padding: 28px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    .logo {
      display: grid;
      place-items: center;
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background:
        radial-gradient(60% 60% at 30% 30%, rgba(99,102,241,0.35), transparent 60%),
        radial-gradient(60% 60% at 70% 70%, rgba(34,197,94,0.25), transparent 60%),
        linear-gradient(135deg, rgba(99,102,241,0.30), rgba(34,197,94,0.25));
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 700;
    }
    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.2px;
    }
    .subtitle {
      color: var(--muted);
      font-size: 14px;
      margin-top: 6px;
    }
    .status {
      margin: 14px 0 4px;
      font-size: 14px;
      color: var(--muted);
    }
    .alert {
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      font-size: 14px;
      display: none;
    }
    .alert.show { display: block; }
    .alert.error { border-color: rgba(239,68,68,0.4); color: #fecaca; background: rgba(239,68,68,0.12); }
    .alert.success { border-color: rgba(34,197,94,0.4); color: #bbf7d0; background: rgba(34,197,94,0.12); }

    form {
      margin-top: 18px;
      display: grid;
      gap: 14px;
    }
    .field {
      display: grid;
      gap: 8px;
    }
    label {
      font-size: 13px;
      color: var(--muted);
    }
    .input-wrap {
      position: relative;
    }
    input[type="password"] {
      width: 100%;
      padding: 12px 44px 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,0.55);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease;
    }
    input[type="password"]:focus {
      border-color: rgba(99,102,241,0.5);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
    }
    .toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
      padding: 6px 8px;
      border-radius: 8px;
    }
    .helper {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(90deg, var(--primary), var(--primary-600));
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform .03s ease, filter .15s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] {
      opacity: .6;
      cursor: not-allowed;
      filter: grayscale(.2);
    }
    .footer {
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }
    .footer a {
      color: var(--text);
      text-decoration: none;
      border-bottom: 1px dashed var(--border);
    }
    .hidden { display: none; }
  </style>
</head>

<body>
  <main class="container">
    <div class="brand">
      <div class="logo">SF</div>
      <div>
        <h1>Reset your password</h1>
        <div class="subtitle">Securely update your Studyflow account password.</div>
      </div>
    </div>

    <div id="status" class="status">Initializing recovery…</div>
    <div id="error" class="alert error"></div>
    <div id="success" class="alert success"></div>

    <form id="resetForm" class="hidden">
      <div class="field">
        <label for="password">New password</label>
        <div class="input-wrap">
          <input id="password" type="password" autocomplete="new-password" placeholder="At least 8 characters" />
          <span class="toggle" data-target="password">Show</span>
        </div>
        <div class="helper">Use 8+ characters with a mix of letters and numbers.</div>
      </div>
      <div class="field">
        <label for="confirm">Confirm new password</label>
        <div class="input-wrap">
          <input id="confirm" type="password" autocomplete="new-password" placeholder="Re-enter your new password" />
          <span class="toggle" data-target="confirm">Show</span>
        </div>
      </div>
      <button id="submitBtn" class="btn" type="submit">Update password</button>
    </form>

    <div class="footer">
      Forgot how you got here? Open the Studyflow app and try “Forgot password” again.
    </div>
  </main>

  <!-- Supabase JS v2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 1) Fill these with your Supabase project config
    const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_PUBLIC_ANON_KEY';

    // 2) Create client
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers
    const qs = new URLSearchParams(window.location.search);
    const hash = new URLSearchParams(window.location.hash.replace(/^#/, ''));
    const el = (id) => document.getElementById(id);
    const setStatus = (msg) => { el('status').textContent = msg; };
    const showError = (msg) => { el('error').textContent = msg; el('error').classList.add('show'); };
    const clearError = () => { el('error').classList.remove('show'); el('error').textContent = ''; };
    const showSuccess = (msg) => { el('success').textContent = msg; el('success').classList.add('show'); };

    // Toggle password visibility
    document.querySelectorAll('.toggle').forEach(t => {
      t.addEventListener('click', () => {
        const target = document.getElementById(t.dataset.target);
        if (!target) return;
        target.type = target.type === 'password' ? 'text' : 'password';
        t.textContent = target.type === 'password' ? 'Show' : 'Hide';
      });
    });

    // 3) Establish recovery session:
    //    A) If token_hash is present, verify it.
    //    B) Else if access_token/refresh_token are present in URL hash, set session.
    //    C) Else, rely on Supabase to trigger PASSWORD_RECOVERY on redirect.
    async function initRecovery() {
      try {
        const tokenHash = qs.get('token_hash') || qs.get('token');
        const accessToken = hash.get('access_token');
        const refreshToken = hash.get('refresh_token');

        if (tokenHash) {
          setStatus('Verifying recovery token…');
          const { data, error } = await client.auth.verifyOtp({ type: 'recovery', token_hash: tokenHash });
          if (error) throw error;
          setStatus('Token verified. You can now set a new password.');
          el('resetForm').classList.remove('hidden');
          return;
        }

        if (accessToken && refreshToken) {
          setStatus('Restoring session…');
          const { data, error } = await client.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
          if (error) throw error;
          setStatus('Session restored. You can now set a new password.');
          el('resetForm').classList.remove('hidden');
          return;
        }

        // Subscribe to auth events as fallback
        setStatus('Waiting for recovery session…');
        client.auth.onAuthStateChange((event, session) => {
          if (event === 'PASSWORD_RECOVERY' || session?.access_token) {
            setStatus('Recovery session ready. You can now set a new password.');
            el('resetForm').classList.remove('hidden');
          }
        });

        // Also poll getSession once in case the hash has been processed
        const { data: sess } = await client.auth.getSession();
        if (sess?.session?.access_token) {
          setStatus('Recovery session ready. You can now set a new password.');
          el('resetForm').classList.remove('hidden');
          return;
        }

        // If nothing found, guide user
        setStatus('If you opened this page directly, please use the email link.');
      } catch (err) {
        console.error('Recovery init error:', err);
        showError(`Failed to initialize recovery: ${err?.message || 'Unknown error'}`);
        setStatus('Initialization failed.');
      }
    }

    // 4) Handle form submit
    el('resetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();
      el('submitBtn').disabled = true;

      try {
        const pw = el('password').value.trim();
        const cf = el('confirm').value.trim();
        if (pw.length < 8) {
          showError('Password must be at least 8 characters.');
          el('submitBtn').disabled = false;
          return;
        }
        if (pw !== cf) {
          showError('Passwords do not match.');
          el('submitBtn').disabled = false;
          return;
        }

        setStatus('Updating password…');
        const { data, error } = await client.auth.updateUser({ password: pw });
        if (error) throw error;

        showSuccess('Your password has been updated successfully.');
        setStatus('All set! You can return to the Studyflow app.');
        el('resetForm').classList.add('hidden');

        // Optional: direct users back to app (if installed)
        const backToApp = document.createElement('div');
        backToApp.style.marginTop = '10px';
        backToApp.innerHTML = '<a href="studyflow://login" style="color:#e5e7eb;text-decoration:none;border-bottom:1px dashed #1f2937;">Open Studyflow App</a>';
        document.querySelector('.footer').appendChild(backToApp);
      } catch (err) {
        console.error('Update password error:', err);
        showError(err?.message || 'Failed to update password. Please try again.');
        setStatus('Update failed.');
      } finally {
        el('submitBtn').disabled = false;
      }
    });

    initRecovery();
  </script>
</body>
</html>
