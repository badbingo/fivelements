<!DOCTYPE html>
<html>
<head>
  <title>充值成功</title>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('order_id');
      
      if (orderId) {
        // 检查订单状态
        checkOrderStatus(orderId);
      } else {
        document.getElementById('status').textContent = '无效的订单号';
      }
    });

    async function checkOrderStatus(orderId) {
      try {
        const response = await fetch(`https://bazi-backend.owenjass.workers.dev/api/recharge/status?orderId=${orderId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'paid') {
          document.getElementById('status').textContent = `充值成功！订单号: ${orderId}`;
          // 更新用户余额显示
          if (data.balance !== undefined) {
            document.getElementById('balance').textContent = `当前余额: ${data.balance}元`;
          }
        } else {
          document.getElementById('status').textContent = `支付处理中...`;
          // 5秒后再次检查
          setTimeout(() => checkOrderStatus(orderId), 5000);
        }
      } catch (error) {
        console.error('状态检查失败:', error);
        document.getElementById('status').textContent = '状态检查失败，请稍后刷新页面';
      }
    }
  </script>
</head>
<body>
  <h1 id="status">正在验证支付状态...</h1>
  <p id="balance"></p>
  <button onclick="window.location.href='/'">返回首页</button>
</body>
</html>
