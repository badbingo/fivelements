<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特定用户登录测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 10px 0; }
        input, button { padding: 8px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; font-family: monospace; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <h1>特定用户登录测试</h1>
        <p>测试不同用户名的登录响应，帮助诊断500错误</p>
        
        <div class="form-group">
            <input type="text" id="username" placeholder="用户名" value="Owen">
            <input type="password" id="password" placeholder="密码" value="123456">
            <button onclick="testLogin()">测试登录</button>
            <button onclick="testMultipleUsers()">测试多个用户</button>
            <button onclick="clearLogs()">清空日志</button>
        </div>
        
        <div id="logs" class="log"></div>
    </div>

    <script>
        const API_BASE = 'https://api.mybazi.net';
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('日志已清空');
        }
        
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log(`\n=== 测试用户: ${username} ===`);
            
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: username, password })
                });
                
                log(`状态码: ${response.status}`);
                log(`状态文本: ${response.statusText}`);
                
                const responseText = await response.text();
                log(`原始响应: ${responseText}`);
                
                if (responseText) {
                    try {
                        const result = JSON.parse(responseText);
                        if (response.status === 500) {
                            log(`服务器错误 (500): ${result.error}`, 'error');
                        } else if (response.status === 401) {
                            log(`认证失败 (401): ${result.error}`, 'warning');
                        } else if (response.status === 200) {
                            log(`登录成功: Token获取成功`, 'success');
                        }
                    } catch (e) {
                        log(`JSON解析失败: ${e.message}`, 'error');
                    }
                } else {
                    log('响应为空', 'error');
                }
                
            } catch (error) {
                log(`网络错误: ${error.message}`, 'error');
            }
        }
        
        async function testMultipleUsers() {
            const testUsers = [
                { name: 'test', password: 'test123' },
                { name: 'Owen', password: '123456' },
                { name: 'admin', password: 'admin123' },
                { name: 'user1', password: 'password' },
                { name: 'nonexistent', password: 'fake' }
            ];
            
            log('\n=== 开始批量测试 ===');
            
            for (const user of testUsers) {
                log(`\n--- 测试用户: ${user.name} ---`);
                
                try {
                    const response = await fetch(`${API_BASE}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: user.name, password: user.password })
                    });
                    
                    const responseText = await response.text();
                    
                    if (response.status === 500) {
                        log(`${user.name}: 服务器错误 (500) - ${responseText}`, 'error');
                    } else if (response.status === 401) {
                        log(`${user.name}: 认证失败 (401) - ${responseText}`, 'warning');
                    } else if (response.status === 200) {
                        log(`${user.name}: 登录成功 (200)`, 'success');
                    } else {
                        log(`${user.name}: 未知状态 (${response.status}) - ${responseText}`);
                    }
                    
                } catch (error) {
                    log(`${user.name}: 网络错误 - ${error.message}`, 'error');
                }
                
                // 添加延迟避免请求过快
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('\n=== 批量测试完成 ===');
        }
        
        window.onload = function() {
            log('特定用户登录测试页面已加载');
            log('这个工具可以帮助诊断哪些用户名会导致500错误');
        };
    </script>
</body>
</html>